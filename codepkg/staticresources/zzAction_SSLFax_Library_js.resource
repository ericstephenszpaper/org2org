<!--
// Name: SSLFax Library
// Committer: eric.stephens@zpaper.com
// Update: ERS230729 HACk qr.md on zp50; ERS230729 need some clear documentation on BATES for qr.md, latest zippi has null
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2023-07-29 16:35:40","evalContinue":"true","active":true,"button":"Stamp","name":"SSLFax Library","conditions":{"logic":"or","arguments":[{"name":"doc.status","value":"NoSSLFax","operation":"not-contains"},{"name":"doc.X(\"X_buttonAction\")","value":"ADD_STAMP","operation":"equals"},{"name":"doc.X(\"X_buttonAction\")","value":"NOTIFY","operation":"starts-with"}]},"consequence":{"doit":"Ly9FUlMyMTA2MDUgY3JlYXRlIFFSIGNvZGUgYW5kIEJsb2NrY2hhaW4gY29udHJhY3QgdG8gZW5hYmxlIGZhc3RlciwgZGlnaXRhbCBhY2Nlc3MKaWYgKGRvYy5YKCJYX2J1dHRvbkFjdGlvbiIpID09ICJBRERfU1RBTVAiKSB7CiAgICByb29sLmV2YWxDb250aW51ZT1mYWxzZTsgLy9zdG9wcyB0aGUgYnVzIQp9CmlmIChkb2MuWCgiWF9idXR0b25BY3Rpb24iKS5pbmRleE9mKCJOT1RJRlkiKT09PTApIHsgLy9FUlMyMjA0MDkgIzkwODgyCiAgICByb29sLmV2YWxDb250aW51ZT1mYWxzZTsgLy9zdG9wcyB0aGUgYnVzIQp9CgovL21ha2UgYSBSRURJUkVDVCBzbmlwcGV0Ci8vY3JlYXRlIHRoZSAgYmxvY2tjaGFpbiBzbWFydCBjb250cmFjdAovLzFzdCBVUkwgaXMgb3BlbiB0aGVuIHJlcXVpcmUgYSBQSU4KLy9yZXR1cm4gYSBVUkwgZm9yIHRoZSBRUiBjb2RlCmFsZXJ0KCJFUlMyMzA2MTUgbWFkZSBmcm9tICIrWChkb2MsIktCaW5QcmludCIpKTsKYWxlcnQoIkVSUzIzMDYxNSBtYWRlIGZyb20gIitYKGRvYywiQ29udGFjdEZheCIpKTsKekRhdGEuYWxyZWFkeVN0YW1wZWQ9WChkb2MsIkNvbnRhY3RGYXgiKTsgLy9FUlMyMzA2MTYgVE9ETyBzYXZlIHRoZSBleGlzdGluZyBzdGFtcCBpbnRvIEtCaW5QcmludAppZiAoekRhdGEuYWxyZWFkeVN0YW1wZWQudG9VcHBlckNhc2UoKS5pbmRleE9mKCJQREYiKT4tMSkgeyB6RGF0YS5zc2xGYXg9ZmFsc2U7IGFsZXJ0KCJFUlMyMzA2MTUgZG8gbm90IHJlc3RhbXAgIit6RGF0YS5hbHJlYWR5U3RhbXBlZCk7IH0gLy9FUlMyMzA2MTUKYWxlcnQoIkVSUzIzMDYxNSBkb2Mua2JEYXRhPSIrZG9jLmtiRGF0YSk7CmFsZXJ0KCJFUlMyMzA2MTUgekRhdGE9Iit6RGF0YS50b1N0cmluZygpKTsgLy9FUlMyMzA2MTUgbmVlZCB0byBzZWUgaWYgdGhlIHN0YW1wIG9uIHRoZSBpbmNvbWluZyBzZW5kVG8gUERGIGFscmVhZHkgZXhpc3RzCmlmICghekRhdGEgfHwgIXpEYXRhLmRvY1R5cGUpIHpEYXRhLmRvY1R5cGU9IlpUQU1QWiI7IC8vRVJTMjMwNTEzCmFsZXJ0KCJFUlMyMzA1MTMgekRhdGEuZG9jVHlwZT0iK3pEYXRhLmRvY1R5cGUpOwppZiAoKCIiK3pEYXRhLmRvY1R5cGUpLmluZGV4T2YoIlpDQVJEIikgIT0gLTEpIHt6RGF0YS5zdGFtcFk9NTA7IHpEYXRhLnN0YW1wWD0xNzsgfSAKLy9UT0RPIGluIHRlbXBsYXRlIHNldCAtMSBmb3Igbm8gc3RhbXBzIG9yIHVzZSB6RGF0YS5kb2NUeXBlCmlmICghekRhdGEuc3RhbXBYKSB7IHpEYXRhLnN0YW1wWD0xNzsgfQppZiAoIXpEYXRhLnN0YW1wWSkgeyB6RGF0YS5zdGFtcFk9NzUwOyB9Ci8vekRhdGEuc3RhbXBYPTM3OyAvL0VSUzIzMDMxOCB0ZXN0aW5nIG1vdmVtZW50ICM5NjgyMgp2YXIgU1k9ekRhdGEuc3RhbXBZLzE7IHZhciBTWD16RGF0YS5zdGFtcFgvMTsKekRhdGEuc3RhbXBNYXJrdXA9IiI7IC8vRVJTMjEwNzMxICM4Mzc2NyBtaWdodCBuZWVkIHRvIGJlIGRpZmZlcmVudCBmb3Igc2lnbmF0dXJlIGludml0ZQp6RGF0YS5zdGFtcE1hcmt1cCs9ImtibSgnSU1HWlNUQU1QX1JFQUxQREZDT09SRFMnLCdQQUdFMUlNR1pTVEFNUCcsJy9rYi9qc3AvcXIuanNwP2NvZGU9eyFxcn0nLDU1LDU1LDEwLDEwLCcnLCcxMicsNDUsNDUsIitTWCsiLCIrU1krIik7IjsKLy9FUlMyMjExMjkgIzkxNTUyIHpEYXRhLnN0YW1wTWFya3VwKz0ia2JtKCdJTUcxNjI3MTQ5MzE4MDM4X1JFQUxQREZDT09SRFMnLCdQQUdFMUlNRzE2MjcxNDkzMTgwMzgnLCdhZGRUZXh0Jyw5MywyMiwxMCw4MywnZmF4TUQub3JnJywnMTAnLDcwLDE2LDcsNzUwKTsiOwp6RGF0YS5zdGFtcE1hcmt1cCs9ImtibSgnSU1HMTYyNzE0OTMxODAzOF9SRUFMUERGQ09PUkRTJywnUEFHRTFJTUcxNjI3MTQ5MzE4MDM4JywnYWRkVGV4dCcsOTMsMjIsMTAsODMsJ3FyLm1kLycsJzcnLDcwLDE2LCIrU1grIiwiK1NZKyIpOyI7IC8vRVJTMjMwMjE2IGp1c3QgcXIubWQgbm90IHpxci5tZAp6RGF0YS5zdGFtcE1hcmt1cCs9ImtibSgnSU1HMTYyNzE0OTMxODAzOV9SRUFMUERGQ09PUkRTJywnUEFHRTFJTUcxNjI3MTQ5MzE4MDM5JywnYWRkVGV4dCcsOTMsMjIsMTAsODMsJ3shenp6WzAsNF19JywnNycsNzAsMTYsIitTWCsiLCIrKFNZLTE1KSsiKTsiOwp6RGF0YS5zdGFtcE1hcmt1cCs9ImtibSgnSU1HMTYyNzE0OTMxODA0MF9SRUFMUERGQ09PUkRTJywnUEFHRTFJTUcxNjI3MTQ5MzE4MDQwJywnYWRkVGV4dCcsOTMsMjIsMTAsODMsJ3shenp6WzUsMTBdfScsJzcnLDcwLDE2LCIrU1grIiwiKyhTWS0zMCkrIik7IjsgLy9FUlMyMzAxMDQKaWYgKHpEYXRhLnN0YW1wWDwwIHx8IHpEYXRhLnN0YW1wWTwwKSB7IHpEYXRhLnN0YW1wTWFya3VwPSIiOyB6RGF0YS5zc2xGYXg9ZmFsc2U7IGFsZXJ0KCJFUlMyMzAzMTguMjEgdHVybmVkIG9mZiBzdGFtcHMgZm9yIHRoaXMgcGRmIik7IH0KCnpEYXRhLmFkZFN0YW1wPWZ1bmN0aW9uKGRvYyxyZXEpIHsKICAgIHZhciBzdGFtcE1hcmt1cD0iZ2V0IGZyb20gekRhdGEiOyAvL0VSUzIxMTEyMCBjbGVhbmluZyB1cAogICAgLy9FUlMyMTExMjAgZmF4bWQgdG8gZmF4TUQgYW5kIGxvb2tpbmcgZm9yIHBsYWNlIGZvciBaUVIgdXJsIHRvIGtlZXAgZm9yZXZlcgogICAgc3RhbXBNYXJrdXA9ekRhdGEuc3RhbXBNYXJrdXA7IC8vRVJTMjEwNzMxCiAgICBpZiAoIXpEYXRhLnNzbEZheCkgeyBhbGVydCgiRVJTMjMwMzE4IG5vdCBzdGFtcGluZyEiKTsgfSAvL0VSUzIzMDMxOCAjOTY4MjIgbmVlZCBhbm90aGVyIGNhc2UKICAgIC8vQkFEIEJBRCB0ZXN0aW5nIEVSUzIzMDYxNgogICAgaWYgKCF6RGF0YS5zc2xGYXgpIHsgYWxlcnQoIkVSUzIzMDYxNSBub3Qgc3RhbXBpbmchIik7IHJldHVybiAiIjsgfSAvL0VSUzIzMDYxNSBwZXJoYXBzIGFuIGV4aXN0aW5nIHN0YW1wZWQgZG9jdW1lbnQKICAgIHZhciB1c2VyRW1haWw9ZG9jLlhPcmcoIlhfY3JtVXNlciIpOwogICAgaWYgKHVzZXJFbWFpbC5pbmRleE9mKCJAIik9PS0xKSB1c2VyRW1haWw9InN1cHBvcnQrc2lnbkB6cGFwZXIuY29tIjsKICAgIC8vdHJhY2soZG9jLCJpbnZpdGUgc2VudCIsImludml0aW5nICIrWChkb2MsIlhfaW52aXRlRW1haWwiK24pLnJlcGxhY2UoLyAvZywiKyIpLCAwKTsKICAgIGFsZXJ0KCJFUlMyMDEyMDcuMDkgenBTZXJ2ZXI9Iitkb2Mua2JEYXRhLkhPU1QpOwogICAgekRhdGEuenBTZXJ2ZXI9KCIiK2RvYy5rYkRhdGEuSE9TVCkucmVwbGFjZSgiaHR0cDovLyIsIiIpLnJlcGxhY2UoIjo4MDgwIiwiIikucmVwbGFjZSgiaHR0cHM6Ly8iLCIiKTsgLy9FUlMyMDEyMDQgIzc3MzAyIC8vRVJTMjAxMjA2IG1vcmUgZW5naW5lIHJlcGxhY2VzCiAgICBpZiAoIXpEYXRhLnpwU2VydmVyKSB6RGF0YS56cFNlcnZlcj0iZWRnZS56cGFwZXIuY29tIjsgLy9FUlMxOTExMTAgIzY0MTYwIFRPRE8gZ2V0IGEgc2VydmVyCiAgICB6RGF0YS56cFNlcnZlcj16RGF0YS56cFNlcnZlci5yZXBsYWNlKCJhLnpwYXBlci5jb20iLCIuenBhcGVyLmNvbSIpLnJlcGxhY2UoImIuenBhcGVyLmNvbSIsIi56cGFwZXIuY29tIik7IC8vRVJTMjMwNzI5IEhBQ2sgcXIubWQgb24genA1MAogICAgaWYgKCgiIit6RGF0YS56cFNlcnZlcikuaW5kZXhPZigienBhcGVyLmNvbSIpPT0tMSkgeyAvL0VSUyBUT0RPIGRvYy56cFNlcnZlciBuZWVkZWQgZm9yIHppcHBpCiAgICAgICAgekRhdGEuenBTZXJ2ZXI9ImVkZ2UuenBhcGVyLmNvbSI7CiAgICAgICAgYWxlcnQoIkVSUzIzMDIxMi4zMiBaSVBQSSBCVVNURUQhISEiKTsKICAgICAgICBkb2Mua2JEYXRhLkhPU1Q9ekRhdGEuenBTZXJ2ZXI7CiAgICB9CiAgICBhbGVydCgiRVJTMjAxMjA0LjExIHpwU2VydmVyIGlzICIrekRhdGEuenBTZXJ2ZXIpOwogICAgdmFyIG1hcmt1cFhNTD0iIitYKGRvYywiWF9tYXJrdXAiKTsgLy9FUlMyMTA2MTEgYWRkZWQgIiIgZm9yIE5QRQogICAgYWxlcnQoIkVSUzIxMDYxMiBtWE1MPSIrbWFya3VwWE1MKTsKICAgIGlmIChtYXJrdXBYTUwuaW5kZXhPZigiWlNUQU1QIikhPS0xKSB7CiAgICAgICAgYWxlcnQoIkFMUkVBRFkgWlNUQU1QRUQhIik7CiAgICAgICAgdmFyIHpzdGFtcD0iIitYKGRvYywiWF9kZWxpdmVyU3RhbXAiKTsKICAgICAgICBpZiAoenN0YW1wLmluZGV4T2YoIi5jb20vIikgPT0gLTEpIHsKICAgICAgICAgICAgYWxlcnQoIlJFRElSRUNUIGJyb2tlbj8gIit6c3RhbXApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB6c3RhbXA7IC8vcHJvYmFibHkgc2hvdWxkIGJlIHN0YW1wTWFya3VwLnJlcGxhY2UoInshcXJ9Iix6c3RhbXApOwogICAgICAgIH0KICAgIH0KICAgIAogICAgdmFyIG49MTsKICAgIHZhciBhcnJPZlBhaXJzPVtdOwogICAgdmFyIFBJTj1YKGRvYywiWF9pbnZpdGVQSU4iK24pOyAvL0VSUzIxMDExOCBUT0RPIHN1cHBvcnQgaW5saW5lIGluIElOVklURW46U01TOmVtYWlsOlBJTiB2YWx1ZXMKICAgIFBJTj0iIitYKGRvYywiQ29udGFjdEZheCIpOyAvL1RPRE8gY2xlYW4gdXAgdG8gMTAgZGlnaXRzCiAgICB2YXIgdG89UElOOyAvL2ZheCBvciBTTVMgbnVtYmVyCiAgICBpZiAoUElOICE9ICJQREYiKSB7IFBJTj1YKGRvYywiWF9pbnZpdGVQSU4iK24pOyB9IC8vRVJTMjMwNDA3IG5vdCBzdXJlIHdoeSB3ZSBldmVyIGRpZCB0aGUgQ29udGFjdEZheCB0aGluZyEgIERvIE5PVCBzdGFtcCBQREYgZGVsaXZlcnkKICAgIGlmICghUElOIHx8ICgiIitQSU4pLmluZGV4T2YoIlBERiIpICE9IC0xIHx8ICgiIitQSU4pLmluZGV4T2YoIjoiKSAhPSAtMSkgeyAvL21ha2Ugb25lIHVwIC8vRVJTMjExMTIwIFBERiAvL0VSUzIzMDIxMiBjaGVjayBzdHJpbmcgJiAiOiIKICAgICAgICBQSU49IjMwMDc2IjsKICAgICAgICBpZiAoMT09PTEpIHsgUElOPTA7CXdoaWxlIChQSU48MTAwMDApIHsgUElOPU1hdGguZmxvb3IoMTAwMDAwKk1hdGgucmFuZG9tKCkpOyB9IH0gLy9FUlMyMTA5MTIgUElOIGJhY2sgb24KICAgIH0KICAgIGFyck9mUGFpcnMucHVzaCgiWF9pbnZpdGVQSU4iK24sICgiIitQSU4pKTsKICAgIHZhciBzaWduSGludHM9IjxYX2ludml0ZVBJTiIrbisiPiIrUElOKyI8L1hfaW52aXRlUElOIituKyI+IjsKICAgIGFyck9mUGFpcnMucHVzaCgiWF9zaWduSXQiLCBzaWduSGludHMpOwoKICAgIC8vY3JlYXRlIGEgb25lIHRpbWUgdXNlIHJlZGlyZWN0IChBKSB0byBkb3dubG9hZCBvciB2aWV3IHRoZSBQREYgb3IgZW1iZWRkZWQgZGF0YQogICAgLy9zdGFtcCBjb250YWlucyB0aGUgQSBsaW5rIGFzIGEgUVIgY29kZQogICAgLy9jcmVhdGUgYSBjb250cmFjdCByZWRpcmVjdCAoQikgd2l0aCBhIFBJTiB0byB2aWV3IC8gc2lnbiAvIG1hcmt1cCB0aGUgUERGIGFmdGVyd2FyZHMKICAgIC8vYWZ0ZXIgdGhlIDFzdCB0aW1lIEEgaXMgdXNlZCBjaGFuZ2UgdGhlIGZvcndhcmQgZnJvbSBBIHRvIGdvdG8gQgogICAgLy9FUlMyMTA2MTIgb25jZSBhIHJlZGlyZWN0IGlzIG91dCBvZiB2aWV3cyBpZiB0aGVyZSBpcyBhIDsgdGhlbiBmb3J3YXJkIHRvIGl0CiAgICAKICAgIGFsZXJ0KCJFUlMyMTA2MTIuNTQgZG9jLkJBVEVTIG1heSBiZSBudWxsIik7CiAgICAvL0VSUzIyMTEwNyB2YXIgbklkPSIiK1goZG9jLCJYX3pJdGVtSWQiKTsgaWYgKCFuSWQgJiYgKCIiK2RvYy5CQVRFUykuaW5kZXhPZigiX0Zvcm0iKT09LTEpIG5JZD1kb2MuZGJJRDsgLy9FUlMyMTA2MTEgMjA0MDA3ZTRaMWRram5pMmlsCiAgICB2YXIgbklkPSIiK1goZG9jLCJYX3pJdGVtSWQiKTsgIGlmICghbklkKSBuSWQ9ZG9jLmRiSUQ7IC8vRVJTMjEwNjExIFRPRE8gY2hlY2sgaWYgekRhdGEuc3NsRmF4IHRoZW4gICgiIitkb2MuQkFURVMpLmluZGV4T2YoIl9Gb3JtIik9PS0xCiAgICBhbGVydCgiRVJTMjIxMTA3LjY2IGNoZWNrIHpEYXRhLnNzbEZheD0iK3pEYXRhLnNzbEZheCArIiB6RGF0YS56aXBwaU1vZGU9Iit6RGF0YS56aXBwaU1vZGUpOwogICAgaWYgKCFuSWQpIHsgcmV0dXJuICJFUlJPUjogVGVtcGxhdGVzIGRvIG5vdCBuZWVkIHN0YW1wcyI7IH0KICAgIAogICAgdmFyIGxpbmtBPSJodHRwczovLyIrekRhdGEuenBTZXJ2ZXIrIi9rYi9wZGYvIituSWQrIi96aXRlbS5wZGYiOyAvL0VSUzIwMTAxNAogICAgdmFyIGxpbmtCPSJodHRwczovLyIrekRhdGEuenBTZXJ2ZXIrIi9rYi9qc3AvZG9jQ2hhdC5qc3A/aW52aXRlPSIrbisiJmRiSUQ9IituSWQ7IC8vRVJTMjAxMDE0CiAgICB2YXIgbW9yZURhdGE9IiZwYWdlcz0iK2RvYy5udW1QYWdlcysiJnNlbmRUbz0iK1goZG9jLCJDb250YWN0RmF4Iik7IC8vRVJTMjEwNzAzICM4Mzc2NwogICAgbW9yZURhdGErPSImeklkPSIrZG9jLmRiSUQrIiZ6SXRlbUlkPSIrbklkOyAvL0VSUzIzMDQwMSAjOTgxMTYgY29ubmVjdCB0byB6SENwcm9kIHJlY29yZAogICAgbW9yZURhdGErPSImd2hvPSIrZG9jLmtiRGF0YS5zZk9yZ2FuaXphdGlvbklEOyAvL0VSUzIzMDQwOCBtaWdodCBuZWVkIHRvIHVwZGF0ZSB0aGUgYXR0YWNoZWRUbyBvbiB0aGUgUkVESVJFQ1Qgd2l0aCB0aGUgcGF0aWVudCBJZAogICAgYWxlcnQoIkVSUzIxMDcwMyBtb3JlRGF0YT0iK21vcmVEYXRhKTsKCiAgICAvKiBUT0RPIGNhbGwgelJlZGlyZWN0LmpzcCB0byBnZXQgc2hvcnQgVVJMICovCiAgICB2YXIgcmVzdWx0c0I9IiIsIGk9LTEsIHNob3J0Qj0iIiwgc1VSTD0iIiwgcmVzdWx0cz0iIjsKICAgIHZhciB0ZW1wbGF0ZT1YKGRvYywidGVtcGxhdGVVUkwxIik7IC8vPHRlbXBsYXRlVVJMMT4wMDAwNWRjMFoxZ2x2M2NqaTQ6QWNjdENhcmRfRm9ybTwvdGVtcGxhdGVVUkwxPiAKICAgIHRlbXBsYXRlPSIiK2RvYy5CQVRFUzsgLy8wMDE0eDAwMDAxazFtTnpBQUktYXQtMDBENHgwMDAwMDVReDU5LUFjY3RDYXJkX0Zvcm0gLy9FUlMyMzA0MDYgIiIgdG8ga2VlcCBkZWZpbmVkICM5ODExNgogICAgaT10ZW1wbGF0ZS5sYXN0SW5kZXhPZigiLSIpOyBpZiAoaT4tMSAmJiB0ZW1wbGF0ZS5pbmRleE9mKCJfRm9ybSIpPi0xKSB7CiAgICAgICAgekRhdGEuZG9jVHlwZT10ZW1wbGF0ZS5zdWJzdHJpbmcoaSsxKS5yZXBsYWNlKCJfRm9ybSIsIiIpOwogICAgICAgIGlmICh6RGF0YS5kb2NUeXBlLmluZGV4T2YoIkNhcmQiKT4tMSkgekRhdGEuZG9jVHlwZT0iWkNBUkQiOyAvL0VSUzIzMDEwNyBUT0RPIG5vdCBzdWNoIGEgaGFjawogICAgICAgIGFsZXJ0KCJFUlMyMzAxMDcgbm93IHpEYXRhLmRvY1R5cGUgaXMgIit6RGF0YS5kb2NUeXBlKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlhfZG9jVHlwZSIsekRhdGEuZG9jVHlwZSk7CiAgICB9IGVsc2UgewogICAgICAgIGFsZXJ0KCJFUlMyMzAxMDcgbm8gam95IHdpdGggIit0ZW1wbGF0ZSsiIGluICIrZG9jLkJBVEVTKyIgb3IgIitkb2Mud2RkYXRhKTsKICAgIH0KICAgIHZhciBzdGFtcFVybD0iaHR0cDovL2xvY2FsaG9zdDoxODgwMC9yZWQvc3RhbXAiOwogICAgc3RhbXBVcmw9Imh0dHBzOi8vcXIubWQvcmVkL3N0YW1wIjsgLy9FUlMyMzAzMTMgIzk2ODIyIGVuYWJsZSBxYTkwIGFuZCBjbGllbnQgc3RhbXBpbmcKICAgIGlmICgxPT0xICYmICAoIiIrekRhdGEuZG9jVHlwZSkuaW5kZXhPZigiWkNBUkQiKSA9PSAtMSkgeyAvL0VSUzIzMDEwNyAjOTY4MjIgWkNBUkQgMT09MCB0ZXN0CiAgICAgICAgLy9FUlMyMzAyMTMgcmVzdWx0c0I9d2dldChkb2MsICJodHRwOi8vbG9jYWxob3N0OjgwODAva2IvanNwL3pSZWRpcmVjdC5qc3A/dmlld3M9LTEmWF9pbnZpdGVQSU4xPSIrUElOK21vcmVEYXRhKyImc2F2ZT0iK2xpbmtCLnJlcGxhY2UoIiYiLCIlMjYiKSk7IC8vRVJTMjAxMDEzIFRPRE8gb3RoZXIgelJlZGlyZWN0IGNvbnRyb2xzIG1vcmUgdGhhbiBqdXN0IHRoZSBQSU4KICAgICAgICByZXN1bHRzQj13Z2V0KGRvYywgc3RhbXBVcmwrIj92aWV3cz0tMSZYX2ludml0ZVBJTjE9IitQSU4rbW9yZURhdGErIiZzYXZlPSIrbGlua0IucmVwbGFjZSgiJiIsIiUyNiIpKTsgLy9FUlMyMDEwMTMgVE9ETyBvdGhlciB6UmVkaXJlY3QgY29udHJvbHMgbW9yZSB0aGFuIGp1c3QgdGhlIFBJTgogCiAgICAgICAgaT1yZXN1bHRzQi5pbmRleE9mKCJVUkwiKTsgCiAgICAgICAgLy9FUlMyMzAxMDcgaWYgKGk9PS0xKSBpPXJlc3VsdHNCLmluZGV4T2YoIlVybCIpOyAvL0VSUzIzMDEwNCB6aXBwaSBpcyBVcmwgbm90IFVSTCBhbmQgd2dldCBpcyBub3QgYSBwdXJlIHN0cmluZz8KICAgICAgICBzaG9ydEI9cmVzdWx0c0Iuc3Vic3RyaW5nKGkrNixyZXN1bHRzQi5sZW5ndGgoKS0zKzEpOyAvL0VSUzIzMDExMSArMSBmb3Igc29tZSBzdHJhbmdlIHJlYXNvbgogICAgICAgIAogICAgICAgIGlmIChzaG9ydEIuaW5kZXhPZigiLCIpPi0xKSBzaG9ydEI9c2hvcnRCLnN1YnN0cmluZygwLHNob3J0Qi5pbmRleE9mKCIsIikpOyAvL0VSUzIzMDMwOCBibG9ja2NoYWluIGFuZCBuZXcgcGF0aWVudHMgVE9ETyBKU09OIHJlc3VsdHNCLlVSTAogICAgICAgIGFsZXJ0KCJFUlMyMzA0MDEuMTEwIGRlc3RJZCBpbiByZXN1bHRzQj0iK3Jlc3VsdHNCKyIgc2hvcnRCPSIrc2hvcnRCKTsKICAgICAgICBpZiAoMT09MSkgewogICAgICAgICAgICBzaG9ydEI9cmVzdWx0c0Iuc3Vic3RyaW5nKGkrNixyZXN1bHRzQi5sZW5ndGgoKS0zKzIpOyAvL25vdyArMgogICAgICAgICAgICBpZiAoc2hvcnRCLmluZGV4T2YoIiwiKT4tMSkgc2hvcnRCPXNob3J0Qi5zdWJzdHJpbmcoMCxzaG9ydEIuaW5kZXhPZigiLCIpKTsgLy9FUlMyMzAzMDggYmxvY2tjaGFpbiBhbmQgbmV3IHBhdGllbnRzIFRPRE8gSlNPTiByZXN1bHRzQi5VUkwKICAgICAgICAgICAgc2hvcnRCPXNob3J0Qi5yZXBsYWNlKCImIiwiIikucmVwbGFjZSgiXCIiLCIiKTsKICAgICAgICAgICAgYWxlcnQoIkVSUzIzMDIxMS45OCByZXN1bHRzQj0iK3Jlc3VsdHNCKyIgc2hvcnRCPSIrc2hvcnRCKTsKICAgICAgICB9CiAgICAgICAgc2hvcnRCPXNob3J0Qi5yZXBsYWNlKCJodHRwOi8vbG9jYWxob3N0OjgwODA6ODA4MC8iLCJodHRwczovLyIrekRhdGEuenBTZXJ2ZXIrIi8iKTsKICAgICAgICBzaG9ydEI9c2hvcnRCLnJlcGxhY2UoImh0dHBzOi8vbG9jYWxob3N0OjgwODAvIiwiaHR0cHM6Ly8iK3pEYXRhLnpwU2VydmVyKyIvIik7CiAgICAgICAgc2hvcnRCPXNob3J0Qi5yZXBsYWNlKHpEYXRhLnpwU2VydmVyKyIva2Ivenp6LyIsInFyLm1kL2tiL3p6ei8iKTsgLy9FUlMyMzAzMTMgYWxsIHN0YW1wcyBvbiBxci5tZCBUT0RPIC9yL3ovIG9yIC8KICAgICAgICB2YXIgZXhwaXJlPW5ldyBEYXRlKCk7IGV4cGlyZS5zZXRUaW1lKGV4cGlyZS5nZXRUaW1lKCkrMTAwMCozNjAwKjI0KjcpOyAvLzIwMjEtMDYtMTAKICAgICAgICB2YXIgZXhwaXJlZD1mb3JtYXREYXRlKGV4cGlyZSwgIllZWVktTU0tREQiKTsKICAgICAgICBhbGVydCgiRVJTMjMwMTA0IHNob3J0Qj0iK3Nob3J0QisiIGZyb20gIityZXN1bHRzKTsKICAgICAgICAvL0VSUzIzMDIxMyBzVVJMPSJodHRwOi8vbG9jYWxob3N0OjgwODAva2IvanNwL3pSZWRpcmVjdC5qc3A/dW50aWw9IitleHBpcmVkK21vcmVEYXRhKyImdmlld3M9MSZzYXZlPSIrKGxpbmtBKyI7IitzaG9ydEIpLnJlcGxhY2UoIiYiLCIlMjYiKTsKICAgICAgICBzVVJMPXN0YW1wVXJsKyI/dW50aWw9IitleHBpcmVkK21vcmVEYXRhKyImdmlld3M9MSZzYXZlPSIrKGxpbmtBKyI7IitzaG9ydEIpLnJlcGxhY2UoIiYiLCIlMjYiKTsKICAgICAgICBzVVJMKz0iJnNhdmUwPSIrbGlua0IucmVwbGFjZSgiJiIsIiUyNiIpOyAvL0VSUzIzMDIxMyBmb3Igc21hcnRlciBjb250cmFjdHMKICAgICAgICBhbGVydCgiRVJTMjMwMTA0IHNVUkw9IitzVVJMKTsKICAgICAgICByZXN1bHRzPXdnZXQoZG9jLCBzVVJMKTsKICAgICAgICBpPXJlc3VsdHMuaW5kZXhPZigiVVJMIik7CiAgICAgICAgLy9FUlMyMzAxMDcgaWYgKGk9PS0xKSBpPXJlc3VsdHMuaW5kZXhPZigiVXJsIik7IC8vRVJTMjMwMTA0IHppcHBpIGlzIFVybCBub3QgVVJMCiAgICB9IGVsc2UgeyAvL0VSUzIzMDEwNyBaQ0FSRCBpcyBhIFFSIGNvZGUgdGhhdCBhbHdheXMgaGFzIGEgcHVibGljIGxhbmRpbmcgcGFnZQogICAgICAgIC8vRVJTMjMwMjE2IHNVUkw9Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9rYi9qc3AvelJlZGlyZWN0LmpzcD92aWV3cz0tMSZzYXZlPSIrKGxpbmtBKyI7IitsaW5rQSkucmVwbGFjZSgiJiIsIiUyNiIpOwogICAgICAgIHNVUkw9c3RhbXBVcmwrIj92aWV3cz0tMSZzYXZlPSIrKGxpbmtBKyI7IitsaW5rQSkucmVwbGFjZSgiJiIsIiUyNiIpOwogICAgICAgIHNVUkwrPW1vcmVEYXRhOyAvL0VSUzIzMDQwMSBmb3Igc2VuZFRvIGFuZCB6SXRlbQogICAgICAgIGFsZXJ0KCJFUlMyMzAxMDcgZG9jVHlwZT0iK3pEYXRhLmRvY1R5cGUrIiBzVVJMPSIrc1VSTCk7CiAgICAgICAgcmVzdWx0cz13Z2V0KGRvYywgc1VSTCk7CiAgICAgICAgaT1yZXN1bHRzLmluZGV4T2YoIlVSTCIpOwogICAgICAgIHJlc3VsdHNCPXJlc3VsdHM7IC8vRVJTMjMwNDA4IGJlc3QgZ3Vlc3MgZm9yIGRlc3RJZAogICAgfQogICAgYWxlcnQoIkVSUzIwMTAxNCBpPSIraSsiIHJlc3VsdHM9IityZXN1bHRzKTsgLy9FUlMyMTAyMTEgIzc3MDMyIGFkZGVkIFhfaW52aXRlUElOMSB0byByZWRpcmVjdAogICAgYWxlcnQoIkVSUzIxMDYwOSBpPSIraSsiIHJlc3VsdHNCPSIrcmVzdWx0c0IpOwogICAgCiAgICB2YXIgZGVzdElkPSIiOyAvL0VSUzIzMDQwMSAjOTgxMTYgZGVzdGluYXRpb24gcGF0aWVudCBvciBwcm92aWRlciByZWNvcmQgaW4gekhDIG9yZyB0byBzYXZlIGludG8gekl0ZW0KICAgIC8vRVJTMjMwNDA4IGdldCB0aGUgZGVzdElkIHRvIHRoZSBwYXRpZW50IG9yIHByb3ZpZGVyIGFuZCBzdG9yZSBpdCBpbiB0aGUgY29udHJhY3QKICAgIGRlc3RJZD1KU09OLnBhcnNlKHJlc3VsdHNCKS5wYXRpZW50SWQ7IC8vRVJTMjMwNDA4IG1ha2Ugb3IgdXBkYXRlIGFuZCBjb25uZWN0CiAgICBhcnJPZlBhaXJzLnB1c2goIlhfc3RhbXBEYXRhIixyZXN1bHRzKTsgLy9FUlMyMzA0MDggbG9vc2luZyBkYXRhPwogICAgCiAgICB2YXIgc3RhbXBYTUw9IiI7CiAgICBpZiAoaT4tMSAmJiByZXN1bHRzLmluZGV4T2YoIkVSUk9SIik9PS0xKSB7CiAgICAgICBsaW5rPXJlc3VsdHMuc3Vic3RyaW5nKGkrNixyZXN1bHRzLmxlbmd0aCgpLTMrMSk7ICAvL0VSUzIzMDExMSArMSBmb3Igc29tZSBzdHJhbmdlIHJlYXNvbgogICAgICAgaWYgKGxpbmsuaW5kZXhPZigiLCIpPi0xKSBsaW5rPWxpbmsuc3Vic3RyaW5nKDAsbGluay5pbmRleE9mKCIsIikpOyAvL0VSUzIzMDMwOCBibG9ja2NoYWluIGFuZCBuZXcgcGF0aWVudHMgVE9ETyBKU09OIHJlc3VsdHNCLlVSTAogICAgICAgIGFsZXJ0KCJFUlMyMzAyMTEuMTIyIHJlc3VsdHM9IityZXN1bHRzKyIgbGluaz0iK2xpbmspOwogICAgICAgIGlmICgxPT0xKSB7CiAgICAgICAgICAgIGxpbms9cmVzdWx0cy5zdWJzdHJpbmcoaSs2LHJlc3VsdHMubGVuZ3RoKCktMysyKTsgLy9ub3cgKzIKICAgICAgICAgICAgaWYgKGxpbmsuaW5kZXhPZigiLCIpPi0xKSBsaW5rPWxpbmsuc3Vic3RyaW5nKDAsbGluay5pbmRleE9mKCIsIikpOyAvL0VSUzIzMDMwOCBibG9ja2NoYWluIGFuZCBuZXcgcGF0aWVudHMgVE9ETyBKU09OIHJlc3VsdHNCLlVSTAogICAgICAgICAgICBsaW5rPWxpbmsucmVwbGFjZSgiJiIsIiIpLnJlcGxhY2UoIlwiIiwiIik7CiAgICAgICAgICAgIGFsZXJ0KCJFUlMyMzAyMTEuOTggcmVzdWx0cz0iK3Jlc3VsdHMrIiBsaW5rPSIrbGluayk7CiAgICAgICAgfQogICAgICAgbGluaz1saW5rLnJlcGxhY2UoImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MDo4MDgwLyIsImh0dHBzOi8vIit6RGF0YS56cFNlcnZlcisiLyIpOyAvL0VSUzIwMTAxNCBIQUNLIEpPS0lORyEhISEKICAgICAgIGxpbms9bGluay5yZXBsYWNlKCJodHRwczovL2xvY2FsaG9zdDo4MDgwLyIsImh0dHBzOi8vIit6RGF0YS56cFNlcnZlcisiLyIpOyAKICAgICAgIC8vVE9ETyBzYXZlIHRoZSBsaW5rIGludG8gU0YgZmllbGQgc28gdGhhdCBjb21tdW5pY2F0aW9uIHRlbXBsYXRlIGNhbiBhY2Nlc3MgaXQgNTAtODAgY2hhcnMgdXNlIFpQQVBFUl9fb3V0Ym91bmRGYXhUZW1wbGF0ZV9fYwogICAgICAgLy9UT0RPIG1pZ2h0IG5lZWQgdG8gYmUgdGhlIGludml0ZWQgcGVyc29uJ3MgSWQgc3RvcmVkIGluICtYKGRvYywiWF9pbnZpdGVJZCIrbikKICAgICAgIC8vdmFyIG1hcmt1cFhNTD1YKGRvYywiWF9tYXJrdXAiKTsKICAgICAgIHZhciBxcj1saW5rOyAvL0VSUzIzMDEyMyAjOTY4MjIKICAgICAgIAogICAgICAgaWYgKG1hcmt1cFhNTC5pbmRleE9mKCJaU1RBTVAiKT09LTEpIHsgLy9jb2RlPWh0dHBzOi8vZWRnZS56cGFwZXIuY29tL2tiL3p6ei8wWDFldThzZTFzYiZ3PTE2CiAgICAgICAgICAgIHFyPWxpbms7IC8vImh0dHBzOi8vIit6RGF0YS56cFNlcnZlcisiL2tiL3p6ei8iK3Nob3J0SUQrIiZ3PTE2IjsKICAgICAgICAgICAgLy9SRUFMUERGIGluIHBhZ2VfcGRmLmpzcCBidXQgbWFya3VwLmpzcCBwcmVmZXJzIDFzdCBzZXQKICAgICAgICAgICAgaWYgKCgiIit6RGF0YS5kb2NUeXBlKS5pbmRleE9mKCJaQ0FSRCIpICE9IC0xKSB7IC8vRVJTMjMwMTA3IFpDQVJEICM5NjgyMgogICAgICAgICAgICAgICAgdmFyIFNNUz1YKGRvYywiQ29udGFjdEZheCIpOyAvL0VSUzIxMDExOCBUT0RPIHN1cHBvcnQgaW5saW5lIGluIElOVklURW46U01TOmVtYWlsOlBJTiB2YWx1ZXMKICAgICAgICAgICAgICAgIHZhciBmYXg9WChkb2MsIkNvbnRhY3RGYXgiKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJFUlMyMzAxMDcgQ29udGFjdEZheD0iK2ZheCsgIiBmcm9tICIrZG9jLndkZGF0YSk7CiAgICAgICAgICAgICAgICAvL1RPRE8gRVJTMjMwMzE4IG1heWJlIGdldCBmcm9tIHNlbmRUbyBpZiBDb250YWN0RmF4IGlzIGVtcHR5CiAgICAgICAgICAgICAgICBpZiAoMT09MCkgeyAvL0VSUzIzMDQwOCAvcmVkL3N0YW1wIG5vdyBtYW5hZ2VzIG5ldyByZWNvcmRzCiAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICBpZiAoZmF4LmluZGV4T2YoIjEiKT09MCkgeyAvL0VSUzIzMDEwNyBUT0RPIENNQSBpZGVhcyBvciBwdXNoIHRvIE5vZGVSZWQKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1Byb3ZpZGVyPXdwb3N0KGRvYywiaHR0cHM6Ly9xci5tZC9yZWQvenFyL3Byb3ZpZGVyP2ZheD0iK2ZheCsiJnpJdGVtPSIrZG9jLmRiSUQpOwogICAgICAgICAgICAgICAgICAgICAgICBhbGVydCgiRVJTMjMwMTA3IG1hZGUgb3IgZm91bmQgIituZXdQcm92aWRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RJZD1KU09OKG5ld1Byb3ZpZGVyKS5pZDsgLy9FUlMyMzA0MDEgbWFrZSBhbmQgY29ubmVjdAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoU01TLmluZGV4T2YoIklOVklURSIpPT0wKSB7IC8vRVJTMjMwMTA3IFRPRE8gQ01BIGlkZWFzIG9yIHB1c2ggdG8gTm9kZVJlZAogICAgICAgICAgICAgICAgICAgICAgICBTTVM9U01TLnNwbGl0KCI6IilbMV07CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdQYXRpZW50PXdwb3N0KGRvYywiaHR0cHM6Ly9xci5tZC9yZWQvenFyL3BhdGllbnQ/c21zPSIrU01TKyImekl0ZW09Iitkb2MuZGJJRCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KCJFUlMyMzA0MDEuMTc1IG1hZGUgb3IgZm91bmQgcGF0aWVudCAiK25ld1BhdGllbnQpOwogICAgICAgICAgICAgICAgICAgICAgICBkZXN0SWQ9SlNPTi5wYXJzZShuZXdQYXRpZW50KS5pZDsgLy9FUlMyMzA0MDEgbWFrZSBvciB1cGRhdGUgYW5kIGNvbm5lY3QKICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoIkVSUzIzMDQwMSBwYXRpZW50ICIrZGVzdElkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzdGFtcE1hcmt1cD0iIjsgLy9FUlMyMTA3MzEgIzgzNzY3IG1pZ2h0IG5lZWQgdG8gYmUgZGlmZmVyZW50IGZvciBzaWduYXR1cmUgaW52aXRlCiAgICAgICAgICAgICAgICB2YXIgU1kxPTUwOwogICAgICAgICAgICAgICAgc3RhbXBNYXJrdXArPSJrYm0oJ0lNR1pTVEFNUF9SRUFMUERGQ09PUkRTJywnUEFHRTFJTUdaU1RBTVAnLCcva2IvanNwL3FyLmpzcD9jb2RlPXshcXJ9Jyw1NSw1NSwxMCwxMCwnJywnMTInLDQ1LDQ1LCIrU1grIiwiK1NZMSsiKTsiOwogICAgICAgICAgICAgICAgLy9FUlMyMjExMjkgIzkxNTUyIHpEYXRhLnN0YW1wTWFya3VwKz0ia2JtKCdJTUcxNjI3MTQ5MzE4MDM4X1JFQUxQREZDT09SRFMnLCdQQUdFMUlNRzE2MjcxNDkzMTgwMzgnLCdhZGRUZXh0Jyw5MywyMiwxMCw4MywnZmF4TUQub3JnJywnMTAnLDcwLDE2LDcsNzUwKTsiOwogICAgICAgICAgICAgICAgc3RhbXBNYXJrdXArPSJrYm0oJ0lNRzE2MjcxNDkzMTgwMzhfUkVBTFBERkNPT1JEUycsJ1BBR0UxSU1HMTYyNzE0OTMxODAzOCcsJ2FkZFRleHQnLDkzLDIyLDEwLDgzLCdxci5tZC8nLCc3Jyw3MCwxNiwiK1NYKyIsIitTWTErIik7IjsgLy9FUlMyMzAyMTYganVzdCBxci5tZCBub3QgenFyLm1kCiAgICAgICAgICAgICAgICBzdGFtcE1hcmt1cCs9ImtibSgnSU1HMTYyNzE0OTMxODAzOV9SRUFMUERGQ09PUkRTJywnUEFHRTFJTUcxNjI3MTQ5MzE4MDM5JywnYWRkVGV4dCcsOTMsMjIsMTAsODMsJ3shenp6WzAsNF19JywnNycsNzAsMTYsIitTWCsiLCIrKFNZMS0xNSkrIik7IjsKICAgICAgICAgICAgICAgIHN0YW1wTWFya3VwKz0ia2JtKCdJTUcxNjI3MTQ5MzE4MDQwX1JFQUxQREZDT09SRFMnLCdQQUdFMUlNRzE2MjcxNDkzMTgwNDAnLCdhZGRUZXh0Jyw5MywyMiwxMCw4MywneyF6enpbNSwxMF19JywnNycsNzAsMTYsIitTWCsiLCIrKFNZMS0zMCkrIik7IjsgLy9FUlMyMzAxMDQKCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKDE9PTEpIHsgLy9FUlMyMzAyMTYgYWxsIHpQYXBlciBzdGFtcHMgY29tZSBmcm9tIHFyLm1kCiAgICAgICAgICAgICAgICB2YXIgcno9IiI7IC8vRE9OT1QgcHV0IGEgLyBpbiBhIGRvY1RpdGxlIEVWRVIgLSAicmVkL3ovIjsgLy9jb3VsZCBub3QgZ2V0IGVtcHR5IHRvIHdvcmsgZG93bnN0cmVhbQogICAgICAgICAgICAgICAgdmFyIHpzPXpEYXRhLnpwU2VydmVyOyBpZiAoIXpzIHx8ICh6cy5pbmRleE9mKCJ6cGFwZXIuY29tIik9PS0xICYmIHpzICE9ICJxci5tZCIpKSBhbGVydCgiRVJTMjMwNDA2IHpEYXRhLnpwU2VydmVyIHN0aWxsIHdyb25nISIpOwogICAgICAgICAgICAgICAgcXI9cXIucmVwbGFjZSh6cysiL2tiL3p6ei8iLCJxci5tZC8iK3J6KTsgLy8gIi9yZWQvei8iIEVSUzIzMDMxOCBuZXh0IDMgbGluZXMgdG9vCiAgICAgICAgICAgICAgICBsaW5rPWxpbmsucmVwbGFjZSh6cysiL2tiL3p6ei8iLCJxci5tZC8iK3J6KTsgLy9FUlMyMzAxMTEgIzk2ODIyIG1pZ2h0IG5vdCBiZSBuZWVkZWQKICAgICAgICAgICAgICAgIGxpbmtBPWxpbmtBLnJlcGxhY2UoenMrIi9rYi96enovIiwicXIubWQvIityeik7CiAgICAgICAgICAgICAgICBsaW5rQj1saW5rQi5yZXBsYWNlKHpzKyIva2Ivenp6LyIsInFyLm1kLyIrcnopOwogICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgYWxlcnQoIkVSUzIzMDExMSBxcj0iK3FyKTsgLy8vaHR0cHM6Ly9xci5tZC8yWDFncnJmanRrcwogICAgICAgICAgICBzdGFtcFhNTD1zdGFtcE1hcmt1cC5yZXBsYWNlKCJ7IXFyfSIscXIpOwogICAgICAgICAgICB2YXIgenp6PXFyLnRvVXBwZXJDYXNlKCk7IAogICAgICAgICAgICB6eno9enp6LnN1YnN0cmluZygxK3p6ei5sYXN0SW5kZXhPZigiLyIpKTsgLy9FUlMyMzAzMTggL3JlZC96LyB0byAvCiAgICAgICAgICAgIAogICAgICAgICAgICBzdGFtcFhNTD1zdGFtcFhNTC5yZXBsYWNlKCJ7IXp6en0iLHp6eik7IC8vRVJTMjIxMTI5ICM5MTU1MgogICAgICAgICAgICBzdGFtcFhNTD1zdGFtcFhNTC5yZXBsYWNlKCJ7IXp6elswLDRdfSIsenp6LnN1YnN0cmluZygwLDUpKTsgLy9FUlMyMzAxMDQgIzkxNTUyCiAgICAgICAgICAgIHN0YW1wWE1MPXN0YW1wWE1MLnJlcGxhY2UoInshenp6WzUsMTBdfSIsenp6LnN1YnN0cmluZyg1KSk7IC8vRVJTMjMwMTA0ICM5MTU1MgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKDE9PTEpIGFyck9mUGFpcnMucHVzaCgiWF9tYXJrdXAiLG1hcmt1cFhNTCtzdGFtcFhNTCk7IC8vRVJTMjMwMTEwIGluIHppcHBpIF9Gb3JtIGlzIG5vdCBhIHJpc2sgYnV0IG5vdCBzdXJlIGluIGtiIEhBQ0sgRU9KCiAgICAgICAgICAgIGlmICgoIiIrZG9jLkJBVEVTKS5pbmRleE9mKCJfRm9ybSIpPT0tMSkgeyAvL0VSUzIzMDExMCBtb3ZlZCBiZWxvdyBaQ0FSRCBidXQgZXhwZWN0aW5nIHRoZSBjYWxsaW5nIGNvZGUgdG8gc2F2ZSB0aGUgbWFya3VwCiAgICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlhfbWFya3VwIixtYXJrdXBYTUwrc3RhbXBYTUwpOwogICAgICAgICAgICAgICAgLy9FUlMyMTA5MTEgVE9ETyBzZXQgQkFURVMgb2YgbmV3IGRvY3VtZW50IHRvIGJlIGFuIGludGVyYWN0aXZlIG9uZSB7IXNmSUR9QHshc2ZPcmd9LXtmb3JtSWR9CiAgICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goImRiLUJBVEVTIiwiTkVFRFMgVE8gQkUgeyFzZklEfUB7IXNmT3JnfS17Zm9ybUlkfSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgxPT0xKSB7IC8vVE9ETyBFUlMyMzA0MDggb25seSBtYWtlcyBzZW5zZSBvbiBaSENQIG5lZWQgb24gUkVESVJFQ1QgcmVjb3JkcyBpbnN0ZWFkCiAgICAgICAgICAgICAgICBpZiAoZGVzdElkKSB7IC8vRVJTMjMwNDAxICM5ODExNiBhdHRhY2ggdG8gZGVsaXZlcnkKICAgICAgICAgICAgICAgICAgICB2YXIgdj1YKGRvYywiWF9hdHRhY2hlZFRvIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHYrPSIsIitkZXN0SWQ7IGVsc2Ugdj1kZXN0SWQ7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoIkVSUzIzMDQwOC4yMjggZGVzdElkIHRvIFhfYXR0YWNoZWRUbyAiK3YpOwogICAgICAgICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiWF9hdHRhY2hlZFRvIix2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdElkPSIwMDE0eDAwMDAxT2JzdmNBQUIiOyAvL3pVc2VycyBpbiB6SENQcm9kIGZvciBsb3N0IHNoZWVwCiAgICAgICAgICAgICAgICAgICAgdmFyIHY9WChkb2MsIlhfYXR0YWNoZWRUbyIpOwogICAgICAgICAgICAgICAgICAgIGlmICh2KSB2Kz0iLCIrZGVzdElkOyBlbHNlIHY9ZGVzdElkOwogICAgICAgICAgICAgICAgICAgIGFsZXJ0KCJFUlMyMzA0MDEuMjE3IEZvcmNpbmcgWF9hdHRhY2hlZFRvICIrdik7CiAgICAgICAgICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJYX2F0dGFjaGVkVG8iLHYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZG9jLkJBVEVTKSB7IGRvYy5CQVRFUz1kZXN0SWQ7IH0gLy9FUlMyMzA3MjkgbmVlZCBzb21lIGNsZWFyIGRvY3VtZW50YXRpb24gb24gQkFURVMgZm9yIHFyLm1kLCBsYXRlc3QgemlwcGkgaGFzIG51bGwKICAgICAgIAogICAgICAgICAgIGlmICgxPT0xKSB7ICAvL0VSUzIzMDIxNiAjOTY4MjIgb25seSBpZiBzdGFtcCBhZGRlZAogICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlhfZGVsaXZlclN0YW1wIixsaW5rQSk7IC8vRVJTMjEwNjA5ICM4Mzc2NwogICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlhfcmV0cmlldmVTdGFtcCIsbGlua0IpOwogICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlhfc2VudFN0YW1wIixxcik7IC8vRVJTMjMwMTIzICM5NjgyMiBodHRwczovL3FyLm1kL3JlZC96LzJYMWduZm9sMXNtCiAgICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiWF96UVIiLHFyKTsgLy9FUlMyMzAxMjMgIzk2ODIyIGh0dHBzOi8vcXIubWQvcmVkL3ovMlgxZ25mb2wxc20KICAgICAgICAgICAgICAgaWYgKGRvYy5sYWJlbC5pbmRleE9mKCIxREQiKSA+IC0xIHx8IGRvYy5CQVRFUy5pbmRleE9mKCJOT19URU1QTEFURSIpID4gLTEpIHsgLy9FUlMyMzAyMTYgMUREIGhhY2sgLy9FUlMyMzAzMjUgIzk4MTE2IE5PX1QKICAgICAgICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiQkFURVMiLGRvYy5CQVRFUy5yZXBsYWNlKCJAIiwiLS1hdC0tIikpOyAKICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiQkFURVMiLGRvYy5CQVRFUy5yZXBsYWNlKCItYXQtIiwiQCIpKTsgCiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgYWxlcnQoIkVSUzIzMDIxMi4xNzkgQUxXQVlTIGFkZCBzdGFtcCB0aGlzIHdheSBYX3pRUj0iK3FyKyIgaW4gIitkb2MuZGJJRCsiIGZpeGVkICIrZG9jLkJBVEVTKTsKICAgICAgICAgICB9CiAgICAgICB9CiAgICAgICAKICAgICAgIAogICAgICAgLy9zYXZlIHRoZSBSRURJUkVDVCBJRCBiYWNrIGludG8gdGhlIG9yaWdpbmFsCiAgICAgICAgLy9FUlMyMzAyMTIgdXBkYXRlREIoZG9jLGFyck9mUGFpcnMpOwogICAgICAgIGlmICgxPT0xICYmIGRvYy5kYklEICE9ICJEVU1NWSIgJiYgZG9jLmxhYmVsLmluZGV4T2YoIkRVTU1ZIikgPT0gLTEpIHVwZGF0ZURCKGRvYyxhcnJPZlBhaXJzKTsvL0hBQ0sgVE8gREVNTwogICAgICAgIGVsc2UgYWxlcnQoIkVSUzIzMDIxMi4xODYgZG8gbm90IHNhdmUgelFSIGZvciAiK2RvYy5sYWJlbCsiICgiK2RvYy5kYklEKyIpIHRydXN0IHRoZSBmbG93IHRvIGRvIGl0Iik7CiAgICAgICAgCiAgICAgICAgYWxlcnQoIkVSUzIwMTExMC4yMyBzaWduSXQ9IitzaWduSGludHMgKyAiIFBJTiIrbisiPSIrUElOKTsKICAgICAgICAvL0VSUzIxMTEyMCBhZGRlZCBsaW5rIHRvIHRyYWNrCiAgICAgICAgdHJhY2soZG9jLCAiU1RBTVAuQ1JFQVRFIixsaW5rKyIgdG8gIisgdG8gKyI6IisgWChkb2MsIlhfaW52aXRlRW1haWwiK24pLnJlcGxhY2UoLyAvZywiKyIpLCAwKTsgLy9FUlMyMTAxMTIgaW52aXRlcyB0b28KICAgICAgICAvL0VSUzIxMDYwNSByZXR1cm4gbGluawogICAgICAgIHJldHVybiBzdGFtcFhNTDsgLy9FUlMyMTA2MTEgU0Zfc2VuZEZheC5qc3BmIGNhbGxzIHRoaXMgYWN0aW9uIGFuZCBuZWVkcyB0aGUgYWRkaXRpb25hbCBtYXJrdXAgWE1MIHRvIGFkZCB0byB0aGUgUERGIG5vdCB5ZXQgc3RvcmVkCiAgICB9IGVsc2UgewogICAgICAgIGFsZXJ0KCJTb21ldGhpbmcgd2VudCB3cm9uZyBjcmVhdGluZyB0aGUgc2VjdXJlIGxpbmsuIik7CiAgICAgICAgLy9yZXR1cm4gRVJST1IKICAgIH0KfTsKCnpEYXRhLm5vdGlmeT1mdW5jdGlvbihkb2MscmVxKSB7IC8vRVJTMjIwNDA5ICM5MDg4MiBpZiAoZG9jLlgoIlhfYnV0dG9uQWN0aW9uIikuaW5kZXhPZigiTk9USUZZIikpCiAgICB2YXIgbj0xOwogICAgdmFyIHRvPVgoZG9jLCJYX2ludml0ZVBob25lIituKTsKICAgIHZhciBQSU49WChkb2MsIlhfaW52aXRlUElOIituKTsKICAgIHZhciBsaW5rPVgoZG9jLCJYX3pRUiIpOwogICAgbGluaz1saW5rLnJlcGxhY2UoekRhdGEuenBTZXJ2ZXIsInFyLm1kIik7IC8vRVJTMjMwMzE2IGRlbW8gIzk2ODIyCiAgICB0bz1YKGRvYywiWF9pbnZpdGVQaG9uZSIrbik7CiAgICB2YXIgZnJvbT0iKzE1NzEyOTcyNzM3IjsKICAgIHZhciBjaGFubmVsPVgoZG9jLCJYX25vdGlmeUNoYW5uZWwiKTsKICAgIHZhciBzZW5kVG89WChkb2MsIlhfc2VuZFRvIik7CiAgICBpZiAoIXNlbmRUbykgc2VuZFRvPVgoZG9jLCJzZW5kVG8iKTsgLy9FUlMyMzAxMjMgIzk2ODIyCiAgICBpZiAoc2VuZFRvICYmIHNlbmRUbyAhPSB0bykgewogICAgICAgIGlmIChzZW5kVG8uaW5kZXhPZigiOiIpPi0xKSB7IHRvPXNlbmRUby5zcGxpdCgiOiIpWzFdOyB9IC8vRVJTMjMwMTIzCiAgICAgICAgZWxzZSB0bz1zZW5kVG87CiAgICAgICAgYWxlcnQoIk5vdGlmeSBkYklEPSIrZG9jLmRiSUQrIiBUT0RPIHNlZSBpZiBzZW5kVG8gb2YgIitzZW5kVG8rIiBpcyBhcHByb3ZlZCBmb3IgIitjaGFubmVsKTsKICAgICAgICAvL3RvPXNlbmRUbzsKICAgIH0gZWxzZSBhbGVydCgiUmVOb3RpZnkgZGJJRD0iK2RvYy5kYklEKyIgdG8gIit0bysiIGlzIGFscmVhZHkgYXBwcm92ZWQgZm9yICIrY2hhbm5lbCk7CiAgICAKICAgIGlmICghY2hhbm5lbCkgY2hhbm5lbD0iU01TIjsKICAgIGlmIChjaGFubmVsID09ICJTTVMiKSB7CiAgICAgICAgdmFyIGJvZHk9IlVzZSBQSU4gb2YgIitQSU4rICIgdG8gc2lnbiAiICsgZG9jLmxhYmVsOwogICAgICAgIGJvZHkrPSIgdXNpbmcgeW91ciBlbWFpbCBvciAiK2xpbms7CiAgICAgICAgaWYgKDE9PTEpIHNlbmRTTVMoZG9jLCBmcm9tLCB0bywgYm9keSk7CiAgICAgICAgdHJhY2soZG9jLCAiU0lHTi5JTlZJVEUiLCB0byArIjoiKyBYKGRvYywiWF9pbnZpdGVFbWFpbCIrbikucmVwbGFjZSgvIC9nLCIrIiksIDApOyAvL0VSUzIxMDExMiBpbnZpdGVzIHRvbwogICAgICAgIGFsZXJ0KCJzZW5kU01TIGFuZCBUUkFDSyBmb3IgU0lHTi5JTlZJVEUgdG8gIit0byk7IC8vRVJTMjMwMjE2IHNlbmRTTVMgc2VlbXMgdG8gYmUgaWdub3JlZAogICAgfQogICAgaWYgKGNoYW5uZWwgPT0gIkZBWCIpIHsKICAgICAgICBhbGVydCgiRmluZCB0aGUgb2xkIGZheCB3aXRoIEtCaW5QcmludCBhbmQgcmVzZW5kIGl0IHRvIHRoZSBuZXcgbnVtYmVyIik7CiAgICAgICAgLy9UT0RPIG5ldyBlbnZlbG9wZSB3aXRoIHNhbWUgUERGIGNyZWF0aW5nIG5ldyB6SXRlbQogICAgfQogICAgcmV0dXJuIHRvOwp9OyAvL0VSUzIzMDMzMCByZW1vdmVkIHRoZSBzdHJheSAtCgppZiAoZG9jLlgoIlhfYnV0dG9uQWN0aW9uIikgPT0gIkFERF9TVEFNUCIpIHsgCiAgICB2YXIgcmVzPXpEYXRhLmFkZFN0YW1wKGRvYywiIik7IAogICAgLy9wdXQgaXQgaW4gdGhlIG91dHB1dAogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsIHJlcyk7CiAgICBpZiAoMT09MSkgeyAvL0VSUzIzMDIxMiBub3Qgc3VyZSBpZiB1cGRhdGVEQiBpcyByZWFsbHkgd29ya2luZwogICAgICAgIGFsZXJ0KCJFbmQgb2YgIitkb2MuZGJJRCsiIGFkZFN0YW1wOiAiK3Jlcyk7CiAgICAgICAgaWYgKDE9PTEgJiYgZG9jLmRiSUQgIT0gIkRVTU1ZIiAmJiBkb2MubGFiZWwuaW5kZXhPZigiRFVNTVkiKSA9PSAtMSkgewogICAgICAgICAgICB6RGF0YS5ub3RpZnkoZG9jLCIiKTsgLy9IQUNLIFRPIERFTU8KICAgICAgICAgICAgLy9UT0RPIHNlbmQgdGhlIGVtYWlsIGZvciBJTlZJVEUgY2FsbHMgLy9FUlMyMzAyMTcgRU9KIHdvcmsgIzk2ODIyCiAgICAgICAgICAgIHZhciBsaW5rPVgoZG9jLCJYX3pRUiIpOwogICAgICAgICAgICBsaW5rPWxpbmsucmVwbGFjZSh6RGF0YS56cFNlcnZlciwicXIubWQiKTsgLy9FUlMyMzAzMTYgZGVtbyAjOTY4MjIKICAgICAgICAgICAgdmFyIGJvZHk9IkNoZWNrIHlvdXIgcGhvbmUgZm9yIHRoZSBQSU4gbmVlZGVkIHRvIHNpZ24gdGhpcyBkb2N1bWVudC4gIE9uY2UgeW91IHJlY2VpdmUgaXQgdGhlbiBjbGljayAiK2xpbmsKICAgICAgICAgICAgKyIgZnJvbSBhbnkgd2ViIGJyb3dzZXIgb3IgbW9iaWxlIGRldmljZSB0byB2aWV3IG9yIHNpZ24gdGhlIGRvY3VtZW50LiI7CiAgICAgICAgICAgIHZhciBzZW5kVG89WChkb2MsIlhfc2VuZFRvIik7CiAgICAgICAgICAgIGlmICghc2VuZFRvKSBzZW5kVG89WChkb2MsInNlbmRUbyIpOwogICAgICAgICAgICB2YXIgdG9FbWFpbD1zZW5kVG8uc3BsaXQoIjoiKVsyXTsgCiAgICAgICAgICAgIGlmICh0b0VtYWlsKSB7IC8vRVJTMjMwNDA3IGp1c3QgZmF4aW5nIG5vIGVtYWlsIG5lZWRlZAogICAgICAgICAgICAgICAgdG9FbWFpbD10b0VtYWlsLnJlcGxhY2UoLyAvZywiKyIpOwogICAgICAgICAgICAgICAgdmFyIHVzZXJFbWFpbD0ic3VwcG9ydCtxcm1kQHpwYXBlci5jb20iOwogICAgICAgICAgICAgICAgaWYgKHRvRW1haWwuaW5kZXhPZigiQCIpPi0xKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHIxPXNlbmRFbWFpbChkb2MsdXNlckVtYWlsLHRvRW1haWwsInpQYXBlciBTaGFyZSBhbmQgU2lnbmluZyIsYm9keSk7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoIkVtYWlsIGZvciAiK3IxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoIk1pc3NpbmcgZW1haWwgaW4gIitzZW5kVG8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWxlcnQoIkVSUzIzMDQwNi4zMTQganVzdCBmYXhpbmcgdG8gIitzZW5kVG8pOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGFsZXJ0KCJFUlMyMzAyMTIgZG8gbm90IHN0YW1wLW5vdGlmeSBmb3IgIitkb2MubGFiZWwrIiAoIitkb2MuZGJJRCsiKSIpOwogICAgICAgIHJldHVybiByZXM7CiAgICB9Cn0KCmlmIChkb2MuWCgiWF9idXR0b25BY3Rpb24iKS5pbmRleE9mKCJOT1RJRlkiKT09PTApIHsgLy9FUlMyMjA0MDkgIzkwODgyCiAgICB2YXIgcmVzPXpEYXRhLm5vdGlmeShkb2MsIiIpOwogICAgYWxlcnQoIkVuZCBvZiBOb3RpZnk6ICIrcmVzKTsKICAgIHJldHVybiByZXM7CiAgICAvL2FkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCByZXMpOwp9"},"ordinal":3}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
//ERS210605 create QR code and Blockchain contract to enable faster, digital access
if (doc.X("X_buttonAction") == "ADD_STAMP") {
    rool.evalContinue=false; //stops the bus!
}
if (doc.X("X_buttonAction").indexOf("NOTIFY")===0) { //ERS220409 #90882
    rool.evalContinue=false; //stops the bus!
}

//make a REDIRECT snippet
//create the  blockchain smart contract
//1st URL is open then require a PIN
//return a URL for the QR code
alert("ERS230615 made from "+X(doc,"KBinPrint"));
alert("ERS230615 made from "+X(doc,"ContactFax"));
zData.alreadyStamped=X(doc,"ContactFax"); //ERS230616 TODO save the existing stamp into KBinPrint
if (zData.alreadyStamped.toUpperCase().indexOf("PDF")>-1) { zData.sslFax=false; alert("ERS230615 do not restamp "+zData.alreadyStamped); } //ERS230615
alert("ERS230615 doc.kbData="+doc.kbData);
alert("ERS230615 zData="+zData.toString()); //ERS230615 need to see if the stamp on the incoming sendTo PDF already exists
if (!zData || !zData.docType) zData.docType="ZTAMPZ"; //ERS230513
alert("ERS230513 zData.docType="+zData.docType);
if ((""+zData.docType).indexOf("ZCARD") != -1) {zData.stampY=50; zData.stampX=17; } 
//TODO in template set -1 for no stamps or use zData.docType
if (!zData.stampX) { zData.stampX=17; }
if (!zData.stampY) { zData.stampY=750; }
//zData.stampX=37; //ERS230318 testing movement #96822
var SY=zData.stampY/1; var SX=zData.stampX/1;
zData.stampMarkup=""; //ERS210731 #83767 might need to be different for signature invite
zData.stampMarkup+="kbm('IMGZSTAMP_REALPDFCOORDS','PAGE1IMGZSTAMP','/kb/jsp/qr.jsp?code={!qr}',55,55,10,10,'','12',45,45,"+SX+","+SY+");";
//ERS221129 #91552 zData.stampMarkup+="kbm('IMG1627149318038_REALPDFCOORDS','PAGE1IMG1627149318038','addText',93,22,10,83,'faxMD.org','10',70,16,7,750);";
zData.stampMarkup+="kbm('IMG1627149318038_REALPDFCOORDS','PAGE1IMG1627149318038','addText',93,22,10,83,'qr.md/','7',70,16,"+SX+","+SY+");"; //ERS230216 just qr.md not zqr.md
zData.stampMarkup+="kbm('IMG1627149318039_REALPDFCOORDS','PAGE1IMG1627149318039','addText',93,22,10,83,'{!zzz[0,4]}','7',70,16,"+SX+","+(SY-15)+");";
zData.stampMarkup+="kbm('IMG1627149318040_REALPDFCOORDS','PAGE1IMG1627149318040','addText',93,22,10,83,'{!zzz[5,10]}','7',70,16,"+SX+","+(SY-30)+");"; //ERS230104
if (zData.stampX<0 || zData.stampY<0) { zData.stampMarkup=""; zData.sslFax=false; alert("ERS230318.21 turned off stamps for this pdf"); }

zData.addStamp=function(doc,req) {
    var stampMarkup="get from zData"; //ERS211120 cleaning up
    //ERS211120 faxmd to faxMD and looking for place for ZQR url to keep forever
    stampMarkup=zData.stampMarkup; //ERS210731
    if (!zData.sslFax) { alert("ERS230318 not stamping!"); } //ERS230318 #96822 need another case
    //BAD BAD testing ERS230616
    if (!zData.sslFax) { alert("ERS230615 not stamping!"); return ""; } //ERS230615 perhaps an existing stamped document
    var userEmail=doc.XOrg("X_crmUser");
    if (userEmail.indexOf("@")==-1) userEmail="support+sign@zpaper.com";
    //track(doc,"invite sent","inviting "+X(doc,"X_inviteEmail"+n).replace(/ /g,"+"), 0);
    alert("ERS201207.09 zpServer="+doc.kbData.HOST);
    zData.zpServer=(""+doc.kbData.HOST).replace("http://","").replace(":8080","").replace("https://",""); //ERS201204 #77302 //ERS201206 more engine replaces
    if (!zData.zpServer) zData.zpServer="edge.zpaper.com"; //ERS191110 #64160 TODO get a server
    zData.zpServer=zData.zpServer.replace("a.zpaper.com",".zpaper.com").replace("b.zpaper.com",".zpaper.com"); //ERS230729 HACk qr.md on zp50
    if ((""+zData.zpServer).indexOf("zpaper.com")==-1) { //ERS TODO doc.zpServer needed for zippi
        zData.zpServer="edge.zpaper.com";
        alert("ERS230212.32 ZIPPI BUSTED!!!");
        doc.kbData.HOST=zData.zpServer;
    }
    alert("ERS201204.11 zpServer is "+zData.zpServer);
    var markupXML=""+X(doc,"X_markup"); //ERS210611 added "" for NPE
    alert("ERS210612 mXML="+markupXML);
    if (markupXML.indexOf("ZSTAMP")!=-1) {
        alert("ALREADY ZSTAMPED!");
        var zstamp=""+X(doc,"X_deliverStamp");
        if (zstamp.indexOf(".com/") == -1) {
            alert("REDIRECT broken? "+zstamp);
        } else {
            return zstamp; //probably should be stampMarkup.replace("{!qr}",zstamp);
        }
    }
    
    var n=1;
    var arrOfPairs=[];
    var PIN=X(doc,"X_invitePIN"+n); //ERS210118 TODO support inline in INVITEn:SMS:email:PIN values
    PIN=""+X(doc,"ContactFax"); //TODO clean up to 10 digits
    var to=PIN; //fax or SMS number
    if (PIN != "PDF") { PIN=X(doc,"X_invitePIN"+n); } //ERS230407 not sure why we ever did the ContactFax thing!  Do NOT stamp PDF delivery
    if (!PIN || (""+PIN).indexOf("PDF") != -1 || (""+PIN).indexOf(":") != -1) { //make one up //ERS211120 PDF //ERS230212 check string & ":"
        PIN="30076";
        if (1===1) { PIN=0;	while (PIN<10000) { PIN=Math.floor(100000*Math.random()); } } //ERS210912 PIN back on
    }
    arrOfPairs.push("X_invitePIN"+n, (""+PIN));
    var signHints="<X_invitePIN"+n+">"+PIN+"</X_invitePIN"+n+">";
    arrOfPairs.push("X_signIt", signHints);

    //create a one time use redirect (A) to download or view the PDF or embedded data
    //stamp contains the A link as a QR code
    //create a contract redirect (B) with a PIN to view / sign / markup the PDF afterwards
    //after the 1st time A is used change the forward from A to goto B
    //ERS210612 once a redirect is out of views if there is a ; then forward to it
    
    alert("ERS210612.54 doc.BATES may be null");
    //ERS221107 var nId=""+X(doc,"X_zItemId"); if (!nId && (""+doc.BATES).indexOf("_Form")==-1) nId=doc.dbID; //ERS210611 204007e4Z1dkjni2il
    var nId=""+X(doc,"X_zItemId");  if (!nId) nId=doc.dbID; //ERS210611 TODO check if zData.sslFax then  (""+doc.BATES).indexOf("_Form")==-1
    alert("ERS221107.66 check zData.sslFax="+zData.sslFax +" zData.zippiMode="+zData.zippiMode);
    if (!nId) { return "ERROR: Templates do not need stamps"; }
    
    var linkA="https://"+zData.zpServer+"/kb/pdf/"+nId+"/zitem.pdf"; //ERS201014
    var linkB="https://"+zData.zpServer+"/kb/jsp/docChat.jsp?invite="+n+"&dbID="+nId; //ERS201014
    var moreData="&pages="+doc.numPages+"&sendTo="+X(doc,"ContactFax"); //ERS210703 #83767
    moreData+="&zId="+doc.dbID+"&zItemId="+nId; //ERS230401 #98116 connect to zHCprod record
    moreData+="&who="+doc.kbData.sfOrganizationID; //ERS230408 might need to update the attachedTo on the REDIRECT with the patient Id
    alert("ERS210703 moreData="+moreData);

    /* TODO call zRedirect.jsp to get short URL */
    var resultsB="", i=-1, shortB="", sURL="", results="";
    var template=X(doc,"templateURL1"); //<templateURL1>00005dc0Z1glv3cji4:AcctCard_Form</templateURL1> 
    template=""+doc.BATES; //0014x00001k1mNzAAI-at-00D4x000005Qx59-AcctCard_Form //ERS230406 "" to keep defined #98116
    i=template.lastIndexOf("-"); if (i>-1 && template.indexOf("_Form")>-1) {
        zData.docType=template.substring(i+1).replace("_Form","");
        if (zData.docType.indexOf("Card")>-1) zData.docType="ZCARD"; //ERS230107 TODO not such a hack
        alert("ERS230107 now zData.docType is "+zData.docType);
        arrOfPairs.push("X_docType",zData.docType);
    } else {
        alert("ERS230107 no joy with "+template+" in "+doc.BATES+" or "+doc.wddata);
    }
    var stampUrl="http://localhost:18800/red/stamp";
    stampUrl="https://qr.md/red/stamp"; //ERS230313 #96822 enable qa90 and client stamping
    if (1==1 &&  (""+zData.docType).indexOf("ZCARD") == -1) { //ERS230107 #96822 ZCARD 1==0 test
        //ERS230213 resultsB=wget(doc, "http://localhost:8080/kb/jsp/zRedirect.jsp?views=-1&X_invitePIN1="+PIN+moreData+"&save="+linkB.replace("&","%26")); //ERS201013 TODO other zRedirect controls more than just the PIN
        resultsB=wget(doc, stampUrl+"?views=-1&X_invitePIN1="+PIN+moreData+"&save="+linkB.replace("&","%26")); //ERS201013 TODO other zRedirect controls more than just the PIN
 
        i=resultsB.indexOf("URL"); 
        //ERS230107 if (i==-1) i=resultsB.indexOf("Url"); //ERS230104 zippi is Url not URL and wget is not a pure string?
        shortB=resultsB.substring(i+6,resultsB.length()-3+1); //ERS230111 +1 for some strange reason
        
        if (shortB.indexOf(",")>-1) shortB=shortB.substring(0,shortB.indexOf(",")); //ERS230308 blockchain and new patients TODO JSON resultsB.URL
        alert("ERS230401.110 destId in resultsB="+resultsB+" shortB="+shortB);
        if (1==1) {
            shortB=resultsB.substring(i+6,resultsB.length()-3+2); //now +2
            if (shortB.indexOf(",")>-1) shortB=shortB.substring(0,shortB.indexOf(",")); //ERS230308 blockchain and new patients TODO JSON resultsB.URL
            shortB=shortB.replace("&","").replace("\"","");
            alert("ERS230211.98 resultsB="+resultsB+" shortB="+shortB);
        }
        shortB=shortB.replace("http://localhost:8080:8080/","https://"+zData.zpServer+"/");
        shortB=shortB.replace("https://localhost:8080/","https://"+zData.zpServer+"/");
        shortB=shortB.replace(zData.zpServer+"/kb/zzz/","qr.md/kb/zzz/"); //ERS230313 all stamps on qr.md TODO /r/z/ or /
        var expire=new Date(); expire.setTime(expire.getTime()+1000*3600*24*7); //2021-06-10
        var expired=formatDate(expire, "YYYY-MM-DD");
        alert("ERS230104 shortB="+shortB+" from "+results);
        //ERS230213 sURL="http://localhost:8080/kb/jsp/zRedirect.jsp?until="+expired+moreData+"&views=1&save="+(linkA+";"+shortB).replace("&","%26");
        sURL=stampUrl+"?until="+expired+moreData+"&views=1&save="+(linkA+";"+shortB).replace("&","%26");
        sURL+="&save0="+linkB.replace("&","%26"); //ERS230213 for smarter contracts
        alert("ERS230104 sURL="+sURL);
        results=wget(doc, sURL);
        i=results.indexOf("URL");
        //ERS230107 if (i==-1) i=results.indexOf("Url"); //ERS230104 zippi is Url not URL
    } else { //ERS230107 ZCARD is a QR code that always has a public landing page
        //ERS230216 sURL="http://localhost:8080/kb/jsp/zRedirect.jsp?views=-1&save="+(linkA+";"+linkA).replace("&","%26");
        sURL=stampUrl+"?views=-1&save="+(linkA+";"+linkA).replace("&","%26");
        sURL+=moreData; //ERS230401 for sendTo and zItem
        alert("ERS230107 docType="+zData.docType+" sURL="+sURL);
        results=wget(doc, sURL);
        i=results.indexOf("URL");
        resultsB=results; //ERS230408 best guess for destId
    }
    alert("ERS201014 i="+i+" results="+results); //ERS210211 #77032 added X_invitePIN1 to redirect
    alert("ERS210609 i="+i+" resultsB="+resultsB);
    
    var destId=""; //ERS230401 #98116 destination patient or provider record in zHC org to save into zItem
    //ERS230408 get the destId to the patient or provider and store it in the contract
    destId=JSON.parse(resultsB).patientId; //ERS230408 make or update and connect
    arrOfPairs.push("X_stampData",results); //ERS230408 loosing data?
    
    var stampXML="";
    if (i>-1 && results.indexOf("ERROR")==-1) {
       link=results.substring(i+6,results.length()-3+1);  //ERS230111 +1 for some strange reason
       if (link.indexOf(",")>-1) link=link.substring(0,link.indexOf(",")); //ERS230308 blockchain and new patients TODO JSON resultsB.URL
        alert("ERS230211.122 results="+results+" link="+link);
        if (1==1) {
            link=results.substring(i+6,results.length()-3+2); //now +2
            if (link.indexOf(",")>-1) link=link.substring(0,link.indexOf(",")); //ERS230308 blockchain and new patients TODO JSON resultsB.URL
            link=link.replace("&","").replace("\"","");
            alert("ERS230211.98 results="+results+" link="+link);
        }
       link=link.replace("http://localhost:8080:8080/","https://"+zData.zpServer+"/"); //ERS201014 HACK JOKING!!!!
       link=link.replace("https://localhost:8080/","https://"+zData.zpServer+"/"); 
       //TODO save the link into SF field so that communication template can access it 50-80 chars use ZPAPER__outboundFaxTemplate__c
       //TODO might need to be the invited person's Id stored in +X(doc,"X_inviteId"+n)
       //var markupXML=X(doc,"X_markup");
       var qr=link; //ERS230123 #96822
       
       if (markupXML.indexOf("ZSTAMP")==-1) { //code=https://edge.zpaper.com/kb/zzz/0X1eu8se1sb&w=16
            qr=link; //"https://"+zData.zpServer+"/kb/zzz/"+shortID+"&w=16";
            //REALPDF in page_pdf.jsp but markup.jsp prefers 1st set
            if ((""+zData.docType).indexOf("ZCARD") != -1) { //ERS230107 ZCARD #96822
                var SMS=X(doc,"ContactFax"); //ERS210118 TODO support inline in INVITEn:SMS:email:PIN values
                var fax=X(doc,"ContactFax");
                alert("ERS230107 ContactFax="+fax+ " from "+doc.wddata);
                //TODO ERS230318 maybe get from sendTo if ContactFax is empty
                if (1==0) { //ERS230408 /red/stamp now manages new records
                    /*
                    if (fax.indexOf("1")==0) { //ERS230107 TODO CMA ideas or push to NodeRed
                        var newProvider=wpost(doc,"https://qr.md/red/zqr/provider?fax="+fax+"&zItem="+doc.dbID);
                        alert("ERS230107 made or found "+newProvider);
                        destId=JSON(newProvider).id; //ERS230401 make and connect
                    }
                    if (SMS.indexOf("INVITE")==0) { //ERS230107 TODO CMA ideas or push to NodeRed
                        SMS=SMS.split(":")[1];
                        var newPatient=wpost(doc,"https://qr.md/red/zqr/patient?sms="+SMS+"&zItem="+doc.dbID);
                        alert("ERS230401.175 made or found patient "+newPatient);
                        destId=JSON.parse(newPatient).id; //ERS230401 make or update and connect
                        alert("ERS230401 patient "+destId);
                    }
                    */
                }

                stampMarkup=""; //ERS210731 #83767 might need to be different for signature invite
                var SY1=50;
                stampMarkup+="kbm('IMGZSTAMP_REALPDFCOORDS','PAGE1IMGZSTAMP','/kb/jsp/qr.jsp?code={!qr}',55,55,10,10,'','12',45,45,"+SX+","+SY1+");";
                //ERS221129 #91552 zData.stampMarkup+="kbm('IMG1627149318038_REALPDFCOORDS','PAGE1IMG1627149318038','addText',93,22,10,83,'faxMD.org','10',70,16,7,750);";
                stampMarkup+="kbm('IMG1627149318038_REALPDFCOORDS','PAGE1IMG1627149318038','addText',93,22,10,83,'qr.md/','7',70,16,"+SX+","+SY1+");"; //ERS230216 just qr.md not zqr.md
                stampMarkup+="kbm('IMG1627149318039_REALPDFCOORDS','PAGE1IMG1627149318039','addText',93,22,10,83,'{!zzz[0,4]}','7',70,16,"+SX+","+(SY1-15)+");";
                stampMarkup+="kbm('IMG1627149318040_REALPDFCOORDS','PAGE1IMG1627149318040','addText',93,22,10,83,'{!zzz[5,10]}','7',70,16,"+SX+","+(SY1-30)+");"; //ERS230104

            }
            if (1==1) { //ERS230216 all zPaper stamps come from qr.md
                var rz=""; //DONOT put a / in a docTitle EVER - "red/z/"; //could not get empty to work downstream
                var zs=zData.zpServer; if (!zs || (zs.indexOf("zpaper.com")==-1 && zs != "qr.md")) alert("ERS230406 zData.zpServer still wrong!");
                qr=qr.replace(zs+"/kb/zzz/","qr.md/"+rz); // "/red/z/" ERS230318 next 3 lines too
                link=link.replace(zs+"/kb/zzz/","qr.md/"+rz); //ERS230111 #96822 might not be needed
                linkA=linkA.replace(zs+"/kb/zzz/","qr.md/"+rz);
                linkB=linkB.replace(zs+"/kb/zzz/","qr.md/"+rz);
            }
                
            alert("ERS230111 qr="+qr); ///https://qr.md/2X1grrfjtks
            stampXML=stampMarkup.replace("{!qr}",qr);
            var zzz=qr.toUpperCase(); 
            zzz=zzz.substring(1+zzz.lastIndexOf("/")); //ERS230318 /red/z/ to /
            
            stampXML=stampXML.replace("{!zzz}",zzz); //ERS221129 #91552
            stampXML=stampXML.replace("{!zzz[0,4]}",zzz.substring(0,5)); //ERS230104 #91552
            stampXML=stampXML.replace("{!zzz[5,10]}",zzz.substring(5)); //ERS230104 #91552
            
            if (1==1) arrOfPairs.push("X_markup",markupXML+stampXML); //ERS230110 in zippi _Form is not a risk but not sure in kb HACK EOJ
            if ((""+doc.BATES).indexOf("_Form")==-1) { //ERS230110 moved below ZCARD but expecting the calling code to save the markup
                arrOfPairs.push("X_markup",markupXML+stampXML);
                //ERS210911 TODO set BATES of new document to be an interactive one {!sfID}@{!sfOrg}-{formId}
                arrOfPairs.push("db-BATES","NEEDS TO BE {!sfID}@{!sfOrg}-{formId}");
            }
            if (1==1) { //TODO ERS230408 only makes sense on ZHCP need on REDIRECT records instead
                if (destId) { //ERS230401 #98116 attach to delivery
                    var v=X(doc,"X_attachedTo");
                    if (v) v+=","+destId; else v=destId;
                    alert("ERS230408.228 destId to X_attachedTo "+v);
                    arrOfPairs.push("X_attachedTo",v);
                } else {
                    destId="0014x00001ObsvcAAB"; //zUsers in zHCProd for lost sheep
                    var v=X(doc,"X_attachedTo");
                    if (v) v+=","+destId; else v=destId;
                    alert("ERS230401.217 Forcing X_attachedTo "+v);
                    arrOfPairs.push("X_attachedTo",v);
                }
            }
            if (!doc.BATES) { doc.BATES=destId; } //ERS230729 need some clear documentation on BATES for qr.md, latest zippi has null
       
           if (1==1) {  //ERS230216 #96822 only if stamp added
               arrOfPairs.push("X_deliverStamp",linkA); //ERS210609 #83767
               arrOfPairs.push("X_retrieveStamp",linkB);
               arrOfPairs.push("X_sentStamp",qr); //ERS230123 #96822 https://qr.md/red/z/2X1gnfol1sm
               arrOfPairs.push("X_zQR",qr); //ERS230123 #96822 https://qr.md/red/z/2X1gnfol1sm
               if (doc.label.indexOf("1DD") > -1 || doc.BATES.indexOf("NO_TEMPLATE") > -1) { //ERS230216 1DD hack //ERS230325 #98116 NO_T
                   arrOfPairs.push("BATES",doc.BATES.replace("@","--at--")); 
               } else {
                   arrOfPairs.push("BATES",doc.BATES.replace("-at-","@")); 
               }
               alert("ERS230212.179 ALWAYS add stamp this way X_zQR="+qr+" in "+doc.dbID+" fixed "+doc.BATES);
           }
       }
       
       
       //save the REDIRECT ID back into the original
        //ERS230212 updateDB(doc,arrOfPairs);
        if (1==1 && doc.dbID != "DUMMY" && doc.label.indexOf("DUMMY") == -1) updateDB(doc,arrOfPairs);//HACK TO DEMO
        else alert("ERS230212.186 do not save zQR for "+doc.label+" ("+doc.dbID+") trust the flow to do it");
        
        alert("ERS201110.23 signIt="+signHints + " PIN"+n+"="+PIN);
        //ERS211120 added link to track
        track(doc, "STAMP.CREATE",link+" to "+ to +":"+ X(doc,"X_inviteEmail"+n).replace(/ /g,"+"), 0); //ERS210112 invites too
        //ERS210605 return link
        return stampXML; //ERS210611 SF_sendFax.jspf calls this action and needs the additional markup XML to add to the PDF not yet stored
    } else {
        alert("Something went wrong creating the secure link.");
        //return ERROR
    }
};

zData.notify=function(doc,req) { //ERS220409 #90882 if (doc.X("X_buttonAction").indexOf("NOTIFY"))
    var n=1;
    var to=X(doc,"X_invitePhone"+n);
    var PIN=X(doc,"X_invitePIN"+n);
    var link=X(doc,"X_zQR");
    link=link.replace(zData.zpServer,"qr.md"); //ERS230316 demo #96822
    to=X(doc,"X_invitePhone"+n);
    var from="+15712972737";
    var channel=X(doc,"X_notifyChannel");
    var sendTo=X(doc,"X_sendTo");
    if (!sendTo) sendTo=X(doc,"sendTo"); //ERS230123 #96822
    if (sendTo && sendTo != to) {
        if (sendTo.indexOf(":")>-1) { to=sendTo.split(":")[1]; } //ERS230123
        else to=sendTo;
        alert("Notify dbID="+doc.dbID+" TODO see if sendTo of "+sendTo+" is approved for "+channel);
        //to=sendTo;
    } else alert("ReNotify dbID="+doc.dbID+" to "+to+" is already approved for "+channel);
    
    if (!channel) channel="SMS";
    if (channel == "SMS") {
        var body="Use PIN of "+PIN+ " to sign " + doc.label;
        body+=" using your email or "+link;
        if (1==1) sendSMS(doc, from, to, body);
        track(doc, "SIGN.INVITE", to +":"+ X(doc,"X_inviteEmail"+n).replace(/ /g,"+"), 0); //ERS210112 invites too
        alert("sendSMS and TRACK for SIGN.INVITE to "+to); //ERS230216 sendSMS seems to be ignored
    }
    if (channel == "FAX") {
        alert("Find the old fax with KBinPrint and resend it to the new number");
        //TODO new envelope with same PDF creating new zItem
    }
    return to;
}; //ERS230330 removed the stray -

if (doc.X("X_buttonAction") == "ADD_STAMP") { 
    var res=zData.addStamp(doc,""); 
    //put it in the output
    addPostExecutionScript(doc, res);
    if (1==1) { //ERS230212 not sure if updateDB is really working
        alert("End of "+doc.dbID+" addStamp: "+res);
        if (1==1 && doc.dbID != "DUMMY" && doc.label.indexOf("DUMMY") == -1) {
            zData.notify(doc,""); //HACK TO DEMO
            //TODO send the email for INVITE calls //ERS230217 EOJ work #96822
            var link=X(doc,"X_zQR");
            link=link.replace(zData.zpServer,"qr.md"); //ERS230316 demo #96822
            var body="Check your phone for the PIN needed to sign this document.  Once you receive it then click "+link
            +" from any web browser or mobile device to view or sign the document.";
            var sendTo=X(doc,"X_sendTo");
            if (!sendTo) sendTo=X(doc,"sendTo");
            var toEmail=sendTo.split(":")[2]; 
            if (toEmail) { //ERS230407 just faxing no email needed
                toEmail=toEmail.replace(/ /g,"+");
                var userEmail="support+qrmd@zpaper.com";
                if (toEmail.indexOf("@")>-1) {
                    var r1=sendEmail(doc,userEmail,toEmail,"zPaper Share and Signing",body);
                    alert("Email for "+r1);
                } else {
                    alert("Missing email in "+sendTo);
                }
            } else {
                alert("ERS230406.314 just faxing to "+sendTo);
            }
        } else alert("ERS230212 do not stamp-notify for "+doc.label+" ("+doc.dbID+")");
        return res;
    }
}

if (doc.X("X_buttonAction").indexOf("NOTIFY")===0) { //ERS220409 #90882
    var res=zData.notify(doc,"");
    alert("End of Notify: "+res);
    return res;
    //addPostExecutionScript(doc, res);
}
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---

//--- RULE VALIDATION CODE - END ---

</script>
