<!--
// Name: Client Library
// Committer: Prathyusha.vasireddy@zpaper.com
// Update: PV220110
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2022-01-10 17:58:26","evalContinue":"true","active":true,"button":"","name":"Client Library","conditions":{"logic":"and","arguments":[{"name":"doc.status","value":"DoNotClient","operation":"not-contains"}]},"consequence":{"doit":"YWxlcnQoInN0YXJ0IGNsaWVudCBsaWJyYXJ5Iik7IC8vRVJTMTkwODAzICM1MjY2MSBmcm9tIE9jY0ZpdAovL0VSUzIwMTExNyBUT0RPIGdldCByaWQgb2ZmIHRoZXNlIGtleXdvcmRzIGFuZCB1c2UgYSBkb2N1bWVudCBqb3VybmV5IHdpemFyZCBmcm9tIEtQUyBhbmQgSmFrZQoKLy9DUk4yMDEwMjUgIzc2Nzg4IE1vdmVkIGZyb20gelN0YWNrIExpYnJhcnkgc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBpbiBtdWx0aXBsZSBydWxlcy4KdmFyIGtleXdvcmRNYXA9e307CnZhciBrZXl3b3Jkcz1bIk5FVzpEb2N1bWVudCBTdGFja34iLCJFTlJMOkVucm9sbG1lbnR+IiwiRU5STDpFTlJPTExNRU5UfiIsIkNPTjpDb25zZW50fiIsIkNPTjpjb25zZW50fiIsIkZBQzpTZXR0aW5nfiIsIkZBQzpEaXN0cmlidXRpb25+IiwiU1RBUlQ6U3RhcnQgRm9ybX4iLCJDSEs6Q2hlY2tsaXN0fiIsIkhJUEFBOkFVVEhPUklaQVRJT05+IiwiSElQQUE6SElQQUF+IiwiSElQQUE6UE9SVEFCSUxJVFl+IiwiUkVGOlJFRkVSUkFMIiwiUkVGOlJlZmVycmFsIiwiRklOOlcyfiIsIklDOk1lbWJlciBJRH4iLCJGQVg6Il07Ci8va2V5d29yZE1hcFsiVEVOUiJdID0iVEVOUjpTdGFydCBGb3JtIjsKa2V5d29yZE1hcFsiTkVXIl0gPSJORVc6RG9jdW1lbnQgU3RhY2siOwprZXl3b3JkTWFwWyJFTlJMIl0gPSJFTlJMOkVucm9sbG1lbnQgRm9ybSI7CmtleXdvcmRNYXBbIkZBQyJdID0iRkFDOkZhY2lsaXR5IEVucm9sbG1lbnQgRm9ybSI7CmtleXdvcmRNYXBbIkZBWCJdID0iTkVXOkRvY3VtZW50IFN0YWNrIjsKLy9rZXl3b3JkTWFwWyJTVEFSVCJdID0iTkVXOkRvY3VtZW50IFN0YWNrIjsKa2V5d29yZE1hcFsiQ09OIl0gPSJDT046Q29uc2VudCBGb3JtIjsKa2V5d29yZE1hcFsiSElQQUEiXSA9IkhJUEFBOkhJUEFBIEF1dGhvcml6YXRpb24iOwprZXl3b3JkTWFwWyJSRUYiXSA9IlJFRjpSZWZlcnJhbCI7CmtleXdvcmRNYXBbIkZXMiJdID0iRlcyOlctMiI7IC8vSlBCMjAxMDIzIGEgZGRlZAprZXl3b3JkTWFwWyJJOSJdID0iSTk6SS05IjsgLy9KUEIyMDEwMjMgYWRkZWQKa2V5d29yZE1hcFsiVzQiXSA9Ilc0OlctNCI7IC8vSlBCMjAxMDIzIGFkZGVkCmtleXdvcmRNYXBbIkRFTSJdID0iREVNOkRlbW9ncmFwaGljcyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIkNMSU4iXSA9IkNMSU46Q2xpbmljYWwgTm90ZXMiOyAvL0NSTjIwMTAyNiBhZGRlZAprZXl3b3JkTWFwWyJGSU4iXSA9IkZJTjpGaW5hbmNpYWwgSW5mbyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIklDIl0gPSJJQzpJbnN1cmFuY2UgQ2FyZCI7IC8vQ1JOMjAxMDI2IGFkZGVkCgp6RGF0YS5tYXhDaGFubmVscz0zOyAvL0VSUzE5MDczMSAjNjEyNzIgemlwcGkgaXMgc3Ryb25nbHkgdHlwZWQKekRhdGEubWFrZVN0YWNrPXRydWU7IC8vRVJTMTkwODE0ICM2MTUxMQoKekRhdGEud2F0ZXJtYXJrPSIiK1hDdXN0b21TZXR0aW5nKGRvYywid2F0ZXJtYXJrX19jIik7IC8vRVJTMTkwNjE4IGJlc3QgcHJhY3RpY2UKLy9hbGVydCgiRVJTMTkwNDExIHdtPSIrekRhdGEud2F0ZXJtYXJrKyIgWlBBUEVSX19zZXJ2ZXJfX2M9IitYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fc2VydmVyX19jIikpOwp6RGF0YS51cGxvYWREaXIgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInVwbG9hZERpcl9fYyIpOyAvLyJhbGtlcm1lc1Jvb3QiOwp6RGF0YS5wYXRFbnJvbGxRdWV1ZUlkID0gIiIrWEN1c3RvbVNldHRpbmcoZG9jLCJwYXRpZW50UXVldWVJZF9fYyIpOyAvLycwMEc0QzAwMDAwMExrbVonOyAvL2luc2VydCB0aGUgUXVldWUgSUQgb2YgdGhlIGRlc2lyZWQgb3duZXJzaGlwIHF1ZXVlLiBVcGRhdGUgd2hlbiBtaWdyYXRpbmcgYmV0d2VlbiBlbnZpcm9ubWVudHMuIE5lZWQgdG8gYWRkIHRoaXMgcXVldWUgaW4gU2V0dXAKekRhdGEucmVjVHlwZVJlcXVlc3QgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInJlY1R5cGVSZXF1ZXN0X19jIik7IC8vJzAxMjRDMDAwMDAwQ2o1WSc7IC8vSUQgb2YgdGhlIENhc2UgUmVjb3JkIFR5cGUgUmVxdWVzdF9QU19NVk4KLy9UT0RPIHpEYXRhLmtleXdvcmRNYXBbIkVOUkwiXSA9IkVOUkw6RW5yb2xsbWVudCBGb3JtIjsgLy9UT0RPIGdldCBmcm9tIHpTdGFjayBwaWNrbGlzdHMKLy9UT0RPIHpEYXRhLmtleXdvcmRNYXBbIkZBQyJdID0iRkFDOkZhY2lsaXR5IEVucm9sbG1lbnQgRm9ybSI7Ci8vRVJTMjAwMjA1IGRlbGV0ZWQgZGVtbyBkYXRhIC0gZG8gd2l0aCBjdXN0b20gc2V0dGluZ3MKCi8vUFYyMTAxMDIgZGF0YSBlbnRyeSBwYW5uZWwgMgp6RGF0YS5YX1pQQVBFUl9fUHJpb3JpdHlfX2MgPSBYKGRvYywgIlhfWlBBUEVSX19Qcmlvcml0eV9fYyIpOwp6RGF0YS5YX0JhcHRpc3RfSGVhcnRfU3BlY2lhbGlzdF9PcmRlcl9fYz0gWChkb2MsICJYX0JhcHRpc3RfSGVhcnRfU3BlY2lhbGlzdF9PcmRlcl9fYyIpOy8vUFYyMTAxMTkKekRhdGEuWF9BdHRlc3RhdGlvbl9JbmNsdWRlZF9fYz0gWChkb2MsICJYX0F0dGVzdGF0aW9uX0luY2x1ZGVkX19jIik7Ly9QVjIxMTIyMAp6RGF0YS5YX1JlYWR5X2Zvcl9TY2hlZHVsaW5nX19jPSBYKGRvYywgIlhfUmVhZHlfZm9yX1NjaGVkdWxpbmdfX2MiKTsKekRhdGEuWF9aUEFQRVJfVG9fRmFjaWxpdHlfX2M9IFgoZG9jLCAiWF9aUEFQRVJfVG9fRmFjaWxpdHlfX2MiKTsKekRhdGEuWF9aUEFQRVJfUHJpbWFyeV9QYXllcl9OYW1lX19jPSBYKGRvYywgIlhfWlBBUEVSX1ByaW1hcnlfUGF5ZXJfTmFtZV9fYyIpOwp6RGF0YS5YX1pQQVBFUl9QcmltYXJ5X01lbWJlcl9JRF9fYz0gWChkb2MsICJYX1pQQVBFUl9QcmltYXJ5X01lbWJlcl9JRF9fYyIpOwp6RGF0YS5YX1pQQVBFUl9TZWNvbmRhcnlfUGF5ZXJfTmFtZV9fYz0gWChkb2MsICJYX1pQQVBFUl9TZWNvbmRhcnlfUGF5ZXJfTmFtZV9fYyIpOwp6RGF0YS5YX1pQQVBFUl9TZWNvbmRhcnlfTWVtYmVyX0lEX19jPSBYKGRvYywgIlhfWlBBUEVSX1NlY29uZGFyeV9NZW1iZXJfSURfX2MiKTsKekRhdGEuWF96UGFwZXJfUHJvY2VkdXJlX0NvZGVfMV9fYz0gWChkb2MsICJYX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8xX19jIik7CnpEYXRhLlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzJfX2M9IFgoZG9jLCAiWF96UGFwZXJfUHJvY2VkdXJlX0NvZGVfMl9fYyIpOwp6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8zX19jPSBYKGRvYywgIlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzNfX2MiKTsKekRhdGEuWF9aUEFQRVJfRGlhZ25vc2lzX0NvZGVfMV9fYz0gWChkb2MsICJYX1pQQVBFUl9EaWFnbm9zaXNfQ29kZV8xX19jIik7CnpEYXRhLlhfWlBBUEVSX0RpYWdub3Npc19Db2RlXzJfX2M9IFgoZG9jLCAiWF9aUEFQRVJfRGlhZ25vc2lzX0NvZGVfMl9fYyIpOwp6RGF0YS5YX1pQQVBFUl9EaWFnbm9zaXNfQ29kZV8zX19jPSBYKGRvYywgIlhfWlBBUEVSX0RpYWdub3Npc19Db2RlXzNfX2MiKTsKekRhdGEuWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jPSBYKGRvYywgIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIpOwp6RGF0YS5YX1pQQVBFUl9fUHJvdmlkZXJDb250YWN0X19jPSBYKGRvYywgIlhfWlBBUEVSX19Qcm92aWRlckNvbnRhY3RfX2MiKTsKekRhdGEuWF96UGFwZXJfUmVhc29uX2Zvcl9WaXNpdF9fYz0gWChkb2MsICJYX3pQYXBlcl9SZWFzb25fZm9yX1Zpc2l0X19jIik7CnpEYXRhLlhfelBhcGVyX0FVQ19EU05fX2M9WChkb2MsICJYX3pQYXBlcl9BVUNfRFNOX19jIik7CnpEYXRhLlhfelBhcGVyX0FVQ19HX0NvZGVfX2M9WChkb2MsICJYX3pQYXBlcl9BVUNfR19Db2RlX19jIik7CnpEYXRhLlhfelBhcGVyX0FVQ19Nb2RpZmllcl9fYz1YKGRvYywgIlhfelBhcGVyX0FVQ19Nb2RpZmllcl9fYyIpOwp6RGF0YS5YX3pQYXBlcl9BVUNfU2NvcmVfX2M9WChkb2MsICJYX3pQYXBlcl9BVUNfU2NvcmVfX2MiKTsKekRhdGEuWF9IZWFsdGhDbG91ZEdBX19HZW5kZXJfX3BjPVgoZG9jLCAiWF9IZWFsdGhDbG91ZEdBX19HZW5kZXJfX3BjIik7Ci8vUFYyMTAxMDIgZGF0YSBlbnRyeSBwYW5uZWwgMiAtIGVuZAoKdmFyIGNzPVhEZXBsb3ltZW50SW5mbyhkb2MsICJCdXNpbmVzc19Qcm9jZXNzX19jIik7IC8vRVJTMjAwMjIyIG5lZWQgYm90aCBkZXBsb3ltZW50IGluZm8gYW5kIGNzCi8vYWxlcnQoImNzPSIrY3MpOwppZiAoY3MpIHsKIGlmIChjcy5pbmRleE9mKCJ6Q3VzdG9tU2V0dGluZ3MiKT4tMSkgY3M9WChkb2MsInpDdXN0b21TZXR0aW5ncyIsY3MpOwogYWxlcnQoIkVSUzIwMDIyNSBFVkFMIG9uICIrY3MpOwogaWYgKGNzICE9PSAiIikgZXZhbCgiIitjcyk7IC8vRVJTMjAwMjIyIFRPRE8gSlNPTi5wYXJzZSgpIC8vRVJTMjAwMjI1IGJlZWRzIHRvIGJlIGV2YWwgYnV0IGFsc28gbmVlZHMgdG8gd29yayEhIQogYWxlcnQoIk5vIHRyeSBqdXN0IGRvISIpOwp9CgppZiAoMT09PTAgJiYgIXpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlKSB7IC8vVE9ETyBjdXN0b20gc2V0dGluZyBvciBkZXBsb3ltZW50PyAvL0VSUzIwMTEyOSBET05FIGluIHpDaGlsZEZpZWxkcwogYWxlcnQoIkVSUzIwMTEyOCBzaG91bGQgYmUgaW4gY3VzdG9tIHNldHRpbmdzIHpDaGlsZEZpZWxkcyIpOwogekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGU9IjAxMjExMDAwMDAxZ0JzM0FBRSI7IC8vRVJTMjAxMTI4IHNob3VsZCBiZSBpbiBjdXN0b20gc2V0dGluZ3MgekNoaWxkRmllbGRzICIwMTIwUjAwMDAwMU4yb0kiOwp9Cgp6RGF0YS5jbGllbnRJbXBvcnRTT1FMPWZ1bmN0aW9uKGRvYyxmcm9tRmlsZSkgeyAvL0VSUzE5MDcwNiBjdXN0b21pemUgaW1wb3J0cyB1c2VkIGJ5IENyZWF0ZSBTdGFjawogekRhdGEuaW1wb3J0ZXI9WEN1c3RvbVNldHRpbmcoZG9jLHpEYXRhLnpwKyJJbXBvcnRlcl9fYyIpLnRyaW0oKTsKIHZhciBzZklkPSIiOwogdmFyIHBhcnRzPWZyb21GaWxlLnNwbGl0KCJfIik7CiAvL3NmSWQgPSBnZXRTRlJlY29yZElEKGRvYywgIkFjY291bnQiLCB7ICJGYXgiIDogcGFydHNbM10gfSApOwogekRhdGEubWFrZVN0YWNrPXRydWU7IC8vZG8gYWxsIHRoZSB3b3JrIHRoZXJlIGJ5IGRlZmF1bHQKIHJldHVybiBzZklkOwp9OwoKLy9hbGVydCgiekRhdGEuY2xpZW50U3RhY2siKTsKekRhdGEuY2xpZW50U3RhY2s9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMpIHsgLy96RGF0YSBvciB0aGlzPwogdmFyIHpwPXpEYXRhLnpwOyBpZiAoIXpwKSB6cD0iWlBBUEVSX18iOyAvL0VSUzE5MDgwNQppZiAoekRhdGEucmVjZWl2ZWQpIGFyck9mUGFpcnMucHVzaCgielN0YWNrX1JlY2VpdmVkX19jIiwgekRhdGEuZm9ybWF0Tm93KTsgLy9FUlMxOTA2MTcgVE9ETyBzYXZlIHdheSB0byBkbyB0aGlzCmlmICh6RGF0YS5vd25lcklkKSBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLHpEYXRhLm93bmVySWQpOyAvLyB6Q2hhcnRhIFF1ZXVlICIwMEczNjAwMDAwMkN5VEsiCmlmICh6RGF0YS5jYWxsZXJJZCkgYXJyT2ZQYWlycy5wdXNoKCJ6Q2FsbGVyX0lEX19jIiwgZG9jLmRlbGl2ZXJlZEZyb20pOyAvL01TSDE3MDgxNyBhZGRlZAppZiAoekRhdGEucGF0RW5yb2xsUXVldWVJZCkgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIix6RGF0YS5wYXRFbnJvbGxRdWV1ZUlkKTsKCiBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fZmF4VHlwZV9fYyIsIHpEYXRhLmRvY1R5cGUpOwogYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIiwgekRhdGEuY2xhc3NpZmljYXRpb24pOwogdmFyIHBhZ2VSYW5nZSA9IFgoZG9jLCJYX2lkeFBhZ2VzIik7CiBpZiAoIXBhZ2VSYW5nZSkgcGFnZVJhbmdlPSIxLSIrWChkb2MsIlhfcGFnZXMiKTsKIHZhciBwYWdlQ291bnQgPSB6RGF0YS5jb3VudFBhZ2VzKGRvYywgcGFnZVJhbmdlKTsKIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNAogLy9FUlMxOTA4MTAgVE9ETz8gYXJyT2ZQYWlycy5wdXNoKCJaU1RBQ0tfX1JlY2VpdmVkX19jIiwgekRhdGEuZm9ybWF0Tm93KTsKIGFsZXJ0KCJFUlMyMDAyMTMuNTEgcGFnZVJhZ2U9IitwYWdlUmFuZ2UgKyAiIGJ1dCBwYWdlQ291bnQ9IitwYWdlQ291bnQpOyAvL0VSUzIwMDIxMyBhbHNvIGNhbGxlZCBpbiBuZXcgaW5jb21pbmcgc3RhY2sKIGlmICghWChkb2MsIlhfaWR4UGFnZXMiKSkgcGFnZUNvdW50PVgoZG9jLCJYX3BhZ2VzIik7IC8vRVJTMjAwMjEzIFRPRE8gZml4IHpEYXRhLmNvdW50UGFnZXMoKQogYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhZ2VzX19jIiwgcGFnZUNvdW50KTsKIAogLy9FUlMyMDAyMDQgVE9ETyB6U3RhY2suUHJvZ3JhbT8KCiBpZiAoekRhdGEucHJvZ3JhbU5hbWUgPT09IHpEYXRhLlBST0dSQU1fWkNIQVJUQSkgeyAvL0pQQjIwMTAyMyBjaGFuZ2VkIGZyb20gY2xhc3NpZmljYXRpb24gdG8gcHJvZ3JhbU5hbWUKIGFyck9mUGFpcnMucHVzaCh6cCsiUHJpb3JpdHlfX2MiLCAiVXJnZW50Iik7IC8vSlBCMTkwNDI2IGNoYW5nZWQgdG8gY2xhc3NpZmljYXRpb24gZnJvbSBwcm9ncmFtCiB9IGVsc2UgaWYgKHpEYXRhLnByb2dyYW1OYW1lID09PSB6RGF0YS5QUk9HUkFNX1pQQVBZUlVTKSB7IC8vSlBCMjAxMDIzIGNoYW5nZWQgZnJvbSBjbGFzc2lmaWNhdGlvbiB0byBwcm9ncmFtTmFtZQogYXJyT2ZQYWlycy5wdXNoKHpwKyJQcmlvcml0eV9fYyIsICJPdGhlciIpOwogfSBlbHNlIGlmICh6RGF0YS5wcm9ncmFtTmFtZSA9PT0gekRhdGEuUFJPR1JBTV9aQ0FSVEEpIHsgLy9KUEIyMDEwMjMgY2hhbmdlZCBmcm9tIGNsYXNzaWZpY2F0aW9uIHRvIHByb2dyYW1OYW1lCiBhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIlN0YXQiKTsKIH0gZWxzZSB7CiBhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIlJvdXRpbmUiKTsgLy9QVjIxMDExOSB1cGRhdGVkIHZhbHVlCiB9CiAKIGFyck9mUGFpcnMucHVzaCh6cCsic2VudEZheFRvX19jIiwgKCJDb21tdW5pdHkiID09PSB6RGF0YS5jaGFubmVsID8gekRhdGEuY2hhbm5lbCA6IGRvYy5kZWxpdmVyZWRUbykpOyAvL0pQQjE5MDUyOSBhZGRlZCBzbyBDb21tdW5pdHkgc2hvd3MgdXAgaW4gTWFzdGVyIEludGFrZSBMaXN0CiBhcnJPZlBhaXJzLnB1c2goenArIkZyb21fX2MiLGRvYy5kZWxpdmVyZWRGcm9tKTsKIGlmICh6RGF0YS5yZXZpZXdlZFN0YXR1cykge2Fyck9mUGFpcnMucHVzaCh6cCsiU3RhZ2VfX2MiLCB6RGF0YS5yZXZpZXdlZFN0YXR1cyk7IH0KIGVsc2UgeyBhcnJPZlBhaXJzLnB1c2goenArIlN0YWdlX19jIiwgIlJlY2VpdmVkIik7IH0KIHpEYXRhLnN0YWNrUGFpcnM9YXJyT2ZQYWlyczsgLy9FUlMxOTA4MTAgIzYxNTcwIGZvciBjaGlsZCBzdGFjayBsYXRlcgogYXJyT2ZQYWlycz16RGF0YS5jbGllbnRGaWVsZHMoZG9jLGFyck9mUGFpcnMsWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX3pTdGFja0ZpZWxkc19fYyIpKTsgLy9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04KcmV0dXJuIGFyck9mUGFpcnM7Cn07CgovL2FsZXJ0KCJ6RGF0YS5jbGllbnRGaWxlIik7CnpEYXRhLmNsaWVudEZpbGU9ZnVuY3Rpb24oZG9jLHN0YWdlKSB7IC8vRVJTMTcwODI5ICM0MTI5OCByZXR1cm5zIGEgbGFiZWwgdG8gYmUgdXNlZCBpbiBhbnkgYXR0YWNoZXMgYW5kIGZpeGVzIHRoZSBkb2MKIC8vRG9jdW1lbnQgYXR0YWNobWVudCBsYWJlbCBzaG91bGQgYmUgIlBhdGllbnQgTmFtZSAtIERvYyBUeXBlIC0gRGF0ZSIuIENvbmZpcm1lZCBmb3IgelBhcGVyIEZpbGUgYW5kIFNGREMgQXR0YWNobWVudAogdmFyIE1NZGRZWVlZID0gekRhdGEuZm9ybWF0VG9kYXlNTWRkWVlZWSgpOwogLy9DUk4yMDEwMjUgIzc2Nzg4IEZpeGVkIHRvIG1hdGNoIHRoZSBjdXJyZW50IGRlbW8uCiB2YXIgcGF0aWVudE5hbWUgPSBYKGRvYywiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19yLk5hbWUiKTsKIGlmICghcGF0aWVudE5hbWUpIHsKIHBhdGllbnROYW1lID0gWChkb2MsIlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiKSArICIgIiArIFgoZG9jLCAiWF9aUEFQRVJfX0xhc3ROYW1lX19jIik7CiB9CiB2YXIgZmF4VHlwZSA9IGtleXdvcmRNYXBbWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIildOwogaWYgKCFmYXhUeXBlKSB7IGZheFR5cGUgPSBYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKTsgfQogaWYgKCFmYXhUeXBlLmluZGV4T2YoJzonKSA+PSAwKSB7IGZheFR5cGUgPSBmYXhUeXBlLnNwbGl0KCc6JylbMV07IH0KIC8vIGRvYy5sYWJlbCA9IHBhdGllbnROYW1lICsgIiAtICIgKyBmYXhUeXBlICsgIiAtICIgKyBNTWRkWVlZWTsKIC8vZG9jLmxhYmVsID0gcGF0aWVudE5hbWUgKyAiIC0gIiArIGZheFR5cGU7CiBkb2MubGFiZWwgPSBwYXRpZW50TmFtZSA7IC8vUFYyMTAxMDQgdXBkYXRpbmcgbGFiZWwKIGlmICghcGF0aWVudE5hbWUgfHwgcGF0aWVudE5hbWUubGVuZ3RoPDUpIHsgLy9FUlMyMDExMjkgIzc4ODMwCiBkb2MubGFiZWw9IlNwbGl0IGZyb20gIitYKGRvYywiWF9zcGxpdFBhZ2VzIikrIiBvZiAiKyBYKGRvYywiWF9mcm9tUGFnZXMiKSArIiAtICIrTU1kZFlZWVk7CiBkb2MubGFiZWw9IkRvY3VtZW50IEluZGV4ZWQgIisgWChkb2MsIlhfZnJvbVBhZ2VzIikgKyIgLSAiK01NZGRZWVlZOyAvL1BWMjEwNjI2CiB9CiBhbGVydCgiRVJTMTcwODI5IGRiSUQ9Iitkb2MuZGJJRCsiIGxhYmVsPSIrZG9jLmxhYmVsKTsKIGlmICh6RGF0YS5zZklEICYmIHpEYXRhLnNmSUQuaW5kZXhPZigiNTAwIik9PT0wKSB7CiB6RGF0YS5wcm92aWRlciA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJBY2NvdW50Lk5hbWUiLCBudWxsLCB6RGF0YS5zZklEKTsKIGxhYmVsID0gIlJlY2VpdmVkIGZyb20gIiArIHpEYXRhLnByb3ZpZGVyOwogaWYgKHpEYXRhLmZhY2lsaXR5KSB7CiB6RGF0YS5mYWNpbGl0eSA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJBY2NvdW50LkZhY2lsaXR5X19yLk5hbWUiLCBudWxsLCB6RGF0YS5zZklEKTsKIGRvYy5sYWJlbCs9IiBhdCAiK3pEYXRhLmZhY2lsaXR5OwogfQp9CnZhciBhcnJPZlBhaXJzID0gW107CiBhcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgZG9jLmxhYmVsKTsKdXBkYXRlREIoZG9jLGFyck9mUGFpcnMpOwogcmV0dXJuIGRvYy5sYWJlbDsKfTsKCnpEYXRhLmNsaWVudFZhbHVlPWZ1bmN0aW9uKGRvYyx2YWwpIHsvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTgogdmFsPXZhbC5yZXBsYWNlKCJ7IWZvcm1hdE5vd30iLHpEYXRhLmZvcm1hdE5vdyk7CiByZXR1cm4gdmFsOwp9Cgp6RGF0YS5jbGllbnRGaWVsZHM9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsamQsemQpIHsgLy9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04gaW4gc2V0dGluZyB0byBjb25maWd1cmUgbmV3IHJlY29yZAogaWYgKCF6ZCkgemQ9ekRhdGE7CmlmIChqZCAmJiBqZC5pbmRleE9mKCJ7Iik9PT0wKSB7CiAvL3siVHlwZSI6IkVsaWdpYmlsaXR5IiwiT3duZXJJZCI6IjAwR2MwMDAwMDAzdmdxdyIsIlJlY29yZFR5cGVJZCI6IjAxMjZBMDAwMDAwSkVLZVFBTyJ9OwogLy9OT1QgQSBHT09EIElERUEgamQ9amQucmVwbGFjZUFsbCgiXCIiLCInIik7IC8vRVJTMTkwODExICM2MTU3MCBIQUNLPwogamQ9amQucmVwbGFjZSgifTsiLCJ9Iik7IC8vRVJTMjAxMTI5IFNIUiB0byB3b3JrIG91dCBkZXNpZ24gb24gY2hhbm5lbCB3aXphcmQgZm9yIHpTdGFjayBjaGlsZCBzZXQgQVNBUAogdHJ5IHsKIHZhciBqZGF0YT1KU09OLnBhcnNlKGpkKTsgLy9FUlMxOTA4MDUgYmV0dGVyIHRoYW4gZXZhbAogZm9yICh2YXIgbiBpbiBqZGF0YSkgewogdmFyIHYwPWpkYXRhW25dOwogdmFyIHY9ekRhdGEuY2xpZW50VmFsdWUoZG9jLHYwKTsgLy9FUlMxOTA4MTEgLHYgbm93ICx2MAogYWxlcnQoIkVSUzE5MDgwMy45NyAiK24rIj0iK3YwKyI9Iit2KTsKIGFyck9mUGFpcnMucHVzaChuLHYpOyAvL0VSUzE5MDgxMSBhZGRlZCAucHVzaAogemRbbl09djsgLy9FUlMyMDExMjkgIzc4ODMwIFRPRE8gcmV2aWV3IGFyck9mUGFpcnMgYWNjZXNzIHVzaW5nIGZvciBSZWNvcmRUeXBlSWQKIH0KIH0gY2F0Y2ggKGUpIHsKIGFsZXJ0KCJKU09OIG5vdCBpbiAiK2pkKyIgRXhjZXB0aW9uOiAiK2UpOyAvL0VSUzE5MDgxMSBhZGRlZCBlCiB9Cn0KcmV0dXJuIGFyck9mUGFpcnM7Cn0KCgp6RGF0YS5jbGllbnRDYXNlPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7CmlmICghemQpIHpkPXpEYXRhOwppZiAoIXpkLnRyaWFnZVR5cGUgJiYgWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIikpIHpkLnRyaWFnZVR5cGU9WChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIik7IC8vRVJTMjAwMzA4CmlmICghbGFiZWwpIHsgbGFiZWw9IkluZGV4ZWQtIiArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KCmFsZXJ0KCJFUlMyMDAzMDguMTI4IG5ldyBDYXNlIHByb3ZpZGVySWQ9Iit6ZC5wcm92aWRlcklkKyIgcGF0aWVudElkPSIremQucGF0aWVudElkKTsKYWxlcnQoInpEYXRhLnBhdGllbnRDb250YWN0SWQgOiAiICsgekRhdGEucGF0aWVudENvbnRhY3RJZCk7Ci8vYXJyT2ZQYWlycy5wdXNoKCJDdXN0b21fUHJvY2VkdXJlX19jIix6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8xX19jKTsvL2FocyAtIGNvbW1lbnRlZAovL2Fyck9mUGFpcnMucHVzaCgiQWNjb3VudElkIix6RGF0YS5YX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MpOwphcnJPZlBhaXJzLnB1c2goIlJlZmVycmluZ19Qcm92aWRlcl9fYyIsekRhdGEuWF9aUEFQRVJfX1Byb3ZpZGVyQ29udGFjdF9fYyk7CmFyck9mUGFpcnMucHVzaCgiQ29udGFjdElkIix6RGF0YS5wYXRpZW50Q29udGFjdElkKTsKYXJyT2ZQYWlycy5wdXNoKCJQcmltYXJ5X1BheWVyX05hbWVfX2MiLHpEYXRhLlhfWlBBUEVSX1ByaW1hcnlfUGF5ZXJfTmFtZV9fYyk7IC8vUFYyMTAxMTEgdXBkYXRlZAphcnJPZlBhaXJzLnB1c2goIlByaW1hcnlfTWVtYmVyX0lEX19jIix6RGF0YS5YX1pQQVBFUl9QcmltYXJ5X01lbWJlcl9JRF9fYyk7CmFyck9mUGFpcnMucHVzaCgiU2Vjb25kYXJ5X1BheWVyX05hbWVfX2MiLHpEYXRhLlhfWlBBUEVSX1NlY29uZGFyeV9QYXllcl9OYW1lX19jKTsKYXJyT2ZQYWlycy5wdXNoKCJTZWNvbmRhcnlfTWVtYmVyX0lEX19jIix6RGF0YS5YX1pQQVBFUl9TZWNvbmRhcnlfTWVtYmVyX0lEX19jKTsKYXJyT2ZQYWlycy5wdXNoKCJTb3VyY2VfX2MiLCJGYXgiKTsKYXJyT2ZQYWlycy5wdXNoKCJUb19GYWNpbGl0eV9OYW1lX19jIix6RGF0YS5YX1pQQVBFUl9Ub19GYWNpbGl0eV9fYyk7CmFyck9mUGFpcnMucHVzaCgiQVVDX0RTTl9fYyIsekRhdGEuWF96UGFwZXJfQVVDX0RTTl9fYyk7CmFyck9mUGFpcnMucHVzaCgiQVVDX0dfQ29kZV9fYyIsekRhdGEuWF96UGFwZXJfQVVDX0dfQ29kZV9fYyk7CmFyck9mUGFpcnMucHVzaCgiQVVDX01vZGlmaWVyX19jIix6RGF0YS5YX3pQYXBlcl9BVUNfTW9kaWZpZXJfX2MpOwphcnJPZlBhaXJzLnB1c2goIkFVQ19TY29yZV9fYyIsekRhdGEuWF96UGFwZXJfQVVDX1Njb3JlX19jKTsKLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7Ci8vaWYgKHpkLmNvbnRhY3RJZCkgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCB6ZC5jb250YWN0SWQpOwphcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbmV3RmF4X19jIiwgInRydWUiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwphcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwphcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fcmVjZWl2ZWRJZF9fYyIsIGRvYy5kYklEKTsgLy9FUlMxOTA4MTQgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwphcnJPZlBhaXJzLnB1c2goIlN0YXR1cyIsIFgoZG9jLCJYX1N0YXR1cyIpKTsKYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLHpkLnRyaWFnZVR5cGUpOyAvL0VSUzIwMDMwOAphbGVydCgiWF9aUEFQRVJfX1ByaW9yaXR5X19jIDogIiArIHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYyk7CmlmKHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYyl7CiBhcnJPZlBhaXJzLnB1c2goIlByaW9yaXR5IiwgekRhdGEuWF9aUEFQRVJfX1ByaW9yaXR5X19jKTsgLy9QVjIxMDExOQogfQppZih6RGF0YS5YX0JhcHRpc3RfSGVhcnRfU3BlY2lhbGlzdF9PcmRlcl9fYyl7CiBhcnJPZlBhaXJzLnB1c2goIkJhcHRpc3RfSGVhcnRfU3BlY2lhbGlzdF9PcmRlcl9fYyIsIHpEYXRhLlhfQmFwdGlzdF9IZWFydF9TcGVjaWFsaXN0X09yZGVyX19jKTsKIH0KIGlmKHpEYXRhLlhfQXR0ZXN0YXRpb25fSW5jbHVkZWRfX2MpewogYXJyT2ZQYWlycy5wdXNoKCJBdHRlc3RhdGlvbl9JbmNsdWRlZF9fYyIsIHpEYXRhLlhfQXR0ZXN0YXRpb25fSW5jbHVkZWRfX2MpOwogfQppZih6RGF0YS5YX1JlYWR5X2Zvcl9TY2hlZHVsaW5nX19jKXsKIGFyck9mUGFpcnMucHVzaCgiUmVhZHlfZm9yX1NjaGVkdWxpbmdfX2MiLCB6RGF0YS5YX1JlYWR5X2Zvcl9TY2hlZHVsaW5nX19jKTsKIH0KLy9FUlMyMDAyMDUgYXJyT2ZQYWlycy5wdXNoKCJUeXBlIiwgIk5ldyAiK3pkLmNsYXNzaWZpY2F0aW9uKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwovL0VSUzIwMDMwOCBhcnJPZlBhaXJzLnB1c2goIlR5cGUiLCAiTmV3ICIremQuZG9jVHlwZSk7CmlmICgxPT0xKSB7IC8vRVJTMTcwNTIzICMzNzE2MiBhZnRlciBkcnlydW4KIGFsZXJ0KCJAQEAgemQucHJpb3JpdHkgPT4gKiIgKyB6ZC5wcmlvcml0eSArICIqIik7Ci8vYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTJRMDAwMDAwMDVBaGoiKTsgLy9FUlMxNzA1MjMgUHJpb3IgQXV0aAovL2lmICh6ZC5wcmlvcml0eSAhPSAiU3RhdCIpIHsgYXJyT2ZQYWlycy5wdXNoKCJQcmlvcml0eSIsemQucHJpb3JpdHkpOyB9IC8vRVJTMTcwNTI0ICMzNzE2MiBwcmlvcml0eSBvbiBDYXNlCi8vZWxzZSB7IGFyck9mUGFpcnMucHVzaCgiUHJpb3JpdHkiLCJSb3V0aW5lIik7IH0gLy9QVjIxMTkwMQphcnJPZlBhaXJzLnB1c2goIk9yaWdpbiIsIkZheCIpOyAvL0VSU2EyMDAyMDUgcnJPZlBhaXJzLnB1c2goIk9yaWdpbiIsemQuY2hhbm5lbCk7Cn0KIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19DYXNlRmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTgogCiBhbGVydCgiRVJTMjAwMzA4LjE0MyBuZXcgQ2FzZSBwcm92aWRlcklkPSIremQucHJvdmlkZXJJZCsiIHBhdGllbnRJZD0iK3pkLnBhdGllbnRJZCk7CiAvL2FocyAtIGNvbW1lbnRlZCBzdGFydCAtIHRvIGZpeCBvdmVyd3JpdGluZyBjb250YWN0L2FjY291bnQKIC8vaWYgKHpkLnByb3ZpZGVySWQgJiYgemQucHJvdmlkZXJJZC5pbmRleE9mKCIwMDEiKT09MCkgeyBhcnJPZlBhaXJzLnB1c2goIkFjY291bnRJZCIsIHpkLnByb3ZpZGVySWQpOyB9IC8vRVJTMjAwMzA4CiAvL2lmICh6ZC5wcm92aWRlcklkICYmIHpkLnByb3ZpZGVySWQuaW5kZXhPZigiMDAzIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCB6ZC5wcm92aWRlcklkKTsgfSAvL0VSUzIwMDMwOAogLy9pZiAoemQucGF0aWVudElkICYmIHpkLnBhdGllbnRJZC5pbmRleE9mKCIwMDEiKT09MCkgeyBhcnJPZlBhaXJzLnB1c2goIkFjY291bnRJZCIsIHpkLnBhdGllbnRJZCk7IH0gLy9FUlMyMDAzMDgKIC8vaWYgKHpkLnBhdGllbnRJZCAmJiB6ZC5wYXRpZW50SWQuaW5kZXhPZigiMDAzIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCB6ZC5wYXRpZW50SWQpOyB9IC8vRVJTMjAwMzA4CiAvL2FocyAtIGNvbW1lbnRlZCBlbmQgLSB0byBmaXggb3ZlcndyaXRpbmcgY29udGFjdC9hY2NvdW50CiAvL2lmICh6ZC56Y2hhbm5lbC5vd25lcikgeyBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS56Y2hhbm5lbC5vd25lcik7IH0gLy9FUlMyMDAzMDggUFYyMTAxMDIgY29tbWVudGVkIHdlIGFyZSBub3QgdXNpbmcgcXVldWUgb24gY2FzZQogCiBpZihYKGRvYywiZGItY29tbWVudHMiKSkKICAgIGFyck9mUGFpcnMucHVzaCgiT3JkZXJfTm90ZXNfX2MiLFgoZG9jLCJkYi1jb21tZW50cyIpKTsKIAp2YXIgY2FzZUlkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNhc2UiLCBsYWJlbCwgYXJyT2ZQYWlycyk7CnJldHVybiBjYXNlSWQ7Cn07Cgp6RGF0YS5jbGllbnRQYXRpZW50PWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7CmlmICghemQpIHpkPXpEYXRhOwppZiAoIWxhYmVsKSB7IGxhYmVsPXpkLnN0YWdlICsgIi0iICsgemQudHJpYWdlVHlwZSArICItIiArIHpkLnN0YWNrSWQ7fQppZiAoemQucGF0aWVudElkKSB7IC8vRVJTMjAwMjA1ICM2ODgyNSBQcm9ncmFtIE1lbWJlcnMKIGFsZXJ0KCJQYXRpZW50IGFscmVhZHkgZXhpc3RzIGluICIremQucGF0aWVudElkKTsKIHJldHVybiB6ZC5wYXRpZW50SWQ7IC8vVE9PRCBnZXQgZnJvbSBYX3BhdGllbnRJZCA/Pz8/Cn0KLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7CnZhciBwPSJaUEFQRVJfXyI7IC8vRVJTMjAwMjAyIGFzc3VtZSB3b3JrZmxvdyBvbiByZWxhdGVkIHJlY29yZCB0eXBlcwppZiAoekRhdGEucGF0aWVudFR5cGUuaW5kZXhPZigiX19jIikgPiAtMSkgeyBwPSIiOyB9IC8vRVJTMjAwMjAzIHR5cG8KaWYgKDE9PTApIHsgLy9FUlMyMDAyMDIgc2VlIGlmIHdvcmtmbG93IGVuYWJsZWQKIGFyck9mUGFpcnMucHVzaChwKyJuZXdGYXhfX2MiLCAidHJ1ZSIpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiBhcnJPZlBhaXJzLnB1c2gocCsibGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogYXJyT2ZQYWlycy5wdXNoKHArInJlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7IC8vRVJTMTkwODE0IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKfQoKIHZhciBydD1YQ3VzdG9tU2V0dGluZyhkb2MsIlBhdGllbnRSZWNvcmRUeXBlX19jIik7IC8vVE9ETyBpbnRvIE1QIEVSUzE5MDgwMiBsaWtlIDAxMjZBMDAwMDAwSkU4eVFBRyBvciBlbXB0eSB0byB1c2UgZGVmYXVsdAogLy9pZiAocnQpIHsgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCBydCk7IH0gLy9FUlMxOTA4MDMKIC8vVE9ETyBDb250YWN0IG9yIEFjY291bnQgRVJTMTkwNjI0IERPTkUhISBFUlMxOTA4MDIKIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19QYXRpZW50RmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTgogYWxlcnQoImFyck9mUGFpcnMgOiAiICsgYXJyT2ZQYWlycyk7CiBhbGVydCgicGF0aWVudGZpZWxkcyBjdXN0b20gc2V0dGluZyA6ICIgKyBYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fUGF0aWVudEZpZWxkc19fYyIpKTsKIGFyck9mUGFpcnM9W107IC8vRVJTMjAwMjA0IHRlc3RpbmcgdG8gZ2V0IGl0IGdvaW5nCiAKIC8vRVJTMjAwMjAyIG5lZWQgdG8gbWFrZSB0aGUgQWNjb3VudCB3aXRoIFBhdGllbnQgcmVjb3JkVHlwZSBmaXJzdAogLy8wMTI0NjAwMDAwME5HRllBQTQgaXMgLnpwYXBlciBmb3IgUGF0aWVudAogLy9hbGVydCgiQEAqKiBhY2NvdW50IHJ0IHZhbCA6ICIgKyBydCk7CiB2YXIgYXIgPSBbXTsKIC8vaWYgKHJ0KSB7IGFyLnB1c2goIlJlY29yZFR5cGVJZCIsIHJ0KTsgfSAvL0VSUzE5MDgwMyAvL0VSUzIwMDIyMiAjNjkxNDkgbW92ZWQgZG93biBhbmQgYWRkZWQgZWxzZQogLy9lbHNlIHsgYXIucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyNjEwMDAwMDBRZ21UQUFTIik7IGFsZXJ0KCJAQEAgRXJyb3IgcmVjb3JkIHR5cGUgaXMgbm90IHBpY2tlZCB1cCBmcm9tIGN1c3RvbSBzZXR0aW5nIikgfQogYXIucHVzaCgiRmlyc3ROYW1lIix6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKTsKIGFyLnB1c2goIkxhc3ROYW1lIix6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogYXIucHVzaCgiUGVyc29uSG9tZVBob25lIiwgekRhdGEuWF9aUEFQRVJfX1Bob25lX19jKTsKIGFsZXJ0KCJYX0hlYWx0aENsb3VkR0FfX0dlbmRlcl9fcGM9PT0iICsgekRhdGEuWF9IZWFsdGhDbG91ZEdBX19HZW5kZXJfX3BjKTsKIGFsZXJ0KCJHZW5kZXJfX2M9PT0iICsgekRhdGEuWF9HZW5kZXJfX2MpOwogaWYoekRhdGEuWF9HZW5kZXJfX2MpewogLy9hci5wdXNoKCJIZWFsdGhDbG91ZEdBX19HZW5kZXJfX3BjIix6RGF0YS5YX0dlbmRlcl9fYyApOyAvL1BWMjEwNDAyIGFkZGVkCiAgIGFyLnB1c2goIkhlYWx0aENsb3VkR0FfX0dlbmRlcl9fcGMiLHpEYXRhLlhfR2VuZGVyX19jICk7CiB9IC8vUFYyMTA0MDIgYWRkZWQKIGlmKHpEYXRhLlhfR2VuZGVyX19jKXsKICAgYXIucHVzaCgiR2VuZGVyX19wYyIsekRhdGEuWF9HZW5kZXJfX2MgKTsKIH0KIHZhciBwYXRpZW50TmFtZT16RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MrIiwgIit6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jOwogYXI9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcixYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fUGF0aWVudEZpZWxkc19fYyIpKTsgLy9QVjIwMTIyOSBhZGRlZCB0byBwYXNzIHZhbHVlIGZyb20gQ3VzdG9tIHNldHRpbmdzCiBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgYXIucHVzaCgiUGVyc29uQmlydGhEYXRlIix6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsKIC8vaWYgKHpEYXRhLlhfWlBBUEVSX19QaG9uZV9fYykgYXIucHVzaCgiUGVyc29uUGhvbmUiLHpEYXRhLlhfWlBBUEVSX19QaG9uZV9fYyk7IC8vUFYyMTAxMTEgYWRkZWQgcGhvbmUKIGFsZXJ0KCJAQGFyIDogIiArIGFyKTsKIHZhciBhSWQgPSBjcmVhdGVTRlJlY29yZChkb2MsICJBY2NvdW50IiwgbnVsbCwgYXIpOyAvL0VSUzIwMDIwNCBwZXJzb24gYWNjb3VudCBzbyBkbyBub3Qgc2V0IHBhdGllbnROYW1lCiAKIGlmIChhSWQgJiYgYUlkICE9ICJORVciICYmIGFJZC5pbmRleE9mKCJFUlJPUiIpPT0tMSkgewogdmFyIHNmSWQgPSAiIjsKIAogLy9FUlMxOTA4MDMgc3BlY2lmaWMgdG8gY2xpZW50IGRhdGEgZW50cnkKIHZhciBkcSA9IHpEYXRhLmRxOwogYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1BlcnNvbl9BY2NvdW50X19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHNmSWQgKyBkcSArICIpOyAiKTsKIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQZXJzb25fQWNjb3VudF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyAiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyBkcSArICIpOyAiKTsKIHJldHVybiBhSWQ7IC8vUFYyMDEyMjkgdG8gY3JlYXRlIFBlcnNvbmFjY291bnQKIH0KIHJldHVybiB7J0VSUk9SJzogJ3BhdGllbnQgbm90IGNyZWF0ZWQnfQp9OwoKekRhdGEuY2xpZW50QWNjb3VudD1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxsYWJlbCx6ZCkgewppZiAoIXpkKSB6ZD16RGF0YTsKaWYgKCFsYWJlbCkgeyBsYWJlbD16ZC5zdGFnZSArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7CmFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19uZXdGYXhfX2MiLCAidHJ1ZSIpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCmFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19sYXRlc3RGYXhfX2MiLCB6ZC5mb3JtYXROb3cpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCmFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCgp2YXIgYWNjb3VudElkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkFjY291bnQiLCBsYWJlbCwgYXJyT2ZQYWlycyk7CnJldHVybiBhY2NvdW50SWQ7Cn07Cgp6RGF0YS5jbGllbnRSZWNvcmQ9ZnVuY3Rpb24oZG9jLHNmVHlwZSxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7IC8vRVJTMTkwNjIwIGNsaWVudFJlY29yZCBnZW5lcmljCmlmICghemQpIHpkPXpEYXRhOwppZiAoIWxhYmVsKSB7IGxhYmVsPXpkLnN0YWdlICsgIi0iICsgemQudHJpYWdlVHlwZSArICItIiArIHpkLnN0YWNrSWQ7fQovL0VSUzE3MDUyMCBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCBxdWV1ZXNNYXBLbHVkZ2VbWChkb2MsIlhfQXNzaWduX3RvX1F1ZXVlX19jIildKTsKdmFyIHpwPSIiOwppZiAoIixDYXNlLENvbnRhY3QsQWNjb3VudCxMZWFkLE9wcG9ydHVuaXR5LFpQQVBFUl9felN0YWNrX19jLCIudG9Mb3dlckNhc2UoKS5pbmRleE9mKCIsIitzZlR5cGUudG9Mb3dlckNhc2UoKSsiLCIpPi0xKSB6cD16RGF0YS56cDsKLy9vbmx5IGRvIHRoaXMgaWYgdGhlIGZpZWxkcyBleGlzdAphcnJPZlBhaXJzLnB1c2goenArIm5ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKYXJyT2ZQYWlycy5wdXNoKHpwKyJsYXRlc3RGYXhfX2MiLCB6ZC5mb3JtYXROb3cpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCmFyck9mUGFpcnMucHVzaCh6cCsicmVjZWl2ZWRJZF9fYyIsIGRvYy5kYklEKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoKLy9UT0RPIHB1dCBjbGllbnQgc3BlY2lmaWMgZGF0YSB1cGRhdGVzIGhlcmUKCnZhciBuZXdJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsIHNmVHlwZSwgbGFiZWwsIGFyck9mUGFpcnMpOwpyZXR1cm4gbmV3SWQ7Cn07Cgp6RGF0YS5jbGllbnRDb21wbGV0ZT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyx6ZCkge3JldHVybiBhcnJPZlBhaXJzO307IC8vRVJTMTkwNjI1CnpEYXRhLmNsaWVudERlbGl2ZXJ5PWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzKSB7IC8vRVJTMjAwMjAyIFRPRE8gY29uc2lkZXIgbmV3IERvY3VtZW50X01WTgogcmV0dXJuIGFyck9mUGFpcnM7Cn07IC8vRVJTMTkwNzExICM2MDkwMCBQQU9TCgp6RGF0YS5jbGllbnRDaGlsZFN0YWNrPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLHBhcmVudElkKSB7IC8vRVJTMTkwODEwICM2MTU3MCBiZSBzdXJlIHRvIGNhbGwgb24gbmV3IGNoaWxkIGRvYwogaWYoekRhdGEuWF9aUEFQRVJfX1ByaW9yaXR5X19jICYmIHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYyAhPSAiRE9OT1RfU0FWRSIpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcmlvcml0eV9fYyIsIHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYyk7CiBpZih6RGF0YS5YX1pQQVBFUl9Ub19GYWNpbGl0eV9fYyAmJiB6RGF0YS5YX1pQQVBFUl9Ub19GYWNpbGl0eV9fYyAhPSAiRE9OT1RfU0FWRSIpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX1RvX0ZhY2lsaXR5X19jIiwgekRhdGEuWF9aUEFQRVJfVG9fRmFjaWxpdHlfX2MpOwogCiBpZih6RGF0YS5YX1pQQVBFUl9QcmltYXJ5X1BheWVyX05hbWVfX2MgJiYgekRhdGEuWF9aUEFQRVJfUHJpbWFyeV9QYXllcl9OYW1lX19jICE9ICJET05PVF9TQVZFIikgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfUHJpbWFyeV9QYXllcl9OYW1lX19jIiwgekRhdGEuWF9aUEFQRVJfUHJpbWFyeV9QYXllcl9OYW1lX19jKTsKIGlmKHpEYXRhLlhfWlBBUEVSX1ByaW1hcnlfTWVtYmVyX0lEX19jKSBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9QcmltYXJ5X01lbWJlcl9JRF9fYyIsIHpEYXRhLlhfWlBBUEVSX1ByaW1hcnlfTWVtYmVyX0lEX19jKTsKIAogaWYoekRhdGEuWF9aUEFQRVJfU2Vjb25kYXJ5X1BheWVyX05hbWVfX2MgJiYgekRhdGEuWF9aUEFQRVJfU2Vjb25kYXJ5X1BheWVyX05hbWVfX2MgIT0gIkRPTk9UX1NBVkUiKSBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9TZWNvbmRhcnlfUGF5ZXJfTmFtZV9fYyIsIHpEYXRhLlhfWlBBUEVSX1NlY29uZGFyeV9QYXllcl9OYW1lX19jKTsKIGlmKHpEYXRhLlhfWlBBUEVSX1NlY29uZGFyeV9NZW1iZXJfSURfX2MpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX1NlY29uZGFyeV9NZW1iZXJfSURfX2MiLCB6RGF0YS5YX1pQQVBFUl9TZWNvbmRhcnlfTWVtYmVyX0lEX19jKTsKIAogaWYoekRhdGEuWF9aUEFQRVJfUHJvdmlkZXJfUGhvbmVfX2MpewogYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfUHJvdmlkZXJfUGhvbmVfX2MiLCB6RGF0YS5YX1pQQVBFUl9Qcm92aWRlcl9QaG9uZV9fYyk7IC8vUFYyMTAxMTIKIH0KIGlmKHpEYXRhLlhfWlBBUEVSX1Byb3ZpZGVyX0ZpcnN0X05hbWVfX2MpewogYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfUHJvdmlkZXJfRmlyc3RfTmFtZV9fYyIsIHpEYXRhLlhfWlBBUEVSX1Byb3ZpZGVyX0ZpcnN0X05hbWVfX2MpOyAvL1BWMjEwMTEyCiB9CiBpZih6RGF0YS5YX1pQQVBFUl9Qcm92aWRlcl9MYXN0X05hbWVfX2MpewogYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfUHJvdmlkZXJfTGFzdF9OYW1lX19jIiwgekRhdGEuWF9aUEFQRVJfUHJvdmlkZXJfTGFzdF9OYW1lX19jKTsgLy9QVjIxMDExMgogfQogaWYoekRhdGEuWF9aUEFQRVJfX05QSV9fYyl7CiBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fTlBJX19jIiwgekRhdGEuWF9aUEFQRVJfX05QSV9fYyk7IC8vUFYyMTAxMTIKIH0KIGlmKHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYyl7CiBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJpb3JpdHlfX2MiLCB6RGF0YS5YX1pQQVBFUl9fUHJpb3JpdHlfX2MpOyAvL1BWMjEwMTE5CiB9CiBpZih6RGF0YS5YX3pQYXBlcl9SZWFzb25fZm9yX1Zpc2l0X19jKSBhcnJPZlBhaXJzLnB1c2goInpQYXBlcl9SZWFzb25fZm9yX1Zpc2l0X19jIiwgekRhdGEuWF96UGFwZXJfUmVhc29uX2Zvcl9WaXNpdF9fYyk7IC8vUFYyMTAxMDQKIGlmKHpEYXRhLlhfQmFwdGlzdF9IZWFydF9TcGVjaWFsaXN0X09yZGVyX19jKSBhcnJPZlBhaXJzLnB1c2goIkJhcHRpc3RfSGVhcnRfU3BlY2lhbGlzdF9PcmRlcl9fYyIsIHpEYXRhLlhfQmFwdGlzdF9IZWFydF9TcGVjaWFsaXN0X09yZGVyX19jKTsKIGlmKHpEYXRhLlhfQXR0ZXN0YXRpb25fSW5jbHVkZWRfX2MpIGFyck9mUGFpcnMucHVzaCgiQXR0ZXN0YXRpb25fSW5jbHVkZWRfX2MiLCB6RGF0YS5YX0F0dGVzdGF0aW9uX0luY2x1ZGVkX19jKTsgLy9QVjIxMTIyMAogaWYoekRhdGEuWF9SZWFkeV9mb3JfU2NoZWR1bGluZ19fYykgYXJyT2ZQYWlycy5wdXNoKCJSZWFkeV9mb3JfU2NoZWR1bGluZ19fYyIsIHpEYXRhLlhfUmVhZHlfZm9yX1NjaGVkdWxpbmdfX2MpOwogCiBpZih6RGF0YS5YX3pQYXBlcl9BVUNfRFNOX19jKWFyck9mUGFpcnMucHVzaCgielBhcGVyX0FVQ19EU05fX2MiLHpEYXRhLlhfelBhcGVyX0FVQ19EU05fX2MpOwogaWYoekRhdGEuWF96UGFwZXJfQVVDX0dfQ29kZV9fYylhcnJPZlBhaXJzLnB1c2goInpQYXBlcl9BVUNfR19Db2RlX19jIix6RGF0YS5YX3pQYXBlcl9BVUNfR19Db2RlX19jKTsKIGlmKHpEYXRhLlhfelBhcGVyX0FVQ19Nb2RpZmllcl9fYylhcnJPZlBhaXJzLnB1c2goInpQYXBlcl9BVUNfTW9kaWZpZXJfX2MiLHpEYXRhLlhfelBhcGVyX0FVQ19Nb2RpZmllcl9fYyk7CiBpZih6RGF0YS5YX3pQYXBlcl9BVUNfU2NvcmVfX2MpYXJyT2ZQYWlycy5wdXNoKCJ6UGFwZXJfQVVDX1Njb3JlX19jIix6RGF0YS5YX3pQYXBlcl9BVUNfU2NvcmVfX2MpOwogLy9pZih6RGF0YS5YX0Nhc2VfTm90ZXNfX2MpYXJyT2ZQYWlycy5wdXNoKCJDYXNlX05vdGVzX19jIix6RGF0YS5YX0Nhc2VfTm90ZXNfX2MpOwogCiB2YXIgcGFpcnM9YXJyT2ZQYWlyczsKIC8vbm8gbWVtb3J5IG9mIHN0YWNrIGNyZWF0aW9uIHZhciBwYWlycz16RGF0YS5zdGFja1BhaXJzOwogLy9DUk4yMDEwMjYgIzc2Nzg4IFdlIG5lZWQgcmV2aWV3ZWRTdGF0dXMgdG8gYmUgIkluZGV4ZWQiIGZvciB0aGUgaW5kZXggcnVsZSwgc28gb25seSBzZXQgdGhlIGZpZWxkIGlmIGl0IGlzbid0IGFscmVhZHkgc2V0LgogaWYgKCF6RGF0YS5yZXZpZXdlZFN0YXR1cykgeyB6RGF0YS5yZXZpZXdlZFN0YXR1cz0iU3BsaXQiOyB9CiAvL3BhaXJzLnB1c2goIlpQQVBFUl9fU3RhdHVzX19jIiwgIkNoaWxkIFN0YWNrIik7IC8vRVJTMTkwODEwIFRPRE8/IC8vUFYyMTAyMDEKIGFsZXJ0KCJkZWJ1ZyBwYWlycyA6ICIgKyBwYWlycyk7CiAKIHBhaXJzPXpEYXRhLmNsaWVudFN0YWNrKGRvYyxwYWlycyk7CiBpZiAoWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX3pDaGlsZEZpZWxkc19fYyIpKSB7IC8vRVJTMTkwODExIG5vdCBpbiBhbGwgTVBzCiBwYWlycz16RGF0YS5jbGllbnRGaWVsZHMoZG9jLHBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX196Q2hpbGRGaWVsZHNfX2MiKSk7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OIGNoaWxkIHJlY29yZCB0eXBlIGlkCiB9CiBhbGVydCgiZGVidWcgcGFpcnMgOiAiICsgcGFpcnMpOwogcGFpcnMucHVzaCgiWlBBUEVSX19QYXJlbnRfX2MiLCBwYXJlbnRJZCk7CiAvL0VSUzIwMTEyOCBzaG91bGQgYmUgaW4gekNoaWxkRmllbGRzIGlmICh6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSkgcGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIix6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSk7CiAKIHBhaXJzLnB1c2goekRhdGEuenArIlByb2dyYW1fX2MiLHpEYXRhLnByb2dyYW1OYW1lKTsgLy9FUlMyMDAyMDUgVE9ETyBpbiBwYWNrYWdlIGFuZCBpbnRvIGJhc2UgY2FsbCAvL1BWMjAxMjI5IGFkZGVkIHpwCiAvL0VSUzIwMDIyOSBpZiAoekRhdGEucGF0aWVudElkKSBwYWlycy5wdXNoKCJQcm9ncmFtX01lbWJlcl9NVk5fX2MiLHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMjAwMjA1IFByb2dyYW1fTWVtYmVyX01WTl9fYyB3YXMgdGhlIFRJQ0tFVCEhIQogYWxlcnQoIkVSUzE5MDgxMS4xOTEgWlBBUEVSX19QYXJlbnRfX2MiKyBwYXJlbnRJZCsiIGNoaWxkIHpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlPSIrekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGUpOwogYWxlcnQoImRlYnVnIHBhaXJzIDogIiArIHBhaXJzKTsKaWYgKCF6RGF0YS5kb2NUeXBlICYmICFYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKSkgeyAvL1BWMjEwMzE4Cgl6RGF0YS5kb2NUeXBlPWdldFNGRmllbGQoZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCAiWlBBUEVSX19mYXhUeXBlX19jIiwgbnVsbCwgcGFyZW50SWQpOwoJcGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIiwgekRhdGEuZG9jVHlwZSk7CiB9CiBpZiAoekRhdGFbJ1JlY29yZFR5cGVJZCddKSB7IHpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlPXpEYXRhWydSZWNvcmRUeXBlSWQnXTsgfSAvL0VSUzIwMTEyOSAjNzg4MzAgVE9ETyBub3Qgc3VyZSB3aGVyZSB0aGlzIGlzIHVzZWQgZWxzZXdoZXJlCiBhbGVydCgiRVJTMjAxMTI5LjI5MiBaUEFQRVJfX1BhcmVudF9fYyIrIHBhcmVudElkKyIgY2hpbGQgUmVjb3JkVHlwZUlkPSIrekRhdGFbJ1JlY29yZFR5cGVJZCddKTsKIHZhciBjaGlsZFN0YWNrU0ZJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJaUEFQRVJfX3pTdGFja19fYyIsICJ6U3RhY2sgIit6RGF0YS5yZXZpZXdlZFN0YXR1cysiIG9uICIgKyB6RGF0YS5mb3JtYXROb3csIHBhaXJzKSArICIiOyAvLyBQVjIxMDIwOCAielN0YWNrIHNwbGl0IG9uICIgCiAKIGlmICghekRhdGEucGF0aWVudElkICYmIFgoZG9jLCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiKSApeyAvL0VSUzIwMDMwOCBIQUNLCiB6RGF0YS5wYXRpZW50SWQ9WChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIpOwogYWxlcnQoIkVSUzIwMDMwOCBXSFkgTk9UIGluIHpEYXRhPyIpOwogfQogaWYgKHpEYXRhLnBhdGllbnRJZCkgeyAvL0VSUzIwMDMwOCBjcmVhdGUgYW4gQWN0aXZpdHkgRXZlbnQgcmVsYXRlZCB0byB0aGUgUGF0aWVudCAoQWNjb3VudCkgZm9yIHRoZSBUaW1lbGluZQogaWYgKCF6RGF0YS5kb2NUeXBlICYmIFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpKSB6RGF0YS5kb2NUeXBlPVgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwogdmFyIGFycj1bXTsKIC8vTk9UIFNFTEVDVCBBY2NvdW50SWQsQWN0aXZpdHlEYXRlLENyZWF0ZWREYXRlLFN0YXR1cyxTdWJqZWN0LFRhc2tTdWJ0eXBlLFdoYXRJZCxXaG9JZCBGUk9NIFRhc2sgd2hlcmUgQWN0aXZpdHlEYXRlID4gMjAyMC0wMi0wMQogLy9TRUxFQ1QgSWQsQWNjb3VudElkLEFjdGl2aXR5RGF0ZSxDcmVhdGVkRGF0ZSxTdWJqZWN0LFdoYXRJZCxXaG9JZCBGUk9NIEV2ZW50IHdoZXJlIElkID0gJzAwVTRUMDAwMDAydkNoclVBRScKIC8vYXJyLnB1c2goIldob0lkIix6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzIwMDMxMCB0aW1lbGluZSB0cmljawogaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMDEiKT09MCkgewogYXJyLnB1c2goIldoYXRJZCIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAzMTAgdGltZWxpbmUgdHJpY2sKIC8vYXJyLnB1c2goIkFjY291bnRJZCIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAzMTAgdGltZWxpbmUgdHJpY2sKIH0gZWxzZSBpZiAoekRhdGEuY2FzZUlkKSBhcnIucHVzaCgiV2hhdElkIix6RGF0YS5jYXNlSWQpOwogZWxzZSBpZiAoekRhdGEucHJvdmlkZXJJZCkgYXJyLnB1c2goIldoYXRJZCIsekRhdGEucHJvdmlkZXJJZCk7CiBlbHNlIGFyci5wdXNoKCJXaGF0SWQiLGNoaWxkU3RhY2tTRklkKTsKIC8vYXJyLnB1c2goIlRhc2tTdWJ0eXBlIiwiVGFzayIpOwogYXJyLnB1c2goIlN1YmplY3QiLHpEYXRhLnN0YWdlICsgIiAiK3pEYXRhLmRvY1R5cGUpOwogYXJyLnB1c2goIkRlc2NyaXB0aW9uIiwiQ2hlY2sgb3V0ICIrZG9jLmRiSUQpOwogLy9hcnIucHVzaCgiQWN0aXZpdHlEYXRlVGltZSIsekRhdGEuZm9ybWF0Tm93KTsgLy9FUlMyMDAzMDkgaGFja2luZyBhd2F5IQogYXJyLnB1c2goIkFjdGl2aXR5RGF0ZSIsekRhdGEuZm9ybWF0Tm93LnN1YnN0cmluZygwLDEwKSk7CiAvL2Fyci5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTI2MTAwMDAwMGozUGFBQUkiKTsgLy9FUlMyMDAzMTAgSEFDSyBmb3IgVGFzayBvbiBDYXJlUGxhbiAvL1BWMjAwMjE4IHVwZGF0ZWQgcmVjb3JkIHR5cGUgaWRvZiBUQVNLCiAgCiBpZiAoWEN1c3RvbVNldHRpbmcoZG9jLCJUYXNrRmllbGRzX19jIikpIHsgLy9FUlMxOTA4MTEgbm90IGluIGFsbCBNUHMKIGFycj16RGF0YS5jbGllbnRGaWVsZHMoZG9jLGFycixYQ3VzdG9tU2V0dGluZyhkb2MsIlRhc2tGaWVsZHNfX2MiKSk7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OIGNoaWxkIHJlY29yZCB0eXBlIGlkCiB9CiAvL2Fyci5wdXNoKCJEdXJhdGlvbkluTWludXRlcyIsIjUiKTsKIC8vYXJyLnB1c2goIlN0YXR1cyIsIkNvbXBsZXRlZCIpOwogCiB2YXIgbGFiZWw9IlRpbWVsaW5lICIrekRhdGEuZG9jVHlwZTsKIC8vdmFyIGFjdElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiVGFzayIsIG51bGwsIGFycik7IC8vRVJTMjAwMzA5IG51bGwgbWVhbnMgbm8gTmFtZSBmaWVsZCAvL1BWMjAxMjI5IHdlIGRvbid0IG5lZWQgdG8gY3JlYXRlIGF0c2sKIC8vdmFyIGFjdElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiRXZlbnQiLCBudWxsLCBhcnIpOyAvL0VSUzIwMDMwOSBudWxsIG1lYW5zIG5vIE5hbWUgZmllbGQKIC8vYWxlcnQoIkVSUzIwMDMwOC4yNjIgdGltZWxpbmUgYWN0aXZpdHkgIithY3RJZCk7CiB9IGVsc2UgeyBhbGVydCgiRVJTMjAwMzA4LjI2MyBiZSB3b3JyaWVkIHRoZXJlIGlzIG5vIHBhdGllbnQhIik7IH0KIGlmICgxPT09MSAmJiB6RGF0YS5jbGllbnRSZWNlaXZlZERvY3VtZW50KSB7IHpEYXRhLnJlY0RvY0lkPXpEYXRhLmNsaWVudFJlY2VpdmVkRG9jdW1lbnQoZG9jLGNoaWxkU3RhY2tTRklkKTsgfSAvL0VSUzIwMTAxOCAjNzcyNTIKIHJldHVybiBjaGlsZFN0YWNrU0ZJZDsKfTsKCgp6RGF0YS51cGRhdGVTdGFja0lkT25DYXNlcz1mdW5jdGlvbihjYXNlSWRzLCBzdGFja0lkKSB7CiAgICBhbGVydCgiQGNhc2VJZHMiICsgY2FzZUlkcyk7CiAgICBhbGVydCgiQHN0YWNrSWQiICsgc3RhY2tJZCk7CiAgICB2YXIgelN0Y2tJZE9uQ2FzZSA9ICIiOwoJaWYoIWNhc2VJZHMpCgkJY2FzZUlkcyA9IFtdOwoJaWYoY2FzZUlkcy5pbmRleE9mKHpEYXRhLmNhc2VJZCkgPT0gLTEgJiYgekRhdGEuY2FzZUlkKSB7CgkgICAgY2FzZUlkcy5wdXNoKHpEYXRhLmNhc2VJZCk7CgkgICAgelN0Y2tJZE9uQ2FzZSA9IGdldFNGRmllbGQoZG9jLCAiY2FzZSIsICJ6U3RhY2tfX2MiLCBudWxsLCB6RGF0YS5jYXNlSWQpOy8vUFYyMTEwMDYgLy9QVjIxMTEzMAoJfQoKCWZvcih2YXIgaSA9IDA7IGkgPCBjYXNlSWRzLmxlbmd0aDsgaSsrKSB7CgkgICAgaWYgKCF6U3Rja0lkT25DYXNlKXsKCSAgICAgICAgdmFyIGNhc2VBcnJPZlBhaXJzID0gW107CgkJICAgIGNhc2VBcnJPZlBhaXJzLnB1c2goInpTdGFja19fYyIsIHN0YWNrSWQpOwoJCSAgICB1cGRhdGVTRlJlY29yZChkb2MsICJjYXNlIiwgY2FzZUlkc1tpXSwgY2FzZUFyck9mUGFpcnMpOyAvL1BWMjIwMTEwCgkgICAgfQoJfQp9CnpEYXRhLmNsaWVudFN0YWNrQ29tcGxldGU9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsemQpIHsgLy9FUlMyMDAzMTQgIzcwMzM2CiBpZiAoIXpkKSB6ZD16RGF0YTsgLy9FUlMyMDA0MDYgIzcxMTU2CiBhcnJPZlBhaXJzLnB1c2goIlRpbWVfQ29tcGxldGVfRGF0ZV9fYyIsemQuZm9ybWF0Tm93KTsgLy9mb3IgZGFzaGJvYXJkCiByZXR1cm4gYXJyT2ZQYWlyczsKfTsgLy9FUlMxOTA2MjUKCnpEYXRhLmNsaWVudENhc2VzRm9yUHJvY2VkdXJlQ29kZT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycykgewogICAgekRhdGEuYXR0YWNoUGF0aElkcyA9ICIiOy8vc3RvcmUgcmVmZXJlbmNlIHRvIGlkcyB0aGF0IGFyZSB0byBiZSBhZGRlZCB0byBhdHRhY2hQYXRoCiAgICAvL1BWMjEwMTAyIGRhdGEgZW50cnkgcGFubmVsIDIKICAgIHZhciBEaWFnbm9zaXNfQ29kZV9fYz0iIjsKICAgIGlmKHpEYXRhLlhfWlBBUEVSX0RpYWdub3Npc19Db2RlXzFfX2MpewogICAgCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX0RpYWdub3Npc19Db2RlXzFfX2MiLCB6RGF0YS5YX1pQQVBFUl9EaWFnbm9zaXNfQ29kZV8xX19jKTsKICAgIAloZWFsdGhDYXJlRGlhZ25vc2lzID0gZ2V0U0ZGaWVsZChkb2MsICJIZWFsdGhDYXJlRGlhZ25vc2lzIiwgIkNvZGUiLCBudWxsLCB6RGF0YS5YX1pQQVBFUl9EaWFnbm9zaXNfQ29kZV8xX19jKTsKICAgIAlEaWFnbm9zaXNfQ29kZV9fYys9aGVhbHRoQ2FyZURpYWdub3NpcyArICAiLCI7IC8vUFYyMTAxMTIgdXBkYXRlZCBOYW1lIHRvIENvZGUKICAgIH0KICAgIAogICAgaWYoekRhdGEuWF9aUEFQRVJfRGlhZ25vc2lzX0NvZGVfMl9fYykgewogICAgCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX0RpYWdub3Npc19Db2RlXzJfX2MiLCB6RGF0YS5YX1pQQVBFUl9EaWFnbm9zaXNfQ29kZV8yX19jKTsKICAgIAloZWFsdGhDYXJlRGlhZ25vc2lzID0gZ2V0U0ZGaWVsZChkb2MsICJIZWFsdGhDYXJlRGlhZ25vc2lzIiwgIkNvZGUiLCBudWxsLCB6RGF0YS5YX1pQQVBFUl9EaWFnbm9zaXNfQ29kZV8yX19jKTsKICAgIAlEaWFnbm9zaXNfQ29kZV9fYys9IGhlYWx0aENhcmVEaWFnbm9zaXMgKyAgIiwiOyAvL1BWMjEwMTEyIHVwZGF0ZWQgTmFtZSB0byBDb2RlCiAgICB9CiAgICBpZih6RGF0YS5YX1pQQVBFUl9EaWFnbm9zaXNfQ29kZV8zX19jKSB7CiAgICAJYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfRGlhZ25vc2lzX0NvZGVfM19fYyIsIHpEYXRhLlhfWlBBUEVSX0RpYWdub3Npc19Db2RlXzNfX2MpOwogICAgCWhlYWx0aENhcmVEaWFnbm9zaXMgPSBnZXRTRkZpZWxkKGRvYywgIkhlYWx0aENhcmVEaWFnbm9zaXMiLCAiQ29kZSIsIG51bGwsIHpEYXRhLlhfWlBBUEVSX0RpYWdub3Npc19Db2RlXzNfX2MpOwogICAgCURpYWdub3Npc19Db2RlX19jKz0gaGVhbHRoQ2FyZURpYWdub3NpcyArICAiLCI7IC8vUFYyMTAxMTIgdXBkYXRlZCBOYW1lIHRvIENvZGUKICAgIH0KICAgIAogICAgdmFyIGNhc2VJZHMgPSBbXTsKICAgIGFyck9mUGFpcnNDYXNlPVtdOwogICAgYXJyT2ZQYWlyc0Nhc2UucHVzaCgiRGlhZ25vc2lzX0NvZGVfX2MiLERpYWdub3Npc19Db2RlX19jKTsKICAgIC8vdmFyIHNmU3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7CiAgICAvL2Fyck9mUGFpcnNDYXNlLnB1c2goInpTdGFja19fYyIsc2ZTdGFja0lkKTsgLy9QVjIxMTIwMgogICAgaWYoekRhdGEucGF0aWVudElkKQogICAgICAgIHpEYXRhLnBhdGllbnRDb250YWN0SWQ9Z2V0U0ZGaWVsZChkb2MsICdDb250YWN0JywgJ0lkJywgJ0FjY291bnRJZD1cJycgKyB6RGF0YS5wYXRpZW50SWQgKyAnXCcnLCBudWxsKTsKICAgIC8vYWxlcnQoInBhdGllbnQgY29udGFjdCBpZCA6ICIgKyB6RGF0YS5wYXRpZW50Q29udGFjdElkKTsgLy9QVjIxMDEyNiBjb21tZW50ZWQKICAgIGlmKHpEYXRhLlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzFfX2MpewogICAgICAgIGFyck9mUGFpcnMucHVzaCgielBhcGVyX1Byb2NlZHVyZV9Db2RlXzFfX2MiLCB6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8xX19jKTsKICAgICAgICBhcnJPZlBhaXJzQ2FzZS5wdXNoKCJDdXN0b21fUHJvY2VkdXJlX19jIix6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8xX19jKTsKICAgICAgICB2YXIgY2FzZUlkID0gekRhdGEuY2xpZW50Q2FzZShkb2MsYXJyT2ZQYWlyc0Nhc2UpOwogICAgICAgIHpEYXRhLmF0dGFjaFBhdGhJZHMrPSIsIitjYXNlSWQ7CiAgICAgICAgY2FzZUlkcy5wdXNoKGNhc2VJZCk7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDYXNlMV9fYyIsIGNhc2VJZCk7IC8vUFYyMTAxMTkgYWRkZWQgdG8gdXBkYXRlIGNhc2Vsb29rdXAgZmllbGQgb24genN0YWNrCiAgICAgICAKICAgIH0KICAgIGlmKHpEYXRhLlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzJfX2MpewogICAgICAgIGFyck9mUGFpcnMucHVzaCgielBhcGVyX1Byb2NlZHVyZV9Db2RlXzJfX2MiLCB6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8yX19jKTsKICAgICAgICBhcnJPZlBhaXJzQ2FzZS5wdXNoKCJDdXN0b21fUHJvY2VkdXJlX19jIix6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8yX19jKTsKICAgICAgICB2YXIgY2FzZUlkID0gekRhdGEuY2xpZW50Q2FzZShkb2MsYXJyT2ZQYWlyc0Nhc2UpOyAvL1BWMjEwMTA1IGZvciBhdHRjaG1lbnQgb24gZG9jc2V0CiAgICAgICAgekRhdGEuYXR0YWNoUGF0aElkcys9IiwiK2Nhc2VJZDsKICAgICAgICBjYXNlSWRzLnB1c2goY2FzZUlkKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNhc2UyX19jIiwgY2FzZUlkKTsKICAgIH0KICAgIGlmKHpEYXRhLlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzNfX2MpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goInpQYXBlcl9Qcm9jZWR1cmVfQ29kZV8zX19jIiwgekRhdGEuWF96UGFwZXJfUHJvY2VkdXJlX0NvZGVfM19fYyk7CiAgICAgICAgYXJyT2ZQYWlyc0Nhc2UucHVzaCgiQ3VzdG9tX1Byb2NlZHVyZV9fYyIsekRhdGEuWF96UGFwZXJfUHJvY2VkdXJlX0NvZGVfM19fYyk7CiAgICAgICAgdmFyIGNhc2VJZCA9ekRhdGEuY2xpZW50Q2FzZShkb2MsYXJyT2ZQYWlyc0Nhc2UpOwogICAgICAgIHpEYXRhLmF0dGFjaFBhdGhJZHMrPSIsIitjYXNlSWQ7CiAgICAgICAgY2FzZUlkcy5wdXNoKGNhc2VJZCk7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDYXNlM19fYyIsIGNhc2VJZCk7CiAgICB9CiAgICAvL1BWMjEwMTE5IGFkZGVkIGNhc2UgY3JlYXRpb24gbG9naWMgaWYgdGhlcmUgaXMgbm8gcHJvY2VkdXJlIGNvZGUKICAgIC8vaWYoekRhdGEuWF9aUEFQRVJfX1ByaW9yaXR5X19jICYmICF6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8xX19jICYmICF6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8yX19jICYmICF6RGF0YS5YX3pQYXBlcl9Qcm9jZWR1cmVfQ29kZV8zX19jICApewogICAgaWYoIXpEYXRhLmNhc2VJZCAmJiB6RGF0YS5YX1pQQVBFUl9fUHJpb3JpdHlfX2MgJiYgIXpEYXRhLlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzFfX2MgJiYgIXpEYXRhLlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzJfX2MgJiYgIXpEYXRhLlhfelBhcGVyX1Byb2NlZHVyZV9Db2RlXzNfX2MgICl7CiAgICAgICAgdmFyIGNhc2VJZCA9ekRhdGEuY2xpZW50Q2FzZShkb2MsYXJyT2ZQYWlyc0Nhc2UpOwogICAgICAgIHpEYXRhLmF0dGFjaFBhdGhJZHMrPSIsIitjYXNlSWQ7CiAgICAgICAgY2FzZUlkcy5wdXNoKGNhc2VJZCk7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0Nhc2VfX2MiLCBjYXNlSWQpOwogICAgfQogICAgCiAgICB6RGF0YS5jYXNlSWRzID0gY2FzZUlkczsKfTsKCnpEYXRhLmNsaWVudFByb3ZpZGVyPWZ1bmN0aW9uKGRvYywgYXJyT2ZQYWlycykgewogICAgLy9sYWJlbCB3aWxsIGJlIGF1dG8gcG9wdWxhdGVkCiAgICBhbGVydCgiZGVidWdnaW5nIHByb3ZpZGVyIGRhdGEgOiAiKTsKICAgIGFsZXJ0KCJ6RGF0YS5YX1pQQVBFUl9Qcm92aWRlcl9GaXJzdF9OYW1lX19jIDogIiArIHpEYXRhLlhfWlBBUEVSX1Byb3ZpZGVyX0ZpcnN0X05hbWVfX2MgKyAiOyBaUEFQRVJfUHJvdmlkZXJfRmlyc3RfTmFtZV9fYyA6ICIgKyB6RGF0YS5aUEFQRVJfUHJvdmlkZXJfRmlyc3RfTmFtZV9fYyk7CiAgICBhbGVydCgiekRhdGEuWF9aUEFQRVJfUHJvdmlkZXJfTGFzdF9OYW1lX19jIDogIiArIHpEYXRhLlhfWlBBUEVSX1Byb3ZpZGVyX0xhc3RfTmFtZV9fYyArICI7IFpQQVBFUl9Qcm92aWRlcl9MYXN0X05hbWVfX2MgOiAiICsgekRhdGEuWlBBUEVSX1Byb3ZpZGVyX0xhc3RfTmFtZV9fYyk7CiAgICBhbGVydCgiekRhdGEuWF9aUEFQRVJfUHJvdmlkZXJfUGhvbmVfX2MgOiAiICsgekRhdGEuWF9aUEFQRVJfUHJvdmlkZXJfUGhvbmVfX2MgKyAiOyBaUEFQRVJfUHJvdmlkZXJfUGhvbmVfX2MgOiAiICsgekRhdGEuWlBBUEVSX1Byb3ZpZGVyX1Bob25lX19jKTsKICAgIGFsZXJ0KCJ6RGF0YS5YX1pQQVBFUl9fTlBJX19jIDogIiArIHpEYXRhLlhfWlBBUEVSX19OUElfX2MgKyAiOyBaUEFQRVJfX05QSV9fYyA6ICIgKyB6RGF0YS5aUEFQRVJfX05QSV9fYyk7CgogICAgYXJyT2ZQYWlycy5wdXNoKCJGaXJzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9Qcm92aWRlcl9GaXJzdF9OYW1lX19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgiTGFzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9Qcm92aWRlcl9MYXN0X05hbWVfX2MpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJQaG9uZSIsIHpEYXRhLlhfWlBBUEVSX1Byb3ZpZGVyX1Bob25lX19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgiTlBJX19jIiwgekRhdGEuWF9aUEFQRVJfX05QSV9fYyk7CgogICAgdmFyIHByb3ZpZGVyRmllbGRzID0gWEN1c3RvbVNldHRpbmcoZG9jLCJ6UGFwZXJfUHJvdmlkZXJGaWVsZHNfX2MiKTsKICAgIGFsZXJ0KCJwcm92aWRlckZpZWxkcyAtICIgKyBwcm92aWRlckZpZWxkcyk7CiAgICAKICAgIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywielBhcGVyX1Byb3ZpZGVyRmllbGRzX19jIikpOwogICAgYWxlcnQoImFyck9mUGFpcnMgOiAiICsgYXJyT2ZQYWlycyk7CiAgICAKICAgIHpEYXRhLnByb3ZpZGVySWQgPSB6RGF0YS5jbGllbnRSZWNvcmQoZG9jLHpEYXRhLnByb3ZpZGVyVHlwZSwgYXJyT2ZQYWlycywgJycsIHpEYXRhKTsKICAgIHByb3ZpZGVyTmFtZSA9ekRhdGEuWF9aUEFQRVJfUHJvdmlkZXJfRmlyc3RfTmFtZV9fYysiICIrekRhdGEuWF9aUEFQRVJfUHJvdmlkZXJfTGFzdF9OYW1lX19jOyAvL1BWMjAxMjI5IGFkZGVkIHRoaXMgdG8gc2hvdyBuZXdseSBjcmVhdGVkIGNvbnRhY3Qgb24gbG9va3VwCiAgICB2YXIgZHEgPSB6RGF0YS5kcSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoMzQpOwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUHJvdmlkZXJDb250YWN0X19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLnByb3ZpZGVySWQgKyBkcSArICIpOyAiKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX1Byb3ZpZGVyQ29udGFjdF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHByb3ZpZGVyTmFtZSArIGRxICsgIik7ICIpOwp9OwoKCgp6RGF0YS5jbGllbnRMaWdodG5pbmdGaWxlPWZ1bmN0aW9uKGRvYyxzZklkcyx6ZCkgewoJaWYgKCF6ZCkgemQgPSB6RGF0YTsKCWlmICghZG9jLmtiRGF0YS5zZlNlcnZlcikgewoJCS8vRVJTMjAwNDI4IEhBQ0sKCQlhbGVydCgiZG9jLmtiRGF0YS5zZlNlcnZlciB3YXMgZW1wdHkuIElkZWFsbHkgc2hvdWxkIE5PVCBjb21lIGhlcmUiKTsKCQlkb2Mua2JEYXRhLnNmU2VydmVyID0gInRha2VkYXBhdGllbnRzZXJ2aWNlcy0tdGtkZXYyLmxpZ2h0bmluZy5mb3JjZS5jb20iOwoJfQoJdmFyIHpzZXJ2ZXIgPSBkb2Mua2JEYXRhLnNmU2VydmVyLmluZGV4T2YoImh0dHBzOi8vIikgPT0gMCA/IGRvYy5rYkRhdGEuc2ZTZXJ2ZXIgOiAiaHR0cHM6Ly8iICsgZG9jLmtiRGF0YS5zZlNlcnZlcjsKCS8vIFNhbGVzZm9yY2UgUkVTVCBBUEkgZW5kcG9pbnQKCXZhciBkb2N1cmwgPSB6c2VydmVyICsgIi9zZXJ2aWNlcy9kYXRhL3Y0Ni4wL3NvYmplY3RzL0NvbnRlbnRWZXJzaW9uLyI7Cgl2YXIgcGRmdXJsID0gImh0dHBzOi8vZ3cuenBhcGVyLmNvbS9rYi9qc3AvU0ZfZmluZC5saWdodG5pbmcuanNwP2dvPVNGX2ZpbGVzLmpzcCZkYklEPSIgKyBkb2MuZGJJRCArICImU0Zvcmc9IiArIGRvYy5rYkRhdGEuc2ZPcmdhbml6YXRpb25JRDsKCgkvLyBHZW5lcmF0ZSBQREYgZmlsZSBmcm9tIHpTdGFjawoJdmFyIGZvcm1hdE5vdyA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYywgZmFsc2UsIHRydWUpOyAvLyBlLmcuICIyMDIxMDIxMC0wNTIxMzIiPwoJdmFyIGFyck9mUGFpcnMgPSBbXTsKCXZhciBub3dUaW1lU3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOwogICAgLy92YXIgZmlsZU5hbWUgPSAhYWNjbmFtZSAmJiAhZmF4dHlwZSA/IGRvYy5sYWJlbCA6IGFjY25hbWUgKyAiIC0gIiArIGZheHR5cGUgKyAiIC0gIiArIGRhdGVzdHI7CiAgICB2YXIgYWNjbmFtZSA9IFgoZG9jLCAiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19yLk5hbWUiKTsKICAgIHZhciBmYXh0eXBlID0gWChkb2MsICJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwogICAgdmFyIGRhdGVzdHIgPSBnZXRDdXJEYXRlKGRvYyk7CiAgICBpZighZmF4dHlwZSkvL1BWMjEwMzE4CgkgZmF4dHlwZSA9IHpEYXRhLmRvY1R5cGU7IC8vUFYyMTAzMTggYWRkZWQgaXQgZm9yIHRvIHVwZGF0ZSBkb2N0eXBlIG9uIExpZ2h0bmluZyBmaWxlcwoJIGlmKCFhY2NuYW1lKQoJCWFjY25hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiKSArICIgIiArIFgoZG9jLCAiWF9aUEFQRVJfX0xhc3ROYW1lX19jIik7IC8vUFYyMTAzMTgKCQkKICAgIHZhciBmaWxlTmFtZSA9ICFhY2NuYW1lICYmICFmYXh0eXBlID8gZG9jLmxhYmVsIDogYWNjbmFtZSArICIgLSAiICsgZmF4dHlwZSArICIgLSAiICsgZGF0ZXN0cjsKICAgIGZpbGVOYW1lICs9ICIucGRmIjsKCS8vdmFyIGZpbGVOYW1lID0gZ2V0Q3VyRGF0ZShkb2MpICsgIiBOZXcgRmF4LnBkZiI7IC8vIGUuZyAtICIyMDIxMDIxMCBOZXcgRmF4LnBkZiI/CglhbGVydCgiQEBAZmlsZU5hbWUgPSAiICsgZmlsZU5hbWUpOwoKCXpEYXRhLnVwbG9hZERpciA9ICd6U3RhY2tVcGxvYWRSb290JzsgLy9zZXR0aW5nIHJvb3QgZGlyZWN0b3J5IGZvciBmaWxlIGNyZWF0aW9uCgoJLy8gY3JlYXRlIGRpcmVjdG9yeSB0byBwbGFjZSBnZW5lcmF0ZWQgUERGIGZpbGUKCWNyZWF0ZURpcmVjdG9yeShkb2MsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wKTsKCgl2YXIgeFBhZ2VzID0gWChkb2MsICJYX3Bvc2l0aW9uIik7IC8vZ2V0IFhfcG9zaXRpb24gLSBwYWdlIHJhbmdlIHNlbGVjdGVkOyBkZWZhdWx0ID0gYWxsIHBhZ2VzCglhbGVydCgiQEBAQEAgQ2FsbGluZyBzcGxpdFBERiB0byBzcGxpdCBvZmYgcGFnZXMgdG8gdXBsb2FkIGFzIFBERiwgcGFnZXMgPSAiICsgeFBhZ2VzICsgIiwgbm93VGltZVN0YW1wID0gIiArIG5vd1RpbWVTdGFtcCk7Cgl2YXIgcmVzcG9uc2UgPSBzcGxpdFBERihkb2MsIHhQYWdlcywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXAsIGZpbGVOYW1lKTsKCWFsZXJ0KCJAQEBAIHJlc3BvbnNlIGZyb20gc3BsaXRQREYgPSAiICsgcmVzcG9uc2UpOwoJdmFyIG5ld1BERk5hbWUgPSBYKGRvYywgIm5ld1BERiIsIHJlc3BvbnNlKTsgLy8gc2V0IHZhbHVlIG9mIG5ld1BERgoKCWFsZXJ0KCJAQEBAIHNwbGl0IFBERiBGaWxlTmFtZSA9ICIgKyBuZXdQREZOYW1lKTsKCgkvLyBDYW5ub3QgZGlyZWN0bHkgQXBwZW5kIFBERiBmaWxlIHRvIG11bHRpcGFydCBmb3JtZGF0YQoJLy8gSlMgZG9lcyBub3QgYWxsb3cgcmVhZGluZyBhIGZpbGUgZnJvbSB0aGUgZmlsZSBzeXN0ZW0gKG5vcm1hbGx5IGFwcGxpZXMgdG8gY2xpZW50IHNpZGUgZm9yIHNlY3VyaXR5IHJlYXNvbnMpCgkvLyBXZSBkb250IGhhdmUgYSBOb2RlLmpzIGNvbnRhaW5lciwgc28gbm8gbHVjayB0aGVyZS4uIGhhdmUgdG8gZG8gdGhpcyBhbm90aGVyIHdheQoJLy8gRXJpYyBzdWdnZXN0ZWQgd2UgdXNlIHVwbG9hZFRvQ2xvdWQuanNwIGFwcHJvYWNoIHRvIGNyZWF0ZSBMaWdodG5pbmcgRmlsZSAocHJvYmFibHkgQ29udGVudERvY3VtZW50KSBpbiBTYWxlc2ZvcmNlCgoJLy92YXIgdXBsb2FkVVJMID0gImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9teWZpbGVmb3JjZS91cGxvYWRUb0Nsb3VkLmpzcD9TRnR5cGU9Q29udGVudFZlcnNpb24mU0ZpZD1ORVcmU0ZwaWQ9IiArIHNmSWRzWzBdICsgIiZTRm9yZz0iICsgZG9jLmtiRGF0YS5zZk9yZ2FuaXphdGlvbklEICsgIiZsYWJlbD0iICsgZmlsZU5hbWUgKyAiJnNlcnZlckZpbGU9IiArIG5ld1BERk5hbWUgKyAiJkRlc2NyaXB0aW9uPUZpbGUgYXR0YWNoZWQgYXMgUERGIjsvL1BWMjEwNDIzIHVwZGF0ZWQgVVJMCiAgICAgdmFyIHVwbG9hZFVSTCA9ICJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0Z0eXBlPUNvbnRlbnRWZXJzaW9uJlNGaWQ9TkVXJlNGcGlkPSIgKyBzZklkc1swXSArICImU0ZTZXJ2ZXI9IiArIGRvYy5rYkRhdGEuc2ZTZXJ2ZXIgKyAiJlNGU2Vzc2lvbj0iICsgZG9jLmtiRGF0YS5zZlNlc3Npb25JRCArICImbGFiZWw9IiArIGZpbGVOYW1lICsgIiZzZXJ2ZXJGaWxlPSIgKyBuZXdQREZOYW1lICsgIiZEZXNjcmlwdGlvbj1GaWxlIGF0dGFjaGVkIGFzIFBERiI7Ly9QVjIxMDUxMSB1cGRhdGVkIFVSTAoJYWxlcnQoIiMjIyMgVXBsb2FkIG5hdGl2ZSBQREYgd2l0aCAiICsgdXBsb2FkVVJMKTsKCgl2YXIgciA9IHdnZXQoZG9jLCB1cGxvYWRVUkwpOyAvLyA/Pz8/PyB3aWxsIHIgY29udGFpbiB0aGUgQ29udGVudERvY3VtZW50IGlkPwoKCWFsZXJ0KCd2YWx1ZSBmcm9tIHdnZXQgcmVzcG9uc2UgPj4+ICcgKyByKTsKCgl2YXIgaWR4QmVnaW4gPSByLmluZGV4T2YoIjxzZklEPiIpOwoJdmFyIGlkeEVuZCA9IHIuaW5kZXhPZigiPC9zZklEPiIpOwoJdmFyIHNmZG9jSWQ7CglpZiAoaWR4RW5kID4gaWR4QmVnaW4pIHsKCQlzZmRvY0lkID0gci5zdWJzdHJpbmcoaWR4QmVnaW4gKyA2LCBpZHhFbmQpOwoJCWFsZXJ0KCJzZkRvY0lkIGV4dHJhY3RlZCBmcm9tIHIgOiAiICsgc2Zkb2NJZCk7Cgl9CgoJLy8gRmluYWxseSwgZGVsZXRlIHRoZSBmb2xkZXIgYW5kIGFsbCBjb250ZW50cy4KCWNsZWFudXBEaXJlY3RvcnkoZG9jLCB6RGF0YS51cGxvYWREaXIsIG5vd1RpbWVTdGFtcCk7CgkKCXZhciBoZWFkZXJzID0gWwogICAgICAgICJBdXRob3JpemF0aW9uIiwgIkJlYXJlciAiICsgZG9jLmtiRGF0YS5zZlNlc3Npb25JRCwKICAgICAgICAiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb24iCiAgICBdOwoJZG9jdXJsID0genNlcnZlciArICcvc2VydmljZXMvZGF0YS92NDkuMC9zb2JqZWN0cy9Db250ZW50RG9jdW1lbnRMaW5rLyc7Cglmb3IgKHZhciBpbmRleCA9IDE7IGluZGV4IDwgc2ZJZHMubGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgLy9zaGFyaW5nIGZpbGVzIHdpdGggb3RoZXIgcmVjb3JkcwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q29udGVudERvY3VtZW50TGlua1JlY29yZCA9IHsKICAgICAgICAgICAgICAgICJDb250ZW50RG9jdW1lbnRJZCI6IHNmZG9jSWQsCiAgICAgICAgICAgICAgICAiTGlua2VkRW50aXR5SWQiOiBzZklkc1tpbmRleF0sCiAgICAgICAgICAgICAgICAiU2hhcmVUeXBlIjogIkkiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShjdXJyZW50Q29udGVudERvY3VtZW50TGlua1JlY29yZCk7CiAgICAgICAgICAgIHJlcyA9IHdwb3N0KGRvYywgZG9jdXJsLCBbXSwgaGVhZGVycywgYm9keSk7CiAgICAgICAgfSBjYXRjaCAoZXJycykgewogICAgICAgICAgICBhbGVydChlcnJzKTsKICAgICAgICB9CiAgICB9CgkKCXJldHVybiBudWxsOwp9Cgp6RGF0YS5jbGllbnRVcGRhdGVDYXNlPWZ1bmN0aW9uKGRvYyxzZklkLHpkKSB7CiAgICB2YXIgZXhpc3RpbmdDYXNlTm90ZXMgPSBnZXRTRkZpZWxkKGRvYywgIkNhc2UiLCAiT3JkZXJfTm90ZXNfX2MiLCBudWxsLCBzZklkKTsKICAgIGlmKGV4aXN0aW5nQ2FzZU5vdGVzKSB7CiAgICAgICAgZXhpc3RpbmdDYXNlTm90ZXMgKz0gJ1xcbic7CiAgICB9IGVsc2UgewogICAgICAgIGV4aXN0aW5nQ2FzZU5vdGVzID0gIiI7CiAgICB9CiAgICAKICAgIGlmKFgoZG9jLCJkYi1jb21tZW50cyIpKSB7CiAgICAgICAgdmFyIG5ld0Nhc2VOb3RlcyA9IGV4aXN0aW5nQ2FzZU5vdGVzICsgWChkb2MsImRiLWNvbW1lbnRzIik7CiAgICAgICAgdmFyIGFyck9mUGFpcnMgPSBbIk9yZGVyX05vdGVzX19jIiwgbmV3Q2FzZU5vdGVzXTsKICAgICAgICB1cGRhdGVTRlJlY29yZChkb2MsICJDYXNlIiwgc2ZJZCwgYXJyT2ZQYWlycyk7CiAgICB9Cn0="},"ordinal":1}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("start client library"); //ERS190803 #52661 from OccFit
//ERS201117 TODO get rid off these keywords and use a document journey wizard from KPS and Jake

//CRN201025 #76788 Moved from zStack Library so that it can be used in multiple rules.
var keywordMap={};
var keywords=["NEW:Document Stack~","ENRL:Enrollment~","ENRL:ENROLLMENT~","CON:Consent~","CON:consent~","FAC:Setting~","FAC:Distribution~","START:Start Form~","CHK:Checklist~","HIPAA:AUTHORIZATION~","HIPAA:HIPAA~","HIPAA:PORTABILITY~","REF:REFERRAL","REF:Referral","FIN:W2~","IC:Member ID~","FAX:"];
//keywordMap["TENR"] ="TENR:Start Form";
keywordMap["NEW"] ="NEW:Document Stack";
keywordMap["ENRL"] ="ENRL:Enrollment Form";
keywordMap["FAC"] ="FAC:Facility Enrollment Form";
keywordMap["FAX"] ="NEW:Document Stack";
//keywordMap["START"] ="NEW:Document Stack";
keywordMap["CON"] ="CON:Consent Form";
keywordMap["HIPAA"] ="HIPAA:HIPAA Authorization";
keywordMap["REF"] ="REF:Referral";
keywordMap["FW2"] ="FW2:W-2"; //JPB201023 a dded
keywordMap["I9"] ="I9:I-9"; //JPB201023 added
keywordMap["W4"] ="W4:W-4"; //JPB201023 added
keywordMap["DEM"] ="DEM:Demographics"; //CRN201026 added
keywordMap["CLIN"] ="CLIN:Clinical Notes"; //CRN201026 added
keywordMap["FIN"] ="FIN:Financial Info"; //CRN201026 added
keywordMap["IC"] ="IC:Insurance Card"; //CRN201026 added

zData.maxChannels=3; //ERS190731 #61272 zippi is strongly typed
zData.makeStack=true; //ERS190814 #61511

zData.watermark=""+XCustomSetting(doc,"watermark__c"); //ERS190618 best practice
//alert("ERS190411 wm="+zData.watermark+" ZPAPER__server__c="+XCustomSetting(doc,"ZPAPER__server__c"));
zData.uploadDir = ""+XCustomSetting(doc,"uploadDir__c"); //"alkermesRoot";
zData.patEnrollQueueId = ""+XCustomSetting(doc,"patientQueueId__c"); //'00G4C000000LkmZ'; //insert the Queue ID of the desired ownership queue. Update when migrating between environments. Need to add this queue in Setup
zData.recTypeRequest = ""+XCustomSetting(doc,"recTypeRequest__c"); //'0124C000000Cj5Y'; //ID of the Case Record Type Request_PS_MVN
//TODO zData.keywordMap["ENRL"] ="ENRL:Enrollment Form"; //TODO get from zStack picklists
//TODO zData.keywordMap["FAC"] ="FAC:Facility Enrollment Form";
//ERS200205 deleted demo data - do with custom settings

//PV210102 data entry pannel 2
zData.X_ZPAPER__Priority__c = X(doc, "X_ZPAPER__Priority__c");
zData.X_Baptist_Heart_Specialist_Order__c= X(doc, "X_Baptist_Heart_Specialist_Order__c");//PV210119
zData.X_Attestation_Included__c= X(doc, "X_Attestation_Included__c");//PV211220
zData.X_Ready_for_Scheduling__c= X(doc, "X_Ready_for_Scheduling__c");
zData.X_ZPAPER_To_Facility__c= X(doc, "X_ZPAPER_To_Facility__c");
zData.X_ZPAPER_Primary_Payer_Name__c= X(doc, "X_ZPAPER_Primary_Payer_Name__c");
zData.X_ZPAPER_Primary_Member_ID__c= X(doc, "X_ZPAPER_Primary_Member_ID__c");
zData.X_ZPAPER_Secondary_Payer_Name__c= X(doc, "X_ZPAPER_Secondary_Payer_Name__c");
zData.X_ZPAPER_Secondary_Member_ID__c= X(doc, "X_ZPAPER_Secondary_Member_ID__c");
zData.X_zPaper_Procedure_Code_1__c= X(doc, "X_zPaper_Procedure_Code_1__c");
zData.X_zPaper_Procedure_Code_2__c= X(doc, "X_zPaper_Procedure_Code_2__c");
zData.X_zPaper_Procedure_Code_3__c= X(doc, "X_zPaper_Procedure_Code_3__c");
zData.X_ZPAPER_Diagnosis_Code_1__c= X(doc, "X_ZPAPER_Diagnosis_Code_1__c");
zData.X_ZPAPER_Diagnosis_Code_2__c= X(doc, "X_ZPAPER_Diagnosis_Code_2__c");
zData.X_ZPAPER_Diagnosis_Code_3__c= X(doc, "X_ZPAPER_Diagnosis_Code_3__c");
zData.X_ZPAPER__PatientAccount__c= X(doc, "X_ZPAPER__PatientAccount__c");
zData.X_ZPAPER__ProviderContact__c= X(doc, "X_ZPAPER__ProviderContact__c");
zData.X_zPaper_Reason_for_Visit__c= X(doc, "X_zPaper_Reason_for_Visit__c");
zData.X_zPaper_AUC_DSN__c=X(doc, "X_zPaper_AUC_DSN__c");
zData.X_zPaper_AUC_G_Code__c=X(doc, "X_zPaper_AUC_G_Code__c");
zData.X_zPaper_AUC_Modifier__c=X(doc, "X_zPaper_AUC_Modifier__c");
zData.X_zPaper_AUC_Score__c=X(doc, "X_zPaper_AUC_Score__c");
zData.X_HealthCloudGA__Gender__pc=X(doc, "X_HealthCloudGA__Gender__pc");
//PV210102 data entry pannel 2 - end

var cs=XDeploymentInfo(doc, "Business_Process__c"); //ERS200222 need both deployment info and cs
//alert("cs="+cs);
if (cs) {
 if (cs.indexOf("zCustomSettings")>-1) cs=X(doc,"zCustomSettings",cs);
 alert("ERS200225 EVAL on "+cs);
 if (cs !== "") eval(""+cs); //ERS200222 TODO JSON.parse() //ERS200225 beeds to be eval but also needs to work!!!
 alert("No try just do!");
}

if (1===0 && !zData.childStackRecordType) { //TODO custom setting or deployment? //ERS201129 DONE in zChildFields
 alert("ERS201128 should be in custom settings zChildFields");
 zData.childStackRecordType="01211000001gBs3AAE"; //ERS201128 should be in custom settings zChildFields "0120R000001N2oI";
}

zData.clientImportSOQL=function(doc,fromFile) { //ERS190706 customize imports used by Create Stack
 zData.importer=XCustomSetting(doc,zData.zp+"Importer__c").trim();
 var sfId="";
 var parts=fromFile.split("_");
 //sfId = getSFRecordID(doc, "Account", { "Fax" : parts[3] } );
 zData.makeStack=true; //do all the work there by default
 return sfId;
};

//alert("zData.clientStack");
zData.clientStack=function(doc,arrOfPairs) { //zData or this?
 var zp=zData.zp; if (!zp) zp="ZPAPER__"; //ERS190805
if (zData.received) arrOfPairs.push("zStack_Received__c", zData.formatNow); //ERS190617 TODO save way to do this
if (zData.ownerId) arrOfPairs.push("OwnerId",zData.ownerId); // zCharta Queue "00G36000002CyTK"
if (zData.callerId) arrOfPairs.push("zCaller_ID__c", doc.deliveredFrom); //MSH170817 added
if (zData.patEnrollQueueId) arrOfPairs.push("OwnerId",zData.patEnrollQueueId);

 arrOfPairs.push("ZPAPER__faxType__c", zData.docType);
 arrOfPairs.push("ZPAPER__Classification__c", zData.classification);
 var pageRange = X(doc,"X_idxPages");
 if (!pageRange) pageRange="1-"+X(doc,"X_pages");
 var pageCount = zData.countPages(doc, pageRange);
 arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814
 //ERS190810 TODO? arrOfPairs.push("ZSTACK__Received__c", zData.formatNow);
 alert("ERS200213.51 pageRage="+pageRange + " but pageCount="+pageCount); //ERS200213 also called in new incoming stack
 if (!X(doc,"X_idxPages")) pageCount=X(doc,"X_pages"); //ERS200213 TODO fix zData.countPages()
 arrOfPairs.push("ZPAPER__Pages__c", pageCount);
 
 //ERS200204 TODO zStack.Program?

 if (zData.programName === zData.PROGRAM_ZCHARTA) { //JPB201023 changed from classification to programName
 arrOfPairs.push(zp+"Priority__c", "Urgent"); //JPB190426 changed to classification from program
 } else if (zData.programName === zData.PROGRAM_ZPAPYRUS) { //JPB201023 changed from classification to programName
 arrOfPairs.push(zp+"Priority__c", "Other");
 } else if (zData.programName === zData.PROGRAM_ZCARTA) { //JPB201023 changed from classification to programName
 arrOfPairs.push(zp+"Priority__c", "Stat");
 } else {
 arrOfPairs.push(zp+"Priority__c", "Routine"); //PV210119 updated value
 }
 
 arrOfPairs.push(zp+"sentFaxTo__c", ("Community" === zData.channel ? zData.channel : doc.deliveredTo)); //JPB190529 added so Community shows up in Master Intake List
 arrOfPairs.push(zp+"From__c",doc.deliveredFrom);
 if (zData.reviewedStatus) {arrOfPairs.push(zp+"Stage__c", zData.reviewedStatus); }
 else { arrOfPairs.push(zp+"Stage__c", "Received"); }
 zData.stackPairs=arrOfPairs; //ERS190810 #61570 for child stack later
 arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__zStackFields__c")); //ERS190803 #52661 using JSON
return arrOfPairs;
};

//alert("zData.clientFile");
zData.clientFile=function(doc,stage) { //ERS170829 #41298 returns a label to be used in any attaches and fixes the doc
 //Document attachment label should be "Patient Name - Doc Type - Date". Confirmed for zPaper File and SFDC Attachment
 var MMddYYYY = zData.formatTodayMMddYYYY();
 //CRN201025 #76788 Fixed to match the current demo.
 var patientName = X(doc,"X_ZPAPER__PatientAccount__r.Name");
 if (!patientName) {
 patientName = X(doc,"X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c");
 }
 var faxType = keywordMap[X(doc,"X_ZPAPER__faxType__c")];
 if (!faxType) { faxType = X(doc,"X_ZPAPER__faxType__c"); }
 if (!faxType.indexOf(':') >= 0) { faxType = faxType.split(':')[1]; }
 // doc.label = patientName + " - " + faxType + " - " + MMddYYYY;
 //doc.label = patientName + " - " + faxType;
 doc.label = patientName ; //PV210104 updating label
 if (!patientName || patientName.length<5) { //ERS201129 #78830
 doc.label="Split from "+X(doc,"X_splitPages")+" of "+ X(doc,"X_fromPages") +" - "+MMddYYYY;
 doc.label="Document Indexed "+ X(doc,"X_fromPages") +" - "+MMddYYYY; //PV210626
 }
 alert("ERS170829 dbID="+doc.dbID+" label="+doc.label);
 if (zData.sfID && zData.sfID.indexOf("500")===0) {
 zData.provider = getSFField(doc, "Case", "Account.Name", null, zData.sfID);
 label = "Received from " + zData.provider;
 if (zData.facility) {
 zData.facility = getSFField(doc, "Case", "Account.Facility__r.Name", null, zData.sfID);
 doc.label+=" at "+zData.facility;
 }
}
var arrOfPairs = [];
 arrOfPairs.push("db-label", doc.label);
updateDB(doc,arrOfPairs);
 return doc.label;
};

zData.clientValue=function(doc,val) {//ERS190803 #52661 using JSON
 val=val.replace("{!formatNow}",zData.formatNow);
 return val;
}

zData.clientFields=function(doc,arrOfPairs,jd,zd) { //ERS190803 #52661 using JSON in setting to configure new record
 if (!zd) zd=zData;
if (jd && jd.indexOf("{")===0) {
 //{"Type":"Eligibility","OwnerId":"00Gc0000003vgqw","RecordTypeId":"0126A000000JEKeQAO"};
 //NOT A GOOD IDEA jd=jd.replaceAll("\"","'"); //ERS190811 #61570 HACK?
 jd=jd.replace("};","}"); //ERS201129 SHR to work out design on channel wizard for zStack child set ASAP
 try {
 var jdata=JSON.parse(jd); //ERS190805 better than eval
 for (var n in jdata) {
 var v0=jdata[n];
 var v=zData.clientValue(doc,v0); //ERS190811 ,v now ,v0
 alert("ERS190803.97 "+n+"="+v0+"="+v);
 arrOfPairs.push(n,v); //ERS190811 added .push
 zd[n]=v; //ERS201129 #78830 TODO review arrOfPairs access using for RecordTypeId
 }
 } catch (e) {
 alert("JSON not in "+jd+" Exception: "+e); //ERS190811 added e
 }
}
return arrOfPairs;
}


zData.clientCase=function(doc,arrOfPairs,label,zd) {
if (!zd) zd=zData;
if (!zd.triageType && X(doc,"X_ZPAPER__faxType__c")) zd.triageType=X(doc,"X_ZPAPER__faxType__c"); //ERS200308
if (!label) { label="Indexed-" + "-" + zd.triageType + "-" + zd.stackId;}

alert("ERS200308.128 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
alert("zData.patientContactId : " + zData.patientContactId);
//arrOfPairs.push("Custom_Procedure__c",zData.X_zPaper_Procedure_Code_1__c);//ahs - commented
//arrOfPairs.push("AccountId",zData.X_ZPAPER__PatientAccount__c);
arrOfPairs.push("Referring_Provider__c",zData.X_ZPAPER__ProviderContact__c);
arrOfPairs.push("ContactId",zData.patientContactId);
arrOfPairs.push("Primary_Payer_Name__c",zData.X_ZPAPER_Primary_Payer_Name__c); //PV210111 updated
arrOfPairs.push("Primary_Member_ID__c",zData.X_ZPAPER_Primary_Member_ID__c);
arrOfPairs.push("Secondary_Payer_Name__c",zData.X_ZPAPER_Secondary_Payer_Name__c);
arrOfPairs.push("Secondary_Member_ID__c",zData.X_ZPAPER_Secondary_Member_ID__c);
arrOfPairs.push("Source__c","Fax");
arrOfPairs.push("To_Facility_Name__c",zData.X_ZPAPER_To_Facility__c);
arrOfPairs.push("AUC_DSN__c",zData.X_zPaper_AUC_DSN__c);
arrOfPairs.push("AUC_G_Code__c",zData.X_zPaper_AUC_G_Code__c);
arrOfPairs.push("AUC_Modifier__c",zData.X_zPaper_AUC_Modifier__c);
arrOfPairs.push("AUC_Score__c",zData.X_zPaper_AUC_Score__c);
//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
//if (zd.contactId) arrOfPairs.push("ContactId", zd.contactId);
arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
arrOfPairs.push("Status", X(doc,"X_Status"));
arrOfPairs.push("ZPAPER__faxType__c",zd.triageType); //ERS200308
alert("X_ZPAPER__Priority__c : " + zData.X_ZPAPER__Priority__c);
if(zData.X_ZPAPER__Priority__c){
 arrOfPairs.push("Priority", zData.X_ZPAPER__Priority__c); //PV210119
 }
if(zData.X_Baptist_Heart_Specialist_Order__c){
 arrOfPairs.push("Baptist_Heart_Specialist_Order__c", zData.X_Baptist_Heart_Specialist_Order__c);
 }
 if(zData.X_Attestation_Included__c){
 arrOfPairs.push("Attestation_Included__c", zData.X_Attestation_Included__c);
 }
if(zData.X_Ready_for_Scheduling__c){
 arrOfPairs.push("Ready_for_Scheduling__c", zData.X_Ready_for_Scheduling__c);
 }
//ERS200205 arrOfPairs.push("Type", "New "+zd.classification); //JPB 170512 added these workflow fields
//ERS200308 arrOfPairs.push("Type", "New "+zd.docType);
if (1==1) { //ERS170523 #37162 after dryrun
 alert("@@@ zd.priority => *" + zd.priority + "*");
//arrOfPairs.push("RecordTypeId","012Q00000005Ahj"); //ERS170523 Prior Auth
//if (zd.priority != "Stat") { arrOfPairs.push("Priority",zd.priority); } //ERS170524 #37162 priority on Case
//else { arrOfPairs.push("Priority","Routine"); } //PV211901
arrOfPairs.push("Origin","Fax"); //ERSa200205 rrOfPairs.push("Origin",zd.channel);
}
 arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__CaseFields__c")); //ERS190803 #52661 using JSON
 
 alert("ERS200308.143 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
 //ahs - commented start - to fix overwriting contact/account
 //if (zd.providerId && zd.providerId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.providerId); } //ERS200308
 //if (zd.providerId && zd.providerId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.providerId); } //ERS200308
 //if (zd.patientId && zd.patientId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.patientId); } //ERS200308
 //if (zd.patientId && zd.patientId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.patientId); } //ERS200308
 //ahs - commented end - to fix overwriting contact/account
 //if (zd.zchannel.owner) { arrOfPairs.push("OwnerId", zData.zchannel.owner); } //ERS200308 PV210102 commented we are not using queue on case
 
 if(X(doc,"db-comments"))
    arrOfPairs.push("Order_Notes__c",X(doc,"db-comments"));
 
var caseId = createAndAttach(doc, "Case", label, arrOfPairs);
return caseId;
};

zData.clientPatient=function(doc,arrOfPairs,label,zd) {
if (!zd) zd=zData;
if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
if (zd.patientId) { //ERS200205 #68825 Program Members
 alert("Patient already exists in "+zd.patientId);
 return zd.patientId; //TOOD get from X_patientId ????
}
//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
var p="ZPAPER__"; //ERS200202 assume workflow on related record types
if (zData.patientType.indexOf("__c") > -1) { p=""; } //ERS200203 typo
if (1==0) { //ERS200202 see if workflow enabled
 arrOfPairs.push(p+"newFax__c", "true"); //JPB 170512 added these workflow fields
 arrOfPairs.push(p+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
 arrOfPairs.push(p+"receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
}

 var rt=XCustomSetting(doc,"PatientRecordType__c"); //TODO into MP ERS190802 like 0126A000000JE8yQAG or empty to use default
 //if (rt) { arrOfPairs.push("RecordTypeId", rt); } //ERS190803
 //TODO Contact or Account ERS190624 DONE!! ERS190802
 arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__PatientFields__c")); //ERS190803 #52661 using JSON
 alert("arrOfPairs : " + arrOfPairs);
 alert("patientfields custom setting : " + XCustomSetting(doc,"ZPAPER__PatientFields__c"));
 arrOfPairs=[]; //ERS200204 testing to get it going
 
 //ERS200202 need to make the Account with Patient recordType first
 //01246000000NGFYAA4 is .zpaper for Patient
 //alert("@@** account rt val : " + rt);
 var ar = [];
 //if (rt) { ar.push("RecordTypeId", rt); } //ERS190803 //ERS200222 #69149 moved down and added else
 //else { ar.push("RecordTypeId","01261000000QgmTAAS"); alert("@@@ Error record type is not picked up from custom setting") }
 ar.push("FirstName",zData.X_ZPAPER__FirstName__c);
 ar.push("LastName",zData.X_ZPAPER__LastName__c);
 ar.push("PersonHomePhone", zData.X_ZPAPER__Phone__c);
 alert("X_HealthCloudGA__Gender__pc===" + zData.X_HealthCloudGA__Gender__pc);
 alert("Gender__c===" + zData.X_Gender__c);
 if(zData.X_Gender__c){
 //ar.push("HealthCloudGA__Gender__pc",zData.X_Gender__c ); //PV210402 added
   ar.push("HealthCloudGA__Gender__pc",zData.X_Gender__c );
 } //PV210402 added
 if(zData.X_Gender__c){
   ar.push("Gender__pc",zData.X_Gender__c );
 }
 var patientName=zData.X_ZPAPER__LastName__c+", "+zData.X_ZPAPER__FirstName__c;
 ar=zData.clientFields(doc,ar,XCustomSetting(doc,"ZPAPER__PatientFields__c")); //PV201229 added to pass value from Custom settings
 if (zData.X_ZPAPER__Birthdate__c) ar.push("PersonBirthDate",zData.X_ZPAPER__Birthdate__c);
 //if (zData.X_ZPAPER__Phone__c) ar.push("PersonPhone",zData.X_ZPAPER__Phone__c); //PV210111 added phone
 alert("@@ar : " + ar);
 var aId = createSFRecord(doc, "Account", null, ar); //ERS200204 person account so do not set patientName
 
 if (aId && aId != "NEW" && aId.indexOf("ERROR")==-1) {
 var sfId = "";
 
 //ERS190803 specific to client data entry
 var dq = zData.dq;
 addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c" + dq + ").val(" + dq + sfId + dq + "); ");
 addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
 return aId; //PV201229 to create Personaccount
 }
 return {'ERROR': 'patient not created'}
};

zData.clientAccount=function(doc,arrOfPairs,label,zd) {
if (!zd) zd=zData;
if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields

var accountId = createAndAttach(doc, "Account", label, arrOfPairs);
return accountId;
};

zData.clientRecord=function(doc,sfType,arrOfPairs,label,zd) { //ERS190620 clientRecord generic
if (!zd) zd=zData;
if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
var zp="";
if (",Case,Contact,Account,Lead,Opportunity,ZPAPER__zStack__c,".toLowerCase().indexOf(","+sfType.toLowerCase()+",")>-1) zp=zData.zp;
//only do this if the fields exist
arrOfPairs.push(zp+"newFax__c", "true"); //JPB 170512 added these workflow fields
arrOfPairs.push(zp+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
arrOfPairs.push(zp+"receivedId__c", doc.dbID); //JPB 170512 added these workflow fields

//TODO put client specific data updates here

var newId = createAndAttach(doc, sfType, label, arrOfPairs);
return newId;
};

zData.clientComplete=function(doc,arrOfPairs,zd) {return arrOfPairs;}; //ERS190625
zData.clientDelivery=function(doc,arrOfPairs) { //ERS200202 TODO consider new Document_MVN
 return arrOfPairs;
}; //ERS190711 #60900 PAOS

zData.clientChildStack=function(doc,arrOfPairs,parentId) { //ERS190810 #61570 be sure to call on new child doc
 if(zData.X_ZPAPER__Priority__c && zData.X_ZPAPER__Priority__c != "DONOT_SAVE") arrOfPairs.push("ZPAPER__Priority__c", zData.X_ZPAPER__Priority__c);
 if(zData.X_ZPAPER_To_Facility__c && zData.X_ZPAPER_To_Facility__c != "DONOT_SAVE") arrOfPairs.push("ZPAPER_To_Facility__c", zData.X_ZPAPER_To_Facility__c);
 
 if(zData.X_ZPAPER_Primary_Payer_Name__c && zData.X_ZPAPER_Primary_Payer_Name__c != "DONOT_SAVE") arrOfPairs.push("ZPAPER_Primary_Payer_Name__c", zData.X_ZPAPER_Primary_Payer_Name__c);
 if(zData.X_ZPAPER_Primary_Member_ID__c) arrOfPairs.push("ZPAPER_Primary_Member_ID__c", zData.X_ZPAPER_Primary_Member_ID__c);
 
 if(zData.X_ZPAPER_Secondary_Payer_Name__c && zData.X_ZPAPER_Secondary_Payer_Name__c != "DONOT_SAVE") arrOfPairs.push("ZPAPER_Secondary_Payer_Name__c", zData.X_ZPAPER_Secondary_Payer_Name__c);
 if(zData.X_ZPAPER_Secondary_Member_ID__c) arrOfPairs.push("ZPAPER_Secondary_Member_ID__c", zData.X_ZPAPER_Secondary_Member_ID__c);
 
 if(zData.X_ZPAPER_Provider_Phone__c){
 arrOfPairs.push("ZPAPER_Provider_Phone__c", zData.X_ZPAPER_Provider_Phone__c); //PV210112
 }
 if(zData.X_ZPAPER_Provider_First_Name__c){
 arrOfPairs.push("ZPAPER_Provider_First_Name__c", zData.X_ZPAPER_Provider_First_Name__c); //PV210112
 }
 if(zData.X_ZPAPER_Provider_Last_Name__c){
 arrOfPairs.push("ZPAPER_Provider_Last_Name__c", zData.X_ZPAPER_Provider_Last_Name__c); //PV210112
 }
 if(zData.X_ZPAPER__NPI__c){
 arrOfPairs.push("ZPAPER__NPI__c", zData.X_ZPAPER__NPI__c); //PV210112
 }
 if(zData.X_ZPAPER__Priority__c){
 arrOfPairs.push("ZPAPER__Priority__c", zData.X_ZPAPER__Priority__c); //PV210119
 }
 if(zData.X_zPaper_Reason_for_Visit__c) arrOfPairs.push("zPaper_Reason_for_Visit__c", zData.X_zPaper_Reason_for_Visit__c); //PV210104
 if(zData.X_Baptist_Heart_Specialist_Order__c) arrOfPairs.push("Baptist_Heart_Specialist_Order__c", zData.X_Baptist_Heart_Specialist_Order__c);
 if(zData.X_Attestation_Included__c) arrOfPairs.push("Attestation_Included__c", zData.X_Attestation_Included__c); //PV211220
 if(zData.X_Ready_for_Scheduling__c) arrOfPairs.push("Ready_for_Scheduling__c", zData.X_Ready_for_Scheduling__c);
 
 if(zData.X_zPaper_AUC_DSN__c)arrOfPairs.push("zPaper_AUC_DSN__c",zData.X_zPaper_AUC_DSN__c);
 if(zData.X_zPaper_AUC_G_Code__c)arrOfPairs.push("zPaper_AUC_G_Code__c",zData.X_zPaper_AUC_G_Code__c);
 if(zData.X_zPaper_AUC_Modifier__c)arrOfPairs.push("zPaper_AUC_Modifier__c",zData.X_zPaper_AUC_Modifier__c);
 if(zData.X_zPaper_AUC_Score__c)arrOfPairs.push("zPaper_AUC_Score__c",zData.X_zPaper_AUC_Score__c);
 //if(zData.X_Case_Notes__c)arrOfPairs.push("Case_Notes__c",zData.X_Case_Notes__c);
 
 var pairs=arrOfPairs;
 //no memory of stack creation var pairs=zData.stackPairs;
 //CRN201026 #76788 We need reviewedStatus to be "Indexed" for the index rule, so only set the field if it isn't already set.
 if (!zData.reviewedStatus) { zData.reviewedStatus="Split"; }
 //pairs.push("ZPAPER__Status__c", "Child Stack"); //ERS190810 TODO? //PV210201
 alert("debug pairs : " + pairs);
 
 pairs=zData.clientStack(doc,pairs);
 if (XCustomSetting(doc,"ZPAPER__zChildFields__c")) { //ERS190811 not in all MPs
 pairs=zData.clientFields(doc,pairs,XCustomSetting(doc,"ZPAPER__zChildFields__c")); //ERS190803 #52661 using JSON child record type id
 }
 alert("debug pairs : " + pairs);
 pairs.push("ZPAPER__Parent__c", parentId);
 //ERS201128 should be in zChildFields if (zData.childStackRecordType) pairs.push("RecordTypeId",zData.childStackRecordType);
 
 pairs.push(zData.zp+"Program__c",zData.programName); //ERS200205 TODO in package and into base call //PV201229 added zp
 //ERS200229 if (zData.patientId) pairs.push("Program_Member_MVN__c",zData.patientId); //ERS200205 Program_Member_MVN__c was the TICKET!!!
 alert("ERS190811.191 ZPAPER__Parent__c"+ parentId+" child zData.childStackRecordType="+zData.childStackRecordType);
 alert("debug pairs : " + pairs);
if (!zData.docType && !X(doc,"X_ZPAPER__faxType__c")) { //PV210318
	zData.docType=getSFField(doc, "ZPAPER__zStack__c", "ZPAPER__faxType__c", null, parentId);
	pairs.push("ZPAPER__faxType__c", zData.docType);
 }
 if (zData['RecordTypeId']) { zData.childStackRecordType=zData['RecordTypeId']; } //ERS201129 #78830 TODO not sure where this is used elsewhere
 alert("ERS201129.292 ZPAPER__Parent__c"+ parentId+" child RecordTypeId="+zData['RecordTypeId']);
 var childStackSFId = createAndAttach(doc, "ZPAPER__zStack__c", "zStack "+zData.reviewedStatus+" on " + zData.formatNow, pairs) + ""; // PV210208 "zStack split on " 
 
 if (!zData.patientId && X(doc,"X_ZPAPER__PatientAccount__c") ){ //ERS200308 HACK
 zData.patientId=X(doc,"X_ZPAPER__PatientAccount__c");
 alert("ERS200308 WHY NOT in zData?");
 }
 if (zData.patientId) { //ERS200308 create an Activity Event related to the Patient (Account) for the Timeline
 if (!zData.docType && X(doc,"X_ZPAPER__faxType__c")) zData.docType=X(doc,"X_ZPAPER__faxType__c");
 var arr=[];
 //NOT SELECT AccountId,ActivityDate,CreatedDate,Status,Subject,TaskSubtype,WhatId,WhoId FROM Task where ActivityDate > 2020-02-01
 //SELECT Id,AccountId,ActivityDate,CreatedDate,Subject,WhatId,WhoId FROM Event where Id = '00U4T000002vChrUAE'
 //arr.push("WhoId",zData.patientId); //ERS200310 timeline trick
 if (zData.patientId.indexOf("001")==0) {
 arr.push("WhatId",zData.patientId); //ERS200310 timeline trick
 //arr.push("AccountId",zData.patientId); //ERS200310 timeline trick
 } else if (zData.caseId) arr.push("WhatId",zData.caseId);
 else if (zData.providerId) arr.push("WhatId",zData.providerId);
 else arr.push("WhatId",childStackSFId);
 //arr.push("TaskSubtype","Task");
 arr.push("Subject",zData.stage + " "+zData.docType);
 arr.push("Description","Check out "+doc.dbID);
 //arr.push("ActivityDateTime",zData.formatNow); //ERS200309 hacking away!
 arr.push("ActivityDate",zData.formatNow.substring(0,10));
 //arr.push("RecordTypeId","01261000000j3PaAAI"); //ERS200310 HACK for Task on CarePlan //PV200218 updated record type idof TASK
  
 if (XCustomSetting(doc,"TaskFields__c")) { //ERS190811 not in all MPs
 arr=zData.clientFields(doc,arr,XCustomSetting(doc,"TaskFields__c")); //ERS190803 #52661 using JSON child record type id
 }
 //arr.push("DurationInMinutes","5");
 //arr.push("Status","Completed");
 
 var label="Timeline "+zData.docType;
 //var actId = createSFRecord(doc, "Task", null, arr); //ERS200309 null means no Name field //PV201229 we don't need to create atsk
 //var actId = createSFRecord(doc, "Event", null, arr); //ERS200309 null means no Name field
 //alert("ERS200308.262 timeline activity "+actId);
 } else { alert("ERS200308.263 be worried there is no patient!"); }
 if (1===1 && zData.clientReceivedDocument) { zData.recDocId=zData.clientReceivedDocument(doc,childStackSFId); } //ERS201018 #77252
 return childStackSFId;
};


zData.updateStackIdOnCases=function(caseIds, stackId) {
    alert("@caseIds" + caseIds);
    alert("@stackId" + stackId);
    var zStckIdOnCase = "";
	if(!caseIds)
		caseIds = [];
	if(caseIds.indexOf(zData.caseId) == -1 && zData.caseId) {
	    caseIds.push(zData.caseId);
	    zStckIdOnCase = getSFField(doc, "case", "zStack__c", null, zData.caseId);//PV211006 //PV211130
	}

	for(var i = 0; i < caseIds.length; i++) {
	    if (!zStckIdOnCase){
	        var caseArrOfPairs = [];
		    caseArrOfPairs.push("zStack__c", stackId);
		    updateSFRecord(doc, "case", caseIds[i], caseArrOfPairs); //PV220110
	    }
	}
}
zData.clientStackComplete=function(doc,arrOfPairs,zd) { //ERS200314 #70336
 if (!zd) zd=zData; //ERS200406 #71156
 arrOfPairs.push("Time_Complete_Date__c",zd.formatNow); //for dashboard
 return arrOfPairs;
}; //ERS190625

zData.clientCasesForProcedureCode=function(doc,arrOfPairs) {
    zData.attachPathIds = "";//store reference to ids that are to be added to attachPath
    //PV210102 data entry pannel 2
    var Diagnosis_Code__c="";
    if(zData.X_ZPAPER_Diagnosis_Code_1__c){
    	arrOfPairs.push("ZPAPER_Diagnosis_Code_1__c", zData.X_ZPAPER_Diagnosis_Code_1__c);
    	healthCareDiagnosis = getSFField(doc, "HealthCareDiagnosis", "Code", null, zData.X_ZPAPER_Diagnosis_Code_1__c);
    	Diagnosis_Code__c+=healthCareDiagnosis +  ","; //PV210112 updated Name to Code
    }
    
    if(zData.X_ZPAPER_Diagnosis_Code_2__c) {
    	arrOfPairs.push("ZPAPER_Diagnosis_Code_2__c", zData.X_ZPAPER_Diagnosis_Code_2__c);
    	healthCareDiagnosis = getSFField(doc, "HealthCareDiagnosis", "Code", null, zData.X_ZPAPER_Diagnosis_Code_2__c);
    	Diagnosis_Code__c+= healthCareDiagnosis +  ","; //PV210112 updated Name to Code
    }
    if(zData.X_ZPAPER_Diagnosis_Code_3__c) {
    	arrOfPairs.push("ZPAPER_Diagnosis_Code_3__c", zData.X_ZPAPER_Diagnosis_Code_3__c);
    	healthCareDiagnosis = getSFField(doc, "HealthCareDiagnosis", "Code", null, zData.X_ZPAPER_Diagnosis_Code_3__c);
    	Diagnosis_Code__c+= healthCareDiagnosis +  ","; //PV210112 updated Name to Code
    }
    
    var caseIds = [];
    arrOfPairsCase=[];
    arrOfPairsCase.push("Diagnosis_Code__c",Diagnosis_Code__c);
    //var sfStackId=zData.getStackId(doc);
    //arrOfPairsCase.push("zStack__c",sfStackId); //PV211202
    if(zData.patientId)
        zData.patientContactId=getSFField(doc, 'Contact', 'Id', 'AccountId=\'' + zData.patientId + '\'', null);
    //alert("patient contact id : " + zData.patientContactId); //PV210126 commented
    if(zData.X_zPaper_Procedure_Code_1__c){
        arrOfPairs.push("zPaper_Procedure_Code_1__c", zData.X_zPaper_Procedure_Code_1__c);
        arrOfPairsCase.push("Custom_Procedure__c",zData.X_zPaper_Procedure_Code_1__c);
        var caseId = zData.clientCase(doc,arrOfPairsCase);
        zData.attachPathIds+=","+caseId;
        caseIds.push(caseId);
        arrOfPairs.push("Case1__c", caseId); //PV210119 added to update caselookup field on zstack
       
    }
    if(zData.X_zPaper_Procedure_Code_2__c){
        arrOfPairs.push("zPaper_Procedure_Code_2__c", zData.X_zPaper_Procedure_Code_2__c);
        arrOfPairsCase.push("Custom_Procedure__c",zData.X_zPaper_Procedure_Code_2__c);
        var caseId = zData.clientCase(doc,arrOfPairsCase); //PV210105 for attchment on docset
        zData.attachPathIds+=","+caseId;
        caseIds.push(caseId);
        arrOfPairs.push("Case2__c", caseId);
    }
    if(zData.X_zPaper_Procedure_Code_3__c) {
        arrOfPairs.push("zPaper_Procedure_Code_3__c", zData.X_zPaper_Procedure_Code_3__c);
        arrOfPairsCase.push("Custom_Procedure__c",zData.X_zPaper_Procedure_Code_3__c);
        var caseId =zData.clientCase(doc,arrOfPairsCase);
        zData.attachPathIds+=","+caseId;
        caseIds.push(caseId);
        arrOfPairs.push("Case3__c", caseId);
    }
    //PV210119 added case creation logic if there is no procedure code
    //if(zData.X_ZPAPER__Priority__c && !zData.X_zPaper_Procedure_Code_1__c && !zData.X_zPaper_Procedure_Code_2__c && !zData.X_zPaper_Procedure_Code_3__c  ){
    if(!zData.caseId && zData.X_ZPAPER__Priority__c && !zData.X_zPaper_Procedure_Code_1__c && !zData.X_zPaper_Procedure_Code_2__c && !zData.X_zPaper_Procedure_Code_3__c  ){
        var caseId =zData.clientCase(doc,arrOfPairsCase);
        zData.attachPathIds+=","+caseId;
        caseIds.push(caseId);
        arrOfPairs.push("ZPAPER__Case__c", caseId);
    }
    
    zData.caseIds = caseIds;
};

zData.clientProvider=function(doc, arrOfPairs) {
    //label will be auto populated
    alert("debugging provider data : ");
    alert("zData.X_ZPAPER_Provider_First_Name__c : " + zData.X_ZPAPER_Provider_First_Name__c + "; ZPAPER_Provider_First_Name__c : " + zData.ZPAPER_Provider_First_Name__c);
    alert("zData.X_ZPAPER_Provider_Last_Name__c : " + zData.X_ZPAPER_Provider_Last_Name__c + "; ZPAPER_Provider_Last_Name__c : " + zData.ZPAPER_Provider_Last_Name__c);
    alert("zData.X_ZPAPER_Provider_Phone__c : " + zData.X_ZPAPER_Provider_Phone__c + "; ZPAPER_Provider_Phone__c : " + zData.ZPAPER_Provider_Phone__c);
    alert("zData.X_ZPAPER__NPI__c : " + zData.X_ZPAPER__NPI__c + "; ZPAPER__NPI__c : " + zData.ZPAPER__NPI__c);

    arrOfPairs.push("FirstName", zData.X_ZPAPER_Provider_First_Name__c);
    arrOfPairs.push("LastName", zData.X_ZPAPER_Provider_Last_Name__c);
    arrOfPairs.push("Phone", zData.X_ZPAPER_Provider_Phone__c);
    arrOfPairs.push("NPI__c", zData.X_ZPAPER__NPI__c);

    var providerFields = XCustomSetting(doc,"zPaper_ProviderFields__c");
    alert("providerFields - " + providerFields);
    
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"zPaper_ProviderFields__c"));
    alert("arrOfPairs : " + arrOfPairs);
    
    zData.providerId = zData.clientRecord(doc,zData.providerType, arrOfPairs, '', zData);
    providerName =zData.X_ZPAPER_Provider_First_Name__c+" "+zData.X_ZPAPER_Provider_Last_Name__c; //PV201229 added this to show newly created contact on lookup
    var dq = zData.dq = String.fromCharCode(34);
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__ProviderContact__c" + dq + ").val(" + dq + zData.providerId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__ProviderContact__c_Name" + dq + ").val(" + dq + providerName + dq + "); ");
};



zData.clientLightningFile=function(doc,sfIds,zd) {
	if (!zd) zd = zData;
	if (!doc.kbData.sfServer) {
		//ERS200428 HACK
		alert("doc.kbData.sfServer was empty. Ideally should NOT come here");
		doc.kbData.sfServer = "takedapatientservices--tkdev2.lightning.force.com";
	}
	var zserver = doc.kbData.sfServer.indexOf("https://") == 0 ? doc.kbData.sfServer : "https://" + doc.kbData.sfServer;
	// Salesforce REST API endpoint
	var docurl = zserver + "/services/data/v46.0/sobjects/ContentVersion/";
	var pdfurl = "https://gw.zpaper.com/kb/jsp/SF_find.lightning.jsp?go=SF_files.jsp&dbID=" + doc.dbID + "&SForg=" + doc.kbData.sfOrganizationID;

	// Generate PDF file from zStack
	var formatNow = getCurDateAndTime(doc, false, true); // e.g. "20210210-052132"?
	var arrOfPairs = [];
	var nowTimeStamp = new Date().getTime() + "";
    //var fileName = !accname && !faxtype ? doc.label : accname + " - " + faxtype + " - " + datestr;
    var accname = X(doc, "X_ZPAPER__PatientAccount__r.Name");
    var faxtype = X(doc, "X_ZPAPER__faxType__c");
    var datestr = getCurDate(doc);
    if(!faxtype)//PV210318
	 faxtype = zData.docType; //PV210318 added it for to update doctype on Lightning files
	 if(!accname)
		accname = X(doc, "X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c"); //PV210318
		
    var fileName = !accname && !faxtype ? doc.label : accname + " - " + faxtype + " - " + datestr;
    fileName += ".pdf";
	//var fileName = getCurDate(doc) + " New Fax.pdf"; // e.g - "20210210 New Fax.pdf"?
	alert("@@@fileName = " + fileName);

	zData.uploadDir = 'zStackUploadRoot'; //setting root directory for file creation

	// create directory to place generated PDF file
	createDirectory(doc, zData.uploadDir, nowTimeStamp);

	var xPages = X(doc, "X_position"); //get X_position - page range selected; default = all pages
	alert("@@@@@ Calling splitPDF to split off pages to upload as PDF, pages = " + xPages + ", nowTimeStamp = " + nowTimeStamp);
	var response = splitPDF(doc, xPages, zData.uploadDir, nowTimeStamp, fileName);
	alert("@@@@ response from splitPDF = " + response);
	var newPDFName = X(doc, "newPDF", response); // set value of newPDF

	alert("@@@@ split PDF FileName = " + newPDFName);

	// Cannot directly Append PDF file to multipart formdata
	// JS does not allow reading a file from the file system (normally applies to client side for security reasons)
	// We dont have a Node.js container, so no luck there.. have to do this another way
	// Eric suggested we use uploadToCloud.jsp approach to create Lightning File (probably ContentDocument) in Salesforce

	//var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid=" + sfIds[0] + "&SForg=" + doc.kbData.sfOrganizationID + "&label=" + fileName + "&serverFile=" + newPDFName + "&Description=File attached as PDF";//PV210423 updated URL
     var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid=" + sfIds[0] + "&SFServer=" + doc.kbData.sfServer + "&SFSession=" + doc.kbData.sfSessionID + "&label=" + fileName + "&serverFile=" + newPDFName + "&Description=File attached as PDF";//PV210511 updated URL
	alert("#### Upload native PDF with " + uploadURL);

	var r = wget(doc, uploadURL); // ????? will r contain the ContentDocument id?

	alert('value from wget response >>> ' + r);

	var idxBegin = r.indexOf("<sfID>");
	var idxEnd = r.indexOf("</sfID>");
	var sfdocId;
	if (idxEnd > idxBegin) {
		sfdocId = r.substring(idxBegin + 6, idxEnd);
		alert("sfDocId extracted from r : " + sfdocId);
	}

	// Finally, delete the folder and all contents.
	cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);
	
	var headers = [
        "Authorization", "Bearer " + doc.kbData.sfSessionID,
        "Content-Type", "application/json"
    ];
	docurl = zserver + '/services/data/v49.0/sobjects/ContentDocumentLink/';
	for (var index = 1; index < sfIds.length; index++) {
	    //sharing files with other records
        try {
            var currentContentDocumentLinkRecord = {
                "ContentDocumentId": sfdocId,
                "LinkedEntityId": sfIds[index],
                "ShareType": "I"
            };
            body = JSON.stringify(currentContentDocumentLinkRecord);
            res = wpost(doc, docurl, [], headers, body);
        } catch (errs) {
            alert(errs);
        }
    }
	
	return null;
}

zData.clientUpdateCase=function(doc,sfId,zd) {
    var existingCaseNotes = getSFField(doc, "Case", "Order_Notes__c", null, sfId);
    if(existingCaseNotes) {
        existingCaseNotes += '\\n';
    } else {
        existingCaseNotes = "";
    }
    
    if(X(doc,"db-comments")) {
        var newCaseNotes = existingCaseNotes + X(doc,"db-comments");
        var arrOfPairs = ["Order_Notes__c", newCaseNotes];
        updateSFRecord(doc, "Case", sfId, arrOfPairs);
    }
}
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
//--- RULE VALIDATION CODE - END ---

</script>
