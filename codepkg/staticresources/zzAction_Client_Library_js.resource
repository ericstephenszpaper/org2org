<!--
// Name: Client Library
// Committer: Prathyusha.vasireddy@zpaper.com
// Update: PV230203 updating for testing
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2023-02-03 15:06:14","evalContinue":"true","active":true,"button":"","name":"Client Library","conditions":{"logic":"and","arguments":[{"name":"doc.status","value":"DoNotClient","operation":"not-contains"}]},"consequence":{"doit":"YWxlcnQoInN0YXJ0IGNsaWVudCBsaWJyYXJ5Iik7IC8vRVJTMTkwODAzICM1MjY2MSBmcm9tIE9jY0ZpdC8vUFYyMzAyMDMgdXBkYXRpbmcgZm9yIHRlc3RpbmcKLy9FUlMyMDExMTcgVE9ETyBnZXQgcmlkIG9mZiB0aGVzZSBrZXl3b3JkcyBhbmQgdXNlIGEgZG9jdW1lbnQgam91cm5leSB3aXphcmQgZnJvbSBLUFMgYW5kIEpha2UKCi8vQ1JOMjAxMDI1ICM3Njc4OCBNb3ZlZCBmcm9tIHpTdGFjayBMaWJyYXJ5IHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgaW4gbXVsdGlwbGUgcnVsZXMuCnZhciBrZXl3b3JkTWFwPXt9Owp2YXIga2V5d29yZHM9WyJORVc6RG9jdW1lbnQgU3RhY2t+IiwiRU5STDpFbnJvbGxtZW50fiIsIkVOUkw6RU5ST0xMTUVOVH4iLCJDT046Q29uc2VudH4iLCJDT046Y29uc2VudH4iLCJGQUM6U2V0dGluZ34iLCJGQUM6RGlzdHJpYnV0aW9ufiIsIlNUQVJUOlN0YXJ0IEZvcm1+IiwiQ0hLOkNoZWNrbGlzdH4iLCJISVBBQTpBVVRIT1JJWkFUSU9OfiIsIkhJUEFBOkhJUEFBfiIsIkhJUEFBOlBPUlRBQklMSVRZfiIsIlJFRjpSRUZFUlJBTCIsIlJFRjpSZWZlcnJhbCIsIkZJTjpXMn4iLCJJQzpNZW1iZXIgSUR+IiwiRkFYOiJdOwovL2tleXdvcmRNYXBbIlRFTlIiXSA9IlRFTlI6U3RhcnQgRm9ybSI7CmtleXdvcmRNYXBbIk5FVyJdID0iTkVXOkRvY3VtZW50IFN0YWNrIjsKa2V5d29yZE1hcFsiRU5STCJdID0iRU5STDpFbnJvbGxtZW50IEZvcm0iOwprZXl3b3JkTWFwWyJGQUMiXSA9IkZBQzpGYWNpbGl0eSBFbnJvbGxtZW50IEZvcm0iOwprZXl3b3JkTWFwWyJGQVgiXSA9Ik5FVzpEb2N1bWVudCBTdGFjayI7Ci8va2V5d29yZE1hcFsiU1RBUlQiXSA9Ik5FVzpEb2N1bWVudCBTdGFjayI7CmtleXdvcmRNYXBbIkNPTiJdID0iQ09OOkNvbnNlbnQgRm9ybSI7CmtleXdvcmRNYXBbIkhJUEFBIl0gPSJISVBBQTpISVBBQSBBdXRob3JpemF0aW9uIjsKa2V5d29yZE1hcFsiUkVGIl0gPSJSRUY6UmVmZXJyYWwiOwprZXl3b3JkTWFwWyJGVzIiXSA9IkZXMjpXLTIiOyAvL0pQQjIwMTAyMyBhZGRlZAprZXl3b3JkTWFwWyJJOSJdID0iSTk6SS05IjsgLy9KUEIyMDEwMjMgYWRkZWQKa2V5d29yZE1hcFsiVzQiXSA9Ilc0OlctNCI7IC8vSlBCMjAxMDIzIGFkZGVkCmtleXdvcmRNYXBbIkRFTSJdID0iREVNOkRlbW9ncmFwaGljcyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIkNMSU4iXSA9IkNMSU46Q2xpbmljYWwgTm90ZXMiOyAvL0NSTjIwMTAyNiBhZGRlZAprZXl3b3JkTWFwWyJGSU4iXSA9IkZJTjpGaW5hbmNpYWwgSW5mbyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIklDIl0gPSJJQzpJbnN1cmFuY2UgQ2FyZCI7IC8vQ1JOMjAxMDI2IGFkZGVkCgp6RGF0YS5tYXhDaGFubmVscz0zOyAvL0VSUzE5MDczMSAjNjEyNzIgemlwcGkgaXMgc3Ryb25nbHkgdHlwZWQKekRhdGEubWFrZVN0YWNrPXRydWU7IC8vRVJTMTkwODE0ICM2MTUxMQoKekRhdGEud2F0ZXJtYXJrPSIiK1hDdXN0b21TZXR0aW5nKGRvYywid2F0ZXJtYXJrX19jIik7IC8vRVJTMTkwNjE4IGJlc3QgcHJhY3RpY2UKLy9hbGVydCgiRVJTMTkwNDExIHdtPSIrekRhdGEud2F0ZXJtYXJrKyIgWlBBUEVSX19zZXJ2ZXJfX2M9IitYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fc2VydmVyX19jIikpOwp6RGF0YS51cGxvYWREaXIgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInVwbG9hZERpcl9fYyIpOyAvLyJhbGtlcm1lc1Jvb3QiOwp6RGF0YS5wYXRFbnJvbGxRdWV1ZUlkID0gIiIrWEN1c3RvbVNldHRpbmcoZG9jLCJwYXRpZW50UXVldWVJZF9fYyIpOyAvLycwMEc0QzAwMDAwMExrbVonOyAvL2luc2VydCB0aGUgUXVldWUgSUQgb2YgdGhlIGRlc2lyZWQgb3duZXJzaGlwIHF1ZXVlLiBVcGRhdGUgd2hlbiBtaWdyYXRpbmcgYmV0d2VlbiBlbnZpcm9ubWVudHMuIE5lZWQgdG8gYWRkIHRoaXMgcXVldWUgaW4gU2V0dXAKekRhdGEucmVjVHlwZVJlcXVlc3QgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInJlY1R5cGVSZXF1ZXN0X19jIik7IC8vJzAxMjRDMDAwMDAwQ2o1WSc7IC8vSUQgb2YgdGhlIENhc2UgUmVjb3JkIFR5cGUgUmVxdWVzdF9QU19NVk4KLy9UT0RPIHpEYXRhLmtleXdvcmRNYXBbIkVOUkwiXSA9IkVOUkw6RW5yb2xsbWVudCBGb3JtIjsgIC8vVE9ETyBnZXQgZnJvbSB6U3RhY2sgcGlja2xpc3RzCi8vVE9ETyB6RGF0YS5rZXl3b3JkTWFwWyJGQUMiXSA9IkZBQzpGYWNpbGl0eSBFbnJvbGxtZW50IEZvcm0iOwovL0VSUzIwMDIwNSBkZWxldGVkIGRlbW8gZGF0YSAtIGRvIHdpdGggY3VzdG9tIHNldHRpbmdzCgp2YXIgY3M9WERlcGxveW1lbnRJbmZvKGRvYywgIkJ1c2luZXNzX1Byb2Nlc3NfX2MiKTsgLy9FUlMyMDAyMjIgbmVlZCBib3RoIGRlcGxveW1lbnQgaW5mbyBhbmQgY3MKLy9hbGVydCgiY3M9Iitjcyk7CmlmIChjcykgewogICAgaWYgKGNzLmluZGV4T2YoInpDdXN0b21TZXR0aW5ncyIpPi0xKSBjcz1YKGRvYywiekN1c3RvbVNldHRpbmdzIixjcyk7CiAgICBhbGVydCgiRVJTMjAwMjI1IEVWQUwgb24gIitjcyk7CiAgICBpZiAoY3MgIT09ICIiKSBldmFsKCIiK2NzKTsgLy9FUlMyMDAyMjIgVE9ETyBKU09OLnBhcnNlKCkgLy9FUlMyMDAyMjUgYmVlZHMgdG8gYmUgZXZhbCBidXQgYWxzbyBuZWVkcyB0byB3b3JrISEhCiAgICBhbGVydCgiTm8gdHJ5IGp1c3QgZG8hIik7Cn0KCmlmICgxPT09MCAmJiAhekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGUpIHsgLy9UT0RPIGN1c3RvbSBzZXR0aW5nIG9yIGRlcGxveW1lbnQ/IC8vRVJTMjAxMTI5IERPTkUgaW4gekNoaWxkRmllbGRzCiAgICBhbGVydCgiRVJTMjAxMTI4IHNob3VsZCBiZSBpbiBjdXN0b20gc2V0dGluZ3MgekNoaWxkRmllbGRzIik7CiAgICB6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZT0iMDEyMTEwMDAwMDFnQnMzQUFFIjsgLy9FUlMyMDExMjggc2hvdWxkIGJlIGluIGN1c3RvbSBzZXR0aW5ncyB6Q2hpbGRGaWVsZHMgIjAxMjBSMDAwMDAxTjJvSSI7Cn0KCnpEYXRhLmNsaWVudEltcG9ydFNPUUw9ZnVuY3Rpb24oZG9jLGZyb21GaWxlKSB7IC8vRVJTMTkwNzA2IGN1c3RvbWl6ZSBpbXBvcnRzIHVzZWQgYnkgQ3JlYXRlIFN0YWNrCiAgICB6RGF0YS5pbXBvcnRlcj1YQ3VzdG9tU2V0dGluZyhkb2MsekRhdGEuenArIkltcG9ydGVyX19jIikudHJpbSgpOwogICAgdmFyIHNmSWQ9IiI7CiAgICB2YXIgcGFydHM9ZnJvbUZpbGUuc3BsaXQoIl8iKTsKICAgIC8vc2ZJZCA9IGdldFNGUmVjb3JkSUQoZG9jLCAiQWNjb3VudCIsIHsgIkZheCIgOiBwYXJ0c1szXSB9ICk7CiAgICB6RGF0YS5tYWtlU3RhY2s9dHJ1ZTsgLy9kbyBhbGwgdGhlIHdvcmsgdGhlcmUgYnkgZGVmYXVsdAogICAgcmV0dXJuIHNmSWQ7Cn07CgovL2FsZXJ0KCJ6RGF0YS5jbGllbnRTdGFjayIpOwp6RGF0YS5jbGllbnRTdGFjaz1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycykgeyAvL3pEYXRhIG9yIHRoaXM/CiAgICB2YXIgenA9ekRhdGEuenA7IGlmICghenApIHpwPSJaUEFQRVJfXyI7IC8vRVJTMTkwODA1IAoJaWYgKHpEYXRhLnJlY2VpdmVkKSBhcnJPZlBhaXJzLnB1c2goInpTdGFja19SZWNlaXZlZF9fYyIsIHpEYXRhLmZvcm1hdE5vdyk7IC8vRVJTMTkwNjE3IFRPRE8gc2F2ZSB3YXkgdG8gZG8gdGhpcwoJaWYgKHpEYXRhLm93bmVySWQpIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsekRhdGEub3duZXJJZCk7ICAvLyB6Q2hhcnRhIFF1ZXVlICIwMEczNjAwMDAwMkN5VEsiIAoJaWYgKHpEYXRhLmNhbGxlcklkKSBhcnJPZlBhaXJzLnB1c2goInpDYWxsZXJfSURfX2MiLCBkb2MuZGVsaXZlcmVkRnJvbSk7IC8vTVNIMTcwODE3IGFkZGVkCglpZiAoekRhdGEucGF0RW5yb2xsUXVldWVJZCkgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIix6RGF0YS5wYXRFbnJvbGxRdWV1ZUlkKTsKCQogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLCB6RGF0YS5kb2NUeXBlKTsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIsIHpEYXRhLmNsYXNzaWZpY2F0aW9uKTsKICAgIHZhciBwYWdlUmFuZ2UgPSBYKGRvYywiWF9pZHhQYWdlcyIpOwogICAgaWYgKCFwYWdlUmFuZ2UpIHBhZ2VSYW5nZT0iMS0iK1goZG9jLCJYX3BhZ2VzIik7IAogICAgdmFyIHBhZ2VDb3VudCA9IHpEYXRhLmNvdW50UGFnZXMoZG9jLCBwYWdlUmFuZ2UpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX3JlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7IC8vRVJTMTkwODE0IAogICAgLy9FUlMxOTA4MTAgVE9ETz8gYXJyT2ZQYWlycy5wdXNoKCJaU1RBQ0tfX1JlY2VpdmVkX19jIiwgekRhdGEuZm9ybWF0Tm93KTsKICAgIGFsZXJ0KCJFUlMyMDAyMTMuNTEgcGFnZVJhZ2U9IitwYWdlUmFuZ2UgKyAiIGJ1dCBwYWdlQ291bnQ9IitwYWdlQ291bnQpOyAvL0VSUzIwMDIxMyBhbHNvIGNhbGxlZCBpbiBuZXcgaW5jb21pbmcgc3RhY2sKICAgIGlmICghWChkb2MsIlhfaWR4UGFnZXMiKSkgcGFnZUNvdW50PVgoZG9jLCJYX3BhZ2VzIik7IC8vRVJTMjAwMjEzIFRPRE8gZml4IHpEYXRhLmNvdW50UGFnZXMoKQogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhZ2VzX19jIiwgcGFnZUNvdW50KTsKICAgIAogICAgLy9FUlMyMDAyMDQgVE9ETyB6U3RhY2suUHJvZ3JhbT8KCiAgICBpZiAoekRhdGEucHJvZ3JhbU5hbWUgPT09IHpEYXRhLlBST0dSQU1fWkNIQVJUQSkgeyAvL0pQQjIwMTAyMyBjaGFuZ2VkIGZyb20gY2xhc3NpZmljYXRpb24gdG8gcHJvZ3JhbU5hbWUKICAgIAlhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIlVyZ2VudCIpOyAvL0pQQjE5MDQyNiBjaGFuZ2VkIHRvIGNsYXNzaWZpY2F0aW9uIGZyb20gcHJvZ3JhbQogICAgfSBlbHNlIGlmICh6RGF0YS5wcm9ncmFtTmFtZSA9PT0gekRhdGEuUFJPR1JBTV9aUEFQWVJVUykgeyAvL0pQQjIwMTAyMyBjaGFuZ2VkIGZyb20gY2xhc3NpZmljYXRpb24gdG8gcHJvZ3JhbU5hbWUKICAgIAlhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIkhpZ2giKTsgCiAgICB9IGVsc2UgaWYgKHpEYXRhLnByb2dyYW1OYW1lID09PSB6RGF0YS5QUk9HUkFNX1pDQVJUQSkgeyAvL0pQQjIwMTAyMyBjaGFuZ2VkIGZyb20gY2xhc3NpZmljYXRpb24gdG8gcHJvZ3JhbU5hbWUKICAgIAlhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIkNyaXRpY2FsIik7CQogICAgfSBlbHNlIHsKICAgIAlhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIk5vcm1hbCIpOwogICAgfQogICAgCiAgICBhcnJPZlBhaXJzLnB1c2goenArInNlbnRGYXhUb19fYyIsICgiQ29tbXVuaXR5IiA9PT0gekRhdGEuY2hhbm5lbCA/IHpEYXRhLmNoYW5uZWwgOiBkb2MuZGVsaXZlcmVkVG8pKTsgLy9KUEIxOTA1MjkgYWRkZWQgc28gQ29tbXVuaXR5IHNob3dzIHVwIGluIE1hc3RlciBJbnRha2UgTGlzdAogICAgYXJyT2ZQYWlycy5wdXNoKHpwKyJGcm9tX19jIixkb2MuZGVsaXZlcmVkRnJvbSk7CiAgICBpZiAoekRhdGEucmV2aWV3ZWRTdGF0dXMpIHthcnJPZlBhaXJzLnB1c2goenArIlN0YWdlX19jIiwgekRhdGEucmV2aWV3ZWRTdGF0dXMpOyB9IAogICAgZWxzZSB7IGFyck9mUGFpcnMucHVzaCh6cCsiU3RhZ2VfX2MiLCAiUmVjZWl2ZWQiKTsgfQogICAgekRhdGEuc3RhY2tQYWlycz1hcnJPZlBhaXJzOyAvL0VSUzE5MDgxMCAjNjE1NzAgZm9yIGNoaWxkIHN0YWNrIGxhdGVyCiAgICBhcnJPZlBhaXJzPXpEYXRhLmNsaWVudEZpZWxkcyhkb2MsYXJyT2ZQYWlycyxYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9felN0YWNrRmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiAKCXJldHVybiBhcnJPZlBhaXJzOwp9OwoKLy9hbGVydCgiekRhdGEuY2xpZW50RmlsZSIpOwp6RGF0YS5jbGllbnRGaWxlPWZ1bmN0aW9uKGRvYyxzdGFnZSkgeyAvL0VSUzE3MDgyOSAjNDEyOTggcmV0dXJucyBhIGxhYmVsIHRvIGJlIHVzZWQgaW4gYW55IGF0dGFjaGVzIGFuZCBmaXhlcyB0aGUgZG9jCiAgICAvL0RvY3VtZW50IGF0dGFjaG1lbnQgbGFiZWwgc2hvdWxkIGJlICJQYXRpZW50IE5hbWUgLSBEb2MgVHlwZSAtIERhdGUiLiAgQ29uZmlybWVkIGZvciB6UGFwZXIgRmlsZSBhbmQgU0ZEQyBBdHRhY2htZW50CiAgICB2YXIgTU1kZFlZWVkgPSB6RGF0YS5mb3JtYXRUb2RheU1NZGRZWVlZKCk7CiAgICBpZiAoIXN0YWdlKSB7IHN0YWdlPSJTcGxpdCI7IH0gLy9FUlMyMTA0MTAgIzc4NzU5IHJpYmJvbiBhY3Rpb25zCiAgICAKICAgIC8vQ1JOMjAxMDI1ICM3Njc4OCBGaXhlZCB0byBtYXRjaCB0aGUgY3VycmVudCBkZW1vLgogICAgdmFyIHBhdGllbnROYW1lID0gWChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIik7CiAgICBpZiAoIXBhdGllbnROYW1lKSB7CiAgICAgICAgcGF0aWVudE5hbWUgPSBYKGRvYywiWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyIpICsgIiAiICsgWChkb2MsICJYX1pQQVBFUl9fTGFzdE5hbWVfX2MiKTsKICAgIH0KICAgIGlmICghcGF0aWVudE5hbWUpIHsKICAgICAgICBwYXRpZW50TmFtZSA9IFgoZG9jLCJYX1pQQVBFUl9fRmlyc3ROYW1lX19jIikgKyAiIGF0ICIgKyBYKGRvYywgIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOwogICAgfQogICAgdmFyIGZheFR5cGUgPSBrZXl3b3JkTWFwW1goZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpXTsKICAgIGlmICghZmF4VHlwZSkgeyBmYXhUeXBlID0gWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIik7IH0KICAgIGlmICghZmF4VHlwZS5pbmRleE9mKCc6JykgPj0gMCkgeyBmYXhUeXBlID0gZmF4VHlwZS5zcGxpdCgnOicpWzFdOyB9CiAgICAvLyBkb2MubGFiZWwgPSBwYXRpZW50TmFtZSArICIgLSAiICsgZmF4VHlwZSArICIgLSAiICsgTU1kZFlZWVk7CiAgICBkb2MubGFiZWwgPSBwYXRpZW50TmFtZSArICIgLSAiICsgZmF4VHlwZTsKICAgIGlmICghcGF0aWVudE5hbWUgfHwgcGF0aWVudE5hbWUubGVuZ3RoPDUgfHwgKCFmYXhUeXBlICYmIHN0YWdlICE9PSAiU3BsaXQiKSkgeyAvL0VSUzIwMTEyOSAjNzg4MzAgLy9FUlMyMTA0MTAgYWRkZWQgZmF4VHlwZSB0ZXN0CiAgICAgICAgZG9jLmxhYmVsPSJTcGxpdCBmcm9tICIrWChkb2MsIlhfc3BsaXRQYWdlcyIpKyIgb2YgIisgWChkb2MsIlhfZnJvbVBhZ2VzIikgKyIgLSAiK01NZGRZWVlZOwogICAgICAgIGRvYy5sYWJlbD0iU3BsaXQgZnJvbSAiKyBYKGRvYywiWF9mcm9tUGFnZXMiKSArIiAtICIrTU1kZFlZWVk7CiAgICAgICAgZG9jLmxhYmVsPXN0YWdlKyIgZnJvbSAiK1goZG9jLCJYX2Zyb21QYWdlcyIpKyIgLSAiK01NZGRZWVlZOyAvL0VSUzIxMDQxMCByaWJib24KICAgIH0gCiAgICBhbGVydCgiRVJTMTcwODI5IGRiSUQ9Iitkb2MuZGJJRCsiIGxhYmVsPSIrZG9jLmxhYmVsICsiIHNmSUQ9Iit6RGF0YS5zZklEKTsKICAgIGlmICghekRhdGEuc2ZJRCkgeyB6RGF0YS5zZklEPVgoZG9jLCJzZklEIik7IH0gLy9FUlMyMDEyMTEgIzc5NTkxCiAgICAvL1RPRE8gaWYgSEMgYW5kIG91dGJvdW5kIHRoZW4gU2VuZCB0byB7IUNvbnRhY3QuTmFtZX0gYXQgeyFDb250YWN0LkFjY291bnQuTmFtZX0KICAgIC8vVE9ETyBpZiBIQyBhbmQgcmVjaWV2ZWQgdGhlbiBSZWNpZXZlZCBmcm9tIHshQ29udGFjdC5OYW1lfSBhdCB7IUNvbnRhY3QuQWNjb3VudC5OYW1lfQogICAgaWYgKHpEYXRhLnNmSUQgICYmIHpEYXRhLnNmSUQuaW5kZXhPZigiNTAwIik9PT0wKSB7CgkgICAgekRhdGEucHJvdmlkZXIgPSBnZXRTRkZpZWxkKGRvYywgIkNhc2UiLCAiQWNjb3VudC5OYW1lIiwgbnVsbCwgekRhdGEuc2ZJRCk7IAoJICAgIGRvYy5sYWJlbCA9ICJSZWNlaXZlZCBmcm9tICIgKyB6RGF0YS5wcm92aWRlcjsgLy9FUlMyMDEyMTEgIzc5NTkxICBtaXNzaW5nIGRvYy4KICAgICAgICBpZiAoekRhdGEuZmFjaWxpdHkpIHsKICAgICAgICAgICAgekRhdGEuZmFjaWxpdHkgPSBnZXRTRkZpZWxkKGRvYywgIkNhc2UiLCAiQWNjb3VudC5GYWNpbGl0eV9fci5OYW1lIiwgbnVsbCwgekRhdGEuc2ZJRCk7CiAgICAgICAgICAgIGRvYy5sYWJlbCs9IiBhdCAiK3pEYXRhLmZhY2lsaXR5OwogICAgICAgIH0KCX0KCXZhciBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgZG9jLmxhYmVsKTsKCXVwZGF0ZURCKGRvYyxhcnJPZlBhaXJzKTsKICAgIHJldHVybiBkb2MubGFiZWw7Cn07Cgp6RGF0YS5jbGllbnRWYWx1ZT1mdW5jdGlvbihkb2MsdmFsKSB7Ly9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04gCiAgICB2YWw9dmFsLnJlcGxhY2UoInshZm9ybWF0Tm93fSIsekRhdGEuZm9ybWF0Tm93KTsKICAgIHJldHVybiB2YWw7Cn0KCnpEYXRhLmNsaWVudEZpZWxkcz1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxqZCx6ZCkgeyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiBpbiBzZXR0aW5nIHRvIGNvbmZpZ3VyZSBuZXcgcmVjb3JkCiAgICBpZiAoIXpkKSB6ZD16RGF0YTsKCWlmIChqZCAmJiBqZC5pbmRleE9mKCJ7Iik9PT0wKSB7IAoJICAgIC8veyJUeXBlIjoiRWxpZ2liaWxpdHkiLCJPd25lcklkIjoiMDBHYzAwMDAwMDN2Z3F3IiwiUmVjb3JkVHlwZUlkIjoiMDEyNkEwMDAwMDBKRUtlUUFPIn07CgkgICAgLy9OT1QgQSBHT09EIElERUEgamQ9amQucmVwbGFjZUFsbCgiXCIiLCInIik7IC8vRVJTMTkwODExICM2MTU3MCBIQUNLPwoJICAgIGpkPWpkLnJlcGxhY2UoIn07IiwifSIpOyAvL0VSUzIwMTEyOSBTSFIgdG8gd29yayBvdXQgZGVzaWduIG9uIGNoYW5uZWwgd2l6YXJkIGZvciB6U3RhY2sgY2hpbGQgc2V0IEFTQVAKCSAgICB0cnkgewogICAgCSAgICB2YXIgamRhdGE9SlNPTi5wYXJzZShqZCk7IC8vRVJTMTkwODA1IGJldHRlciB0aGFuIGV2YWwKICAgIAkgICAgZm9yICh2YXIgbiBpbiBqZGF0YSkgewogICAgCSAgICAgICAgdmFyIHYwPWpkYXRhW25dOyAKICAgIAkgICAgICAgIHZhciB2PXpEYXRhLmNsaWVudFZhbHVlKGRvYyx2MCk7IC8vRVJTMTkwODExICx2IG5vdyAsdjAKICAgIAkgICAgICAgIGFsZXJ0KCJFUlMxOTA4MDMuOTcgIituKyI9Iit2MCsiPSIrdik7IAogICAgCSAgICAgICAgYXJyT2ZQYWlycy5wdXNoKG4sdik7IC8vRVJTMTkwODExIGFkZGVkIC5wdXNoCiAgICAJICAgICAgICB6ZFtuXT12OyAvL0VSUzIwMTEyOSAjNzg4MzAgVE9ETyByZXZpZXcgYXJyT2ZQYWlycyBhY2Nlc3MgdXNpbmcgZm9yIFJlY29yZFR5cGVJZAogICAgCSAgICB9CgkgICAgfSBjYXRjaCAoZSkgewoJICAgICAgICBhbGVydCgiSlNPTiBub3QgaW4gIitqZCsiIEV4Y2VwdGlvbjogIitlKTsgLy9FUlMxOTA4MTEgYWRkZWQgZQoJICAgIH0KCX0KCXJldHVybiBhcnJPZlBhaXJzOwp9CgoKekRhdGEuY2xpZW50Q2FzZT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxsYWJlbCx6ZCkgewoJaWYgKCF6ZCkgemQ9ekRhdGE7CglpZiAoIXpkLnRyaWFnZVR5cGUgJiYgWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIikpIHpkLnRyaWFnZVR5cGU9WChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIik7IC8vRVJTMjAwMzA4CglpZiAoIWxhYmVsKSB7IGxhYmVsPSJJbmRleGVkLSIgKyAiLSIgKyB6ZC50cmlhZ2VUeXBlICsgIi0iICsgemQuc3RhY2tJZDt9CgkKCWFsZXJ0KCJFUlMyMDAzMDguMTI4IG5ldyBDYXNlIHByb3ZpZGVySWQ9Iit6ZC5wcm92aWRlcklkKyIgcGF0aWVudElkPSIremQucGF0aWVudElkKTsKCQoJLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7CglpZiAoemQuY29udGFjdElkKSBhcnJPZlBhaXJzLnB1c2goIkNvbnRhY3RJZCIsIHpkLmNvbnRhY3RJZCk7CglhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbmV3RmF4X19jIiwgInRydWUiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2xhdGVzdEZheF9fYyIsIHpkLmZvcm1hdE5vdyk7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCglhcnJPZlBhaXJzLnB1c2goIlN0YXR1cyIsIFgoZG9jLCJYX1N0YXR1cyIpKTsKCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIix6ZC50cmlhZ2VUeXBlKTsgLy9FUlMyMDAzMDgKCS8vRVJTMjAwMjA1IGFyck9mUGFpcnMucHVzaCgiVHlwZSIsICJOZXcgIit6ZC5jbGFzc2lmaWNhdGlvbik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCS8vRVJTMjAwMzA4IGFyck9mUGFpcnMucHVzaCgiVHlwZSIsICJOZXcgIit6ZC5kb2NUeXBlKTsKCWlmICgxPT0xKSB7IC8vRVJTMTcwNTIzICMzNzE2MiBhZnRlciBkcnlydW4KCSAgICBhbGVydCgiQEBAIHpkLnByaW9yaXR5ID0+ICoiICsgemQucHJpb3JpdHkgKyAiKiIpOwoJCS8vYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTJRMDAwMDAwMDVBaGoiKTsgLy9FUlMxNzA1MjMgUHJpb3IgQXV0aAoJCWlmICh6ZC5wcmlvcml0eSAhPSAiTm9ybWFsIikgeyBhcnJPZlBhaXJzLnB1c2goIlByaW9yaXR5Iix6ZC5wcmlvcml0eSk7IH0gIC8vRVJTMTcwNTI0ICMzNzE2MiBwcmlvcml0eSBvbiBDYXNlCgkJZWxzZSB7IGFyck9mUGFpcnMucHVzaCgiUHJpb3JpdHkiLCJNZWRpdW0iKTsgfQoJCWFyck9mUGFpcnMucHVzaCgiT3JpZ2luIiwiRmF4Iik7IC8vRVJTYTIwMDIwNSByck9mUGFpcnMucHVzaCgiT3JpZ2luIix6ZC5jaGFubmVsKTsKCX0KICAgIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19DYXNlRmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTgogICAgCiAgICBhbGVydCgiRVJTMjAwMzA4LjE0MyBuZXcgQ2FzZSBwcm92aWRlcklkPSIremQucHJvdmlkZXJJZCsiIHBhdGllbnRJZD0iK3pkLnBhdGllbnRJZCk7CiAgICBpZiAoemQucHJvdmlkZXJJZCAmJiB6ZC5wcm92aWRlcklkLmluZGV4T2YoIjAwMSIpPT0wKSB7IGFyck9mUGFpcnMucHVzaCgiQWNjb3VudElkIiwgemQucHJvdmlkZXJJZCk7IH0gLy9FUlMyMDAzMDgKICAgIGlmICh6ZC5wcm92aWRlcklkICYmIHpkLnByb3ZpZGVySWQuaW5kZXhPZigiMDAzIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCB6ZC5wcm92aWRlcklkKTsgfSAvL0VSUzIwMDMwOAogICAgaWYgKHpkLnBhdGllbnRJZCAmJiB6ZC5wYXRpZW50SWQuaW5kZXhPZigiMDAxIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJBY2NvdW50SWQiLCB6ZC5wYXRpZW50SWQpOyB9IC8vRVJTMjAwMzA4CiAgICBpZiAoemQucGF0aWVudElkICYmIHpkLnBhdGllbnRJZC5pbmRleE9mKCIwMDMiKT09MCkgeyBhcnJPZlBhaXJzLnB1c2goIkNvbnRhY3RJZCIsIHpkLnBhdGllbnRJZCk7IH0gLy9FUlMyMDAzMDgKICAgIGlmICh6ZC56Y2hhbm5lbC5vd25lcikgeyBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS56Y2hhbm5lbC5vd25lcik7IH0gLy9FUlMyMDAzMDgKICAgIAoJdmFyIGNhc2VJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJDYXNlIiwgbGFiZWwsIGFyck9mUGFpcnMpOwoJcmV0dXJuIGNhc2VJZDsKfTsKCnpEYXRhLmNsaWVudFBhdGllbnQ9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsbGFiZWwsemQpIHsKCWlmICghemQpIHpkPXpEYXRhOwoJaWYgKCFsYWJlbCkgeyBsYWJlbD16ZC5zdGFnZSArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KCWlmICh6ZC5wYXRpZW50SWQpIHsgLy9FUlMyMDAyMDUgIzY4ODI1IFByb2dyYW0gTWVtYmVycwoJICAgIGFsZXJ0KCJQYXRpZW50IGFscmVhZHkgZXhpc3RzIGluICIremQucGF0aWVudElkKTsKCSAgICByZXR1cm4gemQucGF0aWVudElkOyAvL1RPT0QgZ2V0IGZyb20gWF9wYXRpZW50SWQgID8/Pz8KCX0KCS8vRVJTMTcwNTIwIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHF1ZXVlc01hcEtsdWRnZVtYKGRvYywiWF9Bc3NpZ25fdG9fUXVldWVfX2MiKV0pOwoJdmFyIHA9IlpQQVBFUl9fIjsgLy9FUlMyMDAyMDIgYXNzdW1lIHdvcmtmbG93IG9uIHJlbGF0ZWQgcmVjb3JkIHR5cGVzCglpZiAoekRhdGEucGF0aWVudFR5cGUuaW5kZXhPZigiX19jIikgPiAtMSkgeyBwPSIiOyB9IC8vRVJTMjAwMjAzIHR5cG8KCWlmICgxPT0wKSB7IC8vRVJTMjAwMjAyIHNlZSBpZiB3b3JrZmxvdyBlbmFibGVkCgkgICAgYXJyT2ZQYWlycy5wdXNoKHArIm5ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCSAgICBhcnJPZlBhaXJzLnB1c2gocCsibGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJICAgIGFyck9mUGFpcnMucHVzaChwKyJyZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCgl9CgogICAgdmFyIHJ0PVhDdXN0b21TZXR0aW5nKGRvYywiUGF0aWVudFJlY29yZFR5cGVfX2MiKTsgLy9UT0RPIGludG8gTVAgRVJTMTkwODAyIGxpa2UgMDEyNkEwMDAwMDBKRTh5UUFHIG9yIGVtcHR5IHRvIHVzZSBkZWZhdWx0CiAgICAvL2lmIChydCkgeyBhcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIHJ0KTsgfSAvL0VSUzE5MDgwMwogICAgLy9UT0RPIENvbnRhY3Qgb3IgQWNjb3VudCBFUlMxOTA2MjQgRE9ORSEhIEVSUzE5MDgwMgogICAgYXJyT2ZQYWlycz1bXTsgLy9FUlMyMDEyMTIgSEFDSyBzaW5jZSB0aGUgSW5kZXggYWN0aW9uIG5lZWRzIHRvIGJlIHJlZmFjdG9yZWQKICAgIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19QYXRpZW50RmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiAKICAgIC8vRVJTMjAxMjEyIGJhY2sgaW4gbm93ISAgIzc5NTg4IGFyck9mUGFpcnM9W107IC8vRVJTMjAwMjA0IHRlc3RpbmcgdG8gZ2V0IGl0IGdvaW5nCiAgICAKICAgIC8vRVJTMjAwMjAyIG5lZWQgdG8gbWFrZSB0aGUgQWNjb3VudCB3aXRoIFBhdGllbnQgcmVjb3JkVHlwZSBmaXJzdAogICAgLy8wMTI0NjAwMDAwME5HRllBQTQgaXMgLnpwYXBlciBmb3IgUGF0aWVudAogICAgdmFyIGFyID0gW107CiAgICBhcj1hcnJPZlBhaXJzOyAvL0VSUzIwMTIxMiAjNzk1ODgKICAgIGlmIChydCkgeyBhci5wdXNoKCJSZWNvcmRUeXBlSWQiLCBydCk7IH0gLy9FUlMxOTA4MDMgLy9FUlMyMDAyMjIgIzY5MTQ5IG1vdmVkIGRvd24gYW5kIGFkZGVkIGVsc2UgCiAgICAvL0VSUzIwMTIxMiBnZXQgZnJvbSBQYXRpZW50RmllbGRzIG5vdyEgIzc5NTg4IGVsc2UgYXIucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyNDYwMDAwMDBOR0ZZQUE0Iik7CiAgICBhci5wdXNoKCJGaXJzdE5hbWUiLHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MpOwogICAgYXIucHVzaCgiTGFzdE5hbWUiLHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICB2YXIgcGF0aWVudE5hbWU9ekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKyIsICIrekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYzsKICAgIAogICAgLy9pZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgYXIucHVzaCgiUGVyc29uQmlydGhEYXRlIix6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsKICAgIC8vdmFyIGFJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkFjY291bnQiLCBudWxsLCBhcik7IC8vRVJTMjAwMjA0IHBlcnNvbiBhY2NvdW50IHNvIGRvIG5vdCBzZXQgcGF0aWVudE5hbWUKICAgIAogICAgaWYgKHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MgJiYgekRhdGEucGF0aWVudFR5cGUuaW5kZXhPZigiQWNjb3VudCIpPi0xKSBhci5wdXNoKCJQZXJzb25CaXJ0aERhdGUiLHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgaWYgKHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MgJiYgekRhdGEucGF0aWVudFR5cGUuaW5kZXhPZigiQ29udGFjdCIpPi0xKSBhci5wdXNoKCJCaXJ0aERhdGUiLHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgdmFyIHBhdGllbnRUeXBlPXpEYXRhLnBhdGllbnRUeXBlLnJlcGxhY2UoIlBlcnNvbiIsIiIpOyAvL0VSUzIwMTIxMiBtYWtlIFNPUUwgaGFwcHkgSEFDSz8KICAgIHZhciBhSWQgPSBjcmVhdGVTRlJlY29yZChkb2MscGF0aWVudFR5cGUsIG51bGwsIGFyKTsgLy9FUlMyMDAyMDQgcGVyc29uIGFjY291bnQgc28gZG8gbm90IHNldCBwYXRpZW50TmFtZQogICAgCiAgICAKICAgIGlmIChhSWQgJiYgYUlkICE9ICJORVciICYmIGFJZC5pbmRleE9mKCJFUlJPUiIpPT0tMSkgewogICAgICAgIHZhciBzZklkID0gYUlkOyAvL0VSUzIwMTIxMiB3YXMgIiIKICAgIAkKICAgIAkvL0VSUzE5MDgwMyBzcGVjaWZpYyB0byBjbGllbnQgZGF0YSBlbnRyeQogICAgCXZhciBkcSA9IHpEYXRhLmRxOwogICAgCWFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQZXJzb25fQWNjb3VudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBzZklkICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1BlcnNvbl9BY2NvdW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArICIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArIGRxICsgIik7ICIpOwogICAgICAgIHJldHVybiBhSWQ7IC8vRVJTMjAxMjEyICM3OTU4OCByZXR1cm4gdGhlIElkIHdhcyBtaXNzaW5nCiAgICB9CiAgICByZXR1cm4geydFUlJPUic6ICdwYXRpZW50IG5vdCBjcmVhdGVkJ30KfTsKCnpEYXRhLmNsaWVudEFjY291bnQ9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsbGFiZWwsemQpIHsKCWlmICghemQpIHpkPXpEYXRhOwoJaWYgKCFsYWJlbCkgeyBsYWJlbD16ZC5zdGFnZSArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KCS8vRVJTMTcwNTIwIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHF1ZXVlc01hcEtsdWRnZVtYKGRvYywiWF9Bc3NpZ25fdG9fUXVldWVfX2MiKV0pOwoJYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX25ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19sYXRlc3RGYXhfX2MiLCB6ZC5mb3JtYXROb3cpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCglhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fcmVjZWl2ZWRJZF9fYyIsIGRvYy5kYklEKTsgLy9FUlMxOTA4MTQgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoKCXZhciBhY2NvdW50SWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCAiQWNjb3VudCIsIGxhYmVsLCBhcnJPZlBhaXJzKTsKCXJldHVybiBhY2NvdW50SWQ7Cn07Cgp6RGF0YS5jbGllbnRSZWNvcmQ9ZnVuY3Rpb24oZG9jLHNmVHlwZSxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7IC8vRVJTMTkwNjIwIGNsaWVudFJlY29yZCBnZW5lcmljCglpZiAoIXpkKSB6ZD16RGF0YTsKCWlmICghbGFiZWwpIHsgbGFiZWw9emQuc3RhZ2UgKyAiLSIgKyB6ZC50cmlhZ2VUeXBlICsgIi0iICsgemQuc3RhY2tJZDt9CgkvL0VSUzE3MDUyMCBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCBxdWV1ZXNNYXBLbHVkZ2VbWChkb2MsIlhfQXNzaWduX3RvX1F1ZXVlX19jIildKTsKCXZhciB6cD0iIjsKCWlmICgiLENhc2UsQ29udGFjdCxBY2NvdW50LExlYWQsT3Bwb3J0dW5pdHksWlBBUEVSX196U3RhY2tfX2MsIi50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIiwiK3NmVHlwZS50b0xvd2VyQ2FzZSgpKyIsIik+LTEpIHpwPXpEYXRhLnpwOwoJLy9vbmx5IGRvIHRoaXMgaWYgdGhlIGZpZWxkcyBleGlzdAoJYXJyT2ZQYWlycy5wdXNoKHpwKyJuZXdGYXhfX2MiLCAidHJ1ZSIpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCglhcnJPZlBhaXJzLnB1c2goenArImxhdGVzdEZheF9fYyIsIHpkLmZvcm1hdE5vdyk7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCWFyck9mUGFpcnMucHVzaCh6cCsicmVjZWl2ZWRJZF9fYyIsICJkb2MuZGJJRC5SZWMiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJCgkvL1RPRE8gcHV0IGNsaWVudCBzcGVjaWZpYyBkYXRhIHVwZGF0ZXMgaGVyZQoKCXZhciBuZXdJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsIHNmVHlwZSwgbGFiZWwsIGFyck9mUGFpcnMpOwoJcmV0dXJuIG5ld0lkOwp9OwoKekRhdGEuY2xpZW50Q29tcGxldGU9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsemQpIHtyZXR1cm4gYXJyT2ZQYWlyczt9OyAvL0VSUzE5MDYyNQp6RGF0YS5jbGllbnREZWxpdmVyeT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycykgeyAvL0VSUzIwMDIwMiBUT0RPIGNvbnNpZGVyIG5ldyBEb2N1bWVudF9NVk4KIGlmKFgoZG9jLCJDb250YWN0RmF4IikgPT09ICJQREYiKSB7CiAgICB6RGF0YS5jbGllbnRMaWdodG5pbmdGaWxlKGRvYyxbWChkb2MsInNmSUQiKV0sekRhdGEpOwogfWVsc2V7CiAgICBhbGVydCgiQ2FsbGluZyBjbGllbnRPdXRib3VuZExpZ2h0bmluZ0ZpbGUiKTsKICAgIHpEYXRhLmNsaWVudE91dGJvdW5kTGlnaHRuaW5nRmlsZShkb2MsWChkb2MsInNmSUQiKSx6RGF0YSk7IC8vUFYyMjEyMjEgYWRkZWQgIAogfQogICAgcmV0dXJuIGFyck9mUGFpcnM7Cn07IC8vRVJTMTkwNzExICM2MDkwMCBQQU9TCgp6RGF0YS5jbGllbnRDaGlsZFN0YWNrPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLHBhcmVudElkKSB7IC8vRVJTMTkwODEwICM2MTU3MCBiZSBzdXJlIHRvIGNhbGwgb24gbmV3IGNoaWxkIGRvYwogICAgdmFyIHBhaXJzPWFyck9mUGFpcnM7CiAgICAvL25vIG1lbW9yeSBvZiBzdGFjayBjcmVhdGlvbiB2YXIgcGFpcnM9ekRhdGEuc3RhY2tQYWlyczsKICAgIC8vQ1JOMjAxMDI2ICM3Njc4OCBXZSBuZWVkIHJldmlld2VkU3RhdHVzIHRvIGJlICJJbmRleGVkIiBmb3IgdGhlIGluZGV4IHJ1bGUsIHNvIG9ubHkgc2V0IHRoZSBmaWVsZCBpZiBpdCBpc24ndCBhbHJlYWR5IHNldC4KICAgIGlmICghekRhdGEucmV2aWV3ZWRTdGF0dXMpIHsgekRhdGEucmV2aWV3ZWRTdGF0dXM9IlNwbGl0IjsgfQogICAgLy9FUlMxOTA4MTAgVE9ETz8gcGFpcnMucHVzaCgiWlBBUEVSX19TdGF0dXNfX2MiLCAiQ2hpbGQgU3RhY2siKTsKCiAgICBwYWlycz16RGF0YS5jbGllbnRTdGFjayhkb2MscGFpcnMpOwogICAgaWYgKFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX196Q2hpbGRGaWVsZHNfX2MiKSkgeyAvL0VSUzE5MDgxMSBub3QgaW4gYWxsIE1QcwogICAgICAgIHBhaXJzPXpEYXRhLmNsaWVudEZpZWxkcyhkb2MscGFpcnMsWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX3pDaGlsZEZpZWxkc19fYyIpKTsgLy9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04gY2hpbGQgcmVjb3JkIHR5cGUgaWQKICAgIH0KICAgIHBhaXJzLnB1c2goIlpQQVBFUl9fUGFyZW50X19jIiwgcGFyZW50SWQpOwogICAgLy9FUlMyMDExMjggc2hvdWxkIGJlIGluIHpDaGlsZEZpZWxkcyBpZiAoekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGUpIHBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGUpOwogICAgCiAgICAvL3BhaXJzLnB1c2goIiIrIlByb2dyYW1fX2MiLHpEYXRhLnByb2dyYW1OYW1lKTsgLy9FUlMyMDAyMDUgVE9ETyBpbiBwYWNrYWdlIGFuZCBpbnRvIGJhc2UgY2FsbCAvL1NIUjIwMTIwMiAjNzkyNTcKICAgIHBhaXJzLnB1c2goIiIrIlpQQVBFUl9fUHJvZ3JhbV9OYW1lX19jIix6RGF0YS5wcm9ncmFtTmFtZSk7IC8vU0hSMjAxMjAyICM3OTI1NyB1c2UgdGhlIFByb2dyYW1fTmFtZSBmaWVsZCBpbnN0ZWFkIG9mIFByb2dyYW1fX2MKICAgIC8vRVJTMjAwMjI5IGlmICh6RGF0YS5wYXRpZW50SWQpIHBhaXJzLnB1c2goIlByb2dyYW1fTWVtYmVyX01WTl9fYyIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAyMDUgUHJvZ3JhbV9NZW1iZXJfTVZOX19jIHdhcyB0aGUgVElDS0VUISEhCiAgICBhbGVydCgiRVJTMTkwODExLjE5MSBaUEFQRVJfX1BhcmVudF9fYyIrIHBhcmVudElkKyIgY2hpbGQgekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGU9Iit6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSk7CiAgICBpZiAoekRhdGFbJ1JlY29yZFR5cGVJZCddKSB7ICB6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZT16RGF0YVsnUmVjb3JkVHlwZUlkJ107IH0gLy9FUlMyMDExMjkgIzc4ODMwIFRPRE8gbm90IHN1cmUgd2hlcmUgdGhpcyBpcyB1c2VkIGVsc2V3aGVyZQogICAgYWxlcnQoIkVSUzIwMTEyOS4yOTIgWlBBUEVSX19QYXJlbnRfX2MiKyBwYXJlbnRJZCsiIGNoaWxkIFJlY29yZFR5cGVJZD0iK3pEYXRhWydSZWNvcmRUeXBlSWQnXSk7CiAgICB2YXIgY2hpbGRTdGFja1NGSWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCAielN0YWNrIHNwbGl0IG9uICIgKyB6RGF0YS5mb3JtYXROb3csIHBhaXJzKSArICIiOwogICAgCiAgICBpZiAoIXpEYXRhLnBhdGllbnRJZCAmJiBYKGRvYywiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIikgKXsgLy9FUlMyMDAzMDggSEFDSwogICAgICAgIHpEYXRhLnBhdGllbnRJZD1YKGRvYywiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIik7CiAgICAgICAgYWxlcnQoIkVSUzIwMDMwOCBXSFkgTk9UIGluIHpEYXRhPyIpOwogICAgfQogICAgCiAgICBpZiAoekRhdGEucGF0aWVudElkICYmIHpEYXRhLkNhcmVQbGFuVGFza1JUKSB7IC8vRVJTMjEwMjIxICM3Njk3NSBkZXBsb3ltZW50IHNldHRpbmcgLy9FUlMyMDAzMDggY3JlYXRlIGFuIEFjdGl2aXR5IEV2ZW50IHJlbGF0ZWQgdG8gdGhlIFBhdGllbnQgKEFjY291bnQpIGZvciB0aGUgVGltZWxpbmUKICAgICAgICBpZiAoIXpEYXRhLmRvY1R5cGUgJiYgWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIikpIHpEYXRhLmRvY1R5cGU9WChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIik7CiAgICAgICAgdmFyIGFycj1bXTsKICAgICAgICAvL05PVCBTRUxFQ1QgQWNjb3VudElkLEFjdGl2aXR5RGF0ZSxDcmVhdGVkRGF0ZSxTdGF0dXMsU3ViamVjdCxUYXNrU3VidHlwZSxXaGF0SWQsV2hvSWQgRlJPTSBUYXNrIHdoZXJlIEFjdGl2aXR5RGF0ZSA+IDIwMjAtMDItMDEKICAgICAgICAvL1NFTEVDVCBJZCxBY2NvdW50SWQsQWN0aXZpdHlEYXRlLENyZWF0ZWREYXRlLFN1YmplY3QsV2hhdElkLFdob0lkIEZST00gRXZlbnQgd2hlcmUgSWQgPSAnMDBVNFQwMDAwMDJ2Q2hyVUFFJwogICAgICAgIC8vYXJyLnB1c2goIldob0lkIix6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzIwMDMxMCB0aW1lbGluZSB0cmljawogICAgICAgIGlmICh6RGF0YS5wYXRpZW50SWQuaW5kZXhPZigiMDAxIik9PTApIHsKICAgICAgICAgICAgYXJyLnB1c2goIldoYXRJZCIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAzMTAgdGltZWxpbmUgdHJpY2sKICAgICAgICAgICAgLy9hcnIucHVzaCgiQWNjb3VudElkIix6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzIwMDMxMCB0aW1lbGluZSB0cmljawogICAgICAgIH0gZWxzZSBpZiAoekRhdGEuY2FzZUlkKSBhcnIucHVzaCgiV2hhdElkIix6RGF0YS5jYXNlSWQpOwogICAgICAgIGVsc2UgaWYgKHpEYXRhLnByb3ZpZGVySWQpIGFyci5wdXNoKCJXaGF0SWQiLHpEYXRhLnByb3ZpZGVySWQpOwogICAgICAgIGVsc2UgYXJyLnB1c2goIldoYXRJZCIsY2hpbGRTdGFja1NGSWQpOwogICAgICAgIC8vYXJyLnB1c2goIlRhc2tTdWJ0eXBlIiwiVGFzayIpOwogICAgICAgIGFyci5wdXNoKCJTdWJqZWN0Iix6RGF0YS5zdGFnZSArICIgIit6RGF0YS5kb2NUeXBlKTsKICAgICAgICBhcnIucHVzaCgiRGVzY3JpcHRpb24iLCJDaGVjayBvdXQgIitkb2MuZGJJRCk7CiAgICAgICAgLy9hcnIucHVzaCgiQWN0aXZpdHlEYXRlVGltZSIsekRhdGEuZm9ybWF0Tm93KTsgLy9FUlMyMDAzMDkgaGFja2luZyBhd2F5IQogICAgICAgIGFyci5wdXNoKCJBY3Rpdml0eURhdGUiLHpEYXRhLmZvcm1hdE5vdy5zdWJzdHJpbmcoMCwxMCkpOwogICAgICAgIGFyci5wdXNoKCJSZWNvcmRUeXBlSWQiLHpEYXRhLkNhcmVQbGFuVGFza1JUKTsgLy9FUlMyMTAyMjEgIzc2OTc1ICIwMTI0VDAwMDAwMDhhRm1RQUkiIC8vRVJTMjAwMzEwIEhBQ0sgZm9yIFRhc2sgb24gQ2FyZVBsYW4KICAgICAgICAvL2Fyci5wdXNoKCJEdXJhdGlvbkluTWludXRlcyIsIjUiKTsKICAgICAgICAvL2Fyci5wdXNoKCJTdGF0dXMiLCJDb21wbGV0ZWQiKTsKICAgICAgICAKICAgICAgICB2YXIgbGFiZWw9IlRpbWVsaW5lICIrekRhdGEuZG9jVHlwZTsKICAgICAgICB2YXIgYWN0SWQgPSBjcmVhdGVTRlJlY29yZChkb2MsICJUYXNrIiwgbnVsbCwgYXJyKTsgLy9FUlMyMDAzMDkgbnVsbCBtZWFucyBubyBOYW1lIGZpZWxkCiAgICAgICAgLy92YXIgYWN0SWQgPSBjcmVhdGVTRlJlY29yZChkb2MsICJFdmVudCIsIG51bGwsIGFycik7IC8vRVJTMjAwMzA5IG51bGwgbWVhbnMgbm8gTmFtZSBmaWVsZAogICAgICAgIGFsZXJ0KCJFUlMyMDAzMDguMjYyIHRpbWVsaW5lIGFjdGl2aXR5ICIrYWN0SWQpOwogICAgfSBlbHNlIHsgYWxlcnQoIkVSUzIwMDMwOC4yNjMgYmUgd29ycmllZCB0aGVyZSBpcyBubyBwYXRpZW50ISIpOyB9CiAgICAKICAgIGlmICgxPT09MSAmJiB6RGF0YS5jbGllbnRSZWNlaXZlZERvY3VtZW50KSB7IHpEYXRhLnJlY0RvY0lkPXpEYXRhLmNsaWVudFJlY2VpdmVkRG9jdW1lbnQoZG9jLGNoaWxkU3RhY2tTRklkKTsgfSAvL0VSUzIwMTAxOCAjNzcyNTIKICAgIHJldHVybiBjaGlsZFN0YWNrU0ZJZDsKfTsKCgp6RGF0YS5jbGllbnRTdGFja0NvbXBsZXRlPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLHpkKSB7IC8vRVJTMjAwMzE0ICM3MDMzNgogICAgaWYgKCF6ZCkgemQ9ekRhdGE7IC8vRVJTMjAwNDA2ICM3MTE1NgogICAgYXJyT2ZQYWlycy5wdXNoKCJUaW1lX0NvbXBsZXRlX0RhdGVfX2MiLHpkLmZvcm1hdE5vdyk7IC8vZm9yIGRhc2hib2FyZAogICAgcmV0dXJuIGFyck9mUGFpcnM7Cn07IC8vRVJTMTkwNjI1Cgp6RGF0YS5jbGllbnRDYXNlUEE9ZnVuY3Rpb24oZG9jLHpkKSB7IC8vRVJTMjEwMzIwICM4MTMyNyBleGFtcGxlIHpDaGFubmVsIGFjdGlvbiB0cmlnZ2VyZWQKICAgIGlmICghemQpIHpkPXpEYXRhOyAvL0VSUzIwMDQwNiAjNzExNTYKICAgIGFsZXJ0KHpkLnpjaGFubmVsLmFjdGlvbiArICIgZmlyZWQgb24gIit6ZC56Y2hhbm5lbC5wYXRoKyIgd2l0aCBkb2MuZGJJRD0iK2RvYy5kYklEKyIgb24gelN0YWNrPSIremQuc3RhY2tJZCk7CiAgICByZXR1cm4gdHJ1ZTsKfTsgLy9FUlMxOTA2MjUKCnpEYXRhLmNsaWVudExpZ2h0bmluZ0ZpbGU9ZnVuY3Rpb24oZG9jLHNmSWRzLHpkKSB7CiAgICBpZihYKGRvYywiQ29udGFjdEZheCIpICE9ICJQREYiKSB7CiAgICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXpkKSB6ZCA9IHpEYXRhOwoKICAgIHZhciB6c2VydmVyID0gZG9jLmtiRGF0YS5zZlNlcnZlci5pbmRleE9mKCJodHRwczovLyIpID09IDAgPyBkb2Mua2JEYXRhLnNmU2VydmVyIDogImh0dHBzOi8vIiArIGRvYy5rYkRhdGEuc2ZTZXJ2ZXI7CiAgICAvLyBTYWxlc2ZvcmNlIFJFU1QgQVBJIGVuZHBvaW50CiAgICB2YXIgZG9jdXJsID0genNlcnZlciArICIvc2VydmljZXMvZGF0YS92NDYuMC9zb2JqZWN0cy9Db250ZW50VmVyc2lvbi8iOwogICAgdmFyIHBkZnVybCA9ICJodHRwczovL2d3LnpwYXBlci5jb20va2IvanNwL1NGX2ZpbmQubGlnaHRuaW5nLmpzcD9nbz1TRl9maWxlcy5qc3AmZGJJRD0iICsgZG9jLmRiSUQgKyAiJlNGb3JnPSIgKyBkb2Mua2JEYXRhLnNmT3JnYW5pemF0aW9uSUQ7CgogICAgLy8gR2VuZXJhdGUgUERGIGZpbGUgZnJvbSB6U3RhY2sKICAgIHZhciBmb3JtYXROb3cgPSBnZXRDdXJEYXRlQW5kVGltZShkb2MsIGZhbHNlLCB0cnVlKTsgLy8gZS5nLiAiMjAyMTAyMTAtMDUyMTMyIj8KICAgIHZhciBhcnJPZlBhaXJzID0gW107CiAgICB2YXIgbm93VGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiIjsKICAgIC8vdmFyIGZpbGVOYW1lID0gIWFjY25hbWUgJiYgIWZheHR5cGUgPyBkb2MubGFiZWwgOiBhY2NuYW1lICsgIiAtICIgKyBmYXh0eXBlICsgIiAtICIgKyBkYXRlc3RyOwogICAgdmFyIGFjY25hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIik7CiAgICB2YXIgZmF4dHlwZSA9IFgoZG9jLCAiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKTsKICAgIHZhciBkYXRlc3RyID0gZ2V0Q3VyRGF0ZShkb2MpOwogICAgaWYoIWZheHR5cGUpLy9QVjIxMDMxOAogICAgIGZheHR5cGUgPSB6RGF0YS5kb2NUeXBlOyAvL1BWMjEwMzE4IGFkZGVkIGl0IGZvciB0byB1cGRhdGUgZG9jdHlwZSBvbiBMaWdodG5pbmcgZmlsZXMKICAgICBpZighYWNjbmFtZSkKICAgICAgICBhY2NuYW1lID0gWChkb2MsICJYX1pQQVBFUl9fRmlyc3ROYW1lX19jIikgKyAiICIgKyBYKGRvYywgIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOyAvL1BWMjEwMzE4CiAgICAgICAgCiAgIGFsZXJ0KCJARmlsZU5hbWUgIiArIFgoZG9jLCAiY292ZXJCQVRFUyIpKTsgLy9QVjIyMDkyMiBhZGRlZCBhbGVydCBmb3IgRmlsZU5hbWUgIAogICAgdmFyIGZpbGVOYW1lID0gKFgoZG9jLCAiY292ZXJCQVRFUyIpID09IG51bGwgfHwgWChkb2MsICJjb3ZlckJBVEVTIikgPT0gJycgfHwgWChkb2MsICJjb3ZlckJBVEVTIikgPT0gIiAiKSA/IFgoZG9jLCAiZG9jVGl0bGUiKSA6IFgoZG9jLCAiY292ZXJCQVRFUyIpOyAvL1BWMjIwNjE2CiAgICBhbGVydCgiQGZpbGVOYW1lIGFmdGVyIGFzc2lnbmluZyIgKyBYKGRvYywgImRvY1RpdGxlIikpOwogICAgaWYoZmlsZU5hbWUgJiYgKGZpbGVOYW1lID09ICIyMDEwMDIwMjIzMjEwMDczMjE1X0Zvcm0iICB8fCBmaWxlTmFtZSA9PSAiMjAxMDAyMDIyMzAwNDE0MzAxM19Gb3JtIiB8fCBmaWxlTmFtZT09ICIyMDEwOTIwMjI0MjEyMTQ0MjU1X0Zvcm0iKSkgewogICAgICAgIGZpbGVOYW1lID0gIkZheENvdmVyIjsgIC8vU1AyMjA4MTcgCiAgICB9IGVsc2V7CiAgICAgICAgZmlsZU5hbWUgPSBkb2MubGFiZWwgKyAiIC0gIiArIGRhdGVzdHI7IAogICAgfQogICAgZmlsZU5hbWUgKz0gIi5wZGYiOwogICAgLy92YXIgZmlsZU5hbWUgPSBnZXRDdXJEYXRlKGRvYykgKyAiIE5ldyBGYXgucGRmIjsgLy8gZS5nIC0gIjIwMjEwMjEwIE5ldyBGYXgucGRmIj8KICAgIGFsZXJ0KCJAQEBmaWxlTmFtZSA9ICIgKyBmaWxlTmFtZSk7CiAgICB6RGF0YS51cGxvYWREaXIgPSAnelN0YWNrVXBsb2FkUm9vdCc7IC8vc2V0dGluZyByb290IGRpcmVjdG9yeSBmb3IgZmlsZSBjcmVhdGlvbgogICAgCiAgICB2YXIgZG9jYXJyT2ZQYWlycyA9IFtdOyAvL1BWMjIwNjIyCiAgICBkb2NhcnJPZlBhaXJzLnB1c2goIkxFQVBfRmlsZVR5cGVfX2MiLCAiRmF4Q292ZXIiKTsKICAgIGlmKHNmZG9jSWQpIHsKICAgICAgICBhbGVydCgiVXBkYXRpbmcgTEVBUF9GaWxlVHlwZV9fYyB0byBGYXhDb3ZlciBmb3IgZG9jIGlkOiIrc2Zkb2NJZCk7CiAgICAgICAgdXBkYXRlU0ZSZWNvcmQoZG9jLCAiQ29udGVudFZlcnNpb24iLCBzZmRvY0lkLCBkb2NhcnJPZlBhaXJzKTsKICAgIH0KCiAgICAvLyBjcmVhdGUgZGlyZWN0b3J5IHRvIHBsYWNlIGdlbmVyYXRlZCBQREYgZmlsZQogICAgY3JlYXRlRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwoKICAgIHZhciB4UGFnZXMgPSBYKGRvYywgIlhfcG9zaXRpb24iKTsgLy9nZXQgWF9wb3NpdGlvbiAtIHBhZ2UgcmFuZ2Ugc2VsZWN0ZWQ7IGRlZmF1bHQgPSBhbGwgcGFnZXMKICAgIGFsZXJ0KCJAQEBAQCBDYWxsaW5nIHNwbGl0UERGIHRvIHNwbGl0IG9mZiBwYWdlcyB0byB1cGxvYWQgYXMgUERGLCBwYWdlcyA9ICIgKyB4UGFnZXMgKyAiLCBub3dUaW1lU3RhbXAgPSAiICsgbm93VGltZVN0YW1wKTsKICAgaWYoIXhQYWdlcyl7CiAgICB4UGFnZXM9IjEtOTkiIC8vUFYyMjEyMTQgdXBkYXRlZAogICAgfQogICAgdmFyIHJlc3BvbnNlID0gc3BsaXRQREYoZG9jLCB4UGFnZXMsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wLCBmaWxlTmFtZSk7CiAgICBhbGVydCgiQEBAQCByZXNwb25zZSBmcm9tIHNwbGl0UERGID0gIiArIHJlc3BvbnNlKTsKICAgIHZhciBuZXdQREZOYW1lID0gWChkb2MsICJuZXdQREYiLCByZXNwb25zZSk7IC8vIHNldCB2YWx1ZSBvZiBuZXdQREYKCiAgICBhbGVydCgiQEBAQCBzcGxpdCBQREYgRmlsZU5hbWUgPSAiICsgbmV3UERGTmFtZSk7CgogICAgLy92YXIgdXBsb2FkVVJMID0gImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9teWZpbGVmb3JjZS91cGxvYWRUb0Nsb3VkLmpzcD9TRnR5cGU9Q29udGVudFZlcnNpb24mU0ZpZD1ORVcmU0ZwaWQ9IiArIHNmSWRzWzBdICsgIiZTRm9yZz0iICsgZG9jLmtiRGF0YS5zZk9yZ2FuaXphdGlvbklEICsgIiZsYWJlbD0iICsgZmlsZU5hbWUgKyAiJnNlcnZlckZpbGU9IiArIG5ld1BERk5hbWUgKyAiJkRlc2NyaXB0aW9uPUZpbGUgYXR0YWNoZWQgYXMgUERGIjsvL1BWMjEwNDIzIHVwZGF0ZWQgVVJMCiAgICAgdmFyIHVwbG9hZFVSTCA9ICJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0Z0eXBlPUNvbnRlbnRWZXJzaW9uJlNGaWQ9TkVXJlNGcGlkPSIgKyBzZklkc1swXSArICImU0ZTZXJ2ZXI9IiArIGRvYy5rYkRhdGEuc2ZTZXJ2ZXIgKyAiJlNGU2Vzc2lvbj0iICsgZG9jLmtiRGF0YS5zZlNlc3Npb25JRCArICImbGFiZWw9IiArIGZpbGVOYW1lICsgIiZzZXJ2ZXJGaWxlPSIgKyBuZXdQREZOYW1lICsgIiZEZXNjcmlwdGlvbj1GaWxlIGF0dGFjaGVkIGFzIFBERiI7Ly9QVjIxMDUxMSB1cGRhdGVkIFVSTAogICAgYWxlcnQoIiMjIyMgVXBsb2FkIG5hdGl2ZSBQREYgd2l0aCAiICsgdXBsb2FkVVJMKTsKCiAgICB2YXIgciA9IHdnZXQoZG9jLCB1cGxvYWRVUkwpOyAvLyA/Pz8/PyB3aWxsIHIgY29udGFpbiB0aGUgQ29udGVudERvY3VtZW50IGlkPwoKICAgIGFsZXJ0KCd2YWx1ZSBmcm9tIHdnZXQgcmVzcG9uc2UgPj4+ICcgKyByKTsKCiAgICB2YXIgaWR4QmVnaW4gPSByLmluZGV4T2YoIjxzZklEPiIpOwogICAgdmFyIGlkeEVuZCA9IHIuaW5kZXhPZigiPC9zZklEPiIpOwogICAgdmFyIHNmZG9jSWQ7CiAgICBpZiAoaWR4RW5kID4gaWR4QmVnaW4pIHsKICAgICAgICBzZmRvY0lkID0gci5zdWJzdHJpbmcoaWR4QmVnaW4gKyA2LCBpZHhFbmQpOwogICAgICAgIGFsZXJ0KCJzZkRvY0lkIGV4dHJhY3RlZCBmcm9tIHIgOiAiICsgc2Zkb2NJZCk7CiAgICB9CiAgICAKICAgIC8qdmFyIGRvY2Fyck9mUGFpcnMgPSBbXTsgLy9QVjIyMDYyMgogICAgZG9jYXJyT2ZQYWlycy5wdXNoKCJMRUFQX0ZpbGVUeXBlX19jIiwgIkZheENvdmVyIik7CiAgICBpZihzZmRvY0lkKSB7CiAgICAgICAgYWxlcnQoIlVwZGF0aW5nIExFQVBfRmlsZVR5cGVfX2MgdG8gRmF4Q292ZXIgZm9yIGRvYyBpZDoiK3NmZG9jSWQpOwogICAgICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNvbnRlbnRWZXJzaW9uIiwgc2Zkb2NJZCwgZG9jYXJyT2ZQYWlycyk7CiAgICB9Ki8KCgogICAgLy8gRmluYWxseSwgZGVsZXRlIHRoZSBmb2xkZXIgYW5kIGFsbCBjb250ZW50cy4KICAgIGNsZWFudXBEaXJlY3RvcnkoZG9jLCB6RGF0YS51cGxvYWREaXIsIG5vd1RpbWVTdGFtcCk7CiAgICAKICAgIHZhciBoZWFkZXJzID0gWwogICAgICAgICJBdXRob3JpemF0aW9uIiwgIkJlYXJlciAiICsgZG9jLmtiRGF0YS5zZlNlc3Npb25JRCwKICAgICAgICAiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb24iCiAgICBdOwogICAgZG9jdXJsID0genNlcnZlciArICcvc2VydmljZXMvZGF0YS92NDkuMC9zb2JqZWN0cy9Db250ZW50RG9jdW1lbnRMaW5rLyc7CiAgICBmb3IgKHZhciBpbmRleCA9IDE7IGluZGV4IDwgc2ZJZHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgLy9zaGFyaW5nIGZpbGVzIHdpdGggb3RoZXIgcmVjb3JkcwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q29udGVudERvY3VtZW50TGlua1JlY29yZCA9IHsKICAgICAgICAgICAgICAgICJDb250ZW50RG9jdW1lbnRJZCI6IHNmZG9jSWQsCiAgICAgICAgICAgICAgICAiTGlua2VkRW50aXR5SWQiOiBzZklkc1tpbmRleF0sCiAgICAgICAgICAgICAgICAiU2hhcmVUeXBlIjogIkkiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShjdXJyZW50Q29udGVudERvY3VtZW50TGlua1JlY29yZCk7CiAgICAgICAgICAgIHJlcyA9IHdwb3N0KGRvYywgZG9jdXJsLCBbXSwgaGVhZGVycywgYm9keSk7CiAgICAgICAgfSBjYXRjaCAoZXJycykgewogICAgICAgICAgICBhbGVydChlcnJzKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOwp9CnpEYXRhLmNsaWVudE91dGJvdW5kTGlnaHRuaW5nRmlsZT1mdW5jdGlvbihkb2Msc2ZJZCx6ZCkgey8vUFMyMzExOCBhZGRlZCBmb3IgY29udGVudCBkb2N1bWVudCBsaW5rIAogICAgYWxlcnQoc2ZJZCk7CgkvL2lmICghemQpIHpkID0gekRhdGE7Cgl2YXIgZmlsZU5hbWUgPSAoWChkb2MsICJjb3ZlckJBVEVTIikgPT0gbnVsbCB8fCBYKGRvYywgImNvdmVyQkFURVMiKSA9PSAnJyB8fCBYKGRvYywgImNvdmVyQkFURVMiKSA9PSAiICIpID8gWChkb2MsICJkb2NUaXRsZSIpIDogWChkb2MsICJjb3ZlckJBVEVTIik7Cgl2YXIgcGRmdXJsID0gImh0dHBzOi8vZ3cuenBhcGVyLmNvbS9rYi9qc3AvU0ZfZmluZC5saWdodG5pbmcuanNwP2dvPVNGX2ZpbGVzLmpzcCZkYklEPSIgKyBkb2MuZGJJRCArICImU0Zvcmc9IiArIGRvYy5rYkRhdGEuc2ZPcmdhbml6YXRpb25JRDsKCWFsZXJ0KCJJbnNpZGUgY2xpZW50T3V0Ym91bmRMaWdodG5pbmdGaWxlIik7Cgl2YXIgYXJyT2ZQYWlycyA9IFtdOwoJYXJyT2ZQYWlycy5wdXNoKCJUaXRsZSIsIGRvYy5sYWJlbCk7CglhcnJPZlBhaXJzLnB1c2goIkxFQVBfRmlsZVR5cGVfX2MiLCAiT3V0Ym91bmRGYXgiKTsKCWFyck9mUGFpcnMucHVzaCgiTEVBUF9GaWxlQ2F0ZWdvcnlfX2MiLCAiT3V0Ym91bmQiKTsKCWFyck9mUGFpcnMucHVzaCgiQ29udGVudFVybCIsIHBkZnVybCk7Cgl2YXIgY29udGVudFZlcnNpb25JZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkNvbnRlbnRWZXJzaW9uIiwgbnVsbCwgYXJyT2ZQYWlycyk7CgkKCXZhciBjb250ZW50RG9jdW1lbnRJZCA9IGdldFNGRmllbGQoZG9jLCAiQ29udGVudFZlcnNpb24iLCAiQ29udGVudERvY3VtZW50SWQiLCBudWxsLCBjb250ZW50VmVyc2lvbklkKTsKCQoJYXJyT2ZQYWlycyA9IFtdOwoJYXJyT2ZQYWlycy5wdXNoKCJDb250ZW50RG9jdW1lbnRJZCIsIGNvbnRlbnREb2N1bWVudElkKTsKCWFyck9mUGFpcnMucHVzaCgiTGlua2VkRW50aXR5SWQiLCBzZklkKTsKCWFyck9mUGFpcnMucHVzaCgiU2hhcmVUeXBlIiwgIkkiKTsKCXZhciBjb250ZW50RG9jdW1lbnRMaW5rSWQgPSBjcmVhdGVTRlJlY29yZChkb2MsICJDb250ZW50RG9jdW1lbnRMaW5rIiwgbnVsbCwgYXJyT2ZQYWlycyk7CgkKCS8vU2hhcmUgd2l0aCBDYXNlIHJlY29yZAoJLyp2YXIgY2FzZUlkID0gZ2V0U0ZGaWVsZChkb2MsICJMRUFQX091dGJvdW5kX0NvcnJlc3BvbmRlbmNlX1JlcXVlc3RfX2MiLCAiTEVBUF9DYXNlX19jIiAsIG51bGwsIHNmSWQpOwoJaWYoY2FzZUlkKSB7CiAgICAJYXJyT2ZQYWlycyA9IFtdOwogICAgCWFyck9mUGFpcnMucHVzaCgiQ29udGVudERvY3VtZW50SWQiLCBjb250ZW50RG9jdW1lbnRJZCk7CiAgICAJYXJyT2ZQYWlycy5wdXNoKCJMaW5rZWRFbnRpdHlJZCIsIGNhc2VJZCk7CiAgICAJYXJyT2ZQYWlycy5wdXNoKCJTaGFyZVR5cGUiLCAiSSIpOwogICAgCXZhciBjb250ZW50RG9jdW1lbnRMaW5rSWQgPSBjcmVhdGVTRlJlY29yZChkb2MsICJDb250ZW50RG9jdW1lbnRMaW5rIiwgbnVsbCwgYXJyT2ZQYWlycyk7Cgl9Ki8vL1BWMjMwMjAxCn0KYWxlcnQoImVuZCBjbGllbnQgbGlicmFyeSIpOyAvL0VSUzE5MDYxNSAjNTg5MjEK"},"ordinal":1}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("start client library"); //ERS190803 #52661 from OccFit//PV230203 updating for testing
//ERS201117 TODO get rid off these keywords and use a document journey wizard from KPS and Jake

//CRN201025 #76788 Moved from zStack Library so that it can be used in multiple rules.
var keywordMap={};
var keywords=["NEW:Document Stack~","ENRL:Enrollment~","ENRL:ENROLLMENT~","CON:Consent~","CON:consent~","FAC:Setting~","FAC:Distribution~","START:Start Form~","CHK:Checklist~","HIPAA:AUTHORIZATION~","HIPAA:HIPAA~","HIPAA:PORTABILITY~","REF:REFERRAL","REF:Referral","FIN:W2~","IC:Member ID~","FAX:"];
//keywordMap["TENR"] ="TENR:Start Form";
keywordMap["NEW"] ="NEW:Document Stack";
keywordMap["ENRL"] ="ENRL:Enrollment Form";
keywordMap["FAC"] ="FAC:Facility Enrollment Form";
keywordMap["FAX"] ="NEW:Document Stack";
//keywordMap["START"] ="NEW:Document Stack";
keywordMap["CON"] ="CON:Consent Form";
keywordMap["HIPAA"] ="HIPAA:HIPAA Authorization";
keywordMap["REF"] ="REF:Referral";
keywordMap["FW2"] ="FW2:W-2"; //JPB201023 added
keywordMap["I9"] ="I9:I-9"; //JPB201023 added
keywordMap["W4"] ="W4:W-4"; //JPB201023 added
keywordMap["DEM"] ="DEM:Demographics"; //CRN201026 added
keywordMap["CLIN"] ="CLIN:Clinical Notes"; //CRN201026 added
keywordMap["FIN"] ="FIN:Financial Info"; //CRN201026 added
keywordMap["IC"] ="IC:Insurance Card"; //CRN201026 added

zData.maxChannels=3; //ERS190731 #61272 zippi is strongly typed
zData.makeStack=true; //ERS190814 #61511

zData.watermark=""+XCustomSetting(doc,"watermark__c"); //ERS190618 best practice
//alert("ERS190411 wm="+zData.watermark+" ZPAPER__server__c="+XCustomSetting(doc,"ZPAPER__server__c"));
zData.uploadDir = ""+XCustomSetting(doc,"uploadDir__c"); //"alkermesRoot";
zData.patEnrollQueueId = ""+XCustomSetting(doc,"patientQueueId__c"); //'00G4C000000LkmZ'; //insert the Queue ID of the desired ownership queue. Update when migrating between environments. Need to add this queue in Setup
zData.recTypeRequest = ""+XCustomSetting(doc,"recTypeRequest__c"); //'0124C000000Cj5Y'; //ID of the Case Record Type Request_PS_MVN
//TODO zData.keywordMap["ENRL"] ="ENRL:Enrollment Form";  //TODO get from zStack picklists
//TODO zData.keywordMap["FAC"] ="FAC:Facility Enrollment Form";
//ERS200205 deleted demo data - do with custom settings

var cs=XDeploymentInfo(doc, "Business_Process__c"); //ERS200222 need both deployment info and cs
//alert("cs="+cs);
if (cs) {
    if (cs.indexOf("zCustomSettings")>-1) cs=X(doc,"zCustomSettings",cs);
    alert("ERS200225 EVAL on "+cs);
    if (cs !== "") eval(""+cs); //ERS200222 TODO JSON.parse() //ERS200225 beeds to be eval but also needs to work!!!
    alert("No try just do!");
}

if (1===0 && !zData.childStackRecordType) { //TODO custom setting or deployment? //ERS201129 DONE in zChildFields
    alert("ERS201128 should be in custom settings zChildFields");
    zData.childStackRecordType="01211000001gBs3AAE"; //ERS201128 should be in custom settings zChildFields "0120R000001N2oI";
}

zData.clientImportSOQL=function(doc,fromFile) { //ERS190706 customize imports used by Create Stack
    zData.importer=XCustomSetting(doc,zData.zp+"Importer__c").trim();
    var sfId="";
    var parts=fromFile.split("_");
    //sfId = getSFRecordID(doc, "Account", { "Fax" : parts[3] } );
    zData.makeStack=true; //do all the work there by default
    return sfId;
};

//alert("zData.clientStack");
zData.clientStack=function(doc,arrOfPairs) { //zData or this?
    var zp=zData.zp; if (!zp) zp="ZPAPER__"; //ERS190805 
	if (zData.received) arrOfPairs.push("zStack_Received__c", zData.formatNow); //ERS190617 TODO save way to do this
	if (zData.ownerId) arrOfPairs.push("OwnerId",zData.ownerId);  // zCharta Queue "00G36000002CyTK" 
	if (zData.callerId) arrOfPairs.push("zCaller_ID__c", doc.deliveredFrom); //MSH170817 added
	if (zData.patEnrollQueueId) arrOfPairs.push("OwnerId",zData.patEnrollQueueId);
	
    arrOfPairs.push("ZPAPER__faxType__c", zData.docType);
    arrOfPairs.push("ZPAPER__Classification__c", zData.classification);
    var pageRange = X(doc,"X_idxPages");
    if (!pageRange) pageRange="1-"+X(doc,"X_pages"); 
    var pageCount = zData.countPages(doc, pageRange);
    arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 
    //ERS190810 TODO? arrOfPairs.push("ZSTACK__Received__c", zData.formatNow);
    alert("ERS200213.51 pageRage="+pageRange + " but pageCount="+pageCount); //ERS200213 also called in new incoming stack
    if (!X(doc,"X_idxPages")) pageCount=X(doc,"X_pages"); //ERS200213 TODO fix zData.countPages()
    arrOfPairs.push("ZPAPER__Pages__c", pageCount);
    
    //ERS200204 TODO zStack.Program?

    if (zData.programName === zData.PROGRAM_ZCHARTA) { //JPB201023 changed from classification to programName
    	arrOfPairs.push(zp+"Priority__c", "Urgent"); //JPB190426 changed to classification from program
    } else if (zData.programName === zData.PROGRAM_ZPAPYRUS) { //JPB201023 changed from classification to programName
    	arrOfPairs.push(zp+"Priority__c", "High"); 
    } else if (zData.programName === zData.PROGRAM_ZCARTA) { //JPB201023 changed from classification to programName
    	arrOfPairs.push(zp+"Priority__c", "Critical");	
    } else {
    	arrOfPairs.push(zp+"Priority__c", "Normal");
    }
    
    arrOfPairs.push(zp+"sentFaxTo__c", ("Community" === zData.channel ? zData.channel : doc.deliveredTo)); //JPB190529 added so Community shows up in Master Intake List
    arrOfPairs.push(zp+"From__c",doc.deliveredFrom);
    if (zData.reviewedStatus) {arrOfPairs.push(zp+"Stage__c", zData.reviewedStatus); } 
    else { arrOfPairs.push(zp+"Stage__c", "Received"); }
    zData.stackPairs=arrOfPairs; //ERS190810 #61570 for child stack later
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__zStackFields__c")); //ERS190803 #52661 using JSON 
	return arrOfPairs;
};

//alert("zData.clientFile");
zData.clientFile=function(doc,stage) { //ERS170829 #41298 returns a label to be used in any attaches and fixes the doc
    //Document attachment label should be "Patient Name - Doc Type - Date".  Confirmed for zPaper File and SFDC Attachment
    var MMddYYYY = zData.formatTodayMMddYYYY();
    if (!stage) { stage="Split"; } //ERS210410 #78759 ribbon actions
    
    //CRN201025 #76788 Fixed to match the current demo.
    var patientName = X(doc,"X_ZPAPER__PatientAccount__r.Name");
    if (!patientName) {
        patientName = X(doc,"X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c");
    }
    if (!patientName) {
        patientName = X(doc,"X_ZPAPER__FirstName__c") + " at " + X(doc, "X_ZPAPER__LastName__c");
    }
    var faxType = keywordMap[X(doc,"X_ZPAPER__faxType__c")];
    if (!faxType) { faxType = X(doc,"X_ZPAPER__faxType__c"); }
    if (!faxType.indexOf(':') >= 0) { faxType = faxType.split(':')[1]; }
    // doc.label = patientName + " - " + faxType + " - " + MMddYYYY;
    doc.label = patientName + " - " + faxType;
    if (!patientName || patientName.length<5 || (!faxType && stage !== "Split")) { //ERS201129 #78830 //ERS210410 added faxType test
        doc.label="Split from "+X(doc,"X_splitPages")+" of "+ X(doc,"X_fromPages") +" - "+MMddYYYY;
        doc.label="Split from "+ X(doc,"X_fromPages") +" - "+MMddYYYY;
        doc.label=stage+" from "+X(doc,"X_fromPages")+" - "+MMddYYYY; //ERS210410 ribbon
    } 
    alert("ERS170829 dbID="+doc.dbID+" label="+doc.label +" sfID="+zData.sfID);
    if (!zData.sfID) { zData.sfID=X(doc,"sfID"); } //ERS201211 #79591
    //TODO if HC and outbound then Send to {!Contact.Name} at {!Contact.Account.Name}
    //TODO if HC and recieved then Recieved from {!Contact.Name} at {!Contact.Account.Name}
    if (zData.sfID  && zData.sfID.indexOf("500")===0) {
	    zData.provider = getSFField(doc, "Case", "Account.Name", null, zData.sfID); 
	    doc.label = "Received from " + zData.provider; //ERS201211 #79591  missing doc.
        if (zData.facility) {
            zData.facility = getSFField(doc, "Case", "Account.Facility__r.Name", null, zData.sfID);
            doc.label+=" at "+zData.facility;
        }
	}
	var arrOfPairs = [];
    arrOfPairs.push("db-label", doc.label);
	updateDB(doc,arrOfPairs);
    return doc.label;
};

zData.clientValue=function(doc,val) {//ERS190803 #52661 using JSON 
    val=val.replace("{!formatNow}",zData.formatNow);
    return val;
}

zData.clientFields=function(doc,arrOfPairs,jd,zd) { //ERS190803 #52661 using JSON in setting to configure new record
    if (!zd) zd=zData;
	if (jd && jd.indexOf("{")===0) { 
	    //{"Type":"Eligibility","OwnerId":"00Gc0000003vgqw","RecordTypeId":"0126A000000JEKeQAO"};
	    //NOT A GOOD IDEA jd=jd.replaceAll("\"","'"); //ERS190811 #61570 HACK?
	    jd=jd.replace("};","}"); //ERS201129 SHR to work out design on channel wizard for zStack child set ASAP
	    try {
    	    var jdata=JSON.parse(jd); //ERS190805 better than eval
    	    for (var n in jdata) {
    	        var v0=jdata[n]; 
    	        var v=zData.clientValue(doc,v0); //ERS190811 ,v now ,v0
    	        alert("ERS190803.97 "+n+"="+v0+"="+v); 
    	        arrOfPairs.push(n,v); //ERS190811 added .push
    	        zd[n]=v; //ERS201129 #78830 TODO review arrOfPairs access using for RecordTypeId
    	    }
	    } catch (e) {
	        alert("JSON not in "+jd+" Exception: "+e); //ERS190811 added e
	    }
	}
	return arrOfPairs;
}


zData.clientCase=function(doc,arrOfPairs,label,zd) {
	if (!zd) zd=zData;
	if (!zd.triageType && X(doc,"X_ZPAPER__faxType__c")) zd.triageType=X(doc,"X_ZPAPER__faxType__c"); //ERS200308
	if (!label) { label="Indexed-" + "-" + zd.triageType + "-" + zd.stackId;}
	
	alert("ERS200308.128 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
	
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	if (zd.contactId) arrOfPairs.push("ContactId", zd.contactId);
	arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
	arrOfPairs.push("Status", X(doc,"X_Status"));
	arrOfPairs.push("ZPAPER__faxType__c",zd.triageType); //ERS200308
	//ERS200205 arrOfPairs.push("Type", "New "+zd.classification); //JPB 170512 added these workflow fields
	//ERS200308 arrOfPairs.push("Type", "New "+zd.docType);
	if (1==1) { //ERS170523 #37162 after dryrun
	    alert("@@@ zd.priority => *" + zd.priority + "*");
		//arrOfPairs.push("RecordTypeId","012Q00000005Ahj"); //ERS170523 Prior Auth
		if (zd.priority != "Normal") { arrOfPairs.push("Priority",zd.priority); }  //ERS170524 #37162 priority on Case
		else { arrOfPairs.push("Priority","Medium"); }
		arrOfPairs.push("Origin","Fax"); //ERSa200205 rrOfPairs.push("Origin",zd.channel);
	}
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__CaseFields__c")); //ERS190803 #52661 using JSON
    
    alert("ERS200308.143 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
    if (zd.providerId && zd.providerId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.providerId); } //ERS200308
    if (zd.providerId && zd.providerId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.providerId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.patientId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.patientId); } //ERS200308
    if (zd.zchannel.owner) { arrOfPairs.push("OwnerId", zData.zchannel.owner); } //ERS200308
    
	var caseId = createAndAttach(doc, "Case", label, arrOfPairs);
	return caseId;
};

zData.clientPatient=function(doc,arrOfPairs,label,zd) {
	if (!zd) zd=zData;
	if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
	if (zd.patientId) { //ERS200205 #68825 Program Members
	    alert("Patient already exists in "+zd.patientId);
	    return zd.patientId; //TOOD get from X_patientId  ????
	}
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	var p="ZPAPER__"; //ERS200202 assume workflow on related record types
	if (zData.patientType.indexOf("__c") > -1) { p=""; } //ERS200203 typo
	if (1==0) { //ERS200202 see if workflow enabled
	    arrOfPairs.push(p+"newFax__c", "true"); //JPB 170512 added these workflow fields
	    arrOfPairs.push(p+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	    arrOfPairs.push(p+"receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
	}

    var rt=XCustomSetting(doc,"PatientRecordType__c"); //TODO into MP ERS190802 like 0126A000000JE8yQAG or empty to use default
    //if (rt) { arrOfPairs.push("RecordTypeId", rt); } //ERS190803
    //TODO Contact or Account ERS190624 DONE!! ERS190802
    arrOfPairs=[]; //ERS201212 HACK since the Index action needs to be refactored
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__PatientFields__c")); //ERS190803 #52661 using JSON 
    //ERS201212 back in now!  #79588 arrOfPairs=[]; //ERS200204 testing to get it going
    
    //ERS200202 need to make the Account with Patient recordType first
    //01246000000NGFYAA4 is .zpaper for Patient
    var ar = [];
    ar=arrOfPairs; //ERS201212 #79588
    if (rt) { ar.push("RecordTypeId", rt); } //ERS190803 //ERS200222 #69149 moved down and added else 
    //ERS201212 get from PatientFields now! #79588 else ar.push("RecordTypeId","01246000000NGFYAA4");
    ar.push("FirstName",zData.X_ZPAPER__FirstName__c);
    ar.push("LastName",zData.X_ZPAPER__LastName__c);
    var patientName=zData.X_ZPAPER__LastName__c+", "+zData.X_ZPAPER__FirstName__c;
    
    //if (zData.X_ZPAPER__Birthdate__c) ar.push("PersonBirthDate",zData.X_ZPAPER__Birthdate__c);
    //var aId = createSFRecord(doc, "Account", null, ar); //ERS200204 person account so do not set patientName
    
    if (zData.X_ZPAPER__Birthdate__c && zData.patientType.indexOf("Account")>-1) ar.push("PersonBirthDate",zData.X_ZPAPER__Birthdate__c);
    if (zData.X_ZPAPER__Birthdate__c && zData.patientType.indexOf("Contact")>-1) ar.push("BirthDate",zData.X_ZPAPER__Birthdate__c);
    var patientType=zData.patientType.replace("Person",""); //ERS201212 make SOQL happy HACK?
    var aId = createSFRecord(doc,patientType, null, ar); //ERS200204 person account so do not set patientName
    
    
    if (aId && aId != "NEW" && aId.indexOf("ERROR")==-1) {
        var sfId = aId; //ERS201212 was ""
    	
    	//ERS190803 specific to client data entry
    	var dq = zData.dq;
    	addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c" + dq + ").val(" + dq + sfId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
        return aId; //ERS201212 #79588 return the Id was missing
    }
    return {'ERROR': 'patient not created'}
};

zData.clientAccount=function(doc,arrOfPairs,label,zd) {
	if (!zd) zd=zData;
	if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields

	var accountId = createAndAttach(doc, "Account", label, arrOfPairs);
	return accountId;
};

zData.clientRecord=function(doc,sfType,arrOfPairs,label,zd) { //ERS190620 clientRecord generic
	if (!zd) zd=zData;
	if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	var zp="";
	if (",Case,Contact,Account,Lead,Opportunity,ZPAPER__zStack__c,".toLowerCase().indexOf(","+sfType.toLowerCase()+",")>-1) zp=zData.zp;
	//only do this if the fields exist
	arrOfPairs.push(zp+"newFax__c", "true"); //JPB 170512 added these workflow fields
	arrOfPairs.push(zp+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	arrOfPairs.push(zp+"receivedId__c", "doc.dbID.Rec"); //JPB 170512 added these workflow fields
	
	//TODO put client specific data updates here

	var newId = createAndAttach(doc, sfType, label, arrOfPairs);
	return newId;
};

zData.clientComplete=function(doc,arrOfPairs,zd) {return arrOfPairs;}; //ERS190625
zData.clientDelivery=function(doc,arrOfPairs) { //ERS200202 TODO consider new Document_MVN
 if(X(doc,"ContactFax") === "PDF") {
    zData.clientLightningFile(doc,[X(doc,"sfID")],zData);
 }else{
    alert("Calling clientOutboundLightningFile");
    zData.clientOutboundLightningFile(doc,X(doc,"sfID"),zData); //PV221221 added  
 }
    return arrOfPairs;
}; //ERS190711 #60900 PAOS

zData.clientChildStack=function(doc,arrOfPairs,parentId) { //ERS190810 #61570 be sure to call on new child doc
    var pairs=arrOfPairs;
    //no memory of stack creation var pairs=zData.stackPairs;
    //CRN201026 #76788 We need reviewedStatus to be "Indexed" for the index rule, so only set the field if it isn't already set.
    if (!zData.reviewedStatus) { zData.reviewedStatus="Split"; }
    //ERS190810 TODO? pairs.push("ZPAPER__Status__c", "Child Stack");

    pairs=zData.clientStack(doc,pairs);
    if (XCustomSetting(doc,"ZPAPER__zChildFields__c")) { //ERS190811 not in all MPs
        pairs=zData.clientFields(doc,pairs,XCustomSetting(doc,"ZPAPER__zChildFields__c")); //ERS190803 #52661 using JSON child record type id
    }
    pairs.push("ZPAPER__Parent__c", parentId);
    //ERS201128 should be in zChildFields if (zData.childStackRecordType) pairs.push("RecordTypeId",zData.childStackRecordType);
    
    //pairs.push(""+"Program__c",zData.programName); //ERS200205 TODO in package and into base call //SHR201202 #79257
    pairs.push(""+"ZPAPER__Program_Name__c",zData.programName); //SHR201202 #79257 use the Program_Name field instead of Program__c
    //ERS200229 if (zData.patientId) pairs.push("Program_Member_MVN__c",zData.patientId); //ERS200205 Program_Member_MVN__c was the TICKET!!!
    alert("ERS190811.191 ZPAPER__Parent__c"+ parentId+" child zData.childStackRecordType="+zData.childStackRecordType);
    if (zData['RecordTypeId']) {  zData.childStackRecordType=zData['RecordTypeId']; } //ERS201129 #78830 TODO not sure where this is used elsewhere
    alert("ERS201129.292 ZPAPER__Parent__c"+ parentId+" child RecordTypeId="+zData['RecordTypeId']);
    var childStackSFId = createAndAttach(doc, "ZPAPER__zStack__c", "zStack split on " + zData.formatNow, pairs) + "";
    
    if (!zData.patientId && X(doc,"X_ZPAPER__PatientAccount__c") ){ //ERS200308 HACK
        zData.patientId=X(doc,"X_ZPAPER__PatientAccount__c");
        alert("ERS200308 WHY NOT in zData?");
    }
    
    if (zData.patientId && zData.CarePlanTaskRT) { //ERS210221 #76975 deployment setting //ERS200308 create an Activity Event related to the Patient (Account) for the Timeline
        if (!zData.docType && X(doc,"X_ZPAPER__faxType__c")) zData.docType=X(doc,"X_ZPAPER__faxType__c");
        var arr=[];
        //NOT SELECT AccountId,ActivityDate,CreatedDate,Status,Subject,TaskSubtype,WhatId,WhoId FROM Task where ActivityDate > 2020-02-01
        //SELECT Id,AccountId,ActivityDate,CreatedDate,Subject,WhatId,WhoId FROM Event where Id = '00U4T000002vChrUAE'
        //arr.push("WhoId",zData.patientId); //ERS200310 timeline trick
        if (zData.patientId.indexOf("001")==0) {
            arr.push("WhatId",zData.patientId); //ERS200310 timeline trick
            //arr.push("AccountId",zData.patientId); //ERS200310 timeline trick
        } else if (zData.caseId) arr.push("WhatId",zData.caseId);
        else if (zData.providerId) arr.push("WhatId",zData.providerId);
        else arr.push("WhatId",childStackSFId);
        //arr.push("TaskSubtype","Task");
        arr.push("Subject",zData.stage + " "+zData.docType);
        arr.push("Description","Check out "+doc.dbID);
        //arr.push("ActivityDateTime",zData.formatNow); //ERS200309 hacking away!
        arr.push("ActivityDate",zData.formatNow.substring(0,10));
        arr.push("RecordTypeId",zData.CarePlanTaskRT); //ERS210221 #76975 "0124T0000008aFmQAI" //ERS200310 HACK for Task on CarePlan
        //arr.push("DurationInMinutes","5");
        //arr.push("Status","Completed");
        
        var label="Timeline "+zData.docType;
        var actId = createSFRecord(doc, "Task", null, arr); //ERS200309 null means no Name field
        //var actId = createSFRecord(doc, "Event", null, arr); //ERS200309 null means no Name field
        alert("ERS200308.262 timeline activity "+actId);
    } else { alert("ERS200308.263 be worried there is no patient!"); }
    
    if (1===1 && zData.clientReceivedDocument) { zData.recDocId=zData.clientReceivedDocument(doc,childStackSFId); } //ERS201018 #77252
    return childStackSFId;
};


zData.clientStackComplete=function(doc,arrOfPairs,zd) { //ERS200314 #70336
    if (!zd) zd=zData; //ERS200406 #71156
    arrOfPairs.push("Time_Complete_Date__c",zd.formatNow); //for dashboard
    return arrOfPairs;
}; //ERS190625

zData.clientCasePA=function(doc,zd) { //ERS210320 #81327 example zChannel action triggered
    if (!zd) zd=zData; //ERS200406 #71156
    alert(zd.zchannel.action + " fired on "+zd.zchannel.path+" with doc.dbID="+doc.dbID+" on zStack="+zd.stackId);
    return true;
}; //ERS190625

zData.clientLightningFile=function(doc,sfIds,zd) {
    if(X(doc,"ContactFax") != "PDF") {
       return;
    }
    if (!zd) zd = zData;

    var zserver = doc.kbData.sfServer.indexOf("https://") == 0 ? doc.kbData.sfServer : "https://" + doc.kbData.sfServer;
    // Salesforce REST API endpoint
    var docurl = zserver + "/services/data/v46.0/sobjects/ContentVersion/";
    var pdfurl = "https://gw.zpaper.com/kb/jsp/SF_find.lightning.jsp?go=SF_files.jsp&dbID=" + doc.dbID + "&SForg=" + doc.kbData.sfOrganizationID;

    // Generate PDF file from zStack
    var formatNow = getCurDateAndTime(doc, false, true); // e.g. "20210210-052132"?
    var arrOfPairs = [];
    var nowTimeStamp = new Date().getTime() + "";
    //var fileName = !accname && !faxtype ? doc.label : accname + " - " + faxtype + " - " + datestr;
    var accname = X(doc, "X_ZPAPER__PatientAccount__r.Name");
    var faxtype = X(doc, "X_ZPAPER__faxType__c");
    var datestr = getCurDate(doc);
    if(!faxtype)//PV210318
     faxtype = zData.docType; //PV210318 added it for to update doctype on Lightning files
     if(!accname)
        accname = X(doc, "X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c"); //PV210318
        
   alert("@FileName " + X(doc, "coverBATES")); //PV220922 added alert for FileName  
    var fileName = (X(doc, "coverBATES") == null || X(doc, "coverBATES") == '' || X(doc, "coverBATES") == " ") ? X(doc, "docTitle") : X(doc, "coverBATES"); //PV220616
    alert("@fileName after assigning" + X(doc, "docTitle"));
    if(fileName && (fileName == "2010020223210073215_Form"  || fileName == "2010020223004143013_Form" || fileName== "2010920224212144255_Form")) {
        fileName = "FaxCover";  //SP220817 
    } else{
        fileName = doc.label + " - " + datestr; 
    }
    fileName += ".pdf";
    //var fileName = getCurDate(doc) + " New Fax.pdf"; // e.g - "20210210 New Fax.pdf"?
    alert("@@@fileName = " + fileName);
    zData.uploadDir = 'zStackUploadRoot'; //setting root directory for file creation
    
    var docarrOfPairs = []; //PV220622
    docarrOfPairs.push("LEAP_FileType__c", "FaxCover");
    if(sfdocId) {
        alert("Updating LEAP_FileType__c to FaxCover for doc id:"+sfdocId);
        updateSFRecord(doc, "ContentVersion", sfdocId, docarrOfPairs);
    }

    // create directory to place generated PDF file
    createDirectory(doc, zData.uploadDir, nowTimeStamp);

    var xPages = X(doc, "X_position"); //get X_position - page range selected; default = all pages
    alert("@@@@@ Calling splitPDF to split off pages to upload as PDF, pages = " + xPages + ", nowTimeStamp = " + nowTimeStamp);
   if(!xPages){
    xPages="1-99" //PV221214 updated
    }
    var response = splitPDF(doc, xPages, zData.uploadDir, nowTimeStamp, fileName);
    alert("@@@@ response from splitPDF = " + response);
    var newPDFName = X(doc, "newPDF", response); // set value of newPDF

    alert("@@@@ split PDF FileName = " + newPDFName);

    //var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid=" + sfIds[0] + "&SForg=" + doc.kbData.sfOrganizationID + "&label=" + fileName + "&serverFile=" + newPDFName + "&Description=File attached as PDF";//PV210423 updated URL
     var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid=" + sfIds[0] + "&SFServer=" + doc.kbData.sfServer + "&SFSession=" + doc.kbData.sfSessionID + "&label=" + fileName + "&serverFile=" + newPDFName + "&Description=File attached as PDF";//PV210511 updated URL
    alert("#### Upload native PDF with " + uploadURL);

    var r = wget(doc, uploadURL); // ????? will r contain the ContentDocument id?

    alert('value from wget response >>> ' + r);

    var idxBegin = r.indexOf("<sfID>");
    var idxEnd = r.indexOf("</sfID>");
    var sfdocId;
    if (idxEnd > idxBegin) {
        sfdocId = r.substring(idxBegin + 6, idxEnd);
        alert("sfDocId extracted from r : " + sfdocId);
    }
    
    /*var docarrOfPairs = []; //PV220622
    docarrOfPairs.push("LEAP_FileType__c", "FaxCover");
    if(sfdocId) {
        alert("Updating LEAP_FileType__c to FaxCover for doc id:"+sfdocId);
        updateSFRecord(doc, "ContentVersion", sfdocId, docarrOfPairs);
    }*/


    // Finally, delete the folder and all contents.
    cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);
    
    var headers = [
        "Authorization", "Bearer " + doc.kbData.sfSessionID,
        "Content-Type", "application/json"
    ];
    docurl = zserver + '/services/data/v49.0/sobjects/ContentDocumentLink/';
    for (var index = 1; index < sfIds.length; index++) {
        //sharing files with other records
        try {
            var currentContentDocumentLinkRecord = {
                "ContentDocumentId": sfdocId,
                "LinkedEntityId": sfIds[index],
                "ShareType": "I"
            };
            body = JSON.stringify(currentContentDocumentLinkRecord);
            res = wpost(doc, docurl, [], headers, body);
        } catch (errs) {
            alert(errs);
        }
    }
    
    return null;
}
zData.clientOutboundLightningFile=function(doc,sfId,zd) {//PS23118 added for content document link 
    alert(sfId);
	//if (!zd) zd = zData;
	var fileName = (X(doc, "coverBATES") == null || X(doc, "coverBATES") == '' || X(doc, "coverBATES") == " ") ? X(doc, "docTitle") : X(doc, "coverBATES");
	var pdfurl = "https://gw.zpaper.com/kb/jsp/SF_find.lightning.jsp?go=SF_files.jsp&dbID=" + doc.dbID + "&SForg=" + doc.kbData.sfOrganizationID;
	alert("Inside clientOutboundLightningFile");
	var arrOfPairs = [];
	arrOfPairs.push("Title", doc.label);
	arrOfPairs.push("LEAP_FileType__c", "OutboundFax");
	arrOfPairs.push("LEAP_FileCategory__c", "Outbound");
	arrOfPairs.push("ContentUrl", pdfurl);
	var contentVersionId = createSFRecord(doc, "ContentVersion", null, arrOfPairs);
	
	var contentDocumentId = getSFField(doc, "ContentVersion", "ContentDocumentId", null, contentVersionId);
	
	arrOfPairs = [];
	arrOfPairs.push("ContentDocumentId", contentDocumentId);
	arrOfPairs.push("LinkedEntityId", sfId);
	arrOfPairs.push("ShareType", "I");
	var contentDocumentLinkId = createSFRecord(doc, "ContentDocumentLink", null, arrOfPairs);
	
	//Share with Case record
	/*var caseId = getSFField(doc, "LEAP_Outbound_Correspondence_Request__c", "LEAP_Case__c" , null, sfId);
	if(caseId) {
    	arrOfPairs = [];
    	arrOfPairs.push("ContentDocumentId", contentDocumentId);
    	arrOfPairs.push("LinkedEntityId", caseId);
    	arrOfPairs.push("ShareType", "I");
    	var contentDocumentLinkId = createSFRecord(doc, "ContentDocumentLink", null, arrOfPairs);
	}*///PV230201
}
alert("end client library"); //ERS190615 #58921

//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
//--- RULE VALIDATION CODE - END ---

</script>
