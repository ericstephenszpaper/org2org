<!--
// Name: Client Library
// Committer: atharwa.samant@sparsolutions.com
// Update: AHS220809 - moving acccount validation before product validation
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2022-08-09 14:50:08","evalContinue":"true","active":true,"button":"","name":"Client Library","conditions":{"logic":"and","arguments":[{"name":"doc.status","value":"DoNotClient","operation":"not-contains"}]},"consequence":{"doit":"YWxlcnQoInN0YXJ0IGNsaWVudCBsaWJyYXJ5Iik7IC8vRVJTMTkwODAzICM1MjY2MSBmcm9tIE9jY0ZpdAovL0VSUzIwMTExNyBUT0RPIGdldCByaWQgb2ZmIHRoZXNlIGtleXdvcmRzIGFuZCB1c2UgYSBkb2N1bWVudCBqb3VybmV5IHdpemFyZCBmcm9tIEtQUyBhbmQgSmFrZQoKLy9DUk4yMDEwMjUgIzc2Nzg4IE1vdmVkIGZyb20gelN0YWNrIExpYnJhcnkgc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBpbiBtdWx0aXBsZSBydWxlcy4KdmFyIGtleXdvcmRNYXA9e307CnZhciBrZXl3b3Jkcz1bIk5FVzpEb2N1bWVudCBTdGFja34iLCJFTlJMOkVucm9sbG1lbnR+IiwiRU5STDpFTlJPTExNRU5UfiIsIkNPTlM6Q29uc2VudH4iLCJDT046Y29uc2VudH4iLCJGQUM6U2V0dGluZ34iLCJGQUM6RGlzdHJpYnV0aW9ufiIsIlNUQVJUOlN0YXJ0IEZvcm1+IiwiQ0hLOkNoZWNrbGlzdH4iLCJISVBBQTpBVVRIT1JJWkFUSU9OfiIsIkhJUEFBOkhJUEFBfiIsIkhJUEFBOlBPUlRBQklMSVRZfiIsIlJFRjpSRUZFUlJBTCIsIlJFRjpSZWZlcnJhbCIsIkZJTjpXMn4iLCJJQzpNZW1iZXIgSUR+IiwiRkFYOiJdOwovL2tleXdvcmRNYXBbIlRFTlIiXSA9IlRFTlI6U3RhcnQgRm9ybSI7CmtleXdvcmRNYXBbIk5FVyJdID0iTkVXOkRvY3VtZW50IFN0YWNrIjsKa2V5d29yZE1hcFsiRU5STCJdID0iRU5STDpFbnJvbGxtZW50IEZvcm0iOwprZXl3b3JkTWFwWyJGQUMiXSA9IkZBQzpGYWNpbGl0eSBFbnJvbGxtZW50IEZvcm0iOwprZXl3b3JkTWFwWyJGQVgiXSA9Ik5FVzpEb2N1bWVudCBTdGFjayI7Ci8va2V5d29yZE1hcFsiU1RBUlQiXSA9Ik5FVzpEb2N1bWVudCBTdGFjayI7CmtleXdvcmRNYXBbIkNPTiJdID0iQ09OOkNvbnNlbnQgRm9ybSI7CmtleXdvcmRNYXBbIkhJUEFBIl0gPSJISVBBQTpISVBBQSBBdXRob3JpemF0aW9uIjsKa2V5d29yZE1hcFsiUkVGIl0gPSJSRUY6UmVmZXJyYWwiOwprZXl3b3JkTWFwWyJGVzIiXSA9IkZXMjpXLTIiOyAvL0pQQjIwMTAyMyBhZGRlZAprZXl3b3JkTWFwWyJJOSJdID0iSTk6SS05IjsgLy9KUEIyMDEwMjMgYWRkZWQKa2V5d29yZE1hcFsiVzQiXSA9Ilc0OlctNCI7IC8vSlBCMjAxMDIzIGFkZGVkCmtleXdvcmRNYXBbIkRFTSJdID0iREVNOkRlbW9ncmFwaGljcyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIkNMSU4iXSA9IkNMSU46Q2xpbmljYWwgTm90ZXMiOyAvL0NSTjIwMTAyNiBhZGRlZAprZXl3b3JkTWFwWyJGSU4iXSA9IkZJTjpGaW5hbmNpYWwgSW5mbyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIklDIl0gPSJJQzpJbnN1cmFuY2UgQ2FyZCI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIkNPTlMiXSA9IkNPTlM6Q29uc2VudCI7Cgp6RGF0YS5tYXhDaGFubmVscz0zOyAvL0VSUzE5MDczMSAjNjEyNzIgemlwcGkgaXMgc3Ryb25nbHkgdHlwZWQKekRhdGEubWFrZVN0YWNrPXRydWU7IC8vRVJTMTkwODE0ICM2MTUxMQoKekRhdGEud2F0ZXJtYXJrPSIiK1hDdXN0b21TZXR0aW5nKGRvYywid2F0ZXJtYXJrX19jIik7IC8vRVJTMTkwNjE4IGJlc3QgcHJhY3RpY2UKLy9hbGVydCgiRVJTMTkwNDExIHdtPSIrekRhdGEud2F0ZXJtYXJrKyIgWlBBUEVSX19zZXJ2ZXJfX2M9IitYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fc2VydmVyX19jIikpOwp6RGF0YS51cGxvYWREaXIgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInVwbG9hZERpcl9fYyIpOyAvLyJhbGtlcm1lc1Jvb3QiOwp6RGF0YS5wYXRFbnJvbGxRdWV1ZUlkID0gIiIrWEN1c3RvbVNldHRpbmcoZG9jLCJwYXRpZW50UXVldWVJZF9fYyIpOyAvLycwMEc0QzAwMDAwMExrbVonOyAvL2luc2VydCB0aGUgUXVldWUgSUQgb2YgdGhlIGRlc2lyZWQgb3duZXJzaGlwIHF1ZXVlLiBVcGRhdGUgd2hlbiBtaWdyYXRpbmcgYmV0d2VlbiBlbnZpcm9ubWVudHMuIE5lZWQgdG8gYWRkIHRoaXMgcXVldWUgaW4gU2V0dXAKekRhdGEucmVjVHlwZVJlcXVlc3QgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInJlY1R5cGVSZXF1ZXN0X19jIik7IC8vJzAxMjRDMDAwMDAwQ2o1WSc7IC8vSUQgb2YgdGhlIENhc2UgUmVjb3JkIFR5cGUgUmVxdWVzdF9QU19NVk4KLy9UT0RPIHpEYXRhLmtleXdvcmRNYXBbIkVOUkwiXSA9IkVOUkw6RW5yb2xsbWVudCBGb3JtIjsgIC8vVE9ETyBnZXQgZnJvbSB6U3RhY2sgcGlja2xpc3RzCi8vVE9ETyB6RGF0YS5rZXl3b3JkTWFwWyJGQUMiXSA9IkZBQzpGYWNpbGl0eSBFbnJvbGxtZW50IEZvcm0iOwovL0VSUzIwMDIwNSBkZWxldGVkIGRlbW8gZGF0YSAtIGRvIHdpdGggY3VzdG9tIHNldHRpbmdzCgp2YXIgY3M9WERlcGxveW1lbnRJbmZvKGRvYywgIkJ1c2luZXNzX1Byb2Nlc3NfX2MiKTsgLy9FUlMyMDAyMjIgbmVlZCBib3RoIGRlcGxveW1lbnQgaW5mbyBhbmQgY3MKLy9hbGVydCgiY3M9Iitjcyk7CmlmIChjcykgewogICAgaWYgKGNzLmluZGV4T2YoInpDdXN0b21TZXR0aW5ncyIpPi0xKSBjcz1YKGRvYywiekN1c3RvbVNldHRpbmdzIixjcyk7CiAgICBhbGVydCgiRVJTMjAwMjI1IEVWQUwgb24gIitjcyk7CiAgICBpZiAoY3MgIT09ICIiKSBldmFsKCIiK2NzKTsgLy9FUlMyMDAyMjIgVE9ETyBKU09OLnBhcnNlKCkgLy9FUlMyMDAyMjUgYmVlZHMgdG8gYmUgZXZhbCBidXQgYWxzbyBuZWVkcyB0byB3b3JrISEhCiAgICBhbGVydCgiTm8gdHJ5IGp1c3QgZG8hIik7Cn0KCmlmICgxPT09MCAmJiAhekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGUpIHsgLy9UT0RPIGN1c3RvbSBzZXR0aW5nIG9yIGRlcGxveW1lbnQ/IC8vRVJTMjAxMTI5IERPTkUgaW4gekNoaWxkRmllbGRzCiAgICBhbGVydCgiRVJTMjAxMTI4IHNob3VsZCBiZSBpbiBjdXN0b20gc2V0dGluZ3MgekNoaWxkRmllbGRzIik7CiAgICB6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZT0iMDEyMTEwMDAwMDFnQnMzQUFFIjsgLy9FUlMyMDExMjggc2hvdWxkIGJlIGluIGN1c3RvbSBzZXR0aW5ncyB6Q2hpbGRGaWVsZHMgIjAxMjBSMDAwMDAxTjJvSSI7Cn0KCnpEYXRhLmNsaWVudEltcG9ydFNPUUw9ZnVuY3Rpb24oZG9jLGZyb21GaWxlKSB7IC8vRVJTMTkwNzA2IGN1c3RvbWl6ZSBpbXBvcnRzIHVzZWQgYnkgQ3JlYXRlIFN0YWNrCiAgICB6RGF0YS5pbXBvcnRlcj1YQ3VzdG9tU2V0dGluZyhkb2MsekRhdGEuenArIkltcG9ydGVyX19jIikudHJpbSgpOwogICAgdmFyIHNmSWQ9IiI7CiAgICB2YXIgcGFydHM9ZnJvbUZpbGUuc3BsaXQoIl8iKTsKICAgIC8vc2ZJZCA9IGdldFNGUmVjb3JkSUQoZG9jLCAiQWNjb3VudCIsIHsgIkZheCIgOiBwYXJ0c1szXSB9ICk7CiAgICB6RGF0YS5tYWtlU3RhY2s9dHJ1ZTsgLy9kbyBhbGwgdGhlIHdvcmsgdGhlcmUgYnkgZGVmYXVsdAogICAgcmV0dXJuIHNmSWQ7Cn07CgovL2FsZXJ0KCJ6RGF0YS5jbGllbnRTdGFjayIpOwp6RGF0YS5jbGllbnRTdGFjaz1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycykgeyAvL3pEYXRhIG9yIHRoaXM/CiAgICB2YXIgenA9ekRhdGEuenA7IGlmICghenApIHpwPSJaUEFQRVJfXyI7IC8vRVJTMTkwODA1IAogIGlmICh6RGF0YS5yZWNlaXZlZCkgYXJyT2ZQYWlycy5wdXNoKCJ6U3RhY2tfUmVjZWl2ZWRfX2MiLCB6RGF0YS5mb3JtYXROb3cpOyAvL0VSUzE5MDYxNyBUT0RPIHNhdmUgd2F5IHRvIGRvIHRoaXMKICBpZiAoekRhdGEub3duZXJJZCkgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIix6RGF0YS5vd25lcklkKTsgIC8vIHpDaGFydGEgUXVldWUgIjAwRzM2MDAwMDAyQ3lUSyIgCiAgaWYgKHpEYXRhLmNhbGxlcklkKSBhcnJPZlBhaXJzLnB1c2goInpDYWxsZXJfSURfX2MiLCBkb2MuZGVsaXZlcmVkRnJvbSk7IC8vTVNIMTcwODE3IGFkZGVkCiAgaWYgKHpEYXRhLnBhdEVucm9sbFF1ZXVlSWQpIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsekRhdGEucGF0RW5yb2xsUXVldWVJZCk7CiAgCiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fZmF4VHlwZV9fYyIsIHpEYXRhLmRvY1R5cGUpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIiwgekRhdGEuY2xhc3NpZmljYXRpb24pOwogICAgdmFyIHBhZ2VSYW5nZSA9IFgoZG9jLCJYX2lkeFBhZ2VzIik7CiAgICBpZiAoIXBhZ2VSYW5nZSkgcGFnZVJhbmdlPSIxLSIrWChkb2MsIlhfcGFnZXMiKTsgCiAgICB2YXIgcGFnZUNvdW50ID0gekRhdGEuY291bnRQYWdlcyhkb2MsIHBhZ2VSYW5nZSk7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fcmVjZWl2ZWRJZF9fYyIsIGRvYy5kYklEKTsgLy9FUlMxOTA4MTQgCiAgICAvL0VSUzE5MDgxMCBUT0RPPyBhcnJPZlBhaXJzLnB1c2goIlpTVEFDS19fUmVjZWl2ZWRfX2MiLCB6RGF0YS5mb3JtYXROb3cpOwogICAgYWxlcnQoIkVSUzIwMDIxMy41MSBwYWdlUmFnZT0iK3BhZ2VSYW5nZSArICIgYnV0IHBhZ2VDb3VudD0iK3BhZ2VDb3VudCk7IC8vRVJTMjAwMjEzIGFsc28gY2FsbGVkIGluIG5ldyBpbmNvbWluZyBzdGFjawogICAgaWYgKCFYKGRvYywiWF9pZHhQYWdlcyIpKSBwYWdlQ291bnQ9WChkb2MsIlhfcGFnZXMiKTsgLy9FUlMyMDAyMTMgVE9ETyBmaXggekRhdGEuY291bnRQYWdlcygpCiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGFnZXNfX2MiLCBwYWdlQ291bnQpOwogICAgCiAgICAvL0VSUzIwMDIwNCBUT0RPIHpTdGFjay5Qcm9ncmFtPwoKICAgIGlmICh6RGF0YS5wcm9ncmFtTmFtZSA9PT0gekRhdGEuUFJPR1JBTV9aQ0hBUlRBKSB7IC8vSlBCMjAxMDIzIGNoYW5nZWQgZnJvbSBjbGFzc2lmaWNhdGlvbiB0byBwcm9ncmFtTmFtZQogICAgICBhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIlVyZ2VudCIpOyAvL0pQQjE5MDQyNiBjaGFuZ2VkIHRvIGNsYXNzaWZpY2F0aW9uIGZyb20gcHJvZ3JhbQogICAgfSBlbHNlIGlmICh6RGF0YS5wcm9ncmFtTmFtZSA9PT0gekRhdGEuUFJPR1JBTV9aUEFQWVJVUykgeyAvL0pQQjIwMTAyMyBjaGFuZ2VkIGZyb20gY2xhc3NpZmljYXRpb24gdG8gcHJvZ3JhbU5hbWUKICAgICAgYXJyT2ZQYWlycy5wdXNoKHpwKyJQcmlvcml0eV9fYyIsICJIaWdoIik7IAogICAgfSBlbHNlIGlmICh6RGF0YS5wcm9ncmFtTmFtZSA9PT0gekRhdGEuUFJPR1JBTV9aQ0FSVEEpIHsgLy9KUEIyMDEwMjMgY2hhbmdlZCBmcm9tIGNsYXNzaWZpY2F0aW9uIHRvIHByb2dyYW1OYW1lCiAgICAgIGFyck9mUGFpcnMucHVzaCh6cCsiUHJpb3JpdHlfX2MiLCAiQ3JpdGljYWwiKTsgIAogICAgfSBlbHNlIHsKICAgICAgYXJyT2ZQYWlycy5wdXNoKHpwKyJQcmlvcml0eV9fYyIsICJOb3JtYWwiKTsKICAgIH0KICAgIAogICAgYXJyT2ZQYWlycy5wdXNoKHpwKyJzZW50RmF4VG9fX2MiLCAoIkNvbW11bml0eSIgPT09IHpEYXRhLmNoYW5uZWwgPyB6RGF0YS5jaGFubmVsIDogZG9jLmRlbGl2ZXJlZFRvKSk7IC8vSlBCMTkwNTI5IGFkZGVkIHNvIENvbW11bml0eSBzaG93cyB1cCBpbiBNYXN0ZXIgSW50YWtlIExpc3QKICAgIGFyck9mUGFpcnMucHVzaCh6cCsiRnJvbV9fYyIsZG9jLmRlbGl2ZXJlZEZyb20pOwogICAgaWYgKHpEYXRhLnJldmlld2VkU3RhdHVzKSB7YXJyT2ZQYWlycy5wdXNoKHpwKyJTdGFnZV9fYyIsIHpEYXRhLnJldmlld2VkU3RhdHVzKTsgfSAKICAgIGVsc2UgeyBhcnJPZlBhaXJzLnB1c2goenArIlN0YWdlX19jIiwgIlJlY2VpdmVkIik7IH0KICAgIHpEYXRhLnN0YWNrUGFpcnM9YXJyT2ZQYWlyczsgLy9FUlMxOTA4MTAgIzYxNTcwIGZvciBjaGlsZCBzdGFjayBsYXRlcgogICAgYXJyT2ZQYWlycz16RGF0YS5jbGllbnRGaWVsZHMoZG9jLGFyck9mUGFpcnMsWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX3pTdGFja0ZpZWxkc19fYyIpKTsgLy9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04gCiAgcmV0dXJuIGFyck9mUGFpcnM7Cn07CgovL2FsZXJ0KCJ6RGF0YS5jbGllbnRGaWxlIik7CnpEYXRhLmNsaWVudEZpbGU9ZnVuY3Rpb24oZG9jLHN0YWdlKSB7IC8vRVJTMTcwODI5ICM0MTI5OCByZXR1cm5zIGEgbGFiZWwgdG8gYmUgdXNlZCBpbiBhbnkgYXR0YWNoZXMgYW5kIGZpeGVzIHRoZSBkb2MKICAgIC8vRG9jdW1lbnQgYXR0YWNobWVudCBsYWJlbCBzaG91bGQgYmUgIlBhdGllbnQgTmFtZSAtIERvYyBUeXBlIC0gRGF0ZSIuICBDb25maXJtZWQgZm9yIHpQYXBlciBGaWxlIGFuZCBTRkRDIEF0dGFjaG1lbnQKICAgIHZhciBNTWRkWVlZWSA9IHpEYXRhLmZvcm1hdFRvZGF5TU1kZFlZWVkoKTsKICAgIC8vQ1JOMjAxMDI1ICM3Njc4OCBGaXhlZCB0byBtYXRjaCB0aGUgY3VycmVudCBkZW1vLgogICAgdmFyIHBhdGllbnROYW1lID0gWChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIik7CiAgICBpZiAoIXBhdGllbnROYW1lKSB7CiAgICAgICAgcGF0aWVudE5hbWUgPSBYKGRvYywiWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyIpICsgIiAiICsgWChkb2MsICJYX1pQQVBFUl9fTGFzdE5hbWVfX2MiKTsKICAgIH0KICAgIHZhciBmYXhUeXBlID0ga2V5d29yZE1hcFtYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKV07CiAgICBpZiAoIWZheFR5cGUpIHsgZmF4VHlwZSA9IFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOyB9CiAgICBpZiAoIWZheFR5cGUuaW5kZXhPZignOicpID49IDApIHsgZmF4VHlwZSA9IGZheFR5cGUuc3BsaXQoJzonKVsxXTsgfQogICAgLy8gZG9jLmxhYmVsID0gcGF0aWVudE5hbWUgKyAiIC0gIiArIGZheFR5cGUgKyAiIC0gIiArIE1NZGRZWVlZOwogICAgZG9jLmxhYmVsID0gcGF0aWVudE5hbWUgKyAiIC0gIiArIGZheFR5cGU7CiAgICBpZiAoIXBhdGllbnROYW1lIHx8IHBhdGllbnROYW1lLmxlbmd0aDw1KSB7IC8vRVJTMjAxMTI5ICM3ODgzMAogICAgICAgIGRvYy5sYWJlbD0iU3BsaXQgZnJvbSAiK1goZG9jLCJYX3NwbGl0UGFnZXMiKSsiIG9mICIrIFgoZG9jLCJYX2Zyb21QYWdlcyIpICsiIC0gIitNTWRkWVlZWTsKICAgICAgICBkb2MubGFiZWw9IlNwbGl0IGZyb20gIisgWChkb2MsIlhfZnJvbVBhZ2VzIikgKyIgLSAiK01NZGRZWVlZOyAKICAgIH0gCiAgICBhbGVydCgiRVJTMTcwODI5IGRiSUQ9Iitkb2MuZGJJRCsiIGxhYmVsPSIrZG9jLmxhYmVsKTsKICAgIGlmICh6RGF0YS5zZklEICAmJiB6RGF0YS5zZklELmluZGV4T2YoIjUwMCIpPT09MCkgewogICAgICB6RGF0YS5wcm92aWRlciA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJBY2NvdW50Lk5hbWUiLCBudWxsLCB6RGF0YS5zZklEKTsgCiAgICAgIGxhYmVsID0gIlJlY2VpdmVkIGZyb20gIiArIHpEYXRhLnByb3ZpZGVyOwogICAgICAgIGlmICh6RGF0YS5mYWNpbGl0eSkgewogICAgICAgICAgICB6RGF0YS5mYWNpbGl0eSA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJBY2NvdW50LkZhY2lsaXR5X19yLk5hbWUiLCBudWxsLCB6RGF0YS5zZklEKTsKICAgICAgICAgICAgZG9jLmxhYmVsKz0iIGF0ICIrekRhdGEuZmFjaWxpdHk7CiAgICAgICAgfQogIH0KICB2YXIgYXJyT2ZQYWlycyA9IFtdOwogICAgYXJyT2ZQYWlycy5wdXNoKCJkYi1sYWJlbCIsIGRvYy5sYWJlbCk7CiAgdXBkYXRlREIoZG9jLGFyck9mUGFpcnMpOwogICAgcmV0dXJuIGRvYy5sYWJlbDsKfTsKCnpEYXRhLmNsaWVudFZhbHVlPWZ1bmN0aW9uKGRvYyx2YWwpIHsvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiAKICAgIHZhbD12YWwucmVwbGFjZSgieyFmb3JtYXROb3d9Iix6RGF0YS5mb3JtYXROb3cpOwogICAgcmV0dXJuIHZhbDsKfQoKekRhdGEuY2xpZW50RmllbGRzPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLGpkLHpkKSB7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OIGluIHNldHRpbmcgdG8gY29uZmlndXJlIG5ldyByZWNvcmQKICAgIGlmICghemQpIHpkPXpEYXRhOwogIGlmIChqZCAmJiBqZC5pbmRleE9mKCJ7Iik9PT0wKSB7IAogICAgICAvL3siVHlwZSI6IkVsaWdpYmlsaXR5IiwiT3duZXJJZCI6IjAwR2MwMDAwMDAzdmdxdyIsIlJlY29yZFR5cGVJZCI6IjAxMjZBMDAwMDAwSkVLZVFBTyJ9OwogICAgICAvL05PVCBBIEdPT0QgSURFQSBqZD1qZC5yZXBsYWNlQWxsKCJcIiIsIiciKTsgLy9FUlMxOTA4MTEgIzYxNTcwIEhBQ0s/CiAgICAgIGpkPWpkLnJlcGxhY2UoIn07IiwifSIpOyAvL0VSUzIwMTEyOSBTSFIgdG8gd29yayBvdXQgZGVzaWduIG9uIGNoYW5uZWwgd2l6YXJkIGZvciB6U3RhY2sgY2hpbGQgc2V0IEFTQVAKICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBqZGF0YT1KU09OLnBhcnNlKGpkKTsgLy9FUlMxOTA4MDUgYmV0dGVyIHRoYW4gZXZhbAogICAgICAgICAgZm9yICh2YXIgbiBpbiBqZGF0YSkgewogICAgICAgICAgICAgIHZhciB2MD1qZGF0YVtuXTsgCiAgICAgICAgICAgICAgdmFyIHY9ekRhdGEuY2xpZW50VmFsdWUoZG9jLHYwKTsgLy9FUlMxOTA4MTEgLHYgbm93ICx2MAogICAgICAgICAgICAgIGFsZXJ0KCJFUlMxOTA4MDMuOTcgIituKyI9Iit2MCsiPSIrdik7IAogICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaChuLHYpOyAvL0VSUzE5MDgxMSBhZGRlZCAucHVzaAogICAgICAgICAgICAgIHpkW25dPXY7IC8vRVJTMjAxMTI5ICM3ODgzMCBUT0RPIHJldmlldyBhcnJPZlBhaXJzIGFjY2VzcyB1c2luZyBmb3IgUmVjb3JkVHlwZUlkCiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGFsZXJ0KCJKU09OIG5vdCBpbiAiK2pkKyIgRXhjZXB0aW9uOiAiK2UpOyAvL0VSUzE5MDgxMSBhZGRlZCBlCiAgICAgIH0KICB9CiAgcmV0dXJuIGFyck9mUGFpcnM7Cn0KCgp6RGF0YS5jbGllbnRDYXNlPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7CiAgaWYgKCF6ZCkgemQ9ekRhdGE7CiAgaWYgKCF6ZC50cmlhZ2VUeXBlICYmIFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpKSB6ZC50cmlhZ2VUeXBlPVgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOyAvL0VSUzIwMDMwOAogIGlmICghbGFiZWwpIHsgbGFiZWw9IkluZGV4ZWQtIiArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KICAKICBhbGVydCgiRVJTMjAwMzA4LjEyOCBuZXcgQ2FzZSBwcm92aWRlcklkPSIremQucHJvdmlkZXJJZCsiIHBhdGllbnRJZD0iK3pkLnBhdGllbnRJZCk7CiAgCiAgLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7CiAgaWYgKHpkLmNvbnRhY3RJZCkgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCB6ZC5jb250YWN0SWQpOwogIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19uZXdGYXhfX2MiLCAidHJ1ZSIpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2xhdGVzdEZheF9fYyIsIHpkLmZvcm1hdE5vdyk7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fcmVjZWl2ZWRJZF9fYyIsIGRvYy5kYklEKTsgLy9FUlMxOTA4MTQgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIGFyck9mUGFpcnMucHVzaCgiU3RhdHVzIiwgWChkb2MsIlhfU3RhdHVzIikpOwogIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIix6ZC50cmlhZ2VUeXBlKTsgLy9FUlMyMDAzMDgKICAvL0VSUzIwMDIwNSBhcnJPZlBhaXJzLnB1c2goIlR5cGUiLCAiTmV3ICIremQuY2xhc3NpZmljYXRpb24pOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiAgLy9FUlMyMDAzMDggYXJyT2ZQYWlycy5wdXNoKCJUeXBlIiwgIk5ldyAiK3pkLmRvY1R5cGUpOwogIGlmICgxPT0xKSB7IC8vRVJTMTcwNTIzICMzNzE2MiBhZnRlciBkcnlydW4KICAgICAgYWxlcnQoIkBAQCB6ZC5wcmlvcml0eSA9PiAqIiArIHpkLnByaW9yaXR5ICsgIioiKTsKICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTJRMDAwMDAwMDVBaGoiKTsgLy9FUlMxNzA1MjMgUHJpb3IgQXV0aAogICAgaWYgKHpkLnByaW9yaXR5ICE9ICJOb3JtYWwiKSB7IGFyck9mUGFpcnMucHVzaCgiUHJpb3JpdHkiLHpkLnByaW9yaXR5KTsgfSAgLy9FUlMxNzA1MjQgIzM3MTYyIHByaW9yaXR5IG9uIENhc2UKICAgIGVsc2UgeyBhcnJPZlBhaXJzLnB1c2goIlByaW9yaXR5IiwiTWVkaXVtIik7IH0KICAgIGFyck9mUGFpcnMucHVzaCgiT3JpZ2luIiwiRmF4Iik7IC8vRVJTYTIwMDIwNSByck9mUGFpcnMucHVzaCgiT3JpZ2luIix6ZC5jaGFubmVsKTsKICB9CiAgICBhcnJPZlBhaXJzPXpEYXRhLmNsaWVudEZpZWxkcyhkb2MsYXJyT2ZQYWlycyxYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fQ2FzZUZpZWxkc19fYyIpKTsgLy9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04KICAgIAogICAgYWxlcnQoIkVSUzIwMDMwOC4xNDMgbmV3IENhc2UgcHJvdmlkZXJJZD0iK3pkLnByb3ZpZGVySWQrIiBwYXRpZW50SWQ9Iit6ZC5wYXRpZW50SWQpOwogICAgaWYgKHpkLnByb3ZpZGVySWQgJiYgemQucHJvdmlkZXJJZC5pbmRleE9mKCIwMDEiKT09MCkgeyBhcnJPZlBhaXJzLnB1c2goIkFjY291bnRJZCIsIHpkLnByb3ZpZGVySWQpOyB9IC8vRVJTMjAwMzA4CiAgICBpZiAoemQucHJvdmlkZXJJZCAmJiB6ZC5wcm92aWRlcklkLmluZGV4T2YoIjAwMyIpPT0wKSB7IGFyck9mUGFpcnMucHVzaCgiQ29udGFjdElkIiwgemQucHJvdmlkZXJJZCk7IH0gLy9FUlMyMDAzMDgKICAgIGlmICh6ZC5wYXRpZW50SWQgJiYgemQucGF0aWVudElkLmluZGV4T2YoIjAwMSIpPT0wKSB7IGFyck9mUGFpcnMucHVzaCgiQWNjb3VudElkIiwgemQucGF0aWVudElkKTsgfSAvL0VSUzIwMDMwOAogICAgaWYgKHpkLnBhdGllbnRJZCAmJiB6ZC5wYXRpZW50SWQuaW5kZXhPZigiMDAzIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCB6ZC5wYXRpZW50SWQpOyB9IC8vRVJTMjAwMzA4CiAgICBpZiAoemQuemNoYW5uZWwub3duZXIpIHsgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgekRhdGEuemNoYW5uZWwub3duZXIpOyB9IC8vRVJTMjAwMzA4CiAgICAKICB2YXIgY2FzZUlkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNhc2UiLCBsYWJlbCwgYXJyT2ZQYWlycyk7CiAgcmV0dXJuIGNhc2VJZDsKfTsKCnpEYXRhLmNsaWVudFBhdGllbnQ9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsbGFiZWwsemQpIHsKICBpZiAoIXpkKSB6ZD16RGF0YTsKICBpZiAoIWxhYmVsKSB7IGxhYmVsPXpkLnN0YWdlICsgIi0iICsgemQudHJpYWdlVHlwZSArICItIiArIHpkLnN0YWNrSWQ7fQogIGlmICh6ZC5wYXRpZW50SWQpIHsgLy9FUlMyMDAyMDUgIzY4ODI1IFByb2dyYW0gTWVtYmVycwogICAgICBhbGVydCgiUGF0aWVudCBhbHJlYWR5IGV4aXN0cyBpbiAiK3pkLnBhdGllbnRJZCk7CiAgICAgIHJldHVybiB6ZC5wYXRpZW50SWQ7IC8vVE9PRCBnZXQgZnJvbSBYX3BhdGllbnRJZCAgPz8/PwogIH0KICAvL0VSUzE3MDUyMCBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCBxdWV1ZXNNYXBLbHVkZ2VbWChkb2MsIlhfQXNzaWduX3RvX1F1ZXVlX19jIildKTsKICB2YXIgcD0iWlBBUEVSX18iOyAvL0VSUzIwMDIwMiBhc3N1bWUgd29ya2Zsb3cgb24gcmVsYXRlZCByZWNvcmQgdHlwZXMKICBpZiAoekRhdGEucGF0aWVudFR5cGUuaW5kZXhPZigiX19jIikgPiAtMSkgeyBwPSIiOyB9IC8vRVJTMjAwMjAzIHR5cG8KICBpZiAoMT09MCkgeyAvL0VSUzIwMDIwMiBzZWUgaWYgd29ya2Zsb3cgZW5hYmxlZAogICAgICBhcnJPZlBhaXJzLnB1c2gocCsibmV3RmF4X19jIiwgInRydWUiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogICAgICBhcnJPZlBhaXJzLnB1c2gocCsibGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogICAgICBhcnJPZlBhaXJzLnB1c2gocCsicmVjZWl2ZWRJZF9fYyIsIGRvYy5kYklEKTsgLy9FUlMxOTA4MTQgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIH0KCiAgICB2YXIgcnQ9WEN1c3RvbVNldHRpbmcoZG9jLCJQYXRpZW50UmVjb3JkVHlwZV9fYyIpOyAvL1RPRE8gaW50byBNUCBFUlMxOTA4MDIgbGlrZSAwMTI2QTAwMDAwMEpFOHlRQUcgb3IgZW1wdHkgdG8gdXNlIGRlZmF1bHQKICAgIC8vaWYgKHJ0KSB7IGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgcnQpOyB9IC8vRVJTMTkwODAzCiAgICAvL1RPRE8gQ29udGFjdCBvciBBY2NvdW50IEVSUzE5MDYyNCBET05FISEgRVJTMTkwODAyCiAgICBhcnJPZlBhaXJzPXpEYXRhLmNsaWVudEZpZWxkcyhkb2MsYXJyT2ZQYWlycyxYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fUGF0aWVudEZpZWxkc19fYyIpKTsgLy9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04gCiAgICBhcnJPZlBhaXJzPVtdOyAvL0VSUzIwMDIwNCB0ZXN0aW5nIHRvIGdldCBpdCBnb2luZwogICAgCiAgICAvL0VSUzIwMDIwMiBuZWVkIHRvIG1ha2UgdGhlIEFjY291bnQgd2l0aCBQYXRpZW50IHJlY29yZFR5cGUgZmlyc3QKICAgIC8vMDEyNDYwMDAwMDBOR0ZZQUE0IGlzIC56cGFwZXIgZm9yIFBhdGllbnQKICAgIHZhciBhciA9IFtdOwogICAgaWYgKHJ0KSB7IGFyLnB1c2goIlJlY29yZFR5cGVJZCIsIHJ0KTsgfSAvL0VSUzE5MDgwMyAvL0VSUzIwMDIyMiAjNjkxNDkgbW92ZWQgZG93biBhbmQgYWRkZWQgZWxzZSAKICAgIGVsc2UgYXIucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyNDYwMDAwMDBOR0ZZQUE0Iik7CiAgICBhci5wdXNoKCJGaXJzdE5hbWUiLHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MpOwogICAgYXIucHVzaCgiTGFzdE5hbWUiLHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICB2YXIgcGF0aWVudE5hbWU9ekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKyIsICIrekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYzsKICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSBhci5wdXNoKCJQZXJzb25CaXJ0aERhdGUiLHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgdmFyIGFJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkFjY291bnQiLCBudWxsLCBhcik7IC8vRVJTMjAwMjA0IHBlcnNvbiBhY2NvdW50IHNvIGRvIG5vdCBzZXQgcGF0aWVudE5hbWUKICAgIAogICAgaWYgKGFJZCAmJiBhSWQgIT0gIk5FVyIgJiYgYUlkLmluZGV4T2YoIkVSUk9SIik9PS0xKSB7CiAgICAgICAgdmFyIHNmSWQgPSAiIjsKICAgICAgCiAgICAgIC8vRVJTMTkwODAzIHNwZWNpZmljIHRvIGNsaWVudCBkYXRhIGVudHJ5CiAgICAgIHZhciBkcSA9IHpEYXRhLmRxOwogICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUGVyc29uX0FjY291bnRfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgc2ZJZCArIGRxICsgIik7ICIpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQZXJzb25fQWNjb3VudF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyAiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyBkcSArICIpOyAiKTsKICAgIH0KICAgIHJldHVybiB7J0VSUk9SJzogJ3BhdGllbnQgbm90IGNyZWF0ZWQnfQp9OwoKekRhdGEuY2xpZW50QWNjb3VudD1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxsYWJlbCx6ZCkgewogIGlmICghemQpIHpkPXpEYXRhOwogIGlmICghbGFiZWwpIHsgbGFiZWw9emQuc3RhZ2UgKyAiLSIgKyB6ZC50cmlhZ2VUeXBlICsgIi0iICsgemQuc3RhY2tJZDt9CiAgLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7CiAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX25ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCgogIHZhciBhY2NvdW50SWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCAiQWNjb3VudCIsIGxhYmVsLCBhcnJPZlBhaXJzKTsKICByZXR1cm4gYWNjb3VudElkOwp9OwoKekRhdGEuY2xpZW50UmVjb3JkPWZ1bmN0aW9uKGRvYyxzZlR5cGUsYXJyT2ZQYWlycyxsYWJlbCx6ZCkgeyAvL0VSUzE5MDYyMCBjbGllbnRSZWNvcmQgZ2VuZXJpYwogIGlmICghemQpIHpkPXpEYXRhOwogIGlmICghbGFiZWwpIHsgbGFiZWw9emQuc3RhZ2UgKyAiLSIgKyB6ZC50cmlhZ2VUeXBlICsgIi0iICsgemQuc3RhY2tJZDt9CiAgLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7CiAgdmFyIHpwPSIiOwogIGlmICgiLENhc2UsQ29udGFjdCxBY2NvdW50LExlYWQsT3Bwb3J0dW5pdHksWlBBUEVSX196U3RhY2tfX2MsIi50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIiwiK3NmVHlwZS50b0xvd2VyQ2FzZSgpKyIsIik+LTEpIHpwPXpEYXRhLnpwOwogIC8vb25seSBkbyB0aGlzIGlmIHRoZSBmaWVsZHMgZXhpc3QKICBhcnJPZlBhaXJzLnB1c2goenArIm5ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICBhcnJPZlBhaXJzLnB1c2goenArImxhdGVzdEZheF9fYyIsIHpkLmZvcm1hdE5vdyk7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICBhcnJPZlBhaXJzLnB1c2goenArInJlY2VpdmVkSWRfX2MiLCAiZG9jLmRiSUQuUmVjIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICAKICAvL1RPRE8gcHV0IGNsaWVudCBzcGVjaWZpYyBkYXRhIHVwZGF0ZXMgaGVyZQoKICB2YXIgbmV3SWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCBzZlR5cGUsIGxhYmVsLCBhcnJPZlBhaXJzKTsKICByZXR1cm4gbmV3SWQ7Cn07Cgp6RGF0YS5jbGllbnRDb21wbGV0ZT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyx6ZCkge3JldHVybiBhcnJPZlBhaXJzO307IC8vRVJTMTkwNjI1CnpEYXRhLmNsaWVudERlbGl2ZXJ5PWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzKSB7IC8vRVJTMjAwMjAyIFRPRE8gY29uc2lkZXIgbmV3IERvY3VtZW50X01WTgogICAgcmV0dXJuIGFyck9mUGFpcnM7Cn07IC8vRVJTMTkwNzExICM2MDkwMCBQQU9TCgp6RGF0YS5jbGllbnRDaGlsZFN0YWNrPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLHBhcmVudElkKSB7IC8vRVJTMTkwODEwICM2MTU3MCBiZSBzdXJlIHRvIGNhbGwgb24gbmV3IGNoaWxkIGRvYwogICAgLy9BSFMyMjA2MjcgLSBhZGRpbmcgc3ViY2F0ZWdvcnkgdmFsdWUgdG8gY2hpbGQgc3RhY2sgLSBzdGFydAogICAgekRhdGEuc3ViY2F0ZWdvcnkgPSB6RGF0YS5jYXRlZ29yeU1hcHBpbmdzW3pEYXRhLmRvY1R5cGVdLnN1YmNhdGVnb3J5OwogICAgaWYoekRhdGEuc3ViY2F0ZWdvcnkpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlN1YmNhdGVnb3J5X19jIiwgekRhdGEuc3ViY2F0ZWdvcnkpOwogICAgfQogICAgLy9BSFMyMjA2MjcgLSBhZGRpbmcgc3ViY2F0ZWdvcnkgdmFsdWUgdG8gY2hpbGQgc3RhY2sgLSBlbmQKICAgIAogICAgLy9BSFMyMjA2MjcgLSBhZGRpbmcgQWNjb3VudCBpZCwgUHJvZHVjdCBJZCB2YWx1ZSB0byBjaGlsZCBzdGFjayAtIHN0YXJ0CiAgICAvL3ZhciBhY2NvdW50SWQgPSBYKGRvYywiWF9BY2NvdW50X19jIik7CiAgICBpZih6RGF0YS5hY2NvdW50SWQpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkFjY291bnRfX2MiLCB6RGF0YS5hY2NvdW50SWQpOwogICAgfQogICAgCiAgICAvL3ZhciBwcm9kdWN0SWQgPSBYKGRvYywiWF9Qcm9kdWN0X19jIik7CiAgICBpZih6RGF0YS5wcm9kdWN0SWQpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlByb2R1Y3RfX2MiLCB6RGF0YS5wcm9kdWN0SWQpOwogICAgfQogICAgCiAgICBpZih6RGF0YS5wcm9kdWN0RGV0YWlsSWQpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlByb2R1Y3RfRGV0YWlsX19jIiwgekRhdGEucHJvZHVjdERldGFpbElkKTsKICAgIH0KICAgIAogICAgLy8gaWYoekRhdGEuYWNjb3VudElkICYmIHpEYXRhLnByb2R1Y3RJZCkgewogICAgLy8gICAgIHpEYXRhLnByb2R1Y3REZXRhaWxJZCA9IGdldFNGUmVjb3JkSUQoZG9jLCAiQ2FyZVByb2dyYW1FbnJvbGxlZVByb2R1Y3QiLCB7IkNhcmVQcm9ncmFtUHJvZHVjdElkIjogekRhdGEucHJvZHVjdElkLCAiVEtfUGF0aWVudF9OYW1lX19jIjogekRhdGEuYWNjb3VudElkfSk7CiAgICAvLyAgICAgYWxlcnQoInByb2R1Y3REZXRhaWxJZCA6ICIgKyB6RGF0YS5wcm9kdWN0RGV0YWlsSWQpOwogICAgICAgIAogICAgLy8gICAgIGlmKHpEYXRhLnByb2R1Y3REZXRhaWxJZCkgewogICAgLy8gICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlByb2R1Y3RfRGV0YWlsX19jIiwgekRhdGEucHJvZHVjdERldGFpbElkKTsKICAgIC8vICAgICB9IGVsc2UgewogICAgLy8gICAgICAgICAvL2lmIHByb2R1Y3QgZGV0YWlsIGlkIGlzIG5vdCBmb3VuZCBkb25vdCBwcm9jZWVkIHRocm93IGFuIGVycm9yIGFuZCByZXR1cm4KICAgIC8vICAgICAgICAgLy90aHJvdyAiQXNzaWduIERvY3VtZW50IHdhcyB1bnN1Y2Nlc3NmdWwgYXMgUHJvZHVjdCBEZXRhaWwgcmVjb3JkIHdhcyBub3QgZm91bmQiOwogICAgLy8gICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgJ2FsZXJ0KCJBc3NpZ24gRG9jdW1lbnQgd2FzIHVuc3VjY2Vzc2Z1bCBhcyBQcm9kdWN0IERldGFpbCByZWNvcmQgd2FzIG5vdCBmb3VuZCIpOycpOwogICAgLy8gICAgICAgICByZXR1cm47CiAgICAvLyAgICAgfQogICAgLy8gfQogICAgLy9BSFMyMjA2MjcgLSBhZGRpbmcgQWNjb3VudCBpZCwgUHJvZHVjdCBJZCB2YWx1ZSB0byBjaGlsZCBzdGFjayAtIGVuZAogICAgCiAgICB2YXIgcGFpcnM9YXJyT2ZQYWlyczsKICAgIAogICAgLy9ubyBtZW1vcnkgb2Ygc3RhY2sgY3JlYXRpb24gdmFyIHBhaXJzPXpEYXRhLnN0YWNrUGFpcnM7CiAgICAvL0NSTjIwMTAyNiAjNzY3ODggV2UgbmVlZCByZXZpZXdlZFN0YXR1cyB0byBiZSAiSW5kZXhlZCIgZm9yIHRoZSBpbmRleCBydWxlLCBzbyBvbmx5IHNldCB0aGUgZmllbGQgaWYgaXQgaXNuJ3QgYWxyZWFkeSBzZXQuCiAgICBpZiAoIXpEYXRhLnJldmlld2VkU3RhdHVzKSB7IHpEYXRhLnJldmlld2VkU3RhdHVzPSJTcGxpdCI7IH0KICAgIC8vRVJTMTkwODEwIFRPRE8/IHBhaXJzLnB1c2goIlpQQVBFUl9fU3RhdHVzX19jIiwgIkNoaWxkIFN0YWNrIik7CgogICAgcGFpcnM9ekRhdGEuY2xpZW50U3RhY2soZG9jLHBhaXJzKTsKICAgIGlmIChYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fekNoaWxkRmllbGRzX19jIikpIHsgLy9FUlMxOTA4MTEgbm90IGluIGFsbCBNUHMKICAgICAgICBwYWlycz16RGF0YS5jbGllbnRGaWVsZHMoZG9jLHBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX196Q2hpbGRGaWVsZHNfX2MiKSk7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OIGNoaWxkIHJlY29yZCB0eXBlIGlkCiAgICB9CiAgICBwYWlycy5wdXNoKCJaUEFQRVJfX1BhcmVudF9fYyIsIHBhcmVudElkKTsKICAgIC8vRVJTMjAxMTI4IHNob3VsZCBiZSBpbiB6Q2hpbGRGaWVsZHMgaWYgKHpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlKSBwYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLHpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlKTsKICAgIAogICAgLy9wYWlycy5wdXNoKCIiKyJQcm9ncmFtX19jIix6RGF0YS5wcm9ncmFtTmFtZSk7IC8vRVJTMjAwMjA1IFRPRE8gaW4gcGFja2FnZSBhbmQgaW50byBiYXNlIGNhbGwKICAgIHBhaXJzLnB1c2goIlpQQVBFUl9fUHJvZ3JhbV9fYyIsekRhdGEucHJvZ3JhbU5hbWUpOwogICAgLy9FUlMyMDAyMjkgaWYgKHpEYXRhLnBhdGllbnRJZCkgcGFpcnMucHVzaCgiUHJvZ3JhbV9NZW1iZXJfTVZOX19jIix6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzIwMDIwNSBQcm9ncmFtX01lbWJlcl9NVk5fX2Mgd2FzIHRoZSBUSUNLRVQhISEKICAgIGFsZXJ0KCJFUlMxOTA4MTEuMTkxIFpQQVBFUl9fUGFyZW50X19jIisgcGFyZW50SWQrIiBjaGlsZCB6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZT0iK3pEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlKTsKICAgIGlmICh6RGF0YVsnUmVjb3JkVHlwZUlkJ10pIHsgIHpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlPXpEYXRhWydSZWNvcmRUeXBlSWQnXTsgfSAvL0VSUzIwMTEyOSAjNzg4MzAgVE9ETyBub3Qgc3VyZSB3aGVyZSB0aGlzIGlzIHVzZWQgZWxzZXdoZXJlCiAgICBhbGVydCgiRVJTMjAxMTI5LjI5MiBaUEFQRVJfX1BhcmVudF9fYyIrIHBhcmVudElkKyIgY2hpbGQgUmVjb3JkVHlwZUlkPSIrekRhdGFbJ1JlY29yZFR5cGVJZCddKTsKICAgIGFsZXJ0KCJ0ZXN0aW5nIHBhaXJzIGJlZm9yZSBjcmVhdGVhbmRhdHRhY2ggOiAiICsgcGFpcnMpOwogICAgdmFyIGNoaWxkU3RhY2tTRklkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIlpQQVBFUl9felN0YWNrX19jIiwgInpTdGFjayBzcGxpdCBvbiAiICsgekRhdGEuZm9ybWF0Tm93LCBwYWlycykgKyAiIjsKICAgIAogICAgaWYgKCF6RGF0YS5wYXRpZW50SWQgJiYgWChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIpICl7IC8vRVJTMjAwMzA4IEhBQ0sKICAgICAgICB6RGF0YS5wYXRpZW50SWQ9WChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIpOwogICAgICAgIGFsZXJ0KCJFUlMyMDAzMDggV0hZIE5PVCBpbiB6RGF0YT8iKTsKICAgIH0KICAgIC8qCiAgICAvL2NvbW1lbnRlZCBhcyBUaW1lbGluZSBpcyBub3QgaW4gdXNlCiAgICBpZiAoekRhdGEucGF0aWVudElkKSB7IC8vRVJTMjAwMzA4IGNyZWF0ZSBhbiBBY3Rpdml0eSBFdmVudCByZWxhdGVkIHRvIHRoZSBQYXRpZW50IChBY2NvdW50KSBmb3IgdGhlIFRpbWVsaW5lCiAgICAgICAgaWYgKCF6RGF0YS5kb2NUeXBlICYmIFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpKSB6RGF0YS5kb2NUeXBlPVgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwogICAgICAgIHZhciBhcnI9W107CiAgICAgICAgLy9OT1QgU0VMRUNUIEFjY291bnRJZCxBY3Rpdml0eURhdGUsQ3JlYXRlZERhdGUsU3RhdHVzLFN1YmplY3QsVGFza1N1YnR5cGUsV2hhdElkLFdob0lkIEZST00gVGFzayB3aGVyZSBBY3Rpdml0eURhdGUgPiAyMDIwLTAyLTAxCiAgICAgICAgLy9TRUxFQ1QgSWQsQWNjb3VudElkLEFjdGl2aXR5RGF0ZSxDcmVhdGVkRGF0ZSxTdWJqZWN0LFdoYXRJZCxXaG9JZCBGUk9NIEV2ZW50IHdoZXJlIElkID0gJzAwVTRUMDAwMDAydkNoclVBRScKICAgICAgICAvL2Fyci5wdXNoKCJXaG9JZCIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAzMTAgdGltZWxpbmUgdHJpY2sKICAgICAgICBpZiAoekRhdGEucGF0aWVudElkLmluZGV4T2YoIjAwMSIpPT0wKSB7CiAgICAgICAgICAgIGFyci5wdXNoKCJXaGF0SWQiLHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMjAwMzEwIHRpbWVsaW5lIHRyaWNrCiAgICAgICAgICAgIC8vYXJyLnB1c2goIkFjY291bnRJZCIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAzMTAgdGltZWxpbmUgdHJpY2sKICAgICAgICB9IGVsc2UgaWYgKHpEYXRhLmNhc2VJZCkgYXJyLnB1c2goIldoYXRJZCIsekRhdGEuY2FzZUlkKTsKICAgICAgICBlbHNlIGlmICh6RGF0YS5wcm92aWRlcklkKSBhcnIucHVzaCgiV2hhdElkIix6RGF0YS5wcm92aWRlcklkKTsKICAgICAgICBlbHNlIGFyci5wdXNoKCJXaGF0SWQiLGNoaWxkU3RhY2tTRklkKTsKICAgICAgICAvL2Fyci5wdXNoKCJUYXNrU3VidHlwZSIsIlRhc2siKTsKICAgICAgICBhcnIucHVzaCgiU3ViamVjdCIsekRhdGEuc3RhZ2UgKyAiICIrekRhdGEuZG9jVHlwZSk7CiAgICAgICAgYXJyLnB1c2goIkRlc2NyaXB0aW9uIiwiQ2hlY2sgb3V0ICIrZG9jLmRiSUQpOwogICAgICAgIC8vYXJyLnB1c2goIkFjdGl2aXR5RGF0ZVRpbWUiLHpEYXRhLmZvcm1hdE5vdyk7IC8vRVJTMjAwMzA5IGhhY2tpbmcgYXdheSEKICAgICAgICBhcnIucHVzaCgiQWN0aXZpdHlEYXRlIix6RGF0YS5mb3JtYXROb3cuc3Vic3RyaW5nKDAsMTApKTsKICAgICAgICBhcnIucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyNFQwMDAwMDA4YUZtUUFJIik7IC8vRVJTMjAwMzEwIEhBQ0sgZm9yIFRhc2sgb24gQ2FyZVBsYW4KICAgICAgICAvL2Fyci5wdXNoKCJEdXJhdGlvbkluTWludXRlcyIsIjUiKTsKICAgICAgICAvL2Fyci5wdXNoKCJTdGF0dXMiLCJDb21wbGV0ZWQiKTsKICAgICAgICAKICAgICAgICB2YXIgbGFiZWw9IlRpbWVsaW5lICIrekRhdGEuZG9jVHlwZTsKICAgICAgICB2YXIgYWN0SWQgPSBjcmVhdGVTRlJlY29yZChkb2MsICJUYXNrIiwgbnVsbCwgYXJyKTsgLy9FUlMyMDAzMDkgbnVsbCBtZWFucyBubyBOYW1lIGZpZWxkCiAgICAgICAgLy92YXIgYWN0SWQgPSBjcmVhdGVTRlJlY29yZChkb2MsICJFdmVudCIsIG51bGwsIGFycik7IC8vRVJTMjAwMzA5IG51bGwgbWVhbnMgbm8gTmFtZSBmaWVsZAogICAgICAgIGFsZXJ0KCJFUlMyMDAzMDguMjYyIHRpbWVsaW5lIGFjdGl2aXR5ICIrYWN0SWQpOwogICAgfSBlbHNlIHsgYWxlcnQoIkVSUzIwMDMwOC4yNjMgYmUgd29ycmllZCB0aGVyZSBpcyBubyBwYXRpZW50ISIpOyB9CiAgICAqLwogICAgaWYgKDE9PT0xICYmIHpEYXRhLmNsaWVudFJlY2VpdmVkRG9jdW1lbnQpIHsgekRhdGEucmVjRG9jSWQ9ekRhdGEuY2xpZW50UmVjZWl2ZWREb2N1bWVudChkb2MsY2hpbGRTdGFja1NGSWQpOyB9IC8vRVJTMjAxMDE4ICM3NzI1MgogICAgcmV0dXJuIGNoaWxkU3RhY2tTRklkOwp9OwoKCnpEYXRhLmNsaWVudFN0YWNrQ29tcGxldGU9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsemQpIHsgLy9FUlMyMDAzMTQgIzcwMzM2CiAgICBpZiAoIXpkKSB6ZD16RGF0YTsgLy9FUlMyMDA0MDYgIzcxMTU2CiAgICBhcnJPZlBhaXJzLnB1c2goIlRpbWVfQ29tcGxldGVfRGF0ZV9fYyIsemQuZm9ybWF0Tm93KTsgLy9mb3IgZGFzaGJvYXJkCiAgICByZXR1cm4gYXJyT2ZQYWlyczsKfTsgLy9FUlMxOTA2MjUKCnpEYXRhLmNsaWVudEF0dGFjaFBvcHVsYXRlZmllbGRzPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLHBhdGllbnRJZCxwYXJlbnRJZCxjaGlsZElkKXsgLy9bVkogLSBwb3B1bGF0ZSBmaWVsZHMgYW5kIGF0dGFjaCBpbmRleGVkIHBhZ2VzIHRvIGxvb2t1cHNdCgogIHZhciB6cGFyZW50SWQgPSBwYXJlbnRJZDsKICB2YXIgemNoaWxkSWQgPSBjaGlsZElkOwogIHZhciBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOyAvLyJJbmRleGVkICIgKyBmb3JtYXROb3c7CiAgCiAgaWYgKCh6cGFyZW50SWQgJiYgenBhcmVudElkLmxlbmd0aCA+IDApICYmICh6Y2hpbGRJZCAmJiB6Y2hpbGRJZC5sZW5ndGggPiAwKSkgewogICAgdmFyIGFyck9mUGFpcnMgPSBbXTsKICAgIAogICAgYXJyT2ZQYWlycy5wdXNoKCJEb2N1bWVudF9SZWNlaXZlZF9EYXRlX19jIiwgcmVjZWl2ZWREYXRlKTsKICAgIHVwZGF0ZVNGUmVjb3JkKGRvYyx6RGF0YS56cHMsIHpjaGlsZElkLCBhcnJPZlBhaXJzKTsKICB9CiAgCiAgcmV0dXJuIG51bGw7Cn0KCnpEYXRhLmNsaWVudExpZ2h0bmluZ0ZpbGU9ZnVuY3Rpb24oZG9jLHNmSWQsemQsY2hpbGRTdGFja0lkKSB7IC8vdXNlIGluIGluZGV4IGNsaWVudCBsaWJyYXJ5CiAgCmlmICghemQpIHpkPXpEYXRhOwogICAgaWYgKCFkb2Mua2JEYXRhLnNmU2VydmVyKSB7ICAgCiAgICAvL0VSUzIwMDQyOCBIQUNLCiAgICBhbGVydCgiZG9jLmtiRGF0YS5zZlNlcnZlciB3YXMgZW1wdHkuIElkZWFsbHkgc2hvdWxkIE5PVCBjb21lIGhlcmUiKTsgZG9jLmtiRGF0YS5zZlNlcnZlcj0idGFrZWRhcGF0aWVudHNlcnZpY2VzLS10a2RldjIubGlnaHRuaW5nLmZvcmNlLmNvbSI7IAogIH0KICAgIHZhciB6c2VydmVyID0gZG9jLmtiRGF0YS5zZlNlcnZlci5pbmRleE9mKCJodHRwczovLyIpPT0wID8gZG9jLmtiRGF0YS5zZlNlcnZlciA6ICJodHRwczovLyIgKyBkb2Mua2JEYXRhLnNmU2VydmVyOyAKICAvLyBTYWxlc2ZvcmNlIFJFU1QgQVBJIGVuZHBvaW50CiAgICB2YXIgZG9jdXJsID0genNlcnZlciArICIvc2VydmljZXMvZGF0YS92NDYuMC9zb2JqZWN0cy9Db250ZW50VmVyc2lvbi8iOwogICAgdmFyIHBkZnVybCA9ICJodHRwczovL2d3LnpwYXBlci5jb20va2IvanNwL1NGX2ZpbmQubGlnaHRuaW5nLmpzcD9nbz1TRl9maWxlcy5qc3AmZGJJRD0iICsgZG9jLmRiSUQgKyAiJlNGb3JnPSIgKyBkb2Mua2JEYXRhLnNmT3JnYW5pemF0aW9uSUQ7CgogIC8vIEdlbmVyYXRlIFBERiBmaWxlIGZyb20gelN0YWNrCiAgICB2YXIgZm9ybWF0Tm93ID0gZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jLGZhbHNlLHRydWUpOyAvLyBlLmcuICIyMDIxMDIxMC0wNTIxMzIiPwogICAgdmFyIGFyck9mUGFpcnMgPSBbXTsKICAgIHZhciBub3dUaW1lU3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOyAKICAgIAogICAgdmFyIGZpbGVOYW1lID0gZ2V0Q3VyRGF0ZShkb2MpKyIgIit6RGF0YS5kb2NUeXBlKyIucGRmIjsgIC8vIGUuZyAtICIyMDIxMDIxMCBOZXcgRmF4LnBkZiI/Ly8KICAgIGFsZXJ0KCJAQEBmaWxlTmFtZSA9ICIrZmlsZU5hbWUpOwogIAogIHpEYXRhLnVwbG9hZERpciA9ICd6U3RhY2tVcGxvYWRSb290JzsgLy9zZXR0aW5nIHJvb3QgZGlyZWN0b3J5IGZvciBmaWxlIGNyZWF0aW9uCiAgCiAgICAvLyBjcmVhdGUgZGlyZWN0b3J5IHRvIHBsYWNlIGdlbmVyYXRlZCBQREYgZmlsZQogICAgY3JlYXRlRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwogICAKICAgIHZhciB4UGFnZXMgPSBYKGRvYywgIlhfcG9zaXRpb24iKTsgLy9nZXQgWF9wb3NpdGlvbiAtIHBhZ2UgcmFuZ2Ugc2VsZWN0ZWQ7IGRlZmF1bHQgPSBhbGwgcGFnZXMKICAgIGFsZXJ0KCJAQEBAQCBDYWxsaW5nIHNwbGl0UERGIHRvIHNwbGl0IG9mZiBwYWdlcyB0byB1cGxvYWQgYXMgUERGLCBwYWdlcyA9ICIgKyB4UGFnZXMgKyAiLCBub3dUaW1lU3RhbXAgPSAiICsgbm93VGltZVN0YW1wKTsKICAgIHZhciByZXNwb25zZSA9IHNwbGl0UERGKGRvYywgeFBhZ2VzLCB6RGF0YS51cGxvYWREaXIsIG5vd1RpbWVTdGFtcCwgZmlsZU5hbWUpOwogICAgYWxlcnQoIkBAQEAgcmVzcG9uc2UgZnJvbSBzcGxpdFBERiA9ICIgKyByZXNwb25zZSk7CiAgICB2YXIgbmV3UERGTmFtZSA9IFgoZG9jLCAibmV3UERGIiwgcmVzcG9uc2UpOyAvLyBzZXQgdmFsdWUgb2YgbmV3UERGCiAgICAKICAgIGFsZXJ0KCJAQEBAIHNwbGl0IFBERiBGaWxlTmFtZSA9ICIgKyBuZXdQREZOYW1lKTsKCiAgLy8gQ2Fubm90IGRpcmVjdGx5IEFwcGVuZCBQREYgZmlsZSB0byBtdWx0aXBhcnQgZm9ybWRhdGEKICAvLyBKUyBkb2VzIG5vdCBhbGxvdyByZWFkaW5nIGEgZmlsZSBmcm9tIHRoZSBmaWxlIHN5c3RlbSAobm9ybWFsbHkgYXBwbGllcyB0byBjbGllbnQgc2lkZSBmb3Igc2VjdXJpdHkgcmVhc29ucykKICAvLyBXZSBkb250IGhhdmUgYSBOb2RlLmpzIGNvbnRhaW5lciwgc28gbm8gbHVjayB0aGVyZS4uIGhhdmUgdG8gZG8gdGhpcyBhbm90aGVyIHdheQogIC8vIEVyaWMgc3VnZ2VzdGVkIHdlIHVzZSB1cGxvYWRUb0Nsb3VkLmpzcCBhcHByb2FjaCB0byBjcmVhdGUgTGlnaHRuaW5nIEZpbGUgKHByb2JhYmx5IENvbnRlbnREb2N1bWVudCkgaW4gU2FsZXNmb3JjZQogIAogICAgLy92YXIgdXBsb2FkVVJMPSJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0ZpZD1ORVcmU0ZwaWQ9IitzZklkKyImU0Zvcmc9Iitkb2Muc2ZPcmcrIiZsYWJlbD0iK2ZpbGVOYW1lKyImc2VydmVyRmlsZT0iK25ld1BERk5hbWUrIiZEZXNjcmlwdGlvbj1GaWxlIGF0dGFjaGVkIGFzIFBERiI7CiAgLy9BTjIwMjEwOTAzICM4MTc2NiBuZWVkIFNGdHlwZT1Db250ZW50VmVyc2lvbiBwYXJhbWV0ZXIgdG8gdXBsb2FkIGFzIExpZ2h0bmluZyBGaWxlCiAgLy92YXIgdXBsb2FkVVJMPSJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0Z0eXBlPUNvbnRlbnRWZXJzaW9uJlNGaWQ9TkVXJlNGcGlkPSIrc2ZJZCsiJlNGb3JnPSIrZG9jLnNmT3JnKyImbGFiZWw9IitmaWxlTmFtZSsiJnNlcnZlckZpbGU9IituZXdQREZOYW1lKyImRGVzY3JpcHRpb249RmlsZSBhdHRhY2hlZCBhcyBQREYiOwogICB2YXIgdXBsb2FkVVJMPSJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0Z0eXBlPUNvbnRlbnRWZXJzaW9uJlNGaWQ9TkVXJlNGcGlkPSIrc2ZJZCsiJlNGU2VydmVyPSIrZG9jLmtiRGF0YS5zZlNlcnZlcisiJlNGU2Vzc2lvbj0iK2RvYy5rYkRhdGEuc2ZTZXNzaW9uSUQrIiZsYWJlbD0iK2ZpbGVOYW1lKyImc2VydmVyRmlsZT0iK25ld1BERk5hbWUrIiZEZXNjcmlwdGlvbj1GaWxlIGF0dGFjaGVkIGFzIFBERiI7CiAgIGFsZXJ0KCIjIyMjIFVwbG9hZCBuYXRpdmUgUERGIHdpdGggIit1cGxvYWRVUkwpOwogIAogICAgdmFyIHI9d2dldChkb2MsIHVwbG9hZFVSTCk7IC8vID8/Pz8/IHdpbGwgciBjb250YWluIHRoZSBDb250ZW50RG9jdW1lbnQgaWQ/IHJlc3BvbnNlIG9mIHN0cmluZyB2YWx1ZSB4bWwKICAKICBhbGVydCgndmFsdWUgZnJvbSB3Z2V0IHJlc3BvbnNlID4+PiAnK3IpOwogICAgCiAgICB2YXIgaWR4QmVnaW4gPSByLmluZGV4T2YoIjxzZklEPiIpOwogICAgdmFyIGlkeEVuZCA9IHIuaW5kZXhPZigiPC9zZklEPiIpOwogICAgdmFyIHNmZG9jSWQ7CiAgaWYoaWR4RW5kID4gaWR4QmVnaW4pIHsKICAgIHNmZG9jSWQgPSByLnN1YnN0cmluZyhpZHhCZWdpbis2LGlkeEVuZCk7CiAgICBhbGVydCgic2ZEb2NJZCBleHRyYWN0ZWQgZnJvbSByIDogIiArIHNmZG9jSWQpOwogICAgICAvL3ZhciBhcnJPZlBhaXJzQ29udGVudERvY3VtZW50ID0gW107Ly9QVjIxMDUwNyBhZGRlZCB0byB0ZXN0CiAgICAvL25lZWQgdG8gZ2V0IHRoZSBjdXJyZW50IHVzZXIgaWQgYmVmb3JlIHdlIHBhc3MgaXQgdG8gYXJyb2ZwYWlycwogICAgLy9hcnJPZlBhaXJzQ29udGVudERvY3VtZW50LnB1c2goIk93bmVySWQiLCAiMDA1MDIwMDAwMDBiNllDQUFZIik7CiAgIC8vIHVwZGF0ZVNGUmVjb3JkKGRvYywgJ0NvbnRlbnREb2N1bWVudCcsIHNmZG9jSWQsIGFyck9mUGFpcnNDb250ZW50RG9jdW1lbnQpOwogIH0KICAKICAgIC8vIEZpbmFsbHksIGRlbGV0ZSB0aGUgZm9sZGVyIGFuZCBhbGwgY29udGVudHMuCiAgICBjbGVhbnVwRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwoKICAvL0dldCB0aGUgY29udGVudFZlcnNpb24gcmVjb3JkIG9mIHRoZSBhdHRhY2htZW50CiAgdmFyIGNvblZJZCA9IGdldFNGRmllbGQoZG9jLCAiQ29udGVudFZlcnNpb24iLCAiSWQiLCdDb250ZW50RG9jdW1lbnRJZD1cJycrc2Zkb2NJZCsnXCcnLG51bGwpOwogIAogIC8velN0YWNrX19jLFRLX0RvY3VtZW50X0RhdGVfX2MKICAgIHZhciBhcnJPZlBhaXJzID0gW107CiAgYXJyT2ZQYWlycy5wdXNoKCJ6U3RhY2tfX2MiLCBjaGlsZFN0YWNrSWQpOyAKICB2YXIgZG9jU2lnRGF0ZSA9IFgoZG9jLCAiWF9Eb2N1bWVudF9TaWduYXR1cmVfRGF0ZV9fYyIpOyAvL1BWMjEwNDAyIAogICAgaWYoZG9jU2lnRGF0ZSkKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfRG9jdW1lbnRfRGF0ZV9fYyIsZG9jU2lnRGF0ZSk7CiAgLy9hcnJPZlBhaXJzLnB1c2goIlRLX0RvY3VtZW50X0RhdGVfX2MiLCBYKGRvYywgIlhfRG9jdW1lbnRfU2lnbmF0dXJlX0RhdGVfX2MiKSk7CiAgLy9BSFMyMjA2MjkgLSBjb21tZW50aW5nIHRoZSBleGlzdGluZyBjYXRlZ29yeSBhbmQgc3ViY2F0ZWdvcnkgZmllbGQgdXBkYXRlIC0gc3RhcnQKICAvKgogIGFsZXJ0KCJEb2MgdHlwZSAiK3pEYXRhLmRvY1R5cGUpOwogIGlmKHpEYXRhLmRvY1R5cGUgPT0gIkNPTlMiKXsvL1BWMjEwNDAxIHVwZGF0ZWQKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfQ2F0ZWdvcnlfX2MiLCAiQ29uc2VudCIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19TdWJfQ2F0ZWdvcnlfX2MiLCAiUmV2aWV3IENvbnNlbnQgRm9ybSIpOwogIH1lbHNlIGlmKHpEYXRhLmRvY1R5cGUgPT0gIlJFTVMiKXsKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfQ2F0ZWdvcnlfX2MiLCAiUkVNUyIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19TdWJfQ2F0ZWdvcnlfX2MiLCAiUmV2aWV3IFJFTVMgRG9jdW1lbnQiKTsKICB9ZWxzZSBpZih6RGF0YS5kb2NUeXBlID09ICJTVVAiKXsKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfQ2F0ZWdvcnlfX2MiLCAiIFNVUCIpOyAvL1BWMjEwNDI3IHVwZGF0ZWQgZnJvbSBTVVAgRm9ybSB0byBTVVAKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfU3ViX0NhdGVnb3J5X19jIiwgIlJldmlldyBTVVAgRG9jdW1lbnQiKTsKICB9ZWxzZSBpZih6RGF0YS5kb2NUeXBlID09ICJDT05GIil7CiAgICBhcnJPZlBhaXJzLnB1c2goIlRLX0NhdGVnb3J5X19jIiwgIkNvbmZpcm1hdGlvbiIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19TdWJfQ2F0ZWdvcnlfX2MiLCAiUmV2aWV3IENvbmZpcm1hdGlvbiIpOwogIH1lbHNlIGlmKHpEYXRhLmRvY1R5cGUgPT0gIlBET0MiKXsKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfQ2F0ZWdvcnlfX2MiLCAiUGF0aWVudCBEb2N1bWVudHMiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfU3ViX0NhdGVnb3J5X19jIiwgIlJldmlldyBQYXRpZW50IERvY3VtZW50Iik7CiAgfWVsc2UgaWYoekRhdGEuZG9jVHlwZSA9PSAiT1RIIil7CiAgICBhcnJPZlBhaXJzLnB1c2goIlRLX0NhdGVnb3J5X19jIiwgIk90aGVyIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIlRLX1N1Yl9DYXRlZ29yeV9fYyIsICJSZXZpZXcgT3RoZXIgRG9jdW1lbnQiKTsKICB9CiAgKi8KICAvL0FIUzIyMDYyOSAtIGNvbW1lbnRpbmcgdGhlIGV4aXN0aW5nIGNhdGVnb3J5IGFuZCBzdWJjYXRlZ29yeSBmaWVsZCB1cGRhdGUgLSBlbmQKYWxlcnQoIkRvYyB0eXBlIEpTT04gIitzZklkKTsKCi8vZ2V0IFBhdGllbnQgTmFtZSBmcm9tIENhc2UKICB2YXIgcGF0aWVudE5hbWU7CiAgdmFyIHBhdGllbnRJZDsKICB2YXIgdGl0bGUgPSBnZXRTRkZpZWxkKGRvYywgIkNvbnRlbnRWZXJzaW9uIiwgIlRpdGxlIiwnQ29udGVudERvY3VtZW50SWQ9XCcnK3NmZG9jSWQrJ1wnJyxudWxsKTsKICBpZih6RGF0YS5jYXNlSWQpewogICAgcGF0aWVudE5hbWU9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJUS19UYWtlZGFfUGF0aWVudF9OYW1lX19jIiwgbnVsbCwgekRhdGEuY2FzZUlkKTsKICAgIHBhdGllbnRJZD0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIlRLX1Rha2VkYV9QYXRpZW50c19JRF9fYyIsIG51bGwsIHpEYXRhLmNhc2VJZCk7CglhcnJPZlBhaXJzLnB1c2goIlRpdGxlIiwgcGF0aWVudE5hbWUrJyAnK3BhdGllbnRJZCsnICcrdGl0bGUpOwogIH1lbHNlewoJLy9wYXRpZW50SWQ9IGdldFNGRmllbGQoZG9jLCAiQ2FyZVByb2dyYW1FbnJvbGxlZSIsICJBY2NvdW50LlRLX1VTX1Rha2VkYV9JZF9fYyIsIG51bGwsIHNmSWQpOwoJYWxlcnQoIkAjIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYywgZmFsc2UsIHRydWUpKTsKCWFsZXJ0KCJAIyIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MsIGZhbHNlLCB0cnVlLCB0cnVlKSk7CglhbGVydCgiQCMiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jLCBmYWxzZSkpOwoJYWxlcnQoIkAjIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYywgZmFsc2UsIGZhbHNlKSk7Cgl2YXIgZHQgPSB6RGF0YS5nZXRGb3JtYXR0ZWREYXRlVGltZSgpOwoJLy9BSFMyMjA2MzAgLSBzZXR0aW5nIHRpdGxlIG9uIGxpZ2h0bmluZyBmaWxlIGFuZCBhZGRpbmcgY2F0ZWdvcnkgYW5kIHN1YmNhdGVnb3J5IG9uIGZpbGUgLSBzdGFydAoJcGF0aWVudElkPSBnZXRTRkZpZWxkKGRvYywgIlpQQVBFUl9felN0YWNrX19jIiwgIkFjY291bnRfX3IuVEtfVVNfVGFrZWRhX0lkX19jIiwgbnVsbCwgY2hpbGRTdGFja0lkKTsKCXZhciBmaWxlTGFiZWwgPSBwYXRpZW50SWQgKyAiICIgKyB6RGF0YS5kb2NUeXBlICsgIiAiICsgZHQ7Ly9nZXRDdXJEYXRlKGRvYywgZmFsc2UpOy8vZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jLCBmYWxzZSwgdHJ1ZSwgdHJ1ZSk7CgkvL2Fyck9mUGFpcnMucHVzaCgiVGl0bGUiLCBwYXRpZW50SWQrJyAnK3RpdGxlKTsKCWFyck9mUGFpcnMucHVzaCgiVGl0bGUiLCBmaWxlTGFiZWwpOwoJYXJyT2ZQYWlycy5wdXNoKCJUS19DYXRlZ29yeV9fYyIsIHpEYXRhLmRvY1R5cGUpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19TdWJfQ2F0ZWdvcnlfX2MiLCB6RGF0YS5zdWJjYXRlZ29yeSk7CglhbGVydCgiY2hpbGRTdGFja0lkICIgKyBjaGlsZFN0YWNrSWQpOwoJYWxlcnQoInBhdGllbnRJZCAiICsgcGF0aWVudElkKTsKCWFsZXJ0KCJhcnJPZlBhaXJzICIgKyBhcnJPZlBhaXJzKTsKCWFsZXJ0KCJ0aXRsZSA6ICIgKyBwYXRpZW50SWQrJyAnK3RpdGxlKTsKCS8vQUhTMjIwNjMwIC0gc2V0dGluZyB0aXRsZSBvbiBsaWdodG5pbmcgZmlsZSBhbmQgYWRkaW5nIGNhdGVnb3J5IGFuZCBzdWJjYXRlZ29yeSBvbiBmaWxlIC0gZW5kCiAgfQoKICB1cGRhdGVTRlJlY29yZChkb2MsICdDb250ZW50VmVyc2lvbicsIGNvblZJZCwgYXJyT2ZQYWlycyk7CgogIAoKICAgIHJldHVybiBudWxsOwp9CgoKekRhdGEuZ2V0Rm9ybWF0dGVkRGF0ZVRpbWU9ZnVuY3Rpb24oKSB7CiAgICBhbGVydCgiZ2V0Rm9ybWF0dGVkRGF0ZVRpbWUgc3RhcnRlZCIpOwogICAgdmFyIGZvcm1hdHRlZERhdGVUaW1lID0gIiI7CiAgICB2YXIgdG9kYXkgPSBuZXcgRGF0ZSgpOwogICAgCiAgICB2YXIgc3MgPSB0b2RheS5nZXRTZWNvbmRzKCk7CiAgICB2YXIgbW0gPSB0b2RheS5nZXRNaW51dGVzKCk7CiAgICB2YXIgaGggPSB0b2RheS5nZXRIb3VycygpOwogICAgdmFyIGRkID0gdG9kYXkuZ2V0RGF0ZSgpOwogICAgdmFyIE1NID0gdG9kYXkuZ2V0TW9udGgoKSsxOyAKICAgIHZhciB5eXl5ID0gdG9kYXkuZ2V0RnVsbFllYXIoKTsKICAgIHZhciBvZmZzZXQgPSB0b2RheS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgCiAgICBpZihzczwxMCkgCiAgICB7CiAgICAgICAgc3M9JzAnK3NzOwogICAgfSAKICAgIAogICAgaWYobW08MTApIAogICAgewogICAgICAgIG1tPScwJyttbTsKICAgIH0KICAgIAogICAgaWYoaGg8MTApIAogICAgewogICAgICAgIGhoPScwJytoaDsKICAgIH0gCiAgICAKICAgIGlmKGRkPDEwKSAKICAgIHsKICAgICAgICBkZD0nMCcrZGQ7CiAgICB9IAogICAgCiAgICBpZihNTTwxMCkgCiAgICB7CiAgICAgICAgTU09JzAnK01NOwogICAgfQogICAgCiAgICB2YXIgdGltZXpvbmUgPSAiIjsKICAgIAogICAgaWYob2Zmc2V0ID09IDI0MCkgey8vaWYgaXQgaXMgYSA0IGhvdXIgZGlmZmVyZW5jZSB0aGVuIHdlIGFyZSBvbiBFRFQKICAgICAgICB0aW1lem9uZSA9ICJFRFQiOwogICAgfSBlbHNlIGlmKG9mZnNldCA9PSAzMDApIHsvL2lmIGl0IGlzIGEgNSBob3VycyBkaWZmIHRoZW4gd2UgYXJlIGluIEVTVAogICAgICAgIHRpbWV6b25lID0gIkVTVCI7CiAgICB9IGVsc2Ugey8vYWRkaW5nIHRoZSBlbHNlIGJsb2NrIGFzIGEgc2FmZSBzaWRlIGlmIHRoZSB0aW1lem9uZSBpcyBub3QgRURUIG9yIEVTVAogICAgICAgIHRpbWV6b25lID0gb2Zmc2V0OyAvL2RpdmlkZSBvZmZzZXQgYnkgNjAgdG8gZ2V0IHRoZSBob3VycyBkaXN0YW5jZQogICAgfQogICAgCiAgICBmb3JtYXR0ZWREYXRlVGltZSA9IHl5eXkgKyAiLSIgKyBNTSArICItIiArIGRkICsgIiAiICsgaGggKyAiOiIgKyBtbSArICI6IiArIHNzICsgIiAiICsgdGltZXpvbmU7CiAgICBhbGVydCgiZ2V0Rm9ybWF0dGVkRGF0ZVRpbWUgZmluaXNoZWQgOiAiICsgZm9ybWF0dGVkRGF0ZVRpbWUpOwogICAgcmV0dXJuIGZvcm1hdHRlZERhdGVUaW1lCn0KLy9BSFMyMDIyMDcxMSAtIGFkZGVkIGEgbmV3IGZ1bmN0aW9uICwgdGhpcyB3aWxsIGJlIGNhbGxlZCBhdCB0aGUgYmVnaW5pbmcgb2YgdGhlIGluZGV4IHJ1bGUgLSBzdGFydAp6RGF0YS5jbGllbnRJbmRleFZhbGlkYXRpb249ZnVuY3Rpb24oKSB7IAogICAgdmFyIGlzVmFsaWQgPSB0cnVlOwoJCgl6RGF0YS5jYXRlZ29yeU1hcHBpbmdzID0gewoJCSdEZW5pYWxzJzogewoJCQlzdWJjYXRlZ29yeTogJ1JldmlldyBEZW5pYWwnLAoJCQlyZWNvcmRUeXBlOiAnUGF0aWVudCcKCQl9LAoJCSdBcHByb3ZhbHMnOiB7CgkJCXN1YmNhdGVnb3J5OiAnUmV2aWV3IEFwcHJvdmFsJywKCQkJcmVjb3JkVHlwZTogJ1BhdGllbnQnCgkJfSwKCQknQ29uZmlybWF0aW9uJzp7CgkJCXN1YmNhdGVnb3J5OiAnUmV2aWV3IENvbmZpcm1hdGlvbicsCgkJCXJlY29yZFR5cGU6ICdQYXRpZW50JwoJCX0sCgkJJ09uZVBhdGggRm9ybSc6IHsKCQkJc3ViY2F0ZWdvcnk6ICdSZXZpZXcgT25lUGF0aCBGb3JtJywKCQkJcmVjb3JkVHlwZTogJ1BhdGllbnQnCgkJfSwKCQknUHJvZ3JhbSBDb25zZW50JzogewoJCQlzdWJjYXRlZ29yeTogJ1JldmlldyBQcm9ncmFtIENvbnNlbnQgRm9ybScsCgkJCXJlY29yZFR5cGU6ICdQYXRpZW50JwoJCX0sCgkJJ0NvbW11bmljYXRpb24gQ29uc2VudCc6IHsKCQkJc3ViY2F0ZWdvcnk6ICdSZXZpZXcgQ29tbXVuaWNhdGlvbiBDb25zZW50IEZvcm0nLAoJCQlyZWNvcmRUeXBlOiAnUGF0aWVudCcKCQl9LAoJCSdJbnN1cmFuY2UnOiB7CgkJCXN1YmNhdGVnb3J5OiAnUmV2aWV3IGluc3VyYW5jZSBGb3JtJywKCQkJcmVjb3JkVHlwZTogJ1BhdGllbnQnCgkJfSwKCQknUGF0aWVudCBEb2N1bWVudHMnOiB7CgkJCXN1YmNhdGVnb3J5OiAnUmV2aWV3IFBhdGllbnQgRG9jdW1lbnQnLAoJCQlyZWNvcmRUeXBlOiAnUGF0aWVudCcKCQl9LAoJCSdSRU1TJzogewoJCQlzdWJjYXRlZ29yeTogJ1JldmlldyBSRU1TIERvY3VtZW50JywKCQkJcmVjb3JkVHlwZTogJ1BhdGllbnQnCgkJfSwKCQknT3RoZXInOiB7CgkJCXN1YmNhdGVnb3J5OiAnUmV2aWV3IE90aGVyIERvY3VtZW50JywKCQkJcmVjb3JkVHlwZTogJ1BhdGllbnQnCgkJfSwKCQknSENQIERvY3VtZW50cyc6IHsKCQkJc3ViY2F0ZWdvcnk6ICdSZXZpZXcgSENQIERvY3VtZW50cycsCgkJCXJlY29yZFR5cGU6ICdIZWFsdGggQ2FyZSBQcm9mZXNzaW9uYWxzJwoJCX0sCgkJJ1NPQyBEb2N1bWVudHMnOiB7CgkJCXN1YmNhdGVnb3J5OiAnUmV2aWV3IFNPQyBEb2N1bWVudHMnLAoJCQlyZWNvcmRUeXBlOiAnU2l0ZSBvZiBDYXJlJwoJCX0sCgl9OwogICAgCiAgICB2YXIgYWNjb3VudElkID0gWChkb2MsIlhfQWNjb3VudF9fYyIpOwogICAgaWYoYWNjb3VudElkKSB7CiAgICAgICAgekRhdGEuYWNjb3VudElkID0gYWNjb3VudElkOwogICAgfQogICAgCiAgICB2YXIgcHJvZHVjdElkID0gWChkb2MsIlhfUHJvZHVjdF9fYyIpOwogICAgaWYocHJvZHVjdElkKSB7CiAgICAgICAgekRhdGEucHJvZHVjdElkID0gcHJvZHVjdElkOwogICAgfQogICAgCiAgICAvL0FIUzIyMDgwOSAtIG1vdmluZyBhY2Njb3VudCB2YWxpZGF0aW9uIGJlZm9yZSBwcm9kdWN0IHZhbGlkYXRpb24KICAgIHZhciBjYXRlZ29yeSA9IFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwogICAgaWYoYWNjb3VudElkKSB7CiAgICAgICAgdmFyIHJlY29yZFR5cGVOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJBY2NvdW50IiwgIlJlY29yZFR5cGUuTmFtZSIsIG51bGwsIGFjY291bnRJZCk7CiAgICAgICAgaWYocmVjb3JkVHlwZU5hbWUgIT09IHpEYXRhLmNhdGVnb3J5TWFwcGluZ3NbY2F0ZWdvcnldLnJlY29yZFR5cGUpIHsKICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgJ2FsZXJ0KCJQbGVhc2UgZ28gYmFjayB0byB0aGUgVHJpYWdlIFBhbmVsIGFuZCB2ZXJpZnkgdGhlIHNlbGVjdGVkIEFjY291bnQuIik7Jyk7CiAgICAgICAgICAgIHJldHVybiBpc1ZhbGlkOwogICAgICAgIH0KICAgIH0KICAgIAogICAgLy9pZiBhY2NvdW50IGFuZCBwcm9kdWN0IGJvdGggYXJlIHNlbGVjdGVkLCB3ZSBoYXZlIHRvIGFzc29jaWF0ZSB0aGVkb2N1bWVudCB3aXRoIFByb2R1Y3QgZGV0YWlsCiAgICBpZihhY2NvdW50SWQgJiYgcHJvZHVjdElkKSB7CiAgICAgICAgekRhdGEucHJvZHVjdERldGFpbElkID0gZ2V0U0ZSZWNvcmRJRChkb2MsICJDYXJlUHJvZ3JhbUVucm9sbGVlUHJvZHVjdCIsIHsiQ2FyZVByb2dyYW1Qcm9kdWN0SWQiOiBwcm9kdWN0SWQsICJUS19QYXRpZW50X05hbWVfX2MiOiBhY2NvdW50SWR9KTsKICAgICAgICBhbGVydCgicHJvZHVjdERldGFpbElkIDogIiArIHpEYXRhLnByb2R1Y3REZXRhaWxJZCk7CiAgICAgICAgCiAgICAgICAgaWYoIXpEYXRhLnByb2R1Y3REZXRhaWxJZCkgewogICAgICAgICAgICAvL2lmIHByb2R1Y3QgZGV0YWlsIGlkIGlzIG5vdCBmb3VuZCBkb25vdCBwcm9jZWVkIHRocm93IGFuIGVycm9yIGFuZCByZXR1cm4KICAgICAgICAgICAgLy90aHJvdyAiQXNzaWduIERvY3VtZW50IHdhcyB1bnN1Y2Nlc3NmdWwgYXMgUHJvZHVjdCBEZXRhaWwgcmVjb3JkIHdhcyBub3QgZm91bmQiOwogICAgICAgICAgICAvL2FkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAnYWxlcnQoIkFzc2lnbiBEb2N1bWVudCB3YXMgdW5zdWNjZXNzZnVsIGFzIFByb2R1Y3QgRGV0YWlsIHJlY29yZCB3YXMgbm90IGZvdW5kIik7Jyk7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAnYWxlcnQoIlBsZWFzZSBnbyBiYWNrIHRvIHRoZSBUcmlhZ2UgUGFuZWwgYW5kIHZlcmlmeSB0aGUgc2VsZWN0ZWQgUHJvZHVjdC4iKTsnKTsKICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gaXNWYWxpZDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiBpc1ZhbGlkOwp9Ci8vQUhTMjAyMjA3MTEgLSBhZGRlZCBhIG5ldyBmdW5jdGlvbiAsIHRoaXMgd2lsbCBiZSBjYWxsZWQgYXQgdGhlIGJlZ2luaW5nIG9mIHRoZSBpbmRleCBydWxlIC0gZW5kCmFsZXJ0KCJlbmQgY2xpZW50IGxpYnJhcnkiKTsgLy9FUlMxOTA2MTUgIzU4OTIx"},"ordinal":1}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("start client library"); //ERS190803 #52661 from OccFit
//ERS201117 TODO get rid off these keywords and use a document journey wizard from KPS and Jake

//CRN201025 #76788 Moved from zStack Library so that it can be used in multiple rules.
var keywordMap={};
var keywords=["NEW:Document Stack~","ENRL:Enrollment~","ENRL:ENROLLMENT~","CONS:Consent~","CON:consent~","FAC:Setting~","FAC:Distribution~","START:Start Form~","CHK:Checklist~","HIPAA:AUTHORIZATION~","HIPAA:HIPAA~","HIPAA:PORTABILITY~","REF:REFERRAL","REF:Referral","FIN:W2~","IC:Member ID~","FAX:"];
//keywordMap["TENR"] ="TENR:Start Form";
keywordMap["NEW"] ="NEW:Document Stack";
keywordMap["ENRL"] ="ENRL:Enrollment Form";
keywordMap["FAC"] ="FAC:Facility Enrollment Form";
keywordMap["FAX"] ="NEW:Document Stack";
//keywordMap["START"] ="NEW:Document Stack";
keywordMap["CON"] ="CON:Consent Form";
keywordMap["HIPAA"] ="HIPAA:HIPAA Authorization";
keywordMap["REF"] ="REF:Referral";
keywordMap["FW2"] ="FW2:W-2"; //JPB201023 added
keywordMap["I9"] ="I9:I-9"; //JPB201023 added
keywordMap["W4"] ="W4:W-4"; //JPB201023 added
keywordMap["DEM"] ="DEM:Demographics"; //CRN201026 added
keywordMap["CLIN"] ="CLIN:Clinical Notes"; //CRN201026 added
keywordMap["FIN"] ="FIN:Financial Info"; //CRN201026 added
keywordMap["IC"] ="IC:Insurance Card"; //CRN201026 added
keywordMap["CONS"] ="CONS:Consent";

zData.maxChannels=3; //ERS190731 #61272 zippi is strongly typed
zData.makeStack=true; //ERS190814 #61511

zData.watermark=""+XCustomSetting(doc,"watermark__c"); //ERS190618 best practice
//alert("ERS190411 wm="+zData.watermark+" ZPAPER__server__c="+XCustomSetting(doc,"ZPAPER__server__c"));
zData.uploadDir = ""+XCustomSetting(doc,"uploadDir__c"); //"alkermesRoot";
zData.patEnrollQueueId = ""+XCustomSetting(doc,"patientQueueId__c"); //'00G4C000000LkmZ'; //insert the Queue ID of the desired ownership queue. Update when migrating between environments. Need to add this queue in Setup
zData.recTypeRequest = ""+XCustomSetting(doc,"recTypeRequest__c"); //'0124C000000Cj5Y'; //ID of the Case Record Type Request_PS_MVN
//TODO zData.keywordMap["ENRL"] ="ENRL:Enrollment Form";  //TODO get from zStack picklists
//TODO zData.keywordMap["FAC"] ="FAC:Facility Enrollment Form";
//ERS200205 deleted demo data - do with custom settings

var cs=XDeploymentInfo(doc, "Business_Process__c"); //ERS200222 need both deployment info and cs
//alert("cs="+cs);
if (cs) {
    if (cs.indexOf("zCustomSettings")>-1) cs=X(doc,"zCustomSettings",cs);
    alert("ERS200225 EVAL on "+cs);
    if (cs !== "") eval(""+cs); //ERS200222 TODO JSON.parse() //ERS200225 beeds to be eval but also needs to work!!!
    alert("No try just do!");
}

if (1===0 && !zData.childStackRecordType) { //TODO custom setting or deployment? //ERS201129 DONE in zChildFields
    alert("ERS201128 should be in custom settings zChildFields");
    zData.childStackRecordType="01211000001gBs3AAE"; //ERS201128 should be in custom settings zChildFields "0120R000001N2oI";
}

zData.clientImportSOQL=function(doc,fromFile) { //ERS190706 customize imports used by Create Stack
    zData.importer=XCustomSetting(doc,zData.zp+"Importer__c").trim();
    var sfId="";
    var parts=fromFile.split("_");
    //sfId = getSFRecordID(doc, "Account", { "Fax" : parts[3] } );
    zData.makeStack=true; //do all the work there by default
    return sfId;
};

//alert("zData.clientStack");
zData.clientStack=function(doc,arrOfPairs) { //zData or this?
    var zp=zData.zp; if (!zp) zp="ZPAPER__"; //ERS190805 
  if (zData.received) arrOfPairs.push("zStack_Received__c", zData.formatNow); //ERS190617 TODO save way to do this
  if (zData.ownerId) arrOfPairs.push("OwnerId",zData.ownerId);  // zCharta Queue "00G36000002CyTK" 
  if (zData.callerId) arrOfPairs.push("zCaller_ID__c", doc.deliveredFrom); //MSH170817 added
  if (zData.patEnrollQueueId) arrOfPairs.push("OwnerId",zData.patEnrollQueueId);
  
    arrOfPairs.push("ZPAPER__faxType__c", zData.docType);
    arrOfPairs.push("ZPAPER__Classification__c", zData.classification);
    var pageRange = X(doc,"X_idxPages");
    if (!pageRange) pageRange="1-"+X(doc,"X_pages"); 
    var pageCount = zData.countPages(doc, pageRange);
    arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 
    //ERS190810 TODO? arrOfPairs.push("ZSTACK__Received__c", zData.formatNow);
    alert("ERS200213.51 pageRage="+pageRange + " but pageCount="+pageCount); //ERS200213 also called in new incoming stack
    if (!X(doc,"X_idxPages")) pageCount=X(doc,"X_pages"); //ERS200213 TODO fix zData.countPages()
    arrOfPairs.push("ZPAPER__Pages__c", pageCount);
    
    //ERS200204 TODO zStack.Program?

    if (zData.programName === zData.PROGRAM_ZCHARTA) { //JPB201023 changed from classification to programName
      arrOfPairs.push(zp+"Priority__c", "Urgent"); //JPB190426 changed to classification from program
    } else if (zData.programName === zData.PROGRAM_ZPAPYRUS) { //JPB201023 changed from classification to programName
      arrOfPairs.push(zp+"Priority__c", "High"); 
    } else if (zData.programName === zData.PROGRAM_ZCARTA) { //JPB201023 changed from classification to programName
      arrOfPairs.push(zp+"Priority__c", "Critical");  
    } else {
      arrOfPairs.push(zp+"Priority__c", "Normal");
    }
    
    arrOfPairs.push(zp+"sentFaxTo__c", ("Community" === zData.channel ? zData.channel : doc.deliveredTo)); //JPB190529 added so Community shows up in Master Intake List
    arrOfPairs.push(zp+"From__c",doc.deliveredFrom);
    if (zData.reviewedStatus) {arrOfPairs.push(zp+"Stage__c", zData.reviewedStatus); } 
    else { arrOfPairs.push(zp+"Stage__c", "Received"); }
    zData.stackPairs=arrOfPairs; //ERS190810 #61570 for child stack later
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__zStackFields__c")); //ERS190803 #52661 using JSON 
  return arrOfPairs;
};

//alert("zData.clientFile");
zData.clientFile=function(doc,stage) { //ERS170829 #41298 returns a label to be used in any attaches and fixes the doc
    //Document attachment label should be "Patient Name - Doc Type - Date".  Confirmed for zPaper File and SFDC Attachment
    var MMddYYYY = zData.formatTodayMMddYYYY();
    //CRN201025 #76788 Fixed to match the current demo.
    var patientName = X(doc,"X_ZPAPER__PatientAccount__r.Name");
    if (!patientName) {
        patientName = X(doc,"X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c");
    }
    var faxType = keywordMap[X(doc,"X_ZPAPER__faxType__c")];
    if (!faxType) { faxType = X(doc,"X_ZPAPER__faxType__c"); }
    if (!faxType.indexOf(':') >= 0) { faxType = faxType.split(':')[1]; }
    // doc.label = patientName + " - " + faxType + " - " + MMddYYYY;
    doc.label = patientName + " - " + faxType;
    if (!patientName || patientName.length<5) { //ERS201129 #78830
        doc.label="Split from "+X(doc,"X_splitPages")+" of "+ X(doc,"X_fromPages") +" - "+MMddYYYY;
        doc.label="Split from "+ X(doc,"X_fromPages") +" - "+MMddYYYY; 
    } 
    alert("ERS170829 dbID="+doc.dbID+" label="+doc.label);
    if (zData.sfID  && zData.sfID.indexOf("500")===0) {
      zData.provider = getSFField(doc, "Case", "Account.Name", null, zData.sfID); 
      label = "Received from " + zData.provider;
        if (zData.facility) {
            zData.facility = getSFField(doc, "Case", "Account.Facility__r.Name", null, zData.sfID);
            doc.label+=" at "+zData.facility;
        }
  }
  var arrOfPairs = [];
    arrOfPairs.push("db-label", doc.label);
  updateDB(doc,arrOfPairs);
    return doc.label;
};

zData.clientValue=function(doc,val) {//ERS190803 #52661 using JSON 
    val=val.replace("{!formatNow}",zData.formatNow);
    return val;
}

zData.clientFields=function(doc,arrOfPairs,jd,zd) { //ERS190803 #52661 using JSON in setting to configure new record
    if (!zd) zd=zData;
  if (jd && jd.indexOf("{")===0) { 
      //{"Type":"Eligibility","OwnerId":"00Gc0000003vgqw","RecordTypeId":"0126A000000JEKeQAO"};
      //NOT A GOOD IDEA jd=jd.replaceAll("\"","'"); //ERS190811 #61570 HACK?
      jd=jd.replace("};","}"); //ERS201129 SHR to work out design on channel wizard for zStack child set ASAP
      try {
          var jdata=JSON.parse(jd); //ERS190805 better than eval
          for (var n in jdata) {
              var v0=jdata[n]; 
              var v=zData.clientValue(doc,v0); //ERS190811 ,v now ,v0
              alert("ERS190803.97 "+n+"="+v0+"="+v); 
              arrOfPairs.push(n,v); //ERS190811 added .push
              zd[n]=v; //ERS201129 #78830 TODO review arrOfPairs access using for RecordTypeId
          }
      } catch (e) {
          alert("JSON not in "+jd+" Exception: "+e); //ERS190811 added e
      }
  }
  return arrOfPairs;
}


zData.clientCase=function(doc,arrOfPairs,label,zd) {
  if (!zd) zd=zData;
  if (!zd.triageType && X(doc,"X_ZPAPER__faxType__c")) zd.triageType=X(doc,"X_ZPAPER__faxType__c"); //ERS200308
  if (!label) { label="Indexed-" + "-" + zd.triageType + "-" + zd.stackId;}
  
  alert("ERS200308.128 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
  
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  if (zd.contactId) arrOfPairs.push("ContactId", zd.contactId);
  arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
  arrOfPairs.push("Status", X(doc,"X_Status"));
  arrOfPairs.push("ZPAPER__faxType__c",zd.triageType); //ERS200308
  //ERS200205 arrOfPairs.push("Type", "New "+zd.classification); //JPB 170512 added these workflow fields
  //ERS200308 arrOfPairs.push("Type", "New "+zd.docType);
  if (1==1) { //ERS170523 #37162 after dryrun
      alert("@@@ zd.priority => *" + zd.priority + "*");
    //arrOfPairs.push("RecordTypeId","012Q00000005Ahj"); //ERS170523 Prior Auth
    if (zd.priority != "Normal") { arrOfPairs.push("Priority",zd.priority); }  //ERS170524 #37162 priority on Case
    else { arrOfPairs.push("Priority","Medium"); }
    arrOfPairs.push("Origin","Fax"); //ERSa200205 rrOfPairs.push("Origin",zd.channel);
  }
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__CaseFields__c")); //ERS190803 #52661 using JSON
    
    alert("ERS200308.143 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
    if (zd.providerId && zd.providerId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.providerId); } //ERS200308
    if (zd.providerId && zd.providerId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.providerId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.patientId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.patientId); } //ERS200308
    if (zd.zchannel.owner) { arrOfPairs.push("OwnerId", zData.zchannel.owner); } //ERS200308
    
  var caseId = createAndAttach(doc, "Case", label, arrOfPairs);
  return caseId;
};

zData.clientPatient=function(doc,arrOfPairs,label,zd) {
  if (!zd) zd=zData;
  if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
  if (zd.patientId) { //ERS200205 #68825 Program Members
      alert("Patient already exists in "+zd.patientId);
      return zd.patientId; //TOOD get from X_patientId  ????
  }
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  var p="ZPAPER__"; //ERS200202 assume workflow on related record types
  if (zData.patientType.indexOf("__c") > -1) { p=""; } //ERS200203 typo
  if (1==0) { //ERS200202 see if workflow enabled
      arrOfPairs.push(p+"newFax__c", "true"); //JPB 170512 added these workflow fields
      arrOfPairs.push(p+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
      arrOfPairs.push(p+"receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
  }

    var rt=XCustomSetting(doc,"PatientRecordType__c"); //TODO into MP ERS190802 like 0126A000000JE8yQAG or empty to use default
    //if (rt) { arrOfPairs.push("RecordTypeId", rt); } //ERS190803
    //TODO Contact or Account ERS190624 DONE!! ERS190802
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__PatientFields__c")); //ERS190803 #52661 using JSON 
    arrOfPairs=[]; //ERS200204 testing to get it going
    
    //ERS200202 need to make the Account with Patient recordType first
    //01246000000NGFYAA4 is .zpaper for Patient
    var ar = [];
    if (rt) { ar.push("RecordTypeId", rt); } //ERS190803 //ERS200222 #69149 moved down and added else 
    else ar.push("RecordTypeId","01246000000NGFYAA4");
    ar.push("FirstName",zData.X_ZPAPER__FirstName__c);
    ar.push("LastName",zData.X_ZPAPER__LastName__c);
    var patientName=zData.X_ZPAPER__LastName__c+", "+zData.X_ZPAPER__FirstName__c;
    if (zData.X_ZPAPER__Birthdate__c) ar.push("PersonBirthDate",zData.X_ZPAPER__Birthdate__c);
    var aId = createSFRecord(doc, "Account", null, ar); //ERS200204 person account so do not set patientName
    
    if (aId && aId != "NEW" && aId.indexOf("ERROR")==-1) {
        var sfId = "";
      
      //ERS190803 specific to client data entry
      var dq = zData.dq;
      addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c" + dq + ").val(" + dq + sfId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
    }
    return {'ERROR': 'patient not created'}
};

zData.clientAccount=function(doc,arrOfPairs,label,zd) {
  if (!zd) zd=zData;
  if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields

  var accountId = createAndAttach(doc, "Account", label, arrOfPairs);
  return accountId;
};

zData.clientRecord=function(doc,sfType,arrOfPairs,label,zd) { //ERS190620 clientRecord generic
  if (!zd) zd=zData;
  if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  var zp="";
  if (",Case,Contact,Account,Lead,Opportunity,ZPAPER__zStack__c,".toLowerCase().indexOf(","+sfType.toLowerCase()+",")>-1) zp=zData.zp;
  //only do this if the fields exist
  arrOfPairs.push(zp+"newFax__c", "true"); //JPB 170512 added these workflow fields
  arrOfPairs.push(zp+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
  arrOfPairs.push(zp+"receivedId__c", "doc.dbID.Rec"); //JPB 170512 added these workflow fields
  
  //TODO put client specific data updates here

  var newId = createAndAttach(doc, sfType, label, arrOfPairs);
  return newId;
};

zData.clientComplete=function(doc,arrOfPairs,zd) {return arrOfPairs;}; //ERS190625
zData.clientDelivery=function(doc,arrOfPairs) { //ERS200202 TODO consider new Document_MVN
    return arrOfPairs;
}; //ERS190711 #60900 PAOS

zData.clientChildStack=function(doc,arrOfPairs,parentId) { //ERS190810 #61570 be sure to call on new child doc
    //AHS220627 - adding subcategory value to child stack - start
    zData.subcategory = zData.categoryMappings[zData.docType].subcategory;
    if(zData.subcategory) {
        arrOfPairs.push("Subcategory__c", zData.subcategory);
    }
    //AHS220627 - adding subcategory value to child stack - end
    
    //AHS220627 - adding Account id, Product Id value to child stack - start
    //var accountId = X(doc,"X_Account__c");
    if(zData.accountId) {
        arrOfPairs.push("Account__c", zData.accountId);
    }
    
    //var productId = X(doc,"X_Product__c");
    if(zData.productId) {
        arrOfPairs.push("Product__c", zData.productId);
    }
    
    if(zData.productDetailId) {
        arrOfPairs.push("Product_Detail__c", zData.productDetailId);
    }
    
    // if(zData.accountId && zData.productId) {
    //     zData.productDetailId = getSFRecordID(doc, "CareProgramEnrolleeProduct", {"CareProgramProductId": zData.productId, "TK_Patient_Name__c": zData.accountId});
    //     alert("productDetailId : " + zData.productDetailId);
        
    //     if(zData.productDetailId) {
    //         arrOfPairs.push("Product_Detail__c", zData.productDetailId);
    //     } else {
    //         //if product detail id is not found donot proceed throw an error and return
    //         //throw "Assign Document was unsuccessful as Product Detail record was not found";
    //         addPostExecutionScript(doc, 'alert("Assign Document was unsuccessful as Product Detail record was not found");');
    //         return;
    //     }
    // }
    //AHS220627 - adding Account id, Product Id value to child stack - end
    
    var pairs=arrOfPairs;
    
    //no memory of stack creation var pairs=zData.stackPairs;
    //CRN201026 #76788 We need reviewedStatus to be "Indexed" for the index rule, so only set the field if it isn't already set.
    if (!zData.reviewedStatus) { zData.reviewedStatus="Split"; }
    //ERS190810 TODO? pairs.push("ZPAPER__Status__c", "Child Stack");

    pairs=zData.clientStack(doc,pairs);
    if (XCustomSetting(doc,"ZPAPER__zChildFields__c")) { //ERS190811 not in all MPs
        pairs=zData.clientFields(doc,pairs,XCustomSetting(doc,"ZPAPER__zChildFields__c")); //ERS190803 #52661 using JSON child record type id
    }
    pairs.push("ZPAPER__Parent__c", parentId);
    //ERS201128 should be in zChildFields if (zData.childStackRecordType) pairs.push("RecordTypeId",zData.childStackRecordType);
    
    //pairs.push(""+"Program__c",zData.programName); //ERS200205 TODO in package and into base call
    pairs.push("ZPAPER__Program__c",zData.programName);
    //ERS200229 if (zData.patientId) pairs.push("Program_Member_MVN__c",zData.patientId); //ERS200205 Program_Member_MVN__c was the TICKET!!!
    alert("ERS190811.191 ZPAPER__Parent__c"+ parentId+" child zData.childStackRecordType="+zData.childStackRecordType);
    if (zData['RecordTypeId']) {  zData.childStackRecordType=zData['RecordTypeId']; } //ERS201129 #78830 TODO not sure where this is used elsewhere
    alert("ERS201129.292 ZPAPER__Parent__c"+ parentId+" child RecordTypeId="+zData['RecordTypeId']);
    alert("testing pairs before createandattach : " + pairs);
    var childStackSFId = createAndAttach(doc, "ZPAPER__zStack__c", "zStack split on " + zData.formatNow, pairs) + "";
    
    if (!zData.patientId && X(doc,"X_ZPAPER__PatientAccount__c") ){ //ERS200308 HACK
        zData.patientId=X(doc,"X_ZPAPER__PatientAccount__c");
        alert("ERS200308 WHY NOT in zData?");
    }
    /*
    //commented as Timeline is not in use
    if (zData.patientId) { //ERS200308 create an Activity Event related to the Patient (Account) for the Timeline
        if (!zData.docType && X(doc,"X_ZPAPER__faxType__c")) zData.docType=X(doc,"X_ZPAPER__faxType__c");
        var arr=[];
        //NOT SELECT AccountId,ActivityDate,CreatedDate,Status,Subject,TaskSubtype,WhatId,WhoId FROM Task where ActivityDate > 2020-02-01
        //SELECT Id,AccountId,ActivityDate,CreatedDate,Subject,WhatId,WhoId FROM Event where Id = '00U4T000002vChrUAE'
        //arr.push("WhoId",zData.patientId); //ERS200310 timeline trick
        if (zData.patientId.indexOf("001")==0) {
            arr.push("WhatId",zData.patientId); //ERS200310 timeline trick
            //arr.push("AccountId",zData.patientId); //ERS200310 timeline trick
        } else if (zData.caseId) arr.push("WhatId",zData.caseId);
        else if (zData.providerId) arr.push("WhatId",zData.providerId);
        else arr.push("WhatId",childStackSFId);
        //arr.push("TaskSubtype","Task");
        arr.push("Subject",zData.stage + " "+zData.docType);
        arr.push("Description","Check out "+doc.dbID);
        //arr.push("ActivityDateTime",zData.formatNow); //ERS200309 hacking away!
        arr.push("ActivityDate",zData.formatNow.substring(0,10));
        arr.push("RecordTypeId","0124T0000008aFmQAI"); //ERS200310 HACK for Task on CarePlan
        //arr.push("DurationInMinutes","5");
        //arr.push("Status","Completed");
        
        var label="Timeline "+zData.docType;
        var actId = createSFRecord(doc, "Task", null, arr); //ERS200309 null means no Name field
        //var actId = createSFRecord(doc, "Event", null, arr); //ERS200309 null means no Name field
        alert("ERS200308.262 timeline activity "+actId);
    } else { alert("ERS200308.263 be worried there is no patient!"); }
    */
    if (1===1 && zData.clientReceivedDocument) { zData.recDocId=zData.clientReceivedDocument(doc,childStackSFId); } //ERS201018 #77252
    return childStackSFId;
};


zData.clientStackComplete=function(doc,arrOfPairs,zd) { //ERS200314 #70336
    if (!zd) zd=zData; //ERS200406 #71156
    arrOfPairs.push("Time_Complete_Date__c",zd.formatNow); //for dashboard
    return arrOfPairs;
}; //ERS190625

zData.clientAttachPopulatefields=function(doc,arrOfPairs,patientId,parentId,childId){ //[VJ - populate fields and attach indexed pages to lookups]

  var zparentId = parentId;
  var zchildId = childId;
  var attachLabel=zData.clientFile(doc,"Indexed"); //"Indexed " + formatNow;
  
  if ((zparentId && zparentId.length > 0) && (zchildId && zchildId.length > 0)) {
    var arrOfPairs = [];
    
    arrOfPairs.push("Document_Received_Date__c", receivedDate);
    updateSFRecord(doc,zData.zps, zchildId, arrOfPairs);
  }
  
  return null;
}

zData.clientLightningFile=function(doc,sfId,zd,childStackId) { //use in index client library
  
if (!zd) zd=zData;
    if (!doc.kbData.sfServer) {   
    //ERS200428 HACK
    alert("doc.kbData.sfServer was empty. Ideally should NOT come here"); doc.kbData.sfServer="takedapatientservices--tkdev2.lightning.force.com"; 
  }
    var zserver = doc.kbData.sfServer.indexOf("https://")==0 ? doc.kbData.sfServer : "https://" + doc.kbData.sfServer; 
  // Salesforce REST API endpoint
    var docurl = zserver + "/services/data/v46.0/sobjects/ContentVersion/";
    var pdfurl = "https://gw.zpaper.com/kb/jsp/SF_find.lightning.jsp?go=SF_files.jsp&dbID=" + doc.dbID + "&SForg=" + doc.kbData.sfOrganizationID;

  // Generate PDF file from zStack
    var formatNow = getCurDateAndTime(doc,false,true); // e.g. "20210210-052132"?
    var arrOfPairs = [];
    var nowTimeStamp = new Date().getTime() + ""; 
    
    var fileName = getCurDate(doc)+" "+zData.docType+".pdf";  // e.g - "20210210 New Fax.pdf"?//
    alert("@@@fileName = "+fileName);
  
  zData.uploadDir = 'zStackUploadRoot'; //setting root directory for file creation
  
    // create directory to place generated PDF file
    createDirectory(doc, zData.uploadDir, nowTimeStamp);
   
    var xPages = X(doc, "X_position"); //get X_position - page range selected; default = all pages
    alert("@@@@@ Calling splitPDF to split off pages to upload as PDF, pages = " + xPages + ", nowTimeStamp = " + nowTimeStamp);
    var response = splitPDF(doc, xPages, zData.uploadDir, nowTimeStamp, fileName);
    alert("@@@@ response from splitPDF = " + response);
    var newPDFName = X(doc, "newPDF", response); // set value of newPDF
    
    alert("@@@@ split PDF FileName = " + newPDFName);

  // Cannot directly Append PDF file to multipart formdata
  // JS does not allow reading a file from the file system (normally applies to client side for security reasons)
  // We dont have a Node.js container, so no luck there.. have to do this another way
  // Eric suggested we use uploadToCloud.jsp approach to create Lightning File (probably ContentDocument) in Salesforce
  
    //var uploadURL="http://localhost:8080/myfileforce/uploadToCloud.jsp?SFid=NEW&SFpid="+sfId+"&SForg="+doc.sfOrg+"&label="+fileName+"&serverFile="+newPDFName+"&Description=File attached as PDF";
  //AN20210903 #81766 need SFtype=ContentVersion parameter to upload as Lightning File
  //var uploadURL="http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid="+sfId+"&SForg="+doc.sfOrg+"&label="+fileName+"&serverFile="+newPDFName+"&Description=File attached as PDF";
   var uploadURL="http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid="+sfId+"&SFServer="+doc.kbData.sfServer+"&SFSession="+doc.kbData.sfSessionID+"&label="+fileName+"&serverFile="+newPDFName+"&Description=File attached as PDF";
   alert("#### Upload native PDF with "+uploadURL);
  
    var r=wget(doc, uploadURL); // ????? will r contain the ContentDocument id? response of string value xml
  
  alert('value from wget response >>> '+r);
    
    var idxBegin = r.indexOf("<sfID>");
    var idxEnd = r.indexOf("</sfID>");
    var sfdocId;
  if(idxEnd > idxBegin) {
    sfdocId = r.substring(idxBegin+6,idxEnd);
    alert("sfDocId extracted from r : " + sfdocId);
      //var arrOfPairsContentDocument = [];//PV210507 added to test
    //need to get the current user id before we pass it to arrofpairs
    //arrOfPairsContentDocument.push("OwnerId", "00502000000b6YCAAY");
   // updateSFRecord(doc, 'ContentDocument', sfdocId, arrOfPairsContentDocument);
  }
  
    // Finally, delete the folder and all contents.
    cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);

  //Get the contentVersion record of the attachment
  var conVId = getSFField(doc, "ContentVersion", "Id",'ContentDocumentId=\''+sfdocId+'\'',null);
  
  //zStack__c,TK_Document_Date__c
    var arrOfPairs = [];
  arrOfPairs.push("zStack__c", childStackId); 
  var docSigDate = X(doc, "X_Document_Signature_Date__c"); //PV210402 
    if(docSigDate)
    arrOfPairs.push("TK_Document_Date__c",docSigDate);
  //arrOfPairs.push("TK_Document_Date__c", X(doc, "X_Document_Signature_Date__c"));
  //AHS220629 - commenting the existing category and subcategory field update - start
  /*
  alert("Doc type "+zData.docType);
  if(zData.docType == "CONS"){//PV210401 updated
    arrOfPairs.push("TK_Category__c", "Consent");
    arrOfPairs.push("TK_Sub_Category__c", "Review Consent Form");
  }else if(zData.docType == "REMS"){
    arrOfPairs.push("TK_Category__c", "REMS");
    arrOfPairs.push("TK_Sub_Category__c", "Review REMS Document");
  }else if(zData.docType == "SUP"){
    arrOfPairs.push("TK_Category__c", " SUP"); //PV210427 updated from SUP Form to SUP
    arrOfPairs.push("TK_Sub_Category__c", "Review SUP Document");
  }else if(zData.docType == "CONF"){
    arrOfPairs.push("TK_Category__c", "Confirmation");
    arrOfPairs.push("TK_Sub_Category__c", "Review Confirmation");
  }else if(zData.docType == "PDOC"){
    arrOfPairs.push("TK_Category__c", "Patient Documents");
    arrOfPairs.push("TK_Sub_Category__c", "Review Patient Document");
  }else if(zData.docType == "OTH"){
    arrOfPairs.push("TK_Category__c", "Other");
    arrOfPairs.push("TK_Sub_Category__c", "Review Other Document");
  }
  */
  //AHS220629 - commenting the existing category and subcategory field update - end
alert("Doc type JSON "+sfId);

//get Patient Name from Case
  var patientName;
  var patientId;
  var title = getSFField(doc, "ContentVersion", "Title",'ContentDocumentId=\''+sfdocId+'\'',null);
  if(zData.caseId){
    patientName= getSFField(doc, "Case", "TK_Takeda_Patient_Name__c", null, zData.caseId);
    patientId= getSFField(doc, "Case", "TK_Takeda_Patients_ID__c", null, zData.caseId);
	arrOfPairs.push("Title", patientName+' '+patientId+' '+title);
  }else{
	//patientId= getSFField(doc, "CareProgramEnrollee", "Account.TK_US_Takeda_Id__c", null, sfId);
	alert("@#" + getCurDateAndTime(doc, false, true));
	alert("@#" + getCurDateAndTime(doc, false, true, true));
	alert("@#" + getCurDateAndTime(doc, false));
	alert("@#" + getCurDateAndTime(doc, false, false));
	var dt = zData.getFormattedDateTime();
	//AHS220630 - setting title on lightning file and adding category and subcategory on file - start
	patientId= getSFField(doc, "ZPAPER__zStack__c", "Account__r.TK_US_Takeda_Id__c", null, childStackId);
	var fileLabel = patientId + " " + zData.docType + " " + dt;//getCurDate(doc, false);//getCurDateAndTime(doc, false, true, true);
	//arrOfPairs.push("Title", patientId+' '+title);
	arrOfPairs.push("Title", fileLabel);
	arrOfPairs.push("TK_Category__c", zData.docType);
    arrOfPairs.push("TK_Sub_Category__c", zData.subcategory);
	alert("childStackId " + childStackId);
	alert("patientId " + patientId);
	alert("arrOfPairs " + arrOfPairs);
	alert("title : " + patientId+' '+title);
	//AHS220630 - setting title on lightning file and adding category and subcategory on file - end
  }

  updateSFRecord(doc, 'ContentVersion', conVId, arrOfPairs);

  

    return null;
}


zData.getFormattedDateTime=function() {
    alert("getFormattedDateTime started");
    var formattedDateTime = "";
    var today = new Date();
    
    var ss = today.getSeconds();
    var mm = today.getMinutes();
    var hh = today.getHours();
    var dd = today.getDate();
    var MM = today.getMonth()+1; 
    var yyyy = today.getFullYear();
    var offset = today.getTimezoneOffset();
    
    if(ss<10) 
    {
        ss='0'+ss;
    } 
    
    if(mm<10) 
    {
        mm='0'+mm;
    }
    
    if(hh<10) 
    {
        hh='0'+hh;
    } 
    
    if(dd<10) 
    {
        dd='0'+dd;
    } 
    
    if(MM<10) 
    {
        MM='0'+MM;
    }
    
    var timezone = "";
    
    if(offset == 240) {//if it is a 4 hour difference then we are on EDT
        timezone = "EDT";
    } else if(offset == 300) {//if it is a 5 hours diff then we are in EST
        timezone = "EST";
    } else {//adding the else block as a safe side if the timezone is not EDT or EST
        timezone = offset; //divide offset by 60 to get the hours distance
    }
    
    formattedDateTime = yyyy + "-" + MM + "-" + dd + " " + hh + ":" + mm + ":" + ss + " " + timezone;
    alert("getFormattedDateTime finished : " + formattedDateTime);
    return formattedDateTime
}
//AHS20220711 - added a new function , this will be called at the begining of the index rule - start
zData.clientIndexValidation=function() { 
    var isValid = true;
	
	zData.categoryMappings = {
		'Denials': {
			subcategory: 'Review Denial',
			recordType: 'Patient'
		},
		'Approvals': {
			subcategory: 'Review Approval',
			recordType: 'Patient'
		},
		'Confirmation':{
			subcategory: 'Review Confirmation',
			recordType: 'Patient'
		},
		'OnePath Form': {
			subcategory: 'Review OnePath Form',
			recordType: 'Patient'
		},
		'Program Consent': {
			subcategory: 'Review Program Consent Form',
			recordType: 'Patient'
		},
		'Communication Consent': {
			subcategory: 'Review Communication Consent Form',
			recordType: 'Patient'
		},
		'Insurance': {
			subcategory: 'Review insurance Form',
			recordType: 'Patient'
		},
		'Patient Documents': {
			subcategory: 'Review Patient Document',
			recordType: 'Patient'
		},
		'REMS': {
			subcategory: 'Review REMS Document',
			recordType: 'Patient'
		},
		'Other': {
			subcategory: 'Review Other Document',
			recordType: 'Patient'
		},
		'HCP Documents': {
			subcategory: 'Review HCP Documents',
			recordType: 'Health Care Professionals'
		},
		'SOC Documents': {
			subcategory: 'Review SOC Documents',
			recordType: 'Site of Care'
		},
	};
    
    var accountId = X(doc,"X_Account__c");
    if(accountId) {
        zData.accountId = accountId;
    }
    
    var productId = X(doc,"X_Product__c");
    if(productId) {
        zData.productId = productId;
    }
    
    //AHS220809 - moving acccount validation before product validation
    var category = X(doc,"X_ZPAPER__faxType__c");
    if(accountId) {
        var recordTypeName = getSFField(doc, "Account", "RecordType.Name", null, accountId);
        if(recordTypeName !== zData.categoryMappings[category].recordType) {
            isValid = false;
            addPostExecutionScript(doc, 'alert("Please go back to the Triage Panel and verify the selected Account.");');
            return isValid;
        }
    }
    
    //if account and product both are selected, we have to associate thedocument with Product detail
    if(accountId && productId) {
        zData.productDetailId = getSFRecordID(doc, "CareProgramEnrolleeProduct", {"CareProgramProductId": productId, "TK_Patient_Name__c": accountId});
        alert("productDetailId : " + zData.productDetailId);
        
        if(!zData.productDetailId) {
            //if product detail id is not found donot proceed throw an error and return
            //throw "Assign Document was unsuccessful as Product Detail record was not found";
            //addPostExecutionScript(doc, 'alert("Assign Document was unsuccessful as Product Detail record was not found");');
            addPostExecutionScript(doc, 'alert("Please go back to the Triage Panel and verify the selected Product.");');
            isValid = false;
            return isValid;
        }
    }
    
    return isValid;
}
//AHS20220711 - added a new function , this will be called at the begining of the index rule - end
alert("end client library"); //ERS190615 #58921
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
//--- RULE VALIDATION CODE - END ---

</script>
