<!--
// Name: Client Library
// Committer: Prathyusha.vasireddy@zpaper.com
// Update: PV210831; PV210831
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2021-09-01 06:36:09","evalContinue":"true","active":true,"button":"","name":"Client Library","conditions":{"logic":"and","arguments":[{"name":"doc.status","value":"DoNotClient","operation":"not-contains"}]},"consequence":{"doit":"YWxlcnQoInN0YXJ0IGNsaWVudCBsaWJyYXJ5Iik7IC8vRVJTMTkwODAzICM1MjY2MSBmcm9tIE9jY0ZpdAovL0VSUzIwMTExNyBUT0RPIGdldCByaWQgb2ZmIHRoZXNlIGtleXdvcmRzIGFuZCB1c2UgYSBkb2N1bWVudCBqb3VybmV5IHdpemFyZCBmcm9tIEtQUyBhbmQgSmFrZQoKLy9DUk4yMDEwMjUgIzc2Nzg4IE1vdmVkIGZyb20gelN0YWNrIExpYnJhcnkgc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBpbiBtdWx0aXBsZSBydWxlcy4KdmFyIGtleXdvcmRNYXA9e307CnZhciBrZXl3b3Jkcz1bIk5FVzpEb2N1bWVudCBTdGFja34iLCJFTlJMOkVucm9sbG1jZW50fiIsIkVOUkw6RU5ST0xMTUVOVH4iLCJDT046Q29uc2VudH4iLCJDT046Y29uc2VudH4iLCJGQUM6U2V0dGluZ34iLCJGQUM6RGlzdHJpYnV0aW9ufiIsIlNUQVJUOlN0YXJ0IEZvcm1+IiwiQ0hLOkNoZWNrbGlzdH4iLCJISVBBQTpBVVRIT1JJWkFUSU9OfiIsIkhJUEFBOkhJUEFBfiIsIkhJUEFBOlBPUlRBQklMSVRZfiIsIlJFRjpSRUZFUlJBTCIsIlJFRjpSZWZlcnJhbCIsIkZJTjpXMn4iLCJJQzpNZW1iZXIgSUR+IiwiRkFYOiJdOwovL2tleXdvcmRNYXBbIlRFTlIiXSA9IlRFTlI6U3RhcnQgRm9ybSI7CmtleXdvcmRNYXBbIk5FVyJdID0iTkVXOkRvY3VtZW50IFN0YWNrIjsKa2V5d29yZE1hcFsiRU5STCJdID0iRU5STDpFbnJvbGxtZW50IEZvcm0iOwprZXl3b3JkTWFwWyJGQUMiXSA9IkZBQzpGYWNpbGl0eSBFbnJvbGxtZW50IEZvcm0iOwprZXl3b3JkTWFwWyJGQVgiXSA9Ik5FVzpEb2N1bWVudCBTdGFjayI7Ci8va2V5d29yZE1hcFsiU1RBUlQiXSA9Ik5FVzpEb2N1bWVudCBTdGFjayI7CmtleXdvcmRNYXBbIkNPTiJdID0iQ09OOkNvbnNlbnQgRm9ybSI7CmtleXdvcmRNYXBbIkhJUEFBIl0gPSJISVBBQTpISVBBQSBBdXRob3JpemF0aW9uIjsKa2V5d29yZE1hcFsiUkVGIl0gPSJSRUY6UmVmZXJyYWwiOwprZXl3b3JkTWFwWyJGVzIiXSA9IkZXMjpXLTIiOyAvL0pQQjIwMTAyMyBhZGRlZAprZXl3b3JkTWFwWyJJOSJdID0iSTk6SS05IjsgLy9KUEIyMDEwMjMgYWRkZWQKa2V5d29yZE1hcFsiVzQiXSA9Ilc0OlctNCI7IC8vSlBCMjAxMDIzIGFkZGVkCmtleXdvcmRNYXBbIkRFTSJdID0iREVNOkRlbW9ncmFwaGljcyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIkNMSU4iXSA9IkNMSU46Q2xpbmljYWwgTm90ZXMiOyAvL0NSTjIwMTAyNiBhZGRlZAprZXl3b3JkTWFwWyJGSU4iXSA9IkZJTjpGaW5hbmNpYWwgSW5mbyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIklDIl0gPSJJQzpJbnN1cmFuY2UgQ2FyZCI7IC8vQ1JOMjAxMDI2IGFkZGVkCgp6RGF0YS5tYXhDaGFubmVscz0zOyAvL0VSUzE5MDczMSAjNjEyNzIgemlwcGkgaXMgc3Ryb25nbHkgdHlwZWQKekRhdGEubWFrZVN0YWNrPXRydWU7IC8vRVJTMTkwODE0ICM2MTUxMQoKekRhdGEud2F0ZXJtYXJrPSIiK1hDdXN0b21TZXR0aW5nKGRvYywid2F0ZXJtYXJrX19jIik7IC8vRVJTMTkwNjE4IGJlc3QgcHJhY3RpY2UKLy9hbGVydCgiRVJTMTkwNDExIHdtPSIrekRhdGEud2F0ZXJtYXJrKyIgWlBBUEVSX19zZXJ2ZXJfX2M9IitYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fc2VydmVyX19jIikpOwp6RGF0YS51cGxvYWREaXIgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInVwbG9hZERpcl9fYyIpOyAvLyJhbGtlcm1lc1Jvb3QiOwp6RGF0YS5wYXRFbnJvbGxRdWV1ZUlkID0gIiIrWEN1c3RvbVNldHRpbmcoZG9jLCJwYXRpZW50UXVldWVJZF9fYyIpOyAvLycwMEc0QzAwMDAwMExrbVonOyAvL2luc2VydCB0aGUgUXVldWUgSUQgb2YgdGhlIGRlc2lyZWQgb3duZXJzaGlwIHF1ZXVlLiBVcGRhdGUgd2hlbiBtaWdyYXRpbmcgYmV0d2VlbiBlbnZpcm9ubWVudHMuIE5lZWQgdG8gYWRkIHRoaXMgcXVldWUgaW4gU2V0dXAKekRhdGEucmVjVHlwZVJlcXVlc3QgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInJlY1R5cGVSZXF1ZXN0X19jIik7IC8vJzAxMjRDMDAwMDAwQ2o1WSc7IC8vSUQgb2YgdGhlIENhc2UgUmVjb3JkIFR5cGUgUmVxdWVzdF9QU19NVk4KLy9UT0RPIHpEYXRhLmtleXdvcmRNYXBbIkVOUkwiXSA9IkVOUkw6RW5yb2xsbWVudCBGb3JtIjsgIC8vVE9ETyBnZXQgZnJvbSB6U3RhY2sgcGlja2xpc3RzCi8vVE9ETyB6RGF0YS5rZXl3b3JkTWFwWyJGQUMiXSA9IkZBQzpGYWNpbGl0eSBFbnJvbGxtZW50IEZvcm0iOwovL0VSUzIwMDIwNSBkZWxldGVkIGRlbW8gZGF0YSAtIGRvIHdpdGggY3VzdG9tIHNldHRpbmdzCgp2YXIgY3M9WERlcGxveW1lbnRJbmZvKGRvYywgIkJ1c2luZXNzX1Byb2Nlc3NfX2MiKTsgLy9FUlMyMDAyMjIgbmVlZCBib3RoIGRlcGxveW1lbnQgaW5mbyBhbmQgY3MKLy9hbGVydCgiY3M9Iitjcyk7CmlmIChjcykgewogICAgaWYgKGNzLmluZGV4T2YoInpDdXN0b21TZXR0aW5ncyIpPi0xKSBjcz1YKGRvYywiekN1c3RvbVNldHRpbmdzIixjcyk7CiAgICBhbGVydCgiRVJTMjAwMjI1IEVWQUwgb24gIitjcyk7CiAgICBpZiAoY3MgIT09ICIiKSBldmFsKCIiK2NzKTsgLy9FUlMyMDAyMjIgVE9ETyBKU09OLnBhcnNlKCkgLy9FUlMyMDAyMjUgYmVlZHMgdG8gYmUgZXZhbCBidXQgYWxzbyBuZWVkcyB0byB3b3JrISEhCiAgICBhbGVydCgiTm8gdHJ5IGp1c3QgZG8hIik7Cn0KCmlmICgxPT09MCAmJiAhekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGUpIHsgLy9UT0RPIGN1c3RvbSBzZXR0aW5nIG9yIGRlcGxveW1lbnQ/IC8vRVJTMjAxMTI5IERPTkUgaW4gekNoaWxkRmllbGRzCiAgICBhbGVydCgiRVJTMjAxMTI4IHNob3VsZCBiZSBpbiBjdXN0b20gc2V0dGluZ3MgekNoaWxkRmllbGRzIik7CiAgICB6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZT0iMDEyMTEwMDAwMDFnQnMzQUFFIjsgLy9FUlMyMDExMjggc2hvdWxkIGJlIGluIGN1c3RvbSBzZXR0aW5ncyB6Q2hpbGRGaWVsZHMgIjAxMjBSMDAwMDAxTjJvSSI7Cn0KCnpEYXRhLmNsaWVudEltcG9ydFNPUUw9ZnVuY3Rpb24oZG9jLGZyb21GaWxlKSB7IC8vRVJTMTkwNzA2IGN1c3RvbWl6ZSBpbXBvcnRzIHVzZWQgYnkgQ3JlYXRlIFN0YWNrCiAgICB6RGF0YS5pbXBvcnRlcj1YQ3VzdG9tU2V0dGluZyhkb2MsekRhdGEuenArIkltcG9ydGVyX19jIikudHJpbSgpOwogICAgdmFyIHNmSWQ9IiI7CiAgICB2YXIgcGFydHM9ZnJvbUZpbGUuc3BsaXQoIl8iKTsKICAgIC8vc2ZJZCA9IGdldFNGUmVjb3JkSUQoZG9jLCAiQWNjb3VudCIsIHsgIkZheCIgOiBwYXJ0c1szXSB9ICk7CiAgICB6RGF0YS5tYWtlU3RhY2s9dHJ1ZTsgLy9kbyBhbGwgdGhlIHdvcmsgdGhlcmUgYnkgZGVmYXVsdAogICAgcmV0dXJuIHNmSWQ7Cn07CgovL2FsZXJ0KCJ6RGF0YS5jbGllbnRTdGFjayIpOwp6RGF0YS5jbGllbnRTdGFjaz1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycykgeyAvL3pEYXRhIG9yIHRoaXM/CmFsZXJ0KCJAQEB6RGF0YS5jbGllbnRTdGFjayIpOwogICAgdmFyIHpwPXpEYXRhLnpwOyBpZiAoIXpwKSB6cD0iWlBBUEVSX18iOyAvL0VSUzE5MDgwNSAKCWlmICh6RGF0YS5yZWNlaXZlZCkgYXJyT2ZQYWlycy5wdXNoKCJ6U3RhY2tfUmVjZWl2ZWRfX2MiLCB6RGF0YS5mb3JtYXROb3cpOyAvL0VSUzE5MDYxNyBUT0RPIHNhdmUgd2F5IHRvIGRvIHRoaXMKCWlmICh6RGF0YS5vd25lcklkKSBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLHpEYXRhLm93bmVySWQpOyAgLy8gekNoYXJ0YSBRdWV1ZSAiMDBHMzYwMDAwMDJDeVRLIiAKCWlmICh6RGF0YS5jYWxsZXJJZCkgYXJyT2ZQYWlycy5wdXNoKCJ6Q2FsbGVyX0lEX19jIiwgZG9jLmRlbGl2ZXJlZEZyb20pOyAvL01TSDE3MDgxNyBhZGRlZAoJaWYgKHpEYXRhLnBhdEVucm9sbFF1ZXVlSWQpIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsekRhdGEucGF0RW5yb2xsUXVldWVJZCk7CglhbGVydCgiMTExMXpEYXRhLmNsaWVudFN0YWNrIik7CgkgdmFyIHFyQ29kZSA9IFgoZG9jLCJYX2JhckNvZGUwIik7CgkgYWxlcnQoIjEyM0BAcXJDb2RlIiArIHFyQ29kZSk7CiAgICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLCBxckNvZGUgfHwgekRhdGEuZG9jVHlwZSApOwogICAgIC8vaWYgKHpEYXRhLmRvY1R5cGUpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIiwgekRhdGEuZG9jVHlwZSk7Ly9QVjIxMDgxMQogICAgYWxlcnQoIkBAQDEyM1pQQVBFUl9fZmF4VHlwZV9fYyIgKyB6RGF0YS5kb2NUeXBlKTsvL1BWMjEwODI0CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiLCB6RGF0YS5jbGFzc2lmaWNhdGlvbik7CiAgICB2YXIgcGFnZVJhbmdlID0gWChkb2MsIlhfaWR4UGFnZXMiKTsKICAgIGlmICghcGFnZVJhbmdlKSBwYWdlUmFuZ2U9IjEtIitYKGRvYywiWF9wYWdlcyIpOyAKICAgIHZhciBwYWdlQ291bnQgPSB6RGF0YS5jb3VudFBhZ2VzKGRvYywgcGFnZVJhbmdlKTsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAKICAgIC8vRVJTMTkwODEwIFRPRE8/IGFyck9mUGFpcnMucHVzaCgiWlNUQUNLX19SZWNlaXZlZF9fYyIsIHpEYXRhLmZvcm1hdE5vdyk7CiAgICBhbGVydCgiRVJTMjAwMjEzLjUxIHBhZ2VSYWdlPSIrcGFnZVJhbmdlICsgIiBidXQgcGFnZUNvdW50PSIrcGFnZUNvdW50KTsgLy9FUlMyMDAyMTMgYWxzbyBjYWxsZWQgaW4gbmV3IGluY29taW5nIHN0YWNrCiAgICBpZiAoIVgoZG9jLCJYX2lkeFBhZ2VzIikpIHBhZ2VDb3VudD1YKGRvYywiWF9wYWdlcyIpOyAvL0VSUzIwMDIxMyBUT0RPIGZpeCB6RGF0YS5jb3VudFBhZ2VzKCkKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYWdlc19fYyIsIHBhZ2VDb3VudCk7CiAgICAKICAgIGFyck9mUGFpcnMucHVzaCh6cCsic2VudEZheFRvX19jIiwgKCJDb21tdW5pdHkiID09PSB6RGF0YS5jaGFubmVsID8gekRhdGEuY2hhbm5lbCA6IGRvYy5kZWxpdmVyZWRUbykpOyAvL0pQQjE5MDUyOSBhZGRlZCBzbyBDb21tdW5pdHkgc2hvd3MgdXAgaW4gTWFzdGVyIEludGFrZSBMaXN0CiAgICBhcnJPZlBhaXJzLnB1c2goenArIkZyb21fX2MiLGRvYy5kZWxpdmVyZWRGcm9tKTsKICAgIGlmICh6RGF0YS5yZXZpZXdlZFN0YXR1cykge2Fyck9mUGFpcnMucHVzaCh6cCsiU3RhZ2VfX2MiLCB6RGF0YS5yZXZpZXdlZFN0YXR1cyk7IH0gCiAgICBlbHNlIHsgYXJyT2ZQYWlycy5wdXNoKHpwKyJTdGFnZV9fYyIsICJSZWNlaXZlZCIpOyB9CiAgICB6RGF0YS5zdGFja1BhaXJzPWFyck9mUGFpcnM7IC8vRVJTMTkwODEwICM2MTU3MCBmb3IgY2hpbGQgc3RhY2sgbGF0ZXIKICAgIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX196U3RhY2tGaWVsZHNfX2MiKSk7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OCiAgICBpZiAoekRhdGEubmV3RG9jdW1lbnQgJiYgIShkb2MuZGVsaXZlcmVkRnJvbS5zdGFydHNXaXRoKCJhMSIpIHx8IGRvYy5kZWxpdmVyZWRGcm9tLnN0YXJ0c1dpdGgoImEwIikpKSB7CiAgICAgICAgdmFyIGFvcD1bXTsKICAgICAgICBhb3AucHVzaCh6RGF0YS5QQ3BhY2thZ2UgKyAiUENfRG9jdW1lbnRfQ2F0ZWdvcnlfX2MiLCB6RGF0YS5kb2NUeXBlKTsKICAgICAgICAvL2FvcC5wdXNoKCJ6U3RhY2tfX2MiLCBzdGFja0lkKTsKICAgICAgICB2YXIgZHRwY0lkPXpEYXRhLm5ld0RvY3VtZW50KGRvYywgYW9wLCB6RGF0YS5TRkRDdHlwZSwgekRhdGEucHJvZ3JhbU5hbWUpOwogICAgICAgIGFsZXJ0KCJFUlMyMTA1MjcgIzgzMDMyIGR0cGNJZCBuZXcgenN0YWNrIGRvY3VtZW50IGlkPSIrZHRwY0lkKTsKICAgIH0KICAgIGlmKGRvYy5kZWxpdmVyZWRGcm9tLnN0YXJ0c1dpdGgoImExIikgfHwgZG9jLmRlbGl2ZXJlZEZyb20uc3RhcnRzV2l0aCgiYTAiKSl7IC8vUFYyMTA4MzEKICAgICAgICB2YXIgYXR0YWNoUGF0aCA9IGRvYy5kZWxpdmVyZWRGcm9tOwogICAgICAgIGFsZXJ0KCJAMTIzNDU1NmRvYy5kZWxpdmVyZWRGcm9tIiArIGRvYy5kZWxpdmVyZWRGcm9tKTsKICAgICAgICAgdmFyIGFyck9mUGFpcnNBdHRhY2hUbyA9IFtdOwogICAgICAgIGFyck9mUGFpcnNBdHRhY2hUby5wdXNoKCJYX2F0dGFjaGVkVG8iLCBhdHRhY2hQYXRoKTsgCiAgICAgICAgdXBkYXRlREIoZG9jLGFyck9mUGFpcnNBdHRhY2hUbyk7CiAgICB9CglyZXR1cm4gYXJyT2ZQYWlyczsKfTsKCi8vYWxlcnQoInpEYXRhLmNsaWVudEZpbGUiKTsKekRhdGEuY2xpZW50RmlsZT1mdW5jdGlvbihkb2Msc3RhZ2UpIHsgLy9FUlMxNzA4MjkgIzQxMjk4IHJldHVybnMgYSBsYWJlbCB0byBiZSB1c2VkIGluIGFueSBhdHRhY2hlcyBhbmQgZml4ZXMgdGhlIGRvYwogICAgLy9Eb2N1bWVudCBhdHRhY2htZW50IGxhYmVsIHNob3VsZCBiZSAiUGF0aWVudCBOYW1lIC0gRG9jIFR5cGUgLSBEYXRlIi4gIENvbmZpcm1lZCBmb3IgelBhcGVyIEZpbGUgYW5kIFNGREMgQXR0YWNobWVudAogICAgdmFyIGxhYmVsMD1kb2MubGFiZWw7CiAgICB2YXIgTU1kZFlZWVkgPSB6RGF0YS5mb3JtYXRUb2RheU1NZGRZWVlZKCk7CiAgICBpZiAoIXN0YWdlKSB7IHN0YWdlPSJTcGxpdCI7IH0gLy9FUlMyMTA0MTAgIzc4NzU5IHJpYmJvbiBhY3Rpb25zCiAgICAKICAgIC8vQ1JOMjAxMDI1ICM3Njc4OCBGaXhlZCB0byBtYXRjaCB0aGUgY3VycmVudCBkZW1vLgogICAgdmFyIHBhdGllbnROYW1lID0gWChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIik7CiAgICBpZiAoIXBhdGllbnROYW1lICYmIFgoZG9jLCAiWF9aUEFQRVJfX0xhc3ROYW1lX19jIikgKSB7CiAgICAgICAgcGF0aWVudE5hbWUgPSBYKGRvYywiWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyIpICsgIiAiICsgWChkb2MsICJYX1pQQVBFUl9fTGFzdE5hbWVfX2MiKTsKICAgIH0KICAgIHZhciBmYXhUeXBlID0ga2V5d29yZE1hcFtYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKV07CiAgICBpZiAoIWZheFR5cGUpIHsgZmF4VHlwZSA9IFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOyB9CiAgICBpZiAoIWZheFR5cGUuaW5kZXhPZignOicpID49IDApIHsgZmF4VHlwZSA9IGZheFR5cGUuc3BsaXQoJzonKVsxXTsgfQogICAgLy8gZG9jLmxhYmVsID0gcGF0aWVudE5hbWUgKyAiIC0gIiArIGZheFR5cGUgKyAiIC0gIiArIE1NZGRZWVlZOwogICAgZG9jLmxhYmVsID0gcGF0aWVudE5hbWUgKyAiIC0gIiArIGZheFR5cGU7CiAgICBpZiAoIXBhdGllbnROYW1lIHx8IHBhdGllbnROYW1lLmxlbmd0aDw1IHx8ICghZmF4VHlwZSAmJiBzdGFnZSAhPT0gIlNwbGl0IikpIHsgLy9FUlMyMDExMjkgIzc4ODMwIC8vRVJTMjEwNDEwIGFkZGVkIGZheFR5cGUgdGVzdAogICAgICAgIGRvYy5sYWJlbD0iU3BsaXQgZnJvbSAiK1goZG9jLCJYX3NwbGl0UGFnZXMiKSsiIG9mICIrIFgoZG9jLCJYX2Zyb21QYWdlcyIpICsiIC0gIitNTWRkWVlZWTsKICAgICAgICBkb2MubGFiZWw9IlNwbGl0IGZyb20gIisgWChkb2MsIlhfZnJvbVBhZ2VzIikgKyIgLSAiK01NZGRZWVlZOwogICAgICAgIGRvYy5sYWJlbD1zdGFnZSsiIGZyb20gIitYKGRvYywiWF9mcm9tUGFnZXMiKSsiIC0gIitNTWRkWVlZWTsgLy9FUlMyMTA0MTAgcmliYm9uCiAgICB9IAogICAgYWxlcnQoIkVSUzE3MDgyOSBkYklEPSIrZG9jLmRiSUQrIiBsYWJlbD0iK2RvYy5sYWJlbCArIiBzZklEPSIrekRhdGEuc2ZJRCk7CiAgICBpZiAoIXpEYXRhLnNmSUQpIHsgekRhdGEuc2ZJRD1YKGRvYywic2ZJRCIpOyB9IC8vRVJTMjAxMjExICM3OTU5MQogICAgLy9UT0RPIGlmIEhDIGFuZCBvdXRib3VuZCB0aGVuIFNlbmQgdG8geyFDb250YWN0Lk5hbWV9IGF0IHshQ29udGFjdC5BY2NvdW50Lk5hbWV9CiAgICAvL1RPRE8gaWYgSEMgYW5kIHJlY2lldmVkIHRoZW4gUmVjaWV2ZWQgZnJvbSB7IUNvbnRhY3QuTmFtZX0gYXQgeyFDb250YWN0LkFjY291bnQuTmFtZX0KICAgIGlmICh6RGF0YS5zZklEICAmJiB6RGF0YS5zZklELmluZGV4T2YoIjUwMCIpPT09MCkgewoJICAgIHpEYXRhLnByb3ZpZGVyID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkFjY291bnQuTmFtZSIsIG51bGwsIHpEYXRhLnNmSUQpOyAKCSAgICBkb2MubGFiZWwgPSAiUmVjZWl2ZWQgZnJvbSAiICsgekRhdGEucHJvdmlkZXI7IC8vRVJTMjAxMjExICM3OTU5MSAgbWlzc2luZyBkb2MuCiAgICAgICAgaWYgKHpEYXRhLmZhY2lsaXR5KSB7CiAgICAgICAgICAgIHpEYXRhLmZhY2lsaXR5ID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkFjY291bnQuRmFjaWxpdHlfX3IuTmFtZSIsIG51bGwsIHpEYXRhLnNmSUQpOwogICAgICAgICAgICBkb2MubGFiZWwrPSIgYXQgIit6RGF0YS5mYWNpbGl0eTsKICAgICAgICB9Cgl9CglpZiAoZG9jLmxhYmVsLmxlbmd0aCA+IDYpIHsgLy9FUlMyMTA1Mjkgb25seSBkbyBpdCBpZiB0aGVyZSBpcyBhIGNoYW5nZSB3b3J0aCBzYXZpbmcKICAgIAl2YXIgYXJyT2ZQYWlycyA9IFtdOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiZGItbGFiZWwiLCBkb2MubGFiZWwpOwogICAgCXVwZGF0ZURCKGRvYyxhcnJPZlBhaXJzKTsKCX0gZWxzZSByZXR1cm4gbGFiZWwwOwogICAgcmV0dXJuIGRvYy5sYWJlbDsKfTsKCnpEYXRhLmNsaWVudFZhbHVlPWZ1bmN0aW9uKGRvYyx2YWwpIHsvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiAKICAgIHZhbD12YWwucmVwbGFjZSgieyFmb3JtYXROb3d9Iix6RGF0YS5mb3JtYXROb3cpOwogICAgcmV0dXJuIHZhbDsKfQoKekRhdGEuY2xpZW50RmllbGRzPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLGpkLHpkKSB7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OIGluIHNldHRpbmcgdG8gY29uZmlndXJlIG5ldyByZWNvcmQKICAgIGlmICghemQpIHpkPXpEYXRhOwoJaWYgKGpkICYmIGpkLmluZGV4T2YoInsiKT09PTApIHsgCgkgICAgLy97IlR5cGUiOiJFbGlnaWJpbGl0eSIsIk93bmVySWQiOiIwMEdjMDAwMDAwM3ZncXciLCJSZWNvcmRUeXBlSWQiOiIwMTI2QTAwMDAwMEpFS2VRQU8ifTsKCSAgICAvL05PVCBBIEdPT0QgSURFQSBqZD1qZC5yZXBsYWNlQWxsKCJcIiIsIiciKTsgLy9FUlMxOTA4MTEgIzYxNTcwIEhBQ0s/CgkgICAgamQ9amQucmVwbGFjZSgifTsiLCJ9Iik7IC8vRVJTMjAxMTI5IFNIUiB0byB3b3JrIG91dCBkZXNpZ24gb24gY2hhbm5lbCB3aXphcmQgZm9yIHpTdGFjayBjaGlsZCBzZXQgQVNBUAoJICAgIHRyeSB7CiAgICAJICAgIHZhciBqZGF0YT1KU09OLnBhcnNlKGpkKTsgLy9FUlMxOTA4MDUgYmV0dGVyIHRoYW4gZXZhbAogICAgCSAgICBmb3IgKHZhciBuIGluIGpkYXRhKSB7CiAgICAJICAgICAgICB2YXIgdjA9amRhdGFbbl07IAogICAgCSAgICAgICAgdmFyIHY9ekRhdGEuY2xpZW50VmFsdWUoZG9jLHYwKTsgLy9FUlMxOTA4MTEgLHYgbm93ICx2MAogICAgCSAgICAgICAgYWxlcnQoIkVSUzE5MDgwMy45NyAiK24rIj0iK3YwKyI9Iit2KTsgCiAgICAJICAgICAgICBhcnJPZlBhaXJzLnB1c2gobix2KTsgLy9FUlMxOTA4MTEgYWRkZWQgLnB1c2gKICAgIAkgICAgICAgIHpkW25dPXY7IC8vRVJTMjAxMTI5ICM3ODgzMCBUT0RPIHJldmlldyBhcnJPZlBhaXJzIGFjY2VzcyB1c2luZyBmb3IgUmVjb3JkVHlwZUlkCiAgICAJICAgIH0KCSAgICB9IGNhdGNoIChlKSB7CgkgICAgICAgIGFsZXJ0KCJKU09OIG5vdCBpbiAiK2pkKyIgRXhjZXB0aW9uOiAiK2UpOyAvL0VSUzE5MDgxMSBhZGRlZCBlCgkgICAgfQoJfQoJcmV0dXJuIGFyck9mUGFpcnM7Cn0KCgp6RGF0YS5jbGllbnRDYXNlPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7CglpZiAoIXpkKSB6ZD16RGF0YTsKCWlmICghemQudHJpYWdlVHlwZSAmJiBYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKSkgemQudHJpYWdlVHlwZT1YKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKTsgLy9FUlMyMDAzMDgKCWlmICghbGFiZWwpIHsgbGFiZWw9IkluZGV4ZWQtIiArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KCQoJYWxlcnQoIkVSUzIwMDMwOC4xMjggbmV3IENhc2UgcHJvdmlkZXJJZD0iK3pkLnByb3ZpZGVySWQrIiBwYXRpZW50SWQ9Iit6ZC5wYXRpZW50SWQpOwoJCgkvL0VSUzE3MDUyMCBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCBxdWV1ZXNNYXBLbHVkZ2VbWChkb2MsIlhfQXNzaWduX3RvX1F1ZXVlX19jIildKTsKCWlmICh6ZC5jb250YWN0SWQpIGFyck9mUGFpcnMucHVzaCgiQ29udGFjdElkIiwgemQuY29udGFjdElkKTsKCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19uZXdGYXhfX2MiLCAidHJ1ZSIpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCglhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX3JlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7IC8vRVJTMTkwODE0IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCWFyck9mUGFpcnMucHVzaCgiU3RhdHVzIiwgWChkb2MsIlhfU3RhdHVzIikpOwoJYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLHpkLnRyaWFnZVR5cGUpOyAvL0VSUzIwMDMwOAoJLy9FUlMyMDAyMDUgYXJyT2ZQYWlycy5wdXNoKCJUeXBlIiwgIk5ldyAiK3pkLmNsYXNzaWZpY2F0aW9uKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJLy9FUlMyMDAzMDggYXJyT2ZQYWlycy5wdXNoKCJUeXBlIiwgIk5ldyAiK3pkLmRvY1R5cGUpOwoJaWYgKDE9PTEpIHsgLy9FUlMxNzA1MjMgIzM3MTYyIGFmdGVyIGRyeXJ1bgoJICAgIGFsZXJ0KCJAQEAgemQucHJpb3JpdHkgPT4gKiIgKyB6ZC5wcmlvcml0eSArICIqIik7CgkJLy9hcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIjAxMlEwMDAwMDAwNUFoaiIpOyAvL0VSUzE3MDUyMyBQcmlvciBBdXRoCgkJaWYgKHpkLnByaW9yaXR5ICE9ICJOb3JtYWwiKSB7IGFyck9mUGFpcnMucHVzaCgiUHJpb3JpdHkiLHpkLnByaW9yaXR5KTsgfSAgLy9FUlMxNzA1MjQgIzM3MTYyIHByaW9yaXR5IG9uIENhc2UKCQllbHNlIHsgYXJyT2ZQYWlycy5wdXNoKCJQcmlvcml0eSIsIk1lZGl1bSIpOyB9CgkJYXJyT2ZQYWlycy5wdXNoKCJPcmlnaW4iLCJGYXgiKTsgLy9FUlNhMjAwMjA1IHJyT2ZQYWlycy5wdXNoKCJPcmlnaW4iLHpkLmNoYW5uZWwpOwoJfQogICAgYXJyT2ZQYWlycz16RGF0YS5jbGllbnRGaWVsZHMoZG9jLGFyck9mUGFpcnMsWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX0Nhc2VGaWVsZHNfX2MiKSk7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OCiAgICAKICAgIGFsZXJ0KCJFUlMyMDAzMDguMTQzIG5ldyBDYXNlIHByb3ZpZGVySWQ9Iit6ZC5wcm92aWRlcklkKyIgcGF0aWVudElkPSIremQucGF0aWVudElkKTsKICAgIGlmICh6ZC5wcm92aWRlcklkICYmIHpkLnByb3ZpZGVySWQuaW5kZXhPZigiMDAxIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJBY2NvdW50SWQiLCB6ZC5wcm92aWRlcklkKTsgfSAvL0VSUzIwMDMwOAogICAgaWYgKHpkLnByb3ZpZGVySWQgJiYgemQucHJvdmlkZXJJZC5pbmRleE9mKCIwMDMiKT09MCkgeyBhcnJPZlBhaXJzLnB1c2goIkNvbnRhY3RJZCIsIHpkLnByb3ZpZGVySWQpOyB9IC8vRVJTMjAwMzA4CiAgICBpZiAoemQucGF0aWVudElkICYmIHpkLnBhdGllbnRJZC5pbmRleE9mKCIwMDEiKT09MCkgeyBhcnJPZlBhaXJzLnB1c2goIkFjY291bnRJZCIsIHpkLnBhdGllbnRJZCk7IH0gLy9FUlMyMDAzMDgKICAgIGlmICh6ZC5wYXRpZW50SWQgJiYgemQucGF0aWVudElkLmluZGV4T2YoIjAwMyIpPT0wKSB7IGFyck9mUGFpcnMucHVzaCgiQ29udGFjdElkIiwgemQucGF0aWVudElkKTsgfSAvL0VSUzIwMDMwOAogICAgaWYgKHpkLnpjaGFubmVsLm93bmVyKSB7IGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHpEYXRhLnpjaGFubmVsLm93bmVyKTsgfSAvL0VSUzIwMDMwOAogICAgCgl2YXIgY2FzZUlkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNhc2UiLCBsYWJlbCwgYXJyT2ZQYWlycyk7CglyZXR1cm4gY2FzZUlkOwp9OwoKekRhdGEuY2xpZW50UGF0aWVudD1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxsYWJlbCx6ZCkgewoJaWYgKCF6ZCkgemQ9ekRhdGE7CglpZiAoIWxhYmVsKSB7IGxhYmVsPXpkLnN0YWdlICsgIi0iICsgemQudHJpYWdlVHlwZSArICItIiArIHpkLnN0YWNrSWQ7fQoJaWYgKHpkLnBhdGllbnRJZCkgeyAvL0VSUzIwMDIwNSAjNjg4MjUgUHJvZ3JhbSBNZW1iZXJzCgkgICAgYWxlcnQoIlBhdGllbnQgYWxyZWFkeSBleGlzdHMgaW4gIit6ZC5wYXRpZW50SWQpOwoJICAgIHJldHVybiB6ZC5wYXRpZW50SWQ7IC8vVE9PRCBnZXQgZnJvbSBYX3BhdGllbnRJZCAgPz8/PwoJfQoJLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7Cgl2YXIgcD0iWlBBUEVSX18iOyAvL0VSUzIwMDIwMiBhc3N1bWUgd29ya2Zsb3cgb24gcmVsYXRlZCByZWNvcmQgdHlwZXMKCWlmICh6RGF0YS5wYXRpZW50VHlwZS5pbmRleE9mKCJfX2MiKSA+IC0xKSB7IHA9IiI7IH0gLy9FUlMyMDAyMDMgdHlwbwoJaWYgKDE9PTApIHsgLy9FUlMyMDAyMDIgc2VlIGlmIHdvcmtmbG93IGVuYWJsZWQKCSAgICBhcnJPZlBhaXJzLnB1c2gocCsibmV3RmF4X19jIiwgInRydWUiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJICAgIGFyck9mUGFpcnMucHVzaChwKyJsYXRlc3RGYXhfX2MiLCB6ZC5mb3JtYXROb3cpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCgkgICAgYXJyT2ZQYWlycy5wdXNoKHArInJlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7IC8vRVJTMTkwODE0IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCX0KCiAgICB2YXIgcnQ9WEN1c3RvbVNldHRpbmcoZG9jLCJQYXRpZW50UmVjb3JkVHlwZV9fYyIpOyAvL1RPRE8gaW50byBNUCBFUlMxOTA4MDIgbGlrZSAwMTI2QTAwMDAwMEpFOHlRQUcgb3IgZW1wdHkgdG8gdXNlIGRlZmF1bHQKICAgIC8vaWYgKHJ0KSB7IGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgcnQpOyB9IC8vRVJTMTkwODAzCiAgICAvL1RPRE8gQ29udGFjdCBvciBBY2NvdW50IEVSUzE5MDYyNCBET05FISEgRVJTMTkwODAyCiAgICBhcnJPZlBhaXJzPVtdOyAvL0VSUzIwMTIxMiBIQUNLIHNpbmNlIHRoZSBJbmRleCBhY3Rpb24gbmVlZHMgdG8gYmUgcmVmYWN0b3JlZAogICAgYXJyT2ZQYWlycz16RGF0YS5jbGllbnRGaWVsZHMoZG9jLGFyck9mUGFpcnMsWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX1BhdGllbnRGaWVsZHNfX2MiKSk7IC8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OIAogICAgLy9FUlMyMDEyMTIgYmFjayBpbiBub3chICAjNzk1ODggYXJyT2ZQYWlycz1bXTsgLy9FUlMyMDAyMDQgdGVzdGluZyB0byBnZXQgaXQgZ29pbmcKICAgIAogICAgLy9FUlMyMDAyMDIgbmVlZCB0byBtYWtlIHRoZSBBY2NvdW50IHdpdGggUGF0aWVudCByZWNvcmRUeXBlIGZpcnN0CiAgICAvLzAxMjQ2MDAwMDAwTkdGWUFBNCBpcyAuenBhcGVyIGZvciBQYXRpZW50CiAgICB2YXIgYXIgPSBbXTsKICAgIGFyPWFyck9mUGFpcnM7IC8vRVJTMjAxMjEyICM3OTU4OAogICAgaWYgKHJ0KSB7IGFyLnB1c2goIlJlY29yZFR5cGVJZCIsIHJ0KTsgfSAvL0VSUzE5MDgwMyAvL0VSUzIwMDIyMiAjNjkxNDkgbW92ZWQgZG93biBhbmQgYWRkZWQgZWxzZSAKICAgIC8vRVJTMjAxMjEyIGdldCBmcm9tIFBhdGllbnRGaWVsZHMgbm93ISAjNzk1ODggZWxzZSBhci5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTI0NjAwMDAwME5HRllBQTQiKTsKICAgIGFyLnB1c2goIkZpcnN0TmFtZSIsekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7CiAgICBhci5wdXNoKCJMYXN0TmFtZSIsekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsKICAgIHZhciBwYXRpZW50TmFtZT16RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MrIiwgIit6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jOwogICAgCiAgICAvL2lmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSBhci5wdXNoKCJQZXJzb25CaXJ0aERhdGUiLHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgLy92YXIgYUlkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiQWNjb3VudCIsIG51bGwsIGFyKTsgLy9FUlMyMDAyMDQgcGVyc29uIGFjY291bnQgc28gZG8gbm90IHNldCBwYXRpZW50TmFtZQogICAgCiAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyAmJiB6RGF0YS5wYXRpZW50VHlwZS5pbmRleE9mKCJBY2NvdW50Iik+LTEpIGFyLnB1c2goIlBlcnNvbkJpcnRoRGF0ZSIsekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyk7CiAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyAmJiB6RGF0YS5wYXRpZW50VHlwZS5pbmRleE9mKCJDb250YWN0Iik+LTEpIGFyLnB1c2goIkJpcnRoRGF0ZSIsekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyk7CiAgICB2YXIgcGF0aWVudFR5cGU9ekRhdGEucGF0aWVudFR5cGUucmVwbGFjZSgiUGVyc29uIiwiIik7IC8vRVJTMjAxMjEyIG1ha2UgU09RTCBoYXBweSBIQUNLPwogICAgdmFyIGFJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYyxwYXRpZW50VHlwZSwgbnVsbCwgYXIpOyAvL0VSUzIwMDIwNCBwZXJzb24gYWNjb3VudCBzbyBkbyBub3Qgc2V0IHBhdGllbnROYW1lCiAgICAKICAgIAogICAgaWYgKGFJZCAmJiBhSWQgIT0gIk5FVyIgJiYgYUlkLmluZGV4T2YoIkVSUk9SIik9PS0xKSB7CiAgICAgICAgdmFyIHNmSWQgPSBhSWQ7IC8vRVJTMjAxMjEyIHdhcyAiIgogICAgCQogICAgCS8vRVJTMTkwODAzIHNwZWNpZmljIHRvIGNsaWVudCBkYXRhIGVudHJ5CiAgICAJdmFyIGRxID0gekRhdGEuZHE7CiAgICAJYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1BlcnNvbl9BY2NvdW50X19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHNmSWQgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUGVyc29uX0FjY291bnRfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsgIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgZHEgKyAiKTsgIik7CiAgICAgICAgcmV0dXJuIGFJZDsgLy9FUlMyMDEyMTIgIzc5NTg4IHJldHVybiB0aGUgSWQgd2FzIG1pc3NpbmcKICAgIH0KICAgIHJldHVybiB7J0VSUk9SJzogJ3BhdGllbnQgbm90IGNyZWF0ZWQnfQp9OwoKekRhdGEuY2xpZW50QWNjb3VudD1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxsYWJlbCx6ZCkgewoJaWYgKCF6ZCkgemQ9ekRhdGE7CglpZiAoIWxhYmVsKSB7IGxhYmVsPXpkLnN0YWdlICsgIi0iICsgemQudHJpYWdlVHlwZSArICItIiArIHpkLnN0YWNrSWQ7fQoJLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCJYX0Fzc2lnbl90b19RdWV1ZV9fYyIpXSk7CglhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbmV3RmF4X19jIiwgInRydWUiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2xhdGVzdEZheF9fYyIsIHpkLmZvcm1hdE5vdyk7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCgoJdmFyIGFjY291bnRJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJBY2NvdW50IiwgbGFiZWwsIGFyck9mUGFpcnMpOwoJcmV0dXJuIGFjY291bnRJZDsKfTsKCnpEYXRhLmNsaWVudFJlY29yZD1mdW5jdGlvbihkb2Msc2ZUeXBlLGFyck9mUGFpcnMsbGFiZWwsemQpIHsgLy9FUlMxOTA2MjAgY2xpZW50UmVjb3JkIGdlbmVyaWMKCWlmICghemQpIHpkPXpEYXRhOwoJaWYgKCFsYWJlbCkgeyBsYWJlbD16ZC5zdGFnZSArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KCS8vRVJTMTcwNTIwIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHF1ZXVlc01hcEtsdWRnZVtYKGRvYywiWF9Bc3NpZ25fdG9fUXVldWVfX2MiKV0pOwoJdmFyIHpwPSIiOwoJaWYgKCIsQ2FzZSxDb250YWN0LEFjY291bnQsTGVhZCxPcHBvcnR1bml0eSxaUEFQRVJfX3pTdGFja19fYywiLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiLCIrc2ZUeXBlLnRvTG93ZXJDYXNlKCkrIiwiKT4tMSkgenA9ekRhdGEuenA7CgkvL29ubHkgZG8gdGhpcyBpZiB0aGUgZmllbGRzIGV4aXN0CglhcnJPZlBhaXJzLnB1c2goenArIm5ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCWFyck9mUGFpcnMucHVzaCh6cCsibGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwoJYXJyT2ZQYWlycy5wdXNoKHpwKyJyZWNlaXZlZElkX19jIiwgImRvYy5kYklELlJlYyIpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCgkKCS8vVE9ETyBwdXQgY2xpZW50IHNwZWNpZmljIGRhdGEgdXBkYXRlcyBoZXJlCgoJdmFyIG5ld0lkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgc2ZUeXBlLCBsYWJlbCwgYXJyT2ZQYWlycyk7CglyZXR1cm4gbmV3SWQ7Cn07Cgp6RGF0YS5jbGllbnRDb21wbGV0ZT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyx6ZCkge3JldHVybiBhcnJPZlBhaXJzO307IC8vRVJTMTkwNjI1CmFsZXJ0KCJjbGllbnREZWxpdmVyeVN0YXJ0IiApOwp6RGF0YS5jbGllbnREZWxpdmVyeT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycykgeyAvL0VSUzIwMDIwMiBUT0RPIGNvbnNpZGVyIG5ldyBEb2N1bWVudF9NVk4KICAgIGlmICh6RGF0YS5uZXdEb2N1bWVudCkgewogICAgICAgIC8vVE9ETyBuZXcgYXJyYXk/CiAgICAgICAgdmFyIGJhPWRvYy5YKCJYX2ZheFN0YXR1cyIpKyIiOyAvL1BWMjEwNjIyIHRvIGNoZWNrIHRoZSBmYXggc3RhdHVzCiAgICAgICAgaWYgKCJEZWxpdmVyZWQiICE9PSBiYSkgeyBiYT0iRmFpbGVkIjsgfSAKICAgICAgICBhbGVydCgiQ2xpZW50RGVsaXZlcnlJZjEiKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goInpQYXBlcl9GYXhfVW5pcXVlX0lkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzIxMDUyOSBEVFBDCiAgICAgICAgZGVzdEZpZWxkTmFtZSA9IHpEYXRhLlBDcGFja2FnZSArICJQQ19Ub19GYXhfTnVtYmVyX19jIjsKICAgICAgICBhbGVydCgib3V0Ym91bmRGYXhSZWNvcmRUeXBlIiArIHpEYXRhLm91dGJvdW5kRmF4UmVjb3JkVHlwZSk7CiAgICAgICAgYWxlcnQoImRvYy5kZWxpdmVyZWRUbyIgKyBkb2MuZGVsaXZlcmVkVG8pOwogICAgICAgIGlmIChkb2MuZGVsaXZlcmVkVG8uaW5kZXhPZigiQCIpID4gLTEpIHsgLy9FUlMxODA4MjEgaWYgKGlzTmFOKGRvYy5kZWxpdmVyZWRGcm9tKSkKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCB6RGF0YS5vdXRib3VuZEVtYWlsUmVjb3JkVHlwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCB6RGF0YS5vdXRib3VuZEZheFJlY29yZFR5cGUpOyAvL01TSDE4MDgxNyAjNTE2NDEKICAgICAgICB9CiAgICAgICAgLy9FUlMyMTA1MjkgTkVXIEZJRUxEPyBhcnJPZlBhaXJzLnB1c2goInNwY19TY291cmNlX09iamVjdF9JRF9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKGRlc3RGaWVsZE5hbWUsIGRvYy5kZWxpdmVyZWRUbyk7CiAgICAgICAgLy9QVjIxMDcwOCBjb21tZW50ZWQgY296IGNsaWV0IHJlcXVlc3RlZCB0byBub3QgY3JlYXRlIGRvY3VtZW50IGFuZCBkb2N1bWVudCBsb2cgcmVjb3JkCiAgICAgICAgLy92YXIgZHRwY0lkPXpEYXRhLm5ld0RvY3VtZW50KGRvYywgYXJyT2ZQYWlycywgekRhdGEuU0ZEQ3R5cGUsIHpEYXRhLnByb2dyYW1OYW1lLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgYmEpOyAvL1BWMjEwNzA5IGFkZGVkIGZvciBzdGFnZQogICAgICAgIC8vYWxlcnQoIkVSUzIxMDUyNyAjODMwMzIgZHRwY0lkIG5ldyBhY3Rpdml0eSBkb2N1bWVudCBpZD0iK2R0cGNJZCk7CiAgICB9CiAgICByZXR1cm4gYXJyT2ZQYWlyczsKfTsgLy9FUlMxOTA3MTEgIzYwOTAwIFBBT1MKCnpEYXRhLmNsaWVudENoaWxkU3RhY2s9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMscGFyZW50SWQpIHsgLy9FUlMxOTA4MTAgIzYxNTcwIGJlIHN1cmUgdG8gY2FsbCBvbiBuZXcgY2hpbGQgZG9jCiAgICB2YXIgcGFpcnM9YXJyT2ZQYWlyczsKICAgIC8vbm8gbWVtb3J5IG9mIHN0YWNrIGNyZWF0aW9uIHZhciBwYWlycz16RGF0YS5zdGFja1BhaXJzOwogICAgLy9DUk4yMDEwMjYgIzc2Nzg4IFdlIG5lZWQgcmV2aWV3ZWRTdGF0dXMgdG8gYmUgIkluZGV4ZWQiIGZvciB0aGUgaW5kZXggcnVsZSwgc28gb25seSBzZXQgdGhlIGZpZWxkIGlmIGl0IGlzbid0IGFscmVhZHkgc2V0LgogICAgaWYgKCF6RGF0YS5yZXZpZXdlZFN0YXR1cykgeyB6RGF0YS5yZXZpZXdlZFN0YXR1cz0iU3BsaXQiOyB9CiAgICAvL0VSUzE5MDgxMCBUT0RPPyBwYWlycy5wdXNoKCJaUEFQRVJfX1N0YXR1c19fYyIsICJDaGlsZCBTdGFjayIpOwoKICAgIHBhaXJzPXpEYXRhLmNsaWVudFN0YWNrKGRvYyxwYWlycyk7CiAgICBpZiAoWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX3pDaGlsZEZpZWxkc19fYyIpKSB7IC8vRVJTMTkwODExIG5vdCBpbiBhbGwgTVBzCiAgICAgICAgcGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxwYWlycyxYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fekNoaWxkRmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiBjaGlsZCByZWNvcmQgdHlwZSBpZAogICAgfQogICAgcGFpcnMucHVzaCgiWlBBUEVSX19QYXJlbnRfX2MiLCBwYXJlbnRJZCk7CiAgICAvL0VSUzIwMTEyOCBzaG91bGQgYmUgaW4gekNoaWxkRmllbGRzIGlmICh6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSkgcGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIix6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSk7CiAgICAKICAgIC8vcGFpcnMucHVzaCgiIisiUHJvZ3JhbV9fYyIsekRhdGEucHJvZ3JhbU5hbWUpOyAvL0VSUzIwMDIwNSBUT0RPIGluIHBhY2thZ2UgYW5kIGludG8gYmFzZSBjYWxsIC8vU0hSMjAxMjAyICM3OTI1NwogICAgcGFpcnMucHVzaCgiIisiWlBBUEVSX19Qcm9ncmFtX05hbWVfX2MiLHpEYXRhLnByb2dyYW1OYW1lKTsgLy9TSFIyMDEyMDIgIzc5MjU3IHVzZSB0aGUgUHJvZ3JhbV9OYW1lIGZpZWxkIGluc3RlYWQgb2YgUHJvZ3JhbV9fYwogICAgLy9FUlMyMDAyMjkgaWYgKHpEYXRhLnBhdGllbnRJZCkgcGFpcnMucHVzaCgiUHJvZ3JhbV9NZW1iZXJfTVZOX19jIix6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzIwMDIwNSBQcm9ncmFtX01lbWJlcl9NVk5fX2Mgd2FzIHRoZSBUSUNLRVQhISEKICAgIGFsZXJ0KCJFUlMxOTA4MTEuMTkxIFpQQVBFUl9fUGFyZW50X19jIisgcGFyZW50SWQrIiBjaGlsZCB6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZT0iK3pEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlKTsKICAgIGlmICh6RGF0YVsnUmVjb3JkVHlwZUlkJ10pIHsgIHpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlPXpEYXRhWydSZWNvcmRUeXBlSWQnXTsgfSAvL0VSUzIwMTEyOSAjNzg4MzAgVE9ETyBub3Qgc3VyZSB3aGVyZSB0aGlzIGlzIHVzZWQgZWxzZXdoZXJlCiAgICBhbGVydCgiRVJTMjAxMTI5LjI5MiBaUEFQRVJfX1BhcmVudF9fYyIrIHBhcmVudElkKyIgY2hpbGQgUmVjb3JkVHlwZUlkPSIrekRhdGFbJ1JlY29yZFR5cGVJZCddKTsKICAgIHZhciBjaGlsZFN0YWNrU0ZJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJaUEFQRVJfX3pTdGFja19fYyIsICJ6U3RhY2sgc3BsaXQgb24gIiArIHpEYXRhLmZvcm1hdE5vdywgcGFpcnMpICsgIiI7CiAgICAKCWFsZXJ0KCJ6RGF0YS5uZXdEb2N1bWVudCA9ICIgKyB0eXBlb2YgekRhdGEubmV3RG9jdW1lbnQpOwoJaWYgKHpEYXRhLm5ld0RvY3VtZW50KSB7CiAgICAgICAgdmFyIGFvcD1bXTsKICAgICAgICBhb3AucHVzaCh6RGF0YS5QQ3BhY2thZ2UgKyAiUENfRG9jdW1lbnRfQ2F0ZWdvcnlfX2MiLCB6RGF0YS5kb2NUeXBlKTsKICAgICAgICAvL2FvcC5wdXNoKCJ6U3RhY2tfX2MiLCBzdGFja0lkKTsKICAgICAgICB2YXIgZHRwY0lkPXpEYXRhLm5ld0RvY3VtZW50KGRvYywgYW9wLCB6RGF0YS5TRkRDdHlwZSwgekRhdGEucHJvZ3JhbU5hbWUpOwogICAgICAgIGFsZXJ0KCJkb2N1bWVudCBjcmVhdGVkIGFmdGVyIHNwbGl0PSIrZHRwY0lkKTsKICAgIH0KCQogICAgaWYgKCF6RGF0YS5wYXRpZW50SWQgJiYgWChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIpICl7IC8vRVJTMjAwMzA4IEhBQ0sKICAgICAgICB6RGF0YS5wYXRpZW50SWQ9WChkb2MsIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIpOwogICAgICAgIGFsZXJ0KCJFUlMyMDAzMDggV0hZIE5PVCBpbiB6RGF0YT8iKTsKICAgIH0KICAgIAogICAgaWYgKHpEYXRhLnBhdGllbnRJZCAmJiB6RGF0YS5DYXJlUGxhblRhc2tSVCkgeyAvL0VSUzIxMDIyMSAjNzY5NzUgZGVwbG95bWVudCBzZXR0aW5nIC8vRVJTMjAwMzA4IGNyZWF0ZSBhbiBBY3Rpdml0eSBFdmVudCByZWxhdGVkIHRvIHRoZSBQYXRpZW50IChBY2NvdW50KSBmb3IgdGhlIFRpbWVsaW5lCiAgICAgICAgaWYgKCF6RGF0YS5kb2NUeXBlICYmIFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpKSB6RGF0YS5kb2NUeXBlPVgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwogICAgICAgIHZhciBhcnI9W107CiAgICAgICAgLy9OT1QgU0VMRUNUIEFjY291bnRJZCxBY3Rpdml0eURhdGUsQ3JlYXRlZERhdGUsU3RhdHVzLFN1YmplY3QsVGFza1N1YnR5cGUsV2hhdElkLFdob0lkIEZST00gVGFzayB3aGVyZSBBY3Rpdml0eURhdGUgPiAyMDIwLTAyLTAxCiAgICAgICAgLy9TRUxFQ1QgSWQsQWNjb3VudElkLEFjdGl2aXR5RGF0ZSxDcmVhdGVkRGF0ZSxTdWJqZWN0LFdoYXRJZCxXaG9JZCBGUk9NIEV2ZW50IHdoZXJlIElkID0gJzAwVTRUMDAwMDAydkNoclVBRScKICAgICAgICAvL2Fyci5wdXNoKCJXaG9JZCIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAzMTAgdGltZWxpbmUgdHJpY2sKICAgICAgICBpZiAoekRhdGEucGF0aWVudElkLmluZGV4T2YoIjAwMSIpPT0wKSB7CiAgICAgICAgICAgIGFyci5wdXNoKCJXaGF0SWQiLHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMjAwMzEwIHRpbWVsaW5lIHRyaWNrCiAgICAgICAgICAgIC8vYXJyLnB1c2goIkFjY291bnRJZCIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAzMTAgdGltZWxpbmUgdHJpY2sKICAgICAgICB9IGVsc2UgaWYgKHpEYXRhLmNhc2VJZCkgYXJyLnB1c2goIldoYXRJZCIsekRhdGEuY2FzZUlkKTsKICAgICAgICBlbHNlIGlmICh6RGF0YS5wcm92aWRlcklkKSBhcnIucHVzaCgiV2hhdElkIix6RGF0YS5wcm92aWRlcklkKTsKICAgICAgICBlbHNlIGFyci5wdXNoKCJXaGF0SWQiLGNoaWxkU3RhY2tTRklkKTsKICAgICAgICAvL2Fyci5wdXNoKCJUYXNrU3VidHlwZSIsIlRhc2siKTsKICAgICAgICBhcnIucHVzaCgiU3ViamVjdCIsekRhdGEuc3RhZ2UgKyAiICIrekRhdGEuZG9jVHlwZSk7CiAgICAgICAgYXJyLnB1c2goIkRlc2NyaXB0aW9uIiwiQ2hlY2sgb3V0ICIrZG9jLmRiSUQpOwogICAgICAgIC8vYXJyLnB1c2goIkFjdGl2aXR5RGF0ZVRpbWUiLHpEYXRhLmZvcm1hdE5vdyk7IC8vRVJTMjAwMzA5IGhhY2tpbmcgYXdheSEKICAgICAgICBhcnIucHVzaCgiQWN0aXZpdHlEYXRlIix6RGF0YS5mb3JtYXROb3cuc3Vic3RyaW5nKDAsMTApKTsKICAgICAgICBhcnIucHVzaCgiUmVjb3JkVHlwZUlkIix6RGF0YS5DYXJlUGxhblRhc2tSVCk7IC8vRVJTMjEwMjIxICM3Njk3NSAiMDEyNFQwMDAwMDA4YUZtUUFJIiAvL0VSUzIwMDMxMCBIQUNLIGZvciBUYXNrIG9uIENhcmVQbGFuCiAgICAgICAgLy9hcnIucHVzaCgiRHVyYXRpb25Jbk1pbnV0ZXMiLCI1Iik7CiAgICAgICAgLy9hcnIucHVzaCgiU3RhdHVzIiwiQ29tcGxldGVkIik7CiAgICAgICAgCiAgICAgICAgdmFyIGxhYmVsPSJUaW1lbGluZSAiK3pEYXRhLmRvY1R5cGU7CiAgICAgICAgdmFyIGFjdElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiVGFzayIsIG51bGwsIGFycik7IC8vRVJTMjAwMzA5IG51bGwgbWVhbnMgbm8gTmFtZSBmaWVsZAogICAgICAgIC8vdmFyIGFjdElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiRXZlbnQiLCBudWxsLCBhcnIpOyAvL0VSUzIwMDMwOSBudWxsIG1lYW5zIG5vIE5hbWUgZmllbGQKICAgICAgICBhbGVydCgiRVJTMjAwMzA4LjI2MiB0aW1lbGluZSBhY3Rpdml0eSAiK2FjdElkKTsKICAgIH0gZWxzZSB7IGFsZXJ0KCJFUlMyMDAzMDguMjYzIGJlIHdvcnJpZWQgdGhlcmUgaXMgbm8gcGF0aWVudCEiKTsgfQogICAgCiAgICBpZiAoMT09PTEgJiYgekRhdGEuY2xpZW50UmVjZWl2ZWREb2N1bWVudCkgeyB6RGF0YS5yZWNEb2NJZD16RGF0YS5jbGllbnRSZWNlaXZlZERvY3VtZW50KGRvYyxjaGlsZFN0YWNrU0ZJZCk7IH0gLy9FUlMyMDEwMTggIzc3MjUyCiAgICByZXR1cm4gY2hpbGRTdGFja1NGSWQ7Cn07CgoKekRhdGEuY2xpZW50U3RhY2tDb21wbGV0ZT1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyx6ZCkgeyAvL0VSUzIwMDMxNCAjNzAzMzYKICAgIGlmICghemQpIHpkPXpEYXRhOyAvL0VSUzIwMDQwNiAjNzExNTYKICAgIGFyck9mUGFpcnMucHVzaCgiVGltZV9Db21wbGV0ZV9EYXRlX19jIix6ZC5mb3JtYXROb3cpOyAvL2ZvciBkYXNoYm9hcmQKICAgIHJldHVybiBhcnJPZlBhaXJzOwp9OyAvL0VSUzE5MDYyNQoKekRhdGEuY2xpZW50TGlnaHRuaW5nRmlsZSA9IGZ1bmN0aW9uKGRvYywgc2ZJZHMsIHpkKSB7CiAgICBhbGVydCgid2F0Y2ggMSIpOwogICAgaWYgKCF6ZCkgemQgPSB6RGF0YTsKICAgIGlmICghZG9jLmtiRGF0YS5zZlNlcnZlcikgewogICAgICAgIC8vRVJTMjAwNDI4IEhBQ0sKICAgICAgICBhbGVydCgiZG9jLmtiRGF0YS5zZlNlcnZlciB3YXMgZW1wdHkuIElkZWFsbHkgc2hvdWxkIE5PVCBjb21lIGhlcmUiKTsKICAgICAgICBkb2Mua2JEYXRhLnNmU2VydmVyID0gInRha2VkYXBhdGllbnRzZXJ2aWNlcy0tdGtkZXYyLmxpZ2h0bmluZy5mb3JjZS5jb20iOwogICAgfQogICAgdmFyIHpzZXJ2ZXIgPSBkb2Mua2JEYXRhLnNmU2VydmVyLmluZGV4T2YoImh0dHBzOi8vIikgPT0gMCA/IGRvYy5rYkRhdGEuc2ZTZXJ2ZXIgOiAiaHR0cHM6Ly8iICsgZG9jLmtiRGF0YS5zZlNlcnZlcjsKICAgIC8vIFNhbGVzZm9yY2UgUkVTVCBBUEkgZW5kcG9pbnQKICAgIHZhciBkb2N1cmwgPSB6c2VydmVyICsgIi9zZXJ2aWNlcy9kYXRhL3Y0Ni4wL3NvYmplY3RzL0NvbnRlbnRWZXJzaW9uLyI7CiAgICAvLyBHZW5lcmF0ZSBQREYgZmlsZSBmcm9tIHpTdGFjawogICAgdmFyIGFyck9mUGFpcnMgPSBbXTsKICAgIHZhciBub3dUaW1lU3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOwogICAgYWxlcnQoIndhdGNoIDIiKTsKICAgIC8vZmlsZSBuYW1lIC0gc3RhcnQKICAgIC8vdmFyIGFjY25hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIik7CiAgICAvL3ZhciBmYXh0eXBlID0gWChkb2MsICJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwogICAgLy92YXIgZGF0ZXN0ciA9IGdldEN1ckRhdGUoZG9jKTsKICAgIC8vaWYoIWZheHR5cGUpLy9QVjIxMDMxOAogICAgLy9mYXh0eXBlID0gekRhdGEuZG9jVHlwZTsgLy9QVjIxMDMxOCBhZGRlZCBpdCBmb3IgdG8gdXBkYXRlIGRvY3R5cGUgb24gTGlnaHRuaW5nIGZpbGVzCiAgICAvL2lmKCFhY2NuYW1lKQogICAgLy8gIGFjY25hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiKSArICIgIiArIFgoZG9jLCAiWF9aUEFQRVJfX0xhc3ROYW1lX19jIik7IC8vUFYyMTAzMTgKICAgIC8vICAKICAgIC8vdmFyIGZpbGVOYW1lID0gIWFjY25hbWUgJiYgIWZheHR5cGUgPyBkb2MubGFiZWwgOiBhY2NuYW1lICsgIiAtICIgKyBmYXh0eXBlICsgIiAtICIgKyBkYXRlc3RyOwogICAgdmFyIGZpbGVOYW1lID0gInRlc3QgZmlsZSIgKyBub3dUaW1lU3RhbXAgOyAvL1BWMjEwODMxCiAgICAvL3ZhciBmaWxlTmFtZSA9ICJ0ZXN0IGZpbGUiICArICIucGRmIjsgCiAgICBhbGVydCgiQEBAZmlsZU5hbWUgPSAiICsgZmlsZU5hbWUpOwogICAgLy9maWxlIG5hbWUgZW5kCgogICAgekRhdGEudXBsb2FkRGlyID0gJ3pTdGFja1VwbG9hZFJvb3QnOyAvL3NldHRpbmcgcm9vdCBkaXJlY3RvcnkgZm9yIGZpbGUgY3JlYXRpb24KCiAgICAvL2NyZWF0ZSBkaXJlY3RvcnkgdG8gcGxhY2UgZ2VuZXJhdGVkIFBERiBmaWxlCiAgICBjcmVhdGVEaXJlY3RvcnkoZG9jLCB6RGF0YS51cGxvYWREaXIsIG5vd1RpbWVTdGFtcCk7CiAgICAvL3NwbGl0IHBkZiAtIHN0YXJ0CiAgICB2YXIgeFBhZ2VzID0gWChkb2MsICJYX3Bvc2l0aW9uIik/WChkb2MsICJYX3Bvc2l0aW9uIik6JzEtOTk5JzsgLy9nZXQgWF9wb3NpdGlvbiAtIHBhZ2UgcmFuZ2Ugc2VsZWN0ZWQ7IGRlZmF1bHQgPSBhbGwgcGFnZXMvL1BWMjEwNjI5CiAgICBhbGVydCgiQEBAQEAgQ2FsbGluZyBzcGxpdFBERiB0byBzcGxpdCBvZmYgcGFnZXMgdG8gdXBsb2FkIGFzIFBERiwgcGFnZXMgPSAiICsgeFBhZ2VzICsgIiwgbm93VGltZVN0YW1wID0gIiArIG5vd1RpbWVTdGFtcCk7CiAgICB2YXIgcmVzcG9uc2UgPSBzcGxpdFBERihkb2MsIHhQYWdlcywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXAsIGZpbGVOYW1lKTsKICAgIGFsZXJ0KCJAQEBAIHJlc3BvbnNlIGZyb20gc3BsaXRQREYgPSAiICsgcmVzcG9uc2UpOwogICAgdmFyIG5ld1BERk5hbWUgPSBYKGRvYywgIm5ld1BERiIsIHJlc3BvbnNlKTsgLy8gc2V0IHZhbHVlIG9mIG5ld1BERgogICAgYWxlcnQoIkBAQEAgc3BsaXQgUERGIEZpbGVOYW1lID0gIiArIG5ld1BERk5hbWUpOwogICAgLy9zcGxpdCBwZGYgLSBlbmQKICAgIGFsZXJ0KCJ3YXRjaCAzIik7CiAgICAvLyBDYW5ub3QgZGlyZWN0bHkgQXBwZW5kIFBERiBmaWxlIHRvIG11bHRpcGFydCBmb3JtZGF0YQogICAgLy8gSlMgZG9lcyBub3QgYWxsb3cgcmVhZGluZyBhIGZpbGUgZnJvbSB0aGUgZmlsZSBzeXN0ZW0gKG5vcm1hbGx5IGFwcGxpZXMgdG8gY2xpZW50IHNpZGUgZm9yIHNlY3VyaXR5IHJlYXNvbnMpCiAgICAvLyBXZSBkb250IGhhdmUgYSBOb2RlLmpzIGNvbnRhaW5lciwgc28gbm8gbHVjayB0aGVyZS4uIGhhdmUgdG8gZG8gdGhpcyBhbm90aGVyIHdheQogICAgLy8gRXJpYyBzdWdnZXN0ZWQgd2UgdXNlIHVwbG9hZFRvQ2xvdWQuanNwIGFwcHJvYWNoIHRvIGNyZWF0ZSBMaWdodG5pbmcgRmlsZSAocHJvYmFibHkgQ29udGVudERvY3VtZW50KSBpbiBTYWxlc2ZvcmNlCiAgICB2YXIgdXBsb2FkVVJMID0gImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9teWZpbGVmb3JjZS91cGxvYWRUb0Nsb3VkLmpzcD9TRnR5cGU9Q29udGVudFZlcnNpb24mU0ZpZD1ORVcmU0ZwaWQ9IiArIHNmSWRzWzBdICsgIiZTRlNlcnZlcj0iICsgZG9jLmtiRGF0YS5zZlNlcnZlciArICImU0ZTZXNzaW9uPSIgKyBkb2Mua2JEYXRhLnNmU2Vzc2lvbklEICsgIiZsYWJlbD0iICsgZmlsZU5hbWUgKyAiJnNlcnZlckZpbGU9IiArIG5ld1BERk5hbWUgKyAiJkRlc2NyaXB0aW9uPUZpbGUgYXR0YWNoZWQgYXMgUERGIjsKICAgIGFsZXJ0KCIjIyMjIFVwbG9hZCBuYXRpdmUgUERGIHdpdGggIiArIHVwbG9hZFVSTCk7CiAgICB2YXIgciA9IHdnZXQoZG9jLCB1cGxvYWRVUkwpOyAvLyA/Pz8/PyB3aWxsIHIgY29udGFpbiB0aGUgQ29udGVudERvY3VtZW50IGlkPwoKICAgIGFsZXJ0KCd2YWx1ZSBmcm9tIHdnZXQgcmVzcG9uc2UgPj4+ICcgKyByKTsKICAgIHZhciBpZHhCZWdpbiA9IHIuaW5kZXhPZigiPHNmSUQ+Iik7CiAgICB2YXIgaWR4RW5kID0gci5pbmRleE9mKCI8L3NmSUQ+Iik7CiAgICB2YXIgc2Zkb2NJZDsKICAgIGlmIChpZHhFbmQgPiBpZHhCZWdpbikgewogICAgICAgIHNmZG9jSWQgPSByLnN1YnN0cmluZyhpZHhCZWdpbiArIDYsIGlkeEVuZCk7CiAgICAgICAgYWxlcnQoInNmRG9jSWQgZXh0cmFjdGVkIGZyb20gciA6ICIgKyBzZmRvY0lkKTsKICAgIH0KICAgIC8vIEZpbmFsbHksIGRlbGV0ZSB0aGUgZm9sZGVyIGFuZCBhbGwgY29udGVudHMuCiAgICBjbGVhbnVwRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwogICAgYWxlcnQoIndhdGNoIDQiKTsKCiAgICB2YXIgaGVhZGVycyA9IFsKICAgICAgICAiQXV0aG9yaXphdGlvbiIsICJCZWFyZXIgIiArIGRvYy5rYkRhdGEuc2ZTZXNzaW9uSUQsCiAgICAgICAgIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIgogICAgXTsKICAgIGRvY3VybCA9IHpzZXJ2ZXIgKyAnL3NlcnZpY2VzL2RhdGEvdjQ5LjAvc29iamVjdHMvQ29udGVudERvY3VtZW50TGluay8nOwogICAgZm9yICh2YXIgaW5kZXggPSAxOyBpbmRleCA8IHNmSWRzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIC8vc2hhcmluZyBmaWxlcyB3aXRoIG90aGVyIHJlY29yZHMKICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgY3VycmVudENvbnRlbnREb2N1bWVudExpbmtSZWNvcmQgPSB7CiAgICAgICAgICAgICAgICAiQ29udGVudERvY3VtZW50SWQiOiBzZmRvY0lkLAogICAgICAgICAgICAgICAgIkxpbmtlZEVudGl0eUlkIjogc2ZJZHNbaW5kZXhdLAogICAgICAgICAgICAgICAgIlNoYXJlVHlwZSI6ICJJIgogICAgICAgICAgICB9OwogICAgICAgICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoY3VycmVudENvbnRlbnREb2N1bWVudExpbmtSZWNvcmQpOwogICAgICAgICAgICByZXMgPSB3cG9zdChkb2MsIGRvY3VybCwgW10sIGhlYWRlcnMsIGJvZHkpOwogICAgICAgICAgICBhbGVydCgid2F0Y2ggNS4xICIgKyBpbmRleCk7CiAgICAgICAgfSBjYXRjaCAoZXJycykgewogICAgICAgICAgICBhbGVydCgid2F0Y2ggNS4yIik7CiAgICAgICAgICAgIGFsZXJ0KGVycnMpOwogICAgICAgIH0KICAgIH0KICAgIGFsZXJ0KCJ3YXRjaCA2Iik7CiAgICByZXR1cm4gbnVsbDsKfQphbGVydCgiZW5kIGNsaWVudCBsaWJyYXJ5Iik7IC8vRVJTMTkwNjE1ICM1ODkyMQ=="},"ordinal":2}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("start client library"); //ERS190803 #52661 from OccFit
//ERS201117 TODO get rid off these keywords and use a document journey wizard from KPS and Jake

//CRN201025 #76788 Moved from zStack Library so that it can be used in multiple rules.
var keywordMap={};
var keywords=["NEW:Document Stack~","ENRL:Enrollmcent~","ENRL:ENROLLMENT~","CON:Consent~","CON:consent~","FAC:Setting~","FAC:Distribution~","START:Start Form~","CHK:Checklist~","HIPAA:AUTHORIZATION~","HIPAA:HIPAA~","HIPAA:PORTABILITY~","REF:REFERRAL","REF:Referral","FIN:W2~","IC:Member ID~","FAX:"];
//keywordMap["TENR"] ="TENR:Start Form";
keywordMap["NEW"] ="NEW:Document Stack";
keywordMap["ENRL"] ="ENRL:Enrollment Form";
keywordMap["FAC"] ="FAC:Facility Enrollment Form";
keywordMap["FAX"] ="NEW:Document Stack";
//keywordMap["START"] ="NEW:Document Stack";
keywordMap["CON"] ="CON:Consent Form";
keywordMap["HIPAA"] ="HIPAA:HIPAA Authorization";
keywordMap["REF"] ="REF:Referral";
keywordMap["FW2"] ="FW2:W-2"; //JPB201023 added
keywordMap["I9"] ="I9:I-9"; //JPB201023 added
keywordMap["W4"] ="W4:W-4"; //JPB201023 added
keywordMap["DEM"] ="DEM:Demographics"; //CRN201026 added
keywordMap["CLIN"] ="CLIN:Clinical Notes"; //CRN201026 added
keywordMap["FIN"] ="FIN:Financial Info"; //CRN201026 added
keywordMap["IC"] ="IC:Insurance Card"; //CRN201026 added

zData.maxChannels=3; //ERS190731 #61272 zippi is strongly typed
zData.makeStack=true; //ERS190814 #61511

zData.watermark=""+XCustomSetting(doc,"watermark__c"); //ERS190618 best practice
//alert("ERS190411 wm="+zData.watermark+" ZPAPER__server__c="+XCustomSetting(doc,"ZPAPER__server__c"));
zData.uploadDir = ""+XCustomSetting(doc,"uploadDir__c"); //"alkermesRoot";
zData.patEnrollQueueId = ""+XCustomSetting(doc,"patientQueueId__c"); //'00G4C000000LkmZ'; //insert the Queue ID of the desired ownership queue. Update when migrating between environments. Need to add this queue in Setup
zData.recTypeRequest = ""+XCustomSetting(doc,"recTypeRequest__c"); //'0124C000000Cj5Y'; //ID of the Case Record Type Request_PS_MVN
//TODO zData.keywordMap["ENRL"] ="ENRL:Enrollment Form";  //TODO get from zStack picklists
//TODO zData.keywordMap["FAC"] ="FAC:Facility Enrollment Form";
//ERS200205 deleted demo data - do with custom settings

var cs=XDeploymentInfo(doc, "Business_Process__c"); //ERS200222 need both deployment info and cs
//alert("cs="+cs);
if (cs) {
    if (cs.indexOf("zCustomSettings")>-1) cs=X(doc,"zCustomSettings",cs);
    alert("ERS200225 EVAL on "+cs);
    if (cs !== "") eval(""+cs); //ERS200222 TODO JSON.parse() //ERS200225 beeds to be eval but also needs to work!!!
    alert("No try just do!");
}

if (1===0 && !zData.childStackRecordType) { //TODO custom setting or deployment? //ERS201129 DONE in zChildFields
    alert("ERS201128 should be in custom settings zChildFields");
    zData.childStackRecordType="01211000001gBs3AAE"; //ERS201128 should be in custom settings zChildFields "0120R000001N2oI";
}

zData.clientImportSOQL=function(doc,fromFile) { //ERS190706 customize imports used by Create Stack
    zData.importer=XCustomSetting(doc,zData.zp+"Importer__c").trim();
    var sfId="";
    var parts=fromFile.split("_");
    //sfId = getSFRecordID(doc, "Account", { "Fax" : parts[3] } );
    zData.makeStack=true; //do all the work there by default
    return sfId;
};

//alert("zData.clientStack");
zData.clientStack=function(doc,arrOfPairs) { //zData or this?
alert("@@@zData.clientStack");
    var zp=zData.zp; if (!zp) zp="ZPAPER__"; //ERS190805 
	if (zData.received) arrOfPairs.push("zStack_Received__c", zData.formatNow); //ERS190617 TODO save way to do this
	if (zData.ownerId) arrOfPairs.push("OwnerId",zData.ownerId);  // zCharta Queue "00G36000002CyTK" 
	if (zData.callerId) arrOfPairs.push("zCaller_ID__c", doc.deliveredFrom); //MSH170817 added
	if (zData.patEnrollQueueId) arrOfPairs.push("OwnerId",zData.patEnrollQueueId);
	alert("1111zData.clientStack");
	 var qrCode = X(doc,"X_barCode0");
	 alert("123@@qrCode" + qrCode);
     arrOfPairs.push("ZPAPER__faxType__c", qrCode || zData.docType );
     //if (zData.docType) arrOfPairs.push("ZPAPER__faxType__c", zData.docType);//PV210811
    alert("@@@123ZPAPER__faxType__c" + zData.docType);//PV210824
    arrOfPairs.push("ZPAPER__Classification__c", zData.classification);
    var pageRange = X(doc,"X_idxPages");
    if (!pageRange) pageRange="1-"+X(doc,"X_pages"); 
    var pageCount = zData.countPages(doc, pageRange);
    arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 
    //ERS190810 TODO? arrOfPairs.push("ZSTACK__Received__c", zData.formatNow);
    alert("ERS200213.51 pageRage="+pageRange + " but pageCount="+pageCount); //ERS200213 also called in new incoming stack
    if (!X(doc,"X_idxPages")) pageCount=X(doc,"X_pages"); //ERS200213 TODO fix zData.countPages()
    arrOfPairs.push("ZPAPER__Pages__c", pageCount);
    
    arrOfPairs.push(zp+"sentFaxTo__c", ("Community" === zData.channel ? zData.channel : doc.deliveredTo)); //JPB190529 added so Community shows up in Master Intake List
    arrOfPairs.push(zp+"From__c",doc.deliveredFrom);
    if (zData.reviewedStatus) {arrOfPairs.push(zp+"Stage__c", zData.reviewedStatus); } 
    else { arrOfPairs.push(zp+"Stage__c", "Received"); }
    zData.stackPairs=arrOfPairs; //ERS190810 #61570 for child stack later
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__zStackFields__c")); //ERS190803 #52661 using JSON
    if (zData.newDocument && !(doc.deliveredFrom.startsWith("a1") || doc.deliveredFrom.startsWith("a0"))) {
        var aop=[];
        aop.push(zData.PCpackage + "PC_Document_Category__c", zData.docType);
        //aop.push("zStack__c", stackId);
        var dtpcId=zData.newDocument(doc, aop, zData.SFDCtype, zData.programName);
        alert("ERS210527 #83032 dtpcId new zstack document id="+dtpcId);
    }
    if(doc.deliveredFrom.startsWith("a1") || doc.deliveredFrom.startsWith("a0")){ //PV210831
        var attachPath = doc.deliveredFrom;
        alert("@1234556doc.deliveredFrom" + doc.deliveredFrom);
         var arrOfPairsAttachTo = [];
        arrOfPairsAttachTo.push("X_attachedTo", attachPath); 
        updateDB(doc,arrOfPairsAttachTo);
    }
	return arrOfPairs;
};

//alert("zData.clientFile");
zData.clientFile=function(doc,stage) { //ERS170829 #41298 returns a label to be used in any attaches and fixes the doc
    //Document attachment label should be "Patient Name - Doc Type - Date".  Confirmed for zPaper File and SFDC Attachment
    var label0=doc.label;
    var MMddYYYY = zData.formatTodayMMddYYYY();
    if (!stage) { stage="Split"; } //ERS210410 #78759 ribbon actions
    
    //CRN201025 #76788 Fixed to match the current demo.
    var patientName = X(doc,"X_ZPAPER__PatientAccount__r.Name");
    if (!patientName && X(doc, "X_ZPAPER__LastName__c") ) {
        patientName = X(doc,"X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c");
    }
    var faxType = keywordMap[X(doc,"X_ZPAPER__faxType__c")];
    if (!faxType) { faxType = X(doc,"X_ZPAPER__faxType__c"); }
    if (!faxType.indexOf(':') >= 0) { faxType = faxType.split(':')[1]; }
    // doc.label = patientName + " - " + faxType + " - " + MMddYYYY;
    doc.label = patientName + " - " + faxType;
    if (!patientName || patientName.length<5 || (!faxType && stage !== "Split")) { //ERS201129 #78830 //ERS210410 added faxType test
        doc.label="Split from "+X(doc,"X_splitPages")+" of "+ X(doc,"X_fromPages") +" - "+MMddYYYY;
        doc.label="Split from "+ X(doc,"X_fromPages") +" - "+MMddYYYY;
        doc.label=stage+" from "+X(doc,"X_fromPages")+" - "+MMddYYYY; //ERS210410 ribbon
    } 
    alert("ERS170829 dbID="+doc.dbID+" label="+doc.label +" sfID="+zData.sfID);
    if (!zData.sfID) { zData.sfID=X(doc,"sfID"); } //ERS201211 #79591
    //TODO if HC and outbound then Send to {!Contact.Name} at {!Contact.Account.Name}
    //TODO if HC and recieved then Recieved from {!Contact.Name} at {!Contact.Account.Name}
    if (zData.sfID  && zData.sfID.indexOf("500")===0) {
	    zData.provider = getSFField(doc, "Case", "Account.Name", null, zData.sfID); 
	    doc.label = "Received from " + zData.provider; //ERS201211 #79591  missing doc.
        if (zData.facility) {
            zData.facility = getSFField(doc, "Case", "Account.Facility__r.Name", null, zData.sfID);
            doc.label+=" at "+zData.facility;
        }
	}
	if (doc.label.length > 6) { //ERS210529 only do it if there is a change worth saving
    	var arrOfPairs = [];
        arrOfPairs.push("db-label", doc.label);
    	updateDB(doc,arrOfPairs);
	} else return label0;
    return doc.label;
};

zData.clientValue=function(doc,val) {//ERS190803 #52661 using JSON 
    val=val.replace("{!formatNow}",zData.formatNow);
    return val;
}

zData.clientFields=function(doc,arrOfPairs,jd,zd) { //ERS190803 #52661 using JSON in setting to configure new record
    if (!zd) zd=zData;
	if (jd && jd.indexOf("{")===0) { 
	    //{"Type":"Eligibility","OwnerId":"00Gc0000003vgqw","RecordTypeId":"0126A000000JEKeQAO"};
	    //NOT A GOOD IDEA jd=jd.replaceAll("\"","'"); //ERS190811 #61570 HACK?
	    jd=jd.replace("};","}"); //ERS201129 SHR to work out design on channel wizard for zStack child set ASAP
	    try {
    	    var jdata=JSON.parse(jd); //ERS190805 better than eval
    	    for (var n in jdata) {
    	        var v0=jdata[n]; 
    	        var v=zData.clientValue(doc,v0); //ERS190811 ,v now ,v0
    	        alert("ERS190803.97 "+n+"="+v0+"="+v); 
    	        arrOfPairs.push(n,v); //ERS190811 added .push
    	        zd[n]=v; //ERS201129 #78830 TODO review arrOfPairs access using for RecordTypeId
    	    }
	    } catch (e) {
	        alert("JSON not in "+jd+" Exception: "+e); //ERS190811 added e
	    }
	}
	return arrOfPairs;
}


zData.clientCase=function(doc,arrOfPairs,label,zd) {
	if (!zd) zd=zData;
	if (!zd.triageType && X(doc,"X_ZPAPER__faxType__c")) zd.triageType=X(doc,"X_ZPAPER__faxType__c"); //ERS200308
	if (!label) { label="Indexed-" + "-" + zd.triageType + "-" + zd.stackId;}
	
	alert("ERS200308.128 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
	
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	if (zd.contactId) arrOfPairs.push("ContactId", zd.contactId);
	arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
	arrOfPairs.push("Status", X(doc,"X_Status"));
	arrOfPairs.push("ZPAPER__faxType__c",zd.triageType); //ERS200308
	//ERS200205 arrOfPairs.push("Type", "New "+zd.classification); //JPB 170512 added these workflow fields
	//ERS200308 arrOfPairs.push("Type", "New "+zd.docType);
	if (1==1) { //ERS170523 #37162 after dryrun
	    alert("@@@ zd.priority => *" + zd.priority + "*");
		//arrOfPairs.push("RecordTypeId","012Q00000005Ahj"); //ERS170523 Prior Auth
		if (zd.priority != "Normal") { arrOfPairs.push("Priority",zd.priority); }  //ERS170524 #37162 priority on Case
		else { arrOfPairs.push("Priority","Medium"); }
		arrOfPairs.push("Origin","Fax"); //ERSa200205 rrOfPairs.push("Origin",zd.channel);
	}
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__CaseFields__c")); //ERS190803 #52661 using JSON
    
    alert("ERS200308.143 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
    if (zd.providerId && zd.providerId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.providerId); } //ERS200308
    if (zd.providerId && zd.providerId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.providerId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.patientId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.patientId); } //ERS200308
    if (zd.zchannel.owner) { arrOfPairs.push("OwnerId", zData.zchannel.owner); } //ERS200308
    
	var caseId = createAndAttach(doc, "Case", label, arrOfPairs);
	return caseId;
};

zData.clientPatient=function(doc,arrOfPairs,label,zd) {
	if (!zd) zd=zData;
	if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
	if (zd.patientId) { //ERS200205 #68825 Program Members
	    alert("Patient already exists in "+zd.patientId);
	    return zd.patientId; //TOOD get from X_patientId  ????
	}
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	var p="ZPAPER__"; //ERS200202 assume workflow on related record types
	if (zData.patientType.indexOf("__c") > -1) { p=""; } //ERS200203 typo
	if (1==0) { //ERS200202 see if workflow enabled
	    arrOfPairs.push(p+"newFax__c", "true"); //JPB 170512 added these workflow fields
	    arrOfPairs.push(p+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	    arrOfPairs.push(p+"receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
	}

    var rt=XCustomSetting(doc,"PatientRecordType__c"); //TODO into MP ERS190802 like 0126A000000JE8yQAG or empty to use default
    //if (rt) { arrOfPairs.push("RecordTypeId", rt); } //ERS190803
    //TODO Contact or Account ERS190624 DONE!! ERS190802
    arrOfPairs=[]; //ERS201212 HACK since the Index action needs to be refactored
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__PatientFields__c")); //ERS190803 #52661 using JSON 
    //ERS201212 back in now!  #79588 arrOfPairs=[]; //ERS200204 testing to get it going
    
    //ERS200202 need to make the Account with Patient recordType first
    //01246000000NGFYAA4 is .zpaper for Patient
    var ar = [];
    ar=arrOfPairs; //ERS201212 #79588
    if (rt) { ar.push("RecordTypeId", rt); } //ERS190803 //ERS200222 #69149 moved down and added else 
    //ERS201212 get from PatientFields now! #79588 else ar.push("RecordTypeId","01246000000NGFYAA4");
    ar.push("FirstName",zData.X_ZPAPER__FirstName__c);
    ar.push("LastName",zData.X_ZPAPER__LastName__c);
    var patientName=zData.X_ZPAPER__LastName__c+", "+zData.X_ZPAPER__FirstName__c;
    
    //if (zData.X_ZPAPER__Birthdate__c) ar.push("PersonBirthDate",zData.X_ZPAPER__Birthdate__c);
    //var aId = createSFRecord(doc, "Account", null, ar); //ERS200204 person account so do not set patientName
    
    if (zData.X_ZPAPER__Birthdate__c && zData.patientType.indexOf("Account")>-1) ar.push("PersonBirthDate",zData.X_ZPAPER__Birthdate__c);
    if (zData.X_ZPAPER__Birthdate__c && zData.patientType.indexOf("Contact")>-1) ar.push("BirthDate",zData.X_ZPAPER__Birthdate__c);
    var patientType=zData.patientType.replace("Person",""); //ERS201212 make SOQL happy HACK?
    var aId = createSFRecord(doc,patientType, null, ar); //ERS200204 person account so do not set patientName
    
    
    if (aId && aId != "NEW" && aId.indexOf("ERROR")==-1) {
        var sfId = aId; //ERS201212 was ""
    	
    	//ERS190803 specific to client data entry
    	var dq = zData.dq;
    	addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c" + dq + ").val(" + dq + sfId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
        return aId; //ERS201212 #79588 return the Id was missing
    }
    return {'ERROR': 'patient not created'}
};

zData.clientAccount=function(doc,arrOfPairs,label,zd) {
	if (!zd) zd=zData;
	if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields

	var accountId = createAndAttach(doc, "Account", label, arrOfPairs);
	return accountId;
};

zData.clientRecord=function(doc,sfType,arrOfPairs,label,zd) { //ERS190620 clientRecord generic
	if (!zd) zd=zData;
	if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
	//ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
	var zp="";
	if (",Case,Contact,Account,Lead,Opportunity,ZPAPER__zStack__c,".toLowerCase().indexOf(","+sfType.toLowerCase()+",")>-1) zp=zData.zp;
	//only do this if the fields exist
	arrOfPairs.push(zp+"newFax__c", "true"); //JPB 170512 added these workflow fields
	arrOfPairs.push(zp+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
	arrOfPairs.push(zp+"receivedId__c", "doc.dbID.Rec"); //JPB 170512 added these workflow fields
	
	//TODO put client specific data updates here

	var newId = createAndAttach(doc, sfType, label, arrOfPairs);
	return newId;
};

zData.clientComplete=function(doc,arrOfPairs,zd) {return arrOfPairs;}; //ERS190625
alert("clientDeliveryStart" );
zData.clientDelivery=function(doc,arrOfPairs) { //ERS200202 TODO consider new Document_MVN
    if (zData.newDocument) {
        //TODO new array?
        var ba=doc.X("X_faxStatus")+""; //PV210622 to check the fax status
        if ("Delivered" !== ba) { ba="Failed"; } 
        alert("ClientDeliveryIf1");
        arrOfPairs.push("zPaper_Fax_Unique_Id__c", doc.dbID); //ERS210529 DTPC
        destFieldName = zData.PCpackage + "PC_To_Fax_Number__c";
        alert("outboundFaxRecordType" + zData.outboundFaxRecordType);
        alert("doc.deliveredTo" + doc.deliveredTo);
        if (doc.deliveredTo.indexOf("@") > -1) { //ERS180821 if (isNaN(doc.deliveredFrom))
            arrOfPairs.push("RecordTypeId", zData.outboundEmailRecordType);
        } else {
            arrOfPairs.push("RecordTypeId", zData.outboundFaxRecordType); //MSH180817 #51641
        }
        //ERS210529 NEW FIELD? arrOfPairs.push("spc_Scource_Object_ID__c", zData.caseId);
        arrOfPairs.push(destFieldName, doc.deliveredTo);
        //PV210708 commented coz cliet requested to not create document and document log record
        //var dtpcId=zData.newDocument(doc, arrOfPairs, zData.SFDCtype, zData.programName, undefined, undefined, ba); //PV210709 added for stage
        //alert("ERS210527 #83032 dtpcId new activity document id="+dtpcId);
    }
    return arrOfPairs;
}; //ERS190711 #60900 PAOS

zData.clientChildStack=function(doc,arrOfPairs,parentId) { //ERS190810 #61570 be sure to call on new child doc
    var pairs=arrOfPairs;
    //no memory of stack creation var pairs=zData.stackPairs;
    //CRN201026 #76788 We need reviewedStatus to be "Indexed" for the index rule, so only set the field if it isn't already set.
    if (!zData.reviewedStatus) { zData.reviewedStatus="Split"; }
    //ERS190810 TODO? pairs.push("ZPAPER__Status__c", "Child Stack");

    pairs=zData.clientStack(doc,pairs);
    if (XCustomSetting(doc,"ZPAPER__zChildFields__c")) { //ERS190811 not in all MPs
        pairs=zData.clientFields(doc,pairs,XCustomSetting(doc,"ZPAPER__zChildFields__c")); //ERS190803 #52661 using JSON child record type id
    }
    pairs.push("ZPAPER__Parent__c", parentId);
    //ERS201128 should be in zChildFields if (zData.childStackRecordType) pairs.push("RecordTypeId",zData.childStackRecordType);
    
    //pairs.push(""+"Program__c",zData.programName); //ERS200205 TODO in package and into base call //SHR201202 #79257
    pairs.push(""+"ZPAPER__Program_Name__c",zData.programName); //SHR201202 #79257 use the Program_Name field instead of Program__c
    //ERS200229 if (zData.patientId) pairs.push("Program_Member_MVN__c",zData.patientId); //ERS200205 Program_Member_MVN__c was the TICKET!!!
    alert("ERS190811.191 ZPAPER__Parent__c"+ parentId+" child zData.childStackRecordType="+zData.childStackRecordType);
    if (zData['RecordTypeId']) {  zData.childStackRecordType=zData['RecordTypeId']; } //ERS201129 #78830 TODO not sure where this is used elsewhere
    alert("ERS201129.292 ZPAPER__Parent__c"+ parentId+" child RecordTypeId="+zData['RecordTypeId']);
    var childStackSFId = createAndAttach(doc, "ZPAPER__zStack__c", "zStack split on " + zData.formatNow, pairs) + "";
    
	alert("zData.newDocument = " + typeof zData.newDocument);
	if (zData.newDocument) {
        var aop=[];
        aop.push(zData.PCpackage + "PC_Document_Category__c", zData.docType);
        //aop.push("zStack__c", stackId);
        var dtpcId=zData.newDocument(doc, aop, zData.SFDCtype, zData.programName);
        alert("document created after split="+dtpcId);
    }
	
    if (!zData.patientId && X(doc,"X_ZPAPER__PatientAccount__c") ){ //ERS200308 HACK
        zData.patientId=X(doc,"X_ZPAPER__PatientAccount__c");
        alert("ERS200308 WHY NOT in zData?");
    }
    
    if (zData.patientId && zData.CarePlanTaskRT) { //ERS210221 #76975 deployment setting //ERS200308 create an Activity Event related to the Patient (Account) for the Timeline
        if (!zData.docType && X(doc,"X_ZPAPER__faxType__c")) zData.docType=X(doc,"X_ZPAPER__faxType__c");
        var arr=[];
        //NOT SELECT AccountId,ActivityDate,CreatedDate,Status,Subject,TaskSubtype,WhatId,WhoId FROM Task where ActivityDate > 2020-02-01
        //SELECT Id,AccountId,ActivityDate,CreatedDate,Subject,WhatId,WhoId FROM Event where Id = '00U4T000002vChrUAE'
        //arr.push("WhoId",zData.patientId); //ERS200310 timeline trick
        if (zData.patientId.indexOf("001")==0) {
            arr.push("WhatId",zData.patientId); //ERS200310 timeline trick
            //arr.push("AccountId",zData.patientId); //ERS200310 timeline trick
        } else if (zData.caseId) arr.push("WhatId",zData.caseId);
        else if (zData.providerId) arr.push("WhatId",zData.providerId);
        else arr.push("WhatId",childStackSFId);
        //arr.push("TaskSubtype","Task");
        arr.push("Subject",zData.stage + " "+zData.docType);
        arr.push("Description","Check out "+doc.dbID);
        //arr.push("ActivityDateTime",zData.formatNow); //ERS200309 hacking away!
        arr.push("ActivityDate",zData.formatNow.substring(0,10));
        arr.push("RecordTypeId",zData.CarePlanTaskRT); //ERS210221 #76975 "0124T0000008aFmQAI" //ERS200310 HACK for Task on CarePlan
        //arr.push("DurationInMinutes","5");
        //arr.push("Status","Completed");
        
        var label="Timeline "+zData.docType;
        var actId = createSFRecord(doc, "Task", null, arr); //ERS200309 null means no Name field
        //var actId = createSFRecord(doc, "Event", null, arr); //ERS200309 null means no Name field
        alert("ERS200308.262 timeline activity "+actId);
    } else { alert("ERS200308.263 be worried there is no patient!"); }
    
    if (1===1 && zData.clientReceivedDocument) { zData.recDocId=zData.clientReceivedDocument(doc,childStackSFId); } //ERS201018 #77252
    return childStackSFId;
};


zData.clientStackComplete=function(doc,arrOfPairs,zd) { //ERS200314 #70336
    if (!zd) zd=zData; //ERS200406 #71156
    arrOfPairs.push("Time_Complete_Date__c",zd.formatNow); //for dashboard
    return arrOfPairs;
}; //ERS190625

zData.clientLightningFile = function(doc, sfIds, zd) {
    alert("watch 1");
    if (!zd) zd = zData;
    if (!doc.kbData.sfServer) {
        //ERS200428 HACK
        alert("doc.kbData.sfServer was empty. Ideally should NOT come here");
        doc.kbData.sfServer = "takedapatientservices--tkdev2.lightning.force.com";
    }
    var zserver = doc.kbData.sfServer.indexOf("https://") == 0 ? doc.kbData.sfServer : "https://" + doc.kbData.sfServer;
    // Salesforce REST API endpoint
    var docurl = zserver + "/services/data/v46.0/sobjects/ContentVersion/";
    // Generate PDF file from zStack
    var arrOfPairs = [];
    var nowTimeStamp = new Date().getTime() + "";
    alert("watch 2");
    //file name - start
    //var accname = X(doc, "X_ZPAPER__PatientAccount__r.Name");
    //var faxtype = X(doc, "X_ZPAPER__faxType__c");
    //var datestr = getCurDate(doc);
    //if(!faxtype)//PV210318
    //faxtype = zData.docType; //PV210318 added it for to update doctype on Lightning files
    //if(!accname)
    //  accname = X(doc, "X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c"); //PV210318
    //  
    //var fileName = !accname && !faxtype ? doc.label : accname + " - " + faxtype + " - " + datestr;
    var fileName = "test file" + nowTimeStamp ; //PV210831
    //var fileName = "test file"  + ".pdf"; 
    alert("@@@fileName = " + fileName);
    //file name end

    zData.uploadDir = 'zStackUploadRoot'; //setting root directory for file creation

    //create directory to place generated PDF file
    createDirectory(doc, zData.uploadDir, nowTimeStamp);
    //split pdf - start
    var xPages = X(doc, "X_position")?X(doc, "X_position"):'1-999'; //get X_position - page range selected; default = all pages//PV210629
    alert("@@@@@ Calling splitPDF to split off pages to upload as PDF, pages = " + xPages + ", nowTimeStamp = " + nowTimeStamp);
    var response = splitPDF(doc, xPages, zData.uploadDir, nowTimeStamp, fileName);
    alert("@@@@ response from splitPDF = " + response);
    var newPDFName = X(doc, "newPDF", response); // set value of newPDF
    alert("@@@@ split PDF FileName = " + newPDFName);
    //split pdf - end
    alert("watch 3");
    // Cannot directly Append PDF file to multipart formdata
    // JS does not allow reading a file from the file system (normally applies to client side for security reasons)
    // We dont have a Node.js container, so no luck there.. have to do this another way
    // Eric suggested we use uploadToCloud.jsp approach to create Lightning File (probably ContentDocument) in Salesforce
    var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid=" + sfIds[0] + "&SFServer=" + doc.kbData.sfServer + "&SFSession=" + doc.kbData.sfSessionID + "&label=" + fileName + "&serverFile=" + newPDFName + "&Description=File attached as PDF";
    alert("#### Upload native PDF with " + uploadURL);
    var r = wget(doc, uploadURL); // ????? will r contain the ContentDocument id?

    alert('value from wget response >>> ' + r);
    var idxBegin = r.indexOf("<sfID>");
    var idxEnd = r.indexOf("</sfID>");
    var sfdocId;
    if (idxEnd > idxBegin) {
        sfdocId = r.substring(idxBegin + 6, idxEnd);
        alert("sfDocId extracted from r : " + sfdocId);
    }
    // Finally, delete the folder and all contents.
    cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);
    alert("watch 4");

    var headers = [
        "Authorization", "Bearer " + doc.kbData.sfSessionID,
        "Content-Type", "application/json"
    ];
    docurl = zserver + '/services/data/v49.0/sobjects/ContentDocumentLink/';
    for (var index = 1; index < sfIds.length; index++) {
        //sharing files with other records
        try {
            var currentContentDocumentLinkRecord = {
                "ContentDocumentId": sfdocId,
                "LinkedEntityId": sfIds[index],
                "ShareType": "I"
            };
            body = JSON.stringify(currentContentDocumentLinkRecord);
            res = wpost(doc, docurl, [], headers, body);
            alert("watch 5.1 " + index);
        } catch (errs) {
            alert("watch 5.2");
            alert(errs);
        }
    }
    alert("watch 6");
    return null;
}
alert("end client library"); //ERS190615 #58921
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
//--- RULE VALIDATION CODE - END ---

</script>
