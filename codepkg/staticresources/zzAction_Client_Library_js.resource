<!--
// Name: Client Library
// Committer: Prathyusha.vasireddy@zpaper.com
// Update: updated
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2021-04-04 22:39:00","evalContinue":"true","active":true,"button":"","name":"Client Library","conditions":{"logic":"and","arguments":[{"name":"doc.status","value":"DoNotClient","operation":"not-contains"}]},"consequence":{"doit":"YWxlcnQoInN0YXJ0IGNsaWVudCBsaWJyYXJ5Iik7IC8vRVJTMTkwODAzICM1MjY2MSBmcm9tIE9jY0ZpdAovL0VSUzIwMTExNyBUT0RPIGdldCByaWQgb2ZmIHRoZXNlIGtleXdvcmRzIGFuZCB1c2UgYSBkb2N1bWVudCBqb3VybmV5IHdpemFyZCBmcm9tIEtQUyBhbmQgSmFrZQoKLy9DUk4yMDEwMjUgIzc2Nzg4IE1vdmVkIGZyb20gelN0YWNrIExpYnJhcnkgc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBpbiBtdWx0aXBsZSBydWxlcy4KdmFyIGtleXdvcmRNYXA9e307CnZhciBrZXl3b3Jkcz1bIk5FVzpEb2N1bWVudCBTdGFja34iLCJFTlJMOkVucm9sbG1lbnR+IiwiRU5STDpFTlJPTExNRU5UfiIsIkNPTjpDb25zZW50fiIsIkNPTjpjb25zZW50fiIsIkZBQzpTZXR0aW5nfiIsIkZBQzpEaXN0cmlidXRpb25+IiwiU1RBUlQ6U3RhcnQgRm9ybX4iLCJDSEs6Q2hlY2tsaXN0fiIsIkhJUEFBOkFVVEhPUklaQVRJT05+IiwiSElQQUE6SElQQUF+IiwiSElQQUE6UE9SVEFCSUxJVFl+IiwiUkVGOlJFRkVSUkFMIiwiUkVGOlJlZmVycmFsIiwiRklOOlcyfiIsIklDOk1lbWJlciBJRH4iLCJGQVg6Il07Ci8va2V5d29yZE1hcFsiVEVOUiJdID0iVEVOUjpTdGFydCBGb3JtIjsKa2V5d29yZE1hcFsiTkVXIl0gPSJORVc6RG9jdW1lbnQgU3RhY2siOwprZXl3b3JkTWFwWyJFTlJMIl0gPSJFTlJMOkVucm9sbG1lbnQgRm9ybSI7CmtleXdvcmRNYXBbIkZBQyJdID0iRkFDOkZhY2lsaXR5IEVucm9sbG1lbnQgRm9ybSI7CmtleXdvcmRNYXBbIkZBWCJdID0iTkVXOkRvY3VtZW50IFN0YWNrIjsKLy9rZXl3b3JkTWFwWyJTVEFSVCJdID0iTkVXOkRvY3VtZW50IFN0YWNrIjsKa2V5d29yZE1hcFsiQ09OIl0gPSJDT046Q29uc2VudCBGb3JtIjsKa2V5d29yZE1hcFsiSElQQUEiXSA9IkhJUEFBOkhJUEFBIEF1dGhvcml6YXRpb24iOwprZXl3b3JkTWFwWyJSRUYiXSA9IlJFRjpSZWZlcnJhbCI7CmtleXdvcmRNYXBbIkZXMiJdID0iRlcyOlctMiI7IC8vSlBCMjAxMDIzIGFkZGVkCmtleXdvcmRNYXBbIkk5Il0gPSJJOTpJLTkiOyAvL0pQQjIwMTAyMyBhZGRlZAprZXl3b3JkTWFwWyJXNCJdID0iVzQ6Vy00IjsgLy9KUEIyMDEwMjMgYWRkZWQKa2V5d29yZE1hcFsiREVNIl0gPSJERU06RGVtb2dyYXBoaWNzIjsgLy9DUk4yMDEwMjYgYWRkZWQKa2V5d29yZE1hcFsiQ0xJTiJdID0iQ0xJTjpDbGluaWNhbCBOb3RlcyI7IC8vQ1JOMjAxMDI2IGFkZGVkCmtleXdvcmRNYXBbIkZJTiJdID0iRklOOkZpbmFuY2lhbCBJbmZvIjsgLy9DUk4yMDEwMjYgYWRkZWQKa2V5d29yZE1hcFsiSUMiXSA9IklDOkluc3VyYW5jZSBDYXJkIjsgLy9DUk4yMDEwMjYgYWRkZWQKCnpEYXRhLm1heENoYW5uZWxzPTM7IC8vRVJTMTkwNzMxICM2MTI3MiB6aXBwaSBpcyBzdHJvbmdseSB0eXBlZAp6RGF0YS5tYWtlU3RhY2s9dHJ1ZTsgLy9FUlMxOTA4MTQgIzYxNTExCgp6RGF0YS53YXRlcm1hcms9IiIrWEN1c3RvbVNldHRpbmcoZG9jLCJ3YXRlcm1hcmtfX2MiKTsgLy9FUlMxOTA2MTggYmVzdCBwcmFjdGljZQovL2FsZXJ0KCJFUlMxOTA0MTEgd209Iit6RGF0YS53YXRlcm1hcmsrIiBaUEFQRVJfX3NlcnZlcl9fYz0iK1hDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19zZXJ2ZXJfX2MiKSk7CnpEYXRhLnVwbG9hZERpciA9ICIiK1hDdXN0b21TZXR0aW5nKGRvYywidXBsb2FkRGlyX19jIik7IC8vImFsa2VybWVzUm9vdCI7CnpEYXRhLnBhdEVucm9sbFF1ZXVlSWQgPSAiIitYQ3VzdG9tU2V0dGluZyhkb2MsInBhdGllbnRRdWV1ZUlkX19jIik7IC8vJzAwRzRDMDAwMDAwTGttWic7IC8vaW5zZXJ0IHRoZSBRdWV1ZSBJRCBvZiB0aGUgZGVzaXJlZCBvd25lcnNoaXAgcXVldWUuIFVwZGF0ZSB3aGVuIG1pZ3JhdGluZyBiZXR3ZWVuIGVudmlyb25tZW50cy4gTmVlZCB0byBhZGQgdGhpcyBxdWV1ZSBpbiBTZXR1cAp6RGF0YS5yZWNUeXBlUmVxdWVzdCA9ICIiK1hDdXN0b21TZXR0aW5nKGRvYywicmVjVHlwZVJlcXVlc3RfX2MiKTsgLy8nMDEyNEMwMDAwMDBDajVZJzsgLy9JRCBvZiB0aGUgQ2FzZSBSZWNvcmQgVHlwZSBSZXF1ZXN0X1BTX01WTgovL1RPRE8gekRhdGEua2V5d29yZE1hcFsiRU5STCJdID0iRU5STDpFbnJvbGxtZW50IEZvcm0iOyAgLy9UT0RPIGdldCBmcm9tIHpTdGFjayBwaWNrbGlzdHMKLy9UT0RPIHpEYXRhLmtleXdvcmRNYXBbIkZBQyJdID0iRkFDOkZhY2lsaXR5IEVucm9sbG1lbnQgRm9ybSI7Ci8vRVJTMjAwMjA1IGRlbGV0ZWQgZGVtbyBkYXRhIC0gZG8gd2l0aCBjdXN0b20gc2V0dGluZ3MKCnZhciBjcz1YRGVwbG95bWVudEluZm8oZG9jLCAiQnVzaW5lc3NfUHJvY2Vzc19fYyIpOyAvL0VSUzIwMDIyMiBuZWVkIGJvdGggZGVwbG95bWVudCBpbmZvIGFuZCBjcwovL2FsZXJ0KCJjcz0iK2NzKTsKaWYgKGNzKSB7CiAgICBpZiAoY3MuaW5kZXhPZigiekN1c3RvbVNldHRpbmdzIik+LTEpIGNzPVgoZG9jLCJ6Q3VzdG9tU2V0dGluZ3MiLGNzKTsKICAgIGFsZXJ0KCJFUlMyMDAyMjUgRVZBTCBvbiAiK2NzKTsKICAgIGlmIChjcyAhPT0gIiIpIGV2YWwoIiIrY3MpOyAvL0VSUzIwMDIyMiBUT0RPIEpTT04ucGFyc2UoKSAvL0VSUzIwMDIyNSBiZWVkcyB0byBiZSBldmFsIGJ1dCBhbHNvIG5lZWRzIHRvIHdvcmshISEKICAgIGFsZXJ0KCJObyB0cnkganVzdCBkbyEiKTsKfQoKaWYgKDE9PT0wICYmICF6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSkgeyAvL1RPRE8gY3VzdG9tIHNldHRpbmcgb3IgZGVwbG95bWVudD8gLy9FUlMyMDExMjkgRE9ORSBpbiB6Q2hpbGRGaWVsZHMKICAgIGFsZXJ0KCJFUlMyMDExMjggc2hvdWxkIGJlIGluIGN1c3RvbSBzZXR0aW5ncyB6Q2hpbGRGaWVsZHMiKTsKICAgIHpEYXRhLmNoaWxkU3RhY2tSZWNvcmRUeXBlPSIwMTIxMTAwMDAwMWdCczNBQUUiOyAvL0VSUzIwMTEyOCBzaG91bGQgYmUgaW4gY3VzdG9tIHNldHRpbmdzIHpDaGlsZEZpZWxkcyAiMDEyMFIwMDAwMDFOMm9JIjsKfQoKekRhdGEuY2xpZW50SW1wb3J0U09RTD1mdW5jdGlvbihkb2MsZnJvbUZpbGUpIHsgLy9FUlMxOTA3MDYgY3VzdG9taXplIGltcG9ydHMgdXNlZCBieSBDcmVhdGUgU3RhY2sKICAgIHpEYXRhLmltcG9ydGVyPVhDdXN0b21TZXR0aW5nKGRvYyx6RGF0YS56cCsiSW1wb3J0ZXJfX2MiKS50cmltKCk7CiAgICB2YXIgc2ZJZD0iIjsKICAgIHZhciBwYXJ0cz1mcm9tRmlsZS5zcGxpdCgiXyIpOwogICAgLy9zZklkID0gZ2V0U0ZSZWNvcmRJRChkb2MsICJBY2NvdW50IiwgeyAiRmF4IiA6IHBhcnRzWzNdIH0gKTsKICAgIHpEYXRhLm1ha2VTdGFjaz10cnVlOyAvL2RvIGFsbCB0aGUgd29yayB0aGVyZSBieSBkZWZhdWx0CiAgICByZXR1cm4gc2ZJZDsKfTsKCi8vYWxlcnQoInpEYXRhLmNsaWVudFN0YWNrIik7CnpEYXRhLmNsaWVudFN0YWNrPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzKSB7IC8vekRhdGEgb3IgdGhpcz8KICAgIHZhciB6cD16RGF0YS56cDsgaWYgKCF6cCkgenA9IlpQQVBFUl9fIjsgLy9FUlMxOTA4MDUgCiAgaWYgKHpEYXRhLnJlY2VpdmVkKSBhcnJPZlBhaXJzLnB1c2goInpTdGFja19SZWNlaXZlZF9fYyIsIHpEYXRhLmZvcm1hdE5vdyk7IC8vRVJTMTkwNjE3IFRPRE8gc2F2ZSB3YXkgdG8gZG8gdGhpcwogIGlmICh6RGF0YS5vd25lcklkKSBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLHpEYXRhLm93bmVySWQpOyAgLy8gekNoYXJ0YSBRdWV1ZSAiMDBHMzYwMDAwMDJDeVRLIiAKICBpZiAoekRhdGEuY2FsbGVySWQpIGFyck9mUGFpcnMucHVzaCgiekNhbGxlcl9JRF9fYyIsIGRvYy5kZWxpdmVyZWRGcm9tKTsgLy9NU0gxNzA4MTcgYWRkZWQKICBpZiAoekRhdGEucGF0RW5yb2xsUXVldWVJZCkgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIix6RGF0YS5wYXRFbnJvbGxRdWV1ZUlkKTsKICAKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIiwgekRhdGEuZG9jVHlwZSk7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiLCB6RGF0YS5jbGFzc2lmaWNhdGlvbik7CiAgICB2YXIgcGFnZVJhbmdlID0gWChkb2MsIlhfaWR4UGFnZXMiKTsKICAgIGlmICghcGFnZVJhbmdlKSBwYWdlUmFuZ2U9IjEtIitYKGRvYywiWF9wYWdlcyIpOyAKICAgIHZhciBwYWdlQ291bnQgPSB6RGF0YS5jb3VudFBhZ2VzKGRvYywgcGFnZVJhbmdlKTsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAKICAgIC8vRVJTMTkwODEwIFRPRE8/IGFyck9mUGFpcnMucHVzaCgiWlNUQUNLX19SZWNlaXZlZF9fYyIsIHpEYXRhLmZvcm1hdE5vdyk7CiAgICBhbGVydCgiRVJTMjAwMjEzLjUxIHBhZ2VSYWdlPSIrcGFnZVJhbmdlICsgIiBidXQgcGFnZUNvdW50PSIrcGFnZUNvdW50KTsgLy9FUlMyMDAyMTMgYWxzbyBjYWxsZWQgaW4gbmV3IGluY29taW5nIHN0YWNrCiAgICBpZiAoIVgoZG9jLCJYX2lkeFBhZ2VzIikpIHBhZ2VDb3VudD1YKGRvYywiWF9wYWdlcyIpOyAvL0VSUzIwMDIxMyBUT0RPIGZpeCB6RGF0YS5jb3VudFBhZ2VzKCkKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYWdlc19fYyIsIHBhZ2VDb3VudCk7CiAgICAKICAgIC8vRVJTMjAwMjA0IFRPRE8gelN0YWNrLlByb2dyYW0/CgogICAgaWYgKHpEYXRhLnByb2dyYW1OYW1lID09PSB6RGF0YS5QUk9HUkFNX1pDSEFSVEEpIHsgLy9KUEIyMDEwMjMgY2hhbmdlZCBmcm9tIGNsYXNzaWZpY2F0aW9uIHRvIHByb2dyYW1OYW1lCiAgICAgIGFyck9mUGFpcnMucHVzaCh6cCsiUHJpb3JpdHlfX2MiLCAiVXJnZW50Iik7IC8vSlBCMTkwNDI2IGNoYW5nZWQgdG8gY2xhc3NpZmljYXRpb24gZnJvbSBwcm9ncmFtCiAgICB9IGVsc2UgaWYgKHpEYXRhLnByb2dyYW1OYW1lID09PSB6RGF0YS5QUk9HUkFNX1pQQVBZUlVTKSB7IC8vSlBCMjAxMDIzIGNoYW5nZWQgZnJvbSBjbGFzc2lmaWNhdGlvbiB0byBwcm9ncmFtTmFtZQogICAgICBhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIkhpZ2giKTsgCiAgICB9IGVsc2UgaWYgKHpEYXRhLnByb2dyYW1OYW1lID09PSB6RGF0YS5QUk9HUkFNX1pDQVJUQSkgeyAvL0pQQjIwMTAyMyBjaGFuZ2VkIGZyb20gY2xhc3NpZmljYXRpb24gdG8gcHJvZ3JhbU5hbWUKICAgICAgYXJyT2ZQYWlycy5wdXNoKHpwKyJQcmlvcml0eV9fYyIsICJDcml0aWNhbCIpOyAgCiAgICB9IGVsc2UgewogICAgICBhcnJPZlBhaXJzLnB1c2goenArIlByaW9yaXR5X19jIiwgIk5vcm1hbCIpOwogICAgfQogICAgCiAgICBhcnJPZlBhaXJzLnB1c2goenArInNlbnRGYXhUb19fYyIsICgiQ29tbXVuaXR5IiA9PT0gekRhdGEuY2hhbm5lbCA/IHpEYXRhLmNoYW5uZWwgOiBkb2MuZGVsaXZlcmVkVG8pKTsgLy9KUEIxOTA1MjkgYWRkZWQgc28gQ29tbXVuaXR5IHNob3dzIHVwIGluIE1hc3RlciBJbnRha2UgTGlzdAogICAgYXJyT2ZQYWlycy5wdXNoKHpwKyJGcm9tX19jIixkb2MuZGVsaXZlcmVkRnJvbSk7CiAgICBpZiAoekRhdGEucmV2aWV3ZWRTdGF0dXMpIHthcnJPZlBhaXJzLnB1c2goenArIlN0YWdlX19jIiwgekRhdGEucmV2aWV3ZWRTdGF0dXMpOyB9IAogICAgZWxzZSB7IGFyck9mUGFpcnMucHVzaCh6cCsiU3RhZ2VfX2MiLCAiUmVjZWl2ZWQiKTsgfQogICAgekRhdGEuc3RhY2tQYWlycz1hcnJPZlBhaXJzOyAvL0VSUzE5MDgxMCAjNjE1NzAgZm9yIGNoaWxkIHN0YWNrIGxhdGVyCiAgICBhcnJPZlBhaXJzPXpEYXRhLmNsaWVudEZpZWxkcyhkb2MsYXJyT2ZQYWlycyxYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9felN0YWNrRmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiAKICByZXR1cm4gYXJyT2ZQYWlyczsKfTsKCi8vYWxlcnQoInpEYXRhLmNsaWVudEZpbGUiKTsKekRhdGEuY2xpZW50RmlsZT1mdW5jdGlvbihkb2Msc3RhZ2UpIHsgLy9FUlMxNzA4MjkgIzQxMjk4IHJldHVybnMgYSBsYWJlbCB0byBiZSB1c2VkIGluIGFueSBhdHRhY2hlcyBhbmQgZml4ZXMgdGhlIGRvYwogICAgLy9Eb2N1bWVudCBhdHRhY2htZW50IGxhYmVsIHNob3VsZCBiZSAiUGF0aWVudCBOYW1lIC0gRG9jIFR5cGUgLSBEYXRlIi4gIENvbmZpcm1lZCBmb3IgelBhcGVyIEZpbGUgYW5kIFNGREMgQXR0YWNobWVudAogICAgdmFyIE1NZGRZWVlZID0gekRhdGEuZm9ybWF0VG9kYXlNTWRkWVlZWSgpOwogICAgLy9DUk4yMDEwMjUgIzc2Nzg4IEZpeGVkIHRvIG1hdGNoIHRoZSBjdXJyZW50IGRlbW8uCiAgICB2YXIgcGF0aWVudE5hbWUgPSBYKGRvYywiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19yLk5hbWUiKTsKICAgIGlmICghcGF0aWVudE5hbWUpIHsKICAgICAgICBwYXRpZW50TmFtZSA9IFgoZG9jLCJYX1pQQVBFUl9fRmlyc3ROYW1lX19jIikgKyAiICIgKyBYKGRvYywgIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOwogICAgfQogICAgdmFyIGZheFR5cGUgPSBrZXl3b3JkTWFwW1goZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpXTsKICAgIGlmICghZmF4VHlwZSkgeyBmYXhUeXBlID0gWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIik7IH0KICAgIGlmICghZmF4VHlwZS5pbmRleE9mKCc6JykgPj0gMCkgeyBmYXhUeXBlID0gZmF4VHlwZS5zcGxpdCgnOicpWzFdOyB9CiAgICAvLyBkb2MubGFiZWwgPSBwYXRpZW50TmFtZSArICIgLSAiICsgZmF4VHlwZSArICIgLSAiICsgTU1kZFlZWVk7CiAgICBkb2MubGFiZWwgPSBwYXRpZW50TmFtZSArICIgLSAiICsgZmF4VHlwZTsKICAgIGlmICghcGF0aWVudE5hbWUgfHwgcGF0aWVudE5hbWUubGVuZ3RoPDUpIHsgLy9FUlMyMDExMjkgIzc4ODMwCiAgICAgICAgZG9jLmxhYmVsPSJTcGxpdCBmcm9tICIrWChkb2MsIlhfc3BsaXRQYWdlcyIpKyIgb2YgIisgWChkb2MsIlhfZnJvbVBhZ2VzIikgKyIgLSAiK01NZGRZWVlZOwogICAgICAgIGRvYy5sYWJlbD0iU3BsaXQgZnJvbSAiKyBYKGRvYywiWF9mcm9tUGFnZXMiKSArIiAtICIrTU1kZFlZWVk7IAogICAgfSAKICAgIGFsZXJ0KCJFUlMxNzA4MjkgZGJJRD0iK2RvYy5kYklEKyIgbGFiZWw9Iitkb2MubGFiZWwpOwogICAgaWYgKHpEYXRhLnNmSUQgICYmIHpEYXRhLnNmSUQuaW5kZXhPZigiNTAwIik9PT0wKSB7CiAgICAgIHpEYXRhLnByb3ZpZGVyID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkFjY291bnQuTmFtZSIsIG51bGwsIHpEYXRhLnNmSUQpOyAKICAgICAgbGFiZWwgPSAiUmVjZWl2ZWQgZnJvbSAiICsgekRhdGEucHJvdmlkZXI7CiAgICAgICAgaWYgKHpEYXRhLmZhY2lsaXR5KSB7CiAgICAgICAgICAgIHpEYXRhLmZhY2lsaXR5ID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkFjY291bnQuRmFjaWxpdHlfX3IuTmFtZSIsIG51bGwsIHpEYXRhLnNmSUQpOwogICAgICAgICAgICBkb2MubGFiZWwrPSIgYXQgIit6RGF0YS5mYWNpbGl0eTsKICAgICAgICB9CiAgfQogIHZhciBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgZG9jLmxhYmVsKTsKICB1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7CiAgICByZXR1cm4gZG9jLmxhYmVsOwp9OwoKekRhdGEuY2xpZW50VmFsdWU9ZnVuY3Rpb24oZG9jLHZhbCkgey8vRVJTMTkwODAzICM1MjY2MSB1c2luZyBKU09OIAogICAgdmFsPXZhbC5yZXBsYWNlKCJ7IWZvcm1hdE5vd30iLHpEYXRhLmZvcm1hdE5vdyk7CiAgICByZXR1cm4gdmFsOwp9Cgp6RGF0YS5jbGllbnRGaWVsZHM9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsamQsemQpIHsgLy9FUlMxOTA4MDMgIzUyNjYxIHVzaW5nIEpTT04gaW4gc2V0dGluZyB0byBjb25maWd1cmUgbmV3IHJlY29yZAogICAgaWYgKCF6ZCkgemQ9ekRhdGE7CiAgaWYgKGpkICYmIGpkLmluZGV4T2YoInsiKT09PTApIHsgCiAgICAgIC8veyJUeXBlIjoiRWxpZ2liaWxpdHkiLCJPd25lcklkIjoiMDBHYzAwMDAwMDN2Z3F3IiwiUmVjb3JkVHlwZUlkIjoiMDEyNkEwMDAwMDBKRUtlUUFPIn07CiAgICAgIC8vTk9UIEEgR09PRCBJREVBIGpkPWpkLnJlcGxhY2VBbGwoIlwiIiwiJyIpOyAvL0VSUzE5MDgxMSAjNjE1NzAgSEFDSz8KICAgICAgamQ9amQucmVwbGFjZSgifTsiLCJ9Iik7IC8vRVJTMjAxMTI5IFNIUiB0byB3b3JrIG91dCBkZXNpZ24gb24gY2hhbm5lbCB3aXphcmQgZm9yIHpTdGFjayBjaGlsZCBzZXQgQVNBUAogICAgICB0cnkgewogICAgICAgICAgdmFyIGpkYXRhPUpTT04ucGFyc2UoamQpOyAvL0VSUzE5MDgwNSBiZXR0ZXIgdGhhbiBldmFsCiAgICAgICAgICBmb3IgKHZhciBuIGluIGpkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIHYwPWpkYXRhW25dOyAKICAgICAgICAgICAgICB2YXIgdj16RGF0YS5jbGllbnRWYWx1ZShkb2MsdjApOyAvL0VSUzE5MDgxMSAsdiBub3cgLHYwCiAgICAgICAgICAgICAgYWxlcnQoIkVSUzE5MDgwMy45NyAiK24rIj0iK3YwKyI9Iit2KTsgCiAgICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKG4sdik7IC8vRVJTMTkwODExIGFkZGVkIC5wdXNoCiAgICAgICAgICAgICAgemRbbl09djsgLy9FUlMyMDExMjkgIzc4ODMwIFRPRE8gcmV2aWV3IGFyck9mUGFpcnMgYWNjZXNzIHVzaW5nIGZvciBSZWNvcmRUeXBlSWQKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgYWxlcnQoIkpTT04gbm90IGluICIramQrIiBFeGNlcHRpb246ICIrZSk7IC8vRVJTMTkwODExIGFkZGVkIGUKICAgICAgfQogIH0KICByZXR1cm4gYXJyT2ZQYWlyczsKfQoKCnpEYXRhLmNsaWVudENhc2U9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMsbGFiZWwsemQpIHsKICBpZiAoIXpkKSB6ZD16RGF0YTsKICBpZiAoIXpkLnRyaWFnZVR5cGUgJiYgWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIikpIHpkLnRyaWFnZVR5cGU9WChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIik7IC8vRVJTMjAwMzA4CiAgaWYgKCFsYWJlbCkgeyBsYWJlbD0iSW5kZXhlZC0iICsgIi0iICsgemQudHJpYWdlVHlwZSArICItIiArIHpkLnN0YWNrSWQ7fQogIAogIGFsZXJ0KCJFUlMyMDAzMDguMTI4IG5ldyBDYXNlIHByb3ZpZGVySWQ9Iit6ZC5wcm92aWRlcklkKyIgcGF0aWVudElkPSIremQucGF0aWVudElkKTsKICAKICAvL0VSUzE3MDUyMCBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCBxdWV1ZXNNYXBLbHVkZ2VbWChkb2MsIlhfQXNzaWduX3RvX1F1ZXVlX19jIildKTsKICBpZiAoemQuY29udGFjdElkKSBhcnJPZlBhaXJzLnB1c2goIkNvbnRhY3RJZCIsIHpkLmNvbnRhY3RJZCk7CiAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX25ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiAgYXJyT2ZQYWlycy5wdXNoKCJTdGF0dXMiLCBYKGRvYywiWF9TdGF0dXMiKSk7CiAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLHpkLnRyaWFnZVR5cGUpOyAvL0VSUzIwMDMwOAogIC8vRVJTMjAwMjA1IGFyck9mUGFpcnMucHVzaCgiVHlwZSIsICJOZXcgIit6ZC5jbGFzc2lmaWNhdGlvbik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICAvL0VSUzIwMDMwOCBhcnJPZlBhaXJzLnB1c2goIlR5cGUiLCAiTmV3ICIremQuZG9jVHlwZSk7CiAgaWYgKDE9PTEpIHsgLy9FUlMxNzA1MjMgIzM3MTYyIGFmdGVyIGRyeXJ1bgogICAgICBhbGVydCgiQEBAIHpkLnByaW9yaXR5ID0+ICoiICsgemQucHJpb3JpdHkgKyAiKiIpOwogICAgLy9hcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIjAxMlEwMDAwMDAwNUFoaiIpOyAvL0VSUzE3MDUyMyBQcmlvciBBdXRoCiAgICBpZiAoemQucHJpb3JpdHkgIT0gIk5vcm1hbCIpIHsgYXJyT2ZQYWlycy5wdXNoKCJQcmlvcml0eSIsemQucHJpb3JpdHkpOyB9ICAvL0VSUzE3MDUyNCAjMzcxNjIgcHJpb3JpdHkgb24gQ2FzZQogICAgZWxzZSB7IGFyck9mUGFpcnMucHVzaCgiUHJpb3JpdHkiLCJNZWRpdW0iKTsgfQogICAgYXJyT2ZQYWlycy5wdXNoKCJPcmlnaW4iLCJGYXgiKTsgLy9FUlNhMjAwMjA1IHJyT2ZQYWlycy5wdXNoKCJPcmlnaW4iLHpkLmNoYW5uZWwpOwogIH0KICAgIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19DYXNlRmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTgogICAgCiAgICBhbGVydCgiRVJTMjAwMzA4LjE0MyBuZXcgQ2FzZSBwcm92aWRlcklkPSIremQucHJvdmlkZXJJZCsiIHBhdGllbnRJZD0iK3pkLnBhdGllbnRJZCk7CiAgICBpZiAoemQucHJvdmlkZXJJZCAmJiB6ZC5wcm92aWRlcklkLmluZGV4T2YoIjAwMSIpPT0wKSB7IGFyck9mUGFpcnMucHVzaCgiQWNjb3VudElkIiwgemQucHJvdmlkZXJJZCk7IH0gLy9FUlMyMDAzMDgKICAgIGlmICh6ZC5wcm92aWRlcklkICYmIHpkLnByb3ZpZGVySWQuaW5kZXhPZigiMDAzIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCB6ZC5wcm92aWRlcklkKTsgfSAvL0VSUzIwMDMwOAogICAgaWYgKHpkLnBhdGllbnRJZCAmJiB6ZC5wYXRpZW50SWQuaW5kZXhPZigiMDAxIik9PTApIHsgYXJyT2ZQYWlycy5wdXNoKCJBY2NvdW50SWQiLCB6ZC5wYXRpZW50SWQpOyB9IC8vRVJTMjAwMzA4CiAgICBpZiAoemQucGF0aWVudElkICYmIHpkLnBhdGllbnRJZC5pbmRleE9mKCIwMDMiKT09MCkgeyBhcnJPZlBhaXJzLnB1c2goIkNvbnRhY3RJZCIsIHpkLnBhdGllbnRJZCk7IH0gLy9FUlMyMDAzMDgKICAgIGlmICh6ZC56Y2hhbm5lbC5vd25lcikgeyBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS56Y2hhbm5lbC5vd25lcik7IH0gLy9FUlMyMDAzMDgKICAgIAogIHZhciBjYXNlSWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCAiQ2FzZSIsIGxhYmVsLCBhcnJPZlBhaXJzKTsKICByZXR1cm4gY2FzZUlkOwp9OwoKekRhdGEuY2xpZW50UGF0aWVudD1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxsYWJlbCx6ZCkgewogIGlmICghemQpIHpkPXpEYXRhOwogIGlmICghbGFiZWwpIHsgbGFiZWw9emQuc3RhZ2UgKyAiLSIgKyB6ZC50cmlhZ2VUeXBlICsgIi0iICsgemQuc3RhY2tJZDt9CiAgaWYgKHpkLnBhdGllbnRJZCkgeyAvL0VSUzIwMDIwNSAjNjg4MjUgUHJvZ3JhbSBNZW1iZXJzCiAgICAgIGFsZXJ0KCJQYXRpZW50IGFscmVhZHkgZXhpc3RzIGluICIremQucGF0aWVudElkKTsKICAgICAgcmV0dXJuIHpkLnBhdGllbnRJZDsgLy9UT09EIGdldCBmcm9tIFhfcGF0aWVudElkICA/Pz8/CiAgfQogIC8vRVJTMTcwNTIwIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHF1ZXVlc01hcEtsdWRnZVtYKGRvYywiWF9Bc3NpZ25fdG9fUXVldWVfX2MiKV0pOwogIHZhciBwPSJaUEFQRVJfXyI7IC8vRVJTMjAwMjAyIGFzc3VtZSB3b3JrZmxvdyBvbiByZWxhdGVkIHJlY29yZCB0eXBlcwogIGlmICh6RGF0YS5wYXRpZW50VHlwZS5pbmRleE9mKCJfX2MiKSA+IC0xKSB7IHA9IiI7IH0gLy9FUlMyMDAyMDMgdHlwbwogIGlmICgxPT0wKSB7IC8vRVJTMjAwMjAyIHNlZSBpZiB3b3JrZmxvdyBlbmFibGVkCiAgICAgIGFyck9mUGFpcnMucHVzaChwKyJuZXdGYXhfX2MiLCAidHJ1ZSIpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiAgICAgIGFyck9mUGFpcnMucHVzaChwKyJsYXRlc3RGYXhfX2MiLCB6ZC5mb3JtYXROb3cpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiAgICAgIGFyck9mUGFpcnMucHVzaChwKyJyZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOyAvL0VSUzE5MDgxNCAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiAgfQoKICAgIHZhciBydD1YQ3VzdG9tU2V0dGluZyhkb2MsIlBhdGllbnRSZWNvcmRUeXBlX19jIik7IC8vVE9ETyBpbnRvIE1QIEVSUzE5MDgwMiBsaWtlIDAxMjZBMDAwMDAwSkU4eVFBRyBvciBlbXB0eSB0byB1c2UgZGVmYXVsdAogICAgLy9pZiAocnQpIHsgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCBydCk7IH0gLy9FUlMxOTA4MDMKICAgIC8vVE9ETyBDb250YWN0IG9yIEFjY291bnQgRVJTMTkwNjI0IERPTkUhISBFUlMxOTA4MDIKICAgIGFyck9mUGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxhcnJPZlBhaXJzLFhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19QYXRpZW50RmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiAKICAgIGFyck9mUGFpcnM9W107IC8vRVJTMjAwMjA0IHRlc3RpbmcgdG8gZ2V0IGl0IGdvaW5nCiAgICAKICAgIC8vRVJTMjAwMjAyIG5lZWQgdG8gbWFrZSB0aGUgQWNjb3VudCB3aXRoIFBhdGllbnQgcmVjb3JkVHlwZSBmaXJzdAogICAgLy8wMTI0NjAwMDAwME5HRllBQTQgaXMgLnpwYXBlciBmb3IgUGF0aWVudAogICAgdmFyIGFyID0gW107CiAgICBpZiAocnQpIHsgYXIucHVzaCgiUmVjb3JkVHlwZUlkIiwgcnQpOyB9IC8vRVJTMTkwODAzIC8vRVJTMjAwMjIyICM2OTE0OSBtb3ZlZCBkb3duIGFuZCBhZGRlZCBlbHNlIAogICAgZWxzZSBhci5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTI0NjAwMDAwME5HRllBQTQiKTsKICAgIGFyLnB1c2goIkZpcnN0TmFtZSIsekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7CiAgICBhci5wdXNoKCJMYXN0TmFtZSIsekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsKICAgIHZhciBwYXRpZW50TmFtZT16RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MrIiwgIit6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jOwogICAgaWYgKHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpIGFyLnB1c2goIlBlcnNvbkJpcnRoRGF0ZSIsekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyk7CiAgICB2YXIgYUlkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiQWNjb3VudCIsIG51bGwsIGFyKTsgLy9FUlMyMDAyMDQgcGVyc29uIGFjY291bnQgc28gZG8gbm90IHNldCBwYXRpZW50TmFtZQogICAgCiAgICBpZiAoYUlkICYmIGFJZCAhPSAiTkVXIiAmJiBhSWQuaW5kZXhPZigiRVJST1IiKT09LTEpIHsKICAgICAgICB2YXIgc2ZJZCA9ICIiOwogICAgICAKICAgICAgLy9FUlMxOTA4MDMgc3BlY2lmaWMgdG8gY2xpZW50IGRhdGEgZW50cnkKICAgICAgdmFyIGRxID0gekRhdGEuZHE7CiAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQZXJzb25fQWNjb3VudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBzZklkICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1BlcnNvbl9BY2NvdW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArICIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArIGRxICsgIik7ICIpOwogICAgfQogICAgcmV0dXJuIHsnRVJST1InOiAncGF0aWVudCBub3QgY3JlYXRlZCd9Cn07Cgp6RGF0YS5jbGllbnRBY2NvdW50PWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7CiAgaWYgKCF6ZCkgemQ9ekRhdGE7CiAgaWYgKCFsYWJlbCkgeyBsYWJlbD16ZC5zdGFnZSArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KICAvL0VSUzE3MDUyMCBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCBxdWV1ZXNNYXBLbHVkZ2VbWChkb2MsIlhfQXNzaWduX3RvX1F1ZXVlX19jIildKTsKICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbmV3RmF4X19jIiwgInRydWUiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19sYXRlc3RGYXhfX2MiLCB6ZC5mb3JtYXROb3cpOyAvL0pQQiAxNzA1MTIgYWRkZWQgdGhlc2Ugd29ya2Zsb3cgZmllbGRzCiAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX3JlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7IC8vRVJTMTkwODE0IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKCiAgdmFyIGFjY291bnRJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJBY2NvdW50IiwgbGFiZWwsIGFyck9mUGFpcnMpOwogIHJldHVybiBhY2NvdW50SWQ7Cn07Cgp6RGF0YS5jbGllbnRSZWNvcmQ9ZnVuY3Rpb24oZG9jLHNmVHlwZSxhcnJPZlBhaXJzLGxhYmVsLHpkKSB7IC8vRVJTMTkwNjIwIGNsaWVudFJlY29yZCBnZW5lcmljCiAgaWYgKCF6ZCkgemQ9ekRhdGE7CiAgaWYgKCFsYWJlbCkgeyBsYWJlbD16ZC5zdGFnZSArICItIiArIHpkLnRyaWFnZVR5cGUgKyAiLSIgKyB6ZC5zdGFja0lkO30KICAvL0VSUzE3MDUyMCBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCBxdWV1ZXNNYXBLbHVkZ2VbWChkb2MsIlhfQXNzaWduX3RvX1F1ZXVlX19jIildKTsKICB2YXIgenA9IiI7CiAgaWYgKCIsQ2FzZSxDb250YWN0LEFjY291bnQsTGVhZCxPcHBvcnR1bml0eSxaUEFQRVJfX3pTdGFja19fYywiLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiLCIrc2ZUeXBlLnRvTG93ZXJDYXNlKCkrIiwiKT4tMSkgenA9ekRhdGEuenA7CiAgLy9vbmx5IGRvIHRoaXMgaWYgdGhlIGZpZWxkcyBleGlzdAogIGFyck9mUGFpcnMucHVzaCh6cCsibmV3RmF4X19jIiwgInRydWUiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIGFyck9mUGFpcnMucHVzaCh6cCsibGF0ZXN0RmF4X19jIiwgemQuZm9ybWF0Tm93KTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIGFyck9mUGFpcnMucHVzaCh6cCsicmVjZWl2ZWRJZF9fYyIsICJkb2MuZGJJRC5SZWMiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogIAogIC8vVE9ETyBwdXQgY2xpZW50IHNwZWNpZmljIGRhdGEgdXBkYXRlcyBoZXJlCgogIHZhciBuZXdJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsIHNmVHlwZSwgbGFiZWwsIGFyck9mUGFpcnMpOwogIHJldHVybiBuZXdJZDsKfTsKCnpEYXRhLmNsaWVudENvbXBsZXRlPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLHpkKSB7cmV0dXJuIGFyck9mUGFpcnM7fTsgLy9FUlMxOTA2MjUKekRhdGEuY2xpZW50RGVsaXZlcnk9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMpIHsgLy9FUlMyMDAyMDIgVE9ETyBjb25zaWRlciBuZXcgRG9jdW1lbnRfTVZOCiAgICByZXR1cm4gYXJyT2ZQYWlyczsKfTsgLy9FUlMxOTA3MTEgIzYwOTAwIFBBT1MKCnpEYXRhLmNsaWVudENoaWxkU3RhY2s9ZnVuY3Rpb24oZG9jLGFyck9mUGFpcnMscGFyZW50SWQpIHsgLy9FUlMxOTA4MTAgIzYxNTcwIGJlIHN1cmUgdG8gY2FsbCBvbiBuZXcgY2hpbGQgZG9jCiAgICB2YXIgcGFpcnM9YXJyT2ZQYWlyczsKICAgIC8vbm8gbWVtb3J5IG9mIHN0YWNrIGNyZWF0aW9uIHZhciBwYWlycz16RGF0YS5zdGFja1BhaXJzOwogICAgLy9DUk4yMDEwMjYgIzc2Nzg4IFdlIG5lZWQgcmV2aWV3ZWRTdGF0dXMgdG8gYmUgIkluZGV4ZWQiIGZvciB0aGUgaW5kZXggcnVsZSwgc28gb25seSBzZXQgdGhlIGZpZWxkIGlmIGl0IGlzbid0IGFscmVhZHkgc2V0LgogICAgaWYgKCF6RGF0YS5yZXZpZXdlZFN0YXR1cykgeyB6RGF0YS5yZXZpZXdlZFN0YXR1cz0iU3BsaXQiOyB9CiAgICAvL0VSUzE5MDgxMCBUT0RPPyBwYWlycy5wdXNoKCJaUEFQRVJfX1N0YXR1c19fYyIsICJDaGlsZCBTdGFjayIpOwoKICAgIHBhaXJzPXpEYXRhLmNsaWVudFN0YWNrKGRvYyxwYWlycyk7CiAgICBpZiAoWEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX3pDaGlsZEZpZWxkc19fYyIpKSB7IC8vRVJTMTkwODExIG5vdCBpbiBhbGwgTVBzCiAgICAgICAgcGFpcnM9ekRhdGEuY2xpZW50RmllbGRzKGRvYyxwYWlycyxYQ3VzdG9tU2V0dGluZyhkb2MsIlpQQVBFUl9fekNoaWxkRmllbGRzX19jIikpOyAvL0VSUzE5MDgwMyAjNTI2NjEgdXNpbmcgSlNPTiBjaGlsZCByZWNvcmQgdHlwZSBpZAogICAgfQogICAgcGFpcnMucHVzaCgiWlBBUEVSX19QYXJlbnRfX2MiLCBwYXJlbnRJZCk7CiAgICAvL0VSUzIwMTEyOCBzaG91bGQgYmUgaW4gekNoaWxkRmllbGRzIGlmICh6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSkgcGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIix6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSk7CiAgICAKICAgIC8vcGFpcnMucHVzaCgiIisiUHJvZ3JhbV9fYyIsekRhdGEucHJvZ3JhbU5hbWUpOyAvL0VSUzIwMDIwNSBUT0RPIGluIHBhY2thZ2UgYW5kIGludG8gYmFzZSBjYWxsCiAgICBwYWlycy5wdXNoKCJaUEFQRVJfX1Byb2dyYW1fX2MiLHpEYXRhLnByb2dyYW1OYW1lKTsKICAgIC8vRVJTMjAwMjI5IGlmICh6RGF0YS5wYXRpZW50SWQpIHBhaXJzLnB1c2goIlByb2dyYW1fTWVtYmVyX01WTl9fYyIsekRhdGEucGF0aWVudElkKTsgLy9FUlMyMDAyMDUgUHJvZ3JhbV9NZW1iZXJfTVZOX19jIHdhcyB0aGUgVElDS0VUISEhCiAgICBhbGVydCgiRVJTMTkwODExLjE5MSBaUEFQRVJfX1BhcmVudF9fYyIrIHBhcmVudElkKyIgY2hpbGQgekRhdGEuY2hpbGRTdGFja1JlY29yZFR5cGU9Iit6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZSk7CiAgICBpZiAoekRhdGFbJ1JlY29yZFR5cGVJZCddKSB7ICB6RGF0YS5jaGlsZFN0YWNrUmVjb3JkVHlwZT16RGF0YVsnUmVjb3JkVHlwZUlkJ107IH0gLy9FUlMyMDExMjkgIzc4ODMwIFRPRE8gbm90IHN1cmUgd2hlcmUgdGhpcyBpcyB1c2VkIGVsc2V3aGVyZQogICAgYWxlcnQoIkVSUzIwMTEyOS4yOTIgWlBBUEVSX19QYXJlbnRfX2MiKyBwYXJlbnRJZCsiIGNoaWxkIFJlY29yZFR5cGVJZD0iK3pEYXRhWydSZWNvcmRUeXBlSWQnXSk7CiAgICBhbGVydCgidGVzdGluZyBwYWlycyBiZWZvcmUgY3JlYXRlYW5kYXR0YWNoIDogIiArIHBhaXJzKTsKICAgIHZhciBjaGlsZFN0YWNrU0ZJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJaUEFQRVJfX3pTdGFja19fYyIsICJ6U3RhY2sgc3BsaXQgb24gIiArIHpEYXRhLmZvcm1hdE5vdywgcGFpcnMpICsgIiI7CiAgICAKICAgIGlmICghekRhdGEucGF0aWVudElkICYmIFgoZG9jLCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiKSApeyAvL0VSUzIwMDMwOCBIQUNLCiAgICAgICAgekRhdGEucGF0aWVudElkPVgoZG9jLCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiKTsKICAgICAgICBhbGVydCgiRVJTMjAwMzA4IFdIWSBOT1QgaW4gekRhdGE/Iik7CiAgICB9CiAgICAvKgogICAgLy9jb21tZW50ZWQgYXMgVGltZWxpbmUgaXMgbm90IGluIHVzZQogICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgeyAvL0VSUzIwMDMwOCBjcmVhdGUgYW4gQWN0aXZpdHkgRXZlbnQgcmVsYXRlZCB0byB0aGUgUGF0aWVudCAoQWNjb3VudCkgZm9yIHRoZSBUaW1lbGluZQogICAgICAgIGlmICghekRhdGEuZG9jVHlwZSAmJiBYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKSkgekRhdGEuZG9jVHlwZT1YKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKTsKICAgICAgICB2YXIgYXJyPVtdOwogICAgICAgIC8vTk9UIFNFTEVDVCBBY2NvdW50SWQsQWN0aXZpdHlEYXRlLENyZWF0ZWREYXRlLFN0YXR1cyxTdWJqZWN0LFRhc2tTdWJ0eXBlLFdoYXRJZCxXaG9JZCBGUk9NIFRhc2sgd2hlcmUgQWN0aXZpdHlEYXRlID4gMjAyMC0wMi0wMQogICAgICAgIC8vU0VMRUNUIElkLEFjY291bnRJZCxBY3Rpdml0eURhdGUsQ3JlYXRlZERhdGUsU3ViamVjdCxXaGF0SWQsV2hvSWQgRlJPTSBFdmVudCB3aGVyZSBJZCA9ICcwMFU0VDAwMDAwMnZDaHJVQUUnCiAgICAgICAgLy9hcnIucHVzaCgiV2hvSWQiLHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMjAwMzEwIHRpbWVsaW5lIHRyaWNrCiAgICAgICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMDEiKT09MCkgewogICAgICAgICAgICBhcnIucHVzaCgiV2hhdElkIix6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzIwMDMxMCB0aW1lbGluZSB0cmljawogICAgICAgICAgICAvL2Fyci5wdXNoKCJBY2NvdW50SWQiLHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMjAwMzEwIHRpbWVsaW5lIHRyaWNrCiAgICAgICAgfSBlbHNlIGlmICh6RGF0YS5jYXNlSWQpIGFyci5wdXNoKCJXaGF0SWQiLHpEYXRhLmNhc2VJZCk7CiAgICAgICAgZWxzZSBpZiAoekRhdGEucHJvdmlkZXJJZCkgYXJyLnB1c2goIldoYXRJZCIsekRhdGEucHJvdmlkZXJJZCk7CiAgICAgICAgZWxzZSBhcnIucHVzaCgiV2hhdElkIixjaGlsZFN0YWNrU0ZJZCk7CiAgICAgICAgLy9hcnIucHVzaCgiVGFza1N1YnR5cGUiLCJUYXNrIik7CiAgICAgICAgYXJyLnB1c2goIlN1YmplY3QiLHpEYXRhLnN0YWdlICsgIiAiK3pEYXRhLmRvY1R5cGUpOwogICAgICAgIGFyci5wdXNoKCJEZXNjcmlwdGlvbiIsIkNoZWNrIG91dCAiK2RvYy5kYklEKTsKICAgICAgICAvL2Fyci5wdXNoKCJBY3Rpdml0eURhdGVUaW1lIix6RGF0YS5mb3JtYXROb3cpOyAvL0VSUzIwMDMwOSBoYWNraW5nIGF3YXkhCiAgICAgICAgYXJyLnB1c2goIkFjdGl2aXR5RGF0ZSIsekRhdGEuZm9ybWF0Tm93LnN1YnN0cmluZygwLDEwKSk7CiAgICAgICAgYXJyLnB1c2goIlJlY29yZFR5cGVJZCIsIjAxMjRUMDAwMDAwOGFGbVFBSSIpOyAvL0VSUzIwMDMxMCBIQUNLIGZvciBUYXNrIG9uIENhcmVQbGFuCiAgICAgICAgLy9hcnIucHVzaCgiRHVyYXRpb25Jbk1pbnV0ZXMiLCI1Iik7CiAgICAgICAgLy9hcnIucHVzaCgiU3RhdHVzIiwiQ29tcGxldGVkIik7CiAgICAgICAgCiAgICAgICAgdmFyIGxhYmVsPSJUaW1lbGluZSAiK3pEYXRhLmRvY1R5cGU7CiAgICAgICAgdmFyIGFjdElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiVGFzayIsIG51bGwsIGFycik7IC8vRVJTMjAwMzA5IG51bGwgbWVhbnMgbm8gTmFtZSBmaWVsZAogICAgICAgIC8vdmFyIGFjdElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiRXZlbnQiLCBudWxsLCBhcnIpOyAvL0VSUzIwMDMwOSBudWxsIG1lYW5zIG5vIE5hbWUgZmllbGQKICAgICAgICBhbGVydCgiRVJTMjAwMzA4LjI2MiB0aW1lbGluZSBhY3Rpdml0eSAiK2FjdElkKTsKICAgIH0gZWxzZSB7IGFsZXJ0KCJFUlMyMDAzMDguMjYzIGJlIHdvcnJpZWQgdGhlcmUgaXMgbm8gcGF0aWVudCEiKTsgfQogICAgKi8KICAgIGlmICgxPT09MSAmJiB6RGF0YS5jbGllbnRSZWNlaXZlZERvY3VtZW50KSB7IHpEYXRhLnJlY0RvY0lkPXpEYXRhLmNsaWVudFJlY2VpdmVkRG9jdW1lbnQoZG9jLGNoaWxkU3RhY2tTRklkKTsgfSAvL0VSUzIwMTAxOCAjNzcyNTIKICAgIHJldHVybiBjaGlsZFN0YWNrU0ZJZDsKfTsKCgp6RGF0YS5jbGllbnRTdGFja0NvbXBsZXRlPWZ1bmN0aW9uKGRvYyxhcnJPZlBhaXJzLHpkKSB7IC8vRVJTMjAwMzE0ICM3MDMzNgogICAgaWYgKCF6ZCkgemQ9ekRhdGE7IC8vRVJTMjAwNDA2ICM3MTE1NgogICAgYXJyT2ZQYWlycy5wdXNoKCJUaW1lX0NvbXBsZXRlX0RhdGVfX2MiLHpkLmZvcm1hdE5vdyk7IC8vZm9yIGRhc2hib2FyZAogICAgcmV0dXJuIGFyck9mUGFpcnM7Cn07IC8vRVJTMTkwNjI1Cgp6RGF0YS5jbGllbnRBdHRhY2hQb3B1bGF0ZWZpZWxkcz1mdW5jdGlvbihkb2MsYXJyT2ZQYWlycyxwYXRpZW50SWQscGFyZW50SWQsY2hpbGRJZCl7IC8vW1ZKIC0gcG9wdWxhdGUgZmllbGRzIGFuZCBhdHRhY2ggaW5kZXhlZCBwYWdlcyB0byBsb29rdXBzXQoKICB2YXIgenBhcmVudElkID0gcGFyZW50SWQ7CiAgdmFyIHpjaGlsZElkID0gY2hpbGRJZDsKICB2YXIgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsgLy8iSW5kZXhlZCAiICsgZm9ybWF0Tm93OwogIAogIGlmICgoenBhcmVudElkICYmIHpwYXJlbnRJZC5sZW5ndGggPiAwKSAmJiAoemNoaWxkSWQgJiYgemNoaWxkSWQubGVuZ3RoID4gMCkpIHsKICAgIHZhciBhcnJPZlBhaXJzID0gW107CiAgICAKICAgIGFyck9mUGFpcnMucHVzaCgiRG9jdW1lbnRfUmVjZWl2ZWRfRGF0ZV9fYyIsIHJlY2VpdmVkRGF0ZSk7CiAgICB1cGRhdGVTRlJlY29yZChkb2MsekRhdGEuenBzLCB6Y2hpbGRJZCwgYXJyT2ZQYWlycyk7CiAgfQogIAogIHJldHVybiBudWxsOwp9Cgp6RGF0YS5jbGllbnRMaWdodG5pbmdGaWxlPWZ1bmN0aW9uKGRvYyxzZklkLHpkLGNoaWxkU3RhY2tJZCkgeyAvL3VzZSBpbiBpbmRleCBjbGllbnQgbGlicmFyeQogIAppZiAoIXpkKSB6ZD16RGF0YTsKICAgIGlmICghZG9jLmtiRGF0YS5zZlNlcnZlcikgeyAgIAogICAgLy9FUlMyMDA0MjggSEFDSwogICAgYWxlcnQoImRvYy5rYkRhdGEuc2ZTZXJ2ZXIgd2FzIGVtcHR5LiBJZGVhbGx5IHNob3VsZCBOT1QgY29tZSBoZXJlIik7IGRvYy5rYkRhdGEuc2ZTZXJ2ZXI9InRha2VkYXBhdGllbnRzZXJ2aWNlcy0tdGtkZXYyLmxpZ2h0bmluZy5mb3JjZS5jb20iOyAKICB9CiAgICB2YXIgenNlcnZlciA9IGRvYy5rYkRhdGEuc2ZTZXJ2ZXIuaW5kZXhPZigiaHR0cHM6Ly8iKT09MCA/IGRvYy5rYkRhdGEuc2ZTZXJ2ZXIgOiAiaHR0cHM6Ly8iICsgZG9jLmtiRGF0YS5zZlNlcnZlcjsgCiAgLy8gU2FsZXNmb3JjZSBSRVNUIEFQSSBlbmRwb2ludAogICAgdmFyIGRvY3VybCA9IHpzZXJ2ZXIgKyAiL3NlcnZpY2VzL2RhdGEvdjQ2LjAvc29iamVjdHMvQ29udGVudFZlcnNpb24vIjsKICAgIHZhciBwZGZ1cmwgPSAiaHR0cHM6Ly9ndy56cGFwZXIuY29tL2tiL2pzcC9TRl9maW5kLmxpZ2h0bmluZy5qc3A/Z289U0ZfZmlsZXMuanNwJmRiSUQ9IiArIGRvYy5kYklEICsgIiZTRm9yZz0iICsgZG9jLmtiRGF0YS5zZk9yZ2FuaXphdGlvbklEOwoKICAvLyBHZW5lcmF0ZSBQREYgZmlsZSBmcm9tIHpTdGFjawogICAgdmFyIGZvcm1hdE5vdyA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYyxmYWxzZSx0cnVlKTsgLy8gZS5nLiAiMjAyMTAyMTAtMDUyMTMyIj8KICAgIHZhciBhcnJPZlBhaXJzID0gW107CiAgICB2YXIgbm93VGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiIjsgCiAgICAKICAgIHZhciBmaWxlTmFtZSA9IGdldEN1ckRhdGUoZG9jKSsgIiAiK3pEYXRhLmRvY1R5cGUrIi5wZGYiOyAgLy8gZS5nIC0gIjIwMjEwMjEwIE5ldyBGYXgucGRmIj8KICAgIGFsZXJ0KCJAQEBmaWxlTmFtZSA9ICIrZmlsZU5hbWUpOwogIAogIHpEYXRhLnVwbG9hZERpciA9ICd6U3RhY2tVcGxvYWRSb290JzsgLy9zZXR0aW5nIHJvb3QgZGlyZWN0b3J5IGZvciBmaWxlIGNyZWF0aW9uCiAgCiAgICAvLyBjcmVhdGUgZGlyZWN0b3J5IHRvIHBsYWNlIGdlbmVyYXRlZCBQREYgZmlsZQogICAgY3JlYXRlRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwogICAKICAgIHZhciB4UGFnZXMgPSBYKGRvYywgIlhfcG9zaXRpb24iKTsgLy9nZXQgWF9wb3NpdGlvbiAtIHBhZ2UgcmFuZ2Ugc2VsZWN0ZWQ7IGRlZmF1bHQgPSBhbGwgcGFnZXMKICAgIGFsZXJ0KCJAQEBAQCBDYWxsaW5nIHNwbGl0UERGIHRvIHNwbGl0IG9mZiBwYWdlcyB0byB1cGxvYWQgYXMgUERGLCBwYWdlcyA9ICIgKyB4UGFnZXMgKyAiLCBub3dUaW1lU3RhbXAgPSAiICsgbm93VGltZVN0YW1wKTsKICAgIHZhciByZXNwb25zZSA9IHNwbGl0UERGKGRvYywgeFBhZ2VzLCB6RGF0YS51cGxvYWREaXIsIG5vd1RpbWVTdGFtcCwgZmlsZU5hbWUpOwogICAgYWxlcnQoIkBAQEAgcmVzcG9uc2UgZnJvbSBzcGxpdFBERiA9ICIgKyByZXNwb25zZSk7CiAgICB2YXIgbmV3UERGTmFtZSA9IFgoZG9jLCAibmV3UERGIiwgcmVzcG9uc2UpOyAvLyBzZXQgdmFsdWUgb2YgbmV3UERGCiAgICAKICAgIGFsZXJ0KCJAQEBAIHNwbGl0IFBERiBGaWxlTmFtZSA9ICIgKyBuZXdQREZOYW1lKTsKCiAgLy8gQ2Fubm90IGRpcmVjdGx5IEFwcGVuZCBQREYgZmlsZSB0byBtdWx0aXBhcnQgZm9ybWRhdGEKICAvLyBKUyBkb2VzIG5vdCBhbGxvdyByZWFkaW5nIGEgZmlsZSBmcm9tIHRoZSBmaWxlIHN5c3RlbSAobm9ybWFsbHkgYXBwbGllcyB0byBjbGllbnQgc2lkZSBmb3Igc2VjdXJpdHkgcmVhc29ucykKICAvLyBXZSBkb250IGhhdmUgYSBOb2RlLmpzIGNvbnRhaW5lciwgc28gbm8gbHVjayB0aGVyZS4uIGhhdmUgdG8gZG8gdGhpcyBhbm90aGVyIHdheQogIC8vIEVyaWMgc3VnZ2VzdGVkIHdlIHVzZSB1cGxvYWRUb0Nsb3VkLmpzcCBhcHByb2FjaCB0byBjcmVhdGUgTGlnaHRuaW5nIEZpbGUgKHByb2JhYmx5IENvbnRlbnREb2N1bWVudCkgaW4gU2FsZXNmb3JjZQogIAogICAgLy92YXIgdXBsb2FkVVJMPSJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0ZpZD1ORVcmU0ZwaWQ9IitzZklkKyImU0Zvcmc9Iitkb2Muc2ZPcmcrIiZsYWJlbD0iK2ZpbGVOYW1lKyImc2VydmVyRmlsZT0iK25ld1BERk5hbWUrIiZEZXNjcmlwdGlvbj1GaWxlIGF0dGFjaGVkIGFzIFBERiI7CiAgLy9BTjIwMjEwOTAzICM4MTc2NiBuZWVkIFNGdHlwZT1Db250ZW50VmVyc2lvbiBwYXJhbWV0ZXIgdG8gdXBsb2FkIGFzIExpZ2h0bmluZyBGaWxlCiAgdmFyIHVwbG9hZFVSTD0iaHR0cDovL2xvY2FsaG9zdDo4MDgwL215ZmlsZWZvcmNlL3VwbG9hZFRvQ2xvdWQuanNwP1NGdHlwZT1Db250ZW50VmVyc2lvbiZTRmlkPU5FVyZTRnBpZD0iK3NmSWQrIiZTRm9yZz0iK2RvYy5zZk9yZysiJmxhYmVsPSIrZmlsZU5hbWUrIiZzZXJ2ZXJGaWxlPSIrbmV3UERGTmFtZSsiJkRlc2NyaXB0aW9uPUZpbGUgYXR0YWNoZWQgYXMgUERGIjsKICAKICAgIGFsZXJ0KCIjIyMjIFVwbG9hZCBuYXRpdmUgUERGIHdpdGggIit1cGxvYWRVUkwpOwogIAogICAgdmFyIHI9d2dldChkb2MsIHVwbG9hZFVSTCk7IC8vID8/Pz8/IHdpbGwgciBjb250YWluIHRoZSBDb250ZW50RG9jdW1lbnQgaWQ/CiAgCiAgYWxlcnQoJ3ZhbHVlIGZyb20gd2dldCByZXNwb25zZSA+Pj4gJytyKTsKICAgIAogICAgdmFyIGlkeEJlZ2luID0gci5pbmRleE9mKCI8c2ZJRD4iKTsKICAgIHZhciBpZHhFbmQgPSByLmluZGV4T2YoIjwvc2ZJRD4iKTsKICAgIHZhciBzZmRvY0lkOwogIGlmKGlkeEVuZCA+IGlkeEJlZ2luKSB7CiAgICBzZmRvY0lkID0gci5zdWJzdHJpbmcoaWR4QmVnaW4rNixpZHhFbmQpOwogICAgYWxlcnQoInNmRG9jSWQgZXh0cmFjdGVkIGZyb20gciA6ICIgKyBzZmRvY0lkKTsKICB9CiAgCiAgICAvLyBGaW5hbGx5LCBkZWxldGUgdGhlIGZvbGRlciBhbmQgYWxsIGNvbnRlbnRzLgogICAgY2xlYW51cERpcmVjdG9yeShkb2MsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wKTsKCiAgLy9HZXQgdGhlIGNvbnRlbnRWZXJzaW9uIHJlY29yZCBvZiB0aGUgYXR0YWNobWVudAogIHZhciBjb25WSWQgPSBnZXRTRkZpZWxkKGRvYywgIkNvbnRlbnRWZXJzaW9uIiwgIklkIiwnQ29udGVudERvY3VtZW50SWQ9XCcnK3NmZG9jSWQrJ1wnJyxudWxsKTsKICAKICAvL3pTdGFja19fYyxUS19Eb2N1bWVudF9EYXRlX19jCiAgICB2YXIgYXJyT2ZQYWlycyA9IFtdOwogIGFyck9mUGFpcnMucHVzaCgielN0YWNrX19jIiwgY2hpbGRTdGFja0lkKTsgCiAgdmFyIGRvY1NpZ0RhdGUgPSBYKGRvYywgIlhfRG9jdW1lbnRfU2lnbmF0dXJlX0RhdGVfX2MiKTsgLy9QVjIxMDQwMiAKCWlmKGRvY1NpZ0RhdGUpCglhcnJPZlBhaXJzLnB1c2goIlRLX0RvY3VtZW50X0RhdGVfX2MiLGRvY1NpZ0RhdGUpOwogIC8vYXJyT2ZQYWlycy5wdXNoKCJUS19Eb2N1bWVudF9EYXRlX19jIiwgWChkb2MsICJYX0RvY3VtZW50X1NpZ25hdHVyZV9EYXRlX19jIikpOwogIGFsZXJ0KCJEb2MgdHlwZSAiK3pEYXRhLmRvY1R5cGUpOwogIGlmKHpEYXRhLmRvY1R5cGUgPT0gIkNPTlMiKXsvL1BWMjEwNDAxIHVwZGF0ZWQKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfQ2F0ZWdvcnlfX2MiLCAiQ29uc2VudCIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19TdWJfQ2F0ZWdvcnlfX2MiLCAiUmV2aWV3IENvbnNlbnQgRm9ybSIpOwogIH1lbHNlIGlmKHpEYXRhLmRvY1R5cGUgPT0gIlJFTVMiKXsKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfQ2F0ZWdvcnlfX2MiLCAiUkVNUyIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19TdWJfQ2F0ZWdvcnlfX2MiLCAiUmV2aWV3IFJFTVMgRG9jdW1lbnQiKTsKICB9ZWxzZSBpZih6RGF0YS5kb2NUeXBlID09ICJTVVAiKXsKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfQ2F0ZWdvcnlfX2MiLCAiU1VQIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIlRLX1N1Yl9DYXRlZ29yeV9fYyIsICJSZXZpZXcgU1VQIERvY3VtZW50Iik7CiAgfWVsc2UgaWYoekRhdGEuZG9jVHlwZSA9PSAiQ09ORiIpewogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19DYXRlZ29yeV9fYyIsICJDb25maXJtYXRpb24iKTsKICAgIGFyck9mUGFpcnMucHVzaCgiVEtfU3ViX0NhdGVnb3J5X19jIiwgIlJldmlldyBDb25maXJtYXRpb24iKTsKICB9ZWxzZSBpZih6RGF0YS5kb2NUeXBlID09ICJQRE9DIil7CiAgICBhcnJPZlBhaXJzLnB1c2goIlRLX0NhdGVnb3J5X19jIiwgIlBhdGllbnQgRG9jdW1lbnRzIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIlRLX1N1Yl9DYXRlZ29yeV9fYyIsICJSZXZpZXcgUGF0aWVudCBEb2N1bWVudCIpOwogIH1lbHNlIGlmKHpEYXRhLmRvY1R5cGUgPT0gIk9USCIpewogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19DYXRlZ29yeV9fYyIsICJPdGhlciIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJUS19TdWJfQ2F0ZWdvcnlfX2MiLCAiUmV2aWV3IE90aGVyIERvY3VtZW50Iik7CiAgfQoKICBhbGVydCgic2Z0eXBlIDogIiArIHpEYXRhLnpwcyk7CiAgdXBkYXRlU0ZSZWNvcmQoZG9jLCAnQ29udGVudFZlcnNpb24nLCBjb25WSWQsIGFyck9mUGFpcnMpOwogIAoKICAgIHJldHVybiBudWxsOwp9CgphbGVydCgiZW5kIGNsaWVudCBsaWJyYXJ5Iik7IC8vRVJTMTkwNjE1ICM1ODkyMQ=="},"ordinal":1}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("start client library"); //ERS190803 #52661 from OccFit
//ERS201117 TODO get rid off these keywords and use a document journey wizard from KPS and Jake

//CRN201025 #76788 Moved from zStack Library so that it can be used in multiple rules.
var keywordMap={};
var keywords=["NEW:Document Stack~","ENRL:Enrollment~","ENRL:ENROLLMENT~","CON:Consent~","CON:consent~","FAC:Setting~","FAC:Distribution~","START:Start Form~","CHK:Checklist~","HIPAA:AUTHORIZATION~","HIPAA:HIPAA~","HIPAA:PORTABILITY~","REF:REFERRAL","REF:Referral","FIN:W2~","IC:Member ID~","FAX:"];
//keywordMap["TENR"] ="TENR:Start Form";
keywordMap["NEW"] ="NEW:Document Stack";
keywordMap["ENRL"] ="ENRL:Enrollment Form";
keywordMap["FAC"] ="FAC:Facility Enrollment Form";
keywordMap["FAX"] ="NEW:Document Stack";
//keywordMap["START"] ="NEW:Document Stack";
keywordMap["CON"] ="CON:Consent Form";
keywordMap["HIPAA"] ="HIPAA:HIPAA Authorization";
keywordMap["REF"] ="REF:Referral";
keywordMap["FW2"] ="FW2:W-2"; //JPB201023 added
keywordMap["I9"] ="I9:I-9"; //JPB201023 added
keywordMap["W4"] ="W4:W-4"; //JPB201023 added
keywordMap["DEM"] ="DEM:Demographics"; //CRN201026 added
keywordMap["CLIN"] ="CLIN:Clinical Notes"; //CRN201026 added
keywordMap["FIN"] ="FIN:Financial Info"; //CRN201026 added
keywordMap["IC"] ="IC:Insurance Card"; //CRN201026 added

zData.maxChannels=3; //ERS190731 #61272 zippi is strongly typed
zData.makeStack=true; //ERS190814 #61511

zData.watermark=""+XCustomSetting(doc,"watermark__c"); //ERS190618 best practice
//alert("ERS190411 wm="+zData.watermark+" ZPAPER__server__c="+XCustomSetting(doc,"ZPAPER__server__c"));
zData.uploadDir = ""+XCustomSetting(doc,"uploadDir__c"); //"alkermesRoot";
zData.patEnrollQueueId = ""+XCustomSetting(doc,"patientQueueId__c"); //'00G4C000000LkmZ'; //insert the Queue ID of the desired ownership queue. Update when migrating between environments. Need to add this queue in Setup
zData.recTypeRequest = ""+XCustomSetting(doc,"recTypeRequest__c"); //'0124C000000Cj5Y'; //ID of the Case Record Type Request_PS_MVN
//TODO zData.keywordMap["ENRL"] ="ENRL:Enrollment Form";  //TODO get from zStack picklists
//TODO zData.keywordMap["FAC"] ="FAC:Facility Enrollment Form";
//ERS200205 deleted demo data - do with custom settings

var cs=XDeploymentInfo(doc, "Business_Process__c"); //ERS200222 need both deployment info and cs
//alert("cs="+cs);
if (cs) {
    if (cs.indexOf("zCustomSettings")>-1) cs=X(doc,"zCustomSettings",cs);
    alert("ERS200225 EVAL on "+cs);
    if (cs !== "") eval(""+cs); //ERS200222 TODO JSON.parse() //ERS200225 beeds to be eval but also needs to work!!!
    alert("No try just do!");
}

if (1===0 && !zData.childStackRecordType) { //TODO custom setting or deployment? //ERS201129 DONE in zChildFields
    alert("ERS201128 should be in custom settings zChildFields");
    zData.childStackRecordType="01211000001gBs3AAE"; //ERS201128 should be in custom settings zChildFields "0120R000001N2oI";
}

zData.clientImportSOQL=function(doc,fromFile) { //ERS190706 customize imports used by Create Stack
    zData.importer=XCustomSetting(doc,zData.zp+"Importer__c").trim();
    var sfId="";
    var parts=fromFile.split("_");
    //sfId = getSFRecordID(doc, "Account", { "Fax" : parts[3] } );
    zData.makeStack=true; //do all the work there by default
    return sfId;
};

//alert("zData.clientStack");
zData.clientStack=function(doc,arrOfPairs) { //zData or this?
    var zp=zData.zp; if (!zp) zp="ZPAPER__"; //ERS190805 
  if (zData.received) arrOfPairs.push("zStack_Received__c", zData.formatNow); //ERS190617 TODO save way to do this
  if (zData.ownerId) arrOfPairs.push("OwnerId",zData.ownerId);  // zCharta Queue "00G36000002CyTK" 
  if (zData.callerId) arrOfPairs.push("zCaller_ID__c", doc.deliveredFrom); //MSH170817 added
  if (zData.patEnrollQueueId) arrOfPairs.push("OwnerId",zData.patEnrollQueueId);
  
    arrOfPairs.push("ZPAPER__faxType__c", zData.docType);
    arrOfPairs.push("ZPAPER__Classification__c", zData.classification);
    var pageRange = X(doc,"X_idxPages");
    if (!pageRange) pageRange="1-"+X(doc,"X_pages"); 
    var pageCount = zData.countPages(doc, pageRange);
    arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 
    //ERS190810 TODO? arrOfPairs.push("ZSTACK__Received__c", zData.formatNow);
    alert("ERS200213.51 pageRage="+pageRange + " but pageCount="+pageCount); //ERS200213 also called in new incoming stack
    if (!X(doc,"X_idxPages")) pageCount=X(doc,"X_pages"); //ERS200213 TODO fix zData.countPages()
    arrOfPairs.push("ZPAPER__Pages__c", pageCount);
    
    //ERS200204 TODO zStack.Program?

    if (zData.programName === zData.PROGRAM_ZCHARTA) { //JPB201023 changed from classification to programName
      arrOfPairs.push(zp+"Priority__c", "Urgent"); //JPB190426 changed to classification from program
    } else if (zData.programName === zData.PROGRAM_ZPAPYRUS) { //JPB201023 changed from classification to programName
      arrOfPairs.push(zp+"Priority__c", "High"); 
    } else if (zData.programName === zData.PROGRAM_ZCARTA) { //JPB201023 changed from classification to programName
      arrOfPairs.push(zp+"Priority__c", "Critical");  
    } else {
      arrOfPairs.push(zp+"Priority__c", "Normal");
    }
    
    arrOfPairs.push(zp+"sentFaxTo__c", ("Community" === zData.channel ? zData.channel : doc.deliveredTo)); //JPB190529 added so Community shows up in Master Intake List
    arrOfPairs.push(zp+"From__c",doc.deliveredFrom);
    if (zData.reviewedStatus) {arrOfPairs.push(zp+"Stage__c", zData.reviewedStatus); } 
    else { arrOfPairs.push(zp+"Stage__c", "Received"); }
    zData.stackPairs=arrOfPairs; //ERS190810 #61570 for child stack later
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__zStackFields__c")); //ERS190803 #52661 using JSON 
  return arrOfPairs;
};

//alert("zData.clientFile");
zData.clientFile=function(doc,stage) { //ERS170829 #41298 returns a label to be used in any attaches and fixes the doc
    //Document attachment label should be "Patient Name - Doc Type - Date".  Confirmed for zPaper File and SFDC Attachment
    var MMddYYYY = zData.formatTodayMMddYYYY();
    //CRN201025 #76788 Fixed to match the current demo.
    var patientName = X(doc,"X_ZPAPER__PatientAccount__r.Name");
    if (!patientName) {
        patientName = X(doc,"X_ZPAPER__FirstName__c") + " " + X(doc, "X_ZPAPER__LastName__c");
    }
    var faxType = keywordMap[X(doc,"X_ZPAPER__faxType__c")];
    if (!faxType) { faxType = X(doc,"X_ZPAPER__faxType__c"); }
    if (!faxType.indexOf(':') >= 0) { faxType = faxType.split(':')[1]; }
    // doc.label = patientName + " - " + faxType + " - " + MMddYYYY;
    doc.label = patientName + " - " + faxType;
    if (!patientName || patientName.length<5) { //ERS201129 #78830
        doc.label="Split from "+X(doc,"X_splitPages")+" of "+ X(doc,"X_fromPages") +" - "+MMddYYYY;
        doc.label="Split from "+ X(doc,"X_fromPages") +" - "+MMddYYYY; 
    } 
    alert("ERS170829 dbID="+doc.dbID+" label="+doc.label);
    if (zData.sfID  && zData.sfID.indexOf("500")===0) {
      zData.provider = getSFField(doc, "Case", "Account.Name", null, zData.sfID); 
      label = "Received from " + zData.provider;
        if (zData.facility) {
            zData.facility = getSFField(doc, "Case", "Account.Facility__r.Name", null, zData.sfID);
            doc.label+=" at "+zData.facility;
        }
  }
  var arrOfPairs = [];
    arrOfPairs.push("db-label", doc.label);
  updateDB(doc,arrOfPairs);
    return doc.label;
};

zData.clientValue=function(doc,val) {//ERS190803 #52661 using JSON 
    val=val.replace("{!formatNow}",zData.formatNow);
    return val;
}

zData.clientFields=function(doc,arrOfPairs,jd,zd) { //ERS190803 #52661 using JSON in setting to configure new record
    if (!zd) zd=zData;
  if (jd && jd.indexOf("{")===0) { 
      //{"Type":"Eligibility","OwnerId":"00Gc0000003vgqw","RecordTypeId":"0126A000000JEKeQAO"};
      //NOT A GOOD IDEA jd=jd.replaceAll("\"","'"); //ERS190811 #61570 HACK?
      jd=jd.replace("};","}"); //ERS201129 SHR to work out design on channel wizard for zStack child set ASAP
      try {
          var jdata=JSON.parse(jd); //ERS190805 better than eval
          for (var n in jdata) {
              var v0=jdata[n]; 
              var v=zData.clientValue(doc,v0); //ERS190811 ,v now ,v0
              alert("ERS190803.97 "+n+"="+v0+"="+v); 
              arrOfPairs.push(n,v); //ERS190811 added .push
              zd[n]=v; //ERS201129 #78830 TODO review arrOfPairs access using for RecordTypeId
          }
      } catch (e) {
          alert("JSON not in "+jd+" Exception: "+e); //ERS190811 added e
      }
  }
  return arrOfPairs;
}


zData.clientCase=function(doc,arrOfPairs,label,zd) {
  if (!zd) zd=zData;
  if (!zd.triageType && X(doc,"X_ZPAPER__faxType__c")) zd.triageType=X(doc,"X_ZPAPER__faxType__c"); //ERS200308
  if (!label) { label="Indexed-" + "-" + zd.triageType + "-" + zd.stackId;}
  
  alert("ERS200308.128 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
  
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  if (zd.contactId) arrOfPairs.push("ContactId", zd.contactId);
  arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
  arrOfPairs.push("Status", X(doc,"X_Status"));
  arrOfPairs.push("ZPAPER__faxType__c",zd.triageType); //ERS200308
  //ERS200205 arrOfPairs.push("Type", "New "+zd.classification); //JPB 170512 added these workflow fields
  //ERS200308 arrOfPairs.push("Type", "New "+zd.docType);
  if (1==1) { //ERS170523 #37162 after dryrun
      alert("@@@ zd.priority => *" + zd.priority + "*");
    //arrOfPairs.push("RecordTypeId","012Q00000005Ahj"); //ERS170523 Prior Auth
    if (zd.priority != "Normal") { arrOfPairs.push("Priority",zd.priority); }  //ERS170524 #37162 priority on Case
    else { arrOfPairs.push("Priority","Medium"); }
    arrOfPairs.push("Origin","Fax"); //ERSa200205 rrOfPairs.push("Origin",zd.channel);
  }
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__CaseFields__c")); //ERS190803 #52661 using JSON
    
    alert("ERS200308.143 new Case providerId="+zd.providerId+" patientId="+zd.patientId);
    if (zd.providerId && zd.providerId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.providerId); } //ERS200308
    if (zd.providerId && zd.providerId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.providerId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("001")==0) { arrOfPairs.push("AccountId", zd.patientId); } //ERS200308
    if (zd.patientId && zd.patientId.indexOf("003")==0) { arrOfPairs.push("ContactId", zd.patientId); } //ERS200308
    if (zd.zchannel.owner) { arrOfPairs.push("OwnerId", zData.zchannel.owner); } //ERS200308
    
  var caseId = createAndAttach(doc, "Case", label, arrOfPairs);
  return caseId;
};

zData.clientPatient=function(doc,arrOfPairs,label,zd) {
  if (!zd) zd=zData;
  if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
  if (zd.patientId) { //ERS200205 #68825 Program Members
      alert("Patient already exists in "+zd.patientId);
      return zd.patientId; //TOOD get from X_patientId  ????
  }
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  var p="ZPAPER__"; //ERS200202 assume workflow on related record types
  if (zData.patientType.indexOf("__c") > -1) { p=""; } //ERS200203 typo
  if (1==0) { //ERS200202 see if workflow enabled
      arrOfPairs.push(p+"newFax__c", "true"); //JPB 170512 added these workflow fields
      arrOfPairs.push(p+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
      arrOfPairs.push(p+"receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields
  }

    var rt=XCustomSetting(doc,"PatientRecordType__c"); //TODO into MP ERS190802 like 0126A000000JE8yQAG or empty to use default
    //if (rt) { arrOfPairs.push("RecordTypeId", rt); } //ERS190803
    //TODO Contact or Account ERS190624 DONE!! ERS190802
    arrOfPairs=zData.clientFields(doc,arrOfPairs,XCustomSetting(doc,"ZPAPER__PatientFields__c")); //ERS190803 #52661 using JSON 
    arrOfPairs=[]; //ERS200204 testing to get it going
    
    //ERS200202 need to make the Account with Patient recordType first
    //01246000000NGFYAA4 is .zpaper for Patient
    var ar = [];
    if (rt) { ar.push("RecordTypeId", rt); } //ERS190803 //ERS200222 #69149 moved down and added else 
    else ar.push("RecordTypeId","01246000000NGFYAA4");
    ar.push("FirstName",zData.X_ZPAPER__FirstName__c);
    ar.push("LastName",zData.X_ZPAPER__LastName__c);
    var patientName=zData.X_ZPAPER__LastName__c+", "+zData.X_ZPAPER__FirstName__c;
    if (zData.X_ZPAPER__Birthdate__c) ar.push("PersonBirthDate",zData.X_ZPAPER__Birthdate__c);
    var aId = createSFRecord(doc, "Account", null, ar); //ERS200204 person account so do not set patientName
    
    if (aId && aId != "NEW" && aId.indexOf("ERROR")==-1) {
        var sfId = "";
      
      //ERS190803 specific to client data entry
      var dq = zData.dq;
      addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c" + dq + ").val(" + dq + sfId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
    }
    return {'ERROR': 'patient not created'}
};

zData.clientAccount=function(doc,arrOfPairs,label,zd) {
  if (!zd) zd=zData;
  if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
  arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //ERS190814 //JPB 170512 added these workflow fields

  var accountId = createAndAttach(doc, "Account", label, arrOfPairs);
  return accountId;
};

zData.clientRecord=function(doc,sfType,arrOfPairs,label,zd) { //ERS190620 clientRecord generic
  if (!zd) zd=zData;
  if (!label) { label=zd.stage + "-" + zd.triageType + "-" + zd.stackId;}
  //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc,"X_Assign_to_Queue__c")]);
  var zp="";
  if (",Case,Contact,Account,Lead,Opportunity,ZPAPER__zStack__c,".toLowerCase().indexOf(","+sfType.toLowerCase()+",")>-1) zp=zData.zp;
  //only do this if the fields exist
  arrOfPairs.push(zp+"newFax__c", "true"); //JPB 170512 added these workflow fields
  arrOfPairs.push(zp+"latestFax__c", zd.formatNow); //JPB 170512 added these workflow fields
  arrOfPairs.push(zp+"receivedId__c", "doc.dbID.Rec"); //JPB 170512 added these workflow fields
  
  //TODO put client specific data updates here

  var newId = createAndAttach(doc, sfType, label, arrOfPairs);
  return newId;
};

zData.clientComplete=function(doc,arrOfPairs,zd) {return arrOfPairs;}; //ERS190625
zData.clientDelivery=function(doc,arrOfPairs) { //ERS200202 TODO consider new Document_MVN
    return arrOfPairs;
}; //ERS190711 #60900 PAOS

zData.clientChildStack=function(doc,arrOfPairs,parentId) { //ERS190810 #61570 be sure to call on new child doc
    var pairs=arrOfPairs;
    //no memory of stack creation var pairs=zData.stackPairs;
    //CRN201026 #76788 We need reviewedStatus to be "Indexed" for the index rule, so only set the field if it isn't already set.
    if (!zData.reviewedStatus) { zData.reviewedStatus="Split"; }
    //ERS190810 TODO? pairs.push("ZPAPER__Status__c", "Child Stack");

    pairs=zData.clientStack(doc,pairs);
    if (XCustomSetting(doc,"ZPAPER__zChildFields__c")) { //ERS190811 not in all MPs
        pairs=zData.clientFields(doc,pairs,XCustomSetting(doc,"ZPAPER__zChildFields__c")); //ERS190803 #52661 using JSON child record type id
    }
    pairs.push("ZPAPER__Parent__c", parentId);
    //ERS201128 should be in zChildFields if (zData.childStackRecordType) pairs.push("RecordTypeId",zData.childStackRecordType);
    
    //pairs.push(""+"Program__c",zData.programName); //ERS200205 TODO in package and into base call
    pairs.push("ZPAPER__Program__c",zData.programName);
    //ERS200229 if (zData.patientId) pairs.push("Program_Member_MVN__c",zData.patientId); //ERS200205 Program_Member_MVN__c was the TICKET!!!
    alert("ERS190811.191 ZPAPER__Parent__c"+ parentId+" child zData.childStackRecordType="+zData.childStackRecordType);
    if (zData['RecordTypeId']) {  zData.childStackRecordType=zData['RecordTypeId']; } //ERS201129 #78830 TODO not sure where this is used elsewhere
    alert("ERS201129.292 ZPAPER__Parent__c"+ parentId+" child RecordTypeId="+zData['RecordTypeId']);
    alert("testing pairs before createandattach : " + pairs);
    var childStackSFId = createAndAttach(doc, "ZPAPER__zStack__c", "zStack split on " + zData.formatNow, pairs) + "";
    
    if (!zData.patientId && X(doc,"X_ZPAPER__PatientAccount__c") ){ //ERS200308 HACK
        zData.patientId=X(doc,"X_ZPAPER__PatientAccount__c");
        alert("ERS200308 WHY NOT in zData?");
    }
    /*
    //commented as Timeline is not in use
    if (zData.patientId) { //ERS200308 create an Activity Event related to the Patient (Account) for the Timeline
        if (!zData.docType && X(doc,"X_ZPAPER__faxType__c")) zData.docType=X(doc,"X_ZPAPER__faxType__c");
        var arr=[];
        //NOT SELECT AccountId,ActivityDate,CreatedDate,Status,Subject,TaskSubtype,WhatId,WhoId FROM Task where ActivityDate > 2020-02-01
        //SELECT Id,AccountId,ActivityDate,CreatedDate,Subject,WhatId,WhoId FROM Event where Id = '00U4T000002vChrUAE'
        //arr.push("WhoId",zData.patientId); //ERS200310 timeline trick
        if (zData.patientId.indexOf("001")==0) {
            arr.push("WhatId",zData.patientId); //ERS200310 timeline trick
            //arr.push("AccountId",zData.patientId); //ERS200310 timeline trick
        } else if (zData.caseId) arr.push("WhatId",zData.caseId);
        else if (zData.providerId) arr.push("WhatId",zData.providerId);
        else arr.push("WhatId",childStackSFId);
        //arr.push("TaskSubtype","Task");
        arr.push("Subject",zData.stage + " "+zData.docType);
        arr.push("Description","Check out "+doc.dbID);
        //arr.push("ActivityDateTime",zData.formatNow); //ERS200309 hacking away!
        arr.push("ActivityDate",zData.formatNow.substring(0,10));
        arr.push("RecordTypeId","0124T0000008aFmQAI"); //ERS200310 HACK for Task on CarePlan
        //arr.push("DurationInMinutes","5");
        //arr.push("Status","Completed");
        
        var label="Timeline "+zData.docType;
        var actId = createSFRecord(doc, "Task", null, arr); //ERS200309 null means no Name field
        //var actId = createSFRecord(doc, "Event", null, arr); //ERS200309 null means no Name field
        alert("ERS200308.262 timeline activity "+actId);
    } else { alert("ERS200308.263 be worried there is no patient!"); }
    */
    if (1===1 && zData.clientReceivedDocument) { zData.recDocId=zData.clientReceivedDocument(doc,childStackSFId); } //ERS201018 #77252
    return childStackSFId;
};


zData.clientStackComplete=function(doc,arrOfPairs,zd) { //ERS200314 #70336
    if (!zd) zd=zData; //ERS200406 #71156
    arrOfPairs.push("Time_Complete_Date__c",zd.formatNow); //for dashboard
    return arrOfPairs;
}; //ERS190625

zData.clientAttachPopulatefields=function(doc,arrOfPairs,patientId,parentId,childId){ //[VJ - populate fields and attach indexed pages to lookups]

  var zparentId = parentId;
  var zchildId = childId;
  var attachLabel=zData.clientFile(doc,"Indexed"); //"Indexed " + formatNow;
  
  if ((zparentId && zparentId.length > 0) && (zchildId && zchildId.length > 0)) {
    var arrOfPairs = [];
    
    arrOfPairs.push("Document_Received_Date__c", receivedDate);
    updateSFRecord(doc,zData.zps, zchildId, arrOfPairs);
  }
  
  return null;
}

zData.clientLightningFile=function(doc,sfId,zd,childStackId) { //use in index client library
  
if (!zd) zd=zData;
    if (!doc.kbData.sfServer) {   
    //ERS200428 HACK
    alert("doc.kbData.sfServer was empty. Ideally should NOT come here"); doc.kbData.sfServer="takedapatientservices--tkdev2.lightning.force.com"; 
  }
    var zserver = doc.kbData.sfServer.indexOf("https://")==0 ? doc.kbData.sfServer : "https://" + doc.kbData.sfServer; 
  // Salesforce REST API endpoint
    var docurl = zserver + "/services/data/v46.0/sobjects/ContentVersion/";
    var pdfurl = "https://gw.zpaper.com/kb/jsp/SF_find.lightning.jsp?go=SF_files.jsp&dbID=" + doc.dbID + "&SForg=" + doc.kbData.sfOrganizationID;

  // Generate PDF file from zStack
    var formatNow = getCurDateAndTime(doc,false,true); // e.g. "20210210-052132"?
    var arrOfPairs = [];
    var nowTimeStamp = new Date().getTime() + ""; 
    
    var fileName = getCurDate(doc)+ " "+zData.docType+".pdf";  // e.g - "20210210 New Fax.pdf"?
    alert("@@@fileName = "+fileName);
  
  zData.uploadDir = 'zStackUploadRoot'; //setting root directory for file creation
  
    // create directory to place generated PDF file
    createDirectory(doc, zData.uploadDir, nowTimeStamp);
   
    var xPages = X(doc, "X_position"); //get X_position - page range selected; default = all pages
    alert("@@@@@ Calling splitPDF to split off pages to upload as PDF, pages = " + xPages + ", nowTimeStamp = " + nowTimeStamp);
    var response = splitPDF(doc, xPages, zData.uploadDir, nowTimeStamp, fileName);
    alert("@@@@ response from splitPDF = " + response);
    var newPDFName = X(doc, "newPDF", response); // set value of newPDF
    
    alert("@@@@ split PDF FileName = " + newPDFName);

  // Cannot directly Append PDF file to multipart formdata
  // JS does not allow reading a file from the file system (normally applies to client side for security reasons)
  // We dont have a Node.js container, so no luck there.. have to do this another way
  // Eric suggested we use uploadToCloud.jsp approach to create Lightning File (probably ContentDocument) in Salesforce
  
    //var uploadURL="http://localhost:8080/myfileforce/uploadToCloud.jsp?SFid=NEW&SFpid="+sfId+"&SForg="+doc.sfOrg+"&label="+fileName+"&serverFile="+newPDFName+"&Description=File attached as PDF";
  //AN20210903 #81766 need SFtype=ContentVersion parameter to upload as Lightning File
  var uploadURL="http://localhost:8080/myfileforce/uploadToCloud.jsp?SFtype=ContentVersion&SFid=NEW&SFpid="+sfId+"&SForg="+doc.sfOrg+"&label="+fileName+"&serverFile="+newPDFName+"&Description=File attached as PDF";
  
    alert("#### Upload native PDF with "+uploadURL);
  
    var r=wget(doc, uploadURL); // ????? will r contain the ContentDocument id?
  
  alert('value from wget response >>> '+r);
    
    var idxBegin = r.indexOf("<sfID>");
    var idxEnd = r.indexOf("</sfID>");
    var sfdocId;
  if(idxEnd > idxBegin) {
    sfdocId = r.substring(idxBegin+6,idxEnd);
    alert("sfDocId extracted from r : " + sfdocId);
  }
  
    // Finally, delete the folder and all contents.
    cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);

  //Get the contentVersion record of the attachment
  var conVId = getSFField(doc, "ContentVersion", "Id",'ContentDocumentId=\''+sfdocId+'\'',null);
  
  //zStack__c,TK_Document_Date__c
    var arrOfPairs = [];
  arrOfPairs.push("zStack__c", childStackId); 
  var docSigDate = X(doc, "X_Document_Signature_Date__c"); //PV210402 
	if(docSigDate)
	arrOfPairs.push("TK_Document_Date__c",docSigDate);
  //arrOfPairs.push("TK_Document_Date__c", X(doc, "X_Document_Signature_Date__c"));
  alert("Doc type "+zData.docType);
  if(zData.docType == "CONS"){//PV210401 updated
    arrOfPairs.push("TK_Category__c", "Consent");
    arrOfPairs.push("TK_Sub_Category__c", "Review Consent Form");
  }else if(zData.docType == "REMS"){
    arrOfPairs.push("TK_Category__c", "REMS");
    arrOfPairs.push("TK_Sub_Category__c", "Review REMS Document");
  }else if(zData.docType == "SUP"){
    arrOfPairs.push("TK_Category__c", "SUP");
    arrOfPairs.push("TK_Sub_Category__c", "Review SUP Document");
  }else if(zData.docType == "CONF"){
    arrOfPairs.push("TK_Category__c", "Confirmation");
    arrOfPairs.push("TK_Sub_Category__c", "Review Confirmation");
  }else if(zData.docType == "PDOC"){
    arrOfPairs.push("TK_Category__c", "Patient Documents");
    arrOfPairs.push("TK_Sub_Category__c", "Review Patient Document");
  }else if(zData.docType == "OTH"){
    arrOfPairs.push("TK_Category__c", "Other");
    arrOfPairs.push("TK_Sub_Category__c", "Review Other Document");
  }

  alert("sftype : " + zData.zps);
  updateSFRecord(doc, 'ContentVersion', conVId, arrOfPairs);
  

    return null;
}

alert("end client library"); //ERS190615 #58921
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
//--- RULE VALIDATION CODE - END ---

</script>
