<!--
// Name: Index Page Encrypted
// Committer: andrew@zpaper.com
// Update: updating static resource
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2019-07-08 21:51:33","active":true,"button":"Index","name":"Index Page Encrypted","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Index","operation":"equals"}]},"consequence":{"doit":"Ly90aGlzIGlzIGEgY29weSBhbmQgdXBkYXRlIG9mIHRoZSBleGlzdGluZyBJbmRleCBQYWdlIHJ1bGUuIFRlbXAgdXNlIGZvciBTaGllbGQgRW5jcnlwdGlvbiB0ZXN0aW5nCmFsZXJ0KCJAQEBAIEluZGV4IEVuY3J5cHRlZCBSdWxlIEZpcmVkIEBAQCMiKTsKLyogZG91YmxlLXF1b3RlLCBuZXdsaW5lIGNoYXJhY3RlcnMgKi8KdmFyIGRxID0gU3RyaW5nLmZyb21DaGFyQ29kZSgzNCk7CnZhciBubCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoMTApOwp2YXIgZm9ybWF0Tm93ID0gZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKLyogTVNIMTcxMTMwICM0MzY0OSBjcmVhdGVkIGRhdGUgZm9yIG9yaWdpbmFsIGRvYyAqLwp2YXIgZG9jQ3JlYXRlZERhdGUgPSBnbXRGb3JtYXR0ZWQoZG9jLCAiY3JlYXRlZCIpOwp2YXIgYXR0YWNoUGF0aCA9IFgoZG9jLCAiWF9hdHRhY2hlZFRvIik7CnZhciBwYXRpZW50Rmlyc3ROYW1lID0gIiI7CnZhciBwYXRpZW50TGFzdE5hbWUgPSAiIjsKdmFyIHBhdGllbnRET0IgPSAiIjsKdmFyIHBhdGllbnRJZCA9ICIiOwp2YXIgdGlmZlNmSWQ9IiI7CnZhciBzdGFja0lkID0gWChkb2MsICJYX3N0YWNrIik7IC8velBhcGVyIGRiSUQKdmFyIHNmU3RhY2tJZCA9IFgoZG9jLCAiWF9zZlN0YWNrSWQiKTsKdmFyIG9yZ0RvY0lkID0gZG9jLmRiSUQ7ICAvL1BWMDIyNjE4CmlmIChzZlN0YWNrSWQgPT09ICIiKSB7IC8vRVJTMTcwNzMxICM0MDU5MwogICAgLyogTVNIMTcwODE0IHRoaXMgZG9lc24ndCBkbyBhbnl0aGluZyB1c2VmdWwgWChkb2MsICJYX2F0dGFjaGVkVG8iKTsgKi8KICAgIC8qIE1TSDE3MTEyOSB3ZSBhbHJlYWR5IGdvdCBhdHRhY2hQYXRoLCB1c2UgaXQgc2ZTdGFja0lkID0gWChkb2MsICJYX2F0dGFjaGVkVG8iKTsgKi8KICAgIHNmU3RhY2tJZCA9IGF0dGFjaFBhdGg7CiAgICBpZiAoc2ZTdGFja0lkLmxhc3RJbmRleE9mKCcvJykgPj0gMCkgewogICAgICAgIHNmU3RhY2tJZCA9IHNmU3RhY2tJZC5zdWJzdHJpbmcoc2ZTdGFja0lkLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKICAgICAgICBpZiAoc2ZTdGFja0lkLmluZGV4T2YoJywnKSA+PSAwKSB7IHNmU3RhY2tJZCA9IHNmU3RhY2tJZC5zdWJzdHJpbmcoMCwgc2ZTdGFja0lkLmluZGV4T2YoJywnKSk7IH0KICAgIH0KfQphbGVydCgiQEBAIEN1cnJlbnRseSBhdHRhY2hlZCB0byBaUEFQRVJfX3pTdGFja19fYyB3aXRoIHNmU3RhY2tJZDogIiArIHNmU3RhY2tJZCk7CgovL0FOMjAxODA3MTYgZm9yIGNvZGUgcmV2aWV3IC0gYXJlIHRoZXNlIHZhcmlhYmxlcyBhbmQgSUYgc3RhdGVtZW50IHN0aWxsIG5lZWRlZCwgc2luY2Ugd2UgYXJlIG5vIGxvbmdlciB1c2VyIGZvbGRlcnM/CnZhciBvcmlnaW5hbFNmU3RhY2tJZCA9IHNmU3RhY2tJZDsKYWxlcnQoIkBAQCBvcmlnaW5hbFNmU3RhY2tJZCA9ICIgKyBvcmlnaW5hbFNmU3RhY2tJZCk7CnZhciBzdGFja0ZvbGRlciA9IHN0YWNrSWQgKyAiLVNUQUNLIjsKLyogQ2xlYXIgdGhlIHRyaWdnZXIgdGhhdCBpbnZva2VkIHRoaXMgcnVsZSAqLwp6RGF0YS5jbGVhclRyaWdnZXJDb25kaXRpb24oZG9jLCAiWF9idXR0b25BY3Rpb24iKTsKdmFyIGluZGV4SW5pdGlhbGl6ZWQgPSBYKGRvYywgIlhfaW5kZXhJbml0aWFsaXplZCIpOwppZiAoIWluZGV4SW5pdGlhbGl6ZWQgfHwgMCA9PT0gaW5kZXhJbml0aWFsaXplZC5sZW5ndGgpIHsKICAgIHN0YWNrSWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOwogICAgc3RhY2tGb2xkZXIgPSBzdGFja0lkICsgIi1TVEFDSyI7CiAgICAvKiBNU0gxNzA4MTQgbWlzbWF0Y2hlZCBwYXJhbSBsaXN0ICovCiAgICAvKiB6RGF0YS5pbml0aWFsaXplU3RhY2soZG9jLCBzdGFja0ZvbGRlciwgY29tcGFueUNvZGUsIHN0YWNrSWQpOyAqLwogICAgekRhdGEuaW5pdGlhbGl6ZVN0YWNrKGRvYywgc3RhY2tGb2xkZXIsIHN0YWNrSWQpOwp9Cgp2YXIgY2FzZUlkID0gWChkb2MsICJYX1pQQVBFUl9fQ2FzZV9fYyIpOwphbGVydCgiQEBAIGNhc2VJZCA9ICIgKyBjYXNlSWQpOwoKdmFyIGNhc2VGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCAiQ2FzZSIsICJSZWNvcmRUeXBlSWQsQ29udGFjdElkLEFjY291bnRJZCIsIG51bGwsIGNhc2VJZCk7IC8vQU4yMDE4MDcxOCBnZXQgdGhlIGZpZWxkcyBmcm9tIHRoZSBDYXNlIHRoYXQgd2Ugd2lsbCBuZWVkCgp2YXIgcmVjVHlwZUlkID0gWChkb2MsICJSZWNvcmRUeXBlSWQiLCBjYXNlRmxkcyk7CnZhciByZWNUeXBlTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiUmVjb3JkVHlwZSIsICJOYW1lIiwgbnVsbCwgcmVjVHlwZUlkKTsgLy9BTjIwMTgwNzE4IGdldCB0aGUgbmFtZSBvZiB0aGUgY3VycmVudCBDYXNlIHJlY29yZCB0eXBlCgphbGVydCgiQEBAIGN1cnJlbnQgQ2FzZSBSZWNvcmQgVHlwZSBOYW1lOiAiICsgcmVjVHlwZU5hbWUpOwoKLy9BTjIwMTgwNzE4IGFkZGVkIHRoaXMgbG9naWMgdG8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIFBBUCBhbmQgUkggY2FzZXMKaWYgKHJlY1R5cGVOYW1lID09PSAiTmV3L1JlbmV3YWwvWUVDL09uLWdvaW5nIFByZXNjcmlwdGlvbiIpeyAvL3RoaXMgaXMgYSBQQVAgY2FzZQogICAgYWxlcnQoIkBAQCBnZXR0aW5nIFBBUCBDYXNlIGRldGFpbHMiKTsKCiAgICAvL01TSDE4MDUxNSAjNDgzMDIgdHJ5IGdldFNGRmllbGQKICAgIC8vdmFyIHBhdGllbnRJZCA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJDb250YWN0SWQiLCBudWxsLCBjYXNlSWQpOwogICAgCiAgICBwYXRpZW50SWQgPSAgWChkb2MsICJDb250YWN0SWQiLCBjYXNlRmxkcyk7IC8vZ2V0IHRoZSBDb250YWN0IElEIHNpbmNlIFBBUCB1c2VzIHRoZSBDb250YWN0IG9iamVjdCBmb3IgUGF0aWVudHMKICAgIAogICAgdmFyIGNvbnRhY3RGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCAiQ29udGFjdCIsICJGaXJzdE5hbWUsTGFzdE5hbWUsQmlydGhkYXRlIiwgbnVsbCwgcGF0aWVudElkKTsgLy9NU0gxNzA4MTggYWRkZWQgQmlydGhkYXRlCiAgICBhbGVydCgiQEBAIGNhbGxpbmcgU0YgZm9yIGNvbnRhY3RGbGRzIDo6ICIgKyBjb250YWN0Rmxkcyk7CiAgICBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJGaXJzdE5hbWUiLCBjb250YWN0Rmxkcyk7CiAgICBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIkxhc3ROYW1lIiwgY29udGFjdEZsZHMpOwogICAgcGF0aWVudERPQiA9IFgoZG9jLCAiQmlydGhkYXRlIiwgY29udGFjdEZsZHMpOwoKfQplbHNlIGlmIChyZWNUeXBlTmFtZSA9PT0gIkJlbmVmaXQgVmVyaWZpY2F0aW9uIiB8fCByZWNUeXBlTmFtZSA9PT0gIkRlbmlhbCBTdXBwb3J0IiB8fCByZWNUeXBlTmFtZSA9PT0gIkNvbXBsZXRlIEludGFrZSIpeyAvL0FOMjAxOTAzMDUgdGhpcyBpcyBhbiBSSC1JbW11bm9sb2d5IGNhc2Ugb3IgYSBDb21wbGV0ZSBJbW11bm9sb2d5IGNhc2UKICAgIGFsZXJ0KCJAQEAgZ2V0dGluZyBSSCBvciBDb21wbGV0ZSBJbW11bm9sb2d5IENhc2UgZGV0YWlscyIpOwogICAgCiAgICAvL0FOMjAxODA3MjUgdGhlcmUgaXMgY29uZnVzaW9uIG92ZXIgd2hldGhlciB3ZSBzaG91bGQgdXNlIHRoZSBsb29rdXAgUFNfQWNjb3VudF9fYyBvciB0aGUgc3RhbmRhcmQgQWNjb3VudElkIGZpZWxkIG9uIENhc2UuIEF3YWl0aW5nIGNsYXJpZmljYXRpb24gZnJvbSBBYmJ2aWUKICAgIC8vcGF0aWVudElkID0gWChkb2MsICJQU19BY2NvdW50X19jIiwgY2FzZUZsZHMpOyAvL2dldCB0aGUgQWNjb3VudCBJRCBzaW5jZSBSSCB1c2VzIHRoZSBBY2NvdW50IG9iamVjdCBmb3IgUGF0aWVudHMKICAgIHBhdGllbnRJZCA9IFgoZG9jLCAiQWNjb3VudElkIiwgY2FzZUZsZHMpOyAvL2dldCB0aGUgQWNjb3VudCBJRCBzaW5jZSBSSCB1c2VzIHRoZSBBY2NvdW50IG9iamVjdCBmb3IgUGF0aWVudHMKICAgIAogICAgdmFyIGFjY291bnRGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCAiQWNjb3VudCIsICJQU19QYXRpZW50Rmlyc3ROYW1lX19jLFBTX1BhdGllbnRMYXN0TmFtZV9fYyxQU19ET0JfX2MiLCBudWxsLCBwYXRpZW50SWQpOyAKICAgIGFsZXJ0KCJAQEAgY2FsbGluZyBTRiBmb3IgYWNjb3VudEZsZHMgOjogIiArIGFjY291bnRGbGRzKTsKICAgIHBhdGllbnRGaXJzdE5hbWUgPSBYKGRvYywgIlBTX1BhdGllbnRGaXJzdE5hbWVfX2MiLCBhY2NvdW50Rmxkcyk7CiAgICBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIlBTX1BhdGllbnRMYXN0TmFtZV9fYyIsIGFjY291bnRGbGRzKTsKICAgIHBhdGllbnRET0IgPSBYKGRvYywgIlBTX0RPQl9fYyIsIGFjY291bnRGbGRzKTsKfQoKYWxlcnQoIkBAQCBwYXRpZW50SWQgOjogIiArIHBhdGllbnRJZCk7CmFsZXJ0KCJAQEAgcGF0aWVudEZpcnN0TmFtZSA6OiAiICsgcGF0aWVudEZpcnN0TmFtZSk7CmFsZXJ0KCJAQEAgcGF0aWVudExhc3ROYW1lIDo6ICIgKyBwYXRpZW50TGFzdE5hbWUpOwphbGVydCgiQEBAIHBhdGllbnRET0IgOjogIiArIHBhdGllbnRET0IpOwoKdmFyIE1NZGRZWVlZID0gekRhdGEuZm9ybWF0VG9kYXlNTWRkWVlZWSgpOwovKk1TSDE3MTEyOSB3ZSBhbHJlYWR5IGdvdCBkb2NUeXBlLCB1c2UgaXQgYXR0YWNoTGFiZWwgPSBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKSArICIgLSAiICsgTU1kZFlZWVk7Ki8KYXR0YWNoTGFiZWwgPSBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBkb2NUeXBlICsgIiAtICIgKyBNTWRkWVlZWTsKCi8qIEdldCB0aGUgZG9jdW1lbnQgdHlwZSAod2lsbCBiZSB1c2VkIHRvIHJvdXRlIHRvIG5leHQgZm9sZGVyKSAqLwp2YXIgZG9jVHlwZSA9IFgoZG9jLCAiWF9kb2NUeXBlIik7CnZhciBhdHRhY2hMYWJlbCA9ICIiOyAvKiBNU0gxNzA4MTggZm9ybWF0IHNob3VsZCBiZSAiUGF0aWVudCBOYW1lIC0gRG9jIFR5cGUgLSBEYXRlIiAqLwp2YXIgbWFzdGVySUQgPSAoZG9jLmtiRGF0YS5ncm91cElEKS5zdWJzdHJpbmcoMSwoZG9jLmtiRGF0YS5ncm91cElEKS5sZW5ndGgoKSk7IC8vZ2V0IHRoZSB6UGFwZXIgTWFzdGVyIElECnZhciBuZXh0Rm9sZGVyID0gbWFzdGVySUQgKyAiVHJpYWdlLVMyIjsgICAgICAgICAgICAgIC8qIE90aGVyIGZvbGRlciBpcyB0aGUgZGVmYXVsdCAqLwp2YXIgcHJldkluZGV4UGFnZXMgPSBYKGRvYywgIlhfaW5kZXhlZFBhZ2VzIik7CnZhciBjdXJJbmRleFBhZ2VzID0gWChkb2MsICJYX2lkeFBhZ2VzIik7CmlmIChwcmV2SW5kZXhQYWdlcyAmJiBwcmV2SW5kZXhQYWdlcy5sZW5ndGggPiAwICYmIGN1ckluZGV4UGFnZXMgJiYgY3VySW5kZXhQYWdlcy5sZW5ndGggPiAwKSB7CiAgICBwcmV2SW5kZXhQYWdlcyArPSAiLCI7Cn0KY3VySW5kZXhQYWdlcyA9IHByZXZJbmRleFBhZ2VzICsgY3VySW5kZXhQYWdlczsKdmFyIGFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX2luZGV4ZWRQYWdlcyIsIGN1ckluZGV4UGFnZXMpOwp1cGRhdGVEQihkb2MsIGFyck9mUGFpcnMpOwoKLyogU1BMSVQgT0ZGIE5FVyBTTklQUEVUIEhFUkUgKi8KdmFyIHBhZ2VSYW5nZSA9IFgoZG9jLCAiWF9pZHhQYWdlcyIpOwphbGVydCgiQEBAIHBhZ2VSYW5nZSA9ICIgKyBwYWdlUmFuZ2UpOwp2YXIgYXJyT2ZQYWlyczEgPSBbXTsgLy9QVjI4MDMxOSB1cGRhdGVkIGZvciBjb3B5IG9uIHNwbGl0CnZhciBwYWdlQ291bnQgPXpEYXRhLmNvdW50UGFnZXMoZG9jLCBwYWdlUmFuZ2UpOwovL3ZhciBwYWdlUmFuZ2UgPSAiMS0iICsgcGFnZUNvdW50OwogICAgYWxlcnQoIkBAQCBwYWdlUmFuZ2UgPT09ICIgKyBwYWdlUmFuZ2UpOwogICAgaWYocmVjVHlwZU5hbWUgPT09ICJDb21wbGV0ZSBJbnRha2UiKXsKICAgICAgdmFyIGJ1ZmZlciA9ICIiOwogICAgZm9yICh2YXIgaT0xOyBpPD1wYWdlQ291bnQ7IGkrKykgewogICAgICAgIHZhciBjdXJUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgYnVmZmVyICs9ICJrYm0oJ0lNRyIgKyBjdXJUaW1lICsgIicsJ1BBR0UiICsgaSArICJJTUciICsgY3VyVGltZSArICInLCdhZGRUZXh0JywxMCwxLDg3NSwxNDgwLCdDT1BZJywnMjRweCcpOyI7CiAgICB9CiAgICAKICAgIGFsZXJ0KCJAQEBAIE1BUktVUCA9ICIgKyBidWZmZXIpOyAgIAogICAgLy9hcnJPZlBhaXJzMS5wdXNoKCJYX21hcmt1cCIsIGJ1ZmZlcik7ICAKICAgIH0KICAgIAp2YXIgbmV3RGJJZCA9IHNwbGl0RG9jdW1lbnRGb3JJbmRleChkb2MsICJpbmRleCIsIHBhZ2VSYW5nZSxhcnJPZlBhaXJzMSk7CmFsZXJ0KCJAQEAgYWZ0ZXIgc3BsaXREb2N1bWVudEZvckluZGV4Iik7Ci8qIGFsZXJ0KCJAQEAgQ2FzZSAnIiArIGNhc2VJZCArICInIGFuZCBsZW4gPSAiICsgY2FzZUlkLmxlbmd0aCk7ICovCi8vKgovKiBBRlRFUiBUSElTIFBPSU5ULCBUSEUgRE9DIFdJTEwgSE9MRCBEQVRBIEZPUiBORVcgU05JUFBFVCwgTk9UIFRIRSBTVEFDSyBTTklQUEVUICovCi8vKgoKLyogTVNIMTcxMTE1ICM0MzYxMyAqLwovKmFsZXJ0KCJAQEAgbmV3RGJJZCA9ICIgKyBuZXdEYklkKTsKIHNldERvY3VtZW50Q29udGV4dChkb2MsIG5ld0RiSWQpOyovCgpkb2NUeXBlID0gWChkb2MsICJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwp6RGF0YS5kb2NUeXBlID0gZG9jVHlwZTsKYXR0YWNoTGFiZWwgPSB6RGF0YS5uYW1lRmlsZShkb2MpOyAvL0VSUzE3MDgyOSAjNDEyOTgKYWxlcnQoIkBAQCBwYXRpZW50SWQgZnJvbSBYX1pQQVBFUl9fUGF0aWVudF9fYyA9ICIgKyBwYXRpZW50SWQpOwoKYWxlcnQoIkBAQCBYX1pQQVBFUl9fUGF0aWVudF9fci5OYW1lIDo6ICIgKyBYKGRvYywgIlhfWlBBUEVSX19QYXRpZW50X19yLk5hbWUiKSk7CgovKk1TSDE3MTEyOSB3ZSBhbHJlYWR5IGdvdCBkb2NUeXBlLCB1c2UgaXQgYXR0YWNoTGFiZWwgPSBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBYKGRvYywiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKSArICIgLSAiICsgTU1kZFlZWVk7Ki8KYXR0YWNoTGFiZWwgPSBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBkb2NUeXBlICsgIiAtICIgKyBNTWRkWVlZWTsKCi8vTVNIMTcwODI5IGNsZWFyIG91dCB0aGUgIk5ldyBQYXRpZW50IiBmaWVsZHMKYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fRmlyc3ROYW1lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHBhdGllbnRGaXJzdE5hbWUgKyBkcSArICIpOyAiKTsKYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fTGFzdE5hbWVfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgcGF0aWVudExhc3ROYW1lICsgZHEgKyAiKTsgIik7Ci8vYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQmlydGhkYXRlX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CmFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0JpcnRoZGF0ZV9fY19yZWFkYWJsZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBwYXRpZW50RE9CICsgZHEgKyAiKTsgIik7CgovL0FOMjAxODA3MTggYWRkZWQgdGhpcyBsb2dpYyB0byBkaWZmZXJlbnRpYXRlIGJldHdlZW4gUEFQIGFuZCBSSCBjYXNlcwppZiAocmVjVHlwZU5hbWUgPT09ICJOZXcvUmVuZXdhbC9ZRUMvT24tZ29pbmcgUHJlc2NyaXB0aW9uIil7IC8vdGhpcyBpcyBhIFBBUCBjYXNlLCBzbyB3ZSB1cGRhdGUgdGhlIENvbnRhY3QgbG9va3VwIFBhdGllbnRfX2Mgb24gelN0YWNrCiAgICBhbGVydCgiQEBAIHNldHRpbmcgREUgcGFuZWwgZmllbGRzIGZvciBmb3IgUEFQIGNhc2UiKTsKICAgIC8vTVNIMTcwODI5IHNldCB0aGUgUGF0aWVudCBsb29rdXAgZmllbGRzCiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50X19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHBhdGllbnRJZCArIGRxICsgIik7ICIpOwoKCn0KZWxzZSBpZiAocmVjVHlwZU5hbWUgPT09ICJCZW5lZml0IFZlcmlmaWNhdGlvbiIgfHwgcmVjVHlwZU5hbWUgPT09ICJEZW5pYWwgU3VwcG9ydCIgfHwgcmVjVHlwZU5hbWUgPT09ICJDb21wbGV0ZSBJbnRha2UiKXsgLy9BTjIwMTkwMzA1IHRoaXMgaXMgYW4gUkgtSW1tdW5vbG9neSBjYXNlIG9yIGEgQ29tcGxldGUgSW1tdW5vbG9neSwgc28gd2UgdXBkYXRlIHRoZSBBY2NvdW50IGxvb2t1cCBQYXRpZW50UkhfX2Mgb24gelN0YWNrCiAgICBhbGVydCgiQEBAIHNldHRpbmcgREUgcGFuZWwgZmllbGRzIGZvciBSSCBjYXNlIG9yIENvbXBsZXRlIEltbXVub2xvZ3kgY2FzZSIpOwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1BhdGllbnRSSF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBwYXRpZW50SWQgKyBkcSArICIpOyAiKTsKfQoKLy9NU0gxNzA4Mjkgc2V0IHRoZSBQYXRpZW50IGxvb2t1cCBmaWVsZHMKYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHBhdGllbnRGaXJzdE5hbWUgKyAiICIgKyBwYXRpZW50TGFzdE5hbWUgKyBkcSArICIpOyAiKTsKCi8vIHVwZGF0ZSBzdGFjawphbGVydCgiQEBAIHJlYWR5IHRvIHVwZGF0ZSBTdGFja0lEID0gIiArIHN0YWNrSWQpOyAvL01TSDE3MDkyNgphbGVydCgiQEBAIHNldHRpbmcgcGF0aWVudCBmaWVsZCBvbiBTdGFja0lEID0gIiArIHN0YWNrSWQgKyAiLCBQYXRpZW50ID0gIiArIHBhdGllbnRJZCk7CmFyck9mUGFpcnMgPSBbXTsKCmFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19GaXJzdE5hbWVfX2MiLCBwYXRpZW50Rmlyc3ROYW1lKTsKYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0xhc3ROYW1lX19jIiwgcGF0aWVudExhc3ROYW1lKTsKaWYgKHBhdGllbnRET0IgJiYgcGF0aWVudERPQi5sZW5ndGggPiAwKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQmlydGhkYXRlX19jIiwgcGF0aWVudERPQik7Cn0KCmFyck9mUGFpcnMucHVzaCgiRHJ1Z19UeXBlX19jIiwgWChkb2MsICJYX0RydWdfVHlwZV9fYyIpKTsKYXJyT2ZQYWlycy5wdXNoKCJNaXNzaW5nX0luZm9ybWF0aW9uX19jIiwgWChkb2MsICJYX01pc3NpbmdfSW5mb3JtYXRpb25fX2MiKSk7CmFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIiwgZG9jVHlwZSk7CmFyck9mUGFpcnMucHVzaCgiQXR0cmlidXRlc19MYXN0X01vZGlmaWVkX19jIiwgZm9ybWF0Tm93KTsKYXJyT2ZQYWlycy5wdXNoKCJBdHRyaWJ1dGVzX01vZGlmaWVkX0J5X19jIiwgZG9jLmtiRGF0YS5yZW1vdGVVc2VyKTsKYWxlcnQoIkBAQCB1cGRhdGluZyBuZXcgc3RhY2sgd2l0aCA6OiAiICsgYXJyT2ZQYWlycyk7CnVwZGF0ZVNGUmVjb3JkKGRvYywgIlpQQVBFUl9felN0YWNrX19jIiwgc2ZTdGFja0lkLCBhcnJPZlBhaXJzKTsKCgovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIGEgbmV3IENhc2UgcmVjb3JkLCBpZiBpdCB3YXNuJ3QgcGFzc2VkIGluICovCnZhciBwcmlvcml0eSA9IFgoZG9jLCAiWF9aUEFQRVJfX1ByaW9yaXR5X19jIik7IC8vRVJTMTcwNjI2CnZhciBjYXNlTnVtYmVyID0gIiI7CgovKiBNU0gxNzExMjkgIzQzNjQ5ICovCi8qIHRoaXMgaXMgdXNlZCBmb3IgYWxsIGNhc2VzLCBlaXRoZXIgY3JlYXRlZCBvciBleGlzdGluZyAqLwphcnJPZlBhaXJzID0gW107CmlmICgiQVBOOkFwcGxpY2F0aW9uIiA9PSBkb2NUeXBlKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlBTX0FwcGxpY2F0aW9uX1JlY2VpdmVkX0RhdGVfX2MiLCBkb2NDcmVhdGVkRGF0ZSArICIiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUFNfQXBwbGljYXRpb25fVHJpYWdlX0RhdGVfX2MiLCBmb3JtYXROb3cpOwp9IGVsc2UgaWYgKCJQUk46UHJlc2NyaXB0aW9uIiA9PSBkb2NUeXBlKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlBTX1ByZXNjcmlwdGlvbl9SZWNlaXZlZF9EYXRlX19jIiwgZG9jQ3JlYXRlZERhdGUgKyAiIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIlBTX1ByZXNjcmlwdGlvbl9UcmlhZ2VfRGF0ZV9fYyIsIGZvcm1hdE5vdyk7Cn0KCmFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBDYXNlOiAiICsgY2FzZUlkKTsKdmFyIG1pc3NpbmdJbmZvID0gWChkb2MsICJYX01pc3NpbmdfSW5mb3JtYXRpb25fX2MiKTsKaWYgKG1pc3NpbmdJbmZvICYmIG1pc3NpbmdJbmZvID09ICJ0cnVlIikgewogICAgLy9NU0gxNzA4MjggaWYgbWlzc2luZ0luZm8gPT0gdHJ1ZSwgc2V0IHN0YXR1cyB0byBJbmZvcm1hdGlvbiBSZWNlaXZlZAogICAgYXJyT2ZQYWlycy5wdXNoKCJTdGF0dXMiLCAiSW5mb3JtYXRpb24gUmVjZWl2ZWQiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUFNfTWlzc2luZ19JbmZvX3JlY2VpdmVkX19jIiwgZm9ybWF0Tm93KTsgLy9NU0gxNzA5MTIKfQoKLypBTjIwMTkwNzAyIEF1ZyAyMDE5IHNwcmludCByZXF1aXJlbWVudCAtIHNhdmUgelN0YWNrIElEIHdoZW4gZG9jIGlzIGluZGV4ZWQgdG8gQ2FzZQp0aGlzIGlzIHRlY2ggZGVidC4gTmVlZCB0byByZW1vdmUgdGhlIFNoaWVsZCB3b3JrYXJvdW5kIGFuZCBnbyBiYWNrIHRvIGNyZWF0aW5nIFBhdGllbnQKcmVjb3JkcyBkaXJlY3RseSBmcm9tIHRoZSBERSBwYW5lbAoqLwphcnJPZlBhaXJzLnB1c2goInpTdGFja19fYyIsIHNmU3RhY2tJZCk7IAoKLy9BTjIwMTkwNzAyIGZpZWxkIHpQYXBlcl9Jc19hdmFpbGFibGVfZm9yX3Vwc3RyZWFtX19jIGRvZXMgbm90IGV4aXN0LiBXaHkgaXMgdGhpcyBoZXJlPyBXYXMgdGhpcyBmaWVsZCBkZWxldGVkPwovL2Fyck9mUGFpcnMucHVzaCgielBhcGVyX0lzX2F2YWlsYWJsZV9mb3JfdXBzdHJlYW1fX2MiLCAndHJ1ZScpOyAvLyB1cGRhdGVkIGZpbGVkIGZvciBUSUJDTyBQVjAyMjcxOAovL2FsZXJ0KCJAQEAgelBhcGVyX0lzX2F2YWlsYWJsZV9mb3JfdXBzdHJlYW1fX2MiICsgYXJyT2ZQYWlycyApOyAKCmlmIChyZWNUeXBlTmFtZSA9PT0gIkNvbXBsZXRlIEludGFrZSIpeyAvL0FOMjAxOTAzMDUgdGhpcyBpcyBhIENvbXBsZXRlIEltbXVub2xvZ3kgY2FzZQogICAgYWxlcnQoIkBAQCBlbnRlcmluZyBDb21wbGV0ZSBJbW11bm9sb2d5IGxvZ2ljIik7CiAgICBhbGVydCgiQEBAIGRydWcgdHlwZSBpcyAiICsgWChkb2MsICJYX0RydWdfVHlwZV9fYyIpKTsKICAgIGFsZXJ0KCJAQEAgZW5yb2xsbWVudCBmb3JtIGlzICIgKyBYKGRvYywgIlhfUFNfRW5yb2xsbWVudEZvcm1WZXJzaW9uX19jIikpOwogICAgCiAgICBhcnJPZlBhaXJzLnB1c2goIlBTX1Byb2R1Y3ROYW1lX19jIiwgWChkb2MsICJYX0RydWdfVHlwZV9fYyIpKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUFNfRW5yb2xsbWVudEZvcm1WZXJzaW9uX19jIiwgWChkb2MsICJYX1BTX0Vucm9sbG1lbnRGb3JtVmVyc2lvbl9fYyIpKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUFNfRW5yb2xsbWVudEZvcm1WZXJzaW9uX19jIiwgWChkb2MsICJYX1BTX0Vucm9sbG1lbnRGb3JtVmVyc2lvbl9fYyIpKTsgLy9BTjIwMTkwMzA1IGNvcHkgdGhlIHZhbHVlIG9mIHRoZSBwYXJlbnQgc3RhY2ssIGlmIHRoZXJlIGlzIG9uZQoKfQoKdXBkYXRlU0ZSZWNvcmQoZG9jLCAiQ2FzZSIsIGNhc2VJZCwgYXJyT2ZQYWlycyk7Ci8vYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIGNhc2VJZCk7IC8vQU4yMDE5MDcwMyBjYXNlICM2MDc5NyBjbGllbnQgZG9lc24ndCB3YW50IGFuIEhUTSBhdHRhY2htZW50IG9uIHRoZSBDYXNlCgphcnJPZlBhaXJzID0gW107CmlmIChhdHRhY2hQYXRoLmluZGV4T2YoY2FzZUlkKSA9PSAtMSkgewogICAgYXR0YWNoUGF0aCArPSAiLCIgKyBjYXNlSWQ7Cn0KLy9pZiAocHJvdmlkZXJJZCAmJiBwcm92aWRlcklkLmxlbmd0aCA+IDApIHsKICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1Byb3ZpZGVyX19jIiwgcHJvdmlkZXJJZCk7CiAgICAvL2lmIChhdHRhY2hQYXRoLmluZGV4T2YocHJvdmlkZXJJZCk9PS0xKSB7IGF0dGFjaFBhdGgrPSIsIitwcm92aWRlcklkOyB9Ci8vfQppZiAocGF0aWVudElkICYmIHBhdGllbnRJZC5sZW5ndGggPiAwKSB7CgkvL0FOMjAxOTA3MDIgRGV0ZXJtaW5lIGlmIHRoZSBwYXRpZW50SWQgaXMgYSBDb250YWN0IG9yIGEgUGVyc29uIEFjY291bnQuIFRoaXMgaXMgdGVjaG5pY2FsIGRlYnQgYW5kIHdpbGwgbmVlZCB0byBiZSByZXdvcmtlZAoJaWYgKHBhdGllbnRJZC5zdGFydHNXaXRoKCIwMDEiKSkgewoJCWFyck9mUGFpcnMucHVzaCgiUGF0aWVudFJIX19jIiwgcGF0aWVudElkKTsKCX0KCWVsc2UgewoJCWFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50X19jIiwgcGF0aWVudElkKTsKCX0KICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YocGF0aWVudElkKSA9PSAtMSkgeyBhdHRhY2hQYXRoICs9ICIsIiArIHBhdGllbnRJZDsgfQp9CmlmIChjYXNlSWQgJiYgY2FzZUlkLmxlbmd0aCA+IDApIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DYXNlX19jIiwgY2FzZUlkKTsKfQp1cGRhdGVTRlJlY29yZChkb2MsICJaUEFQRVJfX3pTdGFja19fYyIsIHNmU3RhY2tJZCwgYXJyT2ZQYWlycyk7CmF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCBzZlN0YWNrSWQpOwphbGVydCgiQEBAIHVwZGF0ZWQgYW5kIGF0dGFjaGVkIHRvIHpTdGFjayBSZWNvcmQsIGlkID0gIiArIHNmU3RhY2tJZCk7CgovLyBsZXRzIGNyZWF0ZSB0aWZmIGltYWdlIGZvciBwZGYgaGVyZQphbGVydCgiQEBAIHRpZmYgZmxhZyAjIyMgPSAiICsgekRhdGEuZ2VuZXJhdGVUaWZmKTsKYWxlcnQoIkBAQCBwYWdlUmFuZ2UgIyMjID0gIiArIHBhZ2VSYW5nZSk7CnRpZmZTZklkID0gY2FzZUlkOwppZiAoekRhdGEuZ2VuZXJhdGVUaWZmKSB7IC8vQU4yMDE5MDcwMyB0aGlzIGFwcGVhcnMgdG8gYWx3YXlzIGV2YWx1YXRlIHRvIFRSVUUuIHRlY2ggZGVidC4KICAgIHZhciBhdHRhY2htZW50TmFtZSA9IGF0dGFjaExhYmVsOyAvL1BWMDIyNjE4CiAgICB2YXIgY2hpbGREb2NJZCA9IGRvYy5kYklEOyAvL1BWMDIyNjE4CiAgICBzZXREb2N1bWVudENvbnRleHQoZG9jLCBvcmdEb2NJZCk7CiAgICAvKiAgY3JlYXRlIGFuZCBhdHRhY2ggdGlmICovCiAgICAvKiBBdHRhY2ggZmlsZSBpbiBhZGRpdGlvbiB0byBlbnZlbG9wZSAqLwogICAgdmFyIG5vd1RpbWVTdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIiI7CiAgICAvL2ZvdW5kIGluIC96cGRhdGEvY29uZi93b3JrZmxvdy5wcm9wcwogICAgLy9hIGRpcmVjdG9yeSBpbiB3aGljaCB0byBkbyB0aGUgd29yawogICAgLy9pbnRlZ3JhdGlvbkRpcj0venBkYXRhL2FnZW50cy9tY2svaW50ZWdyYXRpb24vCiAgICBjcmVhdGVEaXJlY3RvcnkoZG9jLCB6RGF0YS51cGxvYWREaXIsIG5vd1RpbWVTdGFtcCk7CiAgIAogICAgLy9QYWdlIFJhbmdlIGNhbiBjb250YWluIG5vbi1udW1lcmljIGNoYXJhY3RlcnMgZnJvbSBQYWdlIFJvdGF0aW9uIGVnOiMjIyBwYWdlUmFuZ2UgIyMjMXUsMiw4LDcsNiw1LDQsMwogICAgLy9tYWtlIHN1cmUgcGFnZSByYW5nZSBhcnJheSBpcyBjbGVhcmVkIG9mIGFsbCBub24tbnVtZXJpYyBjaGFycwogICAgLy9NU0gxODA5MjQgZG9uJ3QgbmVlZCBtaW4gJiBtYXgsIGp1c3Qgc3RyaXAgb3V0IGFscGhhIGNoYXJzLgogICAgLy8gICAgICBwYXJzaW5nIGlzIGhhbmRsZWQgZG93bnN0cmVhbSBpbiBjb20ua25vd2xlZGdlYmluLlV0aWxzIHB1YmxpYyBzdGF0aWMgQ29sbGVjdGlvbjxJbnRlZ2VyPiBwYXJzZVBhZ2VzKFN0cmluZyBwYWdlcykKICAKICAgIC8vcmVnZXg6IGZpbmQgYWxsIGFscGhhIGNoYXJzIChbYS16XSksIGdsb2JhbGx5IChnKSwgYW5kIGNhc2UtaW5zZW5zaXRpdmUgKGkpCiAgICB2YXIgbm9BbHBoYVBhZ2VzID0gcGFnZVJhbmdlLnJlcGxhY2UoL1thLXpdL2dpLCAiIik7CiAgICBhbGVydCgiQEBAQEAgQ2FsbGluZyBzcGxpdCwgcGFnZXMgPSAiICsgbm9BbHBoYVBhZ2VzICsgIiwgbm93VGltZVN0YW1wID0gIiArIG5vd1RpbWVTdGFtcCk7CgogICAgLy9NU0gxODA5MjQgIzUyNDQwIHZhciByZXNwb25zZSA9IHNwbGl0UERGKGRvYywgbWluUGFnZSArICItIiArIG1heFBhZ2UsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wLCBkb2MuZGJJRCk7CiAgICB2YXIgcmVzcG9uc2UgPSBzcGxpdFBERihkb2MsIG5vQWxwaGFQYWdlcywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXAsIGRvYy5kYklEKTsKICAgIGFsZXJ0KCJAQEBAIHJlc3BvbnNlIGZyb20gc3BsaXRQREYgPSAiICsgcmVzcG9uc2UpOwogICAgdmFyIG5ld1BERk5hbWUgPSBYKGRvYywgIm5ld1BERiIsIHJlc3BvbnNlKTsKICAgIGFsZXJ0KCJAQEBAIHNwbGl0IFBERiBGaWxlTmFtZSA9ICIgKyBuZXdQREZOYW1lKTsKICAgIHZhciBuZXdUSUZGTmFtZSA9IHBkZjJ0aWZmKGRvYywgbmV3UERGTmFtZSk7CiAgICBhbGVydCgiQEBAQCBwZGYydGlmZiBGaWxlTmFtZSA9ICIgKyBuZXdUSUZGTmFtZSk7CiAgICB2YXIgbGFiZWwgPSBhdHRhY2htZW50TmFtZSArICIudGlmIjsKICAgIGlmIChuZXdUSUZGTmFtZS5pbmRleE9mKCJFUlJPUiIpICE9PSAwKSB7CiAgICAgICAgdmFyIHVwbG9hZFVSTCA9ICJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0ZpZD1ORVcmU0ZwaWQ9IiArIHRpZmZTZklkICsgIiZTRm9yZz0iICsgZG9jLnNmT3JnICsgIiZsYWJlbD0iICsgbGFiZWwgKyAiJnNlcnZlckZpbGU9IiArIG5ld1RJRkZOYW1lICsgIiZEZXNjcmlwdGlvbj1GaWxlIGF0dGFjaGVkIGJ5IHpQYXBlci4iOwogICAgICAgIGFsZXJ0KCJAQEAjIFVwbG9hZCBuYXRpdmUgUERGIHdpdGggIiArIHVwbG9hZFVSTCk7CiAgICAgICAgdmFyIHIgPSB3Z2V0KGRvYywgdXBsb2FkVVJMKTsKICAgICAgICBhbGVydCgiQEBAIyB0aWZmIGNyZWF0ZWQgYW5kIGF0dGFjaGVkIHRvOiAiICsgY2FzZUlkKTsKICAgICAgICBjbGVhbnVwRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwogICAgICAgIC8qIEZpbmFsbHksIGRlbGV0ZSB0aGUgd29yayBmb2xkZXIgYW5kIGFsbCBjb250ZW50cy4gKi8KICAgICAgICAvL01TSDE3MDIyMiBFUlMgd2FudHMgdG8ga2VlcCBjbGVhbnVwRGlyZWN0b3J5KGRvYywgImludGVncmF0aW9uRGlyIiwgbm93VGltZVN0YW1wKTsKICAgIH0KICAgIC8vTVNIMTgxMDA4IHNpbmNlIHdlIGNoYW5nZWQgdGhlIGRvYyBjb250ZXh0LCBjaGFuZ2UgaXQgYmFjawogICAgc2V0RG9jdW1lbnRDb250ZXh0KGRvYywgY2hpbGREb2NJZCk7Cn0KCi8qIE1TSDE3MTAxMyBub3QgdXNpbmcgZm9sZGVycyAqLwovKiBNb3ZlIHRoZSBzcGxpdCBkb2N1bWVudCB0byBpdHMgcHJvY2Vzc2luZyBmb2xkZXIgKi8KLyogYWxlcnQoIkBAQEBAQCBNb3ZpbmcgdGhlIGluZGV4ZWQgcGFnZXMgZG9jdW1lbnQgaW50byBuZXh0IHByb2Nlc3NpbmcgZm9sZGVyOiAiICsgbmV4dEZvbGRlcik7CiAqIG1vdmVEb2N1bWVudChkb2MsICIiLCBuZXh0Rm9sZGVyKTsKICogcmVsb2FkQnlCQVRFUyhkb2MsIG5leHRGb2xkZXIpOyAvL0VSUzE3MDQxMyAjMzUyOTEKICovCi8qIFBsYWNlIHRoZSBzcGxpdCBkb2N1bWVudCBpbnRvIHRoZSBzdGFjayBmb2xkZXIgKi8KLyogYWxlcnQoIkBAQEBAQCBNb3ZpbmcgdGhlIGluZGV4ZWQgcGFnZXMgZG9jdW1lbnQgaW50byB0aGUgZmluYWwgc3RhY2sgZm9sZGVyOiAiICsgc3RhY2tGb2xkZXIpOwogKiBtb3ZlRG9jdW1lbnQoZG9jLCAiIiwgc3RhY2tGb2xkZXIpOwogKiB1bmxvY2tEb2N1bWVudChkb2MpOwogKi8KCmFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld2VkU3RhdHVzIiwgIkluZGV4ZWQiKTsKLyogQ1JOMTYwODI1IFNldCB0aGUgcGFnZSBjb3VudCBzbyB0aGF0IGl0IGRvZXMgbm90IGhhdmUgdGhlIHBhcmVudCBwYWdlIGNvdW50ICovCiBwYWdlQ291bnQgPSB6RGF0YS5jb3VudFBhZ2VzKGRvYywgcGFnZVJhbmdlKTsKYWxlcnQoIkBAQEAgcGFnZUNvdW50ID0gIiArIHBhZ2VDb3VudCk7CmFyck9mUGFpcnMucHVzaCgiWF9wYWdlcyIsIHBhZ2VDb3VudCk7CmFyck9mUGFpcnMucHVzaCgiWF9kb2NUeXBlIiwgZG9jVHlwZSk7IC8qIE1TSDE3MDkyNyBnZXQgYWxsIHRoZSBkb2NUeXBlcyBhbGlnbmVkICovCmFyck9mUGFpcnMucHVzaCgiZGItcGFnZXMiLCBwYWdlQ291bnQpOwppZiAoIXBhdGllbnRGaXJzdE5hbWUgfHwgMCA9PT0gcGF0aWVudEZpcnN0TmFtZS5sZW5ndGgpIHsgcGF0aWVudEZpcnN0TmFtZSA9ICJVbmtub3duIjsgfQppZiAoIXBhdGllbnRMYXN0TmFtZSB8fCAwID09PSBwYXRpZW50TGFzdE5hbWUubGVuZ3RoKSB7IHBhdGllbnRMYXN0TmFtZSA9ICJOYW1lIjsgfQovKiBNU0gxNzA4MTggYXJyT2ZQYWlycy5wdXNoKCJkYi1sYWJlbCIsIHBhdGllbnRGaXJzdE5hbWUgKyBwYXRpZW50TGFzdE5hbWUgKyAiIC0gIiArIGNvbXBhbnlDb2RlICsgIiAtICIgKyBzdGFja0lkKTsgKi8KLyogRVJTMTcwODI5IG5hbWVGaWxlIGRvZXMgaXQgYXJyT2ZQYWlycy5wdXNoKCJkYi1sYWJlbCIsIHBhdGllbnRGaXJzdE5hbWUgKyBwYXRpZW50TGFzdE5hbWUgKyAiIC0gIiArIGRvYy5kZWxpdmVyZWRUbyArICIgLSAiICsgc3RhY2tJZCk7ICovCmFyck9mUGFpcnMucHVzaCgiWF9hdHRhY2hlZFRvIiwgYXR0YWNoUGF0aCk7IC8vRVJTMTcwNjI4CmFyck9mUGFpcnMucHVzaCgiWF9aUEFQRVJfX0Nhc2VfX2MiLCBjYXNlSWQpOyAvL01TSDE3MDgyOAphcnJPZlBhaXJzLnB1c2goIlhfWlBBUEVSX19DYXNlX19yLkNhc2VOdW1iZXIiLCBjYXNlTnVtYmVyKTsgLy9NU0gxNzA4MjgKYXJyT2ZQYWlycy5wdXNoKCJYX1pQQVBFUl9fUGF0aWVudF9fYyIsIHBhdGllbnRJZCk7IC8vTVNIMTcwODI4CmFyck9mUGFpcnMucHVzaCgiWF9aUEFQRVJfX1BhdGllbnRfX3IuTmFtZSIsIHBhdGllbnRGaXJzdE5hbWUgKyAiICIgKyBwYXRpZW50TGFzdE5hbWUpOyAvL01TSDE3MDgyOAphcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgYXR0YWNoTGFiZWwpOyAvL0NSTjE3MTEwMgoKLy9DUk4xODA3MjYgQ2FzZSAjNTA0NjkgLS0gU2V0IHRoZSAiSW5kZXhlZCIgY2hlY2tib3gKdmFyIGJhID0gIkluZGV4ZWQiOyAvL0pQQjE4MDYwNSBiZWNhdXNlIHdlIGNoYW5nZWQgdGhlIG5hbWUgb2YgdGhlIGJ1dHRvbiBmcm9tIEluZGV4ZWQgdG8gU2F2ZQp2YXIgbm93MCA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYyxmYWxzZSx0cnVlKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld2VkU3RhdHVzIixiYSk7Ci8vYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld3MiLFgoZG9jLCJYX3Jldmlld3MiKStiYSsiIGJ5ICIrZG9jLmtiRGF0YS5yZW1vdGVVc2VyKyIgYXQgIitub3cwKyI8YnIvPiIpOyAvL0VSUzE3MDkwOSAjNDA1OTIKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld3MiLCJSZWNlaXZlZCBieSAiK2RvYy5rYkRhdGEucmVtb3RlVXNlcisiIGF0ICIrbm93MCsiPGJyLz4iK2JhKyIgYnkgIitkb2Mua2JEYXRhLnJlbW90ZVVzZXIrIiBhdCAiK25vdzArIjxici8+Iik7IC8vUFYxOTA0MjAgdXBkYXRlZCBmb3IgZG9jIHNldCBjb21wb25lbnRzIHRvIGNoZWNrCnVwZGF0ZURCKGRvYywgYXJyT2ZQYWlycyk7Cgp0cmFjayhkb2MsICJEb2MgSW5kZXhlZCAiLCAiRG9jdW1lbnQgd2l0aCBJZDogIiArIGRvYy5kYklELCBwYWdlQ291bnQpOwphZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIm5leHRQYWdlKH5yZWFkeX4pO3VwZGF0ZURFU3RhdHVzKH5pbmRleGVkOiIgKyBwYWdlUmFuZ2UgKyAifik7Iik7Ci8qIGVuZCBvZiBydWxlICov"},"ordinal":13}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
//this is a copy and update of the existing Index Page rule. Temp use for Shield Encryption testing
alert("@@@@ Index Encrypted Rule Fired @@@#");
/* double-quote, newline characters */
var dq = String.fromCharCode(34);
var nl = String.fromCharCode(10);
var formatNow = getCurDateAndTime(doc);
/* MSH171130 #43649 created date for original doc */
var docCreatedDate = gmtFormatted(doc, "created");
var attachPath = X(doc, "X_attachedTo");
var patientFirstName = "";
var patientLastName = "";
var patientDOB = "";
var patientId = "";
var tiffSfId="";
var stackId = X(doc, "X_stack"); //zPaper dbID
var sfStackId = X(doc, "X_sfStackId");
var orgDocId = doc.dbID;  //PV022618
if (sfStackId === "") { //ERS170731 #40593
    /* MSH170814 this doesn't do anything useful X(doc, "X_attachedTo"); */
    /* MSH171129 we already got attachPath, use it sfStackId = X(doc, "X_attachedTo"); */
    sfStackId = attachPath;
    if (sfStackId.lastIndexOf('/') >= 0) {
        sfStackId = sfStackId.substring(sfStackId.lastIndexOf('/') + 1);
        if (sfStackId.indexOf(',') >= 0) { sfStackId = sfStackId.substring(0, sfStackId.indexOf(',')); }
    }
}
alert("@@@ Currently attached to ZPAPER__zStack__c with sfStackId: " + sfStackId);

//AN20180716 for code review - are these variables and IF statement still needed, since we are no longer user folders?
var originalSfStackId = sfStackId;
alert("@@@ originalSfStackId = " + originalSfStackId);
var stackFolder = stackId + "-STACK";
/* Clear the trigger that invoked this rule */
zData.clearTriggerCondition(doc, "X_buttonAction");
var indexInitialized = X(doc, "X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    /* MSH170814 mismatched param list */
    /* zData.initializeStack(doc, stackFolder, companyCode, stackId); */
    zData.initializeStack(doc, stackFolder, stackId);
}

var caseId = X(doc, "X_ZPAPER__Case__c");
alert("@@@ caseId = " + caseId);

var caseFlds = getSFFields(doc, "Case", "RecordTypeId,ContactId,AccountId", null, caseId); //AN20180718 get the fields from the Case that we will need

var recTypeId = X(doc, "RecordTypeId", caseFlds);
var recTypeName = getSFField(doc, "RecordType", "Name", null, recTypeId); //AN20180718 get the name of the current Case record type

alert("@@@ current Case Record Type Name: " + recTypeName);

//AN20180718 added this logic to differentiate between PAP and RH cases
if (recTypeName === "New/Renewal/YEC/On-going Prescription"){ //this is a PAP case
    alert("@@@ getting PAP Case details");

    //MSH180515 #48302 try getSFField
    //var patientId = getSFField(doc, "Case", "ContactId", null, caseId);
    
    patientId =  X(doc, "ContactId", caseFlds); //get the Contact ID since PAP uses the Contact object for Patients
    
    var contactFlds = getSFFields(doc, "Contact", "FirstName,LastName,Birthdate", null, patientId); //MSH170818 added Birthdate
    alert("@@@ calling SF for contactFlds :: " + contactFlds);
    patientFirstName = X(doc, "FirstName", contactFlds);
    patientLastName = X(doc, "LastName", contactFlds);
    patientDOB = X(doc, "Birthdate", contactFlds);

}
else if (recTypeName === "Benefit Verification" || recTypeName === "Denial Support" || recTypeName === "Complete Intake"){ //AN20190305 this is an RH-Immunology case or a Complete Immunology case
    alert("@@@ getting RH or Complete Immunology Case details");
    
    //AN20180725 there is confusion over whether we should use the lookup PS_Account__c or the standard AccountId field on Case. Awaiting clarification from Abbvie
    //patientId = X(doc, "PS_Account__c", caseFlds); //get the Account ID since RH uses the Account object for Patients
    patientId = X(doc, "AccountId", caseFlds); //get the Account ID since RH uses the Account object for Patients
    
    var accountFlds = getSFFields(doc, "Account", "PS_PatientFirstName__c,PS_PatientLastName__c,PS_DOB__c", null, patientId); 
    alert("@@@ calling SF for accountFlds :: " + accountFlds);
    patientFirstName = X(doc, "PS_PatientFirstName__c", accountFlds);
    patientLastName = X(doc, "PS_PatientLastName__c", accountFlds);
    patientDOB = X(doc, "PS_DOB__c", accountFlds);
}

alert("@@@ patientId :: " + patientId);
alert("@@@ patientFirstName :: " + patientFirstName);
alert("@@@ patientLastName :: " + patientLastName);
alert("@@@ patientDOB :: " + patientDOB);

var MMddYYYY = zData.formatTodayMMddYYYY();
/*MSH171129 we already got docType, use it attachLabel = patientFirstName + patientLastName + " - " + X(doc,"X_ZPAPER__faxType__c") + " - " + MMddYYYY;*/
attachLabel = patientFirstName + patientLastName + " - " + docType + " - " + MMddYYYY;

/* Get the document type (will be used to route to next folder) */
var docType = X(doc, "X_docType");
var attachLabel = ""; /* MSH170818 format should be "Patient Name - Doc Type - Date" */
var masterID = (doc.kbData.groupID).substring(1,(doc.kbData.groupID).length()); //get the zPaper Master ID
var nextFolder = masterID + "Triage-S2";              /* Other folder is the default */
var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
updateDB(doc, arrOfPairs);

/* SPLIT OFF NEW SNIPPET HERE */
var pageRange = X(doc, "X_idxPages");
alert("@@@ pageRange = " + pageRange);
var arrOfPairs1 = []; //PV280319 updated for copy on split
var pageCount =zData.countPages(doc, pageRange);
//var pageRange = "1-" + pageCount;
    alert("@@@ pageRange === " + pageRange);
    if(recTypeName === "Complete Intake"){
      var buffer = "";
    for (var i=1; i<=pageCount; i++) {
        var curTime = new Date().getTime();
        buffer += "kbm('IMG" + curTime + "','PAGE" + i + "IMG" + curTime + "','addText',10,1,875,1480,'COPY','24px');";
    }
    
    alert("@@@@ MARKUP = " + buffer);   
    //arrOfPairs1.push("X_markup", buffer);  
    }
    
var newDbId = splitDocumentForIndex(doc, "index", pageRange,arrOfPairs1);
alert("@@@ after splitDocumentForIndex");
/* alert("@@@ Case '" + caseId + "' and len = " + caseId.length); */
//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/* MSH171115 #43613 */
/*alert("@@@ newDbId = " + newDbId);
 setDocumentContext(doc, newDbId);*/

docType = X(doc, "X_ZPAPER__faxType__c");
zData.docType = docType;
attachLabel = zData.nameFile(doc); //ERS170829 #41298
alert("@@@ patientId from X_ZPAPER__Patient__c = " + patientId);

alert("@@@ X_ZPAPER__Patient__r.Name :: " + X(doc, "X_ZPAPER__Patient__r.Name"));

/*MSH171129 we already got docType, use it attachLabel = patientFirstName + patientLastName + " - " + X(doc,"X_ZPAPER__faxType__c") + " - " + MMddYYYY;*/
attachLabel = patientFirstName + patientLastName + " - " + docType + " - " + MMddYYYY;

//MSH170829 clear out the "New Patient" fields
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + patientFirstName + dq + "); ");
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + patientLastName + dq + "); ");
//addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + patientDOB + dq + "); ");

//AN20180718 added this logic to differentiate between PAP and RH cases
if (recTypeName === "New/Renewal/YEC/On-going Prescription"){ //this is a PAP case, so we update the Contact lookup Patient__c on zStack
    alert("@@@ setting DE panel fields for for PAP case");
    //MSH170829 set the Patient lookup fields
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c" + dq + ").val(" + dq + patientId + dq + "); ");


}
else if (recTypeName === "Benefit Verification" || recTypeName === "Denial Support" || recTypeName === "Complete Intake"){ //AN20190305 this is an RH-Immunology case or a Complete Immunology, so we update the Account lookup PatientRH__c on zStack
    alert("@@@ setting DE panel fields for RH case or Complete Immunology case");
    addPostExecutionScript(doc, " $(" + dq + "#PatientRH__c" + dq + ").val(" + dq + patientId + dq + "); ");
}

//MSH170829 set the Patient lookup fields
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + patientFirstName + " " + patientLastName + dq + "); ");

// update stack
alert("@@@ ready to update StackID = " + stackId); //MSH170926
alert("@@@ setting patient field on StackID = " + stackId + ", Patient = " + patientId);
arrOfPairs = [];

arrOfPairs.push("ZPAPER__FirstName__c", patientFirstName);
arrOfPairs.push("ZPAPER__LastName__c", patientLastName);
if (patientDOB && patientDOB.length > 0) {
    arrOfPairs.push("ZPAPER__Birthdate__c", patientDOB);
}

arrOfPairs.push("Drug_Type__c", X(doc, "X_Drug_Type__c"));
arrOfPairs.push("Missing_Information__c", X(doc, "X_Missing_Information__c"));
arrOfPairs.push("ZPAPER__faxType__c", docType);
arrOfPairs.push("Attributes_Last_Modified__c", formatNow);
arrOfPairs.push("Attributes_Modified_By__c", doc.kbData.remoteUser);
alert("@@@ updating new stack with :: " + arrOfPairs);
updateSFRecord(doc, "ZPAPER__zStack__c", sfStackId, arrOfPairs);


/* Attach the split document to a new Case record, if it wasn't passed in */
var priority = X(doc, "X_ZPAPER__Priority__c"); //ERS170626
var caseNumber = "";

/* MSH171129 #43649 */
/* this is used for all cases, either created or existing */
arrOfPairs = [];
if ("APN:Application" == docType) {
    arrOfPairs.push("PS_Application_Received_Date__c", docCreatedDate + "");
    arrOfPairs.push("PS_Application_Triage_Date__c", formatNow);
} else if ("PRN:Prescription" == docType) {
    arrOfPairs.push("PS_Prescription_Received_Date__c", docCreatedDate + "");
    arrOfPairs.push("PS_Prescription_Triage_Date__c", formatNow);
}

alert("@@@@ attaching to existing Case: " + caseId);
var missingInfo = X(doc, "X_Missing_Information__c");
if (missingInfo && missingInfo == "true") {
    //MSH170828 if missingInfo == true, set status to Information Received
    arrOfPairs.push("Status", "Information Received");
    arrOfPairs.push("PS_Missing_Info_received__c", formatNow); //MSH170912
}

/*AN20190702 Aug 2019 sprint requirement - save zStack ID when doc is indexed to Case
this is tech debt. Need to remove the Shield workaround and go back to creating Patient
records directly from the DE panel
*/
arrOfPairs.push("zStack__c", sfStackId); 

//AN20190702 field zPaper_Is_available_for_upstream__c does not exist. Why is this here? Was this field deleted?
//arrOfPairs.push("zPaper_Is_available_for_upstream__c", 'true'); // updated filed for TIBCO PV022718
//alert("@@@ zPaper_Is_available_for_upstream__c" + arrOfPairs ); 

if (recTypeName === "Complete Intake"){ //AN20190305 this is a Complete Immunology case
    alert("@@@ entering Complete Immunology logic");
    alert("@@@ drug type is " + X(doc, "X_Drug_Type__c"));
    alert("@@@ enrollment form is " + X(doc, "X_PS_EnrollmentFormVersion__c"));
    
    arrOfPairs.push("PS_ProductName__c", X(doc, "X_Drug_Type__c"));
    arrOfPairs.push("PS_EnrollmentFormVersion__c", X(doc, "X_PS_EnrollmentFormVersion__c"));
    arrOfPairs.push("PS_EnrollmentFormVersion__c", X(doc, "X_PS_EnrollmentFormVersion__c")); //AN20190305 copy the value of the parent stack, if there is one

}

updateSFRecord(doc, "Case", caseId, arrOfPairs);
//attach(doc, attachLabel, caseId); //AN20190703 case #60797 client doesn't want an HTM attachment on the Case

arrOfPairs = [];
if (attachPath.indexOf(caseId) == -1) {
    attachPath += "," + caseId;
}
//if (providerId && providerId.length > 0) {
    //arrOfPairs.push("ZPAPER__Provider__c", providerId);
    //if (attachPath.indexOf(providerId)==-1) { attachPath+=","+providerId; }
//}
if (patientId && patientId.length > 0) {
	//AN20190702 Determine if the patientId is a Contact or a Person Account. This is technical debt and will need to be reworked
	if (patientId.startsWith("001")) {
		arrOfPairs.push("PatientRH__c", patientId);
	}
	else {
		arrOfPairs.push("ZPAPER__Patient__c", patientId);
	}
    if (attachPath.indexOf(patientId) == -1) { attachPath += "," + patientId; }
}
if (caseId && caseId.length > 0) {
    arrOfPairs.push("ZPAPER__Case__c", caseId);
}
updateSFRecord(doc, "ZPAPER__zStack__c", sfStackId, arrOfPairs);
attach(doc, attachLabel, sfStackId);
alert("@@@ updated and attached to zStack Record, id = " + sfStackId);

// lets create tiff image for pdf here
alert("@@@ tiff flag ### = " + zData.generateTiff);
alert("@@@ pageRange ### = " + pageRange);
tiffSfId = caseId;
if (zData.generateTiff) { //AN20190703 this appears to always evaluate to TRUE. tech debt.
    var attachmentName = attachLabel; //PV022618
    var childDocId = doc.dbID; //PV022618
    setDocumentContext(doc, orgDocId);
    /*  create and attach tif */
    /* Attach file in addition to envelope */
    var nowTimeStamp = new Date().getTime() + "";
    //found in /zpdata/conf/workflow.props
    //a directory in which to do the work
    //integrationDir=/zpdata/agents/mck/integration/
    createDirectory(doc, zData.uploadDir, nowTimeStamp);
   
    //Page Range can contain non-numeric characters from Page Rotation eg:### pageRange ###1u,2,8,7,6,5,4,3
    //make sure page range array is cleared of all non-numeric chars
    //MSH180924 don't need min & max, just strip out alpha chars.
    //      parsing is handled downstream in com.knowledgebin.Utils public static Collection<Integer> parsePages(String pages)
  
    //regex: find all alpha chars ([a-z]), globally (g), and case-insensitive (i)
    var noAlphaPages = pageRange.replace(/[a-z]/gi, "");
    alert("@@@@@ Calling split, pages = " + noAlphaPages + ", nowTimeStamp = " + nowTimeStamp);

    //MSH180924 #52440 var response = splitPDF(doc, minPage + "-" + maxPage, zData.uploadDir, nowTimeStamp, doc.dbID);
    var response = splitPDF(doc, noAlphaPages, zData.uploadDir, nowTimeStamp, doc.dbID);
    alert("@@@@ response from splitPDF = " + response);
    var newPDFName = X(doc, "newPDF", response);
    alert("@@@@ split PDF FileName = " + newPDFName);
    var newTIFFName = pdf2tiff(doc, newPDFName);
    alert("@@@@ pdf2tiff FileName = " + newTIFFName);
    var label = attachmentName + ".tif";
    if (newTIFFName.indexOf("ERROR") !== 0) {
        var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFid=NEW&SFpid=" + tiffSfId + "&SForg=" + doc.sfOrg + "&label=" + label + "&serverFile=" + newTIFFName + "&Description=File attached by zPaper.";
        alert("@@@# Upload native PDF with " + uploadURL);
        var r = wget(doc, uploadURL);
        alert("@@@# tiff created and attached to: " + caseId);
        cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);
        /* Finally, delete the work folder and all contents. */
        //MSH170222 ERS wants to keep cleanupDirectory(doc, "integrationDir", nowTimeStamp);
    }
    //MSH181008 since we changed the doc context, change it back
    setDocumentContext(doc, childDocId);
}

/* MSH171013 not using folders */
/* Move the split document to its processing folder */
/* alert("@@@@@@ Moving the indexed pages document into next processing folder: " + nextFolder);
 * moveDocument(doc, "", nextFolder);
 * reloadByBATES(doc, nextFolder); //ERS170413 #35291
 */
/* Place the split document into the stack folder */
/* alert("@@@@@@ Moving the indexed pages document into the final stack folder: " + stackFolder);
 * moveDocument(doc, "", stackFolder);
 * unlockDocument(doc);
 */

arrOfPairs = [];
arrOfPairs.push("X_reviewedStatus", "Indexed");
/* CRN160825 Set the page count so that it does not have the parent page count */
 pageCount = zData.countPages(doc, pageRange);
alert("@@@@ pageCount = " + pageCount);
arrOfPairs.push("X_pages", pageCount);
arrOfPairs.push("X_docType", docType); /* MSH170927 get all the docTypes aligned */
arrOfPairs.push("db-pages", pageCount);
if (!patientFirstName || 0 === patientFirstName.length) { patientFirstName = "Unknown"; }
if (!patientLastName || 0 === patientLastName.length) { patientLastName = "Name"; }
/* MSH170818 arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + stackId); */
/* ERS170829 nameFile does it arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + doc.deliveredTo + " - " + stackId); */
arrOfPairs.push("X_attachedTo", attachPath); //ERS170628
arrOfPairs.push("X_ZPAPER__Case__c", caseId); //MSH170828
arrOfPairs.push("X_ZPAPER__Case__r.CaseNumber", caseNumber); //MSH170828
arrOfPairs.push("X_ZPAPER__Patient__c", patientId); //MSH170828
arrOfPairs.push("X_ZPAPER__Patient__r.Name", patientFirstName + " " + patientLastName); //MSH170828
arrOfPairs.push("db-label", attachLabel); //CRN171102

//CRN180726 Case #50469 -- Set the "Indexed" checkbox
var ba = "Indexed"; //JPB180605 because we changed the name of the button from Indexed to Save
var now0 = getCurDateAndTime(doc,false,true);
arrOfPairs.push("X_reviewedStatus",ba);
//arrOfPairs.push("X_reviews",X(doc,"X_reviews")+ba+" by "+doc.kbData.remoteUser+" at "+now0+"<br/>"); //ERS170909 #40592
arrOfPairs.push("X_reviews","Received by "+doc.kbData.remoteUser+" at "+now0+"<br/>"+ba+" by "+doc.kbData.remoteUser+" at "+now0+"<br/>"); //PV190420 updated for doc set components to check
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed ", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");
/* end of rule */
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
ZnVuY3Rpb24gekluc3RhbGwoKSB7IC8vRVJTMTcwNzIyIHNldCBvbiB0aGUgaW1wb3J0CiAgICAkKCJbbmFtZT0nZGItQkFURVMnXSIpLnZhbCgiIik7CiAgICAkKCIjWF9idXR0b25BY3Rpb25zIikudmFsKCJJbmRleCBFbmNyeXB0ZWQsSW5kZXgsSWdub3JlLFJlamVjdCxTdGFjayBDb21wbGV0ZSIpOwogICAgJCgiI1hfZm9sZGVyRm9ybXMiKS52YWwoIjIwMjAwMjAxNzQ0MTIwNzQ0MDNfRGF0YTJfV2ViX0Zvcm0iKTsgLy9FUlMxNzA4MjIKfSAvL0VSUzE3MDcyMiBlbmQgb2YgZnVuY3Rpb24KCmZ1bmN0aW9uIGRvVmFsaWRhdGlvbigpIHsKICAgIHZhciByZXFCdWZmZXIgPSAiIjsKCiAgICB2YXIgbj0iWF9aUEFQRVJfX2ZheFR5cGVfX2MiOwogICAgdmFyIGw9IkRvY3VtZW50IFR5cGUiOwogICAgdmFyIGU9JCgnW25hbWU9IicrbisnIl0nKTsKICAgIGlmICghZS52YWwoKSB8fCAwID09PSBlLnZhbCgpLmxlbmd0aCB8fCAiRE9OT1RfU0FWRSIgPT09IGUudmFsKCkpIHsKICAgICAgICBlLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIHJlZCcpOwogICAgICAgIGlmIChyZXFCdWZmZXIubGVuZ3RoID4gMCkgeyByZXFCdWZmZXIgKz0gIiwgIjsgfQogICAgICAgIHJlcUJ1ZmZlciArPSBsOwogICAgfSBlbHNlIHsKICAgICAgICBlLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIGdyZWVuJyk7CiAgICB9CgogICAgbj0iWF9aUEFQRVJfX0Nhc2VfX2MiOwogICAgbD0iQ2FzZSI7CiAgICBlPSQoJ1tuYW1lPSInK24rJyJdJyk7CiAgICBpZiAoIWUudmFsKCkgfHwgMCA9PT0gZS52YWwoKS5sZW5ndGggfHwgIkRPTk9UX1NBVkUiID09PSBlLnZhbCgpKSB7CiAgICAgICAgZS5jc3MoJ2JvcmRlcicsJzNweCBzb2xpZCByZWQnKTsKICAgICAgICBpZiAocmVxQnVmZmVyLmxlbmd0aCA+IDApIHsgcmVxQnVmZmVyICs9ICIsICI7IH0KICAgICAgICByZXFCdWZmZXIgKz0gbDsKICAgIH0gZWxzZSB7CiAgICAgICAgZS5jc3MoJ2JvcmRlcicsJzNweCBzb2xpZCBncmVlbicpOwogICAgfQoKICAgIC8vdmFyIGNhc2VJZCA9ICQoJ1tuYW1lPSJYX1pQQVBFUl9fQ2FzZV9fYyJdJykudmFsKCk7CiAgICAvL0VSUzE3MDcyNyBkZWJ1ZyBvbmx5IGFsZXJ0KCJDYXNlICIrY2FzZUlkKTsKCiAgICB2YXIgcGF0aWVudE5hbWUgPSAkKCdbbmFtZT0iWF9aUEFQRVJfX1BhdGllbnRfX3IuTmFtZSJdJykudmFsKCk7CiAgICB2YXIgZm49JCgnW25hbWU9IlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiXScpOwogICAgdmFyIGxuPSQoJ1tuYW1lPSJYX1pQQVBFUl9fTGFzdE5hbWVfX2MiXScpOwogICAgaWYgKHBhdGllbnROYW1lKSB7CiAgICAgICAgZm4udmFsKHBhdGllbnROYW1lLnNwbGl0KCIgIilbMF0pOwogICAgICAgIGxuLnZhbChwYXRpZW50TmFtZS5zcGxpdCgiICIpWzFdKTsKICAgIH0KCiAgICBpZiAocmVxQnVmZmVyLmxlbmd0aCA+IDApIHsKICAgICAgICBhbGVydCgiRVJST1I6IFRoZSBmb2xsb3dpbmcgZmllbGRzIGFyZSByZXF1aXJlZDogIiArIHJlcUJ1ZmZlcik7CiAgICAgICAgcmV0dXJuIGZhbHNlOyAgIC8vQ1JOMTcwNzE5IG9uZSBvciBtb3JlIGZpZWxkIGlzIG1pc3NpbmcsIGRvbid0IHNlbmQgdG8gdGhlIHJ1bGVzIGVuZ2luZQogICAgfQogICAgcmV0dXJuIHRydWU7ICAgICAgICAvL0NSTjE3MDcxOSBBbGwgcmVxdWlyZWQgZmllbGRzIGhhdmUgYmVlbiBzdXBwbGllZCwgbGV0IHRoZSBydWxlcyBlbmdpbmUgYmUgbm90aWZpZWQKfQoKcmV0dXJuIGRvVmFsaWRhdGlvbigpOwo=
//--- RULE VALIDATION CODE - END ---

</script>
