<!--
// Name: Index Page Encrypted
// Committer: Prathyusha.vasireddy2zpaper.com
// Update: updated
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2019-05-29 17:44:47","active":true,"button":"Index","name":"Index Page Encrypted","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Index","operation":"equals"}]},"consequence":{"doit":"Ly90aGlzIGlzIGEgY29weSBhbmQgdXBkYXRlIG9mIHRoZSBleGlzdGluZyBJbmRleCBQYWdlIHJ1bGUuIFRlbXAgdXNlIGZvciBTaGllbGQgRW5jcnlwdGlvbiB0ZXN0aW5nCmFsZXJ0KCJAQEBAIEluZGV4IEVuY3J5cHRlZCBSdWxlIEZpcmVkIEBAQCMiKTsKLyogZG91YmxlLXF1b3RlLCBuZXdsaW5lIGNoYXJhY3RlcnMgKi8KdmFyIGRxID0gU3RyaW5nLmZyb21DaGFyQ29kZSgzNCk7CnZhciBubCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoMTApOwp2YXIgZm9ybWF0Tm93ID0gZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKCi8vaGVyZSBpcyBhbm90aGVyIHNpbGx5IGNvbW1lbnQKCi8qIE1TSDE3MTEzMCAjNDM2NDkgY3JlYXRlZCBkYXRlIGZvciBvcmlnaW5hbCBkb2MgKi8KdmFyIGRvY0NyZWF0ZWREYXRlID0gZ210Rm9ybWF0dGVkKGRvYywgImNyZWF0ZWQiKTsKdmFyIGF0dGFjaFBhdGggPSBYKGRvYywgIlhfYXR0YWNoZWRUbyIpOwp2YXIgcGF0aWVudEZpcnN0TmFtZSA9ICIiOwp2YXIgcGF0aWVudExhc3ROYW1lID0gIiI7CnZhciBwYXRpZW50RE9CID0gIiI7CnZhciBwYXRpZW50SWQgPSAiIjsKdmFyIHRpZmZTZklkPSIiOwp2YXIgc3RhY2tJZCA9IFgoZG9jLCAiWF9zdGFjayIpOyAvL3pQYXBlciBkYklECnZhciBzZlN0YWNrSWQgPSBYKGRvYywgIlhfc2ZTdGFja0lkIik7CnZhciBvcmdEb2NJZCA9IGRvYy5kYklEOyAgLy9QVjAyMjYxOAppZiAoc2ZTdGFja0lkID09PSAiIikgeyAvL0VSUzE3MDczMSAjNDA1OTMKICAgIC8qIE1TSDE3MDgxNCB0aGlzIGRvZXNuJ3QgZG8gYW55dGhpbmcgdXNlZnVsIFgoZG9jLCAiWF9hdHRhY2hlZFRvIik7ICovCiAgICAvKiBNU0gxNzExMjkgd2UgYWxyZWFkeSBnb3QgYXR0YWNoUGF0aCwgdXNlIGl0IHNmU3RhY2tJZCA9IFgoZG9jLCAiWF9hdHRhY2hlZFRvIik7ICovCiAgICBzZlN0YWNrSWQgPSBhdHRhY2hQYXRoOwogICAgaWYgKHNmU3RhY2tJZC5sYXN0SW5kZXhPZignLycpID49IDApIHsKICAgICAgICBzZlN0YWNrSWQgPSBzZlN0YWNrSWQuc3Vic3RyaW5nKHNmU3RhY2tJZC5sYXN0SW5kZXhPZignLycpICsgMSk7CiAgICAgICAgaWYgKHNmU3RhY2tJZC5pbmRleE9mKCcsJykgPj0gMCkgeyBzZlN0YWNrSWQgPSBzZlN0YWNrSWQuc3Vic3RyaW5nKDAsIHNmU3RhY2tJZC5pbmRleE9mKCcsJykpOyB9CiAgICB9Cn0KYWxlcnQoIkBAQCBDdXJyZW50bHkgYXR0YWNoZWQgdG8gWlBBUEVSX196U3RhY2tfX2Mgd2l0aCBzZlN0YWNrSWQ6ICIgKyBzZlN0YWNrSWQpOwoKLy9BTjIwMTgwNzE2IGZvciBjb2RlIHJldmlldyAtIGFyZSB0aGVzZSB2YXJpYWJsZXMgYW5kIElGIHN0YXRlbWVudCBzdGlsbCBuZWVkZWQsIHNpbmNlIHdlIGFyZSBubyBsb25nZXIgdXNlciBmb2xkZXJzPwp2YXIgb3JpZ2luYWxTZlN0YWNrSWQgPSBzZlN0YWNrSWQ7CmFsZXJ0KCJAQEAgb3JpZ2luYWxTZlN0YWNrSWQgPSAiICsgb3JpZ2luYWxTZlN0YWNrSWQpOwp2YXIgc3RhY2tGb2xkZXIgPSBzdGFja0lkICsgIi1TVEFDSyI7Ci8qIENsZWFyIHRoZSB0cmlnZ2VyIHRoYXQgaW52b2tlZCB0aGlzIHJ1bGUgKi8KekRhdGEuY2xlYXJUcmlnZ2VyQ29uZGl0aW9uKGRvYywgIlhfYnV0dG9uQWN0aW9uIik7CnZhciBpbmRleEluaXRpYWxpemVkID0gWChkb2MsICJYX2luZGV4SW5pdGlhbGl6ZWQiKTsKaWYgKCFpbmRleEluaXRpYWxpemVkIHx8IDAgPT09IGluZGV4SW5pdGlhbGl6ZWQubGVuZ3RoKSB7CiAgICBzdGFja0lkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiIjsKICAgIHN0YWNrRm9sZGVyID0gc3RhY2tJZCArICItU1RBQ0siOwogICAgLyogTVNIMTcwODE0IG1pc21hdGNoZWQgcGFyYW0gbGlzdCAqLwogICAgLyogekRhdGEuaW5pdGlhbGl6ZVN0YWNrKGRvYywgc3RhY2tGb2xkZXIsIGNvbXBhbnlDb2RlLCBzdGFja0lkKTsgKi8KICAgIHpEYXRhLmluaXRpYWxpemVTdGFjayhkb2MsIHN0YWNrRm9sZGVyLCBzdGFja0lkKTsKfQoKdmFyIHBlcnNvbkFjY291bnRJZCA9IFgoZG9jLCAiWF9QZXJzb25fQWNjb3VudF9fYyIpOwp2YXIgY2FzZUlkID0gWChkb2MsICJYX1pQQVBFUl9fQ2FzZV9fYyIpOwphbGVydCgiQEBAIGNhc2VJZCA9ICIgKyBjYXNlSWQpOwphbGVydCgiQEBAIHBlcnNvbkFjY291bnRJZCA9ICIgKyBwZXJzb25BY2NvdW50SWQpOwppZiAoIXBlcnNvbkFjY291bnRJZCkgewogICAgYWxlcnQoIkBAQCBjcmVhdGluZyBQZXJzb25BY2NvdW50IEBAQCIpOwogICAgdmFyIGFjY291bnRGaXJzdE5hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiKTsKICAgIHZhciBhY2NvdW50TGFzdE5hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOwogICAgdmFyIGFjY291bnRCaXJ0aERhdGUgPSBYKGRvYywgIlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MiKTsKICAgIHZhciB6cEFyck9mUGFpcnMgPVtdOwogICAgenBBcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsICIwMTI2QTAwMDAwMEpFOHlRQUciKTsKICAgIHpwQXJyT2ZQYWlycy5wdXNoKCJGaXJzdE5hbWUiLGFjY291bnRGaXJzdE5hbWUpOwogICAgenBBcnJPZlBhaXJzLnB1c2goIlBTX1BhdGllbnRGaXJzdE5hbWVfX2MiLGFjY291bnRGaXJzdE5hbWUpOwogICAgenBBcnJPZlBhaXJzLnB1c2goIlBTX1BhdGllbnRMYXN0TmFtZV9fYyIsYWNjb3VudExhc3ROYW1lKTsKICAgIHpwQXJyT2ZQYWlycy5wdXNoKCJMYXN0TmFtZSIsYWNjb3VudExhc3ROYW1lKTsKICAgIHpwQXJyT2ZQYWlycy5wdXNoKCJQZXJzb25CaXJ0aGRhdGUiLGFjY291bnRCaXJ0aERhdGUpOwoKICAgIHBlcnNvbkFjY291bnRJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkFjY291bnQiLCAiUGVyc29uIC0gQWNjb3VudCIsIHpwQXJyT2ZQYWlycyk7Cn0KYWxlcnQoIkBAQCBBRlRFUiBDUkVBVElORyBQRVJTT05BQ0NPVU5UIik7CnZhciBjYXNlRmxkcyA9IGdldFNGRmllbGRzKGRvYywgIkNhc2UiLCAiUmVjb3JkVHlwZUlkLENvbnRhY3RJZCxBY2NvdW50SWQiLCBudWxsLCBjYXNlSWQpOyAvL0FOMjAxODA3MTggZ2V0IHRoZSBmaWVsZHMgZnJvbSB0aGUgQ2FzZSB0aGF0IHdlIHdpbGwgbmVlZAoKdmFyIHJlY1R5cGVJZCA9IFgoZG9jLCAiUmVjb3JkVHlwZUlkIiwgY2FzZUZsZHMpOwp2YXIgcmVjVHlwZU5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIlJlY29yZFR5cGUiLCAiTmFtZSIsIG51bGwsIHJlY1R5cGVJZCk7IC8vQU4yMDE4MDcxOCBnZXQgdGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgQ2FzZSByZWNvcmQgdHlwZQoKcGF0aWVudElkID0gIFgoZG9jLCAiQ29udGFjdElkIiwgY2FzZUZsZHMpOyAvL2dldCB0aGUgQ29udGFjdCBJRCBzaW5jZSBQQVAgdXNlcyB0aGUgQ29udGFjdCBvYmplY3QgZm9yIFBhdGllbnRzCiAgIAogICAgdmFyIGNvbnRhY3RGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCAiQWNjb3VudCIsICJQU19QYXRpZW50Rmlyc3ROYW1lX19jLFBTX1BhdGllbnRMYXN0TmFtZV9fYyxQZXJzb25CaXJ0aGRhdGUiLCBudWxsLCBwZXJzb25BY2NvdW50SWQpOyAvL01TSDE3MDgxOCBhZGRlZCBCaXJ0aGRhdGUKICAgIGFsZXJ0KCJAQEAgY2FsbGluZyBTRiBmb3IgY29udGFjdEZsZHMgOjogIiArIGNvbnRhY3RGbGRzKTsKICAgIHBhdGllbnRGaXJzdE5hbWUgPSBYKGRvYywgIlBTX1BhdGllbnRGaXJzdE5hbWVfX2MiLCBjb250YWN0Rmxkcyk7CiAgICBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIlBTX1BhdGllbnRMYXN0TmFtZV9fYyIsIGNvbnRhY3RGbGRzKTsKICAgIHBhdGllbnRET0IgPSBYKGRvYywgIlBlcnNvbkJpcnRoZGF0ZSIsIGNvbnRhY3RGbGRzKTsKCgp2YXIgTU1kZFlZWVkgPSB6RGF0YS5mb3JtYXRUb2RheU1NZGRZWVlZKCk7Ci8qTVNIMTcxMTI5IHdlIGFscmVhZHkgZ290IGRvY1R5cGUsIHVzZSBpdCBhdHRhY2hMYWJlbCA9IHBhdGllbnRGaXJzdE5hbWUgKyBwYXRpZW50TGFzdE5hbWUgKyAiIC0gIiArIFgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpICsgIiAtICIgKyBNTWRkWVlZWTsqLwphdHRhY2hMYWJlbCA9IHBhdGllbnRGaXJzdE5hbWUgKyBwYXRpZW50TGFzdE5hbWUgKyAiIC0gIiArIGRvY1R5cGUgKyAiIC0gIiArIE1NZGRZWVlZOwoKLyogR2V0IHRoZSBkb2N1bWVudCB0eXBlICh3aWxsIGJlIHVzZWQgdG8gcm91dGUgdG8gbmV4dCBmb2xkZXIpICovCnZhciBkb2NUeXBlID0gWChkb2MsICJYX2RvY1R5cGUiKTsKdmFyIGF0dGFjaExhYmVsID0gIiI7IC8qIE1TSDE3MDgxOCBmb3JtYXQgc2hvdWxkIGJlICJQYXRpZW50IE5hbWUgLSBEb2MgVHlwZSAtIERhdGUiICovCgp2YXIgcHJldkluZGV4UGFnZXMgPSBYKGRvYywgIlhfaW5kZXhlZFBhZ2VzIik7CnZhciBjdXJJbmRleFBhZ2VzID0gWChkb2MsICJYX2lkeFBhZ2VzIik7CmlmIChwcmV2SW5kZXhQYWdlcyAmJiBwcmV2SW5kZXhQYWdlcy5sZW5ndGggPiAwICYmIGN1ckluZGV4UGFnZXMgJiYgY3VySW5kZXhQYWdlcy5sZW5ndGggPiAwKSB7CiAgICBwcmV2SW5kZXhQYWdlcyArPSAiLCI7Cn0KY3VySW5kZXhQYWdlcyA9IHByZXZJbmRleFBhZ2VzICsgY3VySW5kZXhQYWdlczsKdmFyIGFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX2luZGV4ZWRQYWdlcyIsIGN1ckluZGV4UGFnZXMpOwp1cGRhdGVEQihkb2MsIGFyck9mUGFpcnMpOwoKLyogU1BMSVQgT0ZGIE5FVyBTTklQUEVUIEhFUkUgKi8KdmFyIHBhZ2VSYW5nZSA9IFgoZG9jLCAiWF9pZHhQYWdlcyIpOwphbGVydCgiQEBAIHBhZ2VSYW5nZSA9ICIgKyBwYWdlUmFuZ2UpOwp2YXIgYXJyT2ZQYWlyczEgPSBbXTsgLy9QVjI4MDMxOSB1cGRhdGVkIGZvciBjb3B5IG9uIHNwbGl0CnZhciBwYWdlQ291bnQgPXpEYXRhLmNvdW50UGFnZXMoZG9jLCBwYWdlUmFuZ2UpOwovL3ZhciBwYWdlUmFuZ2UgPSAiMS0iICsgcGFnZUNvdW50OwogICAgYWxlcnQoIkBAQCBwYWdlUmFuZ2UgPT09ICIgKyBwYWdlUmFuZ2UpOwogICAKdmFyIG5ld0RiSWQgPSBzcGxpdERvY3VtZW50Rm9ySW5kZXgoZG9jLCAiaW5kZXgiLCBwYWdlUmFuZ2UsYXJyT2ZQYWlyczEpOwphbGVydCgiQEBAIGFmdGVyIHNwbGl0RG9jdW1lbnRGb3JJbmRleCIpOwovKiBhbGVydCgiQEBAIENhc2UgJyIgKyBjYXNlSWQgKyAiJyBhbmQgbGVuID0gIiArIGNhc2VJZC5sZW5ndGgpOyAqLwovLyoKLyogQUZURVIgVEhJUyBQT0lOVCwgVEhFIERPQyBXSUxMIEhPTEQgREFUQSBGT1IgTkVXIFNOSVBQRVQsIE5PVCBUSEUgU1RBQ0sgU05JUFBFVCAqLwovLyoKCi8qIE1TSDE3MTExNSAjNDM2MTMgKi8KLyphbGVydCgiQEBAIG5ld0RiSWQgPSAiICsgbmV3RGJJZCk7CiBzZXREb2N1bWVudENvbnRleHQoZG9jLCBuZXdEYklkKTsqLwoKZG9jVHlwZSA9IFgoZG9jLCAiWF9aUEFQRVJfX2ZheFR5cGVfX2MiKTsKekRhdGEuZG9jVHlwZSA9IGRvY1R5cGU7CmF0dGFjaExhYmVsID0gekRhdGEubmFtZUZpbGUoZG9jKTsgLy9FUlMxNzA4MjkgIzQxMjk4CmFsZXJ0KCJAQEAgcGF0aWVudElkIGZyb20gWF9aUEFQRVJfX1BhdGllbnRfX2MgPSAiICsgcGF0aWVudElkKTsKCmFsZXJ0KCJAQEAgWF9aUEFQRVJfX1BhdGllbnRfX3IuTmFtZSA6OiAiICsgWChkb2MsICJYX1pQQVBFUl9fUGF0aWVudF9fci5OYW1lIikpOwoKLypNU0gxNzExMjkgd2UgYWxyZWFkeSBnb3QgZG9jVHlwZSwgdXNlIGl0IGF0dGFjaExhYmVsID0gcGF0aWVudEZpcnN0TmFtZSArIHBhdGllbnRMYXN0TmFtZSArICIgLSAiICsgWChkb2MsIlhfWlBBUEVSX19mYXhUeXBlX19jIikgKyAiIC0gIiArIE1NZGRZWVlZOyovCmF0dGFjaExhYmVsID0gcGF0aWVudEZpcnN0TmFtZSArIHBhdGllbnRMYXN0TmFtZSArICIgLSAiICsgZG9jVHlwZSArICIgLSAiICsgTU1kZFlZWVk7CgovL01TSDE3MDgyOSBjbGVhciBvdXQgdGhlICJOZXcgUGF0aWVudCIgZmllbGRzCmFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0ZpcnN0TmFtZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBwYXRpZW50Rmlyc3ROYW1lICsgZHEgKyAiKTsgIik7CmFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0xhc3ROYW1lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHBhdGllbnRMYXN0TmFtZSArIGRxICsgIik7ICIpOwovL2FkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0JpcnRoZGF0ZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwphZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19CaXJ0aGRhdGVfX2NfcmVhZGFibGUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgcGF0aWVudERPQiArIGRxICsgIik7ICIpOwoKLy9NU0gxNzA4Mjkgc2V0IHRoZSBQYXRpZW50IGxvb2t1cCBmaWVsZHMKYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHBhdGllbnRGaXJzdE5hbWUgKyAiICIgKyBwYXRpZW50TGFzdE5hbWUgKyBkcSArICIpOyAiKTsKCi8vIHVwZGF0ZSBzdGFjawphbGVydCgiQEBAIHJlYWR5IHRvIHVwZGF0ZSBTdGFja0lEID0gIiArIHN0YWNrSWQpOyAvL01TSDE3MDkyNgphbGVydCgiQEBAIHNldHRpbmcgcGF0aWVudCBmaWVsZCBvbiBTdGFja0lEID0gIiArIHN0YWNrSWQgKyAiLCBQYXRpZW50ID0gIiArIHBhdGllbnRJZCk7CmFyck9mUGFpcnMgPSBbXTsKCmFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19GaXJzdE5hbWVfX2MiLCBwYXRpZW50Rmlyc3ROYW1lKTsKYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0xhc3ROYW1lX19jIiwgcGF0aWVudExhc3ROYW1lKTsKaWYgKHBhdGllbnRET0IgJiYgcGF0aWVudERPQi5sZW5ndGggPiAwKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQmlydGhkYXRlX19jIiwgcGF0aWVudERPQik7Cn0KCmFyck9mUGFpcnMucHVzaCgiRHJ1Z19UeXBlX19jIiwgWChkb2MsICJYX0RydWdfVHlwZV9fYyIpKTsKYXJyT2ZQYWlycy5wdXNoKCJNaXNzaW5nX0luZm9ybWF0aW9uX19jIiwgWChkb2MsICJYX01pc3NpbmdfSW5mb3JtYXRpb25fX2MiKSk7CmFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIiwgZG9jVHlwZSk7CmFyck9mUGFpcnMucHVzaCgiQXR0cmlidXRlc19MYXN0X01vZGlmaWVkX19jIiwgZm9ybWF0Tm93KTsKYXJyT2ZQYWlycy5wdXNoKCJBdHRyaWJ1dGVzX01vZGlmaWVkX0J5X19jIiwgZG9jLmtiRGF0YS5yZW1vdGVVc2VyKTsKYWxlcnQoIkBAQCB1cGRhdGluZyBuZXcgc3RhY2sgd2l0aCA6OiAiICsgYXJyT2ZQYWlycyk7CnVwZGF0ZVNGUmVjb3JkKGRvYywgIlpQQVBFUl9felN0YWNrX19jIiwgc2ZTdGFja0lkLCBhcnJPZlBhaXJzKTsKCgovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIGEgbmV3IENhc2UgcmVjb3JkLCBpZiBpdCB3YXNuJ3QgcGFzc2VkIGluICovCnZhciBwcmlvcml0eSA9IFgoZG9jLCAiWF9aUEFQRVJfX1ByaW9yaXR5X19jIik7IC8vRVJTMTcwNjI2CnZhciBjYXNlTnVtYmVyID0gIiI7CgovKiBNU0gxNzExMjkgIzQzNjQ5ICovCi8qIHRoaXMgaXMgdXNlZCBmb3IgYWxsIGNhc2VzLCBlaXRoZXIgY3JlYXRlZCBvciBleGlzdGluZyAqLwphcnJPZlBhaXJzID0gW107CgphbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgQ2FzZTogIiArIGNhc2VJZCk7CnZhciBtaXNzaW5nSW5mbyA9IFgoZG9jLCAiWF9NaXNzaW5nX0luZm9ybWF0aW9uX19jIik7CmlmIChtaXNzaW5nSW5mbyAmJiBtaXNzaW5nSW5mbyA9PSAidHJ1ZSIpIHsKICAgIC8vTVNIMTcwODI4IGlmIG1pc3NpbmdJbmZvID09IHRydWUsIHNldCBzdGF0dXMgdG8gSW5mb3JtYXRpb24gUmVjZWl2ZWQKICAgIGFyck9mUGFpcnMucHVzaCgiU3RhdHVzIiwgIkluZm9ybWF0aW9uIFJlY2VpdmVkIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIlBTX01pc3NpbmdfSW5mb19yZWNlaXZlZF9fYyIsIGZvcm1hdE5vdyk7IC8vTVNIMTcwOTEyCn0KYXJyT2ZQYWlycy5wdXNoKCJ6UGFwZXJfSXNfYXZhaWxhYmxlX2Zvcl91cHN0cmVhbV9fYyIsICd0cnVlJyk7IC8vIHVwZGF0ZWQgZmlsZWQgZm9yIFRJQkNPIFBWMDIyNzE4CmFsZXJ0KCJAQEAgelBhcGVyX0lzX2F2YWlsYWJsZV9mb3JfdXBzdHJlYW1fX2MiICsgYXJyT2ZQYWlycyApOwphdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgcGVyc29uQWNjb3VudElkKTsKYXR0YWNoUGF0aCA9IFgoZG9jLCAiWF9hdHRhY2hlZFRvIik7CmFyck9mUGFpcnMgPSBbXTsKaWYgKGF0dGFjaFBhdGguaW5kZXhPZihjYXNlSWQpID09IC0xKSB7CiAgICBhdHRhY2hQYXRoICs9ICIsIiArIGNhc2VJZDsKfQovL2lmIChwcm92aWRlcklkICYmIHByb3ZpZGVySWQubGVuZ3RoID4gMCkgewogICAgLy9hcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJvdmlkZXJfX2MiLCBwcm92aWRlcklkKTsKICAgIC8vaWYgKGF0dGFjaFBhdGguaW5kZXhPZihwcm92aWRlcklkKT09LTEpIHsgYXR0YWNoUGF0aCs9IiwiK3Byb3ZpZGVySWQ7IH0KLy99CmlmIChwYXRpZW50SWQgJiYgcGF0aWVudElkLmxlbmd0aCA+IDApIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50X19jIiwgcGF0aWVudElkKTsKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YocGF0aWVudElkKSA9PSAtMSkgeyBhdHRhY2hQYXRoICs9ICIsIiArIHBhdGllbnRJZDsgfQp9CmlmIChjYXNlSWQgJiYgY2FzZUlkLmxlbmd0aCA+IDApIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DYXNlX19jIiwgY2FzZUlkKTsKfQoKaWYgKHBlcnNvbkFjY291bnRJZCAmJiBwZXJzb25BY2NvdW50SWQubGVuZ3RoID4gMCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJQZXJzb25fQWNjb3VudF9fYyIsIHBlcnNvbkFjY291bnRJZCk7Cn0gCgp1cGRhdGVTRlJlY29yZChkb2MsICJaUEFQRVJfX3pTdGFja19fYyIsIHNmU3RhY2tJZCwgYXJyT2ZQYWlycyk7CmF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCBzZlN0YWNrSWQpOwphbGVydCgiQEBAIHVwZGF0ZWQgYW5kIGF0dGFjaGVkIHRvIHpTdGFjayBSZWNvcmQsIGlkID0gIiArIHNmU3RhY2tJZCk7CgovLyBsZXRzIGNyZWF0ZSB0aWZmIGltYWdlIGZvciBwZGYgaGVyZQphbGVydCgiQEBAIHRpZmYgZmxhZyAjIyMgPSAiICsgekRhdGEuZ2VuZXJhdGVUaWZmKTsKYWxlcnQoIkBAQCBwYWdlUmFuZ2UgIyMjID0gIiArIHBhZ2VSYW5nZSk7CnRpZmZTZklkID0gcGVyc29uQWNjb3VudElkOwppZiAoekRhdGEuZ2VuZXJhdGVUaWZmKSB7CiAgICB2YXIgYXR0YWNobWVudE5hbWUgPSBhdHRhY2hMYWJlbDsgLy9QVjAyMjYxOAogICAgdmFyIGNoaWxkRG9jSWQgPSBkb2MuZGJJRDsgLy9QVjAyMjYxOAogICAgc2V0RG9jdW1lbnRDb250ZXh0KGRvYywgb3JnRG9jSWQpOwogICAgLyogIGNyZWF0ZSBhbmQgYXR0YWNoIHRpZiAqLwogICAgLyogQXR0YWNoIGZpbGUgaW4gYWRkaXRpb24gdG8gZW52ZWxvcGUgKi8KICAgIHZhciBub3dUaW1lU3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOwogICAgLy9mb3VuZCBpbiAvenBkYXRhL2NvbmYvd29ya2Zsb3cucHJvcHMKICAgIC8vYSBkaXJlY3RvcnkgaW4gd2hpY2ggdG8gZG8gdGhlIHdvcmsKICAgIC8vaW50ZWdyYXRpb25EaXI9L3pwZGF0YS9hZ2VudHMvbWNrL2ludGVncmF0aW9uLwogICAgY3JlYXRlRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwogICAKICAgIC8vUGFnZSBSYW5nZSBjYW4gY29udGFpbiBub24tbnVtZXJpYyBjaGFyYWN0ZXJzIGZyb20gUGFnZSBSb3RhdGlvbiBlZzojIyMgcGFnZVJhbmdlICMjIzF1LDIsOCw3LDYsNSw0LDMKICAgIC8vbWFrZSBzdXJlIHBhZ2UgcmFuZ2UgYXJyYXkgaXMgY2xlYXJlZCBvZiBhbGwgbm9uLW51bWVyaWMgY2hhcnMKICAgIC8vTVNIMTgwOTI0IGRvbid0IG5lZWQgbWluICYgbWF4LCBqdXN0IHN0cmlwIG91dCBhbHBoYSBjaGFycy4KICAgIC8vICAgICAgcGFyc2luZyBpcyBoYW5kbGVkIGRvd25zdHJlYW0gaW4gY29tLmtub3dsZWRnZWJpbi5VdGlscyBwdWJsaWMgc3RhdGljIENvbGxlY3Rpb248SW50ZWdlcj4gcGFyc2VQYWdlcyhTdHJpbmcgcGFnZXMpCiAKICAgIC8vcmVnZXg6IGZpbmQgYWxsIGFscGhhIGNoYXJzIChbYS16XSksIGdsb2JhbGx5IChnKSwgYW5kIGNhc2UtaW5zZW5zaXRpdmUgKGkpCiAgICB2YXIgbm9BbHBoYVBhZ2VzID0gcGFnZVJhbmdlLnJlcGxhY2UoL1thLXpdL2dpLCAiIik7CiAgICBhbGVydCgiQEBAQEAgQ2FsbGluZyBzcGxpdCwgcGFnZXMgPSAiICsgbm9BbHBoYVBhZ2VzICsgIiwgbm93VGltZVN0YW1wID0gIiArIG5vd1RpbWVTdGFtcCk7CgogICAgLy9NU0gxODA5MjQgIzUyNDQwIHZhciByZXNwb25zZSA9IHNwbGl0UERGKGRvYywgbWluUGFnZSArICItIiArIG1heFBhZ2UsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wLCBkb2MuZGJJRCk7CiAgICB2YXIgcmVzcG9uc2UgPSBzcGxpdFBERihkb2MsIG5vQWxwaGFQYWdlcywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXAsIGRvYy5kYklEKTsKICAgIGFsZXJ0KCJAQEBAIHJlc3BvbnNlIGZyb20gc3BsaXRQREYgPSAiICsgcmVzcG9uc2UpOwogICAgdmFyIG5ld1BERk5hbWUgPSBYKGRvYywgIm5ld1BERiIsIHJlc3BvbnNlKTsKICAgIGFsZXJ0KCJAQEBAIHNwbGl0IFBERiBGaWxlTmFtZSA9ICIgKyBuZXdQREZOYW1lKTsKICAgIHZhciBuZXdUSUZGTmFtZSA9IHBkZjJ0aWZmKGRvYywgbmV3UERGTmFtZSk7CiAgICBhbGVydCgiQEBAQCBwZGYydGlmZiBGaWxlTmFtZSA9ICIgKyBuZXdUSUZGTmFtZSk7CiAgICB2YXIgbGFiZWwgPSBhdHRhY2htZW50TmFtZSArICIudGlmIjsKICAgIGlmIChuZXdUSUZGTmFtZS5pbmRleE9mKCJFUlJPUiIpICE9PSAwKSB7CiAgICAgICAgdmFyIHVwbG9hZFVSTCA9ICJodHRwOi8vbG9jYWxob3N0OjgwODAvbXlmaWxlZm9yY2UvdXBsb2FkVG9DbG91ZC5qc3A/U0ZpZD1ORVcmU0ZwaWQ9IiArIHRpZmZTZklkICsgIiZTRm9yZz0iICsgZG9jLnNmT3JnICsgIiZsYWJlbD0iICsgbGFiZWwgKyAiJnNlcnZlckZpbGU9IiArIG5ld1RJRkZOYW1lICsgIiZEZXNjcmlwdGlvbj1GaWxlIGF0dGFjaGVkIGJ5IHpQYXBlci4iOwogICAgICAgIGFsZXJ0KCJAQEAjIFVwbG9hZCBuYXRpdmUgUERGIHdpdGggIiArIHVwbG9hZFVSTCk7CiAgICAgICAgdmFyIHIgPSB3Z2V0KGRvYywgdXBsb2FkVVJMKTsKICAgICAgICBhbGVydCgiQEBAIyB0aWZmIGNyZWF0ZWQgYW5kIGF0dGFjaGVkIHRvOiAiICsgY2FzZUlkKTsKICAgICAgICBjbGVhbnVwRGlyZWN0b3J5KGRvYywgekRhdGEudXBsb2FkRGlyLCBub3dUaW1lU3RhbXApOwogICAgICAgIC8qIEZpbmFsbHksIGRlbGV0ZSB0aGUgd29yayBmb2xkZXIgYW5kIGFsbCBjb250ZW50cy4gKi8KICAgICAgICAvL01TSDE3MDIyMiBFUlMgd2FudHMgdG8ga2VlcCBjbGVhbnVwRGlyZWN0b3J5KGRvYywgImludGVncmF0aW9uRGlyIiwgbm93VGltZVN0YW1wKTsKICAgIH0KICAgIC8vTVNIMTgxMDA4IHNpbmNlIHdlIGNoYW5nZWQgdGhlIGRvYyBjb250ZXh0LCBjaGFuZ2UgaXQgYmFjawogICAgc2V0RG9jdW1lbnRDb250ZXh0KGRvYywgY2hpbGREb2NJZCk7Cn0KCmFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQZXJzb25fQWNjb3VudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBwZXJzb25BY2NvdW50SWQgKyBkcSArICIpOyAiKTsKYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1BlcnNvbl9BY2NvdW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgcGF0aWVudEZpcnN0TmFtZSArIiAiICtwYXRpZW50TGFzdE5hbWUgKyBkcSArICIpOyAiKTsKYXJyT2ZQYWlycyA9IFtdOwphcnJPZlBhaXJzLnB1c2goIlhfcmV2aWV3ZWRTdGF0dXMiLCAiSW5kZXhlZCIpOwovKiBDUk4xNjA4MjUgU2V0IHRoZSBwYWdlIGNvdW50IHNvIHRoYXQgaXQgZG9lcyBub3QgaGF2ZSB0aGUgcGFyZW50IHBhZ2UgY291bnQgKi8KIHBhZ2VDb3VudCA9IHpEYXRhLmNvdW50UGFnZXMoZG9jLCBwYWdlUmFuZ2UpOwphbGVydCgiQEBAQCBwYWdlQ291bnQgPSAiICsgcGFnZUNvdW50KTsKYXJyT2ZQYWlycy5wdXNoKCJYX3BhZ2VzIiwgcGFnZUNvdW50KTsKYXJyT2ZQYWlycy5wdXNoKCJYX2RvY1R5cGUiLCBkb2NUeXBlKTsgLyogTVNIMTcwOTI3IGdldCBhbGwgdGhlIGRvY1R5cGVzIGFsaWduZWQgKi8KYXJyT2ZQYWlycy5wdXNoKCJkYi1wYWdlcyIsIHBhZ2VDb3VudCk7CmlmICghcGF0aWVudEZpcnN0TmFtZSB8fCAwID09PSBwYXRpZW50Rmlyc3ROYW1lLmxlbmd0aCkgeyBwYXRpZW50Rmlyc3ROYW1lID0gIlVua25vd24iOyB9CmlmICghcGF0aWVudExhc3ROYW1lIHx8IDAgPT09IHBhdGllbnRMYXN0TmFtZS5sZW5ndGgpIHsgcGF0aWVudExhc3ROYW1lID0gIk5hbWUiOyB9Ci8qIE1TSDE3MDgxOCBhcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgcGF0aWVudEZpcnN0TmFtZSArIHBhdGllbnRMYXN0TmFtZSArICIgLSAiICsgY29tcGFueUNvZGUgKyAiIC0gIiArIHN0YWNrSWQpOyAqLwovKiBFUlMxNzA4MjkgbmFtZUZpbGUgZG9lcyBpdCBhcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgcGF0aWVudEZpcnN0TmFtZSArIHBhdGllbnRMYXN0TmFtZSArICIgLSAiICsgZG9jLmRlbGl2ZXJlZFRvICsgIiAtICIgKyBzdGFja0lkKTsgKi8KYXJyT2ZQYWlycy5wdXNoKCJYX2F0dGFjaGVkVG8iLCBhdHRhY2hQYXRoKTsgLy9FUlMxNzA2MjgKYXJyT2ZQYWlycy5wdXNoKCJYX1pQQVBFUl9fQ2FzZV9fYyIsIGNhc2VJZCk7IC8vTVNIMTcwODI4CmFyck9mUGFpcnMucHVzaCgiUGVyc29uX0FjY291bnRfX2MiLCBwZXJzb25BY2NvdW50SWQpOwphcnJPZlBhaXJzLnB1c2goIlhfWlBBUEVSX19DYXNlX19yLkNhc2VOdW1iZXIiLCBjYXNlTnVtYmVyKTsgLy9NU0gxNzA4MjgKYXJyT2ZQYWlycy5wdXNoKCJYX1pQQVBFUl9fUGF0aWVudF9fYyIsIHBhdGllbnRJZCk7IC8vTVNIMTcwODI4CmFyck9mUGFpcnMucHVzaCgiWF9aUEFQRVJfX1BhdGllbnRfX3IuTmFtZSIsIHBhdGllbnRGaXJzdE5hbWUgKyAiICIgKyBwYXRpZW50TGFzdE5hbWUpOyAvL01TSDE3MDgyOAphcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgYXR0YWNoTGFiZWwpOyAvL0NSTjE3MTEwMgoKLy9DUk4xODA3MjYgQ2FzZSAjNTA0NjkgLS0gU2V0IHRoZSAiSW5kZXhlZCIgY2hlY2tib3gKdmFyIGJhID0gIkluZGV4ZWQiOyAvL0pQQjE4MDYwNSBiZWNhdXNlIHdlIGNoYW5nZWQgdGhlIG5hbWUgb2YgdGhlIGJ1dHRvbiBmcm9tIEluZGV4ZWQgdG8gU2F2ZQp2YXIgbm93MCA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYyxmYWxzZSx0cnVlKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld2VkU3RhdHVzIixiYSk7Ci8vYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld3MiLFgoZG9jLCJYX3Jldmlld3MiKStiYSsiIGJ5ICIrZG9jLmtiRGF0YS5yZW1vdGVVc2VyKyIgYXQgIitub3cwKyI8YnIvPiIpOyAvL0VSUzE3MDkwOSAjNDA1OTIKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld3MiLCJSZWNlaXZlZCBieSAiK2RvYy5rYkRhdGEucmVtb3RlVXNlcisiIGF0ICIrbm93MCsiPGJyLz4iK2JhKyIgYnkgIitkb2Mua2JEYXRhLnJlbW90ZVVzZXIrIiBhdCAiK25vdzArIjxici8+Iik7IC8vUFYxOTA0MjAgdXBkYXRlZCBmb3IgZG9jIHNldCBjb21wb25lbnRzIHRvIGNoZWNrCnVwZGF0ZURCKGRvYywgYXJyT2ZQYWlycyk7Cgp0cmFjayhkb2MsICJEb2MgSW5kZXhlZCAiLCAiRG9jdW1lbnQgd2l0aCBJZDogIiArIGRvYy5kYklELCBwYWdlQ291bnQpOwphZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIm5leHRQYWdlKH5yZWFkeX4pO3VwZGF0ZURFU3RhdHVzKH5pbmRleGVkOiIgKyBwYWdlUmFuZ2UgKyAifik7Iik7Ci8qIGVuZCBvZiBydWxlICovCg=="},"ordinal":7}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
//this is a copy and update of the existing Index Page rule. Temp use for Shield Encryption testing
alert("@@@@ Index Encrypted Rule Fired @@@#");
/* double-quote, newline characters */
var dq = String.fromCharCode(34);
var nl = String.fromCharCode(10);
var formatNow = getCurDateAndTime(doc);

//here is another silly comment

/* MSH171130 #43649 created date for original doc */
var docCreatedDate = gmtFormatted(doc, "created");
var attachPath = X(doc, "X_attachedTo");
var patientFirstName = "";
var patientLastName = "";
var patientDOB = "";
var patientId = "";
var tiffSfId="";
var stackId = X(doc, "X_stack"); //zPaper dbID
var sfStackId = X(doc, "X_sfStackId");
var orgDocId = doc.dbID;  //PV022618
if (sfStackId === "") { //ERS170731 #40593
    /* MSH170814 this doesn't do anything useful X(doc, "X_attachedTo"); */
    /* MSH171129 we already got attachPath, use it sfStackId = X(doc, "X_attachedTo"); */
    sfStackId = attachPath;
    if (sfStackId.lastIndexOf('/') >= 0) {
        sfStackId = sfStackId.substring(sfStackId.lastIndexOf('/') + 1);
        if (sfStackId.indexOf(',') >= 0) { sfStackId = sfStackId.substring(0, sfStackId.indexOf(',')); }
    }
}
alert("@@@ Currently attached to ZPAPER__zStack__c with sfStackId: " + sfStackId);

//AN20180716 for code review - are these variables and IF statement still needed, since we are no longer user folders?
var originalSfStackId = sfStackId;
alert("@@@ originalSfStackId = " + originalSfStackId);
var stackFolder = stackId + "-STACK";
/* Clear the trigger that invoked this rule */
zData.clearTriggerCondition(doc, "X_buttonAction");
var indexInitialized = X(doc, "X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    /* MSH170814 mismatched param list */
    /* zData.initializeStack(doc, stackFolder, companyCode, stackId); */
    zData.initializeStack(doc, stackFolder, stackId);
}

var personAccountId = X(doc, "X_Person_Account__c");
var caseId = X(doc, "X_ZPAPER__Case__c");
alert("@@@ caseId = " + caseId);
alert("@@@ personAccountId = " + personAccountId);
if (!personAccountId) {
    alert("@@@ creating PersonAccount @@@");
    var accountFirstName = X(doc, "X_ZPAPER__FirstName__c");
    var accountLastName = X(doc, "X_ZPAPER__LastName__c");
    var accountBirthDate = X(doc, "X_ZPAPER__Birthdate__c");
    var zpArrOfPairs =[];
    zpArrOfPairs.push("RecordTypeId", "0126A000000JE8yQAG");
    zpArrOfPairs.push("FirstName",accountFirstName);
    zpArrOfPairs.push("PS_PatientFirstName__c",accountFirstName);
    zpArrOfPairs.push("PS_PatientLastName__c",accountLastName);
    zpArrOfPairs.push("LastName",accountLastName);
    zpArrOfPairs.push("PersonBirthdate",accountBirthDate);

    personAccountId = createSFRecord(doc, "Account", "Person - Account", zpArrOfPairs);
}
alert("@@@ AFTER CREATING PERSONACCOUNT");
var caseFlds = getSFFields(doc, "Case", "RecordTypeId,ContactId,AccountId", null, caseId); //AN20180718 get the fields from the Case that we will need

var recTypeId = X(doc, "RecordTypeId", caseFlds);
var recTypeName = getSFField(doc, "RecordType", "Name", null, recTypeId); //AN20180718 get the name of the current Case record type

patientId =  X(doc, "ContactId", caseFlds); //get the Contact ID since PAP uses the Contact object for Patients
   
    var contactFlds = getSFFields(doc, "Account", "PS_PatientFirstName__c,PS_PatientLastName__c,PersonBirthdate", null, personAccountId); //MSH170818 added Birthdate
    alert("@@@ calling SF for contactFlds :: " + contactFlds);
    patientFirstName = X(doc, "PS_PatientFirstName__c", contactFlds);
    patientLastName = X(doc, "PS_PatientLastName__c", contactFlds);
    patientDOB = X(doc, "PersonBirthdate", contactFlds);


var MMddYYYY = zData.formatTodayMMddYYYY();
/*MSH171129 we already got docType, use it attachLabel = patientFirstName + patientLastName + " - " + X(doc,"X_ZPAPER__faxType__c") + " - " + MMddYYYY;*/
attachLabel = patientFirstName + patientLastName + " - " + docType + " - " + MMddYYYY;

/* Get the document type (will be used to route to next folder) */
var docType = X(doc, "X_docType");
var attachLabel = ""; /* MSH170818 format should be "Patient Name - Doc Type - Date" */

var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
updateDB(doc, arrOfPairs);

/* SPLIT OFF NEW SNIPPET HERE */
var pageRange = X(doc, "X_idxPages");
alert("@@@ pageRange = " + pageRange);
var arrOfPairs1 = []; //PV280319 updated for copy on split
var pageCount =zData.countPages(doc, pageRange);
//var pageRange = "1-" + pageCount;
    alert("@@@ pageRange === " + pageRange);
   
var newDbId = splitDocumentForIndex(doc, "index", pageRange,arrOfPairs1);
alert("@@@ after splitDocumentForIndex");
/* alert("@@@ Case '" + caseId + "' and len = " + caseId.length); */
//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/* MSH171115 #43613 */
/*alert("@@@ newDbId = " + newDbId);
 setDocumentContext(doc, newDbId);*/

docType = X(doc, "X_ZPAPER__faxType__c");
zData.docType = docType;
attachLabel = zData.nameFile(doc); //ERS170829 #41298
alert("@@@ patientId from X_ZPAPER__Patient__c = " + patientId);

alert("@@@ X_ZPAPER__Patient__r.Name :: " + X(doc, "X_ZPAPER__Patient__r.Name"));

/*MSH171129 we already got docType, use it attachLabel = patientFirstName + patientLastName + " - " + X(doc,"X_ZPAPER__faxType__c") + " - " + MMddYYYY;*/
attachLabel = patientFirstName + patientLastName + " - " + docType + " - " + MMddYYYY;

//MSH170829 clear out the "New Patient" fields
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + patientFirstName + dq + "); ");
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + patientLastName + dq + "); ");
//addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + patientDOB + dq + "); ");

//MSH170829 set the Patient lookup fields
addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + patientFirstName + " " + patientLastName + dq + "); ");

// update stack
alert("@@@ ready to update StackID = " + stackId); //MSH170926
alert("@@@ setting patient field on StackID = " + stackId + ", Patient = " + patientId);
arrOfPairs = [];

arrOfPairs.push("ZPAPER__FirstName__c", patientFirstName);
arrOfPairs.push("ZPAPER__LastName__c", patientLastName);
if (patientDOB && patientDOB.length > 0) {
    arrOfPairs.push("ZPAPER__Birthdate__c", patientDOB);
}

arrOfPairs.push("Drug_Type__c", X(doc, "X_Drug_Type__c"));
arrOfPairs.push("Missing_Information__c", X(doc, "X_Missing_Information__c"));
arrOfPairs.push("ZPAPER__faxType__c", docType);
arrOfPairs.push("Attributes_Last_Modified__c", formatNow);
arrOfPairs.push("Attributes_Modified_By__c", doc.kbData.remoteUser);
alert("@@@ updating new stack with :: " + arrOfPairs);
updateSFRecord(doc, "ZPAPER__zStack__c", sfStackId, arrOfPairs);


/* Attach the split document to a new Case record, if it wasn't passed in */
var priority = X(doc, "X_ZPAPER__Priority__c"); //ERS170626
var caseNumber = "";

/* MSH171129 #43649 */
/* this is used for all cases, either created or existing */
arrOfPairs = [];

alert("@@@@ attaching to existing Case: " + caseId);
var missingInfo = X(doc, "X_Missing_Information__c");
if (missingInfo && missingInfo == "true") {
    //MSH170828 if missingInfo == true, set status to Information Received
    arrOfPairs.push("Status", "Information Received");
    arrOfPairs.push("PS_Missing_Info_received__c", formatNow); //MSH170912
}
arrOfPairs.push("zPaper_Is_available_for_upstream__c", 'true'); // updated filed for TIBCO PV022718
alert("@@@ zPaper_Is_available_for_upstream__c" + arrOfPairs );
attach(doc, attachLabel, personAccountId);
attachPath = X(doc, "X_attachedTo");
arrOfPairs = [];
if (attachPath.indexOf(caseId) == -1) {
    attachPath += "," + caseId;
}
//if (providerId && providerId.length > 0) {
    //arrOfPairs.push("ZPAPER__Provider__c", providerId);
    //if (attachPath.indexOf(providerId)==-1) { attachPath+=","+providerId; }
//}
if (patientId && patientId.length > 0) {
    arrOfPairs.push("ZPAPER__Patient__c", patientId);
    if (attachPath.indexOf(patientId) == -1) { attachPath += "," + patientId; }
}
if (caseId && caseId.length > 0) {
    arrOfPairs.push("ZPAPER__Case__c", caseId);
}

if (personAccountId && personAccountId.length > 0) {
    arrOfPairs.push("Person_Account__c", personAccountId);
} 

updateSFRecord(doc, "ZPAPER__zStack__c", sfStackId, arrOfPairs);
attach(doc, attachLabel, sfStackId);
alert("@@@ updated and attached to zStack Record, id = " + sfStackId);

// lets create tiff image for pdf here
alert("@@@ tiff flag ### = " + zData.generateTiff);
alert("@@@ pageRange ### = " + pageRange);
tiffSfId = personAccountId;
if (zData.generateTiff) {
    var attachmentName = attachLabel; //PV022618
    var childDocId = doc.dbID; //PV022618
    setDocumentContext(doc, orgDocId);
    /*  create and attach tif */
    /* Attach file in addition to envelope */
    var nowTimeStamp = new Date().getTime() + "";
    //found in /zpdata/conf/workflow.props
    //a directory in which to do the work
    //integrationDir=/zpdata/agents/mck/integration/
    createDirectory(doc, zData.uploadDir, nowTimeStamp);
   
    //Page Range can contain non-numeric characters from Page Rotation eg:### pageRange ###1u,2,8,7,6,5,4,3
    //make sure page range array is cleared of all non-numeric chars
    //MSH180924 don't need min & max, just strip out alpha chars.
    //      parsing is handled downstream in com.knowledgebin.Utils public static Collection<Integer> parsePages(String pages)
 
    //regex: find all alpha chars ([a-z]), globally (g), and case-insensitive (i)
    var noAlphaPages = pageRange.replace(/[a-z]/gi, "");
    alert("@@@@@ Calling split, pages = " + noAlphaPages + ", nowTimeStamp = " + nowTimeStamp);

    //MSH180924 #52440 var response = splitPDF(doc, minPage + "-" + maxPage, zData.uploadDir, nowTimeStamp, doc.dbID);
    var response = splitPDF(doc, noAlphaPages, zData.uploadDir, nowTimeStamp, doc.dbID);
    alert("@@@@ response from splitPDF = " + response);
    var newPDFName = X(doc, "newPDF", response);
    alert("@@@@ split PDF FileName = " + newPDFName);
    var newTIFFName = pdf2tiff(doc, newPDFName);
    alert("@@@@ pdf2tiff FileName = " + newTIFFName);
    var label = attachmentName + ".tif";
    if (newTIFFName.indexOf("ERROR") !== 0) {
        var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFid=NEW&SFpid=" + tiffSfId + "&SForg=" + doc.sfOrg + "&label=" + label + "&serverFile=" + newTIFFName + "&Description=File attached by zPaper.";
        alert("@@@# Upload native PDF with " + uploadURL);
        var r = wget(doc, uploadURL);
        alert("@@@# tiff created and attached to: " + caseId);
        cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);
        /* Finally, delete the work folder and all contents. */
        //MSH170222 ERS wants to keep cleanupDirectory(doc, "integrationDir", nowTimeStamp);
    }
    //MSH181008 since we changed the doc context, change it back
    setDocumentContext(doc, childDocId);
}

addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c" + dq + ").val(" + dq + personAccountId + dq + "); ");
addPostExecutionScript(doc, " $(" + dq + "#Person_Account__c_Name" + dq + ").val(" + dq + patientFirstName +" " +patientLastName + dq + "); ");
arrOfPairs = [];
arrOfPairs.push("X_reviewedStatus", "Indexed");
/* CRN160825 Set the page count so that it does not have the parent page count */
 pageCount = zData.countPages(doc, pageRange);
alert("@@@@ pageCount = " + pageCount);
arrOfPairs.push("X_pages", pageCount);
arrOfPairs.push("X_docType", docType); /* MSH170927 get all the docTypes aligned */
arrOfPairs.push("db-pages", pageCount);
if (!patientFirstName || 0 === patientFirstName.length) { patientFirstName = "Unknown"; }
if (!patientLastName || 0 === patientLastName.length) { patientLastName = "Name"; }
/* MSH170818 arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + stackId); */
/* ERS170829 nameFile does it arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + doc.deliveredTo + " - " + stackId); */
arrOfPairs.push("X_attachedTo", attachPath); //ERS170628
arrOfPairs.push("X_ZPAPER__Case__c", caseId); //MSH170828
arrOfPairs.push("Person_Account__c", personAccountId);
arrOfPairs.push("X_ZPAPER__Case__r.CaseNumber", caseNumber); //MSH170828
arrOfPairs.push("X_ZPAPER__Patient__c", patientId); //MSH170828
arrOfPairs.push("X_ZPAPER__Patient__r.Name", patientFirstName + " " + patientLastName); //MSH170828
arrOfPairs.push("db-label", attachLabel); //CRN171102

//CRN180726 Case #50469 -- Set the "Indexed" checkbox
var ba = "Indexed"; //JPB180605 because we changed the name of the button from Indexed to Save
var now0 = getCurDateAndTime(doc,false,true);
arrOfPairs.push("X_reviewedStatus",ba);
//arrOfPairs.push("X_reviews",X(doc,"X_reviews")+ba+" by "+doc.kbData.remoteUser+" at "+now0+"<br/>"); //ERS170909 #40592
arrOfPairs.push("X_reviews","Received by "+doc.kbData.remoteUser+" at "+now0+"<br/>"+ba+" by "+doc.kbData.remoteUser+" at "+now0+"<br/>"); //PV190420 updated for doc set components to check
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed ", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");
/* end of rule */

//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---

//--- RULE VALIDATION CODE - END ---

</script>
