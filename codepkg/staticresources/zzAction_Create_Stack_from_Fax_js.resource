<!--
// Name: Create Stack from Fax
// Committer: eric.stephens@zpaper.com
// Update: assign doc security. Variables are based on the inbound fax line
if (!zData.papGroupId) {zData.papGroupId=doc.kbData.groupID; alert("ERS201203.154 using zChannels?"); } //ERS201203 #72433 TODO WHERE DEFINED?; ERS201203 #72433 TODO WHERE DEFINED?
if (!zData.valetGroupId) {zData.valetGroupId=doc.kbData.groupID; alert("ERS201203.155 using zChannels?"); } //ERS201203 #72433; ERS201203 #72433
if (!zData.compIntGroupId) {zData.compIntGroupId=doc.kbData.groupID; alert("ERS201203.156 using zChannels?"); } //ERS201203 #72433; ERS201203 #72433
if (!zData.classification) {zData.classification="fax"; alert("ERS201203.157 using zChannels?"); } //ERS201203 #72433
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2020-12-03 15:45:50","evalContinue":"true","active":true,"button":"","name":"Create Stack from Fax","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"","operation":"equals"}]},"consequence":{"doit":"LyogQkVHSU4gQ3JlYXRlIFN0YWNrIGZyb20gRmF4ICovCnZhciBjcmVhdGVDYXNlID0gZmFsc2U7IC8vQU4yMDE4MDcxMiBmbGFnIHRvIHRyYWNrIGlmIHdlIHdhbnQgdG8gY3JlYXRlIGEgQ2FzZSBvciBub3QKdmFyIHN0YWNrTnVtYmVyOy8vID0gIiI7IC8vQU4yMDE5MDMwNSBtb3ZpbmcgZGVjbGFyYXRpb24gdG8gdG9wIG9mIHJ1bGUKdmFyIGF0dGFjaExhYmVsID0gIiI7CnZhciB6VHlwZSA9IGRvYy5YKCJYX2RvY1R5cGUiKTsKdmFyIGZvcm1hdE5vdyA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CnZhciBjaGFubmVsID0gIkZheCI7CnZhciB6cEFyck9mUGFpcnMgPSBbXTsgLy9BTjIwMTgwNzEzIGRlY2xhcmluZyBhIHNlcGFyYXRlIGFycmF5IGZvciB1c2UgaW4gc2V0dGluZyB6UGFwZXIgZG9jIHNlY3VyaXR5CnZhciB6U3RhY2sgPSAiWlBBUEVSX196U3RhY2tfX2MiOwp2YXIgYXJyT2ZQYWlycyA9IFtdOwoKdmFyIGZyb21GaWxlID0gWChkb2MsICJYX2Zyb21GaWxlIik7Ci8vQ1JOMTkwMzA4IEhhbmRsZSB1cGxvYWRlZCBmaWxlcyB2aWEgTGlnaHRuaW5nIENvbXBvbmVudAppZiAoZnJvbUZpbGUgJiYgZnJvbUZpbGUuaW5kZXhPZigibGlnaHRuaW5nVXBsb2FkIikgPj0gMCkgewogICAgZnJvbUZpbGUgPSBmcm9tRmlsZS5zdWJzdHJpbmcoZnJvbUZpbGUubGFzdEluZGV4T2YoJy8nKSArIDEpOwogICAgdmFyIHBhcnRzID0gZnJvbUZpbGUuc3BsaXQoIi0iKTsKICAgIGlmIChwYXJ0cy5sZW5ndGggPj0gMykgewogICAgICAgIHZhciBhdHRhY2hUb0lkID0gcGFydHNbMl07CiAgICAgICAgYWxlcnQoIkBAQCBVUExPQUQ6IEFUVEFDSElORyBUTyBTQUxFU0ZPUkNFIFJFQ09SRCA9ICIgKyBhdHRhY2hUb0lkKTsKICAgICAgICB2YXIgbGFiZWwgPSAiRmlsZSB1cGxvYWRlZCBieSAiICsgcGFydHNbMF07CiAgICAgICAgYXR0YWNoKGRvYywgbGFiZWwsIGF0dGFjaFRvSWQsIHRydWUpOwogICAgICAgIHZhciBhcnJPZlBhaXJzTG9jYWwgPSBbXTsKICAgICAgICBhcnJPZlBhaXJzTG9jYWwucHVzaCgiZGItbGFiZWwiLCBsYWJlbCk7CiAgICAgICAgdXBkYXRlREIoZG9jLCBhcnJPZlBhaXJzTG9jYWwpOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy9FUlMxNzAzMjggZG9jVHlwZSBieSBPQ1IKekRhdGEuZG9jVHlwZU9DUiA9IHpEYXRhLmRvY1R5cGVyKGRvYywgewogICAgIlBBUFAiOiAiUGF0aWVudH4gQXNzaXN0YW5jZX4iLAogICAgIlBBVVRIIjogIlByaW9yfiBBdXRob3JpemF0aW9ufiIsCiAgICAiRU5STCI6ICJFbnJvbGxtZW50fiIsCiAgICAiRkFYIjogIiIKfSk7CgphbGVydCgiZG9jVHlwZSB3YXMgIiArIGRvYy5kb2NUeXBlICsgIiBub3cgIiArIHpEYXRhLmRvY1R5cGVPQ1IpOwppZiAoZG9jLmRvY1R5cGUgIT0gekRhdGEuZG9jVHlwZU9DUikgewogICAgdmFyIGFyck9mUGFpcnMwID0gW107CiAgICBhcnJPZlBhaXJzMC5wdXNoKCJYX2RvY1R5cGVPQ1IiLCB6RGF0YS5kb2NUeXBlT0NSKTsKICAgIGFyck9mUGFpcnMwLnB1c2goIlhfZG9jVHlwZSIsIHpEYXRhLmRvY1R5cGVPQ1IpOwogICAgelR5cGUgPSB6RGF0YS5kb2NUeXBlT0NSOyAvL0VSUzE3MDMzMCBzYXZlZCBiZWxvdyBpbnRvIFNGIGZheFR5cGVfX2MgZmllbGQKICAgIHVwZGF0ZURCKGRvYywgYXJyT2ZQYWlyczApOwp9CgppZiAoaXNOYU4oZG9jLmRlbGl2ZXJlZEZyb20pKSB7IC8vIE5vdCBhIE51bWJlciBpcyB0cnVlCiAgICBjaGFubmVsID0gIkVtYWlsIjsKfQoKenBBcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fZmF4VHlwZV9fYyIsIHpUeXBlKTsKenBBcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJpb3JpdHlfX2MiLCAiTWVkaXVtIik7CnpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1N0YXR1c19fYyIsICJOZXcgU3RhY2siKTsKenBBcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQ2hhbm5lbF9fYyIsIGNoYW5uZWwpOwoKLy8gTVNIMTcxMTE2IHVzaW5nIHpTdGFja19SZWNlaXZlZF9fYyBpbnN0ZWFkIG9mIGxhdGVzdEZheF9fYyBiZWNhdXNlIGxhdGVzdEZheF9fYyBnZXRzIHVwZGF0ZWQgYnkgc2F2ZS5qc3AgZXZlcnkgdGltZSB0aGUgcmVjb3JkIGlzIHVwZGF0ZWQKenBBcnJPZlBhaXJzLnB1c2goInpTdGFja19SZWNlaXZlZF9fYyIsIGZvcm1hdE5vdyk7CnpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX3JlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7CnpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX25ld0ZheF9fYyIsICJ0cnVlIik7CnpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhZ2VzX19jIiwgWChkb2MsICJYX3BhZ2VzIikpOwp6cEFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcm9ncmFtX05hbWVfX2MiLCB6RGF0YS5jbGFzc2lmaWNhdGlvbik7CnpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX3NlbnRGYXhUb19fYyIsIGRvYy5kZWxpdmVyZWRUbyk7IC8vRVJTMTcwNjI4IGNhbGxlciBpZAp6cEFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Gcm9tX19jIiwgZG9jLmRlbGl2ZXJlZEZyb20pOwp6cEFyck9mUGFpcnMucHVzaCgiekNhbGxlcl9JRF9fYyIsIGRvYy5kZWxpdmVyZWRGcm9tKTsgLy9NU0gxNzA4MTcgYWRkZWQKenBBcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fU3RhZ2VfX2MiLCAiUmVjZWl2ZWQiKTsgLy9FUlMxNzA3MzEgIzQwNTkzCgphbGVydCgiQEBAIENsYXNzaWZpY2F0aW9uID0gIiArIHpEYXRhLmNsYXNzaWZpY2F0aW9uKTsKCi8vQU4yMDE4MDcxMiBmb3IgY29kZSByZXZpZXc6IHdlIGhhdmUgbXVsdGlwbGUgSUYgaXRlcmF0aW9ucyBpbnZvbHZpbmcgekRhdGEuY2xhc3NpZmNhdGlvbi4gQ2FuIHdlIGNvbWJpbmUgdGhlbT8KaWYgKHpEYXRhLmNsYXNzaWZpY2F0aW9uID09ICJQQVAiKSB7IC8vQU4yMDE4MDYwNCBzZXQgUEFQIHF1ZXVlIGFuZCByZWNvcmQgdHlwZQogICAgYWxlcnQoIkBAQCBlbnRlcmluZyBQQVAgbG9naWMiKTsKICAgIHpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIiwgIlBBUCIpOyAvL0FOMjAxOTAzMTIgdGVjaCBkZWJ0LiBOZWVkIHRvIHJlbW92ZSBhbGwgcmVmZXJlbmNlIHRvIENvbXBsZXRlIEltbXVub2xvZ3kgYW5kIHJlcGxhY2Ugd2l0aCBDb21wbGV0ZSBJbnRha2UsIGluY2x1ZGluZyByZW5hbWluZyBvZiB2YXJpYWJsZXMgYW5kIHJlY29yZCB0eXBlcwogICAgaWYgKHpEYXRhLnBhcFF1ZXVlSWQpIHpwQXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgekRhdGEucGFwUXVldWVJZCk7IC8vRVJTMTkwOTExIGNoZWNrIHZhbHVlCiAgICB6cEFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgekRhdGEucGFwU3RhY2tSZWNvcmRUeXBlSWQpOwogICAgenBBcnJPZlBhaXJzLnB1c2goIkRydWdfVHlwZV9fYyIsICJIdW1pcmEiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiZGItdXNlcnMiLCAiOiIgKyB6RGF0YS5wYXBHcm91cElkICsgIjoiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiZGItcmVhZGVycyIsICI6IiArIHpEYXRhLnBhcEdyb3VwSWQgKyAiOiIpOwogICAgYXR0YWNoTGFiZWwgPSAiTmV3IFN0YWNrIHJlY2VpdmVkIG9uICIgKyBmb3JtYXROb3c7CiAgICBjcmVhdGVDYXNlID0gZmFsc2U7Cn0gZWxzZSBpZiAoekRhdGEuY2xhc3NpZmljYXRpb24gPT0gIlJILUltbXVub2xvZ3kiKSB7Ly9BTjIwMTgwNjA0IHNldCBSSC1JbW11bm9sb2d5IHF1ZXVlIGFuZCByZWNvcmQgdHlwZQogICAgYWxlcnQoIkBAQCBlbnRlcmluZyBSSC1JbW11bm9sb2d5IGxvZ2ljIik7CiAgICB6cEFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIsICJSSC1JbW11bm9sb2d5Iik7IC8vQU4yMDE5MDMxMiB0ZWNoIGRlYnQuIE5lZWQgdG8gcmVtb3ZlIGFsbCByZWZlcmVuY2UgdG8gQ29tcGxldGUgSW1tdW5vbG9neSBhbmQgcmVwbGFjZSB3aXRoIENvbXBsZXRlIEludGFrZSwgaW5jbHVkaW5nIHJlbmFtaW5nIG9mIHZhcmlhYmxlcyBhbmQgcmVjb3JkIHR5cGVzCiAgICAvL2lmICh6RGF0YS52YWxldFF1ZXVlSWQpIHpwQXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgekRhdGEudmFsZXRRdWV1ZUlkKTsgLy9FUlMxOTA5MTEgY2hlY2sgdmFsdWUgLy9BTjIwMjAwNDAxIHJlbW92ZWQgYXMgcGFydCBvZiBNYXkgMjAyMCBzcHJpbnQKICAgIGlmICh6RGF0YS5FbnJvbGxtZW50UXVldWVJZCkgenBBcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5FbnJvbGxtZW50UXVldWVJZCk7IC8vQU4yMDIwMDQwMSBhZGRlZCBhcyBwYXJ0IG9mIE1heSAyMDIwIHNwcmludAogICAgenBBcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIHpEYXRhLnZhbGV0U3RhY2tSZWNvcmRUeXBlSWQpOwogICAgenBBcnJPZlBhaXJzLnB1c2goIkRydWdfVHlwZV9fYyIsICJIdW1pcmEiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiZGItdXNlcnMiLCAiOiIgKyB6RGF0YS52YWxldEdyb3VwSWQgKyAiOiIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJkYi1yZWFkZXJzIiwgIjoiICsgekRhdGEudmFsZXRHcm91cElkICsgIjoiKTsKICAgIGF0dGFjaExhYmVsID0gIk5ldyBTdGFjayByZWNlaXZlZCBvbiAiICsgZm9ybWF0Tm93OwogICAgY3JlYXRlQ2FzZSA9IHRydWU7Cn0gZWxzZSBpZiAoekRhdGEuY2xhc3NpZmljYXRpb24gPT0gIkFSQ0MiKSB7Ly9BTjIwMTgwNjA0IHNldCBBUkNDIHF1ZXVlIGFuZCBJbW11bm9sb2d5IHJlY29yZCB0eXBlCiAgICBhbGVydCgiQEBAIGVudGVyaW5nIEFSQ0MgbG9naWMiKTsKICAgIHpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIiwgIlJILUltbXVub2xvZ3kiKTsgLy9BTjIwMTkwMzEyIHRlY2ggZGVidC4gTmVlZCB0byByZW1vdmUgYWxsIHJlZmVyZW5jZSB0byBDb21wbGV0ZSBJbW11bm9sb2d5IGFuZCByZXBsYWNlIHdpdGggQ29tcGxldGUgSW50YWtlLCBpbmNsdWRpbmcgcmVuYW1pbmcgb2YgdmFyaWFibGVzIGFuZCByZWNvcmQgdHlwZXMKICAgIC8venBBcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5BUkNDUXVldWVJZCk7IC8vQU4yMDIwMDQwMSByZW1vdmVkIGFzIHBhcnQgb2YgTWF5IDIwMjAgc3ByaW50CiAgICB6cEFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHpEYXRhLkltbUF1dGhRdWV1ZUlkKTsgLy9BTjIwMjAwNDAxIGFkZGVkIGFzIHBhcnQgb2YgTWF5IDIwMjAgc3ByaW50CiAgICB6cEFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgekRhdGEudmFsZXRTdGFja1JlY29yZFR5cGVJZCk7CiAgICB6cEFyck9mUGFpcnMucHVzaCgiRHJ1Z19UeXBlX19jIiwgIkh1bWlyYSIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJkYi11c2VycyIsICI6IiArIHpEYXRhLnZhbGV0R3JvdXBJZCArICI6Iik7CiAgICBhcnJPZlBhaXJzLnB1c2goImRiLXJlYWRlcnMiLCAiOiIgKyB6RGF0YS52YWxldEdyb3VwSWQgKyAiOiIpOwogICAgYXR0YWNoTGFiZWwgPSAiTmV3IFN0YWNrIHJlY2VpdmVkIG9uICIgKyBmb3JtYXROb3c7CiAgICBjcmVhdGVDYXNlID0gdHJ1ZTsKfSBlbHNlIGlmICh6RGF0YS5jbGFzc2lmaWNhdGlvbiA9PSAiQVJDQyBPUklBSE5OIikgey8vQU4yMDIwMDQyNyBBUkNDIE9SSUFITk4gLyBXb21lbidzIEhlYWx0aAogICAgYWxlcnQoIkBAQCBlbnRlcmluZyBBUkNDIE9SSUFITk4gbG9naWMiKTsKICAgIHpwQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIiwgIlJILUltbXVub2xvZ3kiKTsgLy9BTjIwMTkwMzEyIHRlY2ggZGVidC4gTmVlZCB0byByZW1vdmUgYWxsIHJlZmVyZW5jZSB0byBDb21wbGV0ZSBJbW11bm9sb2d5IGFuZCByZXBsYWNlIHdpdGggQ29tcGxldGUgSW50YWtlLCBpbmNsdWRpbmcgcmVuYW1pbmcgb2YgdmFyaWFibGVzIGFuZCByZWNvcmQgdHlwZXMKICAgIHpwQXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgekRhdGEuV0hlYWx0aFF1ZXVlSWQpOwogICAgenBBcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIHpEYXRhLnZhbGV0U3RhY2tSZWNvcmRUeXBlSWQpOwogICAgenBBcnJPZlBhaXJzLnB1c2goIkRydWdfVHlwZV9fYyIsICJPUklBSE5OIik7CiAgICBhcnJPZlBhaXJzLnB1c2goImRiLXVzZXJzIiwgIjoiICsgekRhdGEudmFsZXRHcm91cElkICsgIjoiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiZGItcmVhZGVycyIsICI6IiArIHpEYXRhLnZhbGV0R3JvdXBJZCArICI6Iik7CiAgICBhdHRhY2hMYWJlbCA9ICJOZXcgU3RhY2sgcmVjZWl2ZWQgb24gIiArIGZvcm1hdE5vdzsKICAgIGNyZWF0ZUNhc2UgPSB0cnVlOwp9IGVsc2UgaWYgKHpEYXRhLmNsYXNzaWZpY2F0aW9uID09ICJDb21wbGV0ZSBJbW11bm9sb2d5Iikgey8vQU4yMDE4MDYwNCBzZXQgQ29tcGxldGUgSW1tdW5vbG9neSBxdWV1ZSBhbmQgQ29tcGxldGUgSW50YWtlIHJlY29yZCB0eXBlCiAgICBhbGVydCgiQEBAIGVudGVyaW5nIENvbXBsZXRlIEltbXVub2xvZ3kgbG9naWMiKTsKICAgIGFsZXJ0KCJAQEAgekRhdGEuY29tcEltbVN0YWNrUmVjb3JkVHlwZUlkID0gIiArIHpEYXRhLmNvbXBJbW1TdGFja1JlY29yZFR5cGVJZCk7CiAgICB6cEFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIsICJDb21wbGV0ZSBJbnRha2UiKTsKICAgIGlmICh6RGF0YS5jb21wSW1tUXVldWVJZCkgenBBcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5jb21wSW1tUXVldWVJZCk7IC8vRVJTMTkwOTExCiAgICB6cEFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgekRhdGEucGhhcm1TdGFja1JlY29yZFR5cGVJZCk7IC8vQU4yMDE5MDMyNyBmaXJzdCBjcmVhdGVkIHN0YWNrIHNob3VsZCBiZSBmb3IgdGhlIFBoYXJtYWNpc3QKICAgIGFyck9mUGFpcnMucHVzaCgiZGItdXNlcnMiLCAiOiIgKyB6RGF0YS5waGFybUdyb3VwSWQgKyAiOiIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJkYi1yZWFkZXJzIiwgIjoiICsgekRhdGEucGhhcm1Hcm91cElkICsgIjoiKTsKICAgIGF0dGFjaExhYmVsID0gIk5ldyBTdGFjayByZWNlaXZlZCBvbiAiICsgZm9ybWF0Tm93OwogICAgY3JlYXRlQ2FzZSA9IHRydWU7Cn0gZWxzZSBpZiAoekRhdGEuY2xhc3NpZmljYXRpb24gPT0gIkludGFrZSBPUklBSE5OIikgey8vQU4yMDIwMDQyNyBzZXQgT3JpYWhubiAvIE9yaVggLyBXb21lbidzIEhlYWx0aCBxdWV1ZSBhbmQgbG9naWMKICAgIGFsZXJ0KCJAQEAgZW50ZXJpbmcgSW50YWtlIE9SSUFITk4gbG9naWMiKTsKICAgIGFsZXJ0KCJAQEAgekRhdGEuY29tcEltbVN0YWNrUmVjb3JkVHlwZUlkID0gIiArIHpEYXRhLmNvbXBJbW1TdGFja1JlY29yZFR5cGVJZCk7CiAgICB6cEFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIsICJDb21wbGV0ZSBJbnRha2UiKTsKICAgIGlmICh6RGF0YS5jb21wSW50UXVldWVJZCkgenBBcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5jb21wSW50UXVldWVJZCk7CiAgICB6cEFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgekRhdGEucGhhcm1TdGFja1JlY29yZFR5cGVJZCk7IC8vQU4yMDE5MDMyNyBmaXJzdCBjcmVhdGVkIHN0YWNrIHNob3VsZCBiZSBmb3IgdGhlIFBoYXJtYWNpc3QKICAgIGFyck9mUGFpcnMucHVzaCgiZGItdXNlcnMiLCAiOiIgKyB6RGF0YS5waGFybUdyb3VwSWQgKyAiOiIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJkYi1yZWFkZXJzIiwgIjoiICsgekRhdGEucGhhcm1Hcm91cElkICsgIjoiKTsKICAgIGF0dGFjaExhYmVsID0gIk5ldyBTdGFjayByZWNlaXZlZCBvbiAiICsgZm9ybWF0Tm93OwogICAgY3JlYXRlQ2FzZSA9IHRydWU7Cn0gZWxzZSBpZiAoekRhdGEuY2xhc3NpZmljYXRpb24gPT0gIk9uY29sb2d5IEF1dGgiKSB7Ly9BTjIwMjAxMTIwIHNldCBPbmNvbG9neSBBdXRoIHF1ZXVlIGFuZCByZWNvcmQgdHlwZQogICAgYWxlcnQoIkBAQCBlbnRlcmluZyBPbmNvbG9neSBBdXRoIGxvZ2ljIik7CiAgICB6cEFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIsICJSSC1JbW11bm9sb2d5Iik7IC8vQU4yMDE5MDMxMiB0ZWNoIGRlYnQuIE5lZWQgdG8gcmVtb3ZlIGFsbCByZWZlcmVuY2UgdG8gQ29tcGxldGUgSW1tdW5vbG9neSBhbmQgcmVwbGFjZSB3aXRoIENvbXBsZXRlIEludGFrZSwgaW5jbHVkaW5nIHJlbmFtaW5nIG9mIHZhcmlhYmxlcyBhbmQgcmVjb3JkIHR5cGVzCiAgICBpZiAoekRhdGEuT25jb2xvZ3lBdXRoUXVldWVJZCkgenBBcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5PbmNvbG9neUF1dGhRdWV1ZUlkKTsgCiAgICB6cEFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgekRhdGEudmFsZXRTdGFja1JlY29yZFR5cGVJZCk7CiAgICB6cEFyck9mUGFpcnMucHVzaCgiRHJ1Z19UeXBlX19jIiwgIkltYnJ1dmljYSIpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJkYi11c2VycyIsICI6IiArIHpEYXRhLnZhbGV0R3JvdXBJZCArICI6Iik7CiAgICBhcnJPZlBhaXJzLnB1c2goImRiLXJlYWRlcnMiLCAiOiIgKyB6RGF0YS52YWxldEdyb3VwSWQgKyAiOiIpOwogICAgYXR0YWNoTGFiZWwgPSAiTmV3IFN0YWNrIHJlY2VpdmVkIG9uICIgKyBmb3JtYXROb3c7CiAgICBjcmVhdGVDYXNlID0gdHJ1ZTsKfQoKdmFyIHNmSWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCB6U3RhY2ssIGF0dGFjaExhYmVsLCB6cEFyck9mUGFpcnMpOwp2YXIgb3JpZ2luYWxTdGFja0lkID0gc2ZJZDsKc3RhY2tOdW1iZXIgPSBnZXRTRkZpZWxkKGRvYywgelN0YWNrLCAiTmFtZSIsIG51bGwsIHNmSWQpOwphbGVydCgiIyMjIyBTdGFjayBSZWNlaXZlZC4gQXR0YWNoZWQgdG86ICIgKyBzZklkKTsKCmFyck9mUGFpcnMucHVzaCgiZGItbGFiZWwiLCBhdHRhY2hMYWJlbCk7CmFyck9mUGFpcnMucHVzaCgiZGItQkFURVMiLCBzZklkICsgIi1TVEFDSyIpOwphcnJPZlBhaXJzLnB1c2goIlhfc2ZTdGFja0lkIiwgc2ZJZCk7IC8vRVJTMTcwNzI3ICM0MDQ0NwphcnJPZlBhaXJzLnB1c2goIlhfU3RhY2tfTnVtYmVyIiwgc3RhY2tOdW1iZXIpOwoKLy9hc3NpZ24gZG9jIHNlY3VyaXR5LiBWYXJpYWJsZXMgYXJlIGJhc2VkIG9uIHRoZSBpbmJvdW5kIGZheCBsaW5lCmlmICghekRhdGEucGFwR3JvdXBJZCkge3pEYXRhLnBhcEdyb3VwSWQ9ZG9jLmtiRGF0YS5ncm91cElEOyBhbGVydCgiRVJTMjAxMjAzLjE1NCB1c2luZyB6Q2hhbm5lbHM/Iik7IH0gLy9FUlMyMDEyMDMgIzcyNDMzIFRPRE8gV0hFUkUgREVGSU5FRD8KaWYgKCF6RGF0YS52YWxldEdyb3VwSWQpIHt6RGF0YS52YWxldEdyb3VwSWQ9ZG9jLmtiRGF0YS5ncm91cElEOyBhbGVydCgiRVJTMjAxMjAzLjE1NSB1c2luZyB6Q2hhbm5lbHM/Iik7IH0gLy9FUlMyMDEyMDMgIzcyNDMzCmlmICghekRhdGEuY29tcEludEdyb3VwSWQpIHt6RGF0YS5jb21wSW50R3JvdXBJZD1kb2Mua2JEYXRhLmdyb3VwSUQ7IGFsZXJ0KCJFUlMyMDEyMDMuMTU2IHVzaW5nIHpDaGFubmVscz8iKTsgfSAvL0VSUzIwMTIwMyAjNzI0MzMKaWYgKCF6RGF0YS5jbGFzc2lmaWNhdGlvbikge3pEYXRhLmNsYXNzaWZpY2F0aW9uPSJmYXgiOyBhbGVydCgiRVJTMjAxMjAzLjE1NyB1c2luZyB6Q2hhbm5lbHM/Iik7IH0gLy9FUlMyMDEyMDMgIzcyNDMzCmFsZXJ0KCJAQEAgbWFzdGVyIElEIGlzID0gIiArIGRvYy5rYkRhdGEuZ3JvdXBJRCk7CmFsZXJ0KCJAQEAgUEFQIGdyb3VwIElEIGlzID0gIiArIHpEYXRhLnBhcEdyb3VwSWQpOwphbGVydCgiQEBAIFJILUltbXVub2xvZ3kgZ3JvdXAgSUQgaXMgPSAiICsgekRhdGEudmFsZXRHcm91cElkKTsKYWxlcnQoIkBAQCBDb21wbGV0ZSBJbW11bm9sb2d5IGdyb3VwIElEIGlzID0gIiArIHpEYXRhLmNvbXBJbnRHcm91cElkKTsKYWxlcnQoIkBAQCB6RGF0YS5jbGFzc2lmaWNhdGlvbiBpcyAiICsgekRhdGEuY2xhc3NpZmljYXRpb24pOwoKLy9DUk4xODA3MjYgQ2FzZSAjNTA0NjkgLS0gU2V0IHRoZSAiUmVjZWl2ZWQiIGNoZWNrYm94CnZhciBub3cwID0gZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jLCBmYWxzZSwgdHJ1ZSk7CmFsZXJ0KCIkJCQgbm93MCA9ICIgKyBub3cwKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld2VkU3RhdHVzIiwgIlJlY2VpdmVkIik7CmFyck9mUGFpcnMucHVzaCgiWF9yZXZpZXdzIiwgIlJlY2VpdmVkIGJ5IGFnZW50IGF0ICIgKyBub3cwICsgIjxici8+Iik7IC8vRVJTMTcwOTA5ICM0MDU5Mi9DQVcgVXBkYXRlCnVwZGF0ZURCKGRvYywgYXJyT2ZQYWlycyk7CgphbGVydCgiQEBAIHpEYXRhLmNsYXNzaWZpY2F0aW9uID0gIiArIHpEYXRhLmNsYXNzaWZpY2F0aW9uKTsKCi8vQ1JOMTkwMjI2IENyZWF0ZSBjb3B5IG9mIG9yaWdpbmFsIHN0YWNrIC0gd2UgdXNlIHpwQXJyT2ZQYWlycyBhcyBpdCBhbHJlYWR5IGNvbnRhaW5zIG1vc3Qgb2YgdGhlIGRhdGEgdGhhdCB3ZSBuZWVkCmlmICh6RGF0YS5jbGFzc2lmaWNhdGlvbiA9PSAiQ29tcGxldGUgSW1tdW5vbG9neSIgfHwgekRhdGEuY2xhc3NpZmljYXRpb24gPT0gIkludGFrZSBPUklBSE5OIikgewogICAgYWxlcnQoIkBAQCBjcmVhdGluZyBjb3B5IG9mIHpTdGFjayBmb3IgQ29tcGxldGUgSW1tdW5vbG9neSBwcm9ncmFtIik7CgogICAgdmFyIG9yZzJvcmdDUyA9IGRvYy5rYkRhdGEuY3VzdG9tU2V0dGluZ3M7IC8vRVJTMTkwNDExICM1Nzg4MQogICAgYWxlcnQoIkVSUzE5MDQxMSBDUyBhICIgKyAodHlwZW9mIG9yZzJvcmdDUykgKyAiIGhhcyAiICsgb3JnMm9yZ0NTKTsKICAgIGlmIChvcmcyb3JnQ1MpIHsKICAgICAgICB6RGF0YS53YXRlcm1hcmsgPSAiIiArIFhDdXN0b21TZXR0aW5nKGRvYywgIndhdGVybWFya19fYyIpOwogICAgICAgIGFsZXJ0KCJFUlMxOTA0MTEgd209IiArIHpEYXRhLndhdGVybWFyayArICIgWlBBUEVSX19zZXJ2ZXJfX2M9IiArIFhDdXN0b21TZXR0aW5nKGRvYywgIlpQQVBFUl9fc2VydmVyX19jIikpOwogICAgICAgIGlmICghekRhdGEud2F0ZXJtYXJrIHx8IHpEYXRhLndhdGVybWFyayA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICB6RGF0YS53YXRlcm1hcmsgPSAiIjsKICAgICAgICB9CiAgICB9CgogICAgYXJyT2ZQYWlycyA9IFtdOwogICAgdmFyIHBhZ2VDb3VudCA9IFgoZG9jLCAiWF9wYWdlcyIpOwogICAgdmFyIHBhZ2VSYW5nZSA9ICIxLSIgKyBwYWdlQ291bnQ7CiAgICBhbGVydCgiQEBAIHBhZ2VSYW5nZSA9PT0gIiArIHBhZ2VSYW5nZSk7CiAgICAvLyBwdjAyMjUxOCBtYXJrdXAgb24gbm9uIHBoYXJtYWNpc3QgcGFnZXMuCiAgICB2YXIgd2F0ZXJtYXJrID0gIidhZGRUZXh0JywxMCwxLDg3NSwxNDgwLCdDT1BZJywnMjRweCcnIjsgLy9FUlMxOTA0MTEgIzU3ODgxLgogICAgaWYgKHpEYXRhLndhdGVybWFyayAmJiB6RGF0YS53YXRlcm1hcmsgIT0gIiIpIHsgLy9FUlMxOTA0MTEgZ2V0IGZyb20gdGhlIGN1c3RvbSBzZXR0aW5nCiAgICAgICAgd2F0ZXJtYXJrID0gekRhdGEud2F0ZXJtYXJrOwogICAgfQoKICAgIHZhciBidWZmZXIgPSAiIjsKICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IHBhZ2VDb3VudDsgaSsrKSB7CiAgICAgICAgdmFyIGN1clRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAvL0FOMjAxOTAzMTEgcGxhY2UgdGhlIHdvcmQgQ09QWSBvbiBlYWNoIHBhZ2Ugb2YgdGhlIGNvcHkgZG9jdW1lbnQKICAgICAgICBidWZmZXIgKz0gImtibSgnSU1HIiArIGN1clRpbWUgKyAiJywnUEFHRSIgKyBpICsgIklNRyIgKyBjdXJUaW1lICsgIicsIiArIHdhdGVybWFyayArICIpOyI7CiAgICB9CiAgICBhbGVydCgiQEBAQCBvcmlnaW5hbCBkYklEID0gIiArIGRvYy5kYklEKTsKICAgIGFsZXJ0KCJAQEBAIE1BUktVUCA9ICIgKyBidWZmZXIpOwogICAgYWxlcnQoIkBAQEAgT3JpZ2luYWwgU3RhY2sgSWQ6ICIgKyBvcmlnaW5hbFN0YWNrSWQpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJYX21hcmt1cCIsIGJ1ZmZlcik7CgogICAgLy9FUlMgMTkwNDExIGluc3RlYWQgb2Ygc3BsaXQgdGhlbiB3YXRlcm1hcmssIHdhdGVybWFyayBzZW5kIHRvIGZsYXR0ZW4sIGFuZCByZW1vdmUgd2F0ZXJtYXJrIGZyb20gb3JpZ2luYWwKICAgIC8vRVJTMTkwNDExICM1Nzg4MSBmbGF0dGVuIHdpdGggU0Zfc2VuZEZheC5qc3AgYW5kIHVzZSB0aGF0IG5ldyBkYklECiAgICB1cGRhdGVEQihkb2MsIGFyck9mUGFpcnMpOwogICAgdmFyIGZsYXRVUkwgPSAiaHR0cDovL2xvY2FsaG9zdDo4MDgwL2tiL2pzcC9TRl9zZW5kRmF4LmpzcD9mYXhUbz1QREZAIiArIHNmSWQgKyAiJlNGaWRzPSIgKyBzZklkICsgIiZtb2RlPWZpbGVQREYiOwogICAgYWxlcnQoIkVSUzE5MDQxMSBVUkw9IiArIGZsYXRVUkwpOwogICAgdmFyIHNmT3JnSUQgPSBkb2Mua2JEYXRhLnNmT3JnYW5pemF0aW9uSUQ7IC8vVE9ETyBDUk4gdGhlcmUgaXMgYSBTRlNlc3Npb24gaGVyZSBpbnN0ZWFkCiAgICBpZiAoIXNmT3JnSUQgfHwgc2ZPcmdJRC5sZW5ndGggPiAxOCkgeyAvL0VSUzE5MDkxMSAjNjMwNzEgPjE4CiAgICAgICAgc2ZPcmdJRCA9IGRvYy5rYkRhdGEuc2ZTZXNzaW9uSUQuc3Vic3RyaW5nKDAsIGRvYy5rYkRhdGEuc2ZTZXNzaW9uSUQuaW5kZXhPZigiISIpKTsgLy9FUlMxOTA5MTEgIzYzMDcxCiAgICB9CiAgICBmbGF0VVJMICs9ICImU0Zvcmc9IiArIHNmT3JnSUQgKyAiJlNGc2Vzc2lvbj0iICsgZG9jLmtiRGF0YS5zZlNlc3Npb25JRDsKICAgIGZsYXRVUkwgKz0gIiZTRnNlcnZlcj0iKyBkb2Mua2JEYXRhLnNmU2VydmVyOyAvL0VSUzE5MDkxMSAjNjMwNzEKICAgIGZsYXRVUkwgKz0gIiZjb3ZlcklEMj1ub0JhcmNvZGUmY292ZXJJRD0iICsgZG9jLmRiSUQ7IC8vbmV3U25pcHBldElkIGZvciBiYXJjb2RlIGlmIHdlIHdhbnQgd2UgY2FuIHJlbW92ZShjb3ZlcklEMj1ub0JhcmNvZGUpCiAgICBmbGF0VVJMICs9ICImU0Z0eXBlPVpQQVBFUl9felN0YWNrX19jIjsgIC8vRVJTMTkwNDExIFRPRE8gYmV0dGVyIG1pc3NpbmcgcGFyYW1ldGVycwogICAgYWxlcnQoIkVSUzE5MDQxMSBmbGF0dGVuIHdpdGggIiArIGZsYXRVUkwpOwogICAgdmFyIGZsYXREYXRhOwogICAgdmFyIGZsYXRJZD0iIjsKICAgIHZhciB6SGVhZGVycz1bImF1dGhvcml6YXRpb24iLCJaUEFQRVIgV0dFVCJdOyAvL0VSUzE5MDkxMSBUT0RPIGJ5IFN0ZXZlIGEgbmljZSBtZWFsIG91dCAtIGNhc2UgUkVBTExZIG1hdHRlcnMKICAgIGZvciAodmFyIHggPSAwOyB4IDwgMjsgeCsrKSB7IC8vRVJTMTkwOTExIFRPRE8gMiBET05FCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZmxhdERhdGEgPSAiIit3Z2V0KGRvYywgZmxhdFVSTCwgW10sIHpIZWFkZXJzKTsgLy9TRl9zZW5kRmF4LmpzcCBpcyByZXR1cm5pbmcgYSB6aXBwaSBpZCAvL25vICwgbnVsbCwgbnVsbAogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgYWxlcnQoIiM1ODUwNCB3Z2V0IGZhaWxlZCB3aXRoICIrZmxhdFVSTCsiIGV4Y2VwdGlvbjoiK2UpOyAvL0VSUzE5MDkxMAogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoZmxhdERhdGEgJiYgZmxhdERhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmbGF0SWQgPSBYKGRvYywgInppcHBpIiwgZmxhdERhdGEpOwogICAgICAgIH0KICAgICAgICBhbGVydCgiRVJTMTkwNDExIHg9Iit4KyIgZmxhdHRlbmVkIHRvICIgKyBmbGF0SWQgKyAiIGxlbj0iICsgZmxhdElkLmxlbmd0aCk7IC8vKyAiIGZyb20gIitmbGF0RGF0YSk7CiAgICAgICAgYWxlcnQoIkVSUzE5MDQxMiwwOTExQiBhICIgKyAodHlwZW9mIGZsYXRJZCkrIiBmcm9tIHppcHBpIGluICIrIFgoZG9jLCAiemlwcGkiLCBmbGF0RGF0YSkgKyIgd2dldCByZXR1cm5lZCAiK2ZsYXREYXRhLmxlbmd0aCsiIHdpdGggIit6SGVhZGVycyk7IC8vRVJTMTkwOTExCiAgICAgICAgaWYgKGZsYXRJZC5pbmRleE9mKCJ7IikgPT0gMCkgewogICAgICAgICAgICB2YXIgZmxhdEl0ZW0gPSBKU09OLnBhcnNlKGZsYXRJZCk7CiAgICAgICAgICAgIGZsYXRJZCA9IGZsYXRJdGVtWydJdGVtJ107CiAgICAgICAgfQogICAgICAgIGFsZXJ0KCJFUlMxOTA5MTEgIzYzMDcxIGZsYXRJZD0iK2ZsYXRJZCk7CiAgICAgICAgaWYgKGZsYXRJZCkge2JyZWFrO30gLy9FUlMxOTA5MTEKICAgIH0KCiAgICBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goIlhfbWFya3VwIiwgIiIpOwogICAgdXBkYXRlREIoZG9jLCBhcnJPZlBhaXJzKTsKICAgIGFsZXJ0KCIyMjUiKTsKCiAgICBpZiAoIWZsYXRJZCB8fCAoZmxhdElkKyIiKS5sZW5ndGggPCAxNSkgewogICAgICAgIGFsZXJ0KCJFUlMxOTA5MTAgIzU4NTA0IHN0aWxsIG5vIGZsYXRJZCEhICBDYXNlIGNyZWF0ZWQgZnJvbSBlbWFpbC4iKTsKICAgICAgICByZXR1cm47CiAgICB9IGVsc2UgewogICAgdmFyIGNvcHlMYWJlbCA9ICJDb3B5IG9mICIgKyBkb2MubGFiZWw7IC8vVE9ETyB1cGRhdGUgdGhlIGZsYXR0ZW4gZG9jIGxhYmVsCiAgICBhbGVydCgiMjMxOiBzZXR0aW5nIGRvY3VtZW50IGNvbnRleHQgdG8gZGJJRDogIiArIGZsYXRJZCk7CiAgICBzZXREb2N1bWVudENvbnRleHQoZG9jLCBmbGF0SWQpOyAvL0VSUzE5MDQxMiBXQVJOIFdBUk4gV0FSTiBkb2MgaXMgdGhlIENPUFkgZG9jCiAgICBhbGVydCgiMjMzIik7CiAgICBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgY29weUxhYmVsKTsKICAgIHVwZGF0ZURCKGRvYywgYXJyT2ZQYWlycyk7CiAgICBhbGVydCgiMjM3Iik7CiAgICB9CiAgICAKICAgIGFsZXJ0KCJAQEBAIGFmdGVyIHNwbGl0dGluZyBTbmlwcGV0LCBkYklEID0gIiArIGRvYy5kYklEKTsKICAgIHZhciBjb3B5U2ZJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsIHpTdGFjaywgIkNvcHkgb2YgTmV3IFN0YWNrIHJlY2VpdmVkIG9uICIgKyBmb3JtYXROb3csIHpwQXJyT2ZQYWlycyk7CiAgICBhbGVydCgiU3RhY2sgSWQgZm9yIGNvcHkgc3RhY2sgPSAiICsgY29weVNmSWQpOwoKICAgIHZhciBjb3B5U3RhY2tOdW1iZXIgPSBnZXRTRkZpZWxkKGRvYywgelN0YWNrLCAiTmFtZSIsIG51bGwsIGNvcHlTZklkKTsgIC8vQ1JOMTkwMzIxIE1ha2Ugc3VyZSB0aGF0IHRoZSBjb3B5IGlzIGluZGV4ZWQgY29ycmVjdGx5CiAgICBhbGVydCgiQEBAIGNvcHlTdGFja051bWJlciA9ICIgKyBjb3B5U3RhY2tOdW1iZXIpOwogICAgLy9DUk4xOTAyMjYgRml4IHRoZSByZWNlaXZlZElkX19jIGZpZWxkICh3YXMgc2V0IHdpdGggb3JpZ2luYWwgaWQpCiAgICBhcnJPZlBhaXJzID0gW107CgogICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCB6RGF0YS5jb21wSW1tU3RhY2tSZWNvcmRUeXBlSWQpOyAvL0FOMjAxOTAzMDYgdGVjaCBkZWJ0LiBJIGF0dGVtcHRlZCB0byBzZXQgdGhpcyByZWNvcmQgdHlwZSB3aGVuIGNyZWF0aW5nIHRoZSBTdGFjayBidXQgaXQgdGhhdCBkaWRuJ3Qgd29yayBhcyBleHBlY3RlZC4gQ2hhbmdpbmcgdGhlIHJlY29yZCB0eXBlIGFmdGVyIHJlY29yZCBjcmVhdGlvbiB3b3JrcyBidXQgaXMgY2x1bmt5IGFuZCB0ZWNoLWRlYnR5IGFuZCBrbHVkZ2V5CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fcmVjZWl2ZWRJZF9fYyIsIGRvYy5kYklEKTsKICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgelN0YWNrLCBjb3B5U2ZJZCwgYXJyT2ZQYWlycyk7CiAgICAvL0NSTjE5MDIyNiBhbHNvIGZpeCB0aGUgWF9zZlN0YWNrSWQgZmllbGQKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiWF9zZlN0YWNrSWQiLCBjb3B5U2ZJZCk7CiAgICBhcnJPZlBhaXJzLnB1c2goIlhfYXR0YWNoZWRUbyIsIGNvcHlTZklkKTsgLy9FUlMxOTA0MTIgIzU3ODgxCiAgICBhcnJPZlBhaXJzLnB1c2goIlhfU3RhY2tfTnVtYmVyIiwgY29weVN0YWNrTnVtYmVyKTsKCiAgICAvL0FOMjAxOTAzMjcgc2V0IHRoZSBkb2Mgc2VjdXJpdHkgZm9yIENvbXBsZXRlIEludGFrZSBncm91cAogICAgYWxlcnQoIkBAQCBzZXR0aW5nIGRvY3VtZW50IHNlY3VyaXR5IGZvciBDb21wbGV0ZSBJbnRha2UiICsgekRhdGEucGhhcm1Hcm91cElkKTsKICAgIGFyck9mUGFpcnMucHVzaCgiZGItdXNlcnMiLCAiOiIgKyB6RGF0YS5jb21wSW50R3JvdXBJZCArICI6Iik7CiAgICBhcnJPZlBhaXJzLnB1c2goImRiLXJlYWRlcnMiLCAiOiIgKyB6RGF0YS5jb21wSW50R3JvdXBJZCArICI6Iik7CgogICAgdXBkYXRlREIoZG9jLCBhcnJPZlBhaXJzKTsKICAgIC8vQ1JOMTkwMjI2IE1ha2Ugc3VyZSBpdCBpcyBhbHNvIGluIHRoZSBjb3JyZWN0IGluY29taW5nIGZvbGRlcgogICAgdmFyIGluY29taW5nRm9sZGVyID0gZG9jLmtiRGF0YS5ncm91cElELnN1YnN0cmluZygxKSArICJJbiI7CiAgICBhbGVydCgiIyMjIGluY29taW5nRm9sZGVyID0gIiArIGluY29taW5nRm9sZGVyKTsKICAgIG1vdmVEb2N1bWVudChkb2MsIG51bGwsIGluY29taW5nRm9sZGVyKTsKCiAgICAvL3VwZGF0ZSB0aGUgb3JpZ2luYWwgelN0YWNrIGFuZCBtYWtlIGl0IGEgY2hpbGQgb2YgdGhlIGNvcHkgdGhhdCB3ZSBqdXN0IGNyZWF0ZWQKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXJlbnRfX2MiLCBvcmlnaW5hbFN0YWNrSWQpOy8vIFBWMTkwNDE2IHVwZGF0ZWQgZm9yIFBoYXJtYWN5IFNlcnZpY2VzIFN0YWNrIHNob3VsZCB1cGRhdGUgb24gSW50YWtlIFN0YWNrCiAgICB1cGRhdGVTRlJlY29yZChkb2MsIHpTdGFjaywgY29weVNmSWQsIGFyck9mUGFpcnMpOwp9CgphbGVydCgiQEBAIGNyZWF0ZSBjYXNlID0gIiArIGNyZWF0ZUNhc2UpOwppZiAoY3JlYXRlQ2FzZSA9PT0gdHJ1ZSkgeyAvLyBQVjE5MDMyMSBjcmVhdGUgYSBDYXNlIGlmIHRoaXMgaXMgbm90IGEgUEFQIGRvY3VtZW50CiAgICBhbGVydCgiQEBAIGVudGVyaW5nIGNyZWF0ZUNhc2UgbG9naWMiKTsKCiAgICBhcnJPZlBhaXJzID0gW107CgogICAgaWYgKHpEYXRhLmNsYXNzaWZpY2F0aW9uID09ICJSSC1JbW11bm9sb2d5IikgewogICAgICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgekRhdGEudmFsZXRRdWV1ZUlkKTsgLy9BTjIwMjAwNDAxIHJlbW92ZWQgYXMgcGFydCBvZiBNYXkgMjAyMCBzcHJpbnQKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5FbnJvbGxtZW50UXVldWVJZCk7IC8vQU4yMDIwMDQwMSBhZGRlZCBhcyBwYXJ0IG9mIE1heSAyMDIwIHNwcmludAogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgekRhdGEudmFsZXRDYXNlUmVjb3JkVHlwZUlkKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlBTX0Nhc2VTdWJUeXBlX19jIiwgIkJWIEZ1bGwiKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlBTX1JlYXNvbkNvZGVfX2MiLCAiTm9uZSIpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUFNfQ2xhc3NpZmljYXRpb25fX2MiLCAiUkgtSW1tdW5vbG9neSIpOwogICAgfSBlbHNlIGlmICh6RGF0YS5jbGFzc2lmaWNhdGlvbiA9PSAiQVJDQyIpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIHpEYXRhLmF1dGhTdXBwb3J0Q2FzZVJlY29yZFR5cGVJZCk7IC8vQU4yMDIwMDQwMSBhZGRlZCBkdXJpbmcgTWF5IDIwMjAgc3ByaW50CiAgICAgICAgLy9hcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5BUkNDUXVldWVJZCk7IC8vQU4yMDIwMDQwMSByZW1vdmVkIGR1cmluZyBNYXkgMjAyMCBzcHJpbnQKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5JbW1BdXRoUXVldWVJZCk7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJQU19DYXNlU3ViVHlwZV9fYyIsICJEZW5pYWwiKTsgLy9BTjIwMTkxMjMwIGFkZGVkIGR1cmluZyBGZWJydWFyeSAyMDIwIHNwcmludCwgdGhlbiByZW1vdmVkIGR1cmluZyBNYXkgMjAyMCBzcHJpbnQKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlBTX1JlYXNvbkNvZGVfX2MiLCAiTm9uZSIpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUFNfQ2xhc3NpZmljYXRpb25fX2MiLCAiUkgtSW1tdW5vbG9neSIpOwogICAgfSBlbHNlIGlmICh6RGF0YS5jbGFzc2lmaWNhdGlvbiA9PSAiQVJDQyBPUklBSE5OIikgewogICAgICAgIGFsZXJ0KCJAQEAgZW50ZXJpbmcgQVJDQyBPUklBSE5OIENyZWF0ZSBDYXNlIGxvZ2ljIik7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCB6RGF0YS5hdXRoU3VwcG9ydENhc2VSZWNvcmRUeXBlSWQpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHpEYXRhLldIZWFsdGhRdWV1ZUlkKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlBTX0Nhc2VTdWJUeXBlX19jIiwgIkRlbmlhbCIpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUFNfUmVhc29uQ29kZV9fYyIsICJOb25lIik7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJQU19DbGFzc2lmaWNhdGlvbl9fYyIsICJSSC1JbW11bm9sb2d5Iik7IC8vbm90IENPbXBsZXRlIEltbXVub2xvZ3kKICAgIH0gZWxzZSBpZiAoekRhdGEuY2xhc3NpZmljYXRpb24gPT0gIkNvbXBsZXRlIEltbXVub2xvZ3kiKSB7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgekRhdGEuY29tcEludFF1ZXVlSWQpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgekRhdGEuY29tcEludENhc2VSZWNvcmRUeXBlSWQpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUFNfQ2FzZVN1YlR5cGVfX2MiLCAiRW5yb2xsbWVudCIpOwogICAgICAgIC8vQU4yMDE5MDQxMiBjaGFuZ2UgcmVxdWVzdCBwZXIgVmVua2F0IGR1cmluZyB0aGUgQ29tcGxldGUgSW50YWtlIHByb2plY3QKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlBTX0NsYXNzaWZpY2F0aW9uX19jIiwgIkNvbXBsZXRlIEltbXVub2xvZ3kiKTsKICAgIH0KICAgIGVsc2UgaWYgKHpEYXRhLmNsYXNzaWZpY2F0aW9uID09ICJJbnRha2UgT1JJQUhOTiIpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIk93bmVySWQiLCB6RGF0YS5XSGVhbHRoUXVldWVJZCk7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCB6RGF0YS5hdXRoU3VwcG9ydENhc2VSZWNvcmRUeXBlSWQpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUFNfQ2FzZVN1YlR5cGVfX2MiLCAiRGVuaWFsIik7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJQU19DbGFzc2lmaWNhdGlvbl9fYyIsICJSSC1JbW11bm9sb2d5Iik7CiAgICB9CgogICAgYXJyT2ZQYWlycy5wdXNoKCJTdGF0dXMiLCAiTmV3Iik7CiAgICBhcnJPZlBhaXJzLnB1c2goIk9yaWdpbiIsICJGYXggLyBIQ1AiKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUHJpb3JpdHkiLCAiU3RhbmRhcmQiKTsKCiAgICAvL3NldCB6UGFwZXIgd29ya2Zsb3cgZmllbGRzIG9uIHRoZSBjYXNlCiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgZm9ybWF0Tm93KTsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19yZWNlaXZlZElkX19jIiwgZG9jLmRiSUQpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX25ld0ZheF9fYyIsICJ0cnVlIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fZmF4VHlwZV9fYyIsIHpUeXBlKTsgLy9BTjIwMTgwNzEyIGR1cmluZyBjb2RlIHJldmlldywgcGF5IGF0dGVudGlvbiB0byB0aGlzCiAgICBhcnJPZlBhaXJzLnB1c2goInpDYWxsZXJfSURfX2MiLCBkb2MuZGVsaXZlcmVkRnJvbSk7IC8vQU4yMDE4MDcxNyBhZGRlZCB0aGlzCgogICAgLy9BTjIwMDgwNzE3IGxpbmsgdG8gcGFyZW50IHpTdGFjawogICAgaWYgKGNvcHlTZklkKSB7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJ6U3RhY2tfX2MiLCBjb3B5U2ZJZCk7CiAgICB9IGVsc2UgewogICAgICAgIGFyck9mUGFpcnMucHVzaCgielN0YWNrX19jIiwgc2ZJZCk7IC8vQU4yMDA4MDcxNyBsaW5rIHRvIHBhcmVudCB6U3RhY2sKICAgIH0KCiAgICAvLyBUUE0xODA4MTMgY2hhbmdlZCB0byBub3QgYXR0YWNoIGRvYyB0byBjYXNlIHJlY29yZCBpbiB6ZG9jc2V0CiAgICBjcmVhdGVTRlJlY29yZChkb2MsICJDYXNlIiwgIk5ldyBmYXggcmVjZWl2ZWQgb24gIiArIGZvcm1hdE5vdywgYXJyT2ZQYWlycyk7Cn0KLyogRU5EIENyZWF0ZSBTdGFjayBmcm9tIEZheCAqLw=="},"ordinal":22}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
/* BEGIN Create Stack from Fax */
var createCase = false; //AN20180712 flag to track if we want to create a Case or not
var stackNumber;// = ""; //AN20190305 moving declaration to top of rule
var attachLabel = "";
var zType = doc.X("X_docType");
var formatNow = getCurDateAndTime(doc);
var channel = "Fax";
var zpArrOfPairs = []; //AN20180713 declaring a separate array for use in setting zPaper doc security
var zStack = "ZPAPER__zStack__c";
var arrOfPairs = [];

var fromFile = X(doc, "X_fromFile");
//CRN190308 Handle uploaded files via Lightning Component
if (fromFile && fromFile.indexOf("lightningUpload") >= 0) {
    fromFile = fromFile.substring(fromFile.lastIndexOf('/') + 1);
    var parts = fromFile.split("-");
    if (parts.length >= 3) {
        var attachToId = parts[2];
        alert("@@@ UPLOAD: ATTACHING TO SALESFORCE RECORD = " + attachToId);
        var label = "File uploaded by " + parts[0];
        attach(doc, label, attachToId, true);
        var arrOfPairsLocal = [];
        arrOfPairsLocal.push("db-label", label);
        updateDB(doc, arrOfPairsLocal);
        return;
    }
}

//ERS170328 docType by OCR
zData.docTypeOCR = zData.docTyper(doc, {
    "PAPP": "Patient~ Assistance~",
    "PAUTH": "Prior~ Authorization~",
    "ENRL": "Enrollment~",
    "FAX": ""
});

alert("docType was " + doc.docType + " now " + zData.docTypeOCR);
if (doc.docType != zData.docTypeOCR) {
    var arrOfPairs0 = [];
    arrOfPairs0.push("X_docTypeOCR", zData.docTypeOCR);
    arrOfPairs0.push("X_docType", zData.docTypeOCR);
    zType = zData.docTypeOCR; //ERS170330 saved below into SF faxType__c field
    updateDB(doc, arrOfPairs0);
}

if (isNaN(doc.deliveredFrom)) { // Not a Number is true
    channel = "Email";
}

zpArrOfPairs.push("ZPAPER__faxType__c", zType);
zpArrOfPairs.push("ZPAPER__Priority__c", "Medium");
zpArrOfPairs.push("ZPAPER__Status__c", "New Stack");
zpArrOfPairs.push("ZPAPER__Channel__c", channel);

// MSH171116 using zStack_Received__c instead of latestFax__c because latestFax__c gets updated by save.jsp every time the record is updated
zpArrOfPairs.push("zStack_Received__c", formatNow);
zpArrOfPairs.push("ZPAPER__receivedId__c", doc.dbID);
zpArrOfPairs.push("ZPAPER__newFax__c", "true");
zpArrOfPairs.push("ZPAPER__Pages__c", X(doc, "X_pages"));
zpArrOfPairs.push("ZPAPER__Program_Name__c", zData.classification);
zpArrOfPairs.push("ZPAPER__sentFaxTo__c", doc.deliveredTo); //ERS170628 caller id
zpArrOfPairs.push("ZPAPER__From__c", doc.deliveredFrom);
zpArrOfPairs.push("zCaller_ID__c", doc.deliveredFrom); //MSH170817 added
zpArrOfPairs.push("ZPAPER__Stage__c", "Received"); //ERS170731 #40593

alert("@@@ Classification = " + zData.classification);

//AN20180712 for code review: we have multiple IF iterations involving zData.classifcation. Can we combine them?
if (zData.classification == "PAP") { //AN20180604 set PAP queue and record type
    alert("@@@ entering PAP logic");
    zpArrOfPairs.push("ZPAPER__Classification__c", "PAP"); //AN20190312 tech debt. Need to remove all reference to Complete Immunology and replace with Complete Intake, including renaming of variables and record types
    if (zData.papQueueId) zpArrOfPairs.push("OwnerId", zData.papQueueId); //ERS190911 check value
    zpArrOfPairs.push("RecordTypeId", zData.papStackRecordTypeId);
    zpArrOfPairs.push("Drug_Type__c", "Humira");
    arrOfPairs.push("db-users", ":" + zData.papGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.papGroupId + ":");
    attachLabel = "New Stack received on " + formatNow;
    createCase = false;
} else if (zData.classification == "RH-Immunology") {//AN20180604 set RH-Immunology queue and record type
    alert("@@@ entering RH-Immunology logic");
    zpArrOfPairs.push("ZPAPER__Classification__c", "RH-Immunology"); //AN20190312 tech debt. Need to remove all reference to Complete Immunology and replace with Complete Intake, including renaming of variables and record types
    //if (zData.valetQueueId) zpArrOfPairs.push("OwnerId", zData.valetQueueId); //ERS190911 check value //AN20200401 removed as part of May 2020 sprint
    if (zData.EnrollmentQueueId) zpArrOfPairs.push("OwnerId", zData.EnrollmentQueueId); //AN20200401 added as part of May 2020 sprint
    zpArrOfPairs.push("RecordTypeId", zData.valetStackRecordTypeId);
    zpArrOfPairs.push("Drug_Type__c", "Humira");
    arrOfPairs.push("db-users", ":" + zData.valetGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.valetGroupId + ":");
    attachLabel = "New Stack received on " + formatNow;
    createCase = true;
} else if (zData.classification == "ARCC") {//AN20180604 set ARCC queue and Immunology record type
    alert("@@@ entering ARCC logic");
    zpArrOfPairs.push("ZPAPER__Classification__c", "RH-Immunology"); //AN20190312 tech debt. Need to remove all reference to Complete Immunology and replace with Complete Intake, including renaming of variables and record types
    //zpArrOfPairs.push("OwnerId", zData.ARCCQueueId); //AN20200401 removed as part of May 2020 sprint
    zpArrOfPairs.push("OwnerId", zData.ImmAuthQueueId); //AN20200401 added as part of May 2020 sprint
    zpArrOfPairs.push("RecordTypeId", zData.valetStackRecordTypeId);
    zpArrOfPairs.push("Drug_Type__c", "Humira");
    arrOfPairs.push("db-users", ":" + zData.valetGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.valetGroupId + ":");
    attachLabel = "New Stack received on " + formatNow;
    createCase = true;
} else if (zData.classification == "ARCC ORIAHNN") {//AN20200427 ARCC ORIAHNN / Women's Health
    alert("@@@ entering ARCC ORIAHNN logic");
    zpArrOfPairs.push("ZPAPER__Classification__c", "RH-Immunology"); //AN20190312 tech debt. Need to remove all reference to Complete Immunology and replace with Complete Intake, including renaming of variables and record types
    zpArrOfPairs.push("OwnerId", zData.WHealthQueueId);
    zpArrOfPairs.push("RecordTypeId", zData.valetStackRecordTypeId);
    zpArrOfPairs.push("Drug_Type__c", "ORIAHNN");
    arrOfPairs.push("db-users", ":" + zData.valetGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.valetGroupId + ":");
    attachLabel = "New Stack received on " + formatNow;
    createCase = true;
} else if (zData.classification == "Complete Immunology") {//AN20180604 set Complete Immunology queue and Complete Intake record type
    alert("@@@ entering Complete Immunology logic");
    alert("@@@ zData.compImmStackRecordTypeId = " + zData.compImmStackRecordTypeId);
    zpArrOfPairs.push("ZPAPER__Classification__c", "Complete Intake");
    if (zData.compImmQueueId) zpArrOfPairs.push("OwnerId", zData.compImmQueueId); //ERS190911
    zpArrOfPairs.push("RecordTypeId", zData.pharmStackRecordTypeId); //AN20190327 first created stack should be for the Pharmacist
    arrOfPairs.push("db-users", ":" + zData.pharmGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.pharmGroupId + ":");
    attachLabel = "New Stack received on " + formatNow;
    createCase = true;
} else if (zData.classification == "Intake ORIAHNN") {//AN20200427 set Oriahnn / OriX / Women's Health queue and logic
    alert("@@@ entering Intake ORIAHNN logic");
    alert("@@@ zData.compImmStackRecordTypeId = " + zData.compImmStackRecordTypeId);
    zpArrOfPairs.push("ZPAPER__Classification__c", "Complete Intake");
    if (zData.compIntQueueId) zpArrOfPairs.push("OwnerId", zData.compIntQueueId);
    zpArrOfPairs.push("RecordTypeId", zData.pharmStackRecordTypeId); //AN20190327 first created stack should be for the Pharmacist
    arrOfPairs.push("db-users", ":" + zData.pharmGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.pharmGroupId + ":");
    attachLabel = "New Stack received on " + formatNow;
    createCase = true;
} else if (zData.classification == "Oncology Auth") {//AN20201120 set Oncology Auth queue and record type
    alert("@@@ entering Oncology Auth logic");
    zpArrOfPairs.push("ZPAPER__Classification__c", "RH-Immunology"); //AN20190312 tech debt. Need to remove all reference to Complete Immunology and replace with Complete Intake, including renaming of variables and record types
    if (zData.OncologyAuthQueueId) zpArrOfPairs.push("OwnerId", zData.OncologyAuthQueueId); 
    zpArrOfPairs.push("RecordTypeId", zData.valetStackRecordTypeId);
    zpArrOfPairs.push("Drug_Type__c", "Imbruvica");
    arrOfPairs.push("db-users", ":" + zData.valetGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.valetGroupId + ":");
    attachLabel = "New Stack received on " + formatNow;
    createCase = true;
}

var sfId = createAndAttach(doc, zStack, attachLabel, zpArrOfPairs);
var originalStackId = sfId;
stackNumber = getSFField(doc, zStack, "Name", null, sfId);
alert("#### Stack Received. Attached to: " + sfId);

arrOfPairs.push("db-label", attachLabel);
arrOfPairs.push("db-BATES", sfId + "-STACK");
arrOfPairs.push("X_sfStackId", sfId); //ERS170727 #40447
arrOfPairs.push("X_Stack_Number", stackNumber);

//assign doc security. Variables are based on the inbound fax line
if (!zData.papGroupId) {zData.papGroupId=doc.kbData.groupID; alert("ERS201203.154 using zChannels?"); } //ERS201203 #72433 TODO WHERE DEFINED?
if (!zData.valetGroupId) {zData.valetGroupId=doc.kbData.groupID; alert("ERS201203.155 using zChannels?"); } //ERS201203 #72433
if (!zData.compIntGroupId) {zData.compIntGroupId=doc.kbData.groupID; alert("ERS201203.156 using zChannels?"); } //ERS201203 #72433
if (!zData.classification) {zData.classification="fax"; alert("ERS201203.157 using zChannels?"); } //ERS201203 #72433
alert("@@@ master ID is = " + doc.kbData.groupID);
alert("@@@ PAP group ID is = " + zData.papGroupId);
alert("@@@ RH-Immunology group ID is = " + zData.valetGroupId);
alert("@@@ Complete Immunology group ID is = " + zData.compIntGroupId);
alert("@@@ zData.classification is " + zData.classification);

//CRN180726 Case #50469 -- Set the "Received" checkbox
var now0 = getCurDateAndTime(doc, false, true);
alert("$$$ now0 = " + now0);
arrOfPairs.push("X_reviewedStatus", "Received");
arrOfPairs.push("X_reviews", "Received by agent at " + now0 + "<br/>"); //ERS170909 #40592/CAW Update
updateDB(doc, arrOfPairs);

alert("@@@ zData.classification = " + zData.classification);

//CRN190226 Create copy of original stack - we use zpArrOfPairs as it already contains most of the data that we need
if (zData.classification == "Complete Immunology" || zData.classification == "Intake ORIAHNN") {
    alert("@@@ creating copy of zStack for Complete Immunology program");

    var org2orgCS = doc.kbData.customSettings; //ERS190411 #57881
    alert("ERS190411 CS a " + (typeof org2orgCS) + " has " + org2orgCS);
    if (org2orgCS) {
        zData.watermark = "" + XCustomSetting(doc, "watermark__c");
        alert("ERS190411 wm=" + zData.watermark + " ZPAPER__server__c=" + XCustomSetting(doc, "ZPAPER__server__c"));
        if (!zData.watermark || zData.watermark == "undefined") {
            zData.watermark = "";
        }
    }

    arrOfPairs = [];
    var pageCount = X(doc, "X_pages");
    var pageRange = "1-" + pageCount;
    alert("@@@ pageRange === " + pageRange);
    // pv022518 markup on non pharmacist pages.
    var watermark = "'addText',10,1,875,1480,'COPY','24px''"; //ERS190411 #57881.
    if (zData.watermark && zData.watermark != "") { //ERS190411 get from the custom setting
        watermark = zData.watermark;
    }

    var buffer = "";
    for (var i = 1; i <= pageCount; i++) {
        var curTime = new Date().getTime();
        //AN20190311 place the word COPY on each page of the copy document
        buffer += "kbm('IMG" + curTime + "','PAGE" + i + "IMG" + curTime + "'," + watermark + ");";
    }
    alert("@@@@ original dbID = " + doc.dbID);
    alert("@@@@ MARKUP = " + buffer);
    alert("@@@@ Original Stack Id: " + originalStackId);
    arrOfPairs.push("X_markup", buffer);

    //ERS 190411 instead of split then watermark, watermark send to flatten, and remove watermark from original
    //ERS190411 #57881 flatten with SF_sendFax.jsp and use that new dbID
    updateDB(doc, arrOfPairs);
    var flatURL = "http://localhost:8080/kb/jsp/SF_sendFax.jsp?faxTo=PDF@" + sfId + "&SFids=" + sfId + "&mode=filePDF";
    alert("ERS190411 URL=" + flatURL);
    var sfOrgID = doc.kbData.sfOrganizationID; //TODO CRN there is a SFSession here instead
    if (!sfOrgID || sfOrgID.length > 18) { //ERS190911 #63071 >18
        sfOrgID = doc.kbData.sfSessionID.substring(0, doc.kbData.sfSessionID.indexOf("!")); //ERS190911 #63071
    }
    flatURL += "&SForg=" + sfOrgID + "&SFsession=" + doc.kbData.sfSessionID;
    flatURL += "&SFserver="+ doc.kbData.sfServer; //ERS190911 #63071
    flatURL += "&coverID2=noBarcode&coverID=" + doc.dbID; //newSnippetId for barcode if we want we can remove(coverID2=noBarcode)
    flatURL += "&SFtype=ZPAPER__zStack__c";  //ERS190411 TODO better missing parameters
    alert("ERS190411 flatten with " + flatURL);
    var flatData;
    var flatId="";
    var zHeaders=["authorization","ZPAPER WGET"]; //ERS190911 TODO by Steve a nice meal out - case REALLY matters
    for (var x = 0; x < 2; x++) { //ERS190911 TODO 2 DONE
        try {
            flatData = ""+wget(doc, flatURL, [], zHeaders); //SF_sendFax.jsp is returning a zippi id //no , null, null
        } catch (e) {
            alert("#58504 wget failed with "+flatURL+" exception:"+e); //ERS190910
        }
        
        if (flatData && flatData.length > 0) {
            flatId = X(doc, "zippi", flatData);
        }
        alert("ERS190411 x="+x+" flattened to " + flatId + " len=" + flatId.length); //+ " from "+flatData);
        alert("ERS190412,0911B a " + (typeof flatId)+" from zippi in "+ X(doc, "zippi", flatData) +" wget returned "+flatData.length+" with "+zHeaders); //ERS190911
        if (flatId.indexOf("{") == 0) {
            var flatItem = JSON.parse(flatId);
            flatId = flatItem['Item'];
        }
        alert("ERS190911 #63071 flatId="+flatId);
        if (flatId) {break;} //ERS190911
    }

    arrOfPairs = [];
    arrOfPairs.push("X_markup", "");
    updateDB(doc, arrOfPairs);
    alert("225");

    if (!flatId || (flatId+"").length < 15) {
        alert("ERS190910 #58504 still no flatId!!  Case created from email.");
        return;
    } else {
    var copyLabel = "Copy of " + doc.label; //TODO update the flatten doc label
    alert("231: setting document context to dbID: " + flatId);
    setDocumentContext(doc, flatId); //ERS190412 WARN WARN WARN doc is the COPY doc
    alert("233");
    arrOfPairs = [];
    arrOfPairs.push("db-label", copyLabel);
    updateDB(doc, arrOfPairs);
    alert("237");
    }
    
    alert("@@@@ after splitting Snippet, dbID = " + doc.dbID);
    var copySfId = createAndAttach(doc, zStack, "Copy of New Stack received on " + formatNow, zpArrOfPairs);
    alert("Stack Id for copy stack = " + copySfId);

    var copyStackNumber = getSFField(doc, zStack, "Name", null, copySfId);  //CRN190321 Make sure that the copy is indexed correctly
    alert("@@@ copyStackNumber = " + copyStackNumber);
    //CRN190226 Fix the receivedId__c field (was set with original id)
    arrOfPairs = [];

    arrOfPairs.push("RecordTypeId", zData.compImmStackRecordTypeId); //AN20190306 tech debt. I attempted to set this record type when creating the Stack but it that didn't work as expected. Changing the record type after record creation works but is clunky and tech-debty and kludgey
    arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID);
    updateSFRecord(doc, zStack, copySfId, arrOfPairs);
    //CRN190226 also fix the X_sfStackId field
    arrOfPairs = [];
    arrOfPairs.push("X_sfStackId", copySfId);
    arrOfPairs.push("X_attachedTo", copySfId); //ERS190412 #57881
    arrOfPairs.push("X_Stack_Number", copyStackNumber);

    //AN20190327 set the doc security for Complete Intake group
    alert("@@@ setting document security for Complete Intake" + zData.pharmGroupId);
    arrOfPairs.push("db-users", ":" + zData.compIntGroupId + ":");
    arrOfPairs.push("db-readers", ":" + zData.compIntGroupId + ":");

    updateDB(doc, arrOfPairs);
    //CRN190226 Make sure it is also in the correct incoming folder
    var incomingFolder = doc.kbData.groupID.substring(1) + "In";
    alert("### incomingFolder = " + incomingFolder);
    moveDocument(doc, null, incomingFolder);

    //update the original zStack and make it a child of the copy that we just created
    arrOfPairs = [];
    arrOfPairs.push("ZPAPER__Parent__c", originalStackId);// PV190416 updated for Pharmacy Services Stack should update on Intake Stack
    updateSFRecord(doc, zStack, copySfId, arrOfPairs);
}

alert("@@@ create case = " + createCase);
if (createCase === true) { // PV190321 create a Case if this is not a PAP document
    alert("@@@ entering createCase logic");

    arrOfPairs = [];

    if (zData.classification == "RH-Immunology") {
        //arrOfPairs.push("OwnerId", zData.valetQueueId); //AN20200401 removed as part of May 2020 sprint
        arrOfPairs.push("OwnerId", zData.EnrollmentQueueId); //AN20200401 added as part of May 2020 sprint
        arrOfPairs.push("RecordTypeId", zData.valetCaseRecordTypeId);
        arrOfPairs.push("PS_CaseSubType__c", "BV Full");
        arrOfPairs.push("PS_ReasonCode__c", "None");
        arrOfPairs.push("PS_Classification__c", "RH-Immunology");
    } else if (zData.classification == "ARCC") {
        arrOfPairs.push("RecordTypeId", zData.authSupportCaseRecordTypeId); //AN20200401 added during May 2020 sprint
        //arrOfPairs.push("OwnerId", zData.ARCCQueueId); //AN20200401 removed during May 2020 sprint
        arrOfPairs.push("OwnerId", zData.ImmAuthQueueId);
        arrOfPairs.push("PS_CaseSubType__c", "Denial"); //AN20191230 added during February 2020 sprint, then removed during May 2020 sprint
        arrOfPairs.push("PS_ReasonCode__c", "None");
        arrOfPairs.push("PS_Classification__c", "RH-Immunology");
    } else if (zData.classification == "ARCC ORIAHNN") {
        alert("@@@ entering ARCC ORIAHNN Create Case logic");
        arrOfPairs.push("RecordTypeId", zData.authSupportCaseRecordTypeId);
        arrOfPairs.push("OwnerId", zData.WHealthQueueId);
        arrOfPairs.push("PS_CaseSubType__c", "Denial");
        arrOfPairs.push("PS_ReasonCode__c", "None");
        arrOfPairs.push("PS_Classification__c", "RH-Immunology"); //not COmplete Immunology
    } else if (zData.classification == "Complete Immunology") {
        arrOfPairs.push("OwnerId", zData.compIntQueueId);
        arrOfPairs.push("RecordTypeId", zData.compIntCaseRecordTypeId);
        arrOfPairs.push("PS_CaseSubType__c", "Enrollment");
        //AN20190412 change request per Venkat during the Complete Intake project
        arrOfPairs.push("PS_Classification__c", "Complete Immunology");
    }
    else if (zData.classification == "Intake ORIAHNN") {
        arrOfPairs.push("OwnerId", zData.WHealthQueueId);
        arrOfPairs.push("RecordTypeId", zData.authSupportCaseRecordTypeId);
        arrOfPairs.push("PS_CaseSubType__c", "Denial");
        arrOfPairs.push("PS_Classification__c", "RH-Immunology");
    }

    arrOfPairs.push("Status", "New");
    arrOfPairs.push("Origin", "Fax / HCP");
    arrOfPairs.push("Priority", "Standard");

    //set zPaper workflow fields on the case
    arrOfPairs.push("ZPAPER__latestFax__c", formatNow);
    arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID);
    arrOfPairs.push("ZPAPER__newFax__c", "true");
    arrOfPairs.push("ZPAPER__faxType__c", zType); //AN20180712 during code review, pay attention to this
    arrOfPairs.push("zCaller_ID__c", doc.deliveredFrom); //AN20180717 added this

    //AN20080717 link to parent zStack
    if (copySfId) {
        arrOfPairs.push("zStack__c", copySfId);
    } else {
        arrOfPairs.push("zStack__c", sfId); //AN20080717 link to parent zStack
    }

    // TPM180813 changed to not attach doc to case record in zdocset
    createSFRecord(doc, "Case", "New fax received on " + formatNow, arrOfPairs);
}
/* END Create Stack from Fax */
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
//--- RULE VALIDATION CODE - END ---

</script>
