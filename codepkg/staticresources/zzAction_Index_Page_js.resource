<!--
// Name: Index Page
// Committer: cory.newey@zpaper.com
// Update: Always checking priority even if we have a patient account.
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2019-12-18 23:19:42","active":true,"button":"Index","name":"Index Page","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Index","operation":"equals"}]},"consequence":{"doit":"YWxlcnQoIkBAQEAgSW5kZXggUnVsZSBGaXJlZCBAQEAjIik7Ci8vRVJTMTkwNzMwICM2MTI3MiB1cGRhdGVkIGJ1dHRvbiB2YWxpZGF0aW9uIGluIHRoZSBBY3Rpb25zKiBEZXRhaWxzIGFyZWEKCnZhciBzdGFja0lkID0gWChkb2MsICJYX3N0YWNrIik7CmlmICghc3RhY2tJZCkgc3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7IC8vRVJTMTkwNjI0IEhBQ0s/CnZhciBzdGFja0ZvbGRlciA9IHN0YWNrSWQgKyAiLVNUQUNLIjsKdmFyIGNvbXBhbnlDb2RlID0gZG9jLmRlbGl2ZXJlZFRvOwp6RGF0YS5zdGFnZT0iSW5kZXhlZCI7IC8vRVJTMTkwNjIwCgovKiBDbGVhciB0aGUgdHJpZ2dlciB0aGF0IGludm9rZWQgdGhpcyBydWxlICovCi8vRVJTMTcwOTA5IHpEYXRhLmNsZWFyVHJpZ2dlckNvbmRpdGlvbihkb2MsIlhfYnV0dG9uQWN0aW9uIik7CnZhciBpbmRleEluaXRpYWxpemVkID0gWChkb2MsIlhfaW5kZXhJbml0aWFsaXplZCIpOwppZiAoIWluZGV4SW5pdGlhbGl6ZWQgfHwgMCA9PT0gaW5kZXhJbml0aWFsaXplZC5sZW5ndGgpIHsKICAgIHN0YWNrSWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOwogICAgc3RhY2tGb2xkZXIgPSBzdGFja0lkICsgIi1TVEFDSyI7CiAgICB6RGF0YS5pbml0aWFsaXplU3RhY2soZG9jLHN0YWNrRm9sZGVyLCBjb21wYW55Q29kZSwgc3RhY2tJZCk7Cn0KCnNhdmVERVBhbmVsVmFsdWVzKGRvYyk7ICAgICAgICAgICAgIC8vQ1JOMTkxMTE4IFNhdmUgREUgRmllbGRzIHRvIFBhcmVudCBTdGFjawp6RGF0YS5nZXREYXRhRW50cnlGaWVsZHMoZG9jKTsKLy8gRG9lcyB0aGUgdXNlciB3YW50IHRvIGF0dGFjaCBpbmRleGVkIHBhZ2VzIHRvIENhc2U/Ci8vdmFyIGNhc2VJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX0Nhc2VfX2MiKTsKLy92YXIgY29udGFjdElkID0gWChkb2MsICJYX1pQQVBFUl9fUGF0aWVudF9fYyIpOwovL3ZhciBwYXRpZW50SWQ9Y29udGFjdElkOyAvL1RPRE8KLy92YXIgcHJvdmlkZXJJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX1Byb3ZpZGVyX19jIik7Ci8vdmFyIHBhdGllbnRGaXJzdE5hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiKTsKLy92YXIgcGF0aWVudExhc3ROYW1lID0gWChkb2MsICJYX1pQQVBFUl9fTGFzdE5hbWVfX2MiKTsKLy92YXIgcGF0aWVudERPQiA9IFgoZG9jLCAiWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyIpOwoKLy8gR2V0IHRoZSBkb2N1bWVudCB0eXBlICh3aWxsIGJlIHVzZWQgdG8gcm91dGUgdG8gbmV4dCBmb2xkZXIpCi8vdmFyIGRvY1R5cGUgPSBYKGRvYywgIlhfRG9jdW1lbnRfVHlwZV9fYyIpOwp2YXIgbmV4dEZvbGRlciA9ICIyMDUwMFRyaWFnZS1TMiI7ICAgICAgICAgICAgICAvLyBPdGhlciBmb2xkZXIgaXMgdGhlIGRlZmF1bHQKdmFyIHByZXZJbmRleFBhZ2VzID0gWChkb2MsICJYX2luZGV4ZWRQYWdlcyIpOwp2YXIgY3VySW5kZXhQYWdlcyA9IFgoZG9jLCAiWF9pZHhQYWdlcyIpOwppZiAocHJldkluZGV4UGFnZXMgJiYgcHJldkluZGV4UGFnZXMubGVuZ3RoID4gMCAmJiBjdXJJbmRleFBhZ2VzICYmIGN1ckluZGV4UGFnZXMubGVuZ3RoID4gMCkgewogICAgcHJldkluZGV4UGFnZXMgKz0gIiwiOwp9CmN1ckluZGV4UGFnZXMgPSBwcmV2SW5kZXhQYWdlcyArIGN1ckluZGV4UGFnZXM7CnZhciBhcnJPZlBhaXJzID0gW107CmFyck9mUGFpcnMucHVzaCgiWF9pbmRleGVkUGFnZXMiLCBjdXJJbmRleFBhZ2VzKTsKLy9tb3ZlIHRvIGFmdGVyIHVwZGF0ZXMgYXJyT2ZQYWlycz16RGF0YS5hZGRTdGFnZShkb2MsYXJyT2ZQYWlycywiSW5kZXhlZCIpOwp1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7CgovL3ZhciBzZlN0YWNrSWQ9ekRhdGEuZ2V0U3RhY2tJZChkb2MpOwp2YXIgc2ZTdGFja0lkPVgoZG9jLCdYX3NmU3RhY2tJZCcpOwppZighc2ZTdGFja0lkKXsKICBzZlN0YWNrSWQ9ekRhdGEuZ2V0U3RhY2tJZChkb2MpOwp9CgphbGVydCgiQEBAQEBAIEN1cnJlbnRseSBhdHRhY2hlZCB0byBaUEFQRVJfX3pTdGFja19fYyB3aXRoIElEOiAiICsgc2ZTdGFja0lkKTsKekRhdGEuelBhcmVudElkPWRvYy5kYklEOyAvL0VSUzE5MDgxNCB0byBvdmVyc2lkZSB0aGUgc2F2ZS5qc3Agd29ya2Zsb3dzCgphbGVydCgiQEBAQCBQYXJlbnQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBYKGRvYywgIlhfYXR0YWNoZWRUbyIpKTsKCi8qIFNQTElUIE9GRiBORVcgU05JUFBFVCBIRVJFICovCnZhciBwYWdlUmFuZ2UgPSBYKGRvYywiWF9pZHhQYWdlcyIpOwp2YXIgbmV3SWQ9c3BsaXREb2N1bWVudEZvckluZGV4KGRvYywgImluZGV4IiwgcGFnZVJhbmdlKTsKCmFsZXJ0KCJAQEBAIEFGVEVSIFNQTElUOiBDaGlsZCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIFgoZG9jLCAiWF9hdHRhY2hlZFRvIikpOwoKc2F2ZURFUGFuZWxWYWx1ZXMoZG9jKTsgICAgICAgICAgICAgLy9DUk4xOTExMTggQWxzbyBTYXZlIERFIEZpZWxkcyB0byBDaGlsZCBTdGFjawoKYWxlcnQoIkVSUzE5MDYyNCBuZXdJZD0iK25ld0lkKTsKLy8qCi8qIEFGVEVSIFRISVMgUE9JTlQsIFRIRSBET0MgV0lMTCBIT0xEIERBVEEgRk9SIE5FVyBTTklQUEVULCBOT1QgVEhFIFNUQUNLIFNOSVBQRVQgKi8KLy8qCgovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIGEgbmV3IENhc2UgcmVjb3JkLCBpZiBpdCB3YXNuJ3QgcGFzc2VkIGluIGFuZCBpZiB3ZSBhcmUgbm90IGhhbmRsaW5nIHRoZSAyQSBERSBQYW5lbDogQ2FuYWRhX1ByaW9yaXR5X0RhdGEyX1dlYl9Gb3JtICovCi8vdmFyIHByaW9yaXR5PVgoZG9jLCJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiKTsgLy9FUlMxNzA2MjYKdmFyIGxhYmVsMD0iIjsKdmFyIHRyaWFnZVR5cGU9ZG9jLmRvY1R5cGU7Cgp2YXIgYXR0YWNoUGF0aCA9IFgoZG9jLCJYX2F0dGFjaGVkVG8iKTsKekRhdGEuYXR0YWNoZWRUb0Nhc2UgPWZhbHNlOwp6RGF0YS5hdHRhY2hlZFRvID0gWChkb2MsICJYX0F0dGFjaF9Ub19fYyIpOyAvL1BWMTkxMjA1IHVwZGF0ZWQgY2FzZSBjcmVhdGlvbgogICAgYWxlcnQoInpEYXRhLmF0dGFjaGVkVG89PT09PT09PT0iK3pEYXRhLmF0dGFjaGVkVG8pOwogICAgdmFyIGF0dGFjaEZheFR5cGVzID1bIkVOUkwiLCJNRURPIiwiT1RIIiwiQ09QQVkiXTsKICAgIC8vaWYoIGF0dGFjaEZheFR5cGVzLmluZGV4T2YoekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpID4tMSAmJiAoekRhdGEuYXR0YWNoZWRUbyA9PT0gIkNhcmUgUGxhbiIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0gIkFsbCIpKXsKICAgIGlmKCh6RGF0YS5hdHRhY2hlZFRvID09PSAiQ2FyZSBQbGFuIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSAiQWxsIikpewogICAgICB6RGF0YS5hdHRhY2hlZFRvQ2FzZSA9IHRydWU7CiAgICB9Ci8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gUGF0aWVudCByZWNvcmQgaWYgcmVxdWlyZWQgKi8gLy9FUlMxOTA2MTkKekRhdGEucGF0aWVudFR5cGU9WEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX1BhdGllbnRSZWNvcmRfX2MiKTsgLy9FUlMxOTA4MDYgWlBBUEVSX18gbm93IGluIE1QCmFsZXJ0KCJAQEBAIHpEYXRhLnBhdGllbnRUeXBlICoqKioqICIrekRhdGEucGF0aWVudFR5cGUrIiBQYXRpZW50Iik7CmFsZXJ0KCJAQEAgY3VycmVudCBERSBQYW5lbCBuYW1lID0gIiArIFgoZG9jLCAiWF9sYXN0REVQYW5lbCIpKTsKaWYgKCF6RGF0YS5wYXRpZW50VHlwZSkgekRhdGEucGF0aWVudFR5cGU9IkNvbnRhY3QiOyAvL0VSUzE5MDgwMiAjNjEyNzIKLy9pZiAoWChkb2MsIlhfWlBBUEVSX19QYXRpZW50X19jIikgfHwgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKSB7IC8vRVJTMTkwODAzIFRPRE8gcmV0aGluayB1c2UgWAogICAgdmFyIGRxID0gekRhdGEuZHEgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDM0KTsgLy9FUlMxOTA4MDIgVE9ETyBkZWZpbmUgYmV0dGVyIGluIHpEYXRhCiAgICB2YXIgcGF0aWVudFBob25lID0gWChkb2MsICJYX1pQQVBFUl9fUGhvbmVfX2MiKTsKICAgIGFsZXJ0KCJAQEAgcGF0aWVudFBob25lID0gIiArIHBhdGllbnRQaG9uZSk7CiAgICBpZiAoIXpEYXRhLnBhdGllbnRJZCkgewogICAgICAgIGFsZXJ0KCJAQEBAIGNyZWF0aW5nIG5ldyAiK3pEYXRhLnBhdGllbnRUeXBlKyIgUGF0aWVudCIpOwogICAgICAgIGFyck9mUGFpcnMgPSBbXTsKICAgICAgICAvL0VSUzE5MDczMCAjNjEyNzIgbWlzc2luZyB0aGUgYmFzaWNzCiAgICAgICAgdmFyIHA9IiI7CiAgICAgICAgaWYgKCJBY2NvdW50Ij09PXpEYXRhLnBhdGllbnRUeXBlKSB7IC8vRVJTMTkwODAzCiAgICAgICAgICAgIHA9IlBlcnNvbiI7CiAgICAgICAgICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJOYW1lIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYysiICIrekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJGaXJzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKTsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJMYXN0TmFtZSIsIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7CiAgICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2gocCsiQmlydGhkYXRlIiwgekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhdGllbnRQaG9uZSkgeyBhcnJPZlBhaXJzLnB1c2goIlBob25lIiwgcGF0aWVudFBob25lKTsgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiRmlyc3ROYW1lIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7IC8vWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyAvL0VSUzE5MDgwMyBUT0RPIGdldCBjbGVhbmVyICM2MTI3MgogICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkxhc3ROYW1lIiwgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsKICAgICAgICAgICAgaWYgKHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpIHsKICAgICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiQmlydGhkYXRlIiwgekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhdGllbnRQaG9uZSkgeyBhcnJPZlBhaXJzLnB1c2goIlBob25lIiwgcGF0aWVudFBob25lKTsgfQogICAgICAgIH0KICAgICAgICB2YXIgYXR0YWNoTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICAgICAgekRhdGEucGF0aWVudElkPXpEYXRhLmNsaWVudFBhdGllbnQoZG9jLGFyck9mUGFpcnMsIGF0dGFjaExhYmVsKTsKICAgICAgICBhbGVydCgiQ3JlYXRlZCBQYXRpZW50IHdpdGggSUQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgIGlmICh6RGF0YS5wYXRpZW50SWQgPT0gIm51bGwiIHx8IHpEYXRhLnBhdGllbnRJZCA9PSAiTkVXIikgekRhdGEucGF0aWVudElkPW51bGw7CiAgICAgICAgZWxzZSB7IC8vRVJTMTkwNzMwICM2MTI3MiBsZXZlcmFnZSB0aGUgbmV3IHJlY29yZAogICAgICAgICAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnBhdGllbnRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucGF0aWVudElkOwogICAgICAgICAgICBhbGVydCgiQEBAQEBAQCBORVcgUEFUSUVOVCBDUkVBVEVEIFdJVEggSUQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgwMiB6RGF0YS5jb250YWN0SWQKICAgICAgICAgICAgLy8gY2xlYXIgb3V0IHRoZSAiTmV3IFBhdGllbnQiIGZpZWxkcwogICAgICAgICAgICBpZiAoMT09PTEpIHsgLy9FUlMxOTA4MTEgIzYxNTcwIGNvbW1lbnRlZCBvdXQgc28gdGhhdCBwYXRpZW50IGluZm8gaXMgYXZhaWxhYmxlIGZvciBERSB2YXJpYWJsZXMgaW4gemlwcGkKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fRmlyc3ROYW1lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0xhc3ROYW1lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0JpcnRoZGF0ZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QaG9uZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19CaXJ0aGRhdGVfX2NfcmVhZGFibGUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIk5PTkUiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gc2V0IHRoZSBQYXRpZW50IGxvb2t1cCBmaWVsZHMKICAgICAgICAgICAgLy9FUlMxOTA4MDMgVE9ETyBoYW5kbGUgWlBBUEVSX18gcmVsYXRpb25zaGlwcyAvL0VSUzE5MDgxMSBkb3VibGUgdXAgZm9yIHNhZmV0eQogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50X19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLnBhdGllbnRJZCArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArICIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5wYXRpZW50SWQgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsgIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIC8vQ1JOMTkxMTE4IEFsc28gc2F2ZSB0aGUgbmV3IHZhbHVlcyB0byB0aGUgY2hpbGQKICAgICAgICAgICAgdmFyIHNhdmUyREJBcnJPZlBhaXJzID0gW107CiAgICAgICAgICAgIHNhdmUyREJBcnJPZlBhaXJzLnB1c2goIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIHNhdmUyREJBcnJPZlBhaXJzLnB1c2goIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArICIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIHVwZGF0ZURCKGRvYywgc2F2ZTJEQkFyck9mUGFpcnMpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy9pZiAoekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgJiYgKCJDT05TIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKICAgICAgICAgLy8gICB8fCAiRU5STCIgPT09ekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwKICAgICAgICAgLy8gICJNRURPIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpKSB7IC8vRVJTMTkxMDkgIzY0OTIxIFRPRE8gbWFueSBqb3VybmV5IGJlc3QgcHJvY3RpY2UKICAgICAgICAgICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIFBhdGllbnQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICBpZiAoekRhdGEucGF0aWVudFR5cGUgIT0gIkFjY291bnQiKSB7IC8vRVJTMTkwNzMwIGxvb2t1cCB0aGUgZGF0YSBUT0RPIHBlcnNvbiBhY2NvdW50PwogICAgICAgICAgICAgICAgdmFyIGNvbnRhY3RGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCB6RGF0YS5wYXRpZW50VHlwZSwgIkZpcnN0TmFtZSxMYXN0TmFtZSxCaXJ0aGRhdGUiLCBudWxsLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICAgICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIGNvbnRhY3RGbGRzOiAiICsgY29udGFjdEZsZHMpOwogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyA9IHBhdGllbnRGaXJzdE5hbWUgPSBYKGRvYywgIkZpcnN0TmFtZSIsIGNvbnRhY3RGbGRzKTsgLy9QVjE5MTAwNiB1cGRhdGUgdGhlIGNoaWxkIHN0YWNrCiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgPSBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIkxhc3ROYW1lIiwgY29udGFjdEZsZHMpOwogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYz1wYXRpZW50RE9CID0gWChkb2MsICJCaXJ0aGRhdGUiLCBjb250YWN0Rmxkcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoekRhdGEucGF0aWVudFR5cGUgPT09ICJBY2NvdW50IikgeyAvL0VSUzE5MDczMCBsb29rdXAgdGhlIGRhdGEgVE9ETyBwZXJzb24gYWNjb3VudD8KICAgICAgICAgICAgICAgIHZhciBjb250YWN0RmxkcyA9IGdldFNGRmllbGRzKGRvYywgekRhdGEucGF0aWVudFR5cGUsICJOYW1lIiwgbnVsbCwgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBBY2NvdW50RmxkczogIiArIGNvbnRhY3RGbGRzKTsKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgPSBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJOYW1lIiwgY29udGFjdEZsZHMpLnNwbGl0KCIgIilbMF07IC8vRVJTMTkwODAzIFRPRE8gZmluZCBhIGJldHRlciB3YXkKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyA9IHBhdGllbnRMYXN0TmFtZSA9IFgoZG9jLCAiTmFtZSIsIGNvbnRhY3RGbGRzKS5zcGxpdCgiICIpWzFdOwogICAgICAgICAgICAgICAgLy96RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jPXBhdGllbnRET0IgPSBYKGRvYywgIlBlcnNvbkJpcnRoZGF0ZSIsIGNvbnRhY3RGbGRzKTsKCiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9QVjE5MTAwOCB1cGRhdGVkIGF0dGFjaExhYmVsIG9uIGNoaWxkIHN0YWNrCiAgICAgICAgICAgIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7CiAgICAgICAgICAgIGlmKHpEYXRhLmF0dGFjaGVkVG8gPT09ICJQYXRpZW50IiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSAiQWxsIil7CiAgICAgICAgICAgICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgfQogICAgICAvLyB9CiAgICB9CiAgICBpZiAoekRhdGEucGF0aWVudElkICYmIGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5wYXRpZW50SWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLnBhdGllbnRJZDsKLy99CmFsZXJ0KCJAQEBAIEFGVEVSIFBBVElFTlQ6IENoaWxkIHpTdGFjayBTbmlwcGV0IGF0dGFjaGVkIHRvOiAiICsgYXR0YWNoUGF0aCk7Cgp2YXIgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsgLy8iSW5kZXhlZCAiICsgZm9ybWF0Tm93OwphbGVydCgiRVJTMTkwNjI0IGF0dGFjaExhYmVsPSIrYXR0YWNoTGFiZWwpOwoKCi8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gTGVhZCByZWNvcmQgaWYgcmVxdWlyZWQgKi8gLy9FUlMxOTA2MTkKLy8gVE9ETyBFUlMxOTA2MjQgZmxpcCB0aGUgaWYgbG9naWMKaWYgKGRvYy53ZGRhdGEuaW5kZXhPZigiWF9aUEFQRVJfX1JlZmVycmFsTGVhZF9fYyIpPi0xKSB7IC8vRVJTMTkwODAzIFRPRE8gcmV0aGluawogICAgaWYgKCFsZWFkSWQgfHwgMCA9PT0gbGVhZElkLmxlbmd0aCkgewogICAgICAgIGFsZXJ0KCJAQEBAIGNyZWF0aW5nIG5ldyBMZWFkIik7CiAgICAgICAgYXJyT2ZQYWlycyA9IFtdOwogICAgICAgIGxlYWRJZD16RGF0YS5jbGllbnRMZWFkKGRvYyxhcnJPZlBhaXJzKTsKICAgICAgICBhbGVydCgiQ3JlYXRlZCBMZWFkIHdpdGggSUQ6ICIgKyBsZWFkSWQpOwogICAgICAgIGlmIChsZWFkSWQgPT0gIm51bGwiIHx8IGxlYWRJZCA9PSAiTkVXIikgbGVhZElkPW51bGw7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh6RGF0YS5hdHRhY2hSZWNvcmRzLmluZGV4T2YoIkxlYWQiKT4tMSkgewogICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgTGVhZDogIiArIGxlYWRJZCk7CiAgICAgICAgICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCBsZWFkSWQpOwogICAgICAgIH0KICAgIH0KICAgIGlmIChsZWFkSWQgJiYgYXR0YWNoUGF0aC5pbmRleE9mKGxlYWRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrbGVhZElkOwp9CmFsZXJ0KCJAQEBAIEFGVEVSIExFQUQ6IENoaWxkIHpTdGFjayBTbmlwcGV0IGF0dGFjaGVkIHRvOiAiICsgWChkb2MsICJYX2F0dGFjaGVkVG8iKSk7CgoKLy9FUlMxOTA2MjAgdXNlIGEgc2V0dGluZyB0byBkZXRlcm1pbmUgd2hpY2ggbG9va3VwcyB3ZSBhdHRhY2ggdG8KLyogQXR0YWNoIHRoZSBzcGxpdCBkb2N1bWVudCB0byBDYXNlIHJlY29yZCBpZiByZXF1aXJlZCAqLyAvL0VSUzE5MDYxOQovL2lmIChkb2Mud2RkYXRhLmluZGV4T2YoIlhfWlBBUEVSX19DYXNlX19jIik+LTEpIHsKICBpZigxPT09MSl7CiAgICBhbGVydCgiRVJTMTkwNjI0IG5lZWQgQ2FzZSIpOwogICAgaWYgKHpEYXRhLmNhc2VJZCkgewogICAgICAgIGlmICh6RGF0YS5hdHRhY2hSZWNvcmRzLmluZGV4T2YoIkNhc2UiKT4tMSkgewogICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgQ2FzZTogIiArIHpEYXRhLmNhc2VJZCk7CiAgICAgICAgICAgIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7CiAgICAgICAgICAgIGlmKHpEYXRhLmF0dGFjaGVkVG9DYXNlKXsKICAgICAgICAgICAgICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5jYXNlSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYWxlcnQoIkVSUzE5MDYyNC43OCBoYXZlIGEgY2FzZT8iKTsKICAgIGlmICh6RGF0YS5jYXNlSWQgJiYgYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLmNhc2VJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEuY2FzZUlkOwp9CgphbGVydCgiQEBAQCBBRlRFUiBDQVNFOiBDaGlsZCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIFgoZG9jLCAiWF9hdHRhY2hlZFRvIikpOwoKCi8vUFYxOTEwMjIgY3JlYXRlIHByZXNjcmlwdGlvbgp2YXIgc3RhY2tGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCAiWlBBUEVSX19sYXRlc3RGYXhfX2MiLCBudWxsLCBzZlN0YWNrSWQpOwp6RGF0YS5YX1pQQVBFUl9fbGF0ZXN0RmF4X19jID0gIFgoZG9jLCAiWlBBUEVSX19sYXRlc3RGYXhfX2MiLCBzdGFja0ZsZHMpOyAvL1BWMTkwOTI2IHVwZGF0ZSB0aGUgY2hpbGQgc3RhY2sKaWYoIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKXsKICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBQcmVzY3JpcHRpb246ICIgKyB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7CiAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IlByZXNjcmlwdGlvbiIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsKICAgIH0KfQppZiggIXpEYXRhLlhfUHJlc2NyaXB0aW9uX19jICYmIHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICYmIlJYIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgKSB7IC8vRVJTMTkxMTA5ICM2NDkyMSBUT0RPIG1hbnkgam91cm5leXMKICAgIGFsZXJ0KCJAQEBAIENyZWF0aW5nICBQcmVzY3JpcHRpb25fX2Mgd2l0aCBmYXggVHlwZSA6ICIgKyB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyk7CiAgICBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfRGF0ZV9vZl9QcmVzY3JpcHRpb25fUmVjZWl2ZWRfX2MiLHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX1Byb2R1Y3RQcmVzY3JpYmVkX19jIix6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVQbGFuX19jIiwgekRhdGEuY2FzZUlkKTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJQcmVzY3JpcHRpb24iIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09IkFsbCIpewogICAgICAgIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNvcmVfUHJlc2NyaXB0aW9uX19jIixhcnJPZlBhaXJzLCJJbmRleCIpOwogICAgfWVsc2V7CiAgICAgICAgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlTm9BdHRhY2goZG9jLCJDb3JlX1ByZXNjcmlwdGlvbl9fYyIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIH0KICAgIC8vekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ29yZV9QcmVzY3JpcHRpb25fX2MiLGFyck9mUGFpcnMsIkluZGV4Iik7ICBDUk4xOTEyMTMgRG9uJ3QgY3JlYXRlIHRoZSBQcmVzY3JpcHRpb24gbXVsdGlwbGUgdGltZXMKICAgIGFsZXJ0KCJAQEBAIENyZWF0ZSBQcmVzY3JpcHRpb25fX2Mgd2l0aCBJRDogIiArIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsKICAgIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7CiAgICAvL2F0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7CiAgICB6RGF0YS5QcmVzY3JpcHRpb25OYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDb3JlX1ByZXNjcmlwdGlvbl9fYyIsICJOYW1lIiwgbnVsbCwgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOyAvL1BWMTkxMDIyIC8vRVJTMTkxMTA5IGNsaWVudEluZGV4PwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1ByZXNjcmlwdGlvbl9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyArIGRxICsgIik7ICIpOwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1ByZXNjcmlwdGlvbl9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlByZXNjcmlwdGlvbk5hbWUgKyBkcSArICIpOyAiKTsKCn0KLy9DUk4xOTExMTggSWYgd2UgYWxzbyBoYXZlIGEgcGF0aWVudCBhbmQgYSBQcmVzY3JpcHRpb24sIGFzc29jaWF0ZSB0aGVtLgovKgppZiAoekRhdGEucGF0aWVudElkICYmIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKSB7CiAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIFByZXNjcmlwdGlvbjogIiArIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jICsgIiB3aXRoIFBhdGllbnQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgdmFyIHNjcmlwdEFyck9mUGFpcnMgPSBbXTsKICAgIHNjcmlwdEFyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfUHJlc2NyaXB0aW9uX19jIiwgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MsIHNjcmlwdEFyck9mUGFpcnMpOwp9CiovCgovL0NPTURSCi8vaWYoICF6RGF0YS5jYXNlSWQgJiYgKCJDT01EUiIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jCi8vICAgICB8fCAiTUVEQyI9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIkxBQiI9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKLy8gICAgIHx8ICJJTkpSIj09PXpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSl7Ci8vQ1JOMTkxMTE0IEFjY29yZGluZyB0byB0aGUgQWJidmllIHN0b3JpZXMsIGFsbCBkb2NUeXBlcyBleGNlcHQgIkNvbnNlbnQgRm9ybXMiIG5lZWQgdG8gaGF2ZSBhIENhc2UgY3JlYXRlZCBpZiBvbmUgaXNuJ3QgYWxyZWFkeSBzZWxlY3RlZAppZighekRhdGEuY2FzZUlkICYmICJDT05TIiAhPT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgJiYgJ0NhbmFkYV9Qcmlvcml0eV9EYXRhMl9XZWJfRm9ybScgIT09IFgoZG9jLCAiWF9sYXN0REVQYW5lbCIpKSB7CiAgICBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIjAxMjFpMDAwMDAwaFFvN0FBRSIpOyAgICAgICAgICAgICAgIC8vIENSTjE5MTExNCBBbHdheXMgdXNlIENhcmVQbGFuIFJlY29yZCBUeXBlPwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0JyYW5kX19jIix6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpOwogICAgaWYoekRhdGEucHJvZ3JhbU5hbWUgPT09ICJBYmJ2aWUgT25lQ1JNIC0gQ2FuYWRhIil7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NvdW50cnlDb2RlX19jIiwiQ0EiKTsKICAgIH0KICAgIGlmICh6RGF0YS5wYXRpZW50SWQpIHsgYXJyT2ZQYWlycy5wdXNoKCJBY2NvdW50SWQiLCB6RGF0YS5wYXRpZW50SWQpOyB9CiAgICBpZih6RGF0YS5hdHRhY2hlZFRvQ2FzZSl7CiAgICAgICAgekRhdGEuY2FzZUlkID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNhc2UiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB9ZWxzZXsKICAgICAgICB6RGF0YS5jYXNlSWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlTm9BdHRhY2goZG9jLCJDYXNlIixhcnJPZlBhaXJzLCJJbmRleCIpOwogICAgfQogICAgekRhdGEuY2FzZU51bWJlciA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJDYXNlTnVtYmVyIiwgbnVsbCwgekRhdGEuY2FzZUlkKTsgLy9QVjE5MTAyMgogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5jYXNlSWQgKyBkcSArICIpOyAiKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0Nhc2VfX2NfQ2FzZU51bWJlciIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5jYXNlTnVtYmVyICsgZHEgKyAiKTsgIik7IC8vUFYxOTA5MjkgdXBkYXRlZCBjYXNlIG51bWJlciBpbiBsb29rdXAKICAgIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MgPSBYKGRvYywgIlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MiKTsKCi8qCkNSTjE5MTExMyBNb3ZlZCBiZWxvdyB3aGVyZSB0aGUgZG9jVHlwZSBsb2dpYyBpc24ndCBzbyBjb252b2x1dGVkCiAgICBpZigiTEFCIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiSU5KUiI9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgICAgfHwgIk1FREMiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyl7CiAgICAgIGFyck9mUGFpcnMgPSBbXTsKICAgICAgaWYoIkxhYiBUZXN0cyI9PT16RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jKXsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyNUUwMDAwMDBLMjRHUUFTIik7CiAgICAgIH0KICAgICAgaWYoImluamVjdGlvbiBUcmFpbmluZyI9PT16RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jKXsKCiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjVFMDAwMDAwSzI0TFFBUyIpOwogICAgICB9CgogICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJTZXJ2aWNlX1JlcXVlc3RlZF9kYXRlX19jIix6RGF0YS5YX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MpOwogICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJDb3JlX1BhdGllbnRfX2MiLHpEYXRhLnBhdGllbnRJZCk7CiAgICAgaWYoIXpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpewogICAgICAgIGFzc29jaWF0ZWRBcnJPZlBhaXJzLnB1c2goIkNvcmVfQ2FyZV9QbGFuX19jIiwgekRhdGEuY2FzZUlkKTsKICAgICAgICBhc3NvY2lhdGVkQXJyT2ZQYWlycy5wdXNoKCJDb3JlX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIixhcnJPZlBhaXJzLCJJbmRleCIpOwogICAgIH0KICAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCAgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7CiAgICAgekRhdGEuQ2xpbmljYWxOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOyAvL1BWMTkxMDIyCiAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MgKyBkcSArICIpOyAiKTsKICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjQ2xpbmljYWxfU2VydmljZXNfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5DbGluaWNhbE5hbWUgKyBkcSArICIpOyAiKTsKICAgIH0KICAgICovCn0KCi8vU0hSMTkxMjA5ICM2NTUzNSBhZGQgRG9jdW1lbnQgTGluayBpZiB3ZSBoYXZlIGEgbmV3IENhc2UgSWQKaWYgKHpEYXRhLmNhc2VJZCkgewogICAgdmFyIHpzZXJ2ZXIgPSBkb2Mua2JEYXRhLnNmU2VydmVyLnN0YXJ0c1dpdGgoImh0dHBzOi8vIikgPyBkb2Mua2JEYXRhLnNmU2VydmVyIDogImh0dHBzOi8vIiArIGRvYy5rYkRhdGEuc2ZTZXJ2ZXI7CiAgICB2YXIgZG9jdXJsID0genNlcnZlciArICIvc2VydmljZXMvZGF0YS92NDYuMC9zb2JqZWN0cy9Db250ZW50VmVyc2lvbi8iOwogICAgdmFyIHBkZnVybCA9ICJodHRwczovL2d3LnpwYXBlci5jb20va2IvanNwL1NGX2ZpbmQubGlnaHRuaW5nLmpzcD9nbz1TRl9maWxlcy5qc3AmZGJJRD0iICsgZG9jLmRiSUQgKyAiJlNGb3JnPSIgKyBkb2Mua2JEYXRhLnNmT3JnYW5pemF0aW9uSUQ7CiAgICB2YXIgQ29udGVudFZlcnNpb25DYXRlZ29yaWVzID0gewogICAgICAgICJPVEgiOiAiT3RoZXIgRG9jdW1lbnRzIiwKICAgICAgICAiTUlGIjogIk1pc3NpbmcgSW5mb3JtYXRpb24iLAogICAgICAgICJFTlJMIjogIkVucm9sbG1lbnQgRm9ybSIsCiAgICAgICAgIk1FRE8iOiAiTWVkaWNhbCAtIE90aGVyIiwKICAgICAgICAiQ09OUyI6ICJDb25zZW50IEZvcm1zIiwKICAgICAgICAiQ09NRFIiOiAiQ29tbXVuaWNhdGlvbiBmcm9tIFBoeXNpY2lhbnMiLAogICAgICAgICJSWCI6ICJQcmVzY3JpcHRpb24iLAogICAgICAgICJTQSI6ICJTQSBEb2N1bWVudHMiLAogICAgICAgICJNRURDIjogIk1lZGljYWwgQ2xhcmlmaWNhdGlvbiIsCiAgICAgICAgIkxBQiI6ICJMYWIgRG9jdW1lbnRzIiwKICAgICAgICAiSU5KUiI6ICJJbmplY3Rpb24gUmVwb3J0IiwKICAgICAgICAiQ0EiOiAiQ2xpbmljYWwgQXNzZXNzbWVudCIsCiAgICAgICAgIkNPUEFZIjogIkNvcGF5IgogICAgfQogICAgdmFyIGRhdGVzdHIgPSBnZXRDdXJEYXRlKGRvYyk7CiAgICB2YXIgYWNjbmFtZSA9IFgoZG9jLCAiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19yLk5hbWUiKTsKICAgIHZhciBmYXh0eXBlID0gWChkb2MsICJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOwogICAgdmFyIHJldnN0YXQgPSBYKGRvYywgIlhfcmV2aWV3ZWRTdGF0dXMiKTsKICAgIHZhciBjYXR0eXBlID0gQ29udGVudFZlcnNpb25DYXRlZ29yaWVzW2ZheHR5cGVdIHx8IGZheHR5cGU7CiAgICB2YXIgZG9jZGF0YSA9IHsKICAgICAgICAiVGl0bGUiOiBhY2NuYW1lICsgIiAtICIgKyBmYXh0eXBlICsgIiAtICIgKyBkYXRlc3RyLAogICAgICAgICJEZXNjcmlwdGlvbiI6IHJldnN0YXQgKyAiIGJ5OiAiICsgZG9jLnNmVXNlck5hbWUgKyAiIGF0OiAiICsgekRhdGEuZm9ybWF0Tm93LAogICAgICAgICJGaXJzdFB1Ymxpc2hMb2NhdGlvbklkIjogekRhdGEuY2FzZUlkLAogICAgICAgICJDb250ZW50VXJsIjogcGRmdXJsLAogICAgICAgICJDT1JFX0xlZ2FjeV9Eb2N1bWVudF9JRF9fYyI6IHBkZnVybCwKICAgICAgICAiQ29yZV9Db3VudHJ5Q29kZV9fYyI6ICJDQSIsCiAgICAgICAgIkNvcmVfQ2F0ZWdvcnlfX2MiOiBjYXR0eXBlLAogICAgICAgICJDb3JlX1N1Yl9DYXRlZ29yeV9fYyI6IHpEYXRhLlhfU3ViX0NhdGVnb3J5X19jCiAgICB9OwogICAgdmFyIGhlYWRlcnMgPSBbCiAgICAgICAgIkF1dGhvcml6YXRpb24iLCAiQmVhcmVyICIgKyBkb2Mua2JEYXRhLnNmU2Vzc2lvbklELAogICAgICAgICJDb250ZW50LVR5cGUiLCAiYXBwbGljYXRpb24vanNvbiIKICAgIF07CiAgICB2YXIgYm9keSA9IEpTT04uc3RyaW5naWZ5KGRvY2RhdGEpOwogICAgdHJ5IHsKICAgICAgICB2YXIgcmVzID0gd3Bvc3QoZG9jLCBkb2N1cmwsIFtdLCBoZWFkZXJzLCBib2R5KTsKICAgICAgICBhbGVydCgid3Bvc3QgcmVzcG9uc2U6ICIgKyByZXMpOwogICAgfQogICAgY2F0Y2goZXgpIHsKICAgICAgICBhbGVydCgid3Bvc3QgZXhjZXB0aW9uOiAiICsgZXgpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBtZXNzID0gSlNPTi5wYXJzZShleCk7CiAgICAgICAgICAgIGlmIChtZXNzICYmIEFycmF5LmlzQXJyYXkobWVzcykgJiYgbWVzc1swXS5lcnJvckNvZGUpIHsKICAgICAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiYWxlcnQoYEVycm9yIGNyZWF0aW5nIENvbnRlbnRWZXJzaW9uISAiICsgbWVzc1swXS5lcnJvckNvZGUgKyAiID0+ICIgKyBtZXNzWzBdLm1lc3NhZ2UgKyAiYCk7Iik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2gocGV4KSB7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiYWxlcnQoYEVycm9yIHBhcnNpbmcgSlNPTiByZXBzcG9uc2U6ICIgKyBleCArICJgKTsiKTsKICAgICAgICB9CiAgICB9Cn0KCi8vQ09QQVkKaWYgKCJDT1BBWSIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSB7CiAgICBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goIkNBX1BhdGllbnRfX2MiLHpEYXRhLnBhdGllbnRJZCk7CiAgICBhcnJPZlBhaXJzLnB1c2goIkNBX0NhcmVQbGFuSURfX2MiLHpEYXRhLmNhc2VJZCk7CiAgICB6RGF0YS5jb3BheUlkID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNBX0NvcGF5X19jIixhcnJPZlBhaXJzLCJJbmRleCIpOwp9CgoKLy9PVEgKaWYoICF6RGF0YS5jYXNlSWQgJiYgKCJPVEgiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiRU5STCIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jCiAgICB8fCAiTUVETyIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8ICJSWCIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICkpewogICAgaWYoekRhdGEuY3JlYXRlQ2FzZSl7CiAgICAgICAgYXJyT2ZQYWlycyA9IFtdOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyMWkwMDAwMDBoUW83QUFFIik7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0JyYW5kX19jIix6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpOwogICAgICAgIGlmKHpEYXRhLnByb2dyYW1OYW1lID09PSAiQWJidmllIE9uZUNSTSAtIENhbmFkYSIpewogICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQ291bnRyeUNvZGVfX2MiLCJDQSIpOwogICAgICAgIH0KCiAgICAgICAgekRhdGEuY2FzZUlkID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNhc2UiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICAgICAgekRhdGEuY2FzZU51bWJlciA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJDYXNlTnVtYmVyIiwgbnVsbCwgekRhdGEuY2FzZUlkKTsgLy9QVjE5MTAyMgogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0Nhc2VfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZUlkICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fY19DYXNlTnVtYmVyIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLmNhc2VOdW1iZXIgKyBkcSArICIpOyAiKTsgLy9QVjE5MDkyOSB1cGRhdGVkIGNhc2UgbnVtYmVyIGluIGxvb2t1cAogICAgfQp9CgppZiggekRhdGEuWF9SZXBvcnRlZF9PdXRjb21lX19jKXsKICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBPdXRjb21lOiAiICsgekRhdGEuWF9SZXBvcnRlZF9PdXRjb21lX19jKTsKICAgIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7CiAgICBpZiggekRhdGEuYXR0YWNoZWRUbyA9PT0iUmVwb3J0ZWQgT3V0Y29tZXMiIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09IkFsbCIpewogICAgICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwogICAgfQogICAgLy9DUk4xOTExMTggSWYgd2UgYWxzbyBoYXZlIGEgUGF0aWVudCBhbmQgYSBSZXBvcnRlZCBPdXRjb21lLCBhc3NvY2lhdGUgdGhlbS4KICAgIGlmICh6RGF0YS5wYXRpZW50SWQpIHsKICAgICAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIFJlcG9ydGVkIEN1dGNvbWU6ICIgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgKyAiIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgdmFyIG91dGNvbWVBcnJPZlBhaXJzID0gW107CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9BY2NvdW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgICAgICB1cGRhdGVTRlJlY29yZChkb2MsICJDb3JlX1BhdGllbnRfUmVwb3J0ZWRfT3V0Y29tZXNfX2MiLCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MsIG91dGNvbWVBcnJPZlBhaXJzKTsKICAgIH0KfQplbHNlIGlmICgiQ0EiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgewogICAgdmFyIG91dGNvbWVBcnJPZlBhaXJzID0gW107CiAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0VudHJ5X0RhdGVfX2MiLCBnZXRDdXJEYXRlKGRvYykpOwogICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9DYXJlX1BsYW5fX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9BY2NvdW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIHZhciBhc3Nlc3NtZW50VHlwZSA9IFgoZG9jLCAiWF9Bc3Nlc3NtZW50X1R5cGVfX2MiKTsKICAgIGlmIChhc3Nlc3NtZW50VHlwZSAmJiAiRE9OT1RfU0FWRSIgIT09IGFzc2Vzc21lbnRUeXBlKSB7CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9Bc3Nlc3NtZW50X1R5cGVfX2MiLCBhc3Nlc3NtZW50VHlwZSk7CiAgICB9CiAgICB2YXIgb3V0Y29tZVR5cGUgPSBYKGRvYywgIlhfT3V0Y29tZV9UeXBlX19jIik7CiAgICBpZiAob3V0Y29tZVR5cGUgJiYgIkRPTk9UX1NBVkUiICE9PSBvdXRjb21lVHlwZSkgewogICAgICAgIG91dGNvbWVBcnJPZlBhaXJzLnB1c2goIkNvcmVfT3V0Y29tZV9UeXBlX19jIiwgb3V0Y29tZVR5cGUpOwogICAgfQogICAgLy9DUk4xOTExMTggSWYgd2UgYWxzbyBoYXZlIGEgUGF0aWVudCBhbmQgYSBSZXBvcnRlZCBPdXRjb21lLCBhc3NvY2lhdGUgdGhlbS4KICAgIGlmICh6RGF0YS5wYXRpZW50SWQpIHsKICAgICAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIE5ldyBSZXBvcnRlZCBDdXRjb21lIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9BY2NvdW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIH0KICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJSZXBvcnRlZCBPdXRjb21lcyIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgekRhdGEuWF9SZXBvcnRlZF9PdXRjb21lX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNvcmVfUGF0aWVudF9SZXBvcnRlZF9PdXRjb21lc19fYyIsb3V0Y29tZUFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB9ZWxzZXsKICAgICAgICB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlTm9BdHRhY2goZG9jLCJDb3JlX1BhdGllbnRfUmVwb3J0ZWRfT3V0Y29tZXNfX2MiLG91dGNvbWVBcnJPZlBhaXJzLCJJbmRleCIpOwogICAgfQogICAgdmFyIG91dGNvbWVOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDb3JlX1BhdGllbnRfUmVwb3J0ZWRfT3V0Y29tZXNfX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyk7CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUmVwb3J0ZWRfT3V0Y29tZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgKyBkcSArICIpOyAiKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNSZXBvcnRlZF9PdXRjb21lX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgb3V0Y29tZU5hbWUgKyBkcSArICIpOyAiKTsKfQoKCmFyck9mUGFpcnMgPSBbXTsKaWYgKHpEYXRhLmRvY1R5cGUpIHsgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLCB6RGF0YS5kb2NUeXBlKTsgIH0gLy9FUlMxOTA4MTAgUFYxOTA4MDggIzUxNjcwCmlmICh6RGF0YS5wcm92aWRlcklkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJvdmlkZXJfX2MiLCB6RGF0YS5wcm92aWRlcklkKTsKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucHJvdmlkZXJJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucHJvdmlkZXJJZDsKfQphbGVydCgiRVJTMTkwODEyLjIwMCB6RGF0YS5wYXRpZW50SWQ9Iit6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgxMiAjNjE1MTEKaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMDMiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIGlmICh6RGF0YS5wYXRpZW50SWQuaW5kZXhPZigiMDAxIik9PT0wKSBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMFEiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgwMiBMZWFkCiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnBhdGllbnRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucGF0aWVudElkOwogICAgaWYgKDE9PT0xKSB7IC8vRVJTMTkwODEwIFBWMTkwODA4IGRhdGEgZW50cnkgZm9yIG5leHQgc3BsaXQKICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYykgeyBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fRmlyc3ROYW1lX19jIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7IH0KICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19MYXN0TmFtZV9fYyIsIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7IH0KICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgeyBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQmlydGhkYXRlX19jIiwgekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyk7IH0KICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX1N0YXR1c19fYykge2Fyck9mUGFpcnMucHVzaCh6cCsiU3RhdHVzX19jIiwgIkNvbXBsZXRlZCIpOyB9IC8vUFYxOTEwMjMgdXBkYXRlaW5nIHN0YXR1cwogICAgfQp9CmlmICh6RGF0YS5jYXNlSWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DYXNlX19jIiwgekRhdGEuY2FzZUlkKTsKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEuY2FzZUlkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5jYXNlSWQ7Cn0KIGFsZXJ0KCJAQEBAIHpEYXRhLmNvbnRhY3RJZCA9ICIgKyB6RGF0YS5jb250YWN0SWQpOwppZiAoekRhdGEuY29udGFjdElkICYmIHpEYXRhLmNvbnRhY3RJZC5zdGFydHNXaXRoKCIwMDMiKSkgewoKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50X19jIiwgekRhdGEuY29udGFjdElkKTsKfQppZiAoekRhdGEubGVhZElkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUmVmZXJyYWxMZWFkX19jIiwgekRhdGEubGVhZElkKTsKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEubGVhZElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5sZWFkSWQ7Cn0KaWYgKHpEYXRhLnJlZmVycmFsSWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbF9fYyIsIHpEYXRhLnJlZmVycmFsSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5yZWZlcnJhbElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5yZWZlcnJhbElkOwp9CmlmICh6RGF0YS5YX1pQQVBFUl9fUGhvbmVfX2MpIHsgLy9QVjE5MTAwNiBVUERBVEVEIEZPUiBQSE9ORQogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1Bob25lX19jIiwgekRhdGEuWF9aUEFQRVJfX1Bob25lX19jKTsKCn0KdmFyIHNwZWNpYWxBdXRoSWQgPSBYKGRvYywgIlhfU3BlY2lhbF9BdXRob3JpemF0aW9uX19jIik7CmFsZXJ0KCJAQEAgekRhdGEuWF9TcGVjaWFsX0F1dGhvcml6YXRpb25fX2MgIiArIHNwZWNpYWxBdXRoSWQpOwp2YXIgYXV0aERvY1R5cGUgPSBYKGRvYywgIlpQQVBFUl9fZmF4VHlwZV9fYyIpOwppZiAoc3BlY2lhbEF1dGhJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJTcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiLCBzcGVjaWFsQXV0aElkKTsKICAgIC8vUFYxOTExMTMgSWYgd2UgaGF2ZSBhIFNwZWNpYWwgQXV0aG9yaXphdGlvbiwgYXR0YWNoIHRoaXMgZG9jdW1lbnQgdG8gaXQKICAgIHZhciBzcGVjaWFsTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICBpZiggekRhdGEuYXR0YWNoZWRUbyA9PT0iU3BlY2lhbCBBdXRob3JpemF0aW9uIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICBhdHRhY2goZG9jLCBzcGVjaWFsTGFiZWwsIHNwZWNpYWxBdXRoSWQpOwogICAgfQp9CmVsc2UgaWYgKCJTQSIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSB7CiAgICB2YXIgYXV0aEFyck9mUGFpcnMgPSBbXTsKICAgIHZhciBhdXRoTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICBhdXRoQXJyT2ZQYWlycy5wdXNoKCJNZW1iZXJQbGFuSWQiLCB6RGF0YS5YX01lbWJlcl9QbGFuX19jICwgIkNBX0NvdmVyYWdlX0JlbmVmaXRfX2MiLCB6RGF0YS5YX0NvdmVyYWdlX0JlbmVmaXRfX2MgKTsKICAgIGF1dGhBcnJPZlBhaXJzLnB1c2goIkNBX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgYXV0aEFyck9mUGFpcnMucHVzaCgiTmFtZSIsICJhbnlWYWx1ZSIpOwogICAgdmFyIHNwZWNpYWxBdXRoSWQgPSIiOwogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IlNwZWNpYWwgQXV0aG9yaXphdGlvbiIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgc3BlY2lhbEF1dGhJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJDYXJlUHJlYXV0aCIsIGF1dGhMYWJlbCwgYXV0aEFyck9mUGFpcnMpOwogICAgfWVsc2V7CiAgICAgICAgc3BlY2lhbEF1dGhJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkNhcmVQcmVhdXRoIiwgYXV0aExhYmVsLCBhdXRoQXJyT2ZQYWlycyk7CiAgICB9CgogICAgaWYgKCFzcGVjaWFsQXV0aElkLmNvbnRhaW5zKCJFUlJPUiIpKSB7CiAgICAgICAgdmFyIGF1dGhOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDYXJlUHJlYXV0aCIsICJOYW1lIiwgbnVsbCwgc3BlY2lhbEF1dGhJZCk7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJTcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiLCBzcGVjaWFsQXV0aElkKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjU3BlY2lhbF9BdXRob3JpemF0aW9uX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHNwZWNpYWxBdXRoSWQgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjU3BlY2lhbF9BdXRob3JpemF0aW9uX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgYXV0aE5hbWUgKyBkcSArICIpOyAiKTsKICAgIH0KfQovL0NSTjE5MTExOCBJZiB3ZSBhbHNvIGhhdmUgYSBQYXRpZW50IGFuZCBhIFNwZWNpYWwgQXV0aG9yaXphdGlvbiwgYXNzb2NpYXRlIHRoZW0uCmlmICh6RGF0YS5wYXRpZW50SWQgJiYgc3BlY2lhbEF1dGhJZCkgewogICAgYWxlcnQoIkBAQCBBc3NvY2lhdGluZyBTcGVjaWFsIEF1dGhvcml6YXRpb246ICIgKyBzcGVjaWFsQXV0aElkICsgIiB3aXRoIFBhdGllbnQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgdmFyIHNjcmlwdEFyck9mUGFpcnMgPSBbXTsKICAgIHNjcmlwdEFyck9mUGFpcnMucHVzaCgiQ0FfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICB1cGRhdGVTRlJlY29yZChkb2MsICJDYXJlUHJlYXV0aCIsIHNwZWNpYWxBdXRoSWQsIHNjcmlwdEFyck9mUGFpcnMpOwp9CgovL0NSTjE5MTExNCBIYW5kbGUgYW55IHBhc3NlZC1pbiBwaHlzaWNpYW4gKFNob3VsZCB0aGlzIGJlIG9ubHkgZm9yIENPTURSOiBDb21tdW5pY2F0aW9uIGZyb20gUGh5c2ljaWFuPykKYWxlcnQoIkBAQEAgekRhdGEuWF9QaHlzaWNpYW5fX2MgPSAiICsgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwphbGVydCgiQEBAQCBYX1BoeXNpY2lhbl9fYyA9ICIgKyBYKGRvYywgIlhfUGh5c2ljaWFuX19jIikpOwppZiAoWChkb2MsICJYX1BoeXNpY2lhbl9fYyIpKSB7CiAgICB6RGF0YS5YX1BoeXNpY2lhbl9fYyA9IFgoZG9jLCAiWF9QaHlzaWNpYW5fX2MiKTsKICAgIGFsZXJ0KCJAQEBAIHpEYXRhLlhfUGh5c2ljaWFuX19jIG5vdyA9ICIgKyB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7CiAgICBhcnJPZlBhaXJzLnB1c2goIlBoeXNpY2lhbl9fYyIsIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKICAgIHZhciBwaHlzaWNpYW5MYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGFsZXJ0KCJAQEAgQXR0YWNoaW5nIHRvIFBoeXNpY2lhbl9fYyB3aXRoIElkOiAiICsgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwogICAgYXR0YWNoKGRvYywgcGh5c2ljaWFuTGFiZWwsIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKfQoKLy9QVjE5MTAwOCB1cGRhdGVkIG5ldyBmaWVsZHMKaWYoekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKSBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CmlmKCB6RGF0YS5YX1pQQVBFUl9fUHJpb3JpdHlfX2MpIHsKICAgIGlmICghekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJpb3JpdHlfX2MiLHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYyk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJpb3JpdHlfX2MiLCAiIik7CiAgICB9Cn0KaWYoIHpEYXRhLlhfU3ViX0NhdGVnb3J5X19jICkgIGFyck9mUGFpcnMucHVzaCgiU3ViX0NhdGVnb3J5X19jIix6RGF0YS5YX1N1Yl9DYXRlZ29yeV9fYyk7CmlmKCB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIix6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyk7CmlmKCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyApICBhcnJPZlBhaXJzLnB1c2goIlByZXNjcmlwdGlvbl9fYyIsekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwppZiggekRhdGEuWF9NZW1iZXJfUGxhbl9fYyApICBhcnJPZlBhaXJzLnB1c2goIk1lbWJlcl9QbGFuX19jIix6RGF0YS5YX01lbWJlcl9QbGFuX19jKTsKaWYoIHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyApICBhcnJPZlBhaXJzLnB1c2goIkNvdmVyYWdlX0JlbmVmaXRfX2MiLHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyk7CmlmKCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jICkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19fYyIsekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7CiAgICAvL1BWMTkxMTEzIElmIHdlIGhhdmUgYSBDbGluaWNhbCBTZXJ2aWNlcywgYXR0YWNoIHRoaXMgZG9jdW1lbnQgdG8gaXQKICAgIHZhciBjbGluaWNhbExhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IkNsaW5pY2FsIFNlcnZpY2VzIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICBhdHRhY2goZG9jLCBjbGluaWNhbExhYmVsLCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsKICAgIH0KfQplbHNlIGlmICgoIkxBQiI9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIklOSlIiPT09ekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKICAgICAgIHx8ICJNRURDIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpICYmIFgoZG9jLCAiWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIikpIHsgICAgICAgIC8vQ1JOMTkxMTEzIENyZWF0ZSBuZXcgQ2xpbmljYWwgU2VydmljZXMgcmVjb3JkIGlmIERvY1R5cGUgaXMgTUVEQyBhbmQgdGhlIFNlcnZpY2UgUmVxdWVzdGVkIERhdGUgaXMgZmlsbGVkIGluCiAgICB2YXIgY2xpbmljYWxTdmNBcnJPZlBhaXJzID0gW107CiAgICB2YXIgY2xpbmljYWxTdmNMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVfUGxhbl9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICBjbGluaWNhbFN2Y0Fyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIGlmKCJMYWIgVGVzdHMiPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjFpMDAwMDAwWTlEUkFBMCIpOwogICAgfQogICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIlNlcnZpY2VfUmVxdWVzdGVkX2RhdGVfX2MiLCBYKGRvYywgIlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyIpKTsKICAgIGlmKCJJbmplY3Rpb24gVHJhaW5pbmciPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyMWkwMDAwMDBZOURRQUEwIik7CiAgICB9CiAgICB2YXIgY2xpbmljYWxTdmNJZD0iIjsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJDbGluaWNhbCBTZXJ2aWNlcyIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgY2xpbmljYWxTdmNJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLCBjbGluaWNhbFN2Y0xhYmVsLCBjbGluaWNhbFN2Y0Fyck9mUGFpcnMpOwogICAgfWVsc2V7CiAgICAgICAgY2xpbmljYWxTdmNJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsIGNsaW5pY2FsU3ZjTGFiZWwsIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycyk7CiAgICB9CgogICAgaWYgKCFjbGluaWNhbFN2Y0lkLmNvbnRhaW5zKCJFUlJPUiIpKSB7CiAgICAgICAgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyA9IGNsaW5pY2FsU3ZjSWQ7CiAgICAgICAgekRhdGEuQ2xpbmljYWxOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOyAvL1BWMTkxMDIyCiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjQ2xpbmljYWxfU2VydmljZXNfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5DbGluaWNhbE5hbWUgKyBkcSArICIpOyAiKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX19jIiwgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7CgogICAgICAgIC8vQ1JOMTkxMTE4IElmIHdlIGFsc28gaGF2ZSBhIFBhdGllbnQgYW5kIGEgQ2xpbmljYWwgU2VydmljZSwgYXNzb2NpYXRlIHRoZW0uCiAgICAgICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgICAgICAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIENsaW5pY2FsIFNlcnZpY2U6ICIgKyBjbGluaWNhbFN2Y0lkICsgIiB3aXRoIFBhdGllbnQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICB2YXIgc2NyaXB0QXJyT2ZQYWlycyA9IFtdOwogICAgICAgICAgICBzY3JpcHRBcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsIGNsaW5pY2FsU3ZjSWQsIHNjcmlwdEFyck9mUGFpcnMpOwogICAgICAgIH0KICAgIH0KfQoKaWYoIHpEYXRhLlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyApICBhcnJPZlBhaXJzLnB1c2goIlNlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiLHpEYXRhLlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyk7CmlmKCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJSZXBvcnRlZF9PdXRjb21lX19jIix6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwppZiggekRhdGEuWF9Bc3Nlc3NtZW50X1R5cGVfX2MgJiYgIkRPTk9UX1NBVkUiICE9PSB6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYykgIGFyck9mUGFpcnMucHVzaCgiQXNzZXNzbWVudF9UeXBlX19jIix6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYyk7CmlmKCB6RGF0YS5YX091dGNvbWVfVHlwZV9fYyAmJiAiRE9OT1RfU0FWRSIgIT09IHpEYXRhLlhfT3V0Y29tZV9UeXBlX19jKSAgYXJyT2ZQYWlycy5wdXNoKCJPdXRjb21lX1R5cGVfX2MiLHpEYXRhLlhfT3V0Y29tZV9UeXBlX19jKTsKaWYoekRhdGEuWF9Qcm9kdWN0X0Rlc2NyaWJlZF9fYykgYXJyT2ZQYWlycy5wdXNoKCJQcm9kdWN0X0Rlc2NyaWJlZF9fYyIsekRhdGEuWF9Qcm9kdWN0X0Rlc2NyaWJlZF9fYyk7CmlmKHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19sYXRlc3RGYXhfX2MiLHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpOwovL0VSUzE5MDgxNCBqdXN0IHRoZSBjaGlsZCAjNjE1MTEgdXBkYXRlU0ZSZWNvcmQoZG9jLCB6RGF0YS56cHMsIHNmU3RhY2tJZCwgYXJyT2ZQYWlycyk7Ci8vbGV0IHRoZSBkb2NTZXQgZG8gdGhlIHdvcmsgYXR0YWNoKGRvYyxhdHRhY2hMYWJlbCwgc2ZTdGFja0lkKTsKdmFyIHI9dXBkYXRlU0ZSZWNvcmQoZG9jLCJaUEFQRVJfX3pTdGFja19fYyIsc2ZTdGFja0lkLFsiWlBBUEVSX19TdGF0dXNfX2MiLCJTcGxpdCJdKTsgLy9QVjE5MTIxNgphbGVydCgiQEBAQCB1cGRhdGVkIGFuZCBhdHRhY2hlZCB0byB6U3RhY2sgUmVjb3JkLCBpZCA9ICIgKyBzZlN0YWNrSWQgKyAiPz0iK3pEYXRhLmdldFN0YWNrSWQoZG9jKSsiIGRhdGE9IithcnJPZlBhaXJzKTsKCnZhciBjaGlsZFN0YWNrSWQ9ekRhdGEuY2xpZW50Q2hpbGRTdGFjayhkb2MsYXJyT2ZQYWlycyxzZlN0YWNrSWQpOyAvL0VSUzE5MDgxMCBjcmVhdGUgY2hpbGQgc3RhY2sgZm9yIHNwbGl0IEVSUzE5MDgxMSBjbGllbnRDaGlsZFN0YWNrCmlmIChjaGlsZFN0YWNrSWQpIHthdHRhY2hQYXRoKz0iLCIrc2ZTdGFja0lkKyIsIitjaGlsZFN0YWNrSWQ7IGF0dGFjaFBhdGg9YXR0YWNoUGF0aC5yZXBsYWNlKCIvLD8iLCIvIik7IH0gLy9FUlMxOTA4MTEgIzYxNTcwIGNsZWFuIHVwIC8vcGFyZW50IHN0YWNrIHRvbwphcnJPZlBhaXJzPVtdOy8vUFYxOTEwMjMgRXZlcnl0aW1lIGNoaWxkIHdpbGwgYXR0YWNoIHRvIHRoYXQgcGFydGljdWxhciB6U3RhY2sKYXJyT2ZQYWlycy5wdXNoKCJYX3NmU3RhY2tJZCIsY2hpbGRTdGFja0lkKTsKLy9DUk4xOTExMTggQ2xlYXIgb3V0IHRoZXNlIHZhbHVlcyBmcm9tIHBhcmVudCBzdGFjawphcnJPZlBhaXJzLnB1c2goIlhfaW5kZXhlZFBhZ2VzIiwiIik7CmFyck9mUGFpcnMucHVzaCgiWF9pZ25vcmVkUGFnZXMiLCIiKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3JlamVjdGVkUGFnZXMiLCIiKTsKdXBkYXRlREIoZG9jLGFyck9mUGFpcnMpOwovKiBNb3ZlIHRoZSBzcGxpdCBkb2N1bWVudCB0byBpdHMgcHJvY2Vzc2luZyBmb2xkZXIgKi8KYWxlcnQoIkBAQEBAQCBNb3ZpbmcgdGhlIGluZGV4ZWQgcGFnZXMgZG9jdW1lbnQgaW50byBuZXh0IHByb2Nlc3NpbmcgZm9sZGVyOiAiICsgbmV4dEZvbGRlcik7Ci8vRVJTMTkwNzMxICM2MTI3MiBtb3ZlRG9jdW1lbnQoZG9jLCIiLG5leHRGb2xkZXIpOwovL0VSUzE5MDczMSAjNjEyNzIgcmVsb2FkQnlCQVRFUyhkb2MsIG5leHRGb2xkZXIpOyAvL0VSUzE3MDQxMyAjMzUyOTEKLyogUGxhY2UgdGhlIHNwbGl0IGRvY3VtZW50IGludG8gdGhlIHN0YWNrIGZvbGRlciAqLwphbGVydCgiQEBAQEBAIE1vdmluZyB0aGUgaW5kZXhlZCBwYWdlcyBkb2N1bWVudCBpbnRvIHRoZSBmaW5hbCBzdGFjayBmb2xkZXI6ICIgKyBzdGFja0ZvbGRlcik7Cm1vdmVEb2N1bWVudChkb2MsIiIsc3RhY2tGb2xkZXIpOwp1bmxvY2tEb2N1bWVudChkb2MpOwphcnJPZlBhaXJzID0gekRhdGEuYWRkU3RhZ2UoZG9jLGFyck9mUGFpcnMsekRhdGEuc3RhZ2UpOwp2YXIgcGFnZUNvdW50ID0gekRhdGEuY291bnRQYWdlcyhkb2MscGFnZVJhbmdlKTsKYWxlcnQoIkBAQEAgcGFnZUNvdW50ID0gIiArIHBhZ2VDb3VudCArIiB3ZXJlICIrIHpEYXRhLnN0YWdlKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3BhZ2VzIixwYWdlQ291bnQpOwphcnJPZlBhaXJzLnB1c2goIlhfY291bnQiLHBhZ2VDb3VudCk7IC8vUFYxOTEwMjggdXBkYXRlZCBmb3Igc3RhY2sgY29tcGxldGUgdG8gdXNlIGV4YWN0IHBhZ2VzCmFyck9mUGFpcnMucHVzaCgiZGItcGFnZXMiLHBhZ2VDb3VudCk7Ci8vRVJTMTkwNjIwIGFyck9mUGFpcnMucHVzaCgiZGItbGFiZWwiLCBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBjb21wYW55Q29kZSArICIgLSAiICsgc3RhY2tJZCk7Ci8vYXJyT2ZQYWlycy5wdXNoKCJYX2F0dGFjaGVkVG8iLGF0dGFjaFBhdGgpOyAvL0NSTjE5MTAyOCBXZSBkb24ndCBuZWVkIHRvIHVwZGF0ZSB0aGUgWF9hdHRhY2hlZFRvIGJlY2F1c2UgaXQgaXMgYmVpbmcgc2V0IGNvcnJlY3RseSBkdXJpbmcgZWFjaCBhdHRhY2guIEJlc2lkZXMsIGF0dGFjaFBhdGggaG9sZHMgdGhlIHBhcmVudCdzIG1hc3NhZ2VkIFhfYXR0YWNoZWRUbyB3aGljaCB3ZSBkb24ndCB3YW50LiAvL0VSUzE3MDYyOAp1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7CgovL1BWMTkxMDI5IEFkZCAiSW5kZXhlZCIgdG8gdGhlICJSZWNlaXZlZCIgWF9yZXZpZXdzIGFkZGVkIGluIGNsaWVudCBsaWJyYXJ5IGFib3ZlLgp2YXIgb3JpZ1hSZXZpZXdzID0gWChkb2MsICJYX3Jldmlld3MiKTsKdmFyIG5vdzAgPSBnZXRDdXJEYXRlQW5kVGltZShkb2MpOy8vUHYxOTEwMjkgY2hlY2sgZG9jc2V0IGNoZWNrYm94CmFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld3MiLCBvcmlnWFJldmlld3MgKyAiSW5kZXhlZCBieSBhZ2VudCBhdCAiICsgbm93MCArICI8YnIvPiIpOwp1cGRhdGVEQihkb2MsIGFyck9mUGFpcnMpOwoKdHJhY2soZG9jLCAiRG9jIEluZGV4ZWQiLCAiRG9jdW1lbnQgd2l0aCBJZDogIiArIGRvYy5kYklELCBwYWdlQ291bnQpOwphZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIm5leHRQYWdlKH5yZWFkeX4pO3VwZGF0ZURFU3RhdHVzKH5pbmRleGVkOiIgKyBwYWdlUmFuZ2UgKyAifik7Iik7CgovKiBlbmQgb2YgcnVsZSAqLwo="},"ordinal":10}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("@@@@ Index Rule Fired @@@#");
//ERS190730 #61272 updated button validation in the Actions* Details area

var stackId = X(doc, "X_stack");
if (!stackId) stackId=zData.getStackId(doc); //ERS190624 HACK?
var stackFolder = stackId + "-STACK";
var companyCode = doc.deliveredTo;
zData.stage="Indexed"; //ERS190620

/* Clear the trigger that invoked this rule */
//ERS170909 zData.clearTriggerCondition(doc,"X_buttonAction");
var indexInitialized = X(doc,"X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    zData.initializeStack(doc,stackFolder, companyCode, stackId);
}

saveDEPanelValues(doc);             //CRN191118 Save DE Fields to Parent Stack
zData.getDataEntryFields(doc);
// Does the user want to attach indexed pages to Case?
//var caseId = X(doc, "X_ZPAPER__Case__c");
//var contactId = X(doc, "X_ZPAPER__Patient__c");
//var patientId=contactId; //TODO
//var providerId = X(doc, "X_ZPAPER__Provider__c");
//var patientFirstName = X(doc, "X_ZPAPER__FirstName__c");
//var patientLastName = X(doc, "X_ZPAPER__LastName__c");
//var patientDOB = X(doc, "X_ZPAPER__Birthdate__c");

// Get the document type (will be used to route to next folder)
//var docType = X(doc, "X_Document_Type__c");
var nextFolder = "20500Triage-S2";              // Other folder is the default
var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
//move to after updates arrOfPairs=zData.addStage(doc,arrOfPairs,"Indexed");
updateDB(doc,arrOfPairs);

//var sfStackId=zData.getStackId(doc);
var sfStackId=X(doc,'X_sfStackId');
if(!sfStackId){
  sfStackId=zData.getStackId(doc);
}

alert("@@@@@@ Currently attached to ZPAPER__zStack__c with ID: " + sfStackId);
zData.zParentId=doc.dbID; //ERS190814 to overside the save.jsp workflows

alert("@@@@ Parent zStack Snippet attached to: " + X(doc, "X_attachedTo"));

/* SPLIT OFF NEW SNIPPET HERE */
var pageRange = X(doc,"X_idxPages");
var newId=splitDocumentForIndex(doc, "index", pageRange);

alert("@@@@ AFTER SPLIT: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));

saveDEPanelValues(doc);             //CRN191118 Also Save DE Fields to Child Stack

alert("ERS190624 newId="+newId);
//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/* Attach the split document to a new Case record, if it wasn't passed in and if we are not handling the 2A DE Panel: Canada_Priority_Data2_Web_Form */
//var priority=X(doc,"X_ZPAPER__Priority__c"); //ERS170626
var label0="";
var triageType=doc.docType;

var attachPath = X(doc,"X_attachedTo");
zData.attachedToCase =false;
zData.attachedTo = X(doc, "X_Attach_To__c"); //PV191205 updated case creation
    alert("zData.attachedTo========="+zData.attachedTo);
    var attachFaxTypes =["ENRL","MEDO","OTH","COPAY"];
    //if( attachFaxTypes.indexOf(zData.X_ZPAPER__faxType__c) >-1 && (zData.attachedTo === "Care Plan" || zData.attachedTo === "All")){
    if((zData.attachedTo === "Care Plan" || zData.attachedTo === "All")){
      zData.attachedToCase = true;
    }
/* Attach the split document to Patient record if required */ //ERS190619
zData.patientType=XCustomSetting(doc,"ZPAPER__PatientRecord__c"); //ERS190806 ZPAPER__ now in MP
alert("@@@@ zData.patientType ***** "+zData.patientType+" Patient");
alert("@@@ current DE Panel name = " + X(doc, "X_lastDEPanel"));
if (!zData.patientType) zData.patientType="Contact"; //ERS190802 #61272
//if (X(doc,"X_ZPAPER__Patient__c") || zData.X_ZPAPER__LastName__c) { //ERS190803 TODO rethink use X
    var dq = zData.dq = String.fromCharCode(34); //ERS190802 TODO define better in zData
    var patientPhone = X(doc, "X_ZPAPER__Phone__c");
    alert("@@@ patientPhone = " + patientPhone);
    if (!zData.patientId) {
        alert("@@@@ creating new "+zData.patientType+" Patient");
        arrOfPairs = [];
        //ERS190730 #61272 missing the basics
        var p="";
        if ("Account"===zData.patientType) { //ERS190803
            p="Person";
            //arrOfPairs.push("Name", zData.X_ZPAPER__FirstName__c+" "+zData.X_ZPAPER__LastName__c);
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c);
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push(p+"Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        } else {
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c); //X_ZPAPER__FirstName__c //ERS190803 TODO get cleaner #61272
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push("Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        }
        var attachLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
        zData.patientId=zData.clientPatient(doc,arrOfPairs, attachLabel);
        alert("Created Patient with ID: " + zData.patientId);
        if (zData.patientId == "null" || zData.patientId == "NEW") zData.patientId=null;
        else { //ERS190730 #61272 leverage the new record
            if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
            alert("@@@@@@@ NEW PATIENT CREATED WITH ID: " + zData.patientId); //ERS190802 zData.contactId
            // clear out the "New Patient" fields
            if (1===1) { //ERS190811 #61570 commented out so that patient info is available for DE variables in zippi
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Phone__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + "NONE" + dq + "); ");
            }
            // set the Patient lookup fields
            //ERS190803 TODO handle ZPAPER__ relationships //ERS190811 double up for safety
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            //CRN191118 Also save the new values to the child
            var save2DBArrOfPairs = [];
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__c", zData.patientId);
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__r.Name", zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c);
            updateDB(doc, save2DBArrOfPairs);
        }
    } else {
        //if (zData.X_ZPAPER__faxType__c && ("CONS" === zData.X_ZPAPER__faxType__c
         //   || "ENRL" ===zData.X_ZPAPER__faxType__c ||
         //  "MEDO" === zData.X_ZPAPER__faxType__c)) { //ERS19109 #64921 TODO many journey best proctice
            alert("@@@@ attaching to existing Patient: " + zData.patientId);
            if (zData.patientType != "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "FirstName,LastName,Birthdate", null, zData.patientId);
                alert("@@@@ attaching to existing contactFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "FirstName", contactFlds); //PV191006 update the child stack
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "LastName", contactFlds);
                zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "Birthdate", contactFlds);
            } else if (zData.patientType === "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "Name", null, zData.patientId);
                alert("@@@@ attaching to existing AccountFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "Name", contactFlds).split(" ")[0]; //ERS190803 TODO find a better way
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "Name", contactFlds).split(" ")[1];
                //zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "PersonBirthdate", contactFlds);

            }
            //PV191008 updated attachLabel on child stack
            attachLabel=zData.clientFile(doc,"Indexed");
            if(zData.attachedTo === "Patient" || zData.attachedTo === "All"){
                attach(doc, attachLabel, zData.patientId);
            }
      // }
    }
    if (zData.patientId && attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
//}
alert("@@@@ AFTER PATIENT: Child zStack Snippet attached to: " + attachPath);

var attachLabel=zData.clientFile(doc,"Indexed"); //"Indexed " + formatNow;
alert("ERS190624 attachLabel="+attachLabel);


/* Attach the split document to Lead record if required */ //ERS190619
// TODO ERS190624 flip the if logic
if (doc.wddata.indexOf("X_ZPAPER__ReferralLead__c")>-1) { //ERS190803 TODO rethink
    if (!leadId || 0 === leadId.length) {
        alert("@@@@ creating new Lead");
        arrOfPairs = [];
        leadId=zData.clientLead(doc,arrOfPairs);
        alert("Created Lead with ID: " + leadId);
        if (leadId == "null" || leadId == "NEW") leadId=null;
    } else {
        if (zData.attachRecords.indexOf("Lead")>-1) {
            alert("@@@@ attaching to existing Lead: " + leadId);
            attach(doc, attachLabel, leadId);
        }
    }
    if (leadId && attachPath.indexOf(leadId)==-1) attachPath+=","+leadId;
}
alert("@@@@ AFTER LEAD: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//ERS190620 use a setting to determine which lookups we attach to
/* Attach the split document to Case record if required */ //ERS190619
//if (doc.wddata.indexOf("X_ZPAPER__Case__c")>-1) {
  if(1===1){
    alert("ERS190624 need Case");
    if (zData.caseId) {
        if (zData.attachRecords.indexOf("Case")>-1) {
            alert("@@@@ attaching to existing Case: " + zData.caseId);
            attachLabel=zData.clientFile(doc,"Indexed");
            if(zData.attachedToCase){
                attach(doc, attachLabel, zData.caseId);
            }
        }
    }
    alert("ERS190624.78 have a case?");
    if (zData.caseId && attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}

alert("@@@@ AFTER CASE: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//PV191022 create prescription
var stackFlds = getSFFields(doc, "ZPAPER__zStack__c", "ZPAPER__latestFax__c", null, sfStackId);
zData.X_ZPAPER__latestFax__c =  X(doc, "ZPAPER__latestFax__c", stackFlds); //PV190926 update the child stack
if( zData.X_Prescription__c){
    alert("@@@@ attaching to existing Prescription: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    if( zData.attachedTo ==="Prescription" || zData.attachedTo ==="All"){
        attach(doc, attachLabel, zData.X_Prescription__c);
    }
}
if( !zData.X_Prescription__c && zData.X_ZPAPER__faxType__c &&"RX" === zData.X_ZPAPER__faxType__c ) { //ERS191109 #64921 TODO many journeys
    alert("@@@@ Creating  Prescription__c with fax Type : " + zData.X_ZPAPER__faxType__c);
    arrOfPairs = [];
    arrOfPairs.push("Core_Date_of_Prescription_Received__c",zData.X_ZPAPER__latestFax__c);
    arrOfPairs.push("Core_ProductPrescribed__c",zData.X_ZPAPER__Classification__c);
    arrOfPairs.push("Core_CarePlan__c", zData.caseId);
    arrOfPairs.push("Core_Patient__c", zData.patientId);
    if( zData.attachedTo ==="Prescription" || zData.attachedTo ==="All"){
        zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");
    }else{
        zData.X_Prescription__c = zData.clientRecordTypeNoAttach(doc,"Core_Prescription__c",arrOfPairs,"Index");
    }
    //zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");  CRN191213 Don't create the Prescription multiple times
    alert("@@@@ Create Prescription__c with ID: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    //attach(doc, attachLabel, zData.X_Prescription__c);
    zData.PrescriptionName = getSFField(doc, "Core_Prescription__c", "Name", null, zData.X_Prescription__c); //PV191022 //ERS191109 clientIndex?
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c" + dq + ").val(" + dq + zData.X_Prescription__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c_Name" + dq + ").val(" + dq + zData.PrescriptionName + dq + "); ");

}
//CRN191118 If we also have a patient and a Prescription, associate them.
/*
if (zData.patientId && zData.X_Prescription__c) {
    alert("@@@ Associating Prescription: " + zData.X_Prescription__c + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
    updateSFRecord(doc, "Core_Prescription__c", zData.X_Prescription__c, scriptArrOfPairs);
}
*/

//COMDR
//if( !zData.caseId && ("COMDR" === zData.X_ZPAPER__faxType__c
//     || "MEDC"=== zData.X_ZPAPER__faxType__c || "LAB"=== zData.X_ZPAPER__faxType__c
//     || "INJR"===zData.X_ZPAPER__faxType__c)){
//CRN191114 According to the Abbvie stories, all docTypes except "Consent Forms" need to have a Case created if one isn't already selected
if(!zData.caseId && "CONS" !== zData.X_ZPAPER__faxType__c && 'Canada_Priority_Data2_Web_Form' !== X(doc, "X_lastDEPanel")) {
    arrOfPairs = [];
    arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");               // CRN191114 Always use CarePlan Record Type?
    arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
    if(zData.programName === "Abbvie OneCRM - Canada"){
        arrOfPairs.push("Core_CountryCode__c","CA");
    }
    if (zData.patientId) { arrOfPairs.push("AccountId", zData.patientId); }
    if(zData.attachedToCase){
        zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
    }else{
        zData.caseId = zData.clientRecordTypeNoAttach(doc,"Case",arrOfPairs,"Index");
    }
    zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    zData.X_Clinical_Services_Record_Type__c = X(doc, "X_Clinical_Services_Record_Type__c");

/*
CRN191113 Moved below where the docType logic isn't so convoluted
    if("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c){
      arrOfPairs = [];
      if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24GQAS");
      }
      if("injection Training"===zData.X_Clinical_Services_Record_Type__c){

        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24LQAS");
      }

     //arrOfPairs.push("Service_Requested_date__c",zData.X_Service_Requested_Date__c);
     //arrOfPairs.push("Core_Patient__c",zData.patientId);
     if(!zData.X_Clinical_Services__c){
        associatedArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
        associatedArrOfPairs.push("Core_Patient__c", zData.patientId);
        zData.X_Clinical_Services__c = zData.clientRecordType(doc,"Core_Clinical_Service__c",arrOfPairs,"Index");
     }
     attachLabel=zData.clientFile(doc,"Indexed");
     attach(doc, attachLabel,  zData.X_Clinical_Services__c);
     zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
    }
    */
}

//SHR191209 #65535 add Document Link if we have a new Case Id
if (zData.caseId) {
    var zserver = doc.kbData.sfServer.startsWith("https://") ? doc.kbData.sfServer : "https://" + doc.kbData.sfServer;
    var docurl = zserver + "/services/data/v46.0/sobjects/ContentVersion/";
    var pdfurl = "https://gw.zpaper.com/kb/jsp/SF_find.lightning.jsp?go=SF_files.jsp&dbID=" + doc.dbID + "&SForg=" + doc.kbData.sfOrganizationID;
    var ContentVersionCategories = {
        "OTH": "Other Documents",
        "MIF": "Missing Information",
        "ENRL": "Enrollment Form",
        "MEDO": "Medical - Other",
        "CONS": "Consent Forms",
        "COMDR": "Communication from Physicians",
        "RX": "Prescription",
        "SA": "SA Documents",
        "MEDC": "Medical Clarification",
        "LAB": "Lab Documents",
        "INJR": "Injection Report",
        "CA": "Clinical Assessment",
        "COPAY": "Copay"
    }
    var datestr = getCurDate(doc);
    var accname = X(doc, "X_ZPAPER__PatientAccount__r.Name");
    var faxtype = X(doc, "X_ZPAPER__faxType__c");
    var revstat = X(doc, "X_reviewedStatus");
    var cattype = ContentVersionCategories[faxtype] || faxtype;
    var docdata = {
        "Title": accname + " - " + faxtype + " - " + datestr,
        "Description": revstat + " by: " + doc.sfUserName + " at: " + zData.formatNow,
        "FirstPublishLocationId": zData.caseId,
        "ContentUrl": pdfurl,
        "CORE_Legacy_Document_ID__c": pdfurl,
        "Core_CountryCode__c": "CA",
        "Core_Category__c": cattype,
        "Core_Sub_Category__c": zData.X_Sub_Category__c
    };
    var headers = [
        "Authorization", "Bearer " + doc.kbData.sfSessionID,
        "Content-Type", "application/json"
    ];
    var body = JSON.stringify(docdata);
    try {
        var res = wpost(doc, docurl, [], headers, body);
        alert("wpost response: " + res);
    }
    catch(ex) {
        alert("wpost exception: " + ex);
        try {
            var mess = JSON.parse(ex);
            if (mess && Array.isArray(mess) && mess[0].errorCode) {
                addPostExecutionScript(doc, "alert(`Error creating ContentVersion! " + mess[0].errorCode + " => " + mess[0].message + "`);");
            }
        }
        catch(pex) {
            addPostExecutionScript(doc, "alert(`Error parsing JSON repsponse: " + ex + "`);");
        }
    }
}

//COPAY
if ("COPAY" === zData.X_ZPAPER__faxType__c) {
    arrOfPairs = [];
    arrOfPairs.push("CA_Patient__c",zData.patientId);
    arrOfPairs.push("CA_CarePlanID__c",zData.caseId);
    zData.copayId = zData.clientRecordType(doc,"CA_Copay__c",arrOfPairs,"Index");
}


//OTH
if( !zData.caseId && ("OTH" === zData.X_ZPAPER__faxType__c || "ENRL" === zData.X_ZPAPER__faxType__c
    || "MEDO" === zData.X_ZPAPER__faxType__c || "RX" === zData.X_ZPAPER__faxType__c )){
    if(zData.createCase){
        arrOfPairs = [];
        arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");
        arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
        if(zData.programName === "Abbvie OneCRM - Canada"){
            arrOfPairs.push("Core_CountryCode__c","CA");
        }

        zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
        zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    }
}

if( zData.X_Reported_Outcome__c){
    alert("@@@@ attaching to existing Outcome: " + zData.X_Reported_Outcome__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    if( zData.attachedTo ==="Reported Outcomes" || zData.attachedTo ==="All"){
        attach(doc, attachLabel, zData.X_Reported_Outcome__c);
    }
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating Reported Cutcome: " + zData.X_Reported_Outcome__c + " with Patient: " + zData.patientId);
        var outcomeArrOfPairs = [];
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
        updateSFRecord(doc, "Core_Patient_Reported_Outcomes__c", zData.X_Reported_Outcome__c, outcomeArrOfPairs);
    }
}
else if ("CA" === zData.X_ZPAPER__faxType__c) {
    var outcomeArrOfPairs = [];
    outcomeArrOfPairs.push("Core_Entry_Date__c", getCurDate(doc));
    outcomeArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    var assessmentType = X(doc, "X_Assessment_Type__c");
    if (assessmentType && "DONOT_SAVE" !== assessmentType) {
        outcomeArrOfPairs.push("Core_Assessment_Type__c", assessmentType);
    }
    var outcomeType = X(doc, "X_Outcome_Type__c");
    if (outcomeType && "DONOT_SAVE" !== outcomeType) {
        outcomeArrOfPairs.push("Core_Outcome_Type__c", outcomeType);
    }
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating New Reported Cutcome with Patient: " + zData.patientId);
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    }
    if( zData.attachedTo ==="Reported Outcomes" || zData.attachedTo ==="All"){
        zData.X_Reported_Outcome__c = zData.clientRecordType(doc,"Core_Patient_Reported_Outcomes__c",outcomeArrOfPairs,"Index");
    }else{
        zData.X_Reported_Outcome__c = zData.clientRecordTypeNoAttach(doc,"Core_Patient_Reported_Outcomes__c",outcomeArrOfPairs,"Index");
    }
    var outcomeName = getSFField(doc, "Core_Patient_Reported_Outcomes__c", "Name", null, zData.X_Reported_Outcome__c);
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c" + dq + ").val(" + dq + zData.X_Reported_Outcome__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c_Name" + dq + ").val(" + dq + outcomeName + dq + "); ");
}


arrOfPairs = [];
if (zData.docType) { arrOfPairs.push("ZPAPER__faxType__c", zData.docType);  } //ERS190810 PV190808 #51670
if (zData.providerId) {
    arrOfPairs.push("ZPAPER__Provider__c", zData.providerId);
    if (attachPath.indexOf(zData.providerId)==-1) attachPath+=","+zData.providerId;
}
alert("ERS190812.200 zData.patientId="+zData.patientId); //ERS190812 #61511
if (zData.patientId) {
    if (zData.patientId.indexOf("003")===0) arrOfPairs.push("ZPAPER__Patient__c", zData.patientId);
    if (zData.patientId.indexOf("001")===0) arrOfPairs.push("ZPAPER__PatientAccount__c", zData.patientId);
    if (zData.patientId.indexOf("00Q")===0) arrOfPairs.push("ZPAPER__ReferralLead__c", zData.patientId); //ERS190802 Lead
    if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
    if (1===1) { //ERS190810 PV190808 data entry for next split
        if (zData.X_ZPAPER__FirstName__c) { arrOfPairs.push("ZPAPER__FirstName__c", zData.X_ZPAPER__FirstName__c); }
        if (zData.X_ZPAPER__LastName__c) { arrOfPairs.push("ZPAPER__LastName__c", zData.X_ZPAPER__LastName__c); }
        if (zData.X_ZPAPER__Birthdate__c) { arrOfPairs.push("ZPAPER__Birthdate__c", zData.X_ZPAPER__Birthdate__c); }
        if (zData.X_ZPAPER__Status__c) {arrOfPairs.push(zp+"Status__c", "Completed"); } //PV191023 updateing status
    }
}
if (zData.caseId) {
    arrOfPairs.push("ZPAPER__Case__c", zData.caseId);
    if (attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}
 alert("@@@@ zData.contactId = " + zData.contactId);
if (zData.contactId && zData.contactId.startsWith("003")) {

    arrOfPairs.push("ZPAPER__Patient__c", zData.contactId);
}
if (zData.leadId) {
    arrOfPairs.push("ZPAPER__ReferralLead__c", zData.leadId);
    if (attachPath.indexOf(zData.leadId)==-1) attachPath+=","+zData.leadId;
}
if (zData.referralId) {
    arrOfPairs.push("ZPAPER__Referral__c", zData.referralId);
    if (attachPath.indexOf(zData.referralId)==-1) attachPath+=","+zData.referralId;
}
if (zData.X_ZPAPER__Phone__c) { //PV191006 UPDATED FOR PHONE
    arrOfPairs.push("ZPAPER__Phone__c", zData.X_ZPAPER__Phone__c);

}
var specialAuthId = X(doc, "X_Special_Authorization__c");
alert("@@@ zData.X_Special_Authorization__c " + specialAuthId);
var authDocType = X(doc, "ZPAPER__faxType__c");
if (specialAuthId) {
    arrOfPairs.push("Special_Authorization__c", specialAuthId);
    //PV191113 If we have a Special Authorization, attach this document to it
    var specialLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    if( zData.attachedTo ==="Special Authorization" || zData.attachedTo ==="All"){
        attach(doc, specialLabel, specialAuthId);
    }
}
else if ("SA" === zData.X_ZPAPER__faxType__c) {
    var authArrOfPairs = [];
    var authLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    authArrOfPairs.push("MemberPlanId", zData.X_Member_Plan__c , "CA_Coverage_Benefit__c", zData.X_Coverage_Benefit__c );
    authArrOfPairs.push("CA_Patient__c", zData.patientId);
    authArrOfPairs.push("Name", "anyValue");
    var specialAuthId ="";
    if( zData.attachedTo ==="Special Authorization" || zData.attachedTo ==="All"){
        specialAuthId = createAndAttach(doc, "CarePreauth", authLabel, authArrOfPairs);
    }else{
        specialAuthId = createSFRecord(doc, "CarePreauth", authLabel, authArrOfPairs);
    }

    if (!specialAuthId.contains("ERROR")) {
        var authName = getSFField(doc, "CarePreauth", "Name", null, specialAuthId);
        arrOfPairs.push("Special_Authorization__c", specialAuthId);
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c" + dq + ").val(" + dq + specialAuthId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c_Name" + dq + ").val(" + dq + authName + dq + "); ");
    }
}
//CRN191118 If we also have a Patient and a Special Authorization, associate them.
if (zData.patientId && specialAuthId) {
    alert("@@@ Associating Special Authorization: " + specialAuthId + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("CA_Patient__c", zData.patientId);
    updateSFRecord(doc, "CarePreauth", specialAuthId, scriptArrOfPairs);
}

//CRN191114 Handle any passed-in physician (Should this be only for COMDR: Communication from Physician?)
alert("@@@@ zData.X_Physician__c = " + zData.X_Physician__c);
alert("@@@@ X_Physician__c = " + X(doc, "X_Physician__c"));
if (X(doc, "X_Physician__c")) {
    zData.X_Physician__c = X(doc, "X_Physician__c");
    alert("@@@@ zData.X_Physician__c now = " + zData.X_Physician__c);
    arrOfPairs.push("Physician__c", zData.X_Physician__c);
    var physicianLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    alert("@@@ Attaching to Physician__c with Id: " + zData.X_Physician__c);
    attach(doc, physicianLabel, zData.X_Physician__c);
}

//PV191008 updated new fields
if(zData.X_ZPAPER__Classification__c) arrOfPairs.push("ZPAPER__Classification__c",zData.X_ZPAPER__Classification__c);
if( zData.X_ZPAPER__Priority__c) {
    if (!zData.X_ZPAPER__faxType__c) {
        arrOfPairs.push("ZPAPER__Priority__c",zData.X_ZPAPER__Priority__c);
    }
    else {
        arrOfPairs.push("ZPAPER__Priority__c", "");
    }
}
if( zData.X_Sub_Category__c )  arrOfPairs.push("Sub_Category__c",zData.X_Sub_Category__c);
if( zData.X_ZPAPER__faxType__c)  arrOfPairs.push("ZPAPER__faxType__c",zData.X_ZPAPER__faxType__c);
if( zData.X_Prescription__c )  arrOfPairs.push("Prescription__c",zData.X_Prescription__c);
if( zData.X_Member_Plan__c )  arrOfPairs.push("Member_Plan__c",zData.X_Member_Plan__c);
if( zData.X_Coverage_Benefit__c )  arrOfPairs.push("Coverage_Benefit__c",zData.X_Coverage_Benefit__c);
if( zData.X_Clinical_Services__c ) {
    arrOfPairs.push("Clinical_Services__c",zData.X_Clinical_Services__c);
    //PV191113 If we have a Clinical Services, attach this document to it
    var clinicalLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    if( zData.attachedTo ==="Clinical Services" || zData.attachedTo ==="All"){
        attach(doc, clinicalLabel, zData.X_Clinical_Services__c);
    }
}
else if (("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c) && X(doc, "X_Service_Requested_Date__c")) {        //CRN191113 Create new Clinical Services record if DocType is MEDC and the Service Requested Date is filled in
    var clinicalSvcArrOfPairs = [];
    var clinicalSvcLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    clinicalSvcArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    clinicalSvcArrOfPairs.push("Core_Patient__c", zData.patientId);
    if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0121i000000Y9DRAA0");
    }
    clinicalSvcArrOfPairs.push("Service_Requested_date__c", X(doc, "X_Service_Requested_Date__c"));
    if("Injection Training"===zData.X_Clinical_Services_Record_Type__c){
        clinicalSvcArrOfPairs.push("Clinical_Services_Record_Type__c","0121i000000Y9DQAA0");
    }
    var clinicalSvcId="";
    if( zData.attachedTo ==="Clinical Services" || zData.attachedTo ==="All"){
        clinicalSvcId = createAndAttach(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    }else{
        clinicalSvcId = createSFRecord(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    }

    if (!clinicalSvcId.contains("ERROR")) {
        zData.X_Clinical_Services__c = clinicalSvcId;
        zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
        arrOfPairs.push("Clinical_Services__c", zData.X_Clinical_Services__c);

        //CRN191118 If we also have a Patient and a Clinical Service, associate them.
        if (zData.patientId) {
            alert("@@@ Associating Clinical Service: " + clinicalSvcId + " with Patient: " + zData.patientId);
            var scriptArrOfPairs = [];
            scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
            updateSFRecord(doc, "Core_Clinical_Service__c", clinicalSvcId, scriptArrOfPairs);
        }
    }
}

if( zData.X_Service_Requested_Date__c )  arrOfPairs.push("Service_Requested_Date__c",zData.X_Service_Requested_Date__c);
if( zData.X_Reported_Outcome__c )  arrOfPairs.push("Reported_Outcome__c",zData.X_Reported_Outcome__c);
if( zData.X_Assessment_Type__c && "DONOT_SAVE" !== zData.X_Assessment_Type__c)  arrOfPairs.push("Assessment_Type__c",zData.X_Assessment_Type__c);
if( zData.X_Outcome_Type__c && "DONOT_SAVE" !== zData.X_Outcome_Type__c)  arrOfPairs.push("Outcome_Type__c",zData.X_Outcome_Type__c);
if(zData.X_Product_Described__c) arrOfPairs.push("Product_Described__c",zData.X_Product_Described__c);
if(zData.X_ZPAPER__latestFax__c) arrOfPairs.push("ZPAPER__latestFax__c",zData.X_ZPAPER__latestFax__c);
//ERS190814 just the child #61511 updateSFRecord(doc, zData.zps, sfStackId, arrOfPairs);
//let the docSet do the work attach(doc,attachLabel, sfStackId);
var r=updateSFRecord(doc,"ZPAPER__zStack__c",sfStackId,["ZPAPER__Status__c","Split"]); //PV191216
alert("@@@@ updated and attached to zStack Record, id = " + sfStackId + "?="+zData.getStackId(doc)+" data="+arrOfPairs);

var childStackId=zData.clientChildStack(doc,arrOfPairs,sfStackId); //ERS190810 create child stack for split ERS190811 clientChildStack
if (childStackId) {attachPath+=","+sfStackId+","+childStackId; attachPath=attachPath.replace("/,?","/"); } //ERS190811 #61570 clean up //parent stack too
arrOfPairs=[];//PV191023 Everytime child will attach to that particular zStack
arrOfPairs.push("X_sfStackId",childStackId);
//CRN191118 Clear out these values from parent stack
arrOfPairs.push("X_indexedPages","");
arrOfPairs.push("X_ignoredPages","");
arrOfPairs.push("X_rejectedPages","");
updateDB(doc,arrOfPairs);
/* Move the split document to its processing folder */
alert("@@@@@@ Moving the indexed pages document into next processing folder: " + nextFolder);
//ERS190731 #61272 moveDocument(doc,"",nextFolder);
//ERS190731 #61272 reloadByBATES(doc, nextFolder); //ERS170413 #35291
/* Place the split document into the stack folder */
alert("@@@@@@ Moving the indexed pages document into the final stack folder: " + stackFolder);
moveDocument(doc,"",stackFolder);
unlockDocument(doc);
arrOfPairs = zData.addStage(doc,arrOfPairs,zData.stage);
var pageCount = zData.countPages(doc,pageRange);
alert("@@@@ pageCount = " + pageCount +" were "+ zData.stage);
arrOfPairs.push("X_pages",pageCount);
arrOfPairs.push("X_count",pageCount); //PV191028 updated for stack complete to use exact pages
arrOfPairs.push("db-pages",pageCount);
//ERS190620 arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + stackId);
//arrOfPairs.push("X_attachedTo",attachPath); //CRN191028 We don't need to update the X_attachedTo because it is being set correctly during each attach. Besides, attachPath holds the parent's massaged X_attachedTo which we don't want. //ERS170628
updateDB(doc,arrOfPairs);

//PV191029 Add "Indexed" to the "Received" X_reviews added in client library above.
var origXReviews = X(doc, "X_reviews");
var now0 = getCurDateAndTime(doc);//Pv191029 check docset checkbox
arrOfPairs = [];
arrOfPairs.push("X_reviews", origXReviews + "Indexed by agent at " + now0 + "<br/>");
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");

/* end of rule */

//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
dmFyIERFX1BBTkVMX0ZPUk1fMkEgICAgPSAiQ2FuYWRhX1ByaW9yaXR5X0RhdGEyX1dlYl9Gb3JtIjsKdmFyIERFX1BBTkVMX0ZPUk1fMkIgICAgPSAiT25lX0NSTV9DYW5hZGFfSW5kZXhfRGF0YTJfV2ViX0Zvcm0iOwoKLyoKPG9wdGlvbiB2YWx1ZT0iRE9OT1RfU0FWRSI+PC9vcHRpb24+CjxvcHRpb24gdmFsdWU9Ik9USCI+T1RIOk90aGVyIERvY3VtZW50czwvb3B0aW9uPgo8b3B0aW9uIHZhbHVlPSJFTlJMIj5FTlJMOkVucm9sbG1lbnQ8L29wdGlvbj4KPG9wdGlvbiB2YWx1ZT0iTUVETyI+TUVETzogTWVkaWNhbCBPdGhlcjwvb3B0aW9uPgo8b3B0aW9uIHZhbHVlPSJDT05TIj5DT05TOiBDb25zZW50PC9vcHRpb24+CjxvcHRpb24gdmFsdWU9IkNPTURSIj5DT01EUjogQ29tbXVuaWNhdGlvbiBmcm9tIFBoeXNpY2lhbjwvb3B0aW9uPgo8b3B0aW9uIHZhbHVlPSJSWCI+Ulg6IFByZXNjcmlwdGlvbjwvb3B0aW9uPgo8b3B0aW9uIHZhbHVlPSJTQSI+U0E6IFNwZWNpYWwgQXV0aG9yaXphdGlvbjwvb3B0aW9uPgo8b3B0aW9uIHZhbHVlPSJNRURDIj5NRURDOiBNZWRpY2FsIENsYXJpZmljYXRpb248L29wdGlvbj4KPG9wdGlvbiB2YWx1ZT0iTEFCIj5MQUI6IExhYiBEb2N1bWVudHM8L29wdGlvbj4KPG9wdGlvbiB2YWx1ZT0iSU5KUiI+SU5KUjogSW5qZWN0aW9uIFJlcG9ydDwvb3B0aW9uPgo8b3B0aW9uIHZhbHVlPSJDQSI+Q0E6IENsaW5pY2FsIEFzc2Vzc21lbnQ8L29wdGlvbj4KPG9wdGlvbiB2YWx1ZT0iQ09QQVkiPkNPUEFZOiBDb3BheTwvb3B0aW9uPgo8b3B0aW9uIHZhbHVlPSJVTjpVbmtub3duIj5VTjpVbmtub3duPC9vcHRpb24+CnZhciBmb3JtMkJWYWxpZGF0aW9ucyA9IHsKICAgICJPVEgiOiB7CiAgICAgICAgInJlcUZpZWxkcyI6IFsKICAgICAgICAgICAgeyJuYW1lIjogIiIsICJsYWJlbCI6ICIifQogICAgICAgIF0KICAgIH0sCiAgICAiTUVEQyI6IG51bGwsCiAgICAiTEFCIjogbnVsbCwKICAgICJJTkpSIjogbnVsbAp9CiovCi8vIFdlJ2xsIGZpbGwgdGhpcyBpbiB3aXRoIGEgcmVxRmllbGRzIG1lbWJlciBhcyB0aGUgZXhhbXBsZSBhYm92ZQp2YXIgZm9ybTJCVmFsaWRhdGlvbnMgPSB7CiAgICAiQ09OUyI6ICBudWxsLAogICAgIkVOUkwiOiBudWxsLAogICAgIk1FRE8iOiBudWxsLAogICAgIk9USCI6IG51bGwsCiAgICAiQ09NRFIiOiB7CiAgICAgICAgInJlcUZpZWxkcyI6IFsKICAgICAgICAgICAgeyJuYW1lIjogIlhfUGh5c2ljaWFuX19jIiwgImxhYmVsIjogIlBoeXNpY2lhbiIsICJlbGVOYW1lIjogIlhfUGh5c2ljaWFuX19yLk5hbWUifQogICAgICAgIF0KICAgIH0sCiAgICAiU0EiOiBudWxsLAogICAgIk1FREMiOiB7CiAgICAgICAgInJlcUZpZWxkcyI6IFsKICAgICAgICAgICAgeyJuYW1lIjogIlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyIsICJsYWJlbCI6ICJTZXJ2aWNlIFJlcXVlc3RlZCBEYXRlIiwgImVsZU5hbWUiOiAiWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIn0KICAgICAgICBdCiAgICB9LAogICAgIkxBQiI6IHsKICAgICAgICAicmVxRmllbGRzIjogWwogICAgICAgICAgICB7Im5hbWUiOiAiWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIiwgImxhYmVsIjogIlNlcnZpY2UgUmVxdWVzdGVkIERhdGEiLCAiZWxlTmFtZSI6ICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MifQogICAgICAgIF0KICAgIH0sCiAgICAiSU5KUiI6IG51bGwsCiAgICAiQ0EiOiB7CiAgICAgICAgInJlcUZpZWxkcyI6IFsKICAgICAgICAgICAgeyJuYW1lIjogIlhfQXNzZXNzbWVudF9UeXBlX19jIiwgImxhYmVsIjogIkFzc2Vzc21lbnQgVHlwZSIsICJlbGVOYW1lIjogIlhfQXNzZXNzbWVudF9UeXBlX19jIn0sCiAgICAgICAgICAgIHsibmFtZSI6ICJYX091dGNvbWVfVHlwZV9fYyIsICJsYWJlbCI6ICJPdXRjb21lIFR5cGUiLCAiZWxlTmFtZSI6ICJYX091dGNvbWVfVHlwZV9fYyJ9CiAgICAgICAgXQogICAgfSwKICAgICJDT1BBWSI6IG51bGwKfTsKClN0cmluZy5wcm90b3R5cGUuYXBwZW5kID0gZnVuY3Rpb24gKGFwcGVuZFN0cikgewogICAgcmV0dXJuIGFwcGVuZFN0ciA/IHRoaXMgKyAodGhpcy5sZW5ndGggPiAwID8gIiwgIiA6ICIiKSArIGFwcGVuZFN0ciA6IHRoaXM7Cn07CgpmdW5jdGlvbiBkb1ZhbGlkYXRpb24oKSB7CiAgICBkZWJ1Z2dlcjsKICAgIGNvbnNvbGUubG9nKCJDdXJyZW50IERFIFBhbmVsID0gIiArIF9jdXJERVBhbmVsKTsKICAgIC8vQ1JOMTkxMTE0IEZpcnN0IGNsZWFyIHRoZSBzdHlsZXMgb2YgYWxsIGlucHV0IGZpZWxkcyBhbmQgZ2F0aGVyIGZpZWxkIHZhbHVlcwogICAgdmFyIGZpZWxkcyA9IHt9OwogICAgJCgnLmJpZ0RhdGFFbnRyeScpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyICR0aGlzID0gJCh0aGlzKTsKICAgICAgICBmaWVsZHNbdGhpcy5uYW1lXSA9ICR0aGlzLnZhbCgpOwogICAgICAgIGlmICgnaGlkZGVuJyAhPSAkdGhpcy5hdHRyKCd0eXBlJykpIHsKICAgICAgICAgICAgJHRoaXMuY3NzKCdib3JkZXInLCdtZWRpdW0gbm9uZScpOwogICAgICAgIH0KICAgIH0pOwogICAKICAgIHZhciByZXFCdWZmZXIgPSAiIjsKICAgIHZhciBkb2NUeXBlID0gJCgnW25hbWU9IlhfWlBBUEVSX19mYXhUeXBlX19jIl0nKS52YWwoKTsKICAgCiAgICBpZiAoREVfUEFORUxfRk9STV8yQSA9PT0gX2N1ckRFUGFuZWwpIHsKICAgICAgICAvLyBQYW5lbCBBIFZhbGlkYXRpb25zIEhlcmUKICAgICAgICByZXFCdWZmZXIgPSBkbzJBVmFsaWRhdGlvbnMoZmllbGRzLCByZXFCdWZmZXIpOwogICAgfQogICAgZWxzZSBpZiAoREVfUEFORUxfRk9STV8yQiA9PT0gX2N1ckRFUGFuZWwpIHsKICAgICAgICAvLyBQYW5lbCBCIFZhbGlkYXRpb25zIEhlcmUKICAgICAgICAvLyBUZXN0IHRoZSBmaWVsZHMgdGhhdCBBTFdBWVMgcmVxdWlyZWQKICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZTJCQWx3YXlzUmVxdWlyZWRGaWVsZHMoZmllbGRzLCByZXFCdWZmZXIpOwogICAgICAgIC8vIFRoZXNlIGRvY1R5cGVzIHJlcXVpcmUgc3BlY2lhbCBoYW5kbGluZyB0aGF0IGlzbid0IHNpbXBsZSBsaXN0IG9mIHJlcXVpcmVkIGZpZWxkcy4KICAgICAgICAvLyBTcGVjaWFsIEF1dGhvcml6YXRpb24gcmVxdWlyZXMgc3BlY2lhbCBoYW5kbGluZyB0aGF0IGlzbid0IHNpbXBsZSBsaXN0IG9mIHJlcXVpcmVkIGZpZWxkcy4KICAgICAgICBpZiAoIlNBIiA9PT0gZG9jVHlwZSkgewogICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0U3BlY2lhbEF1dGhvcml6YXRpb24oZmllbGRzLCByZXFCdWZmZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgoIkxBQiIgPT09IGRvY1R5cGUgfHwgIk1FREMiID09PSBkb2NUeXBlKSkgewogICAgICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfQ2xpbmljYWxfU2VydmljZXNfX2MiXSkpIHsKICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHNPYmogPSBmb3JtMkJWYWxpZGF0aW9uc1tkb2NUeXBlXTsKICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHMgPSByZXFGaWVsZHNPYmogPyByZXFGaWVsZHNPYmoucmVxRmllbGRzIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChyZXFGaWVsZHMpIHsKICAgICAgICAgICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCJDQSIgPT09IGRvY1R5cGUpIHsKICAgICAgICAgICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1JlcG9ydGVkX091dGNvbWVfX2MiXSkpIHsKICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHNPYmogPSBmb3JtMkJWYWxpZGF0aW9uc1tkb2NUeXBlXTsKICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHMgPSByZXFGaWVsZHNPYmogPyByZXFGaWVsZHNPYmoucmVxRmllbGRzIDogbnVsbDsKICAgICAgICAgICAgICAgIGlmIChyZXFGaWVsZHMpIHsKICAgICAgICAgICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgcmVxRmllbGRzT2JqID0gZm9ybTJCVmFsaWRhdGlvbnNbZG9jVHlwZV07CiAgICAgICAgICAgIHZhciByZXFGaWVsZHMgPSByZXFGaWVsZHNPYmogPyByZXFGaWVsZHNPYmoucmVxRmllbGRzIDogbnVsbDsKICAgICAgICAgICAgaWYgKHJlcUZpZWxkcykgewogICAgICAgICAgICAgICAgcmVxQnVmZmVyID0gdmFsaWRhdGVGb3JEb2N1bWVudFR5cGUocmVxRmllbGRzLCBmaWVsZHMsIHJlcUJ1ZmZlcikKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAocmVxQnVmZmVyLmxlbmd0aCA+IDApIHsKICAgICAgICBhbGVydCgiRVJST1I6IFRoZSBmb2xsb3dpbmcgZmllbGRzIGFyZSByZXF1aXJlZDogIiArIHJlcUJ1ZmZlcik7CiAgICAgICAgcmV0dXJuIGZhbHNlOyAgIC8vb25lIG9yIG1vcmUgZmllbGQgaXMgbWlzc2luZywgZG9uJ3Qgc2VuZCB0byB0aGUgcnVsZXMgZW5naW5lCiAgICB9CiAgICAvLyBNYWtlIHN1cmUgd2Ugc2VuZCB0aGUgY3VycmVudCBERSBQYW5lbCB0byB0aGUgcnVsZXMKICAgICQoJyNkYXRhRW50cnlGb3JtJykuYXBwZW5kKCI8aW5wdXQgdHlwZT0naGlkZGVuJyBjbGFzcz0nYmlnRGF0YUVudHJ5JyBuYW1lPSdYX2xhc3RERVBhbmVsJyB2YWx1ZT0nIiArIF9jdXJERVBhbmVsICsgIic+Iik7CiAgICByZXR1cm4gdHJ1ZTsgICAgICAgIC8vQWxsIHJlcXVpcmVkIGZpZWxkcyBoYXZlIGJlZW4gc3VwcGxpZWQsIGxldCB0aGUgcnVsZXMgZW5naW5lIGJlIG5vdGlmaWVkCn0KCmZ1bmN0aW9uIGlzQmxhbmsodmFsKSB7CiAgICByZXR1cm4gIXZhbCB8fCAiTk9ORSIgPT09IHZhbCB8fCAiRE9OT1RfU0FWRSIgPT09IHZhbDsKfQoKZnVuY3Rpb24gaXNOb3RCbGFuayh2YWwpIHsKICAgIHJldHVybiB2YWwgJiYgIk5PTkUiICE9PSB2YWwgJiYgIkRPTk9UX1NBVkUiICE9PSB2YWw7Cn0KCmZ1bmN0aW9uIG1hcmtNaXNzaW5nKG5hbWUsIGlkKSB7CiAgICB2YXIgJGVsZSA9IG5hbWUgPyAkKCdbbmFtZT0iJyArIG5hbWUgKyAnIl0nKSA6ICQoJyMnICsgaWQpOwogICAgJGVsZS5jc3MoJ2JvcmRlcicsJzNweCBzb2xpZCByZWQnKTsKfQoKZnVuY3Rpb24gZG8yQVZhbGlkYXRpb25zKGZpZWxkcywgcmVxQnVmZmVyKSB7CiAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyJdKSkgewogICAgICAgIHZhciBsYXN0TmFtZSA9IGZpZWxkc1siWF9aUEFQRVJfX0xhc3ROYW1lX19jIl07CiAgICAgICAgdmFyIGZpcnN0TmFtZSA9IGZpZWxkc1siWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyJdOwogICAgICAgIHZhciBiaXJ0aERhdGUgPSBmaWVsZHNbIlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MiXTsKICAgICAgIAogICAgICAgIGlmKGlzQmxhbmsobGFzdE5hbWUpKSB7CiAgICAgICAgICAgIG1hcmtNaXNzaW5nKCJYX1pQQVBFUl9fTGFzdE5hbWVfX2MiKTsKICAgICAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiTGFzdCBOYW1lIik7CiAgICAgICAgfQogICAgICAgIGlmKGlzQmxhbmsoZmlyc3ROYW1lKSkgewogICAgICAgICAgICBtYXJrTWlzc2luZygiWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyIpOwogICAgICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJGaXJzdCBOYW1lIik7CiAgICAgICAgfQogICAgICAgIGlmKGlzQmxhbmsoYmlydGhEYXRlKSkgewogICAgICAgICAgICBtYXJrTWlzc2luZygiWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyIpOwogICAgICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJCaXJ0aCBEYXRlIik7CiAgICAgICAgfQogICAgfQogICAgdmFyIHByaW9yaXR5RGUgID0gZmllbGRzWyJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiXTsKICAgIGlmKGlzQmxhbmsocHJpb3JpdHlEZSkgfHwgIlVuYXNzaWduZWQiID09PSBwcmlvcml0eURlKSB7CiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19Qcmlvcml0eV9fYyIpOwogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIlByaW9yaXR5IG11c3QgYmUgZWl0aGVyIEhpZ2gsIE1lZGl1bSwgb3IgTG93Iik7CiAgICB9CiAgICByZXR1cm4gcmVxQnVmZmVyOwp9CgovKioKICogUmVxdWlyZWQgZmllbGRzIGZvciAyQiBGb3JtczogQ2xhc3NpZmljYXRpb24sIFByaW9yaXR5LCBQYXRpZW50LCBEb2N1bWVudCBUeXBlLCBhbmQgU3ViLUNhdGVnb3J5CiAqLwpmdW5jdGlvbiB2YWxpZGF0ZTJCQWx3YXlzUmVxdWlyZWRGaWVsZHMoZmllbGRzLCByZXFCdWZmZXIpIHsKICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIl0pKSB7CiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIpOwogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIkNsYXNzaWZpY2F0aW9uIik7CiAgICB9CiAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfWlBBUEVSX19Qcmlvcml0eV9fYyJdKSkgewogICAgICAgIG1hcmtNaXNzaW5nKCJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiKTsKICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJQcmlvcml0eSIpOwogICAgfSAgICAKICAgIC8qaWYgKGlzQmxhbmsoZmllbGRzWyJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiXSkpIHsKICAgICAgICBtYXJrTWlzc2luZygiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19yLk5hbWUiKTsKICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJQYXRpZW50Iik7CiAgICB9ICovCiAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfWlBBUEVSX19mYXhUeXBlX19jIl0pKSB7CiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19mYXhUeXBlX19jIik7CiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiRG9jdW1lbnQgVHlwZSIpOwogICAgfQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1N1Yl9DYXRlZ29yeV9fYyJdKSkgewogICAgICAgIG1hcmtNaXNzaW5nKCJYX1N1Yl9DYXRlZ29yeV9fYyIpOwogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIlN1Yi1DYXRlZ29yeSIpOwogICAgfQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX0F0dGFjaF9Ub19fYyJdKSkgewogICAgICAgIG1hcmtNaXNzaW5nKCJYX0F0dGFjaF9Ub19fYyIpOwogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoImF0dGFjaGVkVG8iKTsKICAgIH0KCiAgICByZXR1cm4gcmVxQnVmZmVyOwp9CgpmdW5jdGlvbiB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKSB7CiAgICBmb3IgKHZhciBpIGluIHJlcUZpZWxkcykgewogICAgICAgIGlmIChyZXFGaWVsZHMuaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgdmFyIHJlcUZpZWxkID0gcmVxRmllbGRzW2ldOwogICAgICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbcmVxRmllbGQubmFtZV0pKSB7CiAgICAgICAgICAgICAgICBtYXJrTWlzc2luZyhyZXFGaWVsZC5lbGVOYW1lKTsKICAgICAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQocmVxRmllbGQubGFiZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcUJ1ZmZlcjsKfQoKLyoqCiAqIFRoZSB2YWxpZGF0aW9uIGZvciB0aGlzIERvY3VtZW50IFR5cGUgbmVlZHMgdG8gYmUgdW5pcXVlIHNpbmNlIG5vdCBhbGwgZmllbGRzIGFyZSByZXF1aXJlZCwganVzdCBhIGNlcnRhaW4gY29tYmluYXRpb24uCiAqLwpmdW5jdGlvbiB2YWxpZGF0U3BlY2lhbEF1dGhvcml6YXRpb24oZmllbGRzLCByZXFCdWZmZXIpIHsKICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9TcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiXSkgJiYgKGlzQmxhbmsoZmllbGRzWyJYX01lbWJlcl9QbGFuX19jIl0pIHx8IGlzQmxhbmsoZmllbGRzWyJYX0NvdmVyYWdlX0JlbmVmaXRfX2MiXSkpKSB7CiAgICAgICAgbWFya01pc3NpbmcobnVsbCwgIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fY19OYW1lIik7CiAgICAgICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX01lbWJlcl9QbGFuX19jIl0pKSB7CiAgICAgICAgICAgIG1hcmtNaXNzaW5nKG51bGwsICJNZW1iZXJfUGxhbl9fY19OYW1lIik7CiAgICAgICAgfQogICAgICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9Db3ZlcmFnZV9CZW5lZml0X19jIl0pKSB7CiAgICAgICAgICAgIG1hcmtNaXNzaW5nKCJYX0NvdmVyYWdlX0JlbmVmaXRfX2MiKTsKICAgICAgICB9CiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiRWl0aGVyIFNwZWNpYWwgQXV0aG9yaXphdGlvbiBvciBib3RoIE1lbWJlciBQbGFuIGFuZCBDb3ZlcmFnZSBCZW5lZml0Iik7CiAgICB9CiAgICByZXR1cm4gcmVxQnVmZmVyOwp9CgpyZXR1cm4gZG9WYWxpZGF0aW9uKCk7
//--- RULE VALIDATION CODE - END ---

</script>
