<!--
// Name: Index Page
// Committer: cory.newey@zpaper.com
// Update: validations
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2019-11-16 16:04:02","active":true,"button":"Index","name":"Index Page","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Index","operation":"equals"}]},"consequence":{"doit":"YWxlcnQoIkBAQEAgSW5kZXggUnVsZSBGaXJlZCBAQEAjIik7Ci8vRVJTMTkwNzMwICM2MTI3MiB1cGRhdGVkIGJ1dHRvbiB2YWxpZGF0aW9uIGluIHRoZSBBY3Rpb25zKiBEZXRhaWxzIGFyZWEKCnZhciBzdGFja0lkID0gWChkb2MsICJYX3N0YWNrIik7CmlmICghc3RhY2tJZCkgc3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7IC8vRVJTMTkwNjI0IEhBQ0s/CnZhciBzdGFja0ZvbGRlciA9IHN0YWNrSWQgKyAiLVNUQUNLIjsKdmFyIGNvbXBhbnlDb2RlID0gZG9jLmRlbGl2ZXJlZFRvOwp6RGF0YS5zdGFnZT0iSW5kZXhlZCI7IC8vRVJTMTkwNjIwCgovKiBDbGVhciB0aGUgdHJpZ2dlciB0aGF0IGludm9rZWQgdGhpcyBydWxlICovCi8vRVJTMTcwOTA5IHpEYXRhLmNsZWFyVHJpZ2dlckNvbmRpdGlvbihkb2MsIlhfYnV0dG9uQWN0aW9uIik7CnZhciBpbmRleEluaXRpYWxpemVkID0gWChkb2MsIlhfaW5kZXhJbml0aWFsaXplZCIpOwppZiAoIWluZGV4SW5pdGlhbGl6ZWQgfHwgMCA9PT0gaW5kZXhJbml0aWFsaXplZC5sZW5ndGgpIHsKICAgIHN0YWNrSWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOwogICAgc3RhY2tGb2xkZXIgPSBzdGFja0lkICsgIi1TVEFDSyI7CiAgICB6RGF0YS5pbml0aWFsaXplU3RhY2soZG9jLHN0YWNrRm9sZGVyLCBjb21wYW55Q29kZSwgc3RhY2tJZCk7Cn0KCnpEYXRhLmdldERhdGFFbnRyeUZpZWxkcyhkb2MpOwovLyBEb2VzIHRoZSB1c2VyIHdhbnQgdG8gYXR0YWNoIGluZGV4ZWQgcGFnZXMgdG8gQ2FzZT8KLy92YXIgY2FzZUlkID0gWChkb2MsICJYX1pQQVBFUl9fQ2FzZV9fYyIpOwovL3ZhciBjb250YWN0SWQgPSBYKGRvYywgIlhfWlBBUEVSX19QYXRpZW50X19jIik7Ci8vdmFyIHBhdGllbnRJZD1jb250YWN0SWQ7IC8vVE9ETwovL3ZhciBwcm92aWRlcklkID0gWChkb2MsICJYX1pQQVBFUl9fUHJvdmlkZXJfX2MiKTsKLy92YXIgcGF0aWVudEZpcnN0TmFtZSA9IFgoZG9jLCAiWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyIpOwovL3ZhciBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOwovL3ZhciBwYXRpZW50RE9CID0gWChkb2MsICJYX1pQQVBFUl9fQmlydGhkYXRlX19jIik7CgovLyBHZXQgdGhlIGRvY3VtZW50IHR5cGUgKHdpbGwgYmUgdXNlZCB0byByb3V0ZSB0byBuZXh0IGZvbGRlcikKLy92YXIgZG9jVHlwZSA9IFgoZG9jLCAiWF9Eb2N1bWVudF9UeXBlX19jIik7CnZhciBuZXh0Rm9sZGVyID0gIjIwNTAwVHJpYWdlLVMyIjsgICAgICAgICAgICAgIC8vIE90aGVyIGZvbGRlciBpcyB0aGUgZGVmYXVsdAp2YXIgcHJldkluZGV4UGFnZXMgPSBYKGRvYywgIlhfaW5kZXhlZFBhZ2VzIik7CnZhciBjdXJJbmRleFBhZ2VzID0gWChkb2MsICJYX2lkeFBhZ2VzIik7CmlmIChwcmV2SW5kZXhQYWdlcyAmJiBwcmV2SW5kZXhQYWdlcy5sZW5ndGggPiAwICYmIGN1ckluZGV4UGFnZXMgJiYgY3VySW5kZXhQYWdlcy5sZW5ndGggPiAwKSB7CiAgICBwcmV2SW5kZXhQYWdlcyArPSAiLCI7Cn0KY3VySW5kZXhQYWdlcyA9IHByZXZJbmRleFBhZ2VzICsgY3VySW5kZXhQYWdlczsKdmFyIGFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX2luZGV4ZWRQYWdlcyIsIGN1ckluZGV4UGFnZXMpOwovL21vdmUgdG8gYWZ0ZXIgdXBkYXRlcyBhcnJPZlBhaXJzPXpEYXRhLmFkZFN0YWdlKGRvYyxhcnJPZlBhaXJzLCJJbmRleGVkIik7CnVwZGF0ZURCKGRvYyxhcnJPZlBhaXJzKTsKCi8vdmFyIHNmU3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7CnZhciBzZlN0YWNrSWQ9WChkb2MsJ1hfc2ZTdGFja0lkJyk7CmlmKCFzZlN0YWNrSWQpewogIHNmU3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7ICAKfQoKYWxlcnQoIkBAQEBAQCBDdXJyZW50bHkgYXR0YWNoZWQgdG8gWlBBUEVSX196U3RhY2tfX2Mgd2l0aCBJRDogIiArIHNmU3RhY2tJZCk7CnpEYXRhLnpQYXJlbnRJZD1kb2MuZGJJRDsgLy9FUlMxOTA4MTQgdG8gb3ZlcnNpZGUgdGhlIHNhdmUuanNwIHdvcmtmbG93cwoKYWxlcnQoIkBAQEAgUGFyZW50IHpTdGFjayBTbmlwcGV0IGF0dGFjaGVkIHRvOiAiICsgWChkb2MsICJYX2F0dGFjaGVkVG8iKSk7CgovKiBTUExJVCBPRkYgTkVXIFNOSVBQRVQgSEVSRSAqLwp2YXIgcGFnZVJhbmdlID0gWChkb2MsIlhfaWR4UGFnZXMiKTsKdmFyIG5ld0lkPXNwbGl0RG9jdW1lbnRGb3JJbmRleChkb2MsICJpbmRleCIsIHBhZ2VSYW5nZSk7CgphbGVydCgiQEBAQCBBRlRFUiBTUExJVDogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBYKGRvYywgIlhfYXR0YWNoZWRUbyIpKTsKCmFsZXJ0KCJFUlMxOTA2MjQgbmV3SWQ9IituZXdJZCk7Ci8vKgovKiBBRlRFUiBUSElTIFBPSU5ULCBUSEUgRE9DIFdJTEwgSE9MRCBEQVRBIEZPUiBORVcgU05JUFBFVCwgTk9UIFRIRSBTVEFDSyBTTklQUEVUICovCi8vKgoKLyogQXR0YWNoIHRoZSBzcGxpdCBkb2N1bWVudCB0byBhIG5ldyBDYXNlIHJlY29yZCwgaWYgaXQgd2Fzbid0IHBhc3NlZCBpbiAqLwovL3ZhciBwcmlvcml0eT1YKGRvYywiWF9aUEFQRVJfX1ByaW9yaXR5X19jIik7IC8vRVJTMTcwNjI2CnZhciBsYWJlbDA9IiI7CnZhciB0cmlhZ2VUeXBlPWRvYy5kb2NUeXBlOwoKdmFyIGF0dGFjaFBhdGggPSBYKGRvYywiWF9hdHRhY2hlZFRvIik7Ci8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gUGF0aWVudCByZWNvcmQgaWYgcmVxdWlyZWQgKi8gLy9FUlMxOTA2MTkKekRhdGEucGF0aWVudFR5cGU9WEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX1BhdGllbnRSZWNvcmRfX2MiKTsgLy9FUlMxOTA4MDYgWlBBUEVSX18gbm93IGluIE1QCmFsZXJ0KCJAQEBAIHpEYXRhLnBhdGllbnRUeXBlICoqKioqICIrekRhdGEucGF0aWVudFR5cGUrIiBQYXRpZW50Iik7CmlmICghekRhdGEucGF0aWVudFR5cGUpIHpEYXRhLnBhdGllbnRUeXBlPSJDb250YWN0IjsgLy9FUlMxOTA4MDIgIzYxMjcyCi8vaWYgKFgoZG9jLCJYX1pQQVBFUl9fUGF0aWVudF9fYyIpIHx8IHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYykgeyAvL0VSUzE5MDgwMyBUT0RPIHJldGhpbmsgdXNlIFgKICAgIHZhciBkcSA9IHpEYXRhLmRxID0gU3RyaW5nLmZyb21DaGFyQ29kZSgzNCk7IC8vRVJTMTkwODAyIFRPRE8gZGVmaW5lIGJldHRlciBpbiB6RGF0YQogICAgaWYgKCF6RGF0YS5wYXRpZW50SWQpIHsKICAgICAgICBhbGVydCgiQEBAQCBjcmVhdGluZyBuZXcgIit6RGF0YS5wYXRpZW50VHlwZSsiIFBhdGllbnQiKTsKICAgICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgICAgLy9FUlMxOTA3MzAgIzYxMjcyIG1pc3NpbmcgdGhlIGJhc2ljcwogICAgICAgIHZhciBwPSIiOwogICAgICAgIGlmICgiQWNjb3VudCI9PT16RGF0YS5wYXRpZW50VHlwZSkgeyAvL0VSUzE5MDgwMwogICAgICAgICAgICBwPSJQZXJzb24iOwogICAgICAgICAgICAvL2Fyck9mUGFpcnMucHVzaCgiTmFtZSIsIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MrIiAiK3pEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiRmlyc3ROYW1lIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiTGFzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogICAgICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgewogICAgICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKHArIkJpcnRoZGF0ZSIsIHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJGaXJzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKTsgLy9YX1pQQVBFUl9fRmlyc3ROYW1lX19jIC8vRVJTMTkwODAzIFRPRE8gZ2V0IGNsZWFuZXIgIzYxMjcyCiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiTGFzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogICAgICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgewogICAgICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJCaXJ0aGRhdGUiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXR0YWNoTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICAgICAgekRhdGEucGF0aWVudElkPXpEYXRhLmNsaWVudFBhdGllbnQoZG9jLGFyck9mUGFpcnMsIGF0dGFjaExhYmVsKTsKICAgICAgICBhbGVydCgiQ3JlYXRlZCBQYXRpZW50IHdpdGggSUQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgIGlmICh6RGF0YS5wYXRpZW50SWQgPT0gIm51bGwiIHx8IHpEYXRhLnBhdGllbnRJZCA9PSAiTkVXIikgekRhdGEucGF0aWVudElkPW51bGw7CiAgICAgICAgZWxzZSB7IC8vRVJTMTkwNzMwICM2MTI3MiBsZXZlcmFnZSB0aGUgbmV3IHJlY29yZAogICAgICAgICAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnBhdGllbnRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucGF0aWVudElkOwogICAgICAgICAgICBhbGVydCgiQEBAQEBAQCBORVcgUEFUSUVOVCBDUkVBVEVEIFdJVEggSUQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgwMiB6RGF0YS5jb250YWN0SWQKICAgICAgICAgICAgLy8gY2xlYXIgb3V0IHRoZSAiTmV3IFBhdGllbnQiIGZpZWxkcwogICAgICAgICAgICBpZiAoMT09PTEpIHsgLy9FUlMxOTA4MTEgIzYxNTcwIGNvbW1lbnRlZCBvdXQgc28gdGhhdCBwYXRpZW50IGluZm8gaXMgYXZhaWxhYmxlIGZvciBERSB2YXJpYWJsZXMgaW4gemlwcGkKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fRmlyc3ROYW1lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0xhc3ROYW1lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0JpcnRoZGF0ZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QaG9uZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOyAgICAgICAgICAgIAogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19CaXJ0aGRhdGVfX2NfcmVhZGFibGUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIk5PTkUiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gc2V0IHRoZSBQYXRpZW50IGxvb2t1cCBmaWVsZHMKICAgICAgICAgICAgLy9FUlMxOTA4MDMgVE9ETyBoYW5kbGUgWlBBUEVSX18gcmVsYXRpb25zaGlwcyAvL0VSUzE5MDgxMSBkb3VibGUgdXAgZm9yIHNhZmV0eQogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50X19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLnBhdGllbnRJZCArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArICIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5wYXRpZW50SWQgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsgIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgZHEgKyAiKTsgIik7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICAvL2lmICh6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyAmJiAoIkNPTlMiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgICAgICAvLyAgIHx8ICJFTlJMIiA9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fAogICAgICAgICAvLyAgIk1FRE8iID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykpIHsgLy9FUlMxOTEwOSAjNjQ5MjEgVE9ETyBtYW55IGpvdXJuZXkgYmVzdCBwcm9jdGljZQogICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIGlmICh6RGF0YS5wYXRpZW50VHlwZSAhPSAiQWNjb3VudCIpIHsgLy9FUlMxOTA3MzAgbG9va3VwIHRoZSBkYXRhIFRPRE8gcGVyc29uIGFjY291bnQ/CiAgICAgICAgICAgICAgICB2YXIgY29udGFjdEZsZHMgPSBnZXRTRkZpZWxkcyhkb2MsIHpEYXRhLnBhdGllbnRUeXBlLCAiRmlyc3ROYW1lLExhc3ROYW1lLEJpcnRoZGF0ZSIsIG51bGwsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgY29udGFjdEZsZHM6ICIgKyBjb250YWN0Rmxkcyk7CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jID0gcGF0aWVudEZpcnN0TmFtZSA9IFgoZG9jLCAiRmlyc3ROYW1lIiwgY29udGFjdEZsZHMpOyAvL1BWMTkxMDA2IHVwZGF0ZSB0aGUgY2hpbGQgc3RhY2sKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyA9IHBhdGllbnRMYXN0TmFtZSA9IFgoZG9jLCAiTGFzdE5hbWUiLCBjb250YWN0Rmxkcyk7CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jPXBhdGllbnRET0IgPSBYKGRvYywgIkJpcnRoZGF0ZSIsIGNvbnRhY3RGbGRzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh6RGF0YS5wYXRpZW50VHlwZSA9PT0gIkFjY291bnQiKSB7IC8vRVJTMTkwNzMwIGxvb2t1cCB0aGUgZGF0YSBUT0RPIHBlcnNvbiBhY2NvdW50PwogICAgICAgICAgICAgICAgdmFyIGNvbnRhY3RGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCB6RGF0YS5wYXRpZW50VHlwZSwgIk5hbWUiLCBudWxsLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICAgICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIEFjY291bnRGbGRzOiAiICsgY29udGFjdEZsZHMpOwogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyA9IHBhdGllbnRGaXJzdE5hbWUgPSBYKGRvYywgIk5hbWUiLCBjb250YWN0Rmxkcykuc3BsaXQoIiAiKVswXTsgLy9FUlMxOTA4MDMgVE9ETyBmaW5kIGEgYmV0dGVyIHdheQogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jID0gcGF0aWVudExhc3ROYW1lID0gWChkb2MsICJOYW1lIiwgY29udGFjdEZsZHMpLnNwbGl0KCIgIilbMV07CiAgICAgICAgICAgICAgICAvL3pEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2M9cGF0aWVudERPQiA9IFgoZG9jLCAiUGVyc29uQmlydGhkYXRlIiwgY29udGFjdEZsZHMpOwoKICAgICAgICAgICAgfQogICAgICAgICAgICAvL1BWMTkxMDA4IHVwZGF0ZWQgYXR0YWNoTGFiZWwgb24gY2hpbGQgc3RhY2sKICAgICAgICAgICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgICAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgIC8vIH0KICAgIH0KICAgIGlmICh6RGF0YS5wYXRpZW50SWQgJiYgYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnBhdGllbnRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucGF0aWVudElkOwovL30KYWxlcnQoIkBAQEAgQUZURVIgUEFUSUVOVDogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBhdHRhY2hQYXRoKTsKCnZhciBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOyAvLyJJbmRleGVkICIgKyBmb3JtYXROb3c7CmFsZXJ0KCJFUlMxOTA2MjQgYXR0YWNoTGFiZWw9IithdHRhY2hMYWJlbCk7CgoKLyogQXR0YWNoIHRoZSBzcGxpdCBkb2N1bWVudCB0byBMZWFkIHJlY29yZCBpZiByZXF1aXJlZCAqLyAvL0VSUzE5MDYxOQovLyBUT0RPIEVSUzE5MDYyNCBmbGlwIHRoZSBpZiBsb2dpYwppZiAoZG9jLndkZGF0YS5pbmRleE9mKCJYX1pQQVBFUl9fUmVmZXJyYWxMZWFkX19jIik+LTEpIHsgLy9FUlMxOTA4MDMgVE9ETyByZXRoaW5rCiAgICBpZiAoIWxlYWRJZCB8fCAwID09PSBsZWFkSWQubGVuZ3RoKSB7CiAgICAgICAgYWxlcnQoIkBAQEAgY3JlYXRpbmcgbmV3IExlYWQiKTsKICAgICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgICAgbGVhZElkPXpEYXRhLmNsaWVudExlYWQoZG9jLGFyck9mUGFpcnMpOwogICAgICAgIGFsZXJ0KCJDcmVhdGVkIExlYWQgd2l0aCBJRDogIiArIGxlYWRJZCk7CiAgICAgICAgaWYgKGxlYWRJZCA9PSAibnVsbCIgfHwgbGVhZElkID09ICJORVciKSBsZWFkSWQ9bnVsbDsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHpEYXRhLmF0dGFjaFJlY29yZHMuaW5kZXhPZigiTGVhZCIpPi0xKSB7CiAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBMZWFkOiAiICsgbGVhZElkKTsKICAgICAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIGxlYWRJZCk7CiAgICAgICAgfQogICAgfQogICAgaWYgKGxlYWRJZCAmJiBhdHRhY2hQYXRoLmluZGV4T2YobGVhZElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIitsZWFkSWQ7Cn0KYWxlcnQoIkBAQEAgQUZURVIgTEVBRDogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBYKGRvYywgIlhfYXR0YWNoZWRUbyIpKTsKCgovL0VSUzE5MDYyMCB1c2UgYSBzZXR0aW5nIHRvIGRldGVybWluZSB3aGljaCBsb29rdXBzIHdlIGF0dGFjaCB0bwovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIENhc2UgcmVjb3JkIGlmIHJlcXVpcmVkICovIC8vRVJTMTkwNjE5Ci8vaWYgKGRvYy53ZGRhdGEuaW5kZXhPZigiWF9aUEFQRVJfX0Nhc2VfX2MiKT4tMSkgewogIGlmKDE9PT0xKXsgIAogICAgYWxlcnQoIkVSUzE5MDYyNCBuZWVkIENhc2UiKTsKICAgIGlmICh6RGF0YS5jYXNlSWQpIHsgICAgICAgIAogICAgICAgIGlmICh6RGF0YS5hdHRhY2hSZWNvcmRzLmluZGV4T2YoIkNhc2UiKT4tMSkgewogICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgQ2FzZTogIiArIHpEYXRhLmNhc2VJZCk7CiAgICAgICAgICAgIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7CiAgICAgICAgICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5jYXNlSWQpOwogICAgICAgIH0KICAgIH0KICAgIGFsZXJ0KCJFUlMxOTA2MjQuNzggaGF2ZSBhIGNhc2U/Iik7CiAgICBpZiAoekRhdGEuY2FzZUlkICYmIGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5jYXNlSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmNhc2VJZDsKfQoKYWxlcnQoIkBAQEAgQUZURVIgQ0FTRTogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBYKGRvYywgIlhfYXR0YWNoZWRUbyIpKTsKCgovL1BWMTkxMDIyIGNyZWF0ZSBwcmVzY3JpcHRpb24KdmFyIHN0YWNrRmxkcyA9IGdldFNGRmllbGRzKGRvYywgIlpQQVBFUl9felN0YWNrX19jIiwgIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgbnVsbCwgc2ZTdGFja0lkKTsKekRhdGEuWF9aUEFQRVJfX2xhdGVzdEZheF9fYyA9ICBYKGRvYywgIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgc3RhY2tGbGRzKTsgLy9QVjE5MDkyNiB1cGRhdGUgdGhlIGNoaWxkIHN0YWNrCmlmKCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyl7CiAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgUHJlc2NyaXB0aW9uOiAiICsgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7Cn0KCmlmKCAhekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgJiYgekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgJiYiUlgiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyApeyAvL0VSUzE5MTEwOSAjNjQ5MjEgVE9ETyBtYW55IGpvdXJuZXlzCiAgICBhbGVydCgiQEBAQCBDcmVhdGluZyAgUHJlc2NyaXB0aW9uX19jIHdpdGggZmF4IFR5cGUgOiAiICsgekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpOwogICAgYXJyT2ZQYWlycyA9IFtdOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0RhdGVfb2ZfUHJlc2NyaXB0aW9uX1JlY2VpdmVkX19jIix6RGF0YS5YX1pQQVBFUl9fbGF0ZXN0RmF4X19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9Qcm9kdWN0UHJlc2NyaWJlZF9fYyIsekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgielBhcGVyX3JlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7CiAgICAvL2Fyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIix6RGF0YS5wYXRpZW50SWQpOwogICAgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ29yZV9QcmVzY3JpcHRpb25fX2MiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICBhbGVydCgiQEBAQCBDcmVhdGUgUHJlc2NyaXB0aW9uX19jIHdpdGggSUQ6ICIgKyB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7CiAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgLy9hdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwogICAgekRhdGEuUHJlc2NyaXB0aW9uTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiQ29yZV9QcmVzY3JpcHRpb25fX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsgLy9QVjE5MTAyMiAvL0VSUzE5MTEwOSBjbGllbnRJbmRleD8KICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQcmVzY3JpcHRpb25fX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgKyBkcSArICIpOyAiKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQcmVzY3JpcHRpb25fX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5QcmVzY3JpcHRpb25OYW1lICsgZHEgKyAiKTsgIik7CiAgICAgCn0KCi8vQ09NRFIKLy9pZiggIXpEYXRhLmNhc2VJZCAmJiAoIkNPTURSIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKLy8gICAgIHx8ICJNRURDIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiTEFCIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwovLyAgICAgfHwgIklOSlIiPT09ekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpKXsKLy9DUk4xOTExMTQgQWNjb3JkaW5nIHRvIHRoZSBBYmJ2aWUgc3RvcmllcywgYWxsIGRvY1R5cGVzIGV4Y2VwdCAiQ29uc2VudCBGb3JtcyIgbmVlZCB0byBoYXZlIGEgQ2FzZSBjcmVhdGVkIGlmIG9uZSBpc24ndCBhbHJlYWR5IHNlbGVjdGVkCmlmKCF6RGF0YS5jYXNlSWQgJiYgIkNPTlMiICE9PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyl7CiAgICBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goIlJlY29yZFR5cGVJZCIsIjAxMjFpMDAwMDAwaFFvN0FBRSIpOyAgICAgICAgICAgICAgIC8vIENSTjE5MTExNCBBbHdheXMgdXNlIENhcmVQbGFuIFJlY29yZCBUeXBlPwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0JyYW5kX19jIix6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpOwogICAgaWYoekRhdGEucHJvZ3JhbU5hbWUgPT09ICJBYmJ2aWUgT25lQ1JNIC0gQ2FuYWRhIil7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NvdW50cnlDb2RlX19jIiwiQ0EiKTsKICAgIH0gICAgCiAgIAogICAgekRhdGEuY2FzZUlkID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNhc2UiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB6RGF0YS5jYXNlTnVtYmVyID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkNhc2VOdW1iZXIiLCBudWxsLCB6RGF0YS5jYXNlSWQpOyAvL1BWMTkxMDIyCiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19DYXNlX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLmNhc2VJZCArIGRxICsgIik7ICIpOwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fY19DYXNlTnVtYmVyIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLmNhc2VOdW1iZXIgKyBkcSArICIpOyAiKTsgLy9QVjE5MDkyOSB1cGRhdGVkIGNhc2UgbnVtYmVyIGluIGxvb2t1cAogICAgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyA9IFgoZG9jLCAiWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIpOwoKLyoKQ1JOMTkxMTEzIE1vdmVkIGJlbG93IHdoZXJlIHRoZSBkb2NUeXBlIGxvZ2ljIGlzbid0IHNvIGNvbnZvbHV0ZWQgICAgCiAgICBpZigiTEFCIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiSU5KUiI9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgICAgfHwgIk1FREMiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyl7CiAgICAgIGFyck9mUGFpcnMgPSBbXTsKICAgICAgaWYoIkxhYiBUZXN0cyI9PT16RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jKXsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyNUUwMDAwMDBLMjRHUUFTIik7CiAgICAgIH0KICAgICAgaWYoImluamVjdGlvbiBUcmFpbmluZyI9PT16RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jKXsKICAgICAgICAgCiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjVFMDAwMDAwSzI0TFFBUyIpOwogICAgICB9CgogICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJTZXJ2aWNlX1JlcXVlc3RlZF9kYXRlX19jIix6RGF0YS5YX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MpOwogICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIix6RGF0YS5wYXRpZW50SWQpOwogICAgIGlmKCF6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKXsKICAgICAgICB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgICB9CiAgICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwogICAgIHpEYXRhLkNsaW5pY2FsTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIiwgIk5hbWUiLCBudWxsLCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsgLy9QVjE5MTAyMgogICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNDbGluaWNhbF9TZXJ2aWNlc19fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jICsgZHEgKyAiKTsgIik7CiAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuQ2xpbmljYWxOYW1lICsgZHEgKyAiKTsgIik7CiAgICB9CiAgICAqLwp9CgoKCi8vT1RICmlmKCAhekRhdGEuY2FzZUlkICYmICgiT1RIIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIkVOUkwiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgfHwgIk1FRE8iID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiUlgiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyApKXsKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyMWkwMDAwMDBoUW83QUFFIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQnJhbmRfX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CiAgICBpZih6RGF0YS5wcm9ncmFtTmFtZSA9PT0gIkFiYnZpZSBPbmVDUk0gLSBDYW5hZGEiKXsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQ291bnRyeUNvZGVfX2MiLCJDQSIpOwogICAgfSAgICAKICAgCiAgICB6RGF0YS5jYXNlSWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ2FzZSIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIHpEYXRhLmNhc2VOdW1iZXIgPSBnZXRTRkZpZWxkKGRvYywgIkNhc2UiLCAiQ2FzZU51bWJlciIsIG51bGwsIHpEYXRhLmNhc2VJZCk7IC8vUFYxOTEwMjIKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0Nhc2VfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZUlkICsgZHEgKyAiKTsgIik7CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19DYXNlX19jX0Nhc2VOdW1iZXIiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZU51bWJlciArIGRxICsgIik7ICIpOyAvL1BWMTkwOTI5IHVwZGF0ZWQgY2FzZSBudW1iZXIgaW4gbG9va3VwCn0KCmlmKCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpewogICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIE91dGNvbWU6ICIgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwp9CgoKCmFyck9mUGFpcnMgPSBbXTsKaWYgKHpEYXRhLmRvY1R5cGUpIHsgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLCB6RGF0YS5kb2NUeXBlKTsgIH0gLy9FUlMxOTA4MTAgUFYxOTA4MDggIzUxNjcwCmlmICh6RGF0YS5wcm92aWRlcklkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJvdmlkZXJfX2MiLCB6RGF0YS5wcm92aWRlcklkKTsKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucHJvdmlkZXJJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucHJvdmlkZXJJZDsKfQphbGVydCgiRVJTMTkwODEyLjIwMCB6RGF0YS5wYXRpZW50SWQ9Iit6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgxMiAjNjE1MTEKaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMDMiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIGlmICh6RGF0YS5wYXRpZW50SWQuaW5kZXhPZigiMDAxIik9PT0wKSBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMFEiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgwMiBMZWFkCiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnBhdGllbnRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucGF0aWVudElkOwogICAgaWYgKDE9PT0xKSB7IC8vRVJTMTkwODEwIFBWMTkwODA4IGRhdGEgZW50cnkgZm9yIG5leHQgc3BsaXQKICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYykgeyBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fRmlyc3ROYW1lX19jIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7IH0KICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19MYXN0TmFtZV9fYyIsIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7IH0gIAogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19CaXJ0aGRhdGVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fU3RhdHVzX19jKSB7YXJyT2ZQYWlycy5wdXNoKHpwKyJTdGF0dXNfX2MiLCAiQ29tcGxldGVkIik7IH0gLy9QVjE5MTAyMyB1cGRhdGVpbmcgc3RhdHVzCiAgICB9Cn0KaWYgKHpEYXRhLmNhc2VJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0Nhc2VfX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5jYXNlSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmNhc2VJZDsKfQogYWxlcnQoIkBAQEAgekRhdGEuY29udGFjdElkID0gIiArIHpEYXRhLmNvbnRhY3RJZCk7CmlmICh6RGF0YS5jb250YWN0SWQgJiYgekRhdGEuY29udGFjdElkLnN0YXJ0c1dpdGgoIjAwMyIpKSB7CiAgIAogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhdGllbnRfX2MiLCB6RGF0YS5jb250YWN0SWQpOwp9CmlmICh6RGF0YS5sZWFkSWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiLCB6RGF0YS5sZWFkSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5sZWFkSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmxlYWRJZDsKfQppZiAoekRhdGEucmVmZXJyYWxJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1JlZmVycmFsX19jIiwgekRhdGEucmVmZXJyYWxJZCk7CiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnJlZmVycmFsSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLnJlZmVycmFsSWQ7Cn0KaWYgKHpEYXRhLlhfWlBBUEVSX19QaG9uZV9fYykgeyAvL1BWMTkxMDA2IFVQREFURUQgRk9SIFBIT05FCiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGhvbmVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fUGhvbmVfX2MpOwogICAKfQp2YXIgc3BlY2lhbEF1dGhJZCA9IFgoZG9jLCAiWF9TcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiKTsKYWxlcnQoIkBAQCB6RGF0YS5YX1NwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyAiICsgc3BlY2lhbEF1dGhJZCk7CnZhciBhdXRoRG9jVHlwZSA9IFgoZG9jLCAiWlBBUEVSX19mYXhUeXBlX19jIik7CmlmIChzcGVjaWFsQXV0aElkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIsIHNwZWNpYWxBdXRoSWQpOwogICAgLy9QVjE5MTExMyBJZiB3ZSBoYXZlIGEgU3BlY2lhbCBBdXRob3JpemF0aW9uLCBhdHRhY2ggdGhpcyBkb2N1bWVudCB0byBpdAogICAgdmFyIHNwZWNpYWxMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGF0dGFjaChkb2MsIHNwZWNpYWxMYWJlbCwgc3BlY2lhbEF1dGhJZCk7Cn0KZWxzZSBpZiAoIlNBIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpIHsgCiAgICB2YXIgYXV0aEFyck9mUGFpcnMgPSBbXTsKICAgIHZhciBhdXRoTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICBhdXRoQXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLCB6RGF0YS5kb2NUeXBlLCAiTWVtYmVyX1BsYW5fX2MiLCB6RGF0YS5YX01lbWJlcl9QbGFuX19jICwgIkNsaW5pY2FsX1NlcnZpY2VzX19jIiwgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyApOyAKICAgIHZhciBhdXRoSWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCAiQ2FyZVByZWF1dGgiLCBhdXRoTGFiZWwsIGF1dGhBcnJPZlBhaXJzKTsKICAgIGlmICghYXV0aElkLmNvbnRhaW5zKCJFUlJPUiIpKSB7CiAgICAgICAgdmFyIGF1dGhOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDYXJlUHJlYXV0aCIsICJOYW1lIiwgbnVsbCwgYXV0aElkKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIsIFNwZWNpYWxfQXV0aG9yaXphdGlvbl9fY19OYW1lKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjU3BlY2lhbF9BdXRob3JpemF0aW9uX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIGF1dGhJZCArIGRxICsgIik7ICIpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNTcGVjaWFsX0F1dGhvcml6YXRpb25fX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBhdXRoTmFtZSArIGRxICsgIik7ICIpOwogICAgfQp9CgovL0NSTjE5MTExNCBIYW5kbGUgYW55IHBhc3NlZC1pbiBwaHlzaWNpYW4gKFNob3VsZCB0aGlzIGJlIG9ubHkgZm9yIENPTURSOiBDb21tdW5pY2F0aW9uIGZyb20gUGh5c2ljaWFuPykKYWxlcnQoIkBAQEAgekRhdGEuWF9QaHlzaWNpYW5fX2MgPSAiICsgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwphbGVydCgiQEBAQCBYX1BoeXNpY2lhbl9fYyA9ICIgKyBYKGRvYywgIlhfUGh5c2ljaWFuX19jIikpOwppZiAoWChkb2MsICJYX1BoeXNpY2lhbl9fYyIpKSB7CiAgICB6RGF0YS5YX1BoeXNpY2lhbl9fYyA9IFgoZG9jLCAiWF9QaHlzaWNpYW5fX2MiKTsKICAgIGFsZXJ0KCJAQEBAIHpEYXRhLlhfUGh5c2ljaWFuX19jIG5vdyA9ICIgKyB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7CiAgICBhcnJPZlBhaXJzLnB1c2goIlBoeXNpY2lhbl9fYyIsIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKICAgIHZhciBwaHlzaWNpYW5MYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGFsZXJ0KCJAQEAgQXR0YWNoaW5nIHRvIFBoeXNpY2lhbl9fYyB3aXRoIElkOiAiICsgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwogICAgYXR0YWNoKGRvYywgcGh5c2ljaWFuTGFiZWwsIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKfQoKLy9QVjE5MTAwOCB1cGRhdGVkIG5ldyBmaWVsZHMKaWYoekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKSBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CmlmKCB6RGF0YS5YX1pQQVBFUl9fUHJpb3JpdHlfX2MpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcmlvcml0eV9fYyIsekRhdGEuWF9aUEFQRVJfX1ByaW9yaXR5X19jKTsKaWYoIHpEYXRhLlhfU3ViX0NhdGVnb3J5X19jICkgIGFyck9mUGFpcnMucHVzaCgiU3ViX0NhdGVnb3J5X19jIix6RGF0YS5YX1N1Yl9DYXRlZ29yeV9fYyk7CmlmKCB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIix6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyk7CmlmKCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyApICBhcnJPZlBhaXJzLnB1c2goIlByZXNjcmlwdGlvbl9fYyIsekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwppZiggekRhdGEuWF9NZW1iZXJfUGxhbl9fYyApICBhcnJPZlBhaXJzLnB1c2goIk1lbWJlcl9QbGFuX19jIix6RGF0YS5YX01lbWJlcl9QbGFuX19jKTsKaWYoIHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyApICBhcnJPZlBhaXJzLnB1c2goIkNvdmVyYWdlX0JlbmVmaXRfX2MiLHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyk7CmlmKCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jICkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19fYyIsekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7CiAgICAvL1BWMTkxMTEzIElmIHdlIGhhdmUgYSBTcGVjaWFsIEF1dGhvcml6YXRpb24sIGF0dGFjaCB0aGlzIGRvY3VtZW50IHRvIGl0CiAgICB2YXIgY2xpbmljYWxMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGF0dGFjaChkb2MsIGNsaW5pY2FsTGFiZWwsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwp9CmVsc2UgaWYgKCgiTEFCIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiSU5KUiI9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgICAgfHwgIk1FREMiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgJiYgWChkb2MsICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiKSkgeyAgICAgICAgLy9DUk4xOTExMTMgQ3JlYXRlIG5ldyBDbGluaWNhbCBTZXJ2aWNlcyByZWNvcmQgaWYgRG9jVHlwZSBpcyBNRURDIGFuZCB0aGUgU2VydmljZSBSZXF1ZXN0ZWQgRGF0ZSBpcyBmaWxsZWQgaW4KICAgIHZhciBjbGluaWNhbFN2Y0Fyck9mUGFpcnMgPSBbXTsKICAgIHZhciBjbGluaWNhbFN2Y0xhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7IAogICAgaWYoIkxhYiBUZXN0cyI9PT16RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jKXsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyNUUwMDAwMDBLMjRHUUFTIik7CiAgICB9CiAgICBpZigiSW5qZWN0aW9uIFRyYWluaW5nIj09PXpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MpewogICAgICAgIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjVFMDAwMDAwSzI0TFFBUyIpOwogICAgfQogICAgdmFyIGNsaW5pY2FsU3ZjSWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCAiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIiwgY2xpbmljYWxTdmNMYWJlbCwgY2xpbmljYWxTdmNBcnJPZlBhaXJzKTsKICAgIGlmICghY2xpbmljYWxTdmNJZC5jb250YWlucygiRVJST1IiKSkgewogICAgICAgIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MgPSBjbGluaWNhbFN2Y0lkOwogICAgICAgIHpEYXRhLkNsaW5pY2FsTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIiwgIk5hbWUiLCBudWxsLCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsgLy9QVjE5MTAyMgogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNDbGluaWNhbF9TZXJ2aWNlc19fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuQ2xpbmljYWxOYW1lICsgZHEgKyAiKTsgIik7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19fYyIsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwogICAgfQp9CmlmKCB6RGF0YS5YX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJTZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIix6RGF0YS5YX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MpOwppZiggekRhdGEuWF9SZXBvcnRlZF9PdXRjb21lX19jICkgIGFyck9mUGFpcnMucHVzaCgiUmVwb3J0ZWRfT3V0Y29tZV9fYyIsekRhdGEuWF9SZXBvcnRlZF9PdXRjb21lX19jKTsKaWYoIHpEYXRhLlhfQXNzZXNzbWVudF9UeXBlX19jICkgIGFyck9mUGFpcnMucHVzaCgiQXNzZXNzbWVudF9UeXBlX19jIix6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYyk7CmlmKCB6RGF0YS5YX091dGNvbWVfVHlwZV9fYyApICBhcnJPZlBhaXJzLnB1c2goIk91dGNvbWVfVHlwZV9fYyIsekRhdGEuWF9PdXRjb21lX1R5cGVfX2MpOwppZih6RGF0YS5YX1Byb2R1Y3RfRGVzY3JpYmVkX19jKSBhcnJPZlBhaXJzLnB1c2goIlByb2R1Y3RfRGVzY3JpYmVkX19jIix6RGF0YS5YX1Byb2R1Y3RfRGVzY3JpYmVkX19jKTsKaWYoekRhdGEuWF9aUEFQRVJfX2xhdGVzdEZheF9fYykgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2xhdGVzdEZheF9fYyIsekRhdGEuWF9aUEFQRVJfX2xhdGVzdEZheF9fYyk7Ci8vRVJTMTkwODE0IGp1c3QgdGhlIGNoaWxkICM2MTUxMSB1cGRhdGVTRlJlY29yZChkb2MsIHpEYXRhLnpwcywgc2ZTdGFja0lkLCBhcnJPZlBhaXJzKTsKLy9sZXQgdGhlIGRvY1NldCBkbyB0aGUgd29yayBhdHRhY2goZG9jLGF0dGFjaExhYmVsLCBzZlN0YWNrSWQpOwovL3ZhciByPXVwZGF0ZVNGUmVjb3JkKGRvYywiWlBBUEVSX196U3RhY2tfX2MiLHNmU3RhY2tJZCxbIlpQQVBFUl9fcmVjZWl2ZWRJZF9fYyIsekRhdGEuelBhcmVudElkXSk7IC8vRVJTMTkwODE0ICM2MTUxMSBvdmVycmlkZSB0aGUgc2F2ZS5qc3Agd29ya2Zsb3dzCmFsZXJ0KCJAQEBAIHVwZGF0ZWQgYW5kIGF0dGFjaGVkIHRvIHpTdGFjayBSZWNvcmQsIGlkID0gIiArIHNmU3RhY2tJZCArICI/PSIrekRhdGEuZ2V0U3RhY2tJZChkb2MpKyIgZGF0YT0iK2Fyck9mUGFpcnMpOwoKdmFyIGNoaWxkU3RhY2tJZD16RGF0YS5jbGllbnRDaGlsZFN0YWNrKGRvYyxhcnJPZlBhaXJzLHNmU3RhY2tJZCk7IC8vRVJTMTkwODEwIGNyZWF0ZSBjaGlsZCBzdGFjayBmb3Igc3BsaXQgRVJTMTkwODExIGNsaWVudENoaWxkU3RhY2sKaWYgKGNoaWxkU3RhY2tJZCkge2F0dGFjaFBhdGgrPSIsIitzZlN0YWNrSWQrIiwiK2NoaWxkU3RhY2tJZDsgYXR0YWNoUGF0aD1hdHRhY2hQYXRoLnJlcGxhY2UoIi8sPyIsIi8iKTsgfSAvL0VSUzE5MDgxMSAjNjE1NzAgY2xlYW4gdXAgLy9wYXJlbnQgc3RhY2sgdG9vCmFyck9mUGFpcnM9W107Ly9QVjE5MTAyMyBFdmVyeXRpbWUgY2hpbGQgd2lsbCBhdHRhY2ggdG8gdGhhdCBwYXJ0aWN1bGFyIHpTdGFjawphcnJPZlBhaXJzLnB1c2goIlhfc2ZTdGFja0lkIixjaGlsZFN0YWNrSWQpOwp1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7Ci8qIE1vdmUgdGhlIHNwbGl0IGRvY3VtZW50IHRvIGl0cyBwcm9jZXNzaW5nIGZvbGRlciAqLwphbGVydCgiQEBAQEBAIE1vdmluZyB0aGUgaW5kZXhlZCBwYWdlcyBkb2N1bWVudCBpbnRvIG5leHQgcHJvY2Vzc2luZyBmb2xkZXI6ICIgKyBuZXh0Rm9sZGVyKTsKLy9FUlMxOTA3MzEgIzYxMjcyIG1vdmVEb2N1bWVudChkb2MsIiIsbmV4dEZvbGRlcik7Ci8vRVJTMTkwNzMxICM2MTI3MiByZWxvYWRCeUJBVEVTKGRvYywgbmV4dEZvbGRlcik7IC8vRVJTMTcwNDEzICMzNTI5MQovKiBQbGFjZSB0aGUgc3BsaXQgZG9jdW1lbnQgaW50byB0aGUgc3RhY2sgZm9sZGVyICovCmFsZXJ0KCJAQEBAQEAgTW92aW5nIHRoZSBpbmRleGVkIHBhZ2VzIGRvY3VtZW50IGludG8gdGhlIGZpbmFsIHN0YWNrIGZvbGRlcjogIiArIHN0YWNrRm9sZGVyKTsKbW92ZURvY3VtZW50KGRvYywiIixzdGFja0ZvbGRlcik7CnVubG9ja0RvY3VtZW50KGRvYyk7CmFyck9mUGFpcnMgPSB6RGF0YS5hZGRTdGFnZShkb2MsYXJyT2ZQYWlycyx6RGF0YS5zdGFnZSk7CnZhciBwYWdlQ291bnQgPSB6RGF0YS5jb3VudFBhZ2VzKGRvYyxwYWdlUmFuZ2UpOwphbGVydCgiQEBAQCBwYWdlQ291bnQgPSAiICsgcGFnZUNvdW50ICsiIHdlcmUgIisgekRhdGEuc3RhZ2UpOwphcnJPZlBhaXJzLnB1c2goIlhfcGFnZXMiLHBhZ2VDb3VudCk7CmFyck9mUGFpcnMucHVzaCgiWF9jb3VudCIscGFnZUNvdW50KTsgLy9QVjE5MTAyOCB1cGRhdGVkIGZvciBzdGFjayBjb21wbGV0ZSB0byB1c2UgZXhhY3QgcGFnZXMKYXJyT2ZQYWlycy5wdXNoKCJkYi1wYWdlcyIscGFnZUNvdW50KTsKLy9FUlMxOTA2MjAgYXJyT2ZQYWlycy5wdXNoKCJkYi1sYWJlbCIsIHBhdGllbnRGaXJzdE5hbWUgKyBwYXRpZW50TGFzdE5hbWUgKyAiIC0gIiArIGNvbXBhbnlDb2RlICsgIiAtICIgKyBzdGFja0lkKTsKLy9hcnJPZlBhaXJzLnB1c2goIlhfYXR0YWNoZWRUbyIsYXR0YWNoUGF0aCk7IC8vQ1JOMTkxMDI4IFdlIGRvbid0IG5lZWQgdG8gdXBkYXRlIHRoZSBYX2F0dGFjaGVkVG8gYmVjYXVzZSBpdCBpcyBiZWluZyBzZXQgY29ycmVjdGx5IGR1cmluZyBlYWNoIGF0dGFjaC4gQmVzaWRlcywgYXR0YWNoUGF0aCBob2xkcyB0aGUgcGFyZW50J3MgbWFzc2FnZWQgWF9hdHRhY2hlZFRvIHdoaWNoIHdlIGRvbid0IHdhbnQuIC8vRVJTMTcwNjI4CnVwZGF0ZURCKGRvYyxhcnJPZlBhaXJzKTsKCi8vUFYxOTEwMjkgQWRkICJJbmRleGVkIiB0byB0aGUgIlJlY2VpdmVkIiBYX3Jldmlld3MgYWRkZWQgaW4gY2xpZW50IGxpYnJhcnkgYWJvdmUuCnZhciBvcmlnWFJldmlld3MgPSBYKGRvYywgIlhfcmV2aWV3cyIpOwp2YXIgbm93MCA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7Ly9QdjE5MTAyOSBjaGVjayBkb2NzZXQgY2hlY2tib3gKYXJyT2ZQYWlycyA9IFtdOwphcnJPZlBhaXJzLnB1c2goIlhfcmV2aWV3cyIsIG9yaWdYUmV2aWV3cyArICJJbmRleGVkIGJ5IGFnZW50IGF0ICIgKyBub3cwICsgIjxici8+Iik7CnVwZGF0ZURCKGRvYywgYXJyT2ZQYWlycyk7Cgp0cmFjayhkb2MsICJEb2MgSW5kZXhlZCIsICJEb2N1bWVudCB3aXRoIElkOiAiICsgZG9jLmRiSUQsIHBhZ2VDb3VudCk7CmFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAibmV4dFBhZ2UofnJlYWR5fik7dXBkYXRlREVTdGF0dXMofmluZGV4ZWQ6IiArIHBhZ2VSYW5nZSArICJ+KTsiKTsKCi8qIGVuZCBvZiBydWxlICov"},"ordinal":11}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("@@@@ Index Rule Fired @@@#");
//ERS190730 #61272 updated button validation in the Actions* Details area

var stackId = X(doc, "X_stack");
if (!stackId) stackId=zData.getStackId(doc); //ERS190624 HACK?
var stackFolder = stackId + "-STACK";
var companyCode = doc.deliveredTo;
zData.stage="Indexed"; //ERS190620

/* Clear the trigger that invoked this rule */
//ERS170909 zData.clearTriggerCondition(doc,"X_buttonAction");
var indexInitialized = X(doc,"X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    zData.initializeStack(doc,stackFolder, companyCode, stackId);
}

zData.getDataEntryFields(doc);
// Does the user want to attach indexed pages to Case?
//var caseId = X(doc, "X_ZPAPER__Case__c");
//var contactId = X(doc, "X_ZPAPER__Patient__c");
//var patientId=contactId; //TODO
//var providerId = X(doc, "X_ZPAPER__Provider__c");
//var patientFirstName = X(doc, "X_ZPAPER__FirstName__c");
//var patientLastName = X(doc, "X_ZPAPER__LastName__c");
//var patientDOB = X(doc, "X_ZPAPER__Birthdate__c");

// Get the document type (will be used to route to next folder)
//var docType = X(doc, "X_Document_Type__c");
var nextFolder = "20500Triage-S2";              // Other folder is the default
var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
//move to after updates arrOfPairs=zData.addStage(doc,arrOfPairs,"Indexed");
updateDB(doc,arrOfPairs);

//var sfStackId=zData.getStackId(doc);
var sfStackId=X(doc,'X_sfStackId');
if(!sfStackId){
  sfStackId=zData.getStackId(doc);  
}

alert("@@@@@@ Currently attached to ZPAPER__zStack__c with ID: " + sfStackId);
zData.zParentId=doc.dbID; //ERS190814 to overside the save.jsp workflows

alert("@@@@ Parent zStack Snippet attached to: " + X(doc, "X_attachedTo"));

/* SPLIT OFF NEW SNIPPET HERE */
var pageRange = X(doc,"X_idxPages");
var newId=splitDocumentForIndex(doc, "index", pageRange);

alert("@@@@ AFTER SPLIT: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));

alert("ERS190624 newId="+newId);
//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/* Attach the split document to a new Case record, if it wasn't passed in */
//var priority=X(doc,"X_ZPAPER__Priority__c"); //ERS170626
var label0="";
var triageType=doc.docType;

var attachPath = X(doc,"X_attachedTo");
/* Attach the split document to Patient record if required */ //ERS190619
zData.patientType=XCustomSetting(doc,"ZPAPER__PatientRecord__c"); //ERS190806 ZPAPER__ now in MP
alert("@@@@ zData.patientType ***** "+zData.patientType+" Patient");
if (!zData.patientType) zData.patientType="Contact"; //ERS190802 #61272
//if (X(doc,"X_ZPAPER__Patient__c") || zData.X_ZPAPER__LastName__c) { //ERS190803 TODO rethink use X
    var dq = zData.dq = String.fromCharCode(34); //ERS190802 TODO define better in zData
    if (!zData.patientId) {
        alert("@@@@ creating new "+zData.patientType+" Patient");
        arrOfPairs = [];
        //ERS190730 #61272 missing the basics
        var p="";
        if ("Account"===zData.patientType) { //ERS190803
            p="Person";
            //arrOfPairs.push("Name", zData.X_ZPAPER__FirstName__c+" "+zData.X_ZPAPER__LastName__c);
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c);
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push(p+"Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
        } else {
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c); //X_ZPAPER__FirstName__c //ERS190803 TODO get cleaner #61272
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push("Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
        }
        var attachLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
        zData.patientId=zData.clientPatient(doc,arrOfPairs, attachLabel);
        alert("Created Patient with ID: " + zData.patientId);
        if (zData.patientId == "null" || zData.patientId == "NEW") zData.patientId=null;
        else { //ERS190730 #61272 leverage the new record
            if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
            alert("@@@@@@@ NEW PATIENT CREATED WITH ID: " + zData.patientId); //ERS190802 zData.contactId
            // clear out the "New Patient" fields
            if (1===1) { //ERS190811 #61570 commented out so that patient info is available for DE variables in zippi
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Phone__c" + dq + ").val(" + dq + "" + dq + "); ");            
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + "NONE" + dq + "); ");
            }
            // set the Patient lookup fields
            //ERS190803 TODO handle ZPAPER__ relationships //ERS190811 double up for safety
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
        }
    } else {
        //if (zData.X_ZPAPER__faxType__c && ("CONS" === zData.X_ZPAPER__faxType__c
         //   || "ENRL" ===zData.X_ZPAPER__faxType__c ||
         //  "MEDO" === zData.X_ZPAPER__faxType__c)) { //ERS19109 #64921 TODO many journey best proctice
            alert("@@@@ attaching to existing Patient: " + zData.patientId);
            if (zData.patientType != "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "FirstName,LastName,Birthdate", null, zData.patientId);
                alert("@@@@ attaching to existing contactFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "FirstName", contactFlds); //PV191006 update the child stack
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "LastName", contactFlds);
                zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "Birthdate", contactFlds);
            } else if (zData.patientType === "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "Name", null, zData.patientId);
                alert("@@@@ attaching to existing AccountFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "Name", contactFlds).split(" ")[0]; //ERS190803 TODO find a better way
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "Name", contactFlds).split(" ")[1];
                //zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "PersonBirthdate", contactFlds);

            }
            //PV191008 updated attachLabel on child stack
            attachLabel=zData.clientFile(doc,"Indexed");
            attach(doc, attachLabel, zData.patientId);
      // }
    }
    if (zData.patientId && attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
//}
alert("@@@@ AFTER PATIENT: Child zStack Snippet attached to: " + attachPath);

var attachLabel=zData.clientFile(doc,"Indexed"); //"Indexed " + formatNow;
alert("ERS190624 attachLabel="+attachLabel);


/* Attach the split document to Lead record if required */ //ERS190619
// TODO ERS190624 flip the if logic
if (doc.wddata.indexOf("X_ZPAPER__ReferralLead__c")>-1) { //ERS190803 TODO rethink
    if (!leadId || 0 === leadId.length) {
        alert("@@@@ creating new Lead");
        arrOfPairs = [];
        leadId=zData.clientLead(doc,arrOfPairs);
        alert("Created Lead with ID: " + leadId);
        if (leadId == "null" || leadId == "NEW") leadId=null;
    } else {
        if (zData.attachRecords.indexOf("Lead")>-1) {
            alert("@@@@ attaching to existing Lead: " + leadId);
            attach(doc, attachLabel, leadId);
        }
    }
    if (leadId && attachPath.indexOf(leadId)==-1) attachPath+=","+leadId;
}
alert("@@@@ AFTER LEAD: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//ERS190620 use a setting to determine which lookups we attach to
/* Attach the split document to Case record if required */ //ERS190619
//if (doc.wddata.indexOf("X_ZPAPER__Case__c")>-1) {
  if(1===1){  
    alert("ERS190624 need Case");
    if (zData.caseId) {        
        if (zData.attachRecords.indexOf("Case")>-1) {
            alert("@@@@ attaching to existing Case: " + zData.caseId);
            attachLabel=zData.clientFile(doc,"Indexed");
            attach(doc, attachLabel, zData.caseId);
        }
    }
    alert("ERS190624.78 have a case?");
    if (zData.caseId && attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}

alert("@@@@ AFTER CASE: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//PV191022 create prescription
var stackFlds = getSFFields(doc, "ZPAPER__zStack__c", "ZPAPER__latestFax__c", null, sfStackId);
zData.X_ZPAPER__latestFax__c =  X(doc, "ZPAPER__latestFax__c", stackFlds); //PV190926 update the child stack
if( zData.X_Prescription__c){
    alert("@@@@ attaching to existing Prescription: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    attach(doc, attachLabel, zData.X_Prescription__c);
}

if( !zData.X_Prescription__c && zData.X_ZPAPER__faxType__c &&"RX" === zData.X_ZPAPER__faxType__c ){ //ERS191109 #64921 TODO many journeys
    alert("@@@@ Creating  Prescription__c with fax Type : " + zData.X_ZPAPER__faxType__c);
    arrOfPairs = [];
    arrOfPairs.push("Core_Date_of_Prescription_Received__c",zData.X_ZPAPER__latestFax__c);
    arrOfPairs.push("Core_ProductPrescribed__c",zData.X_ZPAPER__Classification__c);
    arrOfPairs.push("zPaper_receivedId__c", doc.dbID);
    //arrOfPairs.push("Core_Patient__c",zData.patientId);
    zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");
    alert("@@@@ Create Prescription__c with ID: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    //attach(doc, attachLabel, zData.X_Prescription__c);
    zData.PrescriptionName = getSFField(doc, "Core_Prescription__c", "Name", null, zData.X_Prescription__c); //PV191022 //ERS191109 clientIndex?
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c" + dq + ").val(" + dq + zData.X_Prescription__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c_Name" + dq + ").val(" + dq + zData.PrescriptionName + dq + "); ");
     
}

//COMDR
//if( !zData.caseId && ("COMDR" === zData.X_ZPAPER__faxType__c
//     || "MEDC"=== zData.X_ZPAPER__faxType__c || "LAB"=== zData.X_ZPAPER__faxType__c
//     || "INJR"===zData.X_ZPAPER__faxType__c)){
//CRN191114 According to the Abbvie stories, all docTypes except "Consent Forms" need to have a Case created if one isn't already selected
if(!zData.caseId && "CONS" !== zData.X_ZPAPER__faxType__c){
    arrOfPairs = [];
    arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");               // CRN191114 Always use CarePlan Record Type?
    arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
    if(zData.programName === "Abbvie OneCRM - Canada"){
        arrOfPairs.push("Core_CountryCode__c","CA");
    }    
   
    zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
    zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    zData.X_Clinical_Services_Record_Type__c = X(doc, "X_Clinical_Services_Record_Type__c");

/*
CRN191113 Moved below where the docType logic isn't so convoluted    
    if("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c){
      arrOfPairs = [];
      if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24GQAS");
      }
      if("injection Training"===zData.X_Clinical_Services_Record_Type__c){
         
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24LQAS");
      }

     //arrOfPairs.push("Service_Requested_date__c",zData.X_Service_Requested_Date__c);
     arrOfPairs.push("Core_Patient__c",zData.patientId);
     if(!zData.X_Clinical_Services__c){
        zData.X_Clinical_Services__c = zData.clientRecordType(doc,"Core_Clinical_Service__c",arrOfPairs,"Index");
     }
     attachLabel=zData.clientFile(doc,"Indexed");
     attach(doc, attachLabel,  zData.X_Clinical_Services__c);
     zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
    }
    */
}



//OTH
if( !zData.caseId && ("OTH" === zData.X_ZPAPER__faxType__c || "ENRL" === zData.X_ZPAPER__faxType__c
    || "MEDO" === zData.X_ZPAPER__faxType__c || "RX" === zData.X_ZPAPER__faxType__c )){
    arrOfPairs = [];
    arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");
    arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
    if(zData.programName === "Abbvie OneCRM - Canada"){
        arrOfPairs.push("Core_CountryCode__c","CA");
    }    
   
    zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
    zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
}

if( zData.X_Reported_Outcome__c){
    alert("@@@@ attaching to existing Outcome: " + zData.X_Reported_Outcome__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    attach(doc, attachLabel, zData.X_Reported_Outcome__c);
}



arrOfPairs = [];
if (zData.docType) { arrOfPairs.push("ZPAPER__faxType__c", zData.docType);  } //ERS190810 PV190808 #51670
if (zData.providerId) {
    arrOfPairs.push("ZPAPER__Provider__c", zData.providerId);
    if (attachPath.indexOf(zData.providerId)==-1) attachPath+=","+zData.providerId;
}
alert("ERS190812.200 zData.patientId="+zData.patientId); //ERS190812 #61511
if (zData.patientId) {
    if (zData.patientId.indexOf("003")===0) arrOfPairs.push("ZPAPER__Patient__c", zData.patientId);
    if (zData.patientId.indexOf("001")===0) arrOfPairs.push("ZPAPER__PatientAccount__c", zData.patientId);
    if (zData.patientId.indexOf("00Q")===0) arrOfPairs.push("ZPAPER__ReferralLead__c", zData.patientId); //ERS190802 Lead
    if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
    if (1===1) { //ERS190810 PV190808 data entry for next split
        if (zData.X_ZPAPER__FirstName__c) { arrOfPairs.push("ZPAPER__FirstName__c", zData.X_ZPAPER__FirstName__c); }
        if (zData.X_ZPAPER__LastName__c) { arrOfPairs.push("ZPAPER__LastName__c", zData.X_ZPAPER__LastName__c); }  
        if (zData.X_ZPAPER__Birthdate__c) { arrOfPairs.push("ZPAPER__Birthdate__c", zData.X_ZPAPER__Birthdate__c); }
        if (zData.X_ZPAPER__Status__c) {arrOfPairs.push(zp+"Status__c", "Completed"); } //PV191023 updateing status
    }
}
if (zData.caseId) {
    arrOfPairs.push("ZPAPER__Case__c", zData.caseId);
    if (attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}
 alert("@@@@ zData.contactId = " + zData.contactId);
if (zData.contactId && zData.contactId.startsWith("003")) {
   
    arrOfPairs.push("ZPAPER__Patient__c", zData.contactId);
}
if (zData.leadId) {
    arrOfPairs.push("ZPAPER__ReferralLead__c", zData.leadId);
    if (attachPath.indexOf(zData.leadId)==-1) attachPath+=","+zData.leadId;
}
if (zData.referralId) {
    arrOfPairs.push("ZPAPER__Referral__c", zData.referralId);
    if (attachPath.indexOf(zData.referralId)==-1) attachPath+=","+zData.referralId;
}
if (zData.X_ZPAPER__Phone__c) { //PV191006 UPDATED FOR PHONE
    arrOfPairs.push("ZPAPER__Phone__c", zData.X_ZPAPER__Phone__c);
   
}
var specialAuthId = X(doc, "X_Special_Authorization__c");
alert("@@@ zData.X_Special_Authorization__c " + specialAuthId);
var authDocType = X(doc, "ZPAPER__faxType__c");
if (specialAuthId) {
    arrOfPairs.push("Special_Authorization__c", specialAuthId);
    //PV191113 If we have a Special Authorization, attach this document to it
    var specialLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    attach(doc, specialLabel, specialAuthId);
}
else if ("SA" === zData.X_ZPAPER__faxType__c) { 
    var authArrOfPairs = [];
    var authLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    authArrOfPairs.push("ZPAPER__faxType__c", zData.docType, "Member_Plan__c", zData.X_Member_Plan__c , "Clinical_Services__c", zData.X_Clinical_Services__c ); 
    var authId = createAndAttach(doc, "CarePreauth", authLabel, authArrOfPairs);
    if (!authId.contains("ERROR")) {
        var authName = getSFField(doc, "CarePreauth", "Name", null, authId);
        arrOfPairs.push("Special_Authorization__c", Special_Authorization__c_Name);
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c" + dq + ").val(" + dq + authId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c_Name" + dq + ").val(" + dq + authName + dq + "); ");
    }
}

//CRN191114 Handle any passed-in physician (Should this be only for COMDR: Communication from Physician?)
alert("@@@@ zData.X_Physician__c = " + zData.X_Physician__c);
alert("@@@@ X_Physician__c = " + X(doc, "X_Physician__c"));
if (X(doc, "X_Physician__c")) {
    zData.X_Physician__c = X(doc, "X_Physician__c");
    alert("@@@@ zData.X_Physician__c now = " + zData.X_Physician__c);
    arrOfPairs.push("Physician__c", zData.X_Physician__c);
    var physicianLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    alert("@@@ Attaching to Physician__c with Id: " + zData.X_Physician__c);
    attach(doc, physicianLabel, zData.X_Physician__c);
}

//PV191008 updated new fields
if(zData.X_ZPAPER__Classification__c) arrOfPairs.push("ZPAPER__Classification__c",zData.X_ZPAPER__Classification__c);
if( zData.X_ZPAPER__Priority__c) arrOfPairs.push("ZPAPER__Priority__c",zData.X_ZPAPER__Priority__c);
if( zData.X_Sub_Category__c )  arrOfPairs.push("Sub_Category__c",zData.X_Sub_Category__c);
if( zData.X_ZPAPER__faxType__c)  arrOfPairs.push("ZPAPER__faxType__c",zData.X_ZPAPER__faxType__c);
if( zData.X_Prescription__c )  arrOfPairs.push("Prescription__c",zData.X_Prescription__c);
if( zData.X_Member_Plan__c )  arrOfPairs.push("Member_Plan__c",zData.X_Member_Plan__c);
if( zData.X_Coverage_Benefit__c )  arrOfPairs.push("Coverage_Benefit__c",zData.X_Coverage_Benefit__c);
if( zData.X_Clinical_Services__c ) {
    arrOfPairs.push("Clinical_Services__c",zData.X_Clinical_Services__c);
    //PV191113 If we have a Special Authorization, attach this document to it
    var clinicalLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    attach(doc, clinicalLabel, zData.X_Clinical_Services__c);
}
else if (("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c) && X(doc, "X_Service_Requested_Date__c")) {        //CRN191113 Create new Clinical Services record if DocType is MEDC and the Service Requested Date is filled in
    var clinicalSvcArrOfPairs = [];
    var clinicalSvcLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    clinicalSvcArrOfPairs.push("Core_Patient__c", zData.patientId); 
    if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24GQAS");
    }
    if("Injection Training"===zData.X_Clinical_Services_Record_Type__c){
        clinicalSvcArrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24LQAS");
    }
    var clinicalSvcId = createAndAttach(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    if (!clinicalSvcId.contains("ERROR")) {
        zData.X_Clinical_Services__c = clinicalSvcId;
        zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
        arrOfPairs.push("Clinical_Services__c", zData.X_Clinical_Services__c);
    }
}
if( zData.X_Service_Requested_Date__c )  arrOfPairs.push("Service_Requested_Date__c",zData.X_Service_Requested_Date__c);
if( zData.X_Reported_Outcome__c )  arrOfPairs.push("Reported_Outcome__c",zData.X_Reported_Outcome__c);
if( zData.X_Assessment_Type__c )  arrOfPairs.push("Assessment_Type__c",zData.X_Assessment_Type__c);
if( zData.X_Outcome_Type__c )  arrOfPairs.push("Outcome_Type__c",zData.X_Outcome_Type__c);
if(zData.X_Product_Described__c) arrOfPairs.push("Product_Described__c",zData.X_Product_Described__c);
if(zData.X_ZPAPER__latestFax__c) arrOfPairs.push("ZPAPER__latestFax__c",zData.X_ZPAPER__latestFax__c);
//ERS190814 just the child #61511 updateSFRecord(doc, zData.zps, sfStackId, arrOfPairs);
//let the docSet do the work attach(doc,attachLabel, sfStackId);
//var r=updateSFRecord(doc,"ZPAPER__zStack__c",sfStackId,["ZPAPER__receivedId__c",zData.zParentId]); //ERS190814 #61511 override the save.jsp workflows
alert("@@@@ updated and attached to zStack Record, id = " + sfStackId + "?="+zData.getStackId(doc)+" data="+arrOfPairs);

var childStackId=zData.clientChildStack(doc,arrOfPairs,sfStackId); //ERS190810 create child stack for split ERS190811 clientChildStack
if (childStackId) {attachPath+=","+sfStackId+","+childStackId; attachPath=attachPath.replace("/,?","/"); } //ERS190811 #61570 clean up //parent stack too
arrOfPairs=[];//PV191023 Everytime child will attach to that particular zStack
arrOfPairs.push("X_sfStackId",childStackId);
updateDB(doc,arrOfPairs);
/* Move the split document to its processing folder */
alert("@@@@@@ Moving the indexed pages document into next processing folder: " + nextFolder);
//ERS190731 #61272 moveDocument(doc,"",nextFolder);
//ERS190731 #61272 reloadByBATES(doc, nextFolder); //ERS170413 #35291
/* Place the split document into the stack folder */
alert("@@@@@@ Moving the indexed pages document into the final stack folder: " + stackFolder);
moveDocument(doc,"",stackFolder);
unlockDocument(doc);
arrOfPairs = zData.addStage(doc,arrOfPairs,zData.stage);
var pageCount = zData.countPages(doc,pageRange);
alert("@@@@ pageCount = " + pageCount +" were "+ zData.stage);
arrOfPairs.push("X_pages",pageCount);
arrOfPairs.push("X_count",pageCount); //PV191028 updated for stack complete to use exact pages
arrOfPairs.push("db-pages",pageCount);
//ERS190620 arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + stackId);
//arrOfPairs.push("X_attachedTo",attachPath); //CRN191028 We don't need to update the X_attachedTo because it is being set correctly during each attach. Besides, attachPath holds the parent's massaged X_attachedTo which we don't want. //ERS170628
updateDB(doc,arrOfPairs);

//PV191029 Add "Indexed" to the "Received" X_reviews added in client library above.
var origXReviews = X(doc, "X_reviews");
var now0 = getCurDateAndTime(doc);//Pv191029 check docset checkbox
arrOfPairs = [];
arrOfPairs.push("X_reviews", origXReviews + "Indexed by agent at " + now0 + "<br/>");
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");

/* end of rule */
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
dmFyIERFX1BBTkVMX0ZPUk1fMkEgICAgPSAiQ2FuYWRhX1ByaW9yaXR5X0RhdGEyX1dlYl9Gb3JtIjsNCnZhciBERV9QQU5FTF9GT1JNXzJCICAgID0gIk9uZV9DUk1fQ2FuYWRhX0luZGV4X0RhdGEyX1dlYl9Gb3JtIjsNCg0KLyoNCnZhciBmb3JtMkJWYWxpZGF0aW9ucyA9IHsNCiAgICAiT1RIIjogew0KICAgICAgICAicmVxRmllbGRzIjogWw0KICAgICAgICAgICAgeyJuYW1lIjogIiIsICJsYWJlbCI6ICIifQ0KICAgICAgICBdDQogICAgfSwNCiAgICAiTUVEQyI6IG51bGwsDQogICAgIkxBQiI6IG51bGwsDQogICAgIklOSlIiOiBudWxsDQp9DQoqLw0KLy8gV2UnbGwgZmlsbCB0aGlzIGluIHdpdGggYSByZXFGaWVsZHMgbWVtYmVyIGFzIHRoZSBleGFtcGxlIGFib3ZlDQp2YXIgZm9ybTJCVmFsaWRhdGlvbnMgPSB7DQogICAgIk9USCI6IG51bGwsDQogICAgIkVOUkwiOiBudWxsLA0KICAgICJNRURPIjogbnVsbCwNCiAgICAiQ09OUyI6IG51bGwsDQogICAgIkNPTURSIjogbnVsbCwNCiAgICAiU0EiOiBudWxsLA0KICAgICJDQSI6IG51bGwsDQogICAgIkNPUEFZIjogbnVsbCwNCiAgICAiTUVEQyI6IG51bGwsDQogICAgIkxBQiI6IG51bGwsDQogICAgIklOSlIiOiBudWxsDQp9DQoNClN0cmluZy5wcm90b3R5cGUuYXBwZW5kID0gZnVuY3Rpb24gKGFwcGVuZFN0cikgew0KICAgIHJldHVybiBhcHBlbmRTdHIgPyB0aGlzICsgKHRoaXMubGVuZ3RoID4gMCA/ICIsICIgOiAiIikgKyBhcHBlbmRTdHIgOiB0aGlzOw0KfTsNCg0KZnVuY3Rpb24gZG9WYWxpZGF0aW9uKCkgew0KICAgIGRlYnVnZ2VyOw0KICAgIGNvbnNvbGUubG9nKCJDdXJyZW50IERFIFBhbmVsID0gIiArIF9jdXJERVBhbmVsKTsNCiAgICAvL0NSTjE5MTExNCBGaXJzdCBjbGVhciB0aGUgc3R5bGVzIG9mIGFsbCBpbnB1dCBmaWVsZHMgYW5kIGdhdGhlciBmaWVsZCB2YWx1ZXMNCiAgICB2YXIgZmllbGRzID0ge307DQogICAgJCgnLmJpZ0RhdGFFbnRyeScpLmVhY2goZnVuY3Rpb24oKSB7DQogICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyk7DQogICAgICAgIGZpZWxkc1t0aGlzLm5hbWVdID0gJHRoaXMudmFsKCk7DQogICAgICAgIGlmICgnaGlkZGVuJyAhPSAkdGhpcy5hdHRyKCd0eXBlJykpIHsNCiAgICAgICAgICAgICR0aGlzLmNzcygnYm9yZGVyJywnbWVkaXVtIG5vbmUnKTsNCiAgICAgICAgfQ0KICAgIH0pOw0KICAgIA0KICAgIHZhciByZXFCdWZmZXIgPSAiIjsNCiAgICB2YXIgZG9jVHlwZSA9ICQoJ1tuYW1lPSJYX1pQQVBFUl9fZmF4VHlwZV9fYyJdJykudmFsKCk7DQogICAgDQogICAgaWYgKERFX1BBTkVMX0ZPUk1fMkEgPT09IF9jdXJERVBhbmVsKSB7DQogICAgICAgIC8vIFBhbmVsIEEgVmFsaWRhdGlvbnMgSGVyZQ0KICAgIH0NCiAgICBlbHNlIGlmIChERV9QQU5FTF9GT1JNXzJCID09PSBjdXJERVBhbmVsKSB7DQogICAgICAgIC8vIFBhbmVsIEIgVmFsaWRhdGlvbnMgSGVyZQ0KICAgICAgICAvLyBUZXN0IHRoZSBmaWVsZHMgdGhhdCBBTFdBWVMgcmVxdWlyZWQNCiAgICAgICAgcmVxQnVmZmVyID0gdmFsaWRhdGUyQkFsd2F5c1JlcXVpcmVkRmllbGRzKGZpZWxkcywgcmVxQnVmZmVyKTsNCiAgICAgICAgLy8gSWYgY3JlYXRpbmcgbmV3IENsaW5pY2FsIFNlcnZpY2UsIENsaW5pY2FsIFNlcnZpY2UgUmVjb3JkIFR5cGUgaXMgcmVxdWlyZWQuDQogICAgICAgIGlmICgiTUVEQyIgPT09IGRvY1R5cGUgfHwgIklOSlIiID09PSBkb2NUeXBlIHx8ICJMQUIiID09PSBkb2NUeXBlKSB7DQogICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZU1lZGljaWFsQ2xhcmlmaWNhdGlvbk9ySW5qZWN0aW9uUmVwb3J0KGZpZWxkcywgcmVxQnVmZmVyKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHZhciByZXFGaWVsZHNPYmogPSBmb3JtMkJWYWxpZGF0aW9uc1tkb2NUeXBlXTsNCiAgICAgICAgICAgIHZhciByZXFGaWVsZHMgPSByZXFGaWVsZHNPYmogPyByZXFGaWVsZHNPYmoucmVxRmllbGRzIDogbnVsbDsNCiAgICAgICAgICAgIGlmIChyZXFGaWVsZHMpIHsNCiAgICAgICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKHJlcUJ1ZmZlci5sZW5ndGggPiAwKSB7DQogICAgICAgIGFsZXJ0KCJFUlJPUjogVGhlIGZvbGxvd2luZyBmaWVsZHMgYXJlIHJlcXVpcmVkOiAiICsgcmVxQnVmZmVyKTsNCiAgICAgICAgcmV0dXJuIGZhbHNlOyAgIC8vb25lIG9yIG1vcmUgZmllbGQgaXMgbWlzc2luZywgZG9uJ3Qgc2VuZCB0byB0aGUgcnVsZXMgZW5naW5lDQogICAgfQ0KICAgIHJldHVybiB0cnVlOyAgICAgICAgLy9BbGwgcmVxdWlyZWQgZmllbGRzIGhhdmUgYmVlbiBzdXBwbGllZCwgbGV0IHRoZSBydWxlcyBlbmdpbmUgYmUgbm90aWZpZWQNCn0NCg0KZnVuY3Rpb24gaXNCbGFuayh2YWwpIHsNCiAgICByZXR1cm4gIXZhbCB8fCAiTk9ORSIgPT09IHZhbCB8fCAiRE9OT1RfU0FWRSIgPT09IHZhbDsNCn0NCg0KZnVuY3Rpb24gaXNOb3RCbGFuayh2YWwpIHsNCiAgICByZXR1cm4gdmFsICYmICJOT05FIiAhPT0gdmFsICYmICJET05PVF9TQVZFIiAhPT0gdmFsOw0KfQ0KDQpmdW5jdGlvbiBhcHBlbmRUb0J1ZmZlcihidWZmZXIsIHN0cikgew0KICAgIGlmIChidWZmZXIubGVuZ3RoID4gMCkgeyBidWZmZXIgKz0gIiwgIjsgfQ0KICAgIGJ1ZmZlciArPSBzdHI7DQogICAgcmV0dXJuIGJ1ZmZlcjsNCn0NCg0KZnVuY3Rpb24gbWFya01pc3NpbmcobmFtZSwgaWQpIHsNCiAgICB2YXIgJGVsZSA9IG5hbWUgPyAkKCdbbmFtZT0iJyArIG5hbWUgKyAnIl0nKSA6ICQoJyMnICsgaWQpOw0KICAgICRlbGUuY3NzKCdib3JkZXInLCczcHggc29saWQgcmVkJyk7DQp9DQoNCi8qKg0KICogUmVxdWlyZWQgZmllbGRzIGZvciAyQiBGb3JtczogQ2xhc3NpZmljYXRpb24sIFByaW9yaXR5LCBQYXRpZW50LCBEb2N1bWVudCBUeXBlLCBhbmQgU3ViLUNhdGVnb3J5DQogKi8NCmZ1bmN0aW9uIHZhbGlkYXRlMkJBbHdheXNSZXF1aXJlZEZpZWxkcyhmaWVsZHMsIHJlcUJ1ZmZlcikgew0KICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIl0pKSB7DQogICAgICAgIG1hcmtNaXNzaW5nKCJYX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiKTsNCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiQ2xhc3NpZmljYXRpb24iKTsNCiAgICB9DQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19Qcmlvcml0eV9fYyIpOw0KICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJQcmlvcml0eSIpOw0KICAgIH0gICAgDQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIik7DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIlBhdGllbnQiKTsNCiAgICB9ICAgIA0KICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX2ZheFR5cGVfX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19mYXhUeXBlX19jIik7DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIkRvY3VtZW50IFR5cGUiKTsNCiAgICB9DQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1N1Yl9DYXRlZ29yeV9fYyJdKSkgew0KICAgICAgICBtYXJrTWlzc2luZygiWF9TdWJfQ2F0ZWdvcnlfX2MiKTsNCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiU3ViLUNhdGVnb3J5Iik7DQogICAgfQ0KICAgIHJldHVybiByZXFCdWZmZXI7DQp9DQoNCmZ1bmN0aW9uIHZhbGlkYXRlRm9yRG9jdW1lbnRUeXBlKHJlcUZpZWxkcywgZmllbGRzLCByZXFCdWZmZXIpIHsNCiAgICBmb3IgKHZhciBpIGluIHJlcUZpZWxkcykgew0KICAgICAgICBpZiAocmVxRmllbGRzLmhhc093blByb3BlcnR5KGkpKSB7DQogICAgICAgICAgICB2YXIgcmVxRmllbGQgPSByZXFGaWVsZHNbaV07DQogICAgICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbcmVxRmllbGQubmFtZV0pKSB7DQogICAgICAgICAgICAgICAgbWFya01pc3NpbmcobnVsbCwgcmVxRmllbGQubGFiZWwpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXFCdWZmZXI7DQp9DQoNCi8qKg0KICogVGhlIHZhbGlkYXRpb24gZm9yIHRoaXMgRG9jdW1lbnQgVHlwZSBuZWVkcyB0byBiZSB1bmlxdWUgc2luY2Ugbm90IGFsbCBmaWVsZHMgYXJlIHJlcXVpcmVkLCBqdXN0IGEgY2VydGFpbiBjb21iaW5hdGlvbi4NCiAqLw0KZnVuY3Rpb24gdmFsaWRhdGVNZWRpY2lhbENsYXJpZmljYXRpb25PckluamVjdGlvblJlcG9ydChmaWVsZHMsIHJlcUJ1ZmZlcikgew0KICAgIC8vIEFTTSAtIDIwMTktMTEtMTQgLSBXZSBubyBsb25nZXIgcmVxdWlyZSB0aGUgY2FzZS4gIA0KICAgIC8vIEl0J3MgdGhlIHlvdW5nIGFuZCB0aGUgY2FzZWxlc3MuDQogICAgLy8gUmVxdWlyZWQ6IGxvb2tlZCB1cCBDYXNlDQogICAgLy8gaWYgKGlzQmxhbmsoZmllbGRzWyJYX1pQQVBFUl9fQ2FzZV9fYyJdKSkgew0KICAgIC8vICAgICBtYXJrTWlzc2luZyhudWxsLCAiWlBBUEVSX19DYXNlX19jX0Nhc2VOdW1iZXIiKTsNCiAgICAvLyAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiQ2FzZSIpOw0KICAgIC8vIH0NCiAgICAvLyBSZXF1aXJlZDogZWl0aGVyIGxvb2tlZCB1cCBDbGluaWNhbCBTZXJ2aWNlcyBvciBTZXJ2aWNlIFJlcXVlc3RlZCBEYXRlDQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX0NsaW5pY2FsX1NlcnZpY2VzX19jIl0pICYmIChpc0JsYW5rKGZpZWxkc1siWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIl0pIHx8IGlzQmxhbmsoZmllbGRzWyJYX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIl0pKSkgew0KICAgICAgICBtYXJrTWlzc2luZyhudWxsLCAiQ2xpbmljYWxfU2VydmljZXNfX2NfTmFtZSIpOw0KICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyJdKSkgew0KICAgICAgICAgICAgbWFya01pc3NpbmcobnVsbCwgIlNlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2NfcmVhZGFibGUiKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MiXSkpIHsNCiAgICAgICAgICAgIG1hcmtNaXNzaW5nKCJYX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIik7DQogICAgICAgIH0NCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiRWl0aGVyIENsaW5pY2FsIFNlcnZpY2VzIG9yIGJvdGggU2VydmljZSBSZXF1ZXN0ZWQgRGF0ZSBhbmQgQ2xpbmljYWwgU2VydmljZXMgUmVjb3JkIFR5cGUiKTsNCiAgICB9DQogICAgcmV0dXJuIHJlcUJ1ZmZlcjsNCn0NCg0KcmV0dXJuIGRvVmFsaWRhdGlvbigpOw0K
//--- RULE VALIDATION CODE - END ---

</script>
