<!--
// Name: Index Page
// Committer: cory.newey@zpaper.com
// Update: clearing priority if servicing de panel 2A
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2019-11-20 02:27:12","active":true,"button":"Index","name":"Index Page","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Index","operation":"equals"}]},"consequence":{"doit":"YWxlcnQoIkBAQEAgSW5kZXggUnVsZSBGaXJlZCBAQEAjIik7Ci8vRVJTMTkwNzMwICM2MTI3MiB1cGRhdGVkIGJ1dHRvbiB2YWxpZGF0aW9uIGluIHRoZSBBY3Rpb25zKiBEZXRhaWxzIGFyZWEKCnZhciBzdGFja0lkID0gWChkb2MsICJYX3N0YWNrIik7CmlmICghc3RhY2tJZCkgc3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7IC8vRVJTMTkwNjI0IEhBQ0s/CnZhciBzdGFja0ZvbGRlciA9IHN0YWNrSWQgKyAiLVNUQUNLIjsKdmFyIGNvbXBhbnlDb2RlID0gZG9jLmRlbGl2ZXJlZFRvOwp6RGF0YS5zdGFnZT0iSW5kZXhlZCI7IC8vRVJTMTkwNjIwCgovKiBDbGVhciB0aGUgdHJpZ2dlciB0aGF0IGludm9rZWQgdGhpcyBydWxlICovCi8vRVJTMTcwOTA5IHpEYXRhLmNsZWFyVHJpZ2dlckNvbmRpdGlvbihkb2MsIlhfYnV0dG9uQWN0aW9uIik7CnZhciBpbmRleEluaXRpYWxpemVkID0gWChkb2MsIlhfaW5kZXhJbml0aWFsaXplZCIpOwppZiAoIWluZGV4SW5pdGlhbGl6ZWQgfHwgMCA9PT0gaW5kZXhJbml0aWFsaXplZC5sZW5ndGgpIHsKICAgIHN0YWNrSWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICIiOwogICAgc3RhY2tGb2xkZXIgPSBzdGFja0lkICsgIi1TVEFDSyI7CiAgICB6RGF0YS5pbml0aWFsaXplU3RhY2soZG9jLHN0YWNrRm9sZGVyLCBjb21wYW55Q29kZSwgc3RhY2tJZCk7Cn0KCnNhdmVERVBhbmVsVmFsdWVzKGRvYyk7ICAgICAgICAgICAgIC8vQ1JOMTkxMTE4IFNhdmUgREUgRmllbGRzIHRvIFBhcmVudCBTdGFjawp6RGF0YS5nZXREYXRhRW50cnlGaWVsZHMoZG9jKTsKLy8gRG9lcyB0aGUgdXNlciB3YW50IHRvIGF0dGFjaCBpbmRleGVkIHBhZ2VzIHRvIENhc2U/Ci8vdmFyIGNhc2VJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX0Nhc2VfX2MiKTsKLy92YXIgY29udGFjdElkID0gWChkb2MsICJYX1pQQVBFUl9fUGF0aWVudF9fYyIpOwovL3ZhciBwYXRpZW50SWQ9Y29udGFjdElkOyAvL1RPRE8KLy92YXIgcHJvdmlkZXJJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX1Byb3ZpZGVyX19jIik7Ci8vdmFyIHBhdGllbnRGaXJzdE5hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiKTsKLy92YXIgcGF0aWVudExhc3ROYW1lID0gWChkb2MsICJYX1pQQVBFUl9fTGFzdE5hbWVfX2MiKTsKLy92YXIgcGF0aWVudERPQiA9IFgoZG9jLCAiWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyIpOwoKLy8gR2V0IHRoZSBkb2N1bWVudCB0eXBlICh3aWxsIGJlIHVzZWQgdG8gcm91dGUgdG8gbmV4dCBmb2xkZXIpCi8vdmFyIGRvY1R5cGUgPSBYKGRvYywgIlhfRG9jdW1lbnRfVHlwZV9fYyIpOwp2YXIgbmV4dEZvbGRlciA9ICIyMDUwMFRyaWFnZS1TMiI7ICAgICAgICAgICAgICAvLyBPdGhlciBmb2xkZXIgaXMgdGhlIGRlZmF1bHQKdmFyIHByZXZJbmRleFBhZ2VzID0gWChkb2MsICJYX2luZGV4ZWRQYWdlcyIpOwp2YXIgY3VySW5kZXhQYWdlcyA9IFgoZG9jLCAiWF9pZHhQYWdlcyIpOwppZiAocHJldkluZGV4UGFnZXMgJiYgcHJldkluZGV4UGFnZXMubGVuZ3RoID4gMCAmJiBjdXJJbmRleFBhZ2VzICYmIGN1ckluZGV4UGFnZXMubGVuZ3RoID4gMCkgewogICAgcHJldkluZGV4UGFnZXMgKz0gIiwiOwp9CmN1ckluZGV4UGFnZXMgPSBwcmV2SW5kZXhQYWdlcyArIGN1ckluZGV4UGFnZXM7CnZhciBhcnJPZlBhaXJzID0gW107CmFyck9mUGFpcnMucHVzaCgiWF9pbmRleGVkUGFnZXMiLCBjdXJJbmRleFBhZ2VzKTsKLy9tb3ZlIHRvIGFmdGVyIHVwZGF0ZXMgYXJyT2ZQYWlycz16RGF0YS5hZGRTdGFnZShkb2MsYXJyT2ZQYWlycywiSW5kZXhlZCIpOwp1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7CgovL3ZhciBzZlN0YWNrSWQ9ekRhdGEuZ2V0U3RhY2tJZChkb2MpOwp2YXIgc2ZTdGFja0lkPVgoZG9jLCdYX3NmU3RhY2tJZCcpOwppZighc2ZTdGFja0lkKXsKICBzZlN0YWNrSWQ9ekRhdGEuZ2V0U3RhY2tJZChkb2MpOyAgCn0KCmFsZXJ0KCJAQEBAQEAgQ3VycmVudGx5IGF0dGFjaGVkIHRvIFpQQVBFUl9felN0YWNrX19jIHdpdGggSUQ6ICIgKyBzZlN0YWNrSWQpOwp6RGF0YS56UGFyZW50SWQ9ZG9jLmRiSUQ7IC8vRVJTMTkwODE0IHRvIG92ZXJzaWRlIHRoZSBzYXZlLmpzcCB3b3JrZmxvd3MKCmFsZXJ0KCJAQEBAIFBhcmVudCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIFgoZG9jLCAiWF9hdHRhY2hlZFRvIikpOwoKLyogU1BMSVQgT0ZGIE5FVyBTTklQUEVUIEhFUkUgKi8KdmFyIHBhZ2VSYW5nZSA9IFgoZG9jLCJYX2lkeFBhZ2VzIik7CnZhciBuZXdJZD1zcGxpdERvY3VtZW50Rm9ySW5kZXgoZG9jLCAiaW5kZXgiLCBwYWdlUmFuZ2UpOwoKYWxlcnQoIkBAQEAgQUZURVIgU1BMSVQ6IENoaWxkIHpTdGFjayBTbmlwcGV0IGF0dGFjaGVkIHRvOiAiICsgWChkb2MsICJYX2F0dGFjaGVkVG8iKSk7CgpzYXZlREVQYW5lbFZhbHVlcyhkb2MpOyAgICAgICAgICAgICAvL0NSTjE5MTExOCBBbHNvIFNhdmUgREUgRmllbGRzIHRvIENoaWxkIFN0YWNrCgphbGVydCgiRVJTMTkwNjI0IG5ld0lkPSIrbmV3SWQpOwovLyoKLyogQUZURVIgVEhJUyBQT0lOVCwgVEhFIERPQyBXSUxMIEhPTEQgREFUQSBGT1IgTkVXIFNOSVBQRVQsIE5PVCBUSEUgU1RBQ0sgU05JUFBFVCAqLwovLyoKCi8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gYSBuZXcgQ2FzZSByZWNvcmQsIGlmIGl0IHdhc24ndCBwYXNzZWQgaW4gYW5kIGlmIHdlIGFyZSBub3QgaGFuZGxpbmcgdGhlIDJBIERFIFBhbmVsOiBDYW5hZGFfUHJpb3JpdHlfRGF0YTJfV2ViX0Zvcm0gKi8KLy92YXIgcHJpb3JpdHk9WChkb2MsIlhfWlBBUEVSX19Qcmlvcml0eV9fYyIpOyAvL0VSUzE3MDYyNgp2YXIgbGFiZWwwPSIiOwp2YXIgdHJpYWdlVHlwZT1kb2MuZG9jVHlwZTsKCnZhciBhdHRhY2hQYXRoID0gWChkb2MsIlhfYXR0YWNoZWRUbyIpOwovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIFBhdGllbnQgcmVjb3JkIGlmIHJlcXVpcmVkICovIC8vRVJTMTkwNjE5CnpEYXRhLnBhdGllbnRUeXBlPVhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19QYXRpZW50UmVjb3JkX19jIik7IC8vRVJTMTkwODA2IFpQQVBFUl9fIG5vdyBpbiBNUAphbGVydCgiQEBAQCB6RGF0YS5wYXRpZW50VHlwZSAqKioqKiAiK3pEYXRhLnBhdGllbnRUeXBlKyIgUGF0aWVudCIpOwphbGVydCgiQEBAIGN1cnJlbnQgREUgUGFuZWwgbmFtZSA9ICIgKyBYKGRvYywgIlhfbGFzdERFUGFuZWwiKSk7CmlmICghekRhdGEucGF0aWVudFR5cGUpIHpEYXRhLnBhdGllbnRUeXBlPSJDb250YWN0IjsgLy9FUlMxOTA4MDIgIzYxMjcyCi8vaWYgKFgoZG9jLCJYX1pQQVBFUl9fUGF0aWVudF9fYyIpIHx8IHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYykgeyAvL0VSUzE5MDgwMyBUT0RPIHJldGhpbmsgdXNlIFgKICAgIHZhciBkcSA9IHpEYXRhLmRxID0gU3RyaW5nLmZyb21DaGFyQ29kZSgzNCk7IC8vRVJTMTkwODAyIFRPRE8gZGVmaW5lIGJldHRlciBpbiB6RGF0YQogICAgdmFyIHBhdGllbnRQaG9uZSA9IFgoZG9jLCAiWF9aUEFQRVJfX1Bob25lX19jIik7CiAgICBhbGVydCgiQEBAIHBhdGllbnRQaG9uZSA9ICIgKyBwYXRpZW50UGhvbmUpOwogICAgaWYgKCF6RGF0YS5wYXRpZW50SWQpIHsKICAgICAgICBhbGVydCgiQEBAQCBjcmVhdGluZyBuZXcgIit6RGF0YS5wYXRpZW50VHlwZSsiIFBhdGllbnQiKTsKICAgICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgICAgLy9FUlMxOTA3MzAgIzYxMjcyIG1pc3NpbmcgdGhlIGJhc2ljcwogICAgICAgIHZhciBwPSIiOwogICAgICAgIGlmICgiQWNjb3VudCI9PT16RGF0YS5wYXRpZW50VHlwZSkgeyAvL0VSUzE5MDgwMwogICAgICAgICAgICBwPSJQZXJzb24iOwogICAgICAgICAgICAvL2Fyck9mUGFpcnMucHVzaCgiTmFtZSIsIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MrIiAiK3pEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiRmlyc3ROYW1lIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiTGFzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogICAgICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgewogICAgICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKHArIkJpcnRoZGF0ZSIsIHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXRpZW50UGhvbmUpIHsgYXJyT2ZQYWlycy5wdXNoKCJQaG9uZSIsIHBhdGllbnRQaG9uZSk7IH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkZpcnN0TmFtZSIsIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MpOyAvL1hfWlBBUEVSX19GaXJzdE5hbWVfX2MgLy9FUlMxOTA4MDMgVE9ETyBnZXQgY2xlYW5lciAjNjEyNzIKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJMYXN0TmFtZSIsIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7CiAgICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkJpcnRoZGF0ZSIsIHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXRpZW50UGhvbmUpIHsgYXJyT2ZQYWlycy5wdXNoKCJQaG9uZSIsIHBhdGllbnRQaG9uZSk7IH0KICAgICAgICB9CiAgICAgICAgdmFyIGF0dGFjaExhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgICAgIHpEYXRhLnBhdGllbnRJZD16RGF0YS5jbGllbnRQYXRpZW50KGRvYyxhcnJPZlBhaXJzLCBhdHRhY2hMYWJlbCk7CiAgICAgICAgYWxlcnQoIkNyZWF0ZWQgUGF0aWVudCB3aXRoIElEOiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICBpZiAoekRhdGEucGF0aWVudElkID09ICJudWxsIiB8fCB6RGF0YS5wYXRpZW50SWQgPT0gIk5FVyIpIHpEYXRhLnBhdGllbnRJZD1udWxsOwogICAgICAgIGVsc2UgeyAvL0VSUzE5MDczMCAjNjEyNzIgbGV2ZXJhZ2UgdGhlIG5ldyByZWNvcmQKICAgICAgICAgICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5wYXRpZW50SWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLnBhdGllbnRJZDsKICAgICAgICAgICAgYWxlcnQoIkBAQEBAQEAgTkVXIFBBVElFTlQgQ1JFQVRFRCBXSVRIIElEOiAiICsgekRhdGEucGF0aWVudElkKTsgLy9FUlMxOTA4MDIgekRhdGEuY29udGFjdElkCiAgICAgICAgICAgIC8vIGNsZWFyIG91dCB0aGUgIk5ldyBQYXRpZW50IiBmaWVsZHMKICAgICAgICAgICAgaWYgKDE9PT0xKSB7IC8vRVJTMTkwODExICM2MTU3MCBjb21tZW50ZWQgb3V0IHNvIHRoYXQgcGF0aWVudCBpbmZvIGlzIGF2YWlsYWJsZSBmb3IgREUgdmFyaWFibGVzIGluIHppcHBpCiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0ZpcnN0TmFtZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19MYXN0TmFtZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19CaXJ0aGRhdGVfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIiIgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGhvbmVfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIiIgKyBkcSArICIpOyAiKTsgICAgICAgICAgICAKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQmlydGhkYXRlX19jX3JlYWRhYmxlIiArIGRxICsgIikudmFsKCIgKyBkcSArICJOT05FIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHNldCB0aGUgUGF0aWVudCBsb29rdXAgZmllbGRzCiAgICAgICAgICAgIC8vRVJTMTkwODAzIFRPRE8gaGFuZGxlIFpQQVBFUl9fIHJlbGF0aW9uc2hpcHMgLy9FUlMxOTA4MTEgZG91YmxlIHVwIGZvciBzYWZldHkKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5wYXRpZW50SWQgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyAiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEucGF0aWVudElkICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX1BhdGllbnRBY2NvdW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArICIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArIGRxICsgIik7ICIpOwogICAgICAgICAgICAvL0NSTjE5MTExOCBBbHNvIHNhdmUgdGhlIG5ldyB2YWx1ZXMgdG8gdGhlIGNoaWxkCiAgICAgICAgICAgIHZhciBzYXZlMkRCQXJyT2ZQYWlycyA9IFtdOwogICAgICAgICAgICBzYXZlMkRCQXJyT2ZQYWlycy5wdXNoKCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICBzYXZlMkRCQXJyT2ZQYWlycy5wdXNoKCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX3IuTmFtZSIsIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyAiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogICAgICAgICAgICB1cGRhdGVEQihkb2MsIHNhdmUyREJBcnJPZlBhaXJzKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vaWYgKHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICYmICgiQ09OUyIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jCiAgICAgICAgIC8vICAgfHwgIkVOUkwiID09PXpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8CiAgICAgICAgIC8vICAiTUVETyIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSkgeyAvL0VSUzE5MTA5ICM2NDkyMSBUT0RPIG1hbnkgam91cm5leSBiZXN0IHByb2N0aWNlCiAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgaWYgKHpEYXRhLnBhdGllbnRUeXBlICE9ICJBY2NvdW50IikgeyAvL0VSUzE5MDczMCBsb29rdXAgdGhlIGRhdGEgVE9ETyBwZXJzb24gYWNjb3VudD8KICAgICAgICAgICAgICAgIHZhciBjb250YWN0RmxkcyA9IGdldFNGRmllbGRzKGRvYywgekRhdGEucGF0aWVudFR5cGUsICJGaXJzdE5hbWUsTGFzdE5hbWUsQmlydGhkYXRlIiwgbnVsbCwgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBjb250YWN0RmxkczogIiArIGNvbnRhY3RGbGRzKTsKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgPSBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJGaXJzdE5hbWUiLCBjb250YWN0Rmxkcyk7IC8vUFYxOTEwMDYgdXBkYXRlIHRoZSBjaGlsZCBzdGFjawogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jID0gcGF0aWVudExhc3ROYW1lID0gWChkb2MsICJMYXN0TmFtZSIsIGNvbnRhY3RGbGRzKTsKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2M9cGF0aWVudERPQiA9IFgoZG9jLCAiQmlydGhkYXRlIiwgY29udGFjdEZsZHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHpEYXRhLnBhdGllbnRUeXBlID09PSAiQWNjb3VudCIpIHsgLy9FUlMxOTA3MzAgbG9va3VwIHRoZSBkYXRhIFRPRE8gcGVyc29uIGFjY291bnQ/CiAgICAgICAgICAgICAgICB2YXIgY29udGFjdEZsZHMgPSBnZXRTRkZpZWxkcyhkb2MsIHpEYXRhLnBhdGllbnRUeXBlLCAiTmFtZSIsIG51bGwsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgQWNjb3VudEZsZHM6ICIgKyBjb250YWN0Rmxkcyk7CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jID0gcGF0aWVudEZpcnN0TmFtZSA9IFgoZG9jLCAiTmFtZSIsIGNvbnRhY3RGbGRzKS5zcGxpdCgiICIpWzBdOyAvL0VSUzE5MDgwMyBUT0RPIGZpbmQgYSBiZXR0ZXIgd2F5CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgPSBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIk5hbWUiLCBjb250YWN0Rmxkcykuc3BsaXQoIiAiKVsxXTsKICAgICAgICAgICAgICAgIC8vekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYz1wYXRpZW50RE9CID0gWChkb2MsICJQZXJzb25CaXJ0aGRhdGUiLCBjb250YWN0Rmxkcyk7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vUFYxOTEwMDggdXBkYXRlZCBhdHRhY2hMYWJlbCBvbiBjaGlsZCBzdGFjawogICAgICAgICAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgICAgICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgekRhdGEucGF0aWVudElkKTsKICAgICAgLy8gfQogICAgfQogICAgaWYgKHpEYXRhLnBhdGllbnRJZCAmJiBhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucGF0aWVudElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5wYXRpZW50SWQ7Ci8vfQphbGVydCgiQEBAQCBBRlRFUiBQQVRJRU5UOiBDaGlsZCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIGF0dGFjaFBhdGgpOwoKdmFyIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7IC8vIkluZGV4ZWQgIiArIGZvcm1hdE5vdzsKYWxlcnQoIkVSUzE5MDYyNCBhdHRhY2hMYWJlbD0iK2F0dGFjaExhYmVsKTsKCgovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIExlYWQgcmVjb3JkIGlmIHJlcXVpcmVkICovIC8vRVJTMTkwNjE5Ci8vIFRPRE8gRVJTMTkwNjI0IGZsaXAgdGhlIGlmIGxvZ2ljCmlmIChkb2Mud2RkYXRhLmluZGV4T2YoIlhfWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiKT4tMSkgeyAvL0VSUzE5MDgwMyBUT0RPIHJldGhpbmsKICAgIGlmICghbGVhZElkIHx8IDAgPT09IGxlYWRJZC5sZW5ndGgpIHsKICAgICAgICBhbGVydCgiQEBAQCBjcmVhdGluZyBuZXcgTGVhZCIpOwogICAgICAgIGFyck9mUGFpcnMgPSBbXTsKICAgICAgICBsZWFkSWQ9ekRhdGEuY2xpZW50TGVhZChkb2MsYXJyT2ZQYWlycyk7CiAgICAgICAgYWxlcnQoIkNyZWF0ZWQgTGVhZCB3aXRoIElEOiAiICsgbGVhZElkKTsKICAgICAgICBpZiAobGVhZElkID09ICJudWxsIiB8fCBsZWFkSWQgPT0gIk5FVyIpIGxlYWRJZD1udWxsOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAoekRhdGEuYXR0YWNoUmVjb3Jkcy5pbmRleE9mKCJMZWFkIik+LTEpIHsKICAgICAgICAgICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIExlYWQ6ICIgKyBsZWFkSWQpOwogICAgICAgICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgbGVhZElkKTsKICAgICAgICB9CiAgICB9CiAgICBpZiAobGVhZElkICYmIGF0dGFjaFBhdGguaW5kZXhPZihsZWFkSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK2xlYWRJZDsKfQphbGVydCgiQEBAQCBBRlRFUiBMRUFEOiBDaGlsZCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIFgoZG9jLCAiWF9hdHRhY2hlZFRvIikpOwoKCi8vRVJTMTkwNjIwIHVzZSBhIHNldHRpbmcgdG8gZGV0ZXJtaW5lIHdoaWNoIGxvb2t1cHMgd2UgYXR0YWNoIHRvCi8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gQ2FzZSByZWNvcmQgaWYgcmVxdWlyZWQgKi8gLy9FUlMxOTA2MTkKLy9pZiAoZG9jLndkZGF0YS5pbmRleE9mKCJYX1pQQVBFUl9fQ2FzZV9fYyIpPi0xKSB7CiAgaWYoMT09PTEpeyAgCiAgICBhbGVydCgiRVJTMTkwNjI0IG5lZWQgQ2FzZSIpOwogICAgaWYgKHpEYXRhLmNhc2VJZCkgeyAgICAgICAgCiAgICAgICAgaWYgKHpEYXRhLmF0dGFjaFJlY29yZHMuaW5kZXhPZigiQ2FzZSIpPi0xKSB7CiAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBDYXNlOiAiICsgekRhdGEuY2FzZUlkKTsKICAgICAgICAgICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgICAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLmNhc2VJZCk7CiAgICAgICAgfQogICAgfQogICAgYWxlcnQoIkVSUzE5MDYyNC43OCBoYXZlIGEgY2FzZT8iKTsKICAgIGlmICh6RGF0YS5jYXNlSWQgJiYgYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLmNhc2VJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEuY2FzZUlkOwp9CgphbGVydCgiQEBAQCBBRlRFUiBDQVNFOiBDaGlsZCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIFgoZG9jLCAiWF9hdHRhY2hlZFRvIikpOwoKCi8vUFYxOTEwMjIgY3JlYXRlIHByZXNjcmlwdGlvbgp2YXIgc3RhY2tGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCAiWlBBUEVSX19sYXRlc3RGYXhfX2MiLCBudWxsLCBzZlN0YWNrSWQpOwp6RGF0YS5YX1pQQVBFUl9fbGF0ZXN0RmF4X19jID0gIFgoZG9jLCAiWlBBUEVSX19sYXRlc3RGYXhfX2MiLCBzdGFja0ZsZHMpOyAvL1BWMTkwOTI2IHVwZGF0ZSB0aGUgY2hpbGQgc3RhY2sKaWYoIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKXsKICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBQcmVzY3JpcHRpb246ICIgKyB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7CiAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsKfQppZiggIXpEYXRhLlhfUHJlc2NyaXB0aW9uX19jICYmIHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICYmIlJYIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgKSB7IC8vRVJTMTkxMTA5ICM2NDkyMSBUT0RPIG1hbnkgam91cm5leXMKICAgIGFsZXJ0KCJAQEBAIENyZWF0aW5nICBQcmVzY3JpcHRpb25fX2Mgd2l0aCBmYXggVHlwZSA6ICIgKyB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyk7CiAgICBhcnJPZlBhaXJzID0gW107CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfRGF0ZV9vZl9QcmVzY3JpcHRpb25fUmVjZWl2ZWRfX2MiLHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX1Byb2R1Y3RQcmVzY3JpYmVkX19jIix6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVQbGFuX19jIiwgekRhdGEuY2FzZUlkKTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNvcmVfUHJlc2NyaXB0aW9uX19jIixhcnJPZlBhaXJzLCJJbmRleCIpOwogICAgYWxlcnQoIkBAQEAgQ3JlYXRlIFByZXNjcmlwdGlvbl9fYyB3aXRoIElEOiAiICsgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIC8vYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsKICAgIHpEYXRhLlByZXNjcmlwdGlvbk5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNvcmVfUHJlc2NyaXB0aW9uX19jIiwgIk5hbWUiLCBudWxsLCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7IC8vUFYxOTEwMjIgLy9FUlMxOTExMDkgY2xpZW50SW5kZXg/CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUHJlc2NyaXB0aW9uX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jICsgZHEgKyAiKTsgIik7CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUHJlc2NyaXB0aW9uX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuUHJlc2NyaXB0aW9uTmFtZSArIGRxICsgIik7ICIpOwogICAgIAp9Ci8vQ1JOMTkxMTE4IElmIHdlIGFsc28gaGF2ZSBhIHBhdGllbnQgYW5kIGEgUHJlc2NyaXB0aW9uLCBhc3NvY2lhdGUgdGhlbS4KLyoKaWYgKHpEYXRhLnBhdGllbnRJZCAmJiB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYykgewogICAgYWxlcnQoIkBAQCBBc3NvY2lhdGluZyBQcmVzY3JpcHRpb246ICIgKyB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyArICIgd2l0aCBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgIHZhciBzY3JpcHRBcnJPZlBhaXJzID0gW107CiAgICBzY3JpcHRBcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICB1cGRhdGVTRlJlY29yZChkb2MsICJDb3JlX1ByZXNjcmlwdGlvbl9fYyIsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jLCBzY3JpcHRBcnJPZlBhaXJzKTsKfQoqLwoKLy9DT01EUgovL2lmKCAhekRhdGEuY2FzZUlkICYmICgiQ09NRFIiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwovLyAgICAgfHwgIk1FREMiPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8ICJMQUIiPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jCi8vICAgICB8fCAiSU5KUiI9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykpewovL0NSTjE5MTExNCBBY2NvcmRpbmcgdG8gdGhlIEFiYnZpZSBzdG9yaWVzLCBhbGwgZG9jVHlwZXMgZXhjZXB0ICJDb25zZW50IEZvcm1zIiBuZWVkIHRvIGhhdmUgYSBDYXNlIGNyZWF0ZWQgaWYgb25lIGlzbid0IGFscmVhZHkgc2VsZWN0ZWQKaWYoIXpEYXRhLmNhc2VJZCAmJiAiQ09OUyIgIT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICYmICdDYW5hZGFfUHJpb3JpdHlfRGF0YTJfV2ViX0Zvcm0nICE9PSBYKGRvYywgIlhfbGFzdERFUGFuZWwiKSkgewogICAgYXJyT2ZQYWlycyA9IFtdOwogICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTIxaTAwMDAwMGhRbzdBQUUiKTsgICAgICAgICAgICAgICAvLyBDUk4xOTExMTQgQWx3YXlzIHVzZSBDYXJlUGxhbiBSZWNvcmQgVHlwZT8KICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9CcmFuZF9fYyIsekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKTsKICAgIGlmKHpEYXRhLnByb2dyYW1OYW1lID09PSAiQWJidmllIE9uZUNSTSAtIENhbmFkYSIpewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9Db3VudHJ5Q29kZV9fYyIsIkNBIik7CiAgICB9CiAgICBpZiAoekRhdGEucGF0aWVudElkKSB7IGFyck9mUGFpcnMucHVzaCgiQWNjb3VudElkIiwgekRhdGEucGF0aWVudElkKTsgfQogICAKICAgIHpEYXRhLmNhc2VJZCA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGUoZG9jLCJDYXNlIixhcnJPZlBhaXJzLCJJbmRleCIpOwogICAgekRhdGEuY2FzZU51bWJlciA9IGdldFNGRmllbGQoZG9jLCAiQ2FzZSIsICJDYXNlTnVtYmVyIiwgbnVsbCwgekRhdGEuY2FzZUlkKTsgLy9QVjE5MTAyMgogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5jYXNlSWQgKyBkcSArICIpOyAiKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0Nhc2VfX2NfQ2FzZU51bWJlciIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5jYXNlTnVtYmVyICsgZHEgKyAiKTsgIik7IC8vUFYxOTA5MjkgdXBkYXRlZCBjYXNlIG51bWJlciBpbiBsb29rdXAKICAgIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MgPSBYKGRvYywgIlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MiKTsKCi8qCkNSTjE5MTExMyBNb3ZlZCBiZWxvdyB3aGVyZSB0aGUgZG9jVHlwZSBsb2dpYyBpc24ndCBzbyBjb252b2x1dGVkICAgIAogICAgaWYoIkxBQiI9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIklOSlIiPT09ekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKICAgICAgIHx8ICJNRURDIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpewogICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgIGlmKCJMYWIgVGVzdHMiPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjVFMDAwMDAwSzI0R1FBUyIpOwogICAgICB9CiAgICAgIGlmKCJpbmplY3Rpb24gVHJhaW5pbmciPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgIAogICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MiLCIwMTI1RTAwMDAwMEsyNExRQVMiKTsKICAgICAgfQoKICAgICAvL2Fyck9mUGFpcnMucHVzaCgiU2VydmljZV9SZXF1ZXN0ZWRfZGF0ZV9fYyIsekRhdGEuWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jKTsKICAgICAvL2Fyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIix6RGF0YS5wYXRpZW50SWQpOwogICAgIGlmKCF6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKXsKICAgICAgICBhc3NvY2lhdGVkQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVfUGxhbl9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICAgICAgYXNzb2NpYXRlZEFyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgICAgICB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgICB9CiAgICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwogICAgIHpEYXRhLkNsaW5pY2FsTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIiwgIk5hbWUiLCBudWxsLCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsgLy9QVjE5MTAyMgogICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNDbGluaWNhbF9TZXJ2aWNlc19fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jICsgZHEgKyAiKTsgIik7CiAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuQ2xpbmljYWxOYW1lICsgZHEgKyAiKTsgIik7CiAgICB9CiAgICAqLwp9CgovL0NPUEFZCmlmICgiQ09QQVkiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgewogICAgYXJyT2ZQYWlycyA9IFtdOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDQV9QYXRpZW50X19jIix6RGF0YS5wYXRpZW50SWQpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDQV9DYXJlUGxhbklEX19jIix6RGF0YS5jYXNlSWQpOwogICAgekRhdGEuY29wYXlJZCA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGUoZG9jLCJDQV9Db3BheV9fYyIsYXJyT2ZQYWlycywiSW5kZXgiKTsKfQoKCi8vT1RICmlmKCAhekRhdGEuY2FzZUlkICYmICgiT1RIIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIkVOUkwiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgfHwgIk1FRE8iID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiUlgiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyApKXsKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyMWkwMDAwMDBoUW83QUFFIik7CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQnJhbmRfX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CiAgICBpZih6RGF0YS5wcm9ncmFtTmFtZSA9PT0gIkFiYnZpZSBPbmVDUk0gLSBDYW5hZGEiKXsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQ291bnRyeUNvZGVfX2MiLCJDQSIpOwogICAgfSAgICAKICAgCiAgICB6RGF0YS5jYXNlSWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ2FzZSIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIHpEYXRhLmNhc2VOdW1iZXIgPSBnZXRTRkZpZWxkKGRvYywgIkNhc2UiLCAiQ2FzZU51bWJlciIsIG51bGwsIHpEYXRhLmNhc2VJZCk7IC8vUFYxOTEwMjIKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0Nhc2VfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZUlkICsgZHEgKyAiKTsgIik7CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19DYXNlX19jX0Nhc2VOdW1iZXIiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZU51bWJlciArIGRxICsgIik7ICIpOyAvL1BWMTkwOTI5IHVwZGF0ZWQgY2FzZSBudW1iZXIgaW4gbG9va3VwCn0KCmlmKCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpewogICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIE91dGNvbWU6ICIgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwogICAgLy9DUk4xOTExMTggSWYgd2UgYWxzbyBoYXZlIGEgUGF0aWVudCBhbmQgYSBSZXBvcnRlZCBPdXRjb21lLCBhc3NvY2lhdGUgdGhlbS4KICAgIGlmICh6RGF0YS5wYXRpZW50SWQpIHsKICAgICAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIFJlcG9ydGVkIEN1dGNvbWU6ICIgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgKyAiIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgdmFyIG91dGNvbWVBcnJPZlBhaXJzID0gW107CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9BY2NvdW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgICAgICB1cGRhdGVTRlJlY29yZChkb2MsICJDb3JlX1BhdGllbnRfUmVwb3J0ZWRfT3V0Y29tZXNfX2MiLCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MsIG91dGNvbWVBcnJPZlBhaXJzKTsKICAgIH0KfQplbHNlIGlmICgiQ0EiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgewogICAgdmFyIG91dGNvbWVBcnJPZlBhaXJzID0gW107CiAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0VudHJ5X0RhdGVfX2MiLCBnZXRDdXJEYXRlKGRvYykpOwogICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9DYXJlX1BsYW5fX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9BY2NvdW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIHZhciBhc3Nlc3NtZW50VHlwZSA9IFgoZG9jLCAiWF9Bc3Nlc3NtZW50X1R5cGVfX2MiKTsKICAgIGlmIChhc3Nlc3NtZW50VHlwZSAmJiAiRE9OT1RfU0FWRSIgIT09IGFzc2Vzc21lbnRUeXBlKSB7CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9Bc3Nlc3NtZW50X1R5cGVfX2MiLCBhc3Nlc3NtZW50VHlwZSk7CiAgICB9CiAgICB2YXIgb3V0Y29tZVR5cGUgPSBYKGRvYywgIlhfT3V0Y29tZV9UeXBlX19jIik7CiAgICBpZiAob3V0Y29tZVR5cGUgJiYgIkRPTk9UX1NBVkUiICE9PSBvdXRjb21lVHlwZSkgewogICAgICAgIG91dGNvbWVBcnJPZlBhaXJzLnB1c2goIkNvcmVfT3V0Y29tZV9UeXBlX19jIiwgb3V0Y29tZVR5cGUpOwogICAgfQogICAgLy9DUk4xOTExMTggSWYgd2UgYWxzbyBoYXZlIGEgUGF0aWVudCBhbmQgYSBSZXBvcnRlZCBPdXRjb21lLCBhc3NvY2lhdGUgdGhlbS4KICAgIGlmICh6RGF0YS5wYXRpZW50SWQpIHsKICAgICAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIE5ldyBSZXBvcnRlZCBDdXRjb21lIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9BY2NvdW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIH0KICAgIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGUoZG9jLCJDb3JlX1BhdGllbnRfUmVwb3J0ZWRfT3V0Y29tZXNfX2MiLG91dGNvbWVBcnJPZlBhaXJzLCJJbmRleCIpOwogICAgdmFyIG91dGNvbWVOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDb3JlX1BhdGllbnRfUmVwb3J0ZWRfT3V0Y29tZXNfX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyk7CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUmVwb3J0ZWRfT3V0Y29tZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgKyBkcSArICIpOyAiKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNSZXBvcnRlZF9PdXRjb21lX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgb3V0Y29tZU5hbWUgKyBkcSArICIpOyAiKTsKfQoKCmFyck9mUGFpcnMgPSBbXTsKaWYgKHpEYXRhLmRvY1R5cGUpIHsgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLCB6RGF0YS5kb2NUeXBlKTsgIH0gLy9FUlMxOTA4MTAgUFYxOTA4MDggIzUxNjcwCmlmICh6RGF0YS5wcm92aWRlcklkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUHJvdmlkZXJfX2MiLCB6RGF0YS5wcm92aWRlcklkKTsKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucHJvdmlkZXJJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucHJvdmlkZXJJZDsKfQphbGVydCgiRVJTMTkwODEyLjIwMCB6RGF0YS5wYXRpZW50SWQ9Iit6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgxMiAjNjE1MTEKaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMDMiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIGlmICh6RGF0YS5wYXRpZW50SWQuaW5kZXhPZigiMDAxIik9PT0wKSBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMFEiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOyAvL0VSUzE5MDgwMiBMZWFkCiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnBhdGllbnRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucGF0aWVudElkOwogICAgaWYgKDE9PT0xKSB7IC8vRVJTMTkwODEwIFBWMTkwODA4IGRhdGEgZW50cnkgZm9yIG5leHQgc3BsaXQKICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYykgeyBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fRmlyc3ROYW1lX19jIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7IH0KICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19MYXN0TmFtZV9fYyIsIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7IH0gIAogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19CaXJ0aGRhdGVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fU3RhdHVzX19jKSB7YXJyT2ZQYWlycy5wdXNoKHpwKyJTdGF0dXNfX2MiLCAiQ29tcGxldGVkIik7IH0gLy9QVjE5MTAyMyB1cGRhdGVpbmcgc3RhdHVzCiAgICB9Cn0KaWYgKHpEYXRhLmNhc2VJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0Nhc2VfX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5jYXNlSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmNhc2VJZDsKfQogYWxlcnQoIkBAQEAgekRhdGEuY29udGFjdElkID0gIiArIHpEYXRhLmNvbnRhY3RJZCk7CmlmICh6RGF0YS5jb250YWN0SWQgJiYgekRhdGEuY29udGFjdElkLnN0YXJ0c1dpdGgoIjAwMyIpKSB7CiAgIAogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhdGllbnRfX2MiLCB6RGF0YS5jb250YWN0SWQpOwp9CmlmICh6RGF0YS5sZWFkSWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiLCB6RGF0YS5sZWFkSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5sZWFkSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmxlYWRJZDsKfQppZiAoekRhdGEucmVmZXJyYWxJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1JlZmVycmFsX19jIiwgekRhdGEucmVmZXJyYWxJZCk7CiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnJlZmVycmFsSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLnJlZmVycmFsSWQ7Cn0KaWYgKHpEYXRhLlhfWlBBUEVSX19QaG9uZV9fYykgeyAvL1BWMTkxMDA2IFVQREFURUQgRk9SIFBIT05FCiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGhvbmVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fUGhvbmVfX2MpOwogICAKfQp2YXIgc3BlY2lhbEF1dGhJZCA9IFgoZG9jLCAiWF9TcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiKTsKYWxlcnQoIkBAQCB6RGF0YS5YX1NwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyAiICsgc3BlY2lhbEF1dGhJZCk7CnZhciBhdXRoRG9jVHlwZSA9IFgoZG9jLCAiWlBBUEVSX19mYXhUeXBlX19jIik7CmlmIChzcGVjaWFsQXV0aElkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIsIHNwZWNpYWxBdXRoSWQpOwogICAgLy9QVjE5MTExMyBJZiB3ZSBoYXZlIGEgU3BlY2lhbCBBdXRob3JpemF0aW9uLCBhdHRhY2ggdGhpcyBkb2N1bWVudCB0byBpdAogICAgdmFyIHNwZWNpYWxMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGF0dGFjaChkb2MsIHNwZWNpYWxMYWJlbCwgc3BlY2lhbEF1dGhJZCk7Cn0KZWxzZSBpZiAoIlNBIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpIHsgCiAgICB2YXIgYXV0aEFyck9mUGFpcnMgPSBbXTsKICAgIHZhciBhdXRoTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICBhdXRoQXJyT2ZQYWlycy5wdXNoKCJNZW1iZXJQbGFuSWQiLCB6RGF0YS5YX01lbWJlcl9QbGFuX19jICwgIkNBX0NvdmVyYWdlX0JlbmVmaXRfX2MiLCB6RGF0YS5YX0NvdmVyYWdlX0JlbmVmaXRfX2MgKTsKICAgIGF1dGhBcnJPZlBhaXJzLnB1c2goIkNBX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgYXV0aEFyck9mUGFpcnMucHVzaCgiTmFtZSIsICJhbnlWYWx1ZSIpOwogICAgdmFyIHNwZWNpYWxBdXRoSWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCAiQ2FyZVByZWF1dGgiLCBhdXRoTGFiZWwsIGF1dGhBcnJPZlBhaXJzKTsKICAgIGlmICghc3BlY2lhbEF1dGhJZC5jb250YWlucygiRVJST1IiKSkgewogICAgICAgIHZhciBhdXRoTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiQ2FyZVByZWF1dGgiLCAiTmFtZSIsIG51bGwsIHNwZWNpYWxBdXRoSWQpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiU3BlY2lhbF9BdXRob3JpemF0aW9uX19jIiwgc3BlY2lhbEF1dGhJZCk7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1NwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBzcGVjaWFsQXV0aElkICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1NwZWNpYWxfQXV0aG9yaXphdGlvbl9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIGF1dGhOYW1lICsgZHEgKyAiKTsgIik7CiAgICB9Cn0KLy9DUk4xOTExMTggSWYgd2UgYWxzbyBoYXZlIGEgUGF0aWVudCBhbmQgYSBTcGVjaWFsIEF1dGhvcml6YXRpb24sIGFzc29jaWF0ZSB0aGVtLgppZiAoekRhdGEucGF0aWVudElkICYmIHNwZWNpYWxBdXRoSWQpIHsKICAgIGFsZXJ0KCJAQEAgQXNzb2NpYXRpbmcgU3BlY2lhbCBBdXRob3JpemF0aW9uOiAiICsgc3BlY2lhbEF1dGhJZCArICIgd2l0aCBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgIHZhciBzY3JpcHRBcnJPZlBhaXJzID0gW107CiAgICBzY3JpcHRBcnJPZlBhaXJzLnB1c2goIkNBX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgdXBkYXRlU0ZSZWNvcmQoZG9jLCAiQ2FyZVByZWF1dGgiLCBzcGVjaWFsQXV0aElkLCBzY3JpcHRBcnJPZlBhaXJzKTsKfQoKLy9DUk4xOTExMTQgSGFuZGxlIGFueSBwYXNzZWQtaW4gcGh5c2ljaWFuIChTaG91bGQgdGhpcyBiZSBvbmx5IGZvciBDT01EUjogQ29tbXVuaWNhdGlvbiBmcm9tIFBoeXNpY2lhbj8pCmFsZXJ0KCJAQEBAIHpEYXRhLlhfUGh5c2ljaWFuX19jID0gIiArIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKYWxlcnQoIkBAQEAgWF9QaHlzaWNpYW5fX2MgPSAiICsgWChkb2MsICJYX1BoeXNpY2lhbl9fYyIpKTsKaWYgKFgoZG9jLCAiWF9QaHlzaWNpYW5fX2MiKSkgewogICAgekRhdGEuWF9QaHlzaWNpYW5fX2MgPSBYKGRvYywgIlhfUGh5c2ljaWFuX19jIik7CiAgICBhbGVydCgiQEBAQCB6RGF0YS5YX1BoeXNpY2lhbl9fYyBub3cgPSAiICsgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJQaHlzaWNpYW5fX2MiLCB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7CiAgICB2YXIgcGh5c2ljaWFuTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICBhbGVydCgiQEBAIEF0dGFjaGluZyB0byBQaHlzaWNpYW5fX2Mgd2l0aCBJZDogIiArIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKICAgIGF0dGFjaChkb2MsIHBoeXNpY2lhbkxhYmVsLCB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7Cn0KCi8vUFYxOTEwMDggdXBkYXRlZCBuZXcgZmllbGRzCmlmKHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYykgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIix6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpOwppZiggekRhdGEuWF9aUEFQRVJfX1ByaW9yaXR5X19jKSB7CiAgICBpZiAoIXpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSB7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1ByaW9yaXR5X19jIix6RGF0YS5YX1pQQVBFUl9fUHJpb3JpdHlfX2MpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1ByaW9yaXR5X19jIiwgIiIpOwogICAgfQp9CmlmKCB6RGF0YS5YX1N1Yl9DYXRlZ29yeV9fYyApICBhcnJPZlBhaXJzLnB1c2goIlN1Yl9DYXRlZ29yeV9fYyIsekRhdGEuWF9TdWJfQ2F0ZWdvcnlfX2MpOwppZiggekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fZmF4VHlwZV9fYyIsekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpOwppZiggekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJQcmVzY3JpcHRpb25fX2MiLHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsKaWYoIHpEYXRhLlhfTWVtYmVyX1BsYW5fX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJNZW1iZXJfUGxhbl9fYyIsekRhdGEuWF9NZW1iZXJfUGxhbl9fYyk7CmlmKCB6RGF0YS5YX0NvdmVyYWdlX0JlbmVmaXRfX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJDb3ZlcmFnZV9CZW5lZml0X19jIix6RGF0YS5YX0NvdmVyYWdlX0JlbmVmaXRfX2MpOwppZiggekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyApIHsKICAgIGFyck9mUGFpcnMucHVzaCgiQ2xpbmljYWxfU2VydmljZXNfX2MiLHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwogICAgLy9QVjE5MTExMyBJZiB3ZSBoYXZlIGEgQ2xpbmljYWwgU2VydmljZXMsIGF0dGFjaCB0aGlzIGRvY3VtZW50IHRvIGl0CiAgICB2YXIgY2xpbmljYWxMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGF0dGFjaChkb2MsIGNsaW5pY2FsTGFiZWwsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwp9CmVsc2UgaWYgKCgiTEFCIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiSU5KUiI9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgICAgfHwgIk1FREMiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgJiYgWChkb2MsICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiKSkgeyAgICAgICAgLy9DUk4xOTExMTMgQ3JlYXRlIG5ldyBDbGluaWNhbCBTZXJ2aWNlcyByZWNvcmQgaWYgRG9jVHlwZSBpcyBNRURDIGFuZCB0aGUgU2VydmljZSBSZXF1ZXN0ZWQgRGF0ZSBpcyBmaWxsZWQgaW4KICAgIHZhciBjbGluaWNhbFN2Y0Fyck9mUGFpcnMgPSBbXTsKICAgIHZhciBjbGluaWNhbFN2Y0xhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIkNvcmVfQ2FyZV9QbGFuX19jIiwgekRhdGEuY2FzZUlkKTsKICAgIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycy5wdXNoKCJDb3JlX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOyAKICAgIGlmKCJMYWIgVGVzdHMiPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjVFMDAwMDAwSzI0R1FBUyIpOwogICAgfQogICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIlNlcnZpY2VfUmVxdWVzdGVkX2RhdGVfX2MiLCBYKGRvYywgIlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyIpKTsKICAgIGlmKCJJbmplY3Rpb24gVHJhaW5pbmciPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyNUUwMDAwMDBLMjRMUUFTIik7CiAgICB9CiAgICB2YXIgY2xpbmljYWxTdmNJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLCBjbGluaWNhbFN2Y0xhYmVsLCBjbGluaWNhbFN2Y0Fyck9mUGFpcnMpOwogICAgaWYgKCFjbGluaWNhbFN2Y0lkLmNvbnRhaW5zKCJFUlJPUiIpKSB7CiAgICAgICAgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyA9IGNsaW5pY2FsU3ZjSWQ7CiAgICAgICAgekRhdGEuQ2xpbmljYWxOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOyAvL1BWMTkxMDIyCiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjQ2xpbmljYWxfU2VydmljZXNfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5DbGluaWNhbE5hbWUgKyBkcSArICIpOyAiKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX19jIiwgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7CgogICAgICAgIC8vQ1JOMTkxMTE4IElmIHdlIGFsc28gaGF2ZSBhIFBhdGllbnQgYW5kIGEgQ2xpbmljYWwgU2VydmljZSwgYXNzb2NpYXRlIHRoZW0uCiAgICAgICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgICAgICAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIENsaW5pY2FsIFNlcnZpY2U6ICIgKyBjbGluaWNhbFN2Y0lkICsgIiB3aXRoIFBhdGllbnQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICB2YXIgc2NyaXB0QXJyT2ZQYWlycyA9IFtdOwogICAgICAgICAgICBzY3JpcHRBcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsIGNsaW5pY2FsU3ZjSWQsIHNjcmlwdEFyck9mUGFpcnMpOwogICAgICAgIH0KICAgIH0KfQoKaWYoIHpEYXRhLlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyApICBhcnJPZlBhaXJzLnB1c2goIlNlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiLHpEYXRhLlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyk7CmlmKCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJSZXBvcnRlZF9PdXRjb21lX19jIix6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwppZiggekRhdGEuWF9Bc3Nlc3NtZW50X1R5cGVfX2MgJiYgIkRPTk9UX1NBVkUiICE9PSB6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYykgIGFyck9mUGFpcnMucHVzaCgiQXNzZXNzbWVudF9UeXBlX19jIix6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYyk7CmlmKCB6RGF0YS5YX091dGNvbWVfVHlwZV9fYyAmJiAiRE9OT1RfU0FWRSIgIT09IHpEYXRhLlhfT3V0Y29tZV9UeXBlX19jKSAgYXJyT2ZQYWlycy5wdXNoKCJPdXRjb21lX1R5cGVfX2MiLHpEYXRhLlhfT3V0Y29tZV9UeXBlX19jKTsKaWYoekRhdGEuWF9Qcm9kdWN0X0Rlc2NyaWJlZF9fYykgYXJyT2ZQYWlycy5wdXNoKCJQcm9kdWN0X0Rlc2NyaWJlZF9fYyIsekRhdGEuWF9Qcm9kdWN0X0Rlc2NyaWJlZF9fYyk7CmlmKHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19sYXRlc3RGYXhfX2MiLHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpOwovL0VSUzE5MDgxNCBqdXN0IHRoZSBjaGlsZCAjNjE1MTEgdXBkYXRlU0ZSZWNvcmQoZG9jLCB6RGF0YS56cHMsIHNmU3RhY2tJZCwgYXJyT2ZQYWlycyk7Ci8vbGV0IHRoZSBkb2NTZXQgZG8gdGhlIHdvcmsgYXR0YWNoKGRvYyxhdHRhY2hMYWJlbCwgc2ZTdGFja0lkKTsKLy92YXIgcj11cGRhdGVTRlJlY29yZChkb2MsIlpQQVBFUl9felN0YWNrX19jIixzZlN0YWNrSWQsWyJaUEFQRVJfX3JlY2VpdmVkSWRfX2MiLHpEYXRhLnpQYXJlbnRJZF0pOyAvL0VSUzE5MDgxNCAjNjE1MTEgb3ZlcnJpZGUgdGhlIHNhdmUuanNwIHdvcmtmbG93cwphbGVydCgiQEBAQCB1cGRhdGVkIGFuZCBhdHRhY2hlZCB0byB6U3RhY2sgUmVjb3JkLCBpZCA9ICIgKyBzZlN0YWNrSWQgKyAiPz0iK3pEYXRhLmdldFN0YWNrSWQoZG9jKSsiIGRhdGE9IithcnJPZlBhaXJzKTsKCnZhciBjaGlsZFN0YWNrSWQ9ekRhdGEuY2xpZW50Q2hpbGRTdGFjayhkb2MsYXJyT2ZQYWlycyxzZlN0YWNrSWQpOyAvL0VSUzE5MDgxMCBjcmVhdGUgY2hpbGQgc3RhY2sgZm9yIHNwbGl0IEVSUzE5MDgxMSBjbGllbnRDaGlsZFN0YWNrCmlmIChjaGlsZFN0YWNrSWQpIHthdHRhY2hQYXRoKz0iLCIrc2ZTdGFja0lkKyIsIitjaGlsZFN0YWNrSWQ7IGF0dGFjaFBhdGg9YXR0YWNoUGF0aC5yZXBsYWNlKCIvLD8iLCIvIik7IH0gLy9FUlMxOTA4MTEgIzYxNTcwIGNsZWFuIHVwIC8vcGFyZW50IHN0YWNrIHRvbwphcnJPZlBhaXJzPVtdOy8vUFYxOTEwMjMgRXZlcnl0aW1lIGNoaWxkIHdpbGwgYXR0YWNoIHRvIHRoYXQgcGFydGljdWxhciB6U3RhY2sKYXJyT2ZQYWlycy5wdXNoKCJYX3NmU3RhY2tJZCIsY2hpbGRTdGFja0lkKTsKLy9DUk4xOTExMTggQ2xlYXIgb3V0IHRoZXNlIHZhbHVlcyBmcm9tIHBhcmVudCBzdGFjawphcnJPZlBhaXJzLnB1c2goIlhfaW5kZXhlZFBhZ2VzIiwiIik7CmFyck9mUGFpcnMucHVzaCgiWF9pZ25vcmVkUGFnZXMiLCIiKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3JlamVjdGVkUGFnZXMiLCIiKTsKdXBkYXRlREIoZG9jLGFyck9mUGFpcnMpOwovKiBNb3ZlIHRoZSBzcGxpdCBkb2N1bWVudCB0byBpdHMgcHJvY2Vzc2luZyBmb2xkZXIgKi8KYWxlcnQoIkBAQEBAQCBNb3ZpbmcgdGhlIGluZGV4ZWQgcGFnZXMgZG9jdW1lbnQgaW50byBuZXh0IHByb2Nlc3NpbmcgZm9sZGVyOiAiICsgbmV4dEZvbGRlcik7Ci8vRVJTMTkwNzMxICM2MTI3MiBtb3ZlRG9jdW1lbnQoZG9jLCIiLG5leHRGb2xkZXIpOwovL0VSUzE5MDczMSAjNjEyNzIgcmVsb2FkQnlCQVRFUyhkb2MsIG5leHRGb2xkZXIpOyAvL0VSUzE3MDQxMyAjMzUyOTEKLyogUGxhY2UgdGhlIHNwbGl0IGRvY3VtZW50IGludG8gdGhlIHN0YWNrIGZvbGRlciAqLwphbGVydCgiQEBAQEBAIE1vdmluZyB0aGUgaW5kZXhlZCBwYWdlcyBkb2N1bWVudCBpbnRvIHRoZSBmaW5hbCBzdGFjayBmb2xkZXI6ICIgKyBzdGFja0ZvbGRlcik7Cm1vdmVEb2N1bWVudChkb2MsIiIsc3RhY2tGb2xkZXIpOwp1bmxvY2tEb2N1bWVudChkb2MpOwphcnJPZlBhaXJzID0gekRhdGEuYWRkU3RhZ2UoZG9jLGFyck9mUGFpcnMsekRhdGEuc3RhZ2UpOwp2YXIgcGFnZUNvdW50ID0gekRhdGEuY291bnRQYWdlcyhkb2MscGFnZVJhbmdlKTsKYWxlcnQoIkBAQEAgcGFnZUNvdW50ID0gIiArIHBhZ2VDb3VudCArIiB3ZXJlICIrIHpEYXRhLnN0YWdlKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3BhZ2VzIixwYWdlQ291bnQpOwphcnJPZlBhaXJzLnB1c2goIlhfY291bnQiLHBhZ2VDb3VudCk7IC8vUFYxOTEwMjggdXBkYXRlZCBmb3Igc3RhY2sgY29tcGxldGUgdG8gdXNlIGV4YWN0IHBhZ2VzCmFyck9mUGFpcnMucHVzaCgiZGItcGFnZXMiLHBhZ2VDb3VudCk7Ci8vRVJTMTkwNjIwIGFyck9mUGFpcnMucHVzaCgiZGItbGFiZWwiLCBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBjb21wYW55Q29kZSArICIgLSAiICsgc3RhY2tJZCk7Ci8vYXJyT2ZQYWlycy5wdXNoKCJYX2F0dGFjaGVkVG8iLGF0dGFjaFBhdGgpOyAvL0NSTjE5MTAyOCBXZSBkb24ndCBuZWVkIHRvIHVwZGF0ZSB0aGUgWF9hdHRhY2hlZFRvIGJlY2F1c2UgaXQgaXMgYmVpbmcgc2V0IGNvcnJlY3RseSBkdXJpbmcgZWFjaCBhdHRhY2guIEJlc2lkZXMsIGF0dGFjaFBhdGggaG9sZHMgdGhlIHBhcmVudCdzIG1hc3NhZ2VkIFhfYXR0YWNoZWRUbyB3aGljaCB3ZSBkb24ndCB3YW50LiAvL0VSUzE3MDYyOAp1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7CgovL1BWMTkxMDI5IEFkZCAiSW5kZXhlZCIgdG8gdGhlICJSZWNlaXZlZCIgWF9yZXZpZXdzIGFkZGVkIGluIGNsaWVudCBsaWJyYXJ5IGFib3ZlLgp2YXIgb3JpZ1hSZXZpZXdzID0gWChkb2MsICJYX3Jldmlld3MiKTsKdmFyIG5vdzAgPSBnZXRDdXJEYXRlQW5kVGltZShkb2MpOy8vUHYxOTEwMjkgY2hlY2sgZG9jc2V0IGNoZWNrYm94CmFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld3MiLCBvcmlnWFJldmlld3MgKyAiSW5kZXhlZCBieSBhZ2VudCBhdCAiICsgbm93MCArICI8YnIvPiIpOwp1cGRhdGVEQihkb2MsIGFyck9mUGFpcnMpOwoKdHJhY2soZG9jLCAiRG9jIEluZGV4ZWQiLCAiRG9jdW1lbnQgd2l0aCBJZDogIiArIGRvYy5kYklELCBwYWdlQ291bnQpOwphZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIm5leHRQYWdlKH5yZWFkeX4pO3VwZGF0ZURFU3RhdHVzKH5pbmRleGVkOiIgKyBwYWdlUmFuZ2UgKyAifik7Iik7CgovKiBlbmQgb2YgcnVsZSAqLw=="},"ordinal":11}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
alert("@@@@ Index Rule Fired @@@#");
//ERS190730 #61272 updated button validation in the Actions* Details area

var stackId = X(doc, "X_stack");
if (!stackId) stackId=zData.getStackId(doc); //ERS190624 HACK?
var stackFolder = stackId + "-STACK";
var companyCode = doc.deliveredTo;
zData.stage="Indexed"; //ERS190620

/* Clear the trigger that invoked this rule */
//ERS170909 zData.clearTriggerCondition(doc,"X_buttonAction");
var indexInitialized = X(doc,"X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    zData.initializeStack(doc,stackFolder, companyCode, stackId);
}

saveDEPanelValues(doc);             //CRN191118 Save DE Fields to Parent Stack
zData.getDataEntryFields(doc);
// Does the user want to attach indexed pages to Case?
//var caseId = X(doc, "X_ZPAPER__Case__c");
//var contactId = X(doc, "X_ZPAPER__Patient__c");
//var patientId=contactId; //TODO
//var providerId = X(doc, "X_ZPAPER__Provider__c");
//var patientFirstName = X(doc, "X_ZPAPER__FirstName__c");
//var patientLastName = X(doc, "X_ZPAPER__LastName__c");
//var patientDOB = X(doc, "X_ZPAPER__Birthdate__c");

// Get the document type (will be used to route to next folder)
//var docType = X(doc, "X_Document_Type__c");
var nextFolder = "20500Triage-S2";              // Other folder is the default
var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
//move to after updates arrOfPairs=zData.addStage(doc,arrOfPairs,"Indexed");
updateDB(doc,arrOfPairs);

//var sfStackId=zData.getStackId(doc);
var sfStackId=X(doc,'X_sfStackId');
if(!sfStackId){
  sfStackId=zData.getStackId(doc);  
}

alert("@@@@@@ Currently attached to ZPAPER__zStack__c with ID: " + sfStackId);
zData.zParentId=doc.dbID; //ERS190814 to overside the save.jsp workflows

alert("@@@@ Parent zStack Snippet attached to: " + X(doc, "X_attachedTo"));

/* SPLIT OFF NEW SNIPPET HERE */
var pageRange = X(doc,"X_idxPages");
var newId=splitDocumentForIndex(doc, "index", pageRange);

alert("@@@@ AFTER SPLIT: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));

saveDEPanelValues(doc);             //CRN191118 Also Save DE Fields to Child Stack

alert("ERS190624 newId="+newId);
//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/* Attach the split document to a new Case record, if it wasn't passed in and if we are not handling the 2A DE Panel: Canada_Priority_Data2_Web_Form */
//var priority=X(doc,"X_ZPAPER__Priority__c"); //ERS170626
var label0="";
var triageType=doc.docType;

var attachPath = X(doc,"X_attachedTo");
/* Attach the split document to Patient record if required */ //ERS190619
zData.patientType=XCustomSetting(doc,"ZPAPER__PatientRecord__c"); //ERS190806 ZPAPER__ now in MP
alert("@@@@ zData.patientType ***** "+zData.patientType+" Patient");
alert("@@@ current DE Panel name = " + X(doc, "X_lastDEPanel"));
if (!zData.patientType) zData.patientType="Contact"; //ERS190802 #61272
//if (X(doc,"X_ZPAPER__Patient__c") || zData.X_ZPAPER__LastName__c) { //ERS190803 TODO rethink use X
    var dq = zData.dq = String.fromCharCode(34); //ERS190802 TODO define better in zData
    var patientPhone = X(doc, "X_ZPAPER__Phone__c");
    alert("@@@ patientPhone = " + patientPhone);
    if (!zData.patientId) {
        alert("@@@@ creating new "+zData.patientType+" Patient");
        arrOfPairs = [];
        //ERS190730 #61272 missing the basics
        var p="";
        if ("Account"===zData.patientType) { //ERS190803
            p="Person";
            //arrOfPairs.push("Name", zData.X_ZPAPER__FirstName__c+" "+zData.X_ZPAPER__LastName__c);
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c);
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push(p+"Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        } else {
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c); //X_ZPAPER__FirstName__c //ERS190803 TODO get cleaner #61272
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push("Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        }
        var attachLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
        zData.patientId=zData.clientPatient(doc,arrOfPairs, attachLabel);
        alert("Created Patient with ID: " + zData.patientId);
        if (zData.patientId == "null" || zData.patientId == "NEW") zData.patientId=null;
        else { //ERS190730 #61272 leverage the new record
            if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
            alert("@@@@@@@ NEW PATIENT CREATED WITH ID: " + zData.patientId); //ERS190802 zData.contactId
            // clear out the "New Patient" fields
            if (1===1) { //ERS190811 #61570 commented out so that patient info is available for DE variables in zippi
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Phone__c" + dq + ").val(" + dq + "" + dq + "); ");            
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + "NONE" + dq + "); ");
            }
            // set the Patient lookup fields
            //ERS190803 TODO handle ZPAPER__ relationships //ERS190811 double up for safety
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            //CRN191118 Also save the new values to the child
            var save2DBArrOfPairs = [];
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__c", zData.patientId);
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__r.Name", zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c);
            updateDB(doc, save2DBArrOfPairs);
        }
    } else {
        //if (zData.X_ZPAPER__faxType__c && ("CONS" === zData.X_ZPAPER__faxType__c
         //   || "ENRL" ===zData.X_ZPAPER__faxType__c ||
         //  "MEDO" === zData.X_ZPAPER__faxType__c)) { //ERS19109 #64921 TODO many journey best proctice
            alert("@@@@ attaching to existing Patient: " + zData.patientId);
            if (zData.patientType != "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "FirstName,LastName,Birthdate", null, zData.patientId);
                alert("@@@@ attaching to existing contactFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "FirstName", contactFlds); //PV191006 update the child stack
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "LastName", contactFlds);
                zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "Birthdate", contactFlds);
            } else if (zData.patientType === "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "Name", null, zData.patientId);
                alert("@@@@ attaching to existing AccountFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "Name", contactFlds).split(" ")[0]; //ERS190803 TODO find a better way
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "Name", contactFlds).split(" ")[1];
                //zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "PersonBirthdate", contactFlds);

            }
            //PV191008 updated attachLabel on child stack
            attachLabel=zData.clientFile(doc,"Indexed");
            attach(doc, attachLabel, zData.patientId);
      // }
    }
    if (zData.patientId && attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
//}
alert("@@@@ AFTER PATIENT: Child zStack Snippet attached to: " + attachPath);

var attachLabel=zData.clientFile(doc,"Indexed"); //"Indexed " + formatNow;
alert("ERS190624 attachLabel="+attachLabel);


/* Attach the split document to Lead record if required */ //ERS190619
// TODO ERS190624 flip the if logic
if (doc.wddata.indexOf("X_ZPAPER__ReferralLead__c")>-1) { //ERS190803 TODO rethink
    if (!leadId || 0 === leadId.length) {
        alert("@@@@ creating new Lead");
        arrOfPairs = [];
        leadId=zData.clientLead(doc,arrOfPairs);
        alert("Created Lead with ID: " + leadId);
        if (leadId == "null" || leadId == "NEW") leadId=null;
    } else {
        if (zData.attachRecords.indexOf("Lead")>-1) {
            alert("@@@@ attaching to existing Lead: " + leadId);
            attach(doc, attachLabel, leadId);
        }
    }
    if (leadId && attachPath.indexOf(leadId)==-1) attachPath+=","+leadId;
}
alert("@@@@ AFTER LEAD: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//ERS190620 use a setting to determine which lookups we attach to
/* Attach the split document to Case record if required */ //ERS190619
//if (doc.wddata.indexOf("X_ZPAPER__Case__c")>-1) {
  if(1===1){  
    alert("ERS190624 need Case");
    if (zData.caseId) {        
        if (zData.attachRecords.indexOf("Case")>-1) {
            alert("@@@@ attaching to existing Case: " + zData.caseId);
            attachLabel=zData.clientFile(doc,"Indexed");
            attach(doc, attachLabel, zData.caseId);
        }
    }
    alert("ERS190624.78 have a case?");
    if (zData.caseId && attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}

alert("@@@@ AFTER CASE: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//PV191022 create prescription
var stackFlds = getSFFields(doc, "ZPAPER__zStack__c", "ZPAPER__latestFax__c", null, sfStackId);
zData.X_ZPAPER__latestFax__c =  X(doc, "ZPAPER__latestFax__c", stackFlds); //PV190926 update the child stack
if( zData.X_Prescription__c){
    alert("@@@@ attaching to existing Prescription: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    attach(doc, attachLabel, zData.X_Prescription__c);
}
if( !zData.X_Prescription__c && zData.X_ZPAPER__faxType__c &&"RX" === zData.X_ZPAPER__faxType__c ) { //ERS191109 #64921 TODO many journeys
    alert("@@@@ Creating  Prescription__c with fax Type : " + zData.X_ZPAPER__faxType__c);
    arrOfPairs = [];
    arrOfPairs.push("Core_Date_of_Prescription_Received__c",zData.X_ZPAPER__latestFax__c);
    arrOfPairs.push("Core_ProductPrescribed__c",zData.X_ZPAPER__Classification__c);
    arrOfPairs.push("Core_CarePlan__c", zData.caseId);
    arrOfPairs.push("Core_Patient__c", zData.patientId);
    zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");
    alert("@@@@ Create Prescription__c with ID: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    //attach(doc, attachLabel, zData.X_Prescription__c);
    zData.PrescriptionName = getSFField(doc, "Core_Prescription__c", "Name", null, zData.X_Prescription__c); //PV191022 //ERS191109 clientIndex?
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c" + dq + ").val(" + dq + zData.X_Prescription__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c_Name" + dq + ").val(" + dq + zData.PrescriptionName + dq + "); ");
     
}
//CRN191118 If we also have a patient and a Prescription, associate them.
/*
if (zData.patientId && zData.X_Prescription__c) {
    alert("@@@ Associating Prescription: " + zData.X_Prescription__c + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
    updateSFRecord(doc, "Core_Prescription__c", zData.X_Prescription__c, scriptArrOfPairs);
}
*/

//COMDR
//if( !zData.caseId && ("COMDR" === zData.X_ZPAPER__faxType__c
//     || "MEDC"=== zData.X_ZPAPER__faxType__c || "LAB"=== zData.X_ZPAPER__faxType__c
//     || "INJR"===zData.X_ZPAPER__faxType__c)){
//CRN191114 According to the Abbvie stories, all docTypes except "Consent Forms" need to have a Case created if one isn't already selected
if(!zData.caseId && "CONS" !== zData.X_ZPAPER__faxType__c && 'Canada_Priority_Data2_Web_Form' !== X(doc, "X_lastDEPanel")) {
    arrOfPairs = [];
    arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");               // CRN191114 Always use CarePlan Record Type?
    arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
    if(zData.programName === "Abbvie OneCRM - Canada"){
        arrOfPairs.push("Core_CountryCode__c","CA");
    }
    if (zData.patientId) { arrOfPairs.push("AccountId", zData.patientId); }
   
    zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
    zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    zData.X_Clinical_Services_Record_Type__c = X(doc, "X_Clinical_Services_Record_Type__c");

/*
CRN191113 Moved below where the docType logic isn't so convoluted    
    if("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c){
      arrOfPairs = [];
      if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24GQAS");
      }
      if("injection Training"===zData.X_Clinical_Services_Record_Type__c){
         
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24LQAS");
      }

     //arrOfPairs.push("Service_Requested_date__c",zData.X_Service_Requested_Date__c);
     //arrOfPairs.push("Core_Patient__c",zData.patientId);
     if(!zData.X_Clinical_Services__c){
        associatedArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
        associatedArrOfPairs.push("Core_Patient__c", zData.patientId);
        zData.X_Clinical_Services__c = zData.clientRecordType(doc,"Core_Clinical_Service__c",arrOfPairs,"Index");
     }
     attachLabel=zData.clientFile(doc,"Indexed");
     attach(doc, attachLabel,  zData.X_Clinical_Services__c);
     zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
    }
    */
}

//COPAY
if ("COPAY" === zData.X_ZPAPER__faxType__c) {
    arrOfPairs = [];
    arrOfPairs.push("CA_Patient__c",zData.patientId);
    arrOfPairs.push("CA_CarePlanID__c",zData.caseId);
    zData.copayId = zData.clientRecordType(doc,"CA_Copay__c",arrOfPairs,"Index");
}


//OTH
if( !zData.caseId && ("OTH" === zData.X_ZPAPER__faxType__c || "ENRL" === zData.X_ZPAPER__faxType__c
    || "MEDO" === zData.X_ZPAPER__faxType__c || "RX" === zData.X_ZPAPER__faxType__c )){
    arrOfPairs = [];
    arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");
    arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
    if(zData.programName === "Abbvie OneCRM - Canada"){
        arrOfPairs.push("Core_CountryCode__c","CA");
    }    
   
    zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
    zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
}

if( zData.X_Reported_Outcome__c){
    alert("@@@@ attaching to existing Outcome: " + zData.X_Reported_Outcome__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    attach(doc, attachLabel, zData.X_Reported_Outcome__c);
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating Reported Cutcome: " + zData.X_Reported_Outcome__c + " with Patient: " + zData.patientId);
        var outcomeArrOfPairs = [];
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
        updateSFRecord(doc, "Core_Patient_Reported_Outcomes__c", zData.X_Reported_Outcome__c, outcomeArrOfPairs);
    }
}
else if ("CA" === zData.X_ZPAPER__faxType__c) {
    var outcomeArrOfPairs = [];
    outcomeArrOfPairs.push("Core_Entry_Date__c", getCurDate(doc));
    outcomeArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    var assessmentType = X(doc, "X_Assessment_Type__c");
    if (assessmentType && "DONOT_SAVE" !== assessmentType) {
        outcomeArrOfPairs.push("Core_Assessment_Type__c", assessmentType);
    }
    var outcomeType = X(doc, "X_Outcome_Type__c");
    if (outcomeType && "DONOT_SAVE" !== outcomeType) {
        outcomeArrOfPairs.push("Core_Outcome_Type__c", outcomeType);
    }
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating New Reported Cutcome with Patient: " + zData.patientId);
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    }
    zData.X_Reported_Outcome__c = zData.clientRecordType(doc,"Core_Patient_Reported_Outcomes__c",outcomeArrOfPairs,"Index");
    var outcomeName = getSFField(doc, "Core_Patient_Reported_Outcomes__c", "Name", null, zData.X_Reported_Outcome__c);
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c" + dq + ").val(" + dq + zData.X_Reported_Outcome__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c_Name" + dq + ").val(" + dq + outcomeName + dq + "); ");
}


arrOfPairs = [];
if (zData.docType) { arrOfPairs.push("ZPAPER__faxType__c", zData.docType);  } //ERS190810 PV190808 #51670
if (zData.providerId) {
    arrOfPairs.push("ZPAPER__Provider__c", zData.providerId);
    if (attachPath.indexOf(zData.providerId)==-1) attachPath+=","+zData.providerId;
}
alert("ERS190812.200 zData.patientId="+zData.patientId); //ERS190812 #61511
if (zData.patientId) {
    if (zData.patientId.indexOf("003")===0) arrOfPairs.push("ZPAPER__Patient__c", zData.patientId);
    if (zData.patientId.indexOf("001")===0) arrOfPairs.push("ZPAPER__PatientAccount__c", zData.patientId);
    if (zData.patientId.indexOf("00Q")===0) arrOfPairs.push("ZPAPER__ReferralLead__c", zData.patientId); //ERS190802 Lead
    if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
    if (1===1) { //ERS190810 PV190808 data entry for next split
        if (zData.X_ZPAPER__FirstName__c) { arrOfPairs.push("ZPAPER__FirstName__c", zData.X_ZPAPER__FirstName__c); }
        if (zData.X_ZPAPER__LastName__c) { arrOfPairs.push("ZPAPER__LastName__c", zData.X_ZPAPER__LastName__c); }  
        if (zData.X_ZPAPER__Birthdate__c) { arrOfPairs.push("ZPAPER__Birthdate__c", zData.X_ZPAPER__Birthdate__c); }
        if (zData.X_ZPAPER__Status__c) {arrOfPairs.push(zp+"Status__c", "Completed"); } //PV191023 updateing status
    }
}
if (zData.caseId) {
    arrOfPairs.push("ZPAPER__Case__c", zData.caseId);
    if (attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}
 alert("@@@@ zData.contactId = " + zData.contactId);
if (zData.contactId && zData.contactId.startsWith("003")) {
   
    arrOfPairs.push("ZPAPER__Patient__c", zData.contactId);
}
if (zData.leadId) {
    arrOfPairs.push("ZPAPER__ReferralLead__c", zData.leadId);
    if (attachPath.indexOf(zData.leadId)==-1) attachPath+=","+zData.leadId;
}
if (zData.referralId) {
    arrOfPairs.push("ZPAPER__Referral__c", zData.referralId);
    if (attachPath.indexOf(zData.referralId)==-1) attachPath+=","+zData.referralId;
}
if (zData.X_ZPAPER__Phone__c) { //PV191006 UPDATED FOR PHONE
    arrOfPairs.push("ZPAPER__Phone__c", zData.X_ZPAPER__Phone__c);
   
}
var specialAuthId = X(doc, "X_Special_Authorization__c");
alert("@@@ zData.X_Special_Authorization__c " + specialAuthId);
var authDocType = X(doc, "ZPAPER__faxType__c");
if (specialAuthId) {
    arrOfPairs.push("Special_Authorization__c", specialAuthId);
    //PV191113 If we have a Special Authorization, attach this document to it
    var specialLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    attach(doc, specialLabel, specialAuthId);
}
else if ("SA" === zData.X_ZPAPER__faxType__c) { 
    var authArrOfPairs = [];
    var authLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    authArrOfPairs.push("MemberPlanId", zData.X_Member_Plan__c , "CA_Coverage_Benefit__c", zData.X_Coverage_Benefit__c );
    authArrOfPairs.push("CA_Patient__c", zData.patientId);
    authArrOfPairs.push("Name", "anyValue");
    var specialAuthId = createAndAttach(doc, "CarePreauth", authLabel, authArrOfPairs);
    if (!specialAuthId.contains("ERROR")) {
        var authName = getSFField(doc, "CarePreauth", "Name", null, specialAuthId);
        arrOfPairs.push("Special_Authorization__c", specialAuthId);
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c" + dq + ").val(" + dq + specialAuthId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c_Name" + dq + ").val(" + dq + authName + dq + "); ");
    }
}
//CRN191118 If we also have a Patient and a Special Authorization, associate them.
if (zData.patientId && specialAuthId) {
    alert("@@@ Associating Special Authorization: " + specialAuthId + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("CA_Patient__c", zData.patientId);
    updateSFRecord(doc, "CarePreauth", specialAuthId, scriptArrOfPairs);
}

//CRN191114 Handle any passed-in physician (Should this be only for COMDR: Communication from Physician?)
alert("@@@@ zData.X_Physician__c = " + zData.X_Physician__c);
alert("@@@@ X_Physician__c = " + X(doc, "X_Physician__c"));
if (X(doc, "X_Physician__c")) {
    zData.X_Physician__c = X(doc, "X_Physician__c");
    alert("@@@@ zData.X_Physician__c now = " + zData.X_Physician__c);
    arrOfPairs.push("Physician__c", zData.X_Physician__c);
    var physicianLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    alert("@@@ Attaching to Physician__c with Id: " + zData.X_Physician__c);
    attach(doc, physicianLabel, zData.X_Physician__c);
}

//PV191008 updated new fields
if(zData.X_ZPAPER__Classification__c) arrOfPairs.push("ZPAPER__Classification__c",zData.X_ZPAPER__Classification__c);
if( zData.X_ZPAPER__Priority__c) {
    if (!zData.X_ZPAPER__faxType__c) {
        arrOfPairs.push("ZPAPER__Priority__c",zData.X_ZPAPER__Priority__c);
    }
    else {
        arrOfPairs.push("ZPAPER__Priority__c", "");
    }
}
if( zData.X_Sub_Category__c )  arrOfPairs.push("Sub_Category__c",zData.X_Sub_Category__c);
if( zData.X_ZPAPER__faxType__c)  arrOfPairs.push("ZPAPER__faxType__c",zData.X_ZPAPER__faxType__c);
if( zData.X_Prescription__c )  arrOfPairs.push("Prescription__c",zData.X_Prescription__c);
if( zData.X_Member_Plan__c )  arrOfPairs.push("Member_Plan__c",zData.X_Member_Plan__c);
if( zData.X_Coverage_Benefit__c )  arrOfPairs.push("Coverage_Benefit__c",zData.X_Coverage_Benefit__c);
if( zData.X_Clinical_Services__c ) {
    arrOfPairs.push("Clinical_Services__c",zData.X_Clinical_Services__c);
    //PV191113 If we have a Clinical Services, attach this document to it
    var clinicalLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    attach(doc, clinicalLabel, zData.X_Clinical_Services__c);
}
else if (("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c) && X(doc, "X_Service_Requested_Date__c")) {        //CRN191113 Create new Clinical Services record if DocType is MEDC and the Service Requested Date is filled in
    var clinicalSvcArrOfPairs = [];
    var clinicalSvcLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    clinicalSvcArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    clinicalSvcArrOfPairs.push("Core_Patient__c", zData.patientId); 
    if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24GQAS");
    }
    clinicalSvcArrOfPairs.push("Service_Requested_date__c", X(doc, "X_Service_Requested_Date__c"));
    if("Injection Training"===zData.X_Clinical_Services_Record_Type__c){
        clinicalSvcArrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24LQAS");
    }
    var clinicalSvcId = createAndAttach(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    if (!clinicalSvcId.contains("ERROR")) {
        zData.X_Clinical_Services__c = clinicalSvcId;
        zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
        arrOfPairs.push("Clinical_Services__c", zData.X_Clinical_Services__c);

        //CRN191118 If we also have a Patient and a Clinical Service, associate them.
        if (zData.patientId) {
            alert("@@@ Associating Clinical Service: " + clinicalSvcId + " with Patient: " + zData.patientId);
            var scriptArrOfPairs = [];
            scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
            updateSFRecord(doc, "Core_Clinical_Service__c", clinicalSvcId, scriptArrOfPairs);
        }
    }
}

if( zData.X_Service_Requested_Date__c )  arrOfPairs.push("Service_Requested_Date__c",zData.X_Service_Requested_Date__c);
if( zData.X_Reported_Outcome__c )  arrOfPairs.push("Reported_Outcome__c",zData.X_Reported_Outcome__c);
if( zData.X_Assessment_Type__c && "DONOT_SAVE" !== zData.X_Assessment_Type__c)  arrOfPairs.push("Assessment_Type__c",zData.X_Assessment_Type__c);
if( zData.X_Outcome_Type__c && "DONOT_SAVE" !== zData.X_Outcome_Type__c)  arrOfPairs.push("Outcome_Type__c",zData.X_Outcome_Type__c);
if(zData.X_Product_Described__c) arrOfPairs.push("Product_Described__c",zData.X_Product_Described__c);
if(zData.X_ZPAPER__latestFax__c) arrOfPairs.push("ZPAPER__latestFax__c",zData.X_ZPAPER__latestFax__c);
//ERS190814 just the child #61511 updateSFRecord(doc, zData.zps, sfStackId, arrOfPairs);
//let the docSet do the work attach(doc,attachLabel, sfStackId);
//var r=updateSFRecord(doc,"ZPAPER__zStack__c",sfStackId,["ZPAPER__receivedId__c",zData.zParentId]); //ERS190814 #61511 override the save.jsp workflows
alert("@@@@ updated and attached to zStack Record, id = " + sfStackId + "?="+zData.getStackId(doc)+" data="+arrOfPairs);

var childStackId=zData.clientChildStack(doc,arrOfPairs,sfStackId); //ERS190810 create child stack for split ERS190811 clientChildStack
if (childStackId) {attachPath+=","+sfStackId+","+childStackId; attachPath=attachPath.replace("/,?","/"); } //ERS190811 #61570 clean up //parent stack too
arrOfPairs=[];//PV191023 Everytime child will attach to that particular zStack
arrOfPairs.push("X_sfStackId",childStackId);
//CRN191118 Clear out these values from parent stack
arrOfPairs.push("X_indexedPages","");
arrOfPairs.push("X_ignoredPages","");
arrOfPairs.push("X_rejectedPages","");
updateDB(doc,arrOfPairs);
/* Move the split document to its processing folder */
alert("@@@@@@ Moving the indexed pages document into next processing folder: " + nextFolder);
//ERS190731 #61272 moveDocument(doc,"",nextFolder);
//ERS190731 #61272 reloadByBATES(doc, nextFolder); //ERS170413 #35291
/* Place the split document into the stack folder */
alert("@@@@@@ Moving the indexed pages document into the final stack folder: " + stackFolder);
moveDocument(doc,"",stackFolder);
unlockDocument(doc);
arrOfPairs = zData.addStage(doc,arrOfPairs,zData.stage);
var pageCount = zData.countPages(doc,pageRange);
alert("@@@@ pageCount = " + pageCount +" were "+ zData.stage);
arrOfPairs.push("X_pages",pageCount);
arrOfPairs.push("X_count",pageCount); //PV191028 updated for stack complete to use exact pages
arrOfPairs.push("db-pages",pageCount);
//ERS190620 arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + stackId);
//arrOfPairs.push("X_attachedTo",attachPath); //CRN191028 We don't need to update the X_attachedTo because it is being set correctly during each attach. Besides, attachPath holds the parent's massaged X_attachedTo which we don't want. //ERS170628
updateDB(doc,arrOfPairs);

//PV191029 Add "Indexed" to the "Received" X_reviews added in client library above.
var origXReviews = X(doc, "X_reviews");
var now0 = getCurDateAndTime(doc);//Pv191029 check docset checkbox
arrOfPairs = [];
arrOfPairs.push("X_reviews", origXReviews + "Indexed by agent at " + now0 + "<br/>");
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");

/* end of rule */
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
dmFyIERFX1BBTkVMX0ZPUk1fMkEgICAgPSAiQ2FuYWRhX1ByaW9yaXR5X0RhdGEyX1dlYl9Gb3JtIjsNCnZhciBERV9QQU5FTF9GT1JNXzJCICAgID0gIk9uZV9DUk1fQ2FuYWRhX0luZGV4X0RhdGEyX1dlYl9Gb3JtIjsNCg0KLyoNCjxvcHRpb24gdmFsdWU9IkRPTk9UX1NBVkUiPjwvb3B0aW9uPg0KPG9wdGlvbiB2YWx1ZT0iT1RIIj5PVEg6T3RoZXIgRG9jdW1lbnRzPC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJFTlJMIj5FTlJMOkVucm9sbG1lbnQ8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9Ik1FRE8iPk1FRE86IE1lZGljYWwgT3RoZXI8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkNPTlMiPkNPTlM6IENvbnNlbnQ8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkNPTURSIj5DT01EUjogQ29tbXVuaWNhdGlvbiBmcm9tIFBoeXNpY2lhbjwvb3B0aW9uPg0KPG9wdGlvbiB2YWx1ZT0iUlgiPlJYOiBQcmVzY3JpcHRpb248L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IlNBIj5TQTogU3BlY2lhbCBBdXRob3JpemF0aW9uPC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJNRURDIj5NRURDOiBNZWRpY2FsIENsYXJpZmljYXRpb248L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkxBQiI+TEFCOiBMYWIgRG9jdW1lbnRzPC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJJTkpSIj5JTkpSOiBJbmplY3Rpb24gUmVwb3J0PC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJDQSI+Q0E6IENsaW5pY2FsIEFzc2Vzc21lbnQ8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkNPUEFZIj5DT1BBWTogQ29wYXk8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IlVOOlVua25vd24iPlVOOlVua25vd248L29wdGlvbj4NCnZhciBmb3JtMkJWYWxpZGF0aW9ucyA9IHsNCiAgICAiT1RIIjogew0KICAgICAgICAicmVxRmllbGRzIjogWw0KICAgICAgICAgICAgeyJuYW1lIjogIiIsICJsYWJlbCI6ICIifQ0KICAgICAgICBdDQogICAgfSwNCiAgICAiTUVEQyI6IG51bGwsDQogICAgIkxBQiI6IG51bGwsDQogICAgIklOSlIiOiBudWxsDQp9DQoqLw0KLy8gV2UnbGwgZmlsbCB0aGlzIGluIHdpdGggYSByZXFGaWVsZHMgbWVtYmVyIGFzIHRoZSBleGFtcGxlIGFib3ZlDQp2YXIgZm9ybTJCVmFsaWRhdGlvbnMgPSB7DQogICAgIkNPTlMiOiAgbnVsbCwNCiAgICAiRU5STCI6IG51bGwsDQogICAgIk1FRE8iOiBudWxsLA0KICAgICJPVEgiOiBudWxsLA0KICAgICJDT01EUiI6IHsNCiAgICAgICAgInJlcUZpZWxkcyI6IFsNCiAgICAgICAgICAgIHsibmFtZSI6ICJYX1BoeXNpY2lhbl9fYyIsICJsYWJlbCI6ICJQaHlzaWNpYW4iLCAiZWxlTmFtZSI6ICJYX1BoeXNpY2lhbl9fci5OYW1lIn0NCiAgICAgICAgXQ0KICAgIH0sDQogICAgIlNBIjogbnVsbCwNCiAgICAiTUVEQyI6IHsNCiAgICAgICAgInJlcUZpZWxkcyI6IFsNCiAgICAgICAgICAgIHsibmFtZSI6ICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiLCAibGFiZWwiOiAiU2VydmljZSBSZXF1ZXN0ZWQgRGF0ZSIsICJlbGVOYW1lIjogIlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyJ9DQogICAgICAgIF0NCiAgICB9LA0KICAgICJMQUIiOiB7DQogICAgICAgICJyZXFGaWVsZHMiOiBbDQogICAgICAgICAgICB7Im5hbWUiOiAiWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIiwgImxhYmVsIjogIlNlcnZpY2UgUmVxdWVzdGVkIERhdGEiLCAiZWxlTmFtZSI6ICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MifQ0KICAgICAgICBdDQogICAgfSwNCiAgICAiSU5KUiI6IG51bGwsDQogICAgIkNBIjogew0KICAgICAgICAicmVxRmllbGRzIjogWw0KICAgICAgICAgICAgeyJuYW1lIjogIlhfQXNzZXNzbWVudF9UeXBlX19jIiwgImxhYmVsIjogIkFzc2Vzc21lbnQgVHlwZSIsICJlbGVOYW1lIjogIlhfQXNzZXNzbWVudF9UeXBlX19jIn0sDQogICAgICAgICAgICB7Im5hbWUiOiAiWF9PdXRjb21lX1R5cGVfX2MiLCAibGFiZWwiOiAiT3V0Y29tZSBUeXBlIiwgImVsZU5hbWUiOiAiWF9PdXRjb21lX1R5cGVfX2MifQ0KICAgICAgICBdDQogICAgfSwNCiAgICAiQ09QQVkiOiBudWxsDQp9Ow0KDQpTdHJpbmcucHJvdG90eXBlLmFwcGVuZCA9IGZ1bmN0aW9uIChhcHBlbmRTdHIpIHsNCiAgICByZXR1cm4gYXBwZW5kU3RyID8gdGhpcyArICh0aGlzLmxlbmd0aCA+IDAgPyAiLCAiIDogIiIpICsgYXBwZW5kU3RyIDogdGhpczsNCn07DQoNCmZ1bmN0aW9uIGRvVmFsaWRhdGlvbigpIHsNCiAgICBkZWJ1Z2dlcjsNCiAgICBjb25zb2xlLmxvZygiQ3VycmVudCBERSBQYW5lbCA9ICIgKyBfY3VyREVQYW5lbCk7DQogICAgLy9DUk4xOTExMTQgRmlyc3QgY2xlYXIgdGhlIHN0eWxlcyBvZiBhbGwgaW5wdXQgZmllbGRzIGFuZCBnYXRoZXIgZmllbGQgdmFsdWVzDQogICAgdmFyIGZpZWxkcyA9IHt9Ow0KICAgICQoJy5iaWdEYXRhRW50cnknKS5lYWNoKGZ1bmN0aW9uKCkgew0KICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOw0KICAgICAgICBmaWVsZHNbdGhpcy5uYW1lXSA9ICR0aGlzLnZhbCgpOw0KICAgICAgICBpZiAoJ2hpZGRlbicgIT0gJHRoaXMuYXR0cigndHlwZScpKSB7DQogICAgICAgICAgICAkdGhpcy5jc3MoJ2JvcmRlcicsJ21lZGl1bSBub25lJyk7DQogICAgICAgIH0NCiAgICB9KTsNCiAgICANCiAgICB2YXIgcmVxQnVmZmVyID0gIiI7DQogICAgdmFyIGRvY1R5cGUgPSAkKCdbbmFtZT0iWF9aUEFQRVJfX2ZheFR5cGVfX2MiXScpLnZhbCgpOw0KICAgIA0KICAgIGlmIChERV9QQU5FTF9GT1JNXzJBID09PSBfY3VyREVQYW5lbCkgew0KICAgICAgICAvLyBQYW5lbCBBIFZhbGlkYXRpb25zIEhlcmUNCiAgICAgICAgcmVxQnVmZmVyID0gZG8yQVZhbGlkYXRpb25zKGZpZWxkcywgcmVxQnVmZmVyKTsNCiAgICB9DQogICAgZWxzZSBpZiAoREVfUEFORUxfRk9STV8yQiA9PT0gX2N1ckRFUGFuZWwpIHsNCiAgICAgICAgLy8gUGFuZWwgQiBWYWxpZGF0aW9ucyBIZXJlDQogICAgICAgIC8vIFRlc3QgdGhlIGZpZWxkcyB0aGF0IEFMV0FZUyByZXF1aXJlZA0KICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZTJCQWx3YXlzUmVxdWlyZWRGaWVsZHMoZmllbGRzLCByZXFCdWZmZXIpOw0KICAgICAgICAvLyBUaGVzZSBkb2NUeXBlcyByZXF1aXJlIHNwZWNpYWwgaGFuZGxpbmcgdGhhdCBpc24ndCBzaW1wbGUgbGlzdCBvZiByZXF1aXJlZCBmaWVsZHMuDQogICAgICAgIC8vIFNwZWNpYWwgQXV0aG9yaXphdGlvbiByZXF1aXJlcyBzcGVjaWFsIGhhbmRsaW5nIHRoYXQgaXNuJ3Qgc2ltcGxlIGxpc3Qgb2YgcmVxdWlyZWQgZmllbGRzLg0KICAgICAgICBpZiAoIlNBIiA9PT0gZG9jVHlwZSkgew0KICAgICAgICAgICAgcmVxQnVmZmVyID0gdmFsaWRhdFNwZWNpYWxBdXRob3JpemF0aW9uKGZpZWxkcywgcmVxQnVmZmVyKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICgoIkxBQiIgPT09IGRvY1R5cGUgfHwgIk1FREMiID09PSBkb2NUeXBlKSkgew0KICAgICAgICAgICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX0NsaW5pY2FsX1NlcnZpY2VzX19jIl0pKSB7DQogICAgICAgICAgICAgICAgdmFyIHJlcUZpZWxkc09iaiA9IGZvcm0yQlZhbGlkYXRpb25zW2RvY1R5cGVdOw0KICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHMgPSByZXFGaWVsZHNPYmogPyByZXFGaWVsZHNPYmoucmVxRmllbGRzIDogbnVsbDsNCiAgICAgICAgICAgICAgICBpZiAocmVxRmllbGRzKSB7DQogICAgICAgICAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHZhbGlkYXRlRm9yRG9jdW1lbnRUeXBlKHJlcUZpZWxkcywgZmllbGRzLCByZXFCdWZmZXIpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKCJDQSIgPT09IGRvY1R5cGUpIHsNCiAgICAgICAgICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9SZXBvcnRlZF9PdXRjb21lX19jIl0pKSB7DQogICAgICAgICAgICAgICAgdmFyIHJlcUZpZWxkc09iaiA9IGZvcm0yQlZhbGlkYXRpb25zW2RvY1R5cGVdOw0KICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHMgPSByZXFGaWVsZHNPYmogPyByZXFGaWVsZHNPYmoucmVxRmllbGRzIDogbnVsbDsNCiAgICAgICAgICAgICAgICBpZiAocmVxRmllbGRzKSB7DQogICAgICAgICAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHZhbGlkYXRlRm9yRG9jdW1lbnRUeXBlKHJlcUZpZWxkcywgZmllbGRzLCByZXFCdWZmZXIpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgdmFyIHJlcUZpZWxkc09iaiA9IGZvcm0yQlZhbGlkYXRpb25zW2RvY1R5cGVdOw0KICAgICAgICAgICAgdmFyIHJlcUZpZWxkcyA9IHJlcUZpZWxkc09iaiA/IHJlcUZpZWxkc09iai5yZXFGaWVsZHMgOiBudWxsOw0KICAgICAgICAgICAgaWYgKHJlcUZpZWxkcykgew0KICAgICAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHZhbGlkYXRlRm9yRG9jdW1lbnRUeXBlKHJlcUZpZWxkcywgZmllbGRzLCByZXFCdWZmZXIpDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBpZiAocmVxQnVmZmVyLmxlbmd0aCA+IDApIHsNCiAgICAgICAgYWxlcnQoIkVSUk9SOiBUaGUgZm9sbG93aW5nIGZpZWxkcyBhcmUgcmVxdWlyZWQ6ICIgKyByZXFCdWZmZXIpOw0KICAgICAgICByZXR1cm4gZmFsc2U7ICAgLy9vbmUgb3IgbW9yZSBmaWVsZCBpcyBtaXNzaW5nLCBkb24ndCBzZW5kIHRvIHRoZSBydWxlcyBlbmdpbmUNCiAgICB9DQogICAgLy8gTWFrZSBzdXJlIHdlIHNlbmQgdGhlIGN1cnJlbnQgREUgUGFuZWwgdG8gdGhlIHJ1bGVzDQogICAgJCgnI2RhdGFFbnRyeUZvcm0nKS5hcHBlbmQoIjxpbnB1dCB0eXBlPSdoaWRkZW4nIGNsYXNzPSdiaWdEYXRhRW50cnknIG5hbWU9J1hfbGFzdERFUGFuZWwnIHZhbHVlPSciICsgX2N1ckRFUGFuZWwgKyAiJz4iKTsNCiAgICByZXR1cm4gdHJ1ZTsgICAgICAgIC8vQWxsIHJlcXVpcmVkIGZpZWxkcyBoYXZlIGJlZW4gc3VwcGxpZWQsIGxldCB0aGUgcnVsZXMgZW5naW5lIGJlIG5vdGlmaWVkDQp9DQoNCmZ1bmN0aW9uIGlzQmxhbmsodmFsKSB7DQogICAgcmV0dXJuICF2YWwgfHwgIk5PTkUiID09PSB2YWwgfHwgIkRPTk9UX1NBVkUiID09PSB2YWw7DQp9DQoNCmZ1bmN0aW9uIGlzTm90QmxhbmsodmFsKSB7DQogICAgcmV0dXJuIHZhbCAmJiAiTk9ORSIgIT09IHZhbCAmJiAiRE9OT1RfU0FWRSIgIT09IHZhbDsNCn0NCg0KZnVuY3Rpb24gbWFya01pc3NpbmcobmFtZSwgaWQpIHsNCiAgICB2YXIgJGVsZSA9IG5hbWUgPyAkKCdbbmFtZT0iJyArIG5hbWUgKyAnIl0nKSA6ICQoJyMnICsgaWQpOw0KICAgICRlbGUuY3NzKCdib3JkZXInLCczcHggc29saWQgcmVkJyk7DQp9DQoNCmZ1bmN0aW9uIGRvMkFWYWxpZGF0aW9ucyhmaWVsZHMsIHJlcUJ1ZmZlcikgew0KICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIl0pKSB7DQogICAgICAgIHZhciBsYXN0TmFtZSA9IGZpZWxkc1siWF9aUEFQRVJfX0xhc3ROYW1lX19jIl07DQogICAgICAgIHZhciBmaXJzdE5hbWUgPSBmaWVsZHNbIlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiXTsNCiAgICAgICAgdmFyIGJpcnRoRGF0ZSA9IGZpZWxkc1siWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyJdOw0KICAgICAgIA0KICAgICAgICBpZihpc0JsYW5rKGxhc3ROYW1lKSkgew0KICAgICAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOw0KICAgICAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiTGFzdCBOYW1lIik7DQogICAgICAgIH0NCiAgICAgICAgaWYoaXNCbGFuayhmaXJzdE5hbWUpKSB7DQogICAgICAgICAgICBtYXJrTWlzc2luZygiWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyIpOw0KICAgICAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiRmlyc3QgTmFtZSIpOw0KICAgICAgICB9DQogICAgICAgIGlmKGlzQmxhbmsoYmlydGhEYXRlKSkgew0KICAgICAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MiKTsNCiAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIkJpcnRoIERhdGUiKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBwcmlvcml0eURlICA9IGZpZWxkc1siWF9aUEFQRVJfX1ByaW9yaXR5X19jIl07DQogICAgICAgIGlmKGlzQmxhbmsocHJpb3JpdHlEZSkgfHwgIlVuYXNzaWduZWQiID09PSBwcmlvcml0eURlKSB7DQogICAgICAgICAgICBtYXJrTWlzc2luZygiWF9aUEFQRVJfX1ByaW9yaXR5X19jIik7DQogICAgICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJQcmlvcml0eSBtdXN0IGJlIGVpdGhlciBIaWdoLCBNZWRpdW0sIG9yIExvdyIpOw0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXFCdWZmZXI7DQp9DQoNCi8qKg0KICogUmVxdWlyZWQgZmllbGRzIGZvciAyQiBGb3JtczogQ2xhc3NpZmljYXRpb24sIFByaW9yaXR5LCBQYXRpZW50LCBEb2N1bWVudCBUeXBlLCBhbmQgU3ViLUNhdGVnb3J5DQogKi8NCmZ1bmN0aW9uIHZhbGlkYXRlMkJBbHdheXNSZXF1aXJlZEZpZWxkcyhmaWVsZHMsIHJlcUJ1ZmZlcikgew0KICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIl0pKSB7DQogICAgICAgIG1hcmtNaXNzaW5nKCJYX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiKTsNCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiQ2xhc3NpZmljYXRpb24iKTsNCiAgICB9DQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19Qcmlvcml0eV9fYyIpOw0KICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJQcmlvcml0eSIpOw0KICAgIH0gICAgDQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fci5OYW1lIik7DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIlBhdGllbnQiKTsNCiAgICB9ICAgIA0KICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX2ZheFR5cGVfX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19mYXhUeXBlX19jIik7DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIkRvY3VtZW50IFR5cGUiKTsNCiAgICB9DQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1N1Yl9DYXRlZ29yeV9fYyJdKSkgew0KICAgICAgICBtYXJrTWlzc2luZygiWF9TdWJfQ2F0ZWdvcnlfX2MiKTsNCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiU3ViLUNhdGVnb3J5Iik7DQogICAgfQ0KICAgIHJldHVybiByZXFCdWZmZXI7DQp9DQoNCmZ1bmN0aW9uIHZhbGlkYXRlRm9yRG9jdW1lbnRUeXBlKHJlcUZpZWxkcywgZmllbGRzLCByZXFCdWZmZXIpIHsNCiAgICBmb3IgKHZhciBpIGluIHJlcUZpZWxkcykgew0KICAgICAgICBpZiAocmVxRmllbGRzLmhhc093blByb3BlcnR5KGkpKSB7DQogICAgICAgICAgICB2YXIgcmVxRmllbGQgPSByZXFGaWVsZHNbaV07DQogICAgICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbcmVxRmllbGQubmFtZV0pKSB7DQogICAgICAgICAgICAgICAgbWFya01pc3NpbmcocmVxRmllbGQuZWxlTmFtZSk7DQogICAgICAgICAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZChyZXFGaWVsZC5sYWJlbCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHJlcUJ1ZmZlcjsNCn0NCg0KLyoqDQogKiBUaGUgdmFsaWRhdGlvbiBmb3IgdGhpcyBEb2N1bWVudCBUeXBlIG5lZWRzIHRvIGJlIHVuaXF1ZSBzaW5jZSBub3QgYWxsIGZpZWxkcyBhcmUgcmVxdWlyZWQsIGp1c3QgYSBjZXJ0YWluIGNvbWJpbmF0aW9uLg0KICovDQpmdW5jdGlvbiB2YWxpZGF0U3BlY2lhbEF1dGhvcml6YXRpb24oZmllbGRzLCByZXFCdWZmZXIpIHsNCiAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfU3BlY2lhbF9BdXRob3JpemF0aW9uX19jIl0pICYmIChpc0JsYW5rKGZpZWxkc1siWF9NZW1iZXJfUGxhbl9fYyJdKSB8fCBpc0JsYW5rKGZpZWxkc1siWF9Db3ZlcmFnZV9CZW5lZml0X19jIl0pKSkgew0KICAgICAgICBtYXJrTWlzc2luZyhudWxsLCAiU3BlY2lhbF9BdXRob3JpemF0aW9uX19jX05hbWUiKTsNCiAgICAgICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX01lbWJlcl9QbGFuX19jIl0pKSB7DQogICAgICAgICAgICBtYXJrTWlzc2luZyhudWxsLCAiTWVtYmVyX1BsYW5fX2NfTmFtZSIpOw0KICAgICAgICB9DQogICAgICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9Db3ZlcmFnZV9CZW5lZml0X19jIl0pKSB7DQogICAgICAgICAgICBtYXJrTWlzc2luZygiWF9Db3ZlcmFnZV9CZW5lZml0X19jIik7DQogICAgICAgIH0NCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiRWl0aGVyIFNwZWNpYWwgQXV0aG9yaXphdGlvbiBvciBib3RoIE1lbWJlciBQbGFuIGFuZCBDb3ZlcmFnZSBCZW5lZml0Iik7DQogICAgfQ0KICAgIHJldHVybiByZXFCdWZmZXI7DQp9DQoNCnJldHVybiBkb1ZhbGlkYXRpb24oKTsNCg==
//--- RULE VALIDATION CODE - END ---

</script>
