<!--
// Name: Index Page
// Committer: cory.newey@zpaper.com
// Update: added debug info
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2020-05-05 19:59:24","active":true,"button":"Index","name":"Index Page","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Index","operation":"equals"}]},"consequence":{"doit":"Ly9BU00gMjAyMC0wMS0wOSAtIEZpeGVzIGZpZWxkIGZvciBiaXJ0aGRhdGUKLy9FUlMyMDA0MTIgVE9ETyBzaWduaWZpY2FudCB3b3JrIHRvIG1vdmUgY3VzdG9taXphdGlvbiBpbnRvIGNsaWVudCBsaWJyYXJ5CgphbGVydCgiQEBAQCBJbmRleCBSdWxlIEZpcmVkIEBAQCMiKTsKLy9FUlMxOTA3MzAgIzYxMjcyIHVwZGF0ZWQgYnV0dG9uIHZhbGlkYXRpb24gaW4gdGhlIEFjdGlvbnMqIERldGFpbHMgYXJlYQoKdmFyIHN0YWNrSWQgPSBYKGRvYywgIlhfc3RhY2siKTsKaWYgKCFzdGFja0lkIHx8IHN0YWNrSWQuaW5kZXhPZigiYSIpICE9PSAwKSBzdGFja0lkPXpEYXRhLmdldFN0YWNrSWQoZG9jKTsgLy9FUlMxOTA2MjQgSEFDSz8KaWYgKHN0YWNrSWQpIHpEYXRhLnN0YWNrSWQ9c3RhY2tJZDsgLy9FUlMyMDAyMDQgIzY4ODI1IG11Y2ggYmV0dGVyIGZvciBjbGllbnQgY2FsbHMKdmFyIHN0YWNrRm9sZGVyID0gc3RhY2tJZCArICItU1RBQ0siOwp2YXIgY29tcGFueUNvZGUgPSBkb2MuZGVsaXZlcmVkVG87CnpEYXRhLnN0YWdlPSJJbmRleGVkIjsgLy9FUlMxOTA2MjAKCi8qIENsZWFyIHRoZSB0cmlnZ2VyIHRoYXQgaW52b2tlZCB0aGlzIHJ1bGUgKi8KLy9FUlMxNzA5MDkgekRhdGEuY2xlYXJUcmlnZ2VyQ29uZGl0aW9uKGRvYywiWF9idXR0b25BY3Rpb24iKTsKdmFyIGluZGV4SW5pdGlhbGl6ZWQgPSBYKGRvYywiWF9pbmRleEluaXRpYWxpemVkIik7CmlmICghaW5kZXhJbml0aWFsaXplZCB8fCAwID09PSBpbmRleEluaXRpYWxpemVkLmxlbmd0aCkgewogICAgc3RhY2tJZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIiI7CiAgICBzdGFja0ZvbGRlciA9IHN0YWNrSWQgKyAiLVNUQUNLIjsKICAgIHpEYXRhLmluaXRpYWxpemVTdGFjayhkb2Msc3RhY2tGb2xkZXIsIGNvbXBhbnlDb2RlLCBzdGFja0lkKTsKfQoKc2F2ZURFUGFuZWxWYWx1ZXMoZG9jKTsgICAgICAgICAgICAgLy9DUk4xOTExMTggU2F2ZSBERSBGaWVsZHMgdG8gUGFyZW50IFN0YWNrICAvL0VSUzIwMDQxMiBUT0RPIGludG8gTVAKekRhdGEuZ2V0RGF0YUVudHJ5RmllbGRzKGRvYyk7Ci8vIERvZXMgdGhlIHVzZXIgd2FudCB0byBhdHRhY2ggaW5kZXhlZCBwYWdlcyB0byBDYXNlPwovL3ZhciBjYXNlSWQgPSBYKGRvYywgIlhfWlBBUEVSX19DYXNlX19jIik7Ci8vdmFyIGNvbnRhY3RJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX1BhdGllbnRfX2MiKTsKLy92YXIgcGF0aWVudElkPWNvbnRhY3RJZDsgLy9UT0RPCi8vdmFyIHByb3ZpZGVySWQgPSBYKGRvYywgIlhfWlBBUEVSX19Qcm92aWRlcl9fYyIpOwovL3ZhciBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJYX1pQQVBFUl9fRmlyc3ROYW1lX19jIik7Ci8vdmFyIHBhdGllbnRMYXN0TmFtZSA9IFgoZG9jLCAiWF9aUEFQRVJfX0xhc3ROYW1lX19jIik7Ci8vdmFyIHBhdGllbnRET0IgPSBYKGRvYywgIlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MiKTsKCi8vekRhdGEuY2xpZW50Q29weUZyb21Eb2MoZG9jKTsgLy9FUlMyMDAzMDkgc3BsaXRzIGZyYWdtZW50IHppcHBpIHpEYXRhCmlmICghekRhdGEucGF0aWVudElkICYmIFgoZG9jLCJYX3BhdGllbnRJZCIpKSB6RGF0YS5wYXRpZW50SWQ9WChkb2MsIlhfcGF0aWVudElkIik7CmlmICghekRhdGEucGF0aWVudElkICYmIFgoZG9jLCJYX1pQQVBFUl9fUGF0aWVudF9fYyIpKSB6RGF0YS5wYXRpZW50SWQ9WChkb2MsIlhfWlBBUEVSX19QYXRpZW50X19jIik7IC8vRVJTMjAwMjA1IGtlZXAgdHJhY2sgb2YgSURzIGJldHRlcgppZiAoIXpEYXRhLnBhdGllbnRJZCAmJiBYKGRvYywiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIikpIHpEYXRhLnBhdGllbnRJZD1YKGRvYywiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIik7IC8vRVJTMjAwMzA4ICM3MDI3MwoKaWYgKCF6RGF0YS5wcm92aWRlcklkICYmIFgoZG9jLCJYX1pQQVBFUl9fUHJvdmlkZXJfX2MiKSkgekRhdGEucHJvdmlkZXJJZD1YKGRvYywiWF9aUEFQRVJfX1Byb3ZpZGVyX19jIik7IC8vRVJTMjAwMzA4ICM3MDI3MwppZiAoIXpEYXRhLnByb3ZpZGVySWQgJiYgWChkb2MsIlhfUHJvdmlkZXJDb250YWN0X19jIikpIHpEYXRhLnByb3ZpZGVySWQ9WChkb2MsIlhfUHJvdmlkZXJDb250YWN0X19jIik7IC8vRVJTMjAwMzA4ICM3MDI3MyBUT0RPIHpwKwppZiAoIXpEYXRhLnByb3ZpZGVySWQgJiYgWChkb2MsIlhfWlBBUEVSX19Qcm92aWRlckNvbnRhY3RfX2MiKSkgekRhdGEucHJvdmlkZXJJZD1YKGRvYywiWF9aUEFQRVJfX1Byb3ZpZGVyQ29udGFjdF9fYyIpOyAvL0VSUzIwMDMwOCAjNzAyNzMgVE9ETyB6cCsKYWxlcnQoIkVSUzIwMDMwOS4zOCBwcm92aWRlcklkPSIrekRhdGEucHJvdmlkZXJJZCArIiBmcm9tICIrWChkb2MsIlhfUHJvdmlkZXJDb250YWN0X19jIikKICAgKyIgYW5kIHBhdGllbnRJZD0iK3pEYXRhLnBhdGllbnRJZCsiIGZyb20gIitYKGRvYywiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIikpOyAvL0VSUzIwMDMwOSBnZXQgdGhlIElkcwoKaWYgKCF6RGF0YS5jYXNlSWQpIHpEYXRhLmNhc2VJZD1YKGRvYywiWF9aUEFQRVJfX0Nhc2VfX2MiKTsgLy8vL0VSUzIwMDIwNSB6aXBwaSBjaGFuZ2VzCgovLyBHZXQgdGhlIGRvY3VtZW50IHR5cGUgKHdpbGwgYmUgdXNlZCB0byByb3V0ZSB0byBuZXh0IGZvbGRlcikKLy92YXIgZG9jVHlwZSA9IFgoZG9jLCAiWF9Eb2N1bWVudF9UeXBlX19jIik7CnZhciBuZXh0Rm9sZGVyID0gIjIwNTAwVHJpYWdlLVMyIjsgICAgICAgICAgICAgIC8vIE90aGVyIGZvbGRlciBpcyB0aGUgZGVmYXVsdAp2YXIgcHJldkluZGV4UGFnZXMgPSBYKGRvYywgIlhfaW5kZXhlZFBhZ2VzIik7CnZhciBjdXJJbmRleFBhZ2VzID0gWChkb2MsICJYX2lkeFBhZ2VzIik7CmlmIChwcmV2SW5kZXhQYWdlcyAmJiBwcmV2SW5kZXhQYWdlcy5sZW5ndGggPiAwICYmIGN1ckluZGV4UGFnZXMgJiYgY3VySW5kZXhQYWdlcy5sZW5ndGggPiAwKSB7CiAgICBwcmV2SW5kZXhQYWdlcyArPSAiLCI7Cn0KY3VySW5kZXhQYWdlcyA9IHByZXZJbmRleFBhZ2VzICsgY3VySW5kZXhQYWdlczsKdmFyIGFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX2luZGV4ZWRQYWdlcyIsIGN1ckluZGV4UGFnZXMpOwovL21vdmUgdG8gYWZ0ZXIgdXBkYXRlcyBhcnJPZlBhaXJzPXpEYXRhLmFkZFN0YWdlKGRvYyxhcnJPZlBhaXJzLCJJbmRleGVkIik7CnVwZGF0ZURCKGRvYyxhcnJPZlBhaXJzKTsKCi8vdmFyIHNmU3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7CnZhciBzZlN0YWNrSWQ9WChkb2MsJ1hfc2ZTdGFja0lkJyk7CmlmKCFzZlN0YWNrSWQpewogIHNmU3RhY2tJZD16RGF0YS5nZXRTdGFja0lkKGRvYyk7Cn0KCmFsZXJ0KCJAQEBAQEAgQ3VycmVudGx5IGF0dGFjaGVkIHRvIFpQQVBFUl9felN0YWNrX19jIHdpdGggSUQ6ICIgKyBzZlN0YWNrSWQpOwp6RGF0YS56UGFyZW50SWQ9ZG9jLmRiSUQ7IC8vRVJTMTkwODE0IHRvIG92ZXJzaWRlIHRoZSBzYXZlLmpzcCB3b3JrZmxvd3MKCmFsZXJ0KCJAQEBAIFBhcmVudCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIFgoZG9jLCAiWF9hdHRhY2hlZFRvIikpOwoKLyogU1BMSVQgT0ZGIE5FVyBTTklQUEVUIEhFUkUgKi8KdmFyIHBhZ2VSYW5nZSA9IFgoZG9jLCJYX2lkeFBhZ2VzIik7CnZhciBuZXdJZD1zcGxpdERvY3VtZW50Rm9ySW5kZXgoZG9jLCAiaW5kZXgiLCBwYWdlUmFuZ2UpOwoKYWxlcnQoIkBAQEAgQUZURVIgU1BMSVQ6IENoaWxkIHpTdGFjayBTbmlwcGV0IGF0dGFjaGVkIHRvOiAiICsgWChkb2MsICJYX2F0dGFjaGVkVG8iKSk7CgpzYXZlREVQYW5lbFZhbHVlcyhkb2MpOyAgICAgICAgICAgICAvL0NSTjE5MTExOCBBbHNvIFNhdmUgREUgRmllbGRzIHRvIENoaWxkIFN0YWNrIC8vRVJTMjAwNDEyIFRPRE8gaW50byBNUAoKYWxlcnQoIkVSUzE5MDYyNCBuZXdJZD0iK25ld0lkKTsKLy8qCi8qIEFGVEVSIFRISVMgUE9JTlQsIFRIRSBET0MgV0lMTCBIT0xEIERBVEEgRk9SIE5FVyBTTklQUEVULCBOT1QgVEhFIFNUQUNLIFNOSVBQRVQgKi8KLy8qCgovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIGEgbmV3IENhc2UgcmVjb3JkLCBpZiBpdCB3YXNuJ3QgcGFzc2VkIGluIGFuZCBpZiB3ZSBhcmUgbm90IGhhbmRsaW5nIHRoZSAyQSBERSBQYW5lbDogQ2FuYWRhX1ByaW9yaXR5X0RhdGEyX1dlYl9Gb3JtICovCi8vdmFyIHByaW9yaXR5PVgoZG9jLCJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiKTsgLy9FUlMxNzA2MjYKdmFyIGxhYmVsMD0iIjsKdmFyIHRyaWFnZVR5cGU9ZG9jLmRvY1R5cGU7CmlmICghdHJpYWdlVHlwZSB8fCB0cmlhZ2VUeXBlID09ICJGQVgiKSB0cmlhZ2VUeXBlPVgoZG9jLCJYX1pQQVBFUl9fZmF4VHlwZV9fYyIpOyAvL0VSUzIwMDIwNSBkb2MuZG9jVHlwZTsKekRhdGEuZG9jVHlwZT10cmlhZ2VUeXBlOyBhbGVydCgiVXNpbmcgRVJTMjAwMjA1IGRvY1R5cGU9Iit6RGF0YS5kb2NUeXBlKTsgLy9FUlMyMDAyMDUgQDY4ODI1Cgp2YXIgYXR0YWNoUGF0aCA9IFgoZG9jLCJYX2F0dGFjaGVkVG8iKTsKekRhdGEuYXR0YWNoZWRUb0Nhc2UgPWZhbHNlOwp6RGF0YS5hdHRhY2hlZFRvID0gWChkb2MsICJYX0F0dGFjaF9Ub19fYyIpOyAvL1BWMTkxMjA1IHVwZGF0ZWQgY2FzZSBjcmVhdGlvbgogICAgYWxlcnQoInpEYXRhLmF0dGFjaGVkVG89PT09PT09PT0iK3pEYXRhLmF0dGFjaGVkVG8pOwogICAgdmFyIGF0dGFjaEZheFR5cGVzID1bIkVOUkwiLCJNRURPIiwiT1RIIiwiQ09QQVkiXTsKICAgIC8vaWYoIGF0dGFjaEZheFR5cGVzLmluZGV4T2YoekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpID4tMSAmJiAoekRhdGEuYXR0YWNoZWRUbyA9PT0gIkNhcmUgUGxhbiIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0gIkFsbCIpKXsKICAgIGlmKCh6RGF0YS5hdHRhY2hlZFRvID09PSAiQ2FyZSBQbGFuIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSAiQWxsIikpewogICAgICB6RGF0YS5hdHRhY2hlZFRvQ2FzZSA9IHRydWU7CiAgICB9Ci8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gUGF0aWVudCByZWNvcmQgaWYgcmVxdWlyZWQgKi8gLy9FUlMxOTA2MTkKekRhdGEucGF0aWVudFR5cGU9WEN1c3RvbVNldHRpbmcoZG9jLCJaUEFQRVJfX1BhdGllbnRSZWNvcmRfX2MiKTsgLy9FUlMxOTA4MDYgWlBBUEVSX18gbm93IGluIE1QCmFsZXJ0KCJAQEBAIHpEYXRhLnBhdGllbnRUeXBlICoqKioqICIrekRhdGEucGF0aWVudFR5cGUrIiBQYXRpZW50Iik7CmFsZXJ0KCJAQEAgY3VycmVudCBERSBQYW5lbCBuYW1lID0gIiArIFgoZG9jLCAiWF9sYXN0REVQYW5lbCIpKTsKaWYgKCF6RGF0YS5wYXRpZW50VHlwZSkgekRhdGEucGF0aWVudFR5cGU9IkNvbnRhY3QiOyAvL0VSUzE5MDgwMiAjNjEyNzIKLy9pZiAoWChkb2MsIlhfWlBBUEVSX19QYXRpZW50X19jIikgfHwgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKSB7IC8vRVJTMTkwODAzIFRPRE8gcmV0aGluayB1c2UgWAogICAgdmFyIGRxID0gekRhdGEuZHEgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDM0KTsgLy9FUlMxOTA4MDIgVE9ETyBkZWZpbmUgYmV0dGVyIGluIHpEYXRhCiAgICB2YXIgcGF0aWVudFBob25lID0gWChkb2MsICJYX1pQQVBFUl9fUGhvbmVfX2MiKTsKICAgIGFsZXJ0KCJAQEAgcGF0aWVudFBob25lID0gIiArIHBhdGllbnRQaG9uZSk7CiAgICBpZiAoIXpEYXRhLnBhdGllbnRJZCkgewogICAgICAgIGFsZXJ0KCJAQEBAIGNyZWF0aW5nIG5ldyAiK3pEYXRhLnBhdGllbnRUeXBlKyIgUGF0aWVudCIpOwogICAgICAgIGFyck9mUGFpcnMgPSBbXTsKICAgICAgICAvL0VSUzE5MDczMCAjNjEyNzIgbWlzc2luZyB0aGUgYmFzaWNzCiAgICAgICAgdmFyIHA9IiI7CiAgICAgICAgaWYgKCJBY2NvdW50Ij09PXpEYXRhLnBhdGllbnRUeXBlKSB7IC8vRVJTMTkwODAzCiAgICAgICAgICAgIHA9IlBlcnNvbiI7CiAgICAgICAgICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJOYW1lIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYysiICIrekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJGaXJzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKTsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJMYXN0TmFtZSIsIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7Ci8vICAgICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaChwKyJCaXJ0aGRhdGUiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsKICAgICAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9CaXJ0aF9EYXRlX19wYyIsIHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOyAvL0FTTTIwMjAwMTA5IC0gVXNpbmcgdGhlIGNvcnJlY3QgZmllbGQuIC8vQ1JOMjAwMTA4IGFiYnZpZSB3YW50cyBiaXJ0aGRhdGUgc3RvcmVkIGluIHRoaXMgZmllbGQsIG5vdCBzdGFuZGFyZCBmaWVsZAogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXRpZW50UGhvbmUpIHsgYXJyT2ZQYWlycy5wdXNoKCJQaG9uZSIsIHBhdGllbnRQaG9uZSk7IH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkZpcnN0TmFtZSIsIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MpOyAvL1hfWlBBUEVSX19GaXJzdE5hbWVfX2MgLy9FUlMxOTA4MDMgVE9ETyBnZXQgY2xlYW5lciAjNjEyNzIKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJMYXN0TmFtZSIsIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7CiAgICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkJpcnRoZGF0ZSIsIHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXRpZW50UGhvbmUpIHsgYXJyT2ZQYWlycy5wdXNoKCJQaG9uZSIsIHBhdGllbnRQaG9uZSk7IH0KICAgICAgICB9CiAgICAgICAgdmFyIGF0dGFjaExhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgICAgIHpEYXRhLnBhdGllbnRJZD16RGF0YS5jbGllbnRQYXRpZW50KGRvYyxhcnJPZlBhaXJzLCBhdHRhY2hMYWJlbCk7CiAgICAgICAgYWxlcnQoIkNyZWF0ZWQgUGF0aWVudCB3aXRoIElEOiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICBpZiAoekRhdGEucGF0aWVudElkID09ICJudWxsIiB8fCB6RGF0YS5wYXRpZW50SWQgPT0gIk5FVyIpIHpEYXRhLnBhdGllbnRJZD1udWxsOwogICAgICAgIGVsc2UgeyAvL0VSUzE5MDczMCAjNjEyNzIgbGV2ZXJhZ2UgdGhlIG5ldyByZWNvcmQKICAgICAgICAgICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5wYXRpZW50SWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLnBhdGllbnRJZDsKICAgICAgICAgICAgYWxlcnQoIkBAQEBAQEAgTkVXIFBBVElFTlQgQ1JFQVRFRCBXSVRIIElEOiAiICsgekRhdGEucGF0aWVudElkKTsgLy9FUlMxOTA4MDIgekRhdGEuY29udGFjdElkCiAgICAgICAgICAgIC8vIGNsZWFyIG91dCB0aGUgIk5ldyBQYXRpZW50IiBmaWVsZHMKICAgICAgICAgICAgaWYgKDE9PT0xKSB7IC8vRVJTMTkwODExICM2MTU3MCBjb21tZW50ZWQgb3V0IHNvIHRoYXQgcGF0aWVudCBpbmZvIGlzIGF2YWlsYWJsZSBmb3IgREUgdmFyaWFibGVzIGluIHppcHBpCiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0ZpcnN0TmFtZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19MYXN0TmFtZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19CaXJ0aGRhdGVfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIiIgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGhvbmVfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIiIgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQmlydGhkYXRlX19jX3JlYWRhYmxlIiArIGRxICsgIikudmFsKCIgKyBkcSArICJOT05FIiArIGRxICsgIik7ICIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHNldCB0aGUgUGF0aWVudCBsb29rdXAgZmllbGRzCiAgICAgICAgICAgIC8vRVJTMTkwODAzIFRPRE8gaGFuZGxlIFpQQVBFUl9fIHJlbGF0aW9uc2hpcHMgLy9FUlMxOTA4MTEgZG91YmxlIHVwIGZvciBzYWZldHkKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5wYXRpZW50SWQgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyAiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEucGF0aWVudElkICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX1BhdGllbnRBY2NvdW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArICIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArIGRxICsgIik7ICIpOwogICAgICAgICAgICAvL0NSTjE5MTExOCBBbHNvIHNhdmUgdGhlIG5ldyB2YWx1ZXMgdG8gdGhlIGNoaWxkCiAgICAgICAgICAgIHZhciBzYXZlMkRCQXJyT2ZQYWlycyA9IFtdOwogICAgICAgICAgICBzYXZlMkRCQXJyT2ZQYWlycy5wdXNoKCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICBzYXZlMkRCQXJyT2ZQYWlycy5wdXNoKCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX3IuTmFtZSIsIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyAiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogICAgICAgICAgICB1cGRhdGVEQihkb2MsIHNhdmUyREJBcnJPZlBhaXJzKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vaWYgKHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICYmICgiQ09OUyIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jCiAgICAgICAgIC8vICAgfHwgIkVOUkwiID09PXpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8CiAgICAgICAgIC8vICAiTUVETyIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSkgeyAvL0VSUzE5MTA5ICM2NDkyMSBUT0RPIG1hbnkgam91cm5leSBiZXN0IHByb2N0aWNlCiAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgaWYgKHpEYXRhLnBhdGllbnRUeXBlICE9ICJBY2NvdW50IikgeyAvL0VSUzE5MDczMCBsb29rdXAgdGhlIGRhdGEgVE9ETyBwZXJzb24gYWNjb3VudD8KICAgICAgICAgICAgICAgIHZhciBjb250YWN0RmxkcyA9IGdldFNGRmllbGRzKGRvYywgekRhdGEucGF0aWVudFR5cGUsICJGaXJzdE5hbWUsTGFzdE5hbWUsQmlydGhkYXRlIiwgbnVsbCwgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBjb250YWN0RmxkczogIiArIGNvbnRhY3RGbGRzKTsKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgPSBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJGaXJzdE5hbWUiLCBjb250YWN0Rmxkcyk7IC8vUFYxOTEwMDYgdXBkYXRlIHRoZSBjaGlsZCBzdGFjawogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jID0gcGF0aWVudExhc3ROYW1lID0gWChkb2MsICJMYXN0TmFtZSIsIGNvbnRhY3RGbGRzKTsKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2M9cGF0aWVudERPQiA9IFgoZG9jLCAiQmlydGhkYXRlIiwgY29udGFjdEZsZHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHpEYXRhLnBhdGllbnRUeXBlID09PSAiQWNjb3VudCIpIHsgLy9FUlMxOTA3MzAgbG9va3VwIHRoZSBkYXRhIFRPRE8gcGVyc29uIGFjY291bnQ/CiAgICAgICAgICAgICAgICB2YXIgY29udGFjdEZsZHMgPSBnZXRTRkZpZWxkcyhkb2MsIHpEYXRhLnBhdGllbnRUeXBlLCAiTmFtZSIsIG51bGwsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgQWNjb3VudEZsZHM6ICIgKyBjb250YWN0Rmxkcyk7CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jID0gcGF0aWVudEZpcnN0TmFtZSA9IFgoZG9jLCAiTmFtZSIsIGNvbnRhY3RGbGRzKS5zcGxpdCgiICIpWzBdOyAvL0VSUzE5MDgwMyBUT0RPIGZpbmQgYSBiZXR0ZXIgd2F5CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgPSBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIk5hbWUiLCBjb250YWN0Rmxkcykuc3BsaXQoIiAiKVsxXTsKICAgICAgICAgICAgICAgIC8vekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYz1wYXRpZW50RE9CID0gWChkb2MsICJQZXJzb25CaXJ0aGRhdGUiLCBjb250YWN0Rmxkcyk7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vUFYxOTEwMDggdXBkYXRlZCBhdHRhY2hMYWJlbCBvbiBjaGlsZCBzdGFjawogICAgICAgICAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgICAgICAgICBpZih6RGF0YS5hdHRhY2hlZFRvID09PSAiUGF0aWVudCIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0gIkFsbCIpewogICAgICAgICAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIH0KICAgICAgLy8gfQogICAgfQogICAgaWYgKHpEYXRhLnBhdGllbnRJZCAmJiBhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucGF0aWVudElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5wYXRpZW50SWQ7Ci8vfQphbGVydCgiQEBAQCBBRlRFUiBQQVRJRU5UOiBDaGlsZCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIGF0dGFjaFBhdGgpOwoKdmFyIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7IC8vIkluZGV4ZWQgIiArIGZvcm1hdE5vdzsKYWxlcnQoIkVSUzE5MDYyNCBhdHRhY2hMYWJlbD0iK2F0dGFjaExhYmVsKTsKCgovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIExlYWQgcmVjb3JkIGlmIHJlcXVpcmVkICovIC8vRVJTMTkwNjE5Ci8vIFRPRE8gRVJTMTkwNjI0IGZsaXAgdGhlIGlmIGxvZ2ljCmlmIChkb2Mud2RkYXRhLmluZGV4T2YoIlhfWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiKT4tMSkgeyAvL0VSUzE5MDgwMyBUT0RPIHJldGhpbmsKICAgIGlmICghbGVhZElkIHx8IDAgPT09IGxlYWRJZC5sZW5ndGgpIHsKICAgICAgICBhbGVydCgiQEBAQCBjcmVhdGluZyBuZXcgTGVhZCIpOwogICAgICAgIGFyck9mUGFpcnMgPSBbXTsKICAgICAgICBsZWFkSWQ9ekRhdGEuY2xpZW50TGVhZChkb2MsYXJyT2ZQYWlycyk7CiAgICAgICAgYWxlcnQoIkNyZWF0ZWQgTGVhZCB3aXRoIElEOiAiICsgbGVhZElkKTsKICAgICAgICBpZiAobGVhZElkID09ICJudWxsIiB8fCBsZWFkSWQgPT0gIk5FVyIpIGxlYWRJZD1udWxsOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAoekRhdGEuYXR0YWNoUmVjb3Jkcy5pbmRleE9mKCJMZWFkIik+LTEpIHsKICAgICAgICAgICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIExlYWQ6ICIgKyBsZWFkSWQpOwogICAgICAgICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgbGVhZElkKTsKICAgICAgICB9CiAgICB9CiAgICBpZiAobGVhZElkICYmIGF0dGFjaFBhdGguaW5kZXhPZihsZWFkSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK2xlYWRJZDsKfQphbGVydCgiQEBAQCBBRlRFUiBMRUFEOiBDaGlsZCB6U3RhY2sgU25pcHBldCBhdHRhY2hlZCB0bzogIiArIFgoZG9jLCAiWF9hdHRhY2hlZFRvIikpOwoKCi8vRVJTMTkwNjIwIHVzZSBhIHNldHRpbmcgdG8gZGV0ZXJtaW5lIHdoaWNoIGxvb2t1cHMgd2UgYXR0YWNoIHRvCi8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gQ2FzZSByZWNvcmQgaWYgcmVxdWlyZWQgKi8gLy9FUlMxOTA2MTkKLy9pZiAoZG9jLndkZGF0YS5pbmRleE9mKCJYX1pQQVBFUl9fQ2FzZV9fYyIpPi0xKSB7CiAgaWYoMT09PTEpewogICAgYWxlcnQoIkVSUzE5MDYyNCBuZWVkIENhc2UiKTsKICAgIGlmICh6RGF0YS5jYXNlSWQpIHsKICAgICAgICBpZiAoekRhdGEuYXR0YWNoUmVjb3Jkcy5pbmRleE9mKCJDYXNlIik+LTEpIHsKICAgICAgICAgICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIENhc2U6ICIgKyB6RGF0YS5jYXNlSWQpOwogICAgICAgICAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgICAgICAgICBpZih6RGF0YS5hdHRhY2hlZFRvQ2FzZSl7CiAgICAgICAgICAgICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgekRhdGEuY2FzZUlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFsZXJ0KCJFUlMxOTA2MjQuNzggaGF2ZSBhIGNhc2U/Iik7CiAgICBpZiAoekRhdGEuY2FzZUlkICYmIGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5jYXNlSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmNhc2VJZDsKfQoKYWxlcnQoIkBAQEAgQUZURVIgQ0FTRTogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBYKGRvYywgIlhfYXR0YWNoZWRUbyIpKTsKCgovL1BWMTkxMDIyIGNyZWF0ZSBwcmVzY3JpcHRpb24KdmFyIHN0YWNrRmxkcyA9IGdldFNGRmllbGRzKGRvYywgIlpQQVBFUl9felN0YWNrX19jIiwgIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgbnVsbCwgc2ZTdGFja0lkKTsKekRhdGEuWF9aUEFQRVJfX2xhdGVzdEZheF9fYyA9ICBYKGRvYywgIlpQQVBFUl9fbGF0ZXN0RmF4X19jIiwgc3RhY2tGbGRzKTsgLy9QVjE5MDkyNiB1cGRhdGUgdGhlIGNoaWxkIHN0YWNrCmlmKCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyl7CiAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgUHJlc2NyaXB0aW9uOiAiICsgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJQcmVzY3JpcHRpb24iIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09IkFsbCIpewogICAgICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7CiAgICB9Cn0KaWYoICF6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyAmJiB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyAmJiJSWCIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICkgeyAvL0VSUzE5MTEwOSAjNjQ5MjEgVE9ETyBtYW55IGpvdXJuZXlzCiAgICBhbGVydCgiQEBAQCBDcmVhdGluZyAgUHJlc2NyaXB0aW9uX19jIHdpdGggZmF4IFR5cGUgOiAiICsgekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpOwogICAgYXJyT2ZQYWlycyA9IFtdOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX0RhdGVfb2ZfUHJlc2NyaXB0aW9uX1JlY2VpdmVkX19jIix6RGF0YS5YX1pQQVBFUl9fbGF0ZXN0RmF4X19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9Qcm9kdWN0UHJlc2NyaWJlZF9fYyIsekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9DYXJlUGxhbl9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICBpZiggekRhdGEuYXR0YWNoZWRUbyA9PT0iUHJlc2NyaXB0aW9uIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGUoZG9jLCJDb3JlX1ByZXNjcmlwdGlvbl9fYyIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIH1lbHNlewogICAgICAgIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZU5vQXR0YWNoKGRvYywiQ29yZV9QcmVzY3JpcHRpb25fX2MiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB9CiAgICAvL3pEYXRhLlhfUHJlc2NyaXB0aW9uX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNvcmVfUHJlc2NyaXB0aW9uX19jIixhcnJPZlBhaXJzLCJJbmRleCIpOyAgQ1JOMTkxMjEzIERvbid0IGNyZWF0ZSB0aGUgUHJlc2NyaXB0aW9uIG11bHRpcGxlIHRpbWVzCiAgICBhbGVydCgiQEBAQCBDcmVhdGUgUHJlc2NyaXB0aW9uX19jIHdpdGggSUQ6ICIgKyB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7CiAgICBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOwogICAgLy9hdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwogICAgekRhdGEuUHJlc2NyaXB0aW9uTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiQ29yZV9QcmVzY3JpcHRpb25fX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsgLy9QVjE5MTAyMiAvL0VSUzE5MTEwOSBjbGllbnRJbmRleD8KICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQcmVzY3JpcHRpb25fX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgKyBkcSArICIpOyAiKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNQcmVzY3JpcHRpb25fX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5QcmVzY3JpcHRpb25OYW1lICsgZHEgKyAiKTsgIik7Cgp9Ci8vQ1JOMTkxMTE4IElmIHdlIGFsc28gaGF2ZSBhIHBhdGllbnQgYW5kIGEgUHJlc2NyaXB0aW9uLCBhc3NvY2lhdGUgdGhlbS4KLyoKaWYgKHpEYXRhLnBhdGllbnRJZCAmJiB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYykgewogICAgYWxlcnQoIkBAQCBBc3NvY2lhdGluZyBQcmVzY3JpcHRpb246ICIgKyB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyArICIgd2l0aCBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgIHZhciBzY3JpcHRBcnJPZlBhaXJzID0gW107CiAgICBzY3JpcHRBcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICB1cGRhdGVTRlJlY29yZChkb2MsICJDb3JlX1ByZXNjcmlwdGlvbl9fYyIsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jLCBzY3JpcHRBcnJPZlBhaXJzKTsKfQoqLwoKLy9DT01EUgovL2lmKCAhekRhdGEuY2FzZUlkICYmICgiQ09NRFIiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwovLyAgICAgfHwgIk1FREMiPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8ICJMQUIiPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jCi8vICAgICB8fCAiSU5KUiI9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykpewovL0NSTjE5MTExNCBBY2NvcmRpbmcgdG8gdGhlIEFiYnZpZSBzdG9yaWVzLCBhbGwgZG9jVHlwZXMgZXhjZXB0ICJDb25zZW50IEZvcm1zIiBuZWVkIHRvIGhhdmUgYSBDYXNlIGNyZWF0ZWQgaWYgb25lIGlzbid0IGFscmVhZHkgc2VsZWN0ZWQKaWYoIXpEYXRhLmNhc2VJZCAmJiAiQ09OUyIgIT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jICYmICdDYW5hZGFfUHJpb3JpdHlfRGF0YTJfV2ViX0Zvcm0nICE9PSBYKGRvYywgIlhfbGFzdERFUGFuZWwiKSkgewogICAgYXJyT2ZQYWlycyA9IFtdOwogICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTIxaTAwMDAwMGhRbzdBQUUiKTsgICAgICAgICAgICAgICAvLyBDUk4xOTExMTQgQWx3YXlzIHVzZSBDYXJlUGxhbiBSZWNvcmQgVHlwZT8KICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9CcmFuZF9fYyIsekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKTsKICAgIGlmKHpEYXRhLnByb2dyYW1OYW1lID09PSAiQWJidmllIE9uZUNSTSAtIENhbmFkYSIpewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9Db3VudHJ5Q29kZV9fYyIsIkNBIik7CiAgICB9CiAgICBpZiAoekRhdGEucGF0aWVudElkKSB7IGFyck9mUGFpcnMucHVzaCgiQWNjb3VudElkIiwgekRhdGEucGF0aWVudElkKTsgfQogICAgaWYoekRhdGEuYXR0YWNoZWRUb0Nhc2UpewogICAgICAgIHpEYXRhLmNhc2VJZCA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGUoZG9jLCJDYXNlIixhcnJPZlBhaXJzLCJJbmRleCIpOwogICAgfWVsc2V7CiAgICAgICAgekRhdGEuY2FzZUlkID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZU5vQXR0YWNoKGRvYywiQ2FzZSIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIH0KICAgIHpEYXRhLmNhc2VOdW1iZXIgPSBnZXRTRkZpZWxkKGRvYywgIkNhc2UiLCAiQ2FzZU51bWJlciIsIG51bGwsIHpEYXRhLmNhc2VJZCk7IC8vUFYxOTEwMjIKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0Nhc2VfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZUlkICsgZHEgKyAiKTsgIik7CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19DYXNlX19jX0Nhc2VOdW1iZXIiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZU51bWJlciArIGRxICsgIik7ICIpOyAvL1BWMTkwOTI5IHVwZGF0ZWQgY2FzZSBudW1iZXIgaW4gbG9va3VwCiAgICB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jID0gWChkb2MsICJYX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIik7CgovKgpDUk4xOTExMTMgTW92ZWQgYmVsb3cgd2hlcmUgdGhlIGRvY1R5cGUgbG9naWMgaXNuJ3Qgc28gY29udm9sdXRlZAogICAgaWYoIkxBQiI9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIklOSlIiPT09ekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKICAgICAgIHx8ICJNRURDIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpewogICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgIGlmKCJMYWIgVGVzdHMiPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjVFMDAwMDAwSzI0R1FBUyIpOwogICAgICB9CiAgICAgIGlmKCJpbmplY3Rpb24gVHJhaW5pbmciPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CgogICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MiLCIwMTI1RTAwMDAwMEsyNExRQVMiKTsKICAgICAgfQoKICAgICAvL2Fyck9mUGFpcnMucHVzaCgiU2VydmljZV9SZXF1ZXN0ZWRfZGF0ZV9fYyIsekRhdGEuWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jKTsKICAgICAvL2Fyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIix6RGF0YS5wYXRpZW50SWQpOwogICAgIGlmKCF6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKXsKICAgICAgICBhc3NvY2lhdGVkQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVfUGxhbl9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICAgICAgYXNzb2NpYXRlZEFyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgICAgICB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jID0gekRhdGEuY2xpZW50UmVjb3JkVHlwZShkb2MsIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgICB9CiAgICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwogICAgIHpEYXRhLkNsaW5pY2FsTmFtZSA9IGdldFNGRmllbGQoZG9jLCAiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIiwgIk5hbWUiLCBudWxsLCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsgLy9QVjE5MTAyMgogICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNDbGluaWNhbF9TZXJ2aWNlc19fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jICsgZHEgKyAiKTsgIik7CiAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuQ2xpbmljYWxOYW1lICsgZHEgKyAiKTsgIik7CiAgICB9CiAgICAqLwp9CgovL1NIUjE5MTIwOSAjNjU1MzUgYWRkIERvY3VtZW50IExpbmsgaWYgd2UgaGF2ZSBhIG5ldyBDYXNlIElkCmlmICh6RGF0YS5jYXNlSWQpIHsKICAgIHpEYXRhLmNsaWVudExpZ2h0bmluZ0ZpbGUoZG9jLHpEYXRhLmNhc2VJZCk7IC8vRVJTMjAwNDI4IG1vdmUgdG8gbGlicmFyeSAjNzA5NTMKfQoKLy9DT1BBWQppZiAoIkNPUEFZIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpIHsKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ0FfUGF0aWVudF9fYyIsekRhdGEucGF0aWVudElkKTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ0FfQ2FyZVBsYW5JRF9fYyIsekRhdGEuY2FzZUlkKTsKICAgIHpEYXRhLmNvcGF5SWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ0FfQ29wYXlfX2MiLGFyck9mUGFpcnMsIkluZGV4Iik7Cn0KCgovL09USAppZiggIXpEYXRhLmNhc2VJZCAmJiAoIk9USCIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8ICJFTlJMIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKICAgIHx8ICJNRURPIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIlJYIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgKSl7CiAgICBpZih6RGF0YS5jcmVhdGVDYXNlKXsKICAgICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTIxaTAwMDAwMGhRbzdBQUUiKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQnJhbmRfX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CiAgICAgICAgaWYoekRhdGEucHJvZ3JhbU5hbWUgPT09ICJBYmJ2aWUgT25lQ1JNIC0gQ2FuYWRhIil7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9Db3VudHJ5Q29kZV9fYyIsIkNBIik7CiAgICAgICAgfQoKICAgICAgICB6RGF0YS5jYXNlSWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ2FzZSIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgICAgICB6RGF0YS5jYXNlTnVtYmVyID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkNhc2VOdW1iZXIiLCBudWxsLCB6RGF0YS5jYXNlSWQpOyAvL1BWMTkxMDIyCiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5jYXNlSWQgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19DYXNlX19jX0Nhc2VOdW1iZXIiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZU51bWJlciArIGRxICsgIik7ICIpOyAvL1BWMTkwOTI5IHVwZGF0ZWQgY2FzZSBudW1iZXIgaW4gbG9va3VwCiAgICB9Cn0KCmlmKCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpewogICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIE91dGNvbWU6ICIgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJSZXBvcnRlZCBPdXRjb21lcyIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyk7CiAgICB9CiAgICAvL0NSTjE5MTExOCBJZiB3ZSBhbHNvIGhhdmUgYSBQYXRpZW50IGFuZCBhIFJlcG9ydGVkIE91dGNvbWUsIGFzc29jaWF0ZSB0aGVtLgogICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgICAgIGFsZXJ0KCJAQEAgQXNzb2NpYXRpbmcgUmVwb3J0ZWQgQ3V0Y29tZTogIiArIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyArICIgd2l0aCBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICB2YXIgb3V0Y29tZUFyck9mUGFpcnMgPSBbXTsKICAgICAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0FjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfUGF0aWVudF9SZXBvcnRlZF9PdXRjb21lc19fYyIsIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYywgb3V0Y29tZUFyck9mUGFpcnMpOwogICAgfQp9CmVsc2UgaWYgKCJDQSIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSB7CiAgICB2YXIgb3V0Y29tZUFyck9mUGFpcnMgPSBbXTsKICAgIG91dGNvbWVBcnJPZlBhaXJzLnB1c2goIkNvcmVfRW50cnlfRGF0ZV9fYyIsIGdldEN1ckRhdGUoZG9jKSk7CiAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVfUGxhbl9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0FjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgdmFyIGFzc2Vzc21lbnRUeXBlID0gWChkb2MsICJYX0Fzc2Vzc21lbnRfVHlwZV9fYyIpOwogICAgaWYgKGFzc2Vzc21lbnRUeXBlICYmICJET05PVF9TQVZFIiAhPT0gYXNzZXNzbWVudFR5cGUpIHsKICAgICAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0Fzc2Vzc21lbnRfVHlwZV9fYyIsIGFzc2Vzc21lbnRUeXBlKTsKICAgIH0KICAgIHZhciBvdXRjb21lVHlwZSA9IFgoZG9jLCAiWF9PdXRjb21lX1R5cGVfX2MiKTsKICAgIGlmIChvdXRjb21lVHlwZSAmJiAiRE9OT1RfU0FWRSIgIT09IG91dGNvbWVUeXBlKSB7CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9PdXRjb21lX1R5cGVfX2MiLCBvdXRjb21lVHlwZSk7CiAgICB9CiAgICAvL0NSTjE5MTExOCBJZiB3ZSBhbHNvIGhhdmUgYSBQYXRpZW50IGFuZCBhIFJlcG9ydGVkIE91dGNvbWUsIGFzc29jaWF0ZSB0aGVtLgogICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgICAgIGFsZXJ0KCJAQEAgQXNzb2NpYXRpbmcgTmV3IFJlcG9ydGVkIEN1dGNvbWUgd2l0aCBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0FjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgfQogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IlJlcG9ydGVkIE91dGNvbWVzIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ29yZV9QYXRpZW50X1JlcG9ydGVkX091dGNvbWVzX19jIixvdXRjb21lQXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIH1lbHNlewogICAgICAgIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGVOb0F0dGFjaChkb2MsIkNvcmVfUGF0aWVudF9SZXBvcnRlZF9PdXRjb21lc19fYyIsb3V0Y29tZUFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB9CiAgICB2YXIgb3V0Y29tZU5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNvcmVfUGF0aWVudF9SZXBvcnRlZF9PdXRjb21lc19fYyIsICJOYW1lIiwgbnVsbCwgekRhdGEuWF9SZXBvcnRlZF9PdXRjb21lX19jKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNSZXBvcnRlZF9PdXRjb21lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyArIGRxICsgIik7ICIpOwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1JlcG9ydGVkX091dGNvbWVfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBvdXRjb21lTmFtZSArIGRxICsgIik7ICIpOwp9CgoKYXJyT2ZQYWlycyA9IFtdOwppZiAoekRhdGEuZG9jVHlwZSkgeyBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fZmF4VHlwZV9fYyIsIHpEYXRhLmRvY1R5cGUpOyAgfSAvL0VSUzE5MDgxMCBQVjE5MDgwOCAjNTE2NzAKaWYgKHpEYXRhLnByb3ZpZGVySWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcm92aWRlcl9fYyIsIHpEYXRhLnByb3ZpZGVySWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5wcm92aWRlcklkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5wcm92aWRlcklkOwp9CmFsZXJ0KCJFUlMxOTA4MTIuMjAwIHpEYXRhLnBhdGllbnRJZD0iK3pEYXRhLnBhdGllbnRJZCk7IC8vRVJTMTkwODEyICM2MTUxMQppZiAoekRhdGEucGF0aWVudElkKSB7CiAgICBpZiAoekRhdGEucGF0aWVudElkLmluZGV4T2YoIjAwMyIpPT09MCkgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMDEiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICBpZiAoekRhdGEucGF0aWVudElkLmluZGV4T2YoIjAwUSIpPT09MCkgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1JlZmVycmFsTGVhZF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMTkwODAyIExlYWQKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucGF0aWVudElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5wYXRpZW50SWQ7CiAgICBpZiAoMT09PTEpIHsgLy9FUlMxOTA4MTAgUFYxOTA4MDggZGF0YSBlbnRyeSBmb3IgbmV4dCBzcGxpdAogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19GaXJzdE5hbWVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpIHsgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0xhc3ROYW1lX19jIiwgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19CaXJ0aGRhdGVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fU3RhdHVzX19jKSB7YXJyT2ZQYWlycy5wdXNoKHpwKyJTdGF0dXNfX2MiLCAiQ29tcGxldGVkIik7IH0gLy9QVjE5MTAyMyB1cGRhdGVpbmcgc3RhdHVzCiAgICB9Cn0KaWYgKHpEYXRhLmNhc2VJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0Nhc2VfX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5jYXNlSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmNhc2VJZDsKfQogYWxlcnQoIkBAQEAgekRhdGEuY29udGFjdElkID0gIiArIHpEYXRhLmNvbnRhY3RJZCk7CmlmICh6RGF0YS5jb250YWN0SWQgJiYgekRhdGEuY29udGFjdElkLnN0YXJ0c1dpdGgoIjAwMyIpKSB7CgogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhdGllbnRfX2MiLCB6RGF0YS5jb250YWN0SWQpOwp9CmlmICh6RGF0YS5sZWFkSWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiLCB6RGF0YS5sZWFkSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5sZWFkSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmxlYWRJZDsKfQppZiAoekRhdGEucmVmZXJyYWxJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1JlZmVycmFsX19jIiwgekRhdGEucmVmZXJyYWxJZCk7CiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnJlZmVycmFsSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLnJlZmVycmFsSWQ7Cn0KaWYgKHpEYXRhLlhfWlBBUEVSX19QaG9uZV9fYykgeyAvL1BWMTkxMDA2IFVQREFURUQgRk9SIFBIT05FCiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGhvbmVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fUGhvbmVfX2MpOwoKfQp2YXIgc3BlY2lhbEF1dGhJZCA9IFgoZG9jLCAiWF9TcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiKTsKYWxlcnQoIkBAQCB6RGF0YS5YX1NwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyAiICsgc3BlY2lhbEF1dGhJZCk7CnZhciBhdXRoRG9jVHlwZSA9IFgoZG9jLCAiWlBBUEVSX19mYXhUeXBlX19jIik7CmlmIChzcGVjaWFsQXV0aElkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIsIHNwZWNpYWxBdXRoSWQpOwogICAgLy9QVjE5MTExMyBJZiB3ZSBoYXZlIGEgU3BlY2lhbCBBdXRob3JpemF0aW9uLCBhdHRhY2ggdGhpcyBkb2N1bWVudCB0byBpdAogICAgdmFyIHNwZWNpYWxMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJTcGVjaWFsIEF1dGhvcml6YXRpb24iIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09IkFsbCIpewogICAgICAgIGF0dGFjaChkb2MsIHNwZWNpYWxMYWJlbCwgc3BlY2lhbEF1dGhJZCk7CiAgICB9Cn0KZWxzZSBpZiAoIlNBIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpIHsKICAgIHZhciBhdXRoQXJyT2ZQYWlycyA9IFtdOwogICAgdmFyIGF1dGhMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGF1dGhBcnJPZlBhaXJzLnB1c2goIk1lbWJlclBsYW5JZCIsIHpEYXRhLlhfTWVtYmVyX1BsYW5fX2MgLCAiQ0FfQ292ZXJhZ2VfQmVuZWZpdF9fYyIsIHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyApOwogICAgYXV0aEFyck9mUGFpcnMucHVzaCgiQ0FfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICBhdXRoQXJyT2ZQYWlycy5wdXNoKCJOYW1lIiwgImFueVZhbHVlIik7CiAgICB2YXIgc3BlY2lhbEF1dGhJZCA9IiI7CiAgICBpZiggekRhdGEuYXR0YWNoZWRUbyA9PT0iU3BlY2lhbCBBdXRob3JpemF0aW9uIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICBzcGVjaWFsQXV0aElkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNhcmVQcmVhdXRoIiwgYXV0aExhYmVsLCBhdXRoQXJyT2ZQYWlycyk7CiAgICB9ZWxzZXsKICAgICAgICBzcGVjaWFsQXV0aElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiQ2FyZVByZWF1dGgiLCBhdXRoTGFiZWwsIGF1dGhBcnJPZlBhaXJzKTsKICAgIH0KCiAgICBpZiAoIXNwZWNpYWxBdXRoSWQuY29udGFpbnMoIkVSUk9SIikpIHsKICAgICAgICB2YXIgYXV0aE5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNhcmVQcmVhdXRoIiwgIk5hbWUiLCBudWxsLCBzcGVjaWFsQXV0aElkKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIsIHNwZWNpYWxBdXRoSWQpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNTcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgc3BlY2lhbEF1dGhJZCArIGRxICsgIik7ICIpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNTcGVjaWFsX0F1dGhvcml6YXRpb25fX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBhdXRoTmFtZSArIGRxICsgIik7ICIpOwogICAgfQp9Ci8vQ1JOMTkxMTE4IElmIHdlIGFsc28gaGF2ZSBhIFBhdGllbnQgYW5kIGEgU3BlY2lhbCBBdXRob3JpemF0aW9uLCBhc3NvY2lhdGUgdGhlbS4KaWYgKHpEYXRhLnBhdGllbnRJZCAmJiBzcGVjaWFsQXV0aElkKSB7CiAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIFNwZWNpYWwgQXV0aG9yaXphdGlvbjogIiArIHNwZWNpYWxBdXRoSWQgKyAiIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICB2YXIgc2NyaXB0QXJyT2ZQYWlycyA9IFtdOwogICAgc2NyaXB0QXJyT2ZQYWlycy5wdXNoKCJDQV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNhcmVQcmVhdXRoIiwgc3BlY2lhbEF1dGhJZCwgc2NyaXB0QXJyT2ZQYWlycyk7Cn0KCi8vQ1JOMTkxMTE0IEhhbmRsZSBhbnkgcGFzc2VkLWluIHBoeXNpY2lhbiAoU2hvdWxkIHRoaXMgYmUgb25seSBmb3IgQ09NRFI6IENvbW11bmljYXRpb24gZnJvbSBQaHlzaWNpYW4/KQphbGVydCgiQEBAQCB6RGF0YS5YX1BoeXNpY2lhbl9fYyA9ICIgKyB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7CmFsZXJ0KCJAQEBAIFhfUGh5c2ljaWFuX19jID0gIiArIFgoZG9jLCAiWF9QaHlzaWNpYW5fX2MiKSk7CmlmIChYKGRvYywgIlhfUGh5c2ljaWFuX19jIikpIHsKICAgIHpEYXRhLlhfUGh5c2ljaWFuX19jID0gWChkb2MsICJYX1BoeXNpY2lhbl9fYyIpOwogICAgYWxlcnQoIkBAQEAgekRhdGEuWF9QaHlzaWNpYW5fX2Mgbm93ID0gIiArIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUGh5c2ljaWFuX19jIiwgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwogICAgdmFyIHBoeXNpY2lhbkxhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgYWxlcnQoIkBAQCBBdHRhY2hpbmcgdG8gUGh5c2ljaWFuX19jIHdpdGggSWQ6ICIgKyB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7CiAgICBhdHRhY2goZG9jLCBwaHlzaWNpYW5MYWJlbCwgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwp9CgovL1BWMTkxMDA4IHVwZGF0ZWQgbmV3IGZpZWxkcwppZih6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIsekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKTsKaWYoIHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYykgewogICAgaWYgKCF6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcmlvcml0eV9fYyIsekRhdGEuWF9aUEFQRVJfX1ByaW9yaXR5X19jKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcmlvcml0eV9fYyIsICIiKTsKICAgIH0KfQovL2lmKCB6RGF0YS5YX1N1Yl9DYXRlZ29yeV9fYyApICBhcnJPZlBhaXJzLnB1c2goIlN1Yl9DYXRlZ29yeV9fYyIsekRhdGEuWF9TdWJfQ2F0ZWdvcnlfX2MpOwphbGVydCgiQEBAQEAgQ2FsbGluZyBYIHRvIHB1bGwgWF9TdWJfQ2F0ZWdvcnlfX2MgPT4gIiArIFgoZG9jLCAiWF9TdWJfQ2F0ZWdvcnlfX2MiKSk7Ci8vQ1JOMjAwNTA0ICM3MTA1NCAtLSBXaGF0IHRoZSBoZWNrPyB6RGF0YSBkb2Vzbid0IHNlZW0gdG8gaGF2ZSBiZWVuIGluaXRpYWxpemVkCmlmKCBYKGRvYywgIlhfU3ViX0NhdGVnb3J5X19jIikgKSB7IGFyck9mUGFpcnMucHVzaCgiU3ViX0NhdGVnb3J5X19jIixYKGRvYywgIlhfU3ViX0NhdGVnb3J5X19jIikpOyB9CmlmKCB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIix6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyk7CmlmKCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyApICBhcnJPZlBhaXJzLnB1c2goIlByZXNjcmlwdGlvbl9fYyIsekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwppZiggekRhdGEuWF9NZW1iZXJfUGxhbl9fYyApICBhcnJPZlBhaXJzLnB1c2goIk1lbWJlcl9QbGFuX19jIix6RGF0YS5YX01lbWJlcl9QbGFuX19jKTsKaWYoIHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyApICBhcnJPZlBhaXJzLnB1c2goIkNvdmVyYWdlX0JlbmVmaXRfX2MiLHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyk7CmlmKCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jICkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19fYyIsekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7CiAgICAvL1BWMTkxMTEzIElmIHdlIGhhdmUgYSBDbGluaWNhbCBTZXJ2aWNlcywgYXR0YWNoIHRoaXMgZG9jdW1lbnQgdG8gaXQKICAgIHZhciBjbGluaWNhbExhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IkNsaW5pY2FsIFNlcnZpY2VzIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICBhdHRhY2goZG9jLCBjbGluaWNhbExhYmVsLCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsKICAgIH0KfQplbHNlIGlmICgoIkxBQiI9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIklOSlIiPT09ekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKICAgICAgIHx8ICJNRURDIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpICYmIFgoZG9jLCAiWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIikpIHsgICAgICAgIC8vQ1JOMTkxMTEzIENyZWF0ZSBuZXcgQ2xpbmljYWwgU2VydmljZXMgcmVjb3JkIGlmIERvY1R5cGUgaXMgTUVEQyBhbmQgdGhlIFNlcnZpY2UgUmVxdWVzdGVkIERhdGUgaXMgZmlsbGVkIGluCiAgICB2YXIgY2xpbmljYWxTdmNBcnJPZlBhaXJzID0gW107CiAgICB2YXIgY2xpbmljYWxTdmNMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVfUGxhbl9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICBjbGluaWNhbFN2Y0Fyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIGlmKCJMYWIgVGVzdHMiPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJDbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIsIjAxMjFpMDAwMDAwWTlEUkFBMCIpOwogICAgfQogICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIlNlcnZpY2VfUmVxdWVzdGVkX2RhdGVfX2MiLCBYKGRvYywgIlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyIpKTsKICAgIGlmKCJJbmplY3Rpb24gVHJhaW5pbmciPT09ekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyl7CiAgICAgICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyMWkwMDAwMDBZOURRQUEwIik7CiAgICB9CiAgICB2YXIgY2xpbmljYWxTdmNJZD0iIjsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJDbGluaWNhbCBTZXJ2aWNlcyIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgY2xpbmljYWxTdmNJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLCBjbGluaWNhbFN2Y0xhYmVsLCBjbGluaWNhbFN2Y0Fyck9mUGFpcnMpOwogICAgfWVsc2V7CiAgICAgICAgY2xpbmljYWxTdmNJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsIGNsaW5pY2FsU3ZjTGFiZWwsIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycyk7CiAgICB9CgogICAgaWYgKCFjbGluaWNhbFN2Y0lkLmNvbnRhaW5zKCJFUlJPUiIpKSB7CiAgICAgICAgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyA9IGNsaW5pY2FsU3ZjSWQ7CiAgICAgICAgekRhdGEuQ2xpbmljYWxOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLCAiTmFtZSIsIG51bGwsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOyAvL1BWMTkxMDIyCiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI0NsaW5pY2FsX1NlcnZpY2VzX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjQ2xpbmljYWxfU2VydmljZXNfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5DbGluaWNhbE5hbWUgKyBkcSArICIpOyAiKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX19jIiwgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7CgogICAgICAgIC8vQ1JOMTkxMTE4IElmIHdlIGFsc28gaGF2ZSBhIFBhdGllbnQgYW5kIGEgQ2xpbmljYWwgU2VydmljZSwgYXNzb2NpYXRlIHRoZW0uCiAgICAgICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgICAgICAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIENsaW5pY2FsIFNlcnZpY2U6ICIgKyBjbGluaWNhbFN2Y0lkICsgIiB3aXRoIFBhdGllbnQ6ICIgKyB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICB2YXIgc2NyaXB0QXJyT2ZQYWlycyA9IFtdOwogICAgICAgICAgICBzY3JpcHRBcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsIGNsaW5pY2FsU3ZjSWQsIHNjcmlwdEFyck9mUGFpcnMpOwogICAgICAgIH0KICAgIH0KfQoKaWYoIHpEYXRhLlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyApICBhcnJPZlBhaXJzLnB1c2goIlNlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiLHpEYXRhLlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyk7CmlmKCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJSZXBvcnRlZF9PdXRjb21lX19jIix6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwppZiggekRhdGEuWF9Bc3Nlc3NtZW50X1R5cGVfX2MgJiYgIkRPTk9UX1NBVkUiICE9PSB6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYykgIGFyck9mUGFpcnMucHVzaCgiQXNzZXNzbWVudF9UeXBlX19jIix6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYyk7CmlmKCB6RGF0YS5YX091dGNvbWVfVHlwZV9fYyAmJiAiRE9OT1RfU0FWRSIgIT09IHpEYXRhLlhfT3V0Y29tZV9UeXBlX19jKSAgYXJyT2ZQYWlycy5wdXNoKCJPdXRjb21lX1R5cGVfX2MiLHpEYXRhLlhfT3V0Y29tZV9UeXBlX19jKTsKaWYoekRhdGEuWF9Qcm9kdWN0X0Rlc2NyaWJlZF9fYykgYXJyT2ZQYWlycy5wdXNoKCJQcm9kdWN0X0Rlc2NyaWJlZF9fYyIsekRhdGEuWF9Qcm9kdWN0X0Rlc2NyaWJlZF9fYyk7CmlmKHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19sYXRlc3RGYXhfX2MiLHpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MpOwovL0VSUzE5MDgxNCBqdXN0IHRoZSBjaGlsZCAjNjE1MTEgdXBkYXRlU0ZSZWNvcmQoZG9jLCB6RGF0YS56cHMsIHNmU3RhY2tJZCwgYXJyT2ZQYWlycyk7Ci8vbGV0IHRoZSBkb2NTZXQgZG8gdGhlIHdvcmsgYXR0YWNoKGRvYyxhdHRhY2hMYWJlbCwgc2ZTdGFja0lkKTsKdmFyIHI9dXBkYXRlU0ZSZWNvcmQoZG9jLCJaUEFQRVJfX3pTdGFja19fYyIsc2ZTdGFja0lkLFsiWlBBUEVSX19TdGF0dXNfX2MiLCJTcGxpdCJdKTsgLy9QVjE5MTIxNgphbGVydCgiQEBAQCB1cGRhdGVkIGFuZCBhdHRhY2hlZCB0byB6U3RhY2sgUmVjb3JkLCBpZCA9ICIgKyBzZlN0YWNrSWQgKyAiPz0iK3pEYXRhLmdldFN0YWNrSWQoZG9jKSsiIGRhdGE9IithcnJPZlBhaXJzKTsKCnZhciBjaGlsZFN0YWNrSWQ9ekRhdGEuY2xpZW50Q2hpbGRTdGFjayhkb2MsYXJyT2ZQYWlycyxzZlN0YWNrSWQpOyAvL0VSUzE5MDgxMCBjcmVhdGUgY2hpbGQgc3RhY2sgZm9yIHNwbGl0IEVSUzE5MDgxMSBjbGllbnRDaGlsZFN0YWNrCmlmIChjaGlsZFN0YWNrSWQpIHthdHRhY2hQYXRoKz0iLCIrc2ZTdGFja0lkKyIsIitjaGlsZFN0YWNrSWQ7IGF0dGFjaFBhdGg9YXR0YWNoUGF0aC5yZXBsYWNlKCIvLD8iLCIvIik7IH0gLy9FUlMxOTA4MTEgIzYxNTcwIGNsZWFuIHVwIC8vcGFyZW50IHN0YWNrIHRvbwphcnJPZlBhaXJzPVtdOy8vUFYxOTEwMjMgRXZlcnl0aW1lIGNoaWxkIHdpbGwgYXR0YWNoIHRvIHRoYXQgcGFydGljdWxhciB6U3RhY2sKYXJyT2ZQYWlycy5wdXNoKCJYX3NmU3RhY2tJZCIsY2hpbGRTdGFja0lkKTsKLy9DUk4xOTExMTggQ2xlYXIgb3V0IHRoZXNlIHZhbHVlcyBmcm9tIHBhcmVudCBzdGFjawphcnJPZlBhaXJzLnB1c2goIlhfaW5kZXhlZFBhZ2VzIiwiIik7CmFyck9mUGFpcnMucHVzaCgiWF9pZ25vcmVkUGFnZXMiLCIiKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3JlamVjdGVkUGFnZXMiLCIiKTsKdXBkYXRlREIoZG9jLGFyck9mUGFpcnMpOwovKiBNb3ZlIHRoZSBzcGxpdCBkb2N1bWVudCB0byBpdHMgcHJvY2Vzc2luZyBmb2xkZXIgKi8KYWxlcnQoIkBAQEBAQCBNb3ZpbmcgdGhlIGluZGV4ZWQgcGFnZXMgZG9jdW1lbnQgaW50byBuZXh0IHByb2Nlc3NpbmcgZm9sZGVyOiAiICsgbmV4dEZvbGRlcik7Ci8vRVJTMTkwNzMxICM2MTI3MiBtb3ZlRG9jdW1lbnQoZG9jLCIiLG5leHRGb2xkZXIpOwovL0VSUzE5MDczMSAjNjEyNzIgcmVsb2FkQnlCQVRFUyhkb2MsIG5leHRGb2xkZXIpOyAvL0VSUzE3MDQxMyAjMzUyOTEKLyogUGxhY2UgdGhlIHNwbGl0IGRvY3VtZW50IGludG8gdGhlIHN0YWNrIGZvbGRlciAqLwphbGVydCgiQEBAQEBAIE1vdmluZyB0aGUgaW5kZXhlZCBwYWdlcyBkb2N1bWVudCBpbnRvIHRoZSBmaW5hbCBzdGFjayBmb2xkZXI6ICIgKyBzdGFja0ZvbGRlcik7Cm1vdmVEb2N1bWVudChkb2MsIiIsc3RhY2tGb2xkZXIpOwp1bmxvY2tEb2N1bWVudChkb2MpOwphcnJPZlBhaXJzID0gekRhdGEuYWRkU3RhZ2UoZG9jLGFyck9mUGFpcnMsekRhdGEuc3RhZ2UpOwp2YXIgcGFnZUNvdW50ID0gekRhdGEuY291bnRQYWdlcyhkb2MscGFnZVJhbmdlKTsKYWxlcnQoIkBAQEAgcGFnZUNvdW50ID0gIiArIHBhZ2VDb3VudCArIiB3ZXJlICIrIHpEYXRhLnN0YWdlKTsKYXJyT2ZQYWlycy5wdXNoKCJYX3BhZ2VzIixwYWdlQ291bnQpOwphcnJPZlBhaXJzLnB1c2goIlhfY291bnQiLHBhZ2VDb3VudCk7IC8vUFYxOTEwMjggdXBkYXRlZCBmb3Igc3RhY2sgY29tcGxldGUgdG8gdXNlIGV4YWN0IHBhZ2VzCmFyck9mUGFpcnMucHVzaCgiZGItcGFnZXMiLHBhZ2VDb3VudCk7Ci8vRVJTMTkwNjIwIGFyck9mUGFpcnMucHVzaCgiZGItbGFiZWwiLCBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBjb21wYW55Q29kZSArICIgLSAiICsgc3RhY2tJZCk7Ci8vYXJyT2ZQYWlycy5wdXNoKCJYX2F0dGFjaGVkVG8iLGF0dGFjaFBhdGgpOyAvL0NSTjE5MTAyOCBXZSBkb24ndCBuZWVkIHRvIHVwZGF0ZSB0aGUgWF9hdHRhY2hlZFRvIGJlY2F1c2UgaXQgaXMgYmVpbmcgc2V0IGNvcnJlY3RseSBkdXJpbmcgZWFjaCBhdHRhY2guIEJlc2lkZXMsIGF0dGFjaFBhdGggaG9sZHMgdGhlIHBhcmVudCdzIG1hc3NhZ2VkIFhfYXR0YWNoZWRUbyB3aGljaCB3ZSBkb24ndCB3YW50LiAvL0VSUzE3MDYyOAp1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7CgovL1BWMTkxMDI5IEFkZCAiSW5kZXhlZCIgdG8gdGhlICJSZWNlaXZlZCIgWF9yZXZpZXdzIGFkZGVkIGluIGNsaWVudCBsaWJyYXJ5IGFib3ZlLgp2YXIgb3JpZ1hSZXZpZXdzID0gWChkb2MsICJYX3Jldmlld3MiKTsKdmFyIG5vdzAgPSBnZXRDdXJEYXRlQW5kVGltZShkb2MpOy8vUHYxOTEwMjkgY2hlY2sgZG9jc2V0IGNoZWNrYm94CmFyck9mUGFpcnMgPSBbXTsKYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld3MiLCBvcmlnWFJldmlld3MgKyAiSW5kZXhlZCBieSBhZ2VudCBhdCAiICsgbm93MCArICI8YnIvPiIpOwp1cGRhdGVEQihkb2MsIGFyck9mUGFpcnMpOwoKdHJhY2soZG9jLCAiRG9jIEluZGV4ZWQiLCAiRG9jdW1lbnQgd2l0aCBJZDogIiArIGRvYy5kYklELCBwYWdlQ291bnQpOwphZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIm5leHRQYWdlKH5yZWFkeX4pO3VwZGF0ZURFU3RhdHVzKH5pbmRleGVkOiIgKyBwYWdlUmFuZ2UgKyAifik7Iik7CgovKiBlbmQgb2YgcnVsZSAqLw=="},"ordinal":9}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
//ASM 2020-01-09 - Fixes field for birthdate
//ERS200412 TODO significant work to move customization into client library

alert("@@@@ Index Rule Fired @@@#");
//ERS190730 #61272 updated button validation in the Actions* Details area

var stackId = X(doc, "X_stack");
if (!stackId || stackId.indexOf("a") !== 0) stackId=zData.getStackId(doc); //ERS190624 HACK?
if (stackId) zData.stackId=stackId; //ERS200204 #68825 much better for client calls
var stackFolder = stackId + "-STACK";
var companyCode = doc.deliveredTo;
zData.stage="Indexed"; //ERS190620

/* Clear the trigger that invoked this rule */
//ERS170909 zData.clearTriggerCondition(doc,"X_buttonAction");
var indexInitialized = X(doc,"X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    zData.initializeStack(doc,stackFolder, companyCode, stackId);
}

saveDEPanelValues(doc);             //CRN191118 Save DE Fields to Parent Stack  //ERS200412 TODO into MP
zData.getDataEntryFields(doc);
// Does the user want to attach indexed pages to Case?
//var caseId = X(doc, "X_ZPAPER__Case__c");
//var contactId = X(doc, "X_ZPAPER__Patient__c");
//var patientId=contactId; //TODO
//var providerId = X(doc, "X_ZPAPER__Provider__c");
//var patientFirstName = X(doc, "X_ZPAPER__FirstName__c");
//var patientLastName = X(doc, "X_ZPAPER__LastName__c");
//var patientDOB = X(doc, "X_ZPAPER__Birthdate__c");

//zData.clientCopyFromDoc(doc); //ERS200309 splits fragment zippi zData
if (!zData.patientId && X(doc,"X_patientId")) zData.patientId=X(doc,"X_patientId");
if (!zData.patientId && X(doc,"X_ZPAPER__Patient__c")) zData.patientId=X(doc,"X_ZPAPER__Patient__c"); //ERS200205 keep track of IDs better
if (!zData.patientId && X(doc,"X_ZPAPER__PatientAccount__c")) zData.patientId=X(doc,"X_ZPAPER__PatientAccount__c"); //ERS200308 #70273

if (!zData.providerId && X(doc,"X_ZPAPER__Provider__c")) zData.providerId=X(doc,"X_ZPAPER__Provider__c"); //ERS200308 #70273
if (!zData.providerId && X(doc,"X_ProviderContact__c")) zData.providerId=X(doc,"X_ProviderContact__c"); //ERS200308 #70273 TODO zp+
if (!zData.providerId && X(doc,"X_ZPAPER__ProviderContact__c")) zData.providerId=X(doc,"X_ZPAPER__ProviderContact__c"); //ERS200308 #70273 TODO zp+
alert("ERS200309.38 providerId="+zData.providerId +" from "+X(doc,"X_ProviderContact__c")
   +" and patientId="+zData.patientId+" from "+X(doc,"X_ZPAPER__PatientAccount__c")); //ERS200309 get the Ids

if (!zData.caseId) zData.caseId=X(doc,"X_ZPAPER__Case__c"); ////ERS200205 zippi changes

// Get the document type (will be used to route to next folder)
//var docType = X(doc, "X_Document_Type__c");
var nextFolder = "20500Triage-S2";              // Other folder is the default
var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
//move to after updates arrOfPairs=zData.addStage(doc,arrOfPairs,"Indexed");
updateDB(doc,arrOfPairs);

//var sfStackId=zData.getStackId(doc);
var sfStackId=X(doc,'X_sfStackId');
if(!sfStackId){
  sfStackId=zData.getStackId(doc);
}

alert("@@@@@@ Currently attached to ZPAPER__zStack__c with ID: " + sfStackId);
zData.zParentId=doc.dbID; //ERS190814 to overside the save.jsp workflows

alert("@@@@ Parent zStack Snippet attached to: " + X(doc, "X_attachedTo"));

/* SPLIT OFF NEW SNIPPET HERE */
var pageRange = X(doc,"X_idxPages");
var newId=splitDocumentForIndex(doc, "index", pageRange);

alert("@@@@ AFTER SPLIT: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));

saveDEPanelValues(doc);             //CRN191118 Also Save DE Fields to Child Stack //ERS200412 TODO into MP

alert("ERS190624 newId="+newId);
//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/* Attach the split document to a new Case record, if it wasn't passed in and if we are not handling the 2A DE Panel: Canada_Priority_Data2_Web_Form */
//var priority=X(doc,"X_ZPAPER__Priority__c"); //ERS170626
var label0="";
var triageType=doc.docType;
if (!triageType || triageType == "FAX") triageType=X(doc,"X_ZPAPER__faxType__c"); //ERS200205 doc.docType;
zData.docType=triageType; alert("Using ERS200205 docType="+zData.docType); //ERS200205 @68825

var attachPath = X(doc,"X_attachedTo");
zData.attachedToCase =false;
zData.attachedTo = X(doc, "X_Attach_To__c"); //PV191205 updated case creation
    alert("zData.attachedTo========="+zData.attachedTo);
    var attachFaxTypes =["ENRL","MEDO","OTH","COPAY"];
    //if( attachFaxTypes.indexOf(zData.X_ZPAPER__faxType__c) >-1 && (zData.attachedTo === "Care Plan" || zData.attachedTo === "All")){
    if((zData.attachedTo === "Care Plan" || zData.attachedTo === "All")){
      zData.attachedToCase = true;
    }
/* Attach the split document to Patient record if required */ //ERS190619
zData.patientType=XCustomSetting(doc,"ZPAPER__PatientRecord__c"); //ERS190806 ZPAPER__ now in MP
alert("@@@@ zData.patientType ***** "+zData.patientType+" Patient");
alert("@@@ current DE Panel name = " + X(doc, "X_lastDEPanel"));
if (!zData.patientType) zData.patientType="Contact"; //ERS190802 #61272
//if (X(doc,"X_ZPAPER__Patient__c") || zData.X_ZPAPER__LastName__c) { //ERS190803 TODO rethink use X
    var dq = zData.dq = String.fromCharCode(34); //ERS190802 TODO define better in zData
    var patientPhone = X(doc, "X_ZPAPER__Phone__c");
    alert("@@@ patientPhone = " + patientPhone);
    if (!zData.patientId) {
        alert("@@@@ creating new "+zData.patientType+" Patient");
        arrOfPairs = [];
        //ERS190730 #61272 missing the basics
        var p="";
        if ("Account"===zData.patientType) { //ERS190803
            p="Person";
            //arrOfPairs.push("Name", zData.X_ZPAPER__FirstName__c+" "+zData.X_ZPAPER__LastName__c);
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c);
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
//                arrOfPairs.push(p+"Birthdate", zData.X_ZPAPER__Birthdate__c);
                arrOfPairs.push("Core_Birth_Date__pc", zData.X_ZPAPER__Birthdate__c); //ASM20200109 - Using the correct field. //CRN200108 abbvie wants birthdate stored in this field, not standard field
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        } else {
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c); //X_ZPAPER__FirstName__c //ERS190803 TODO get cleaner #61272
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push("Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        }
        var attachLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
        zData.patientId=zData.clientPatient(doc,arrOfPairs, attachLabel);
        alert("Created Patient with ID: " + zData.patientId);
        if (zData.patientId == "null" || zData.patientId == "NEW") zData.patientId=null;
        else { //ERS190730 #61272 leverage the new record
            if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
            alert("@@@@@@@ NEW PATIENT CREATED WITH ID: " + zData.patientId); //ERS190802 zData.contactId
            // clear out the "New Patient" fields
            if (1===1) { //ERS190811 #61570 commented out so that patient info is available for DE variables in zippi
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Phone__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + "NONE" + dq + "); ");
            }
            // set the Patient lookup fields
            //ERS190803 TODO handle ZPAPER__ relationships //ERS190811 double up for safety
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            //CRN191118 Also save the new values to the child
            var save2DBArrOfPairs = [];
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__c", zData.patientId);
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__r.Name", zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c);
            updateDB(doc, save2DBArrOfPairs);
        }
    } else {
        //if (zData.X_ZPAPER__faxType__c && ("CONS" === zData.X_ZPAPER__faxType__c
         //   || "ENRL" ===zData.X_ZPAPER__faxType__c ||
         //  "MEDO" === zData.X_ZPAPER__faxType__c)) { //ERS19109 #64921 TODO many journey best proctice
            alert("@@@@ attaching to existing Patient: " + zData.patientId);
            if (zData.patientType != "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "FirstName,LastName,Birthdate", null, zData.patientId);
                alert("@@@@ attaching to existing contactFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "FirstName", contactFlds); //PV191006 update the child stack
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "LastName", contactFlds);
                zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "Birthdate", contactFlds);
            } else if (zData.patientType === "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "Name", null, zData.patientId);
                alert("@@@@ attaching to existing AccountFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "Name", contactFlds).split(" ")[0]; //ERS190803 TODO find a better way
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "Name", contactFlds).split(" ")[1];
                //zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "PersonBirthdate", contactFlds);

            }
            //PV191008 updated attachLabel on child stack
            attachLabel=zData.clientFile(doc,"Indexed");
            if(zData.attachedTo === "Patient" || zData.attachedTo === "All"){
                attach(doc, attachLabel, zData.patientId);
            }
      // }
    }
    if (zData.patientId && attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
//}
alert("@@@@ AFTER PATIENT: Child zStack Snippet attached to: " + attachPath);

var attachLabel=zData.clientFile(doc,"Indexed"); //"Indexed " + formatNow;
alert("ERS190624 attachLabel="+attachLabel);


/* Attach the split document to Lead record if required */ //ERS190619
// TODO ERS190624 flip the if logic
if (doc.wddata.indexOf("X_ZPAPER__ReferralLead__c")>-1) { //ERS190803 TODO rethink
    if (!leadId || 0 === leadId.length) {
        alert("@@@@ creating new Lead");
        arrOfPairs = [];
        leadId=zData.clientLead(doc,arrOfPairs);
        alert("Created Lead with ID: " + leadId);
        if (leadId == "null" || leadId == "NEW") leadId=null;
    } else {
        if (zData.attachRecords.indexOf("Lead")>-1) {
            alert("@@@@ attaching to existing Lead: " + leadId);
            attach(doc, attachLabel, leadId);
        }
    }
    if (leadId && attachPath.indexOf(leadId)==-1) attachPath+=","+leadId;
}
alert("@@@@ AFTER LEAD: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//ERS190620 use a setting to determine which lookups we attach to
/* Attach the split document to Case record if required */ //ERS190619
//if (doc.wddata.indexOf("X_ZPAPER__Case__c")>-1) {
  if(1===1){
    alert("ERS190624 need Case");
    if (zData.caseId) {
        if (zData.attachRecords.indexOf("Case")>-1) {
            alert("@@@@ attaching to existing Case: " + zData.caseId);
            attachLabel=zData.clientFile(doc,"Indexed");
            if(zData.attachedToCase){
                attach(doc, attachLabel, zData.caseId);
            }
        }
    }
    alert("ERS190624.78 have a case?");
    if (zData.caseId && attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}

alert("@@@@ AFTER CASE: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//PV191022 create prescription
var stackFlds = getSFFields(doc, "ZPAPER__zStack__c", "ZPAPER__latestFax__c", null, sfStackId);
zData.X_ZPAPER__latestFax__c =  X(doc, "ZPAPER__latestFax__c", stackFlds); //PV190926 update the child stack
if( zData.X_Prescription__c){
    alert("@@@@ attaching to existing Prescription: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    if( zData.attachedTo ==="Prescription" || zData.attachedTo ==="All"){
        attach(doc, attachLabel, zData.X_Prescription__c);
    }
}
if( !zData.X_Prescription__c && zData.X_ZPAPER__faxType__c &&"RX" === zData.X_ZPAPER__faxType__c ) { //ERS191109 #64921 TODO many journeys
    alert("@@@@ Creating  Prescription__c with fax Type : " + zData.X_ZPAPER__faxType__c);
    arrOfPairs = [];
    arrOfPairs.push("Core_Date_of_Prescription_Received__c",zData.X_ZPAPER__latestFax__c);
    arrOfPairs.push("Core_ProductPrescribed__c",zData.X_ZPAPER__Classification__c);
    arrOfPairs.push("Core_CarePlan__c", zData.caseId);
    arrOfPairs.push("Core_Patient__c", zData.patientId);
    if( zData.attachedTo ==="Prescription" || zData.attachedTo ==="All"){
        zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");
    }else{
        zData.X_Prescription__c = zData.clientRecordTypeNoAttach(doc,"Core_Prescription__c",arrOfPairs,"Index");
    }
    //zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");  CRN191213 Don't create the Prescription multiple times
    alert("@@@@ Create Prescription__c with ID: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    //attach(doc, attachLabel, zData.X_Prescription__c);
    zData.PrescriptionName = getSFField(doc, "Core_Prescription__c", "Name", null, zData.X_Prescription__c); //PV191022 //ERS191109 clientIndex?
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c" + dq + ").val(" + dq + zData.X_Prescription__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c_Name" + dq + ").val(" + dq + zData.PrescriptionName + dq + "); ");

}
//CRN191118 If we also have a patient and a Prescription, associate them.
/*
if (zData.patientId && zData.X_Prescription__c) {
    alert("@@@ Associating Prescription: " + zData.X_Prescription__c + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
    updateSFRecord(doc, "Core_Prescription__c", zData.X_Prescription__c, scriptArrOfPairs);
}
*/

//COMDR
//if( !zData.caseId && ("COMDR" === zData.X_ZPAPER__faxType__c
//     || "MEDC"=== zData.X_ZPAPER__faxType__c || "LAB"=== zData.X_ZPAPER__faxType__c
//     || "INJR"===zData.X_ZPAPER__faxType__c)){
//CRN191114 According to the Abbvie stories, all docTypes except "Consent Forms" need to have a Case created if one isn't already selected
if(!zData.caseId && "CONS" !== zData.X_ZPAPER__faxType__c && 'Canada_Priority_Data2_Web_Form' !== X(doc, "X_lastDEPanel")) {
    arrOfPairs = [];
    arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");               // CRN191114 Always use CarePlan Record Type?
    arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
    if(zData.programName === "Abbvie OneCRM - Canada"){
        arrOfPairs.push("Core_CountryCode__c","CA");
    }
    if (zData.patientId) { arrOfPairs.push("AccountId", zData.patientId); }
    if(zData.attachedToCase){
        zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
    }else{
        zData.caseId = zData.clientRecordTypeNoAttach(doc,"Case",arrOfPairs,"Index");
    }
    zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    zData.X_Clinical_Services_Record_Type__c = X(doc, "X_Clinical_Services_Record_Type__c");

/*
CRN191113 Moved below where the docType logic isn't so convoluted
    if("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c){
      arrOfPairs = [];
      if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24GQAS");
      }
      if("injection Training"===zData.X_Clinical_Services_Record_Type__c){

        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24LQAS");
      }

     //arrOfPairs.push("Service_Requested_date__c",zData.X_Service_Requested_Date__c);
     //arrOfPairs.push("Core_Patient__c",zData.patientId);
     if(!zData.X_Clinical_Services__c){
        associatedArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
        associatedArrOfPairs.push("Core_Patient__c", zData.patientId);
        zData.X_Clinical_Services__c = zData.clientRecordType(doc,"Core_Clinical_Service__c",arrOfPairs,"Index");
     }
     attachLabel=zData.clientFile(doc,"Indexed");
     attach(doc, attachLabel,  zData.X_Clinical_Services__c);
     zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
    }
    */
}

//SHR191209 #65535 add Document Link if we have a new Case Id
if (zData.caseId) {
    zData.clientLightningFile(doc,zData.caseId); //ERS200428 move to library #70953
}

//COPAY
if ("COPAY" === zData.X_ZPAPER__faxType__c) {
    arrOfPairs = [];
    arrOfPairs.push("CA_Patient__c",zData.patientId);
    arrOfPairs.push("CA_CarePlanID__c",zData.caseId);
    zData.copayId = zData.clientRecordType(doc,"CA_Copay__c",arrOfPairs,"Index");
}


//OTH
if( !zData.caseId && ("OTH" === zData.X_ZPAPER__faxType__c || "ENRL" === zData.X_ZPAPER__faxType__c
    || "MEDO" === zData.X_ZPAPER__faxType__c || "RX" === zData.X_ZPAPER__faxType__c )){
    if(zData.createCase){
        arrOfPairs = [];
        arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");
        arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
        if(zData.programName === "Abbvie OneCRM - Canada"){
            arrOfPairs.push("Core_CountryCode__c","CA");
        }

        zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
        zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    }
}

if( zData.X_Reported_Outcome__c){
    alert("@@@@ attaching to existing Outcome: " + zData.X_Reported_Outcome__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    if( zData.attachedTo ==="Reported Outcomes" || zData.attachedTo ==="All"){
        attach(doc, attachLabel, zData.X_Reported_Outcome__c);
    }
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating Reported Cutcome: " + zData.X_Reported_Outcome__c + " with Patient: " + zData.patientId);
        var outcomeArrOfPairs = [];
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
        updateSFRecord(doc, "Core_Patient_Reported_Outcomes__c", zData.X_Reported_Outcome__c, outcomeArrOfPairs);
    }
}
else if ("CA" === zData.X_ZPAPER__faxType__c) {
    var outcomeArrOfPairs = [];
    outcomeArrOfPairs.push("Core_Entry_Date__c", getCurDate(doc));
    outcomeArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    var assessmentType = X(doc, "X_Assessment_Type__c");
    if (assessmentType && "DONOT_SAVE" !== assessmentType) {
        outcomeArrOfPairs.push("Core_Assessment_Type__c", assessmentType);
    }
    var outcomeType = X(doc, "X_Outcome_Type__c");
    if (outcomeType && "DONOT_SAVE" !== outcomeType) {
        outcomeArrOfPairs.push("Core_Outcome_Type__c", outcomeType);
    }
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating New Reported Cutcome with Patient: " + zData.patientId);
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    }
    if( zData.attachedTo ==="Reported Outcomes" || zData.attachedTo ==="All"){
        zData.X_Reported_Outcome__c = zData.clientRecordType(doc,"Core_Patient_Reported_Outcomes__c",outcomeArrOfPairs,"Index");
    }else{
        zData.X_Reported_Outcome__c = zData.clientRecordTypeNoAttach(doc,"Core_Patient_Reported_Outcomes__c",outcomeArrOfPairs,"Index");
    }
    var outcomeName = getSFField(doc, "Core_Patient_Reported_Outcomes__c", "Name", null, zData.X_Reported_Outcome__c);
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c" + dq + ").val(" + dq + zData.X_Reported_Outcome__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c_Name" + dq + ").val(" + dq + outcomeName + dq + "); ");
}


arrOfPairs = [];
if (zData.docType) { arrOfPairs.push("ZPAPER__faxType__c", zData.docType);  } //ERS190810 PV190808 #51670
if (zData.providerId) {
    arrOfPairs.push("ZPAPER__Provider__c", zData.providerId);
    if (attachPath.indexOf(zData.providerId)==-1) attachPath+=","+zData.providerId;
}
alert("ERS190812.200 zData.patientId="+zData.patientId); //ERS190812 #61511
if (zData.patientId) {
    if (zData.patientId.indexOf("003")===0) arrOfPairs.push("ZPAPER__Patient__c", zData.patientId);
    if (zData.patientId.indexOf("001")===0) arrOfPairs.push("ZPAPER__PatientAccount__c", zData.patientId);
    if (zData.patientId.indexOf("00Q")===0) arrOfPairs.push("ZPAPER__ReferralLead__c", zData.patientId); //ERS190802 Lead
    if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
    if (1===1) { //ERS190810 PV190808 data entry for next split
        if (zData.X_ZPAPER__FirstName__c) { arrOfPairs.push("ZPAPER__FirstName__c", zData.X_ZPAPER__FirstName__c); }
        if (zData.X_ZPAPER__LastName__c) { arrOfPairs.push("ZPAPER__LastName__c", zData.X_ZPAPER__LastName__c); }
        if (zData.X_ZPAPER__Birthdate__c) { arrOfPairs.push("ZPAPER__Birthdate__c", zData.X_ZPAPER__Birthdate__c); }
        if (zData.X_ZPAPER__Status__c) {arrOfPairs.push(zp+"Status__c", "Completed"); } //PV191023 updateing status
    }
}
if (zData.caseId) {
    arrOfPairs.push("ZPAPER__Case__c", zData.caseId);
    if (attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}
 alert("@@@@ zData.contactId = " + zData.contactId);
if (zData.contactId && zData.contactId.startsWith("003")) {

    arrOfPairs.push("ZPAPER__Patient__c", zData.contactId);
}
if (zData.leadId) {
    arrOfPairs.push("ZPAPER__ReferralLead__c", zData.leadId);
    if (attachPath.indexOf(zData.leadId)==-1) attachPath+=","+zData.leadId;
}
if (zData.referralId) {
    arrOfPairs.push("ZPAPER__Referral__c", zData.referralId);
    if (attachPath.indexOf(zData.referralId)==-1) attachPath+=","+zData.referralId;
}
if (zData.X_ZPAPER__Phone__c) { //PV191006 UPDATED FOR PHONE
    arrOfPairs.push("ZPAPER__Phone__c", zData.X_ZPAPER__Phone__c);

}
var specialAuthId = X(doc, "X_Special_Authorization__c");
alert("@@@ zData.X_Special_Authorization__c " + specialAuthId);
var authDocType = X(doc, "ZPAPER__faxType__c");
if (specialAuthId) {
    arrOfPairs.push("Special_Authorization__c", specialAuthId);
    //PV191113 If we have a Special Authorization, attach this document to it
    var specialLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    if( zData.attachedTo ==="Special Authorization" || zData.attachedTo ==="All"){
        attach(doc, specialLabel, specialAuthId);
    }
}
else if ("SA" === zData.X_ZPAPER__faxType__c) {
    var authArrOfPairs = [];
    var authLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    authArrOfPairs.push("MemberPlanId", zData.X_Member_Plan__c , "CA_Coverage_Benefit__c", zData.X_Coverage_Benefit__c );
    authArrOfPairs.push("CA_Patient__c", zData.patientId);
    authArrOfPairs.push("Name", "anyValue");
    var specialAuthId ="";
    if( zData.attachedTo ==="Special Authorization" || zData.attachedTo ==="All"){
        specialAuthId = createAndAttach(doc, "CarePreauth", authLabel, authArrOfPairs);
    }else{
        specialAuthId = createSFRecord(doc, "CarePreauth", authLabel, authArrOfPairs);
    }

    if (!specialAuthId.contains("ERROR")) {
        var authName = getSFField(doc, "CarePreauth", "Name", null, specialAuthId);
        arrOfPairs.push("Special_Authorization__c", specialAuthId);
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c" + dq + ").val(" + dq + specialAuthId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c_Name" + dq + ").val(" + dq + authName + dq + "); ");
    }
}
//CRN191118 If we also have a Patient and a Special Authorization, associate them.
if (zData.patientId && specialAuthId) {
    alert("@@@ Associating Special Authorization: " + specialAuthId + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("CA_Patient__c", zData.patientId);
    updateSFRecord(doc, "CarePreauth", specialAuthId, scriptArrOfPairs);
}

//CRN191114 Handle any passed-in physician (Should this be only for COMDR: Communication from Physician?)
alert("@@@@ zData.X_Physician__c = " + zData.X_Physician__c);
alert("@@@@ X_Physician__c = " + X(doc, "X_Physician__c"));
if (X(doc, "X_Physician__c")) {
    zData.X_Physician__c = X(doc, "X_Physician__c");
    alert("@@@@ zData.X_Physician__c now = " + zData.X_Physician__c);
    arrOfPairs.push("Physician__c", zData.X_Physician__c);
    var physicianLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    alert("@@@ Attaching to Physician__c with Id: " + zData.X_Physician__c);
    attach(doc, physicianLabel, zData.X_Physician__c);
}

//PV191008 updated new fields
if(zData.X_ZPAPER__Classification__c) arrOfPairs.push("ZPAPER__Classification__c",zData.X_ZPAPER__Classification__c);
if( zData.X_ZPAPER__Priority__c) {
    if (!zData.X_ZPAPER__faxType__c) {
        arrOfPairs.push("ZPAPER__Priority__c",zData.X_ZPAPER__Priority__c);
    }
    else {
        arrOfPairs.push("ZPAPER__Priority__c", "");
    }
}
//if( zData.X_Sub_Category__c )  arrOfPairs.push("Sub_Category__c",zData.X_Sub_Category__c);
alert("@@@@@ Calling X to pull X_Sub_Category__c => " + X(doc, "X_Sub_Category__c"));
//CRN200504 #71054 -- What the heck? zData doesn't seem to have been initialized
if( X(doc, "X_Sub_Category__c") ) { arrOfPairs.push("Sub_Category__c",X(doc, "X_Sub_Category__c")); }
if( zData.X_ZPAPER__faxType__c)  arrOfPairs.push("ZPAPER__faxType__c",zData.X_ZPAPER__faxType__c);
if( zData.X_Prescription__c )  arrOfPairs.push("Prescription__c",zData.X_Prescription__c);
if( zData.X_Member_Plan__c )  arrOfPairs.push("Member_Plan__c",zData.X_Member_Plan__c);
if( zData.X_Coverage_Benefit__c )  arrOfPairs.push("Coverage_Benefit__c",zData.X_Coverage_Benefit__c);
if( zData.X_Clinical_Services__c ) {
    arrOfPairs.push("Clinical_Services__c",zData.X_Clinical_Services__c);
    //PV191113 If we have a Clinical Services, attach this document to it
    var clinicalLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    if( zData.attachedTo ==="Clinical Services" || zData.attachedTo ==="All"){
        attach(doc, clinicalLabel, zData.X_Clinical_Services__c);
    }
}
else if (("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c) && X(doc, "X_Service_Requested_Date__c")) {        //CRN191113 Create new Clinical Services record if DocType is MEDC and the Service Requested Date is filled in
    var clinicalSvcArrOfPairs = [];
    var clinicalSvcLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    clinicalSvcArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    clinicalSvcArrOfPairs.push("Core_Patient__c", zData.patientId);
    if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0121i000000Y9DRAA0");
    }
    clinicalSvcArrOfPairs.push("Service_Requested_date__c", X(doc, "X_Service_Requested_Date__c"));
    if("Injection Training"===zData.X_Clinical_Services_Record_Type__c){
        clinicalSvcArrOfPairs.push("Clinical_Services_Record_Type__c","0121i000000Y9DQAA0");
    }
    var clinicalSvcId="";
    if( zData.attachedTo ==="Clinical Services" || zData.attachedTo ==="All"){
        clinicalSvcId = createAndAttach(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    }else{
        clinicalSvcId = createSFRecord(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    }

    if (!clinicalSvcId.contains("ERROR")) {
        zData.X_Clinical_Services__c = clinicalSvcId;
        zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
        arrOfPairs.push("Clinical_Services__c", zData.X_Clinical_Services__c);

        //CRN191118 If we also have a Patient and a Clinical Service, associate them.
        if (zData.patientId) {
            alert("@@@ Associating Clinical Service: " + clinicalSvcId + " with Patient: " + zData.patientId);
            var scriptArrOfPairs = [];
            scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
            updateSFRecord(doc, "Core_Clinical_Service__c", clinicalSvcId, scriptArrOfPairs);
        }
    }
}

if( zData.X_Service_Requested_Date__c )  arrOfPairs.push("Service_Requested_Date__c",zData.X_Service_Requested_Date__c);
if( zData.X_Reported_Outcome__c )  arrOfPairs.push("Reported_Outcome__c",zData.X_Reported_Outcome__c);
if( zData.X_Assessment_Type__c && "DONOT_SAVE" !== zData.X_Assessment_Type__c)  arrOfPairs.push("Assessment_Type__c",zData.X_Assessment_Type__c);
if( zData.X_Outcome_Type__c && "DONOT_SAVE" !== zData.X_Outcome_Type__c)  arrOfPairs.push("Outcome_Type__c",zData.X_Outcome_Type__c);
if(zData.X_Product_Described__c) arrOfPairs.push("Product_Described__c",zData.X_Product_Described__c);
if(zData.X_ZPAPER__latestFax__c) arrOfPairs.push("ZPAPER__latestFax__c",zData.X_ZPAPER__latestFax__c);
//ERS190814 just the child #61511 updateSFRecord(doc, zData.zps, sfStackId, arrOfPairs);
//let the docSet do the work attach(doc,attachLabel, sfStackId);
var r=updateSFRecord(doc,"ZPAPER__zStack__c",sfStackId,["ZPAPER__Status__c","Split"]); //PV191216
alert("@@@@ updated and attached to zStack Record, id = " + sfStackId + "?="+zData.getStackId(doc)+" data="+arrOfPairs);

var childStackId=zData.clientChildStack(doc,arrOfPairs,sfStackId); //ERS190810 create child stack for split ERS190811 clientChildStack
if (childStackId) {attachPath+=","+sfStackId+","+childStackId; attachPath=attachPath.replace("/,?","/"); } //ERS190811 #61570 clean up //parent stack too
arrOfPairs=[];//PV191023 Everytime child will attach to that particular zStack
arrOfPairs.push("X_sfStackId",childStackId);
//CRN191118 Clear out these values from parent stack
arrOfPairs.push("X_indexedPages","");
arrOfPairs.push("X_ignoredPages","");
arrOfPairs.push("X_rejectedPages","");
updateDB(doc,arrOfPairs);
/* Move the split document to its processing folder */
alert("@@@@@@ Moving the indexed pages document into next processing folder: " + nextFolder);
//ERS190731 #61272 moveDocument(doc,"",nextFolder);
//ERS190731 #61272 reloadByBATES(doc, nextFolder); //ERS170413 #35291
/* Place the split document into the stack folder */
alert("@@@@@@ Moving the indexed pages document into the final stack folder: " + stackFolder);
moveDocument(doc,"",stackFolder);
unlockDocument(doc);
arrOfPairs = zData.addStage(doc,arrOfPairs,zData.stage);
var pageCount = zData.countPages(doc,pageRange);
alert("@@@@ pageCount = " + pageCount +" were "+ zData.stage);
arrOfPairs.push("X_pages",pageCount);
arrOfPairs.push("X_count",pageCount); //PV191028 updated for stack complete to use exact pages
arrOfPairs.push("db-pages",pageCount);
//ERS190620 arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + stackId);
//arrOfPairs.push("X_attachedTo",attachPath); //CRN191028 We don't need to update the X_attachedTo because it is being set correctly during each attach. Besides, attachPath holds the parent's massaged X_attachedTo which we don't want. //ERS170628
updateDB(doc,arrOfPairs);

//PV191029 Add "Indexed" to the "Received" X_reviews added in client library above.
var origXReviews = X(doc, "X_reviews");
var now0 = getCurDateAndTime(doc);//Pv191029 check docset checkbox
arrOfPairs = [];
arrOfPairs.push("X_reviews", origXReviews + "Indexed by agent at " + now0 + "<br/>");
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");

/* end of rule */
//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---

//--- RULE VALIDATION CODE - END ---

</script>
