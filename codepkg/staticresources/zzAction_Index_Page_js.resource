<!--
// Name: Index Page
// Committer: andy.meadows@zpaper.com
// Update: Replaces the use of the default Birth Date to the Core_Birth_Date__pc field.
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2020-01-10 15:37:40","active":true,"button":"Index","name":"Index Page","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Index","operation":"equals"}]},"consequence":{"doit":"Ly9BU00gMjAyMC0wMS0wOSAtIEZpeGVzIGZpZWxkIGZvciBiaXJ0aGRhdGUKCmFsZXJ0KCJAQEBAIEluZGV4IFJ1bGUgRmlyZWQgQEBAIyIpOwovL0VSUzE5MDczMCAjNjEyNzIgdXBkYXRlZCBidXR0b24gdmFsaWRhdGlvbiBpbiB0aGUgQWN0aW9ucyogRGV0YWlscyBhcmVhCgp2YXIgc3RhY2tJZCA9IFgoZG9jLCAiWF9zdGFjayIpOwppZiAoIXN0YWNrSWQpIHN0YWNrSWQ9ekRhdGEuZ2V0U3RhY2tJZChkb2MpOyAvL0VSUzE5MDYyNCBIQUNLPwp2YXIgc3RhY2tGb2xkZXIgPSBzdGFja0lkICsgIi1TVEFDSyI7CnZhciBjb21wYW55Q29kZSA9IGRvYy5kZWxpdmVyZWRUbzsKekRhdGEuc3RhZ2U9IkluZGV4ZWQiOyAvL0VSUzE5MDYyMAoKLyogQ2xlYXIgdGhlIHRyaWdnZXIgdGhhdCBpbnZva2VkIHRoaXMgcnVsZSAqLwovL0VSUzE3MDkwOSB6RGF0YS5jbGVhclRyaWdnZXJDb25kaXRpb24oZG9jLCJYX2J1dHRvbkFjdGlvbiIpOwp2YXIgaW5kZXhJbml0aWFsaXplZCA9IFgoZG9jLCJYX2luZGV4SW5pdGlhbGl6ZWQiKTsKaWYgKCFpbmRleEluaXRpYWxpemVkIHx8IDAgPT09IGluZGV4SW5pdGlhbGl6ZWQubGVuZ3RoKSB7CiAgICBzdGFja0lkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiIjsKICAgIHN0YWNrRm9sZGVyID0gc3RhY2tJZCArICItU1RBQ0siOwogICAgekRhdGEuaW5pdGlhbGl6ZVN0YWNrKGRvYyxzdGFja0ZvbGRlciwgY29tcGFueUNvZGUsIHN0YWNrSWQpOwp9CgpzYXZlREVQYW5lbFZhbHVlcyhkb2MpOyAgICAgICAgICAgICAvL0NSTjE5MTExOCBTYXZlIERFIEZpZWxkcyB0byBQYXJlbnQgU3RhY2sKekRhdGEuZ2V0RGF0YUVudHJ5RmllbGRzKGRvYyk7Ci8vIERvZXMgdGhlIHVzZXIgd2FudCB0byBhdHRhY2ggaW5kZXhlZCBwYWdlcyB0byBDYXNlPwovL3ZhciBjYXNlSWQgPSBYKGRvYywgIlhfWlBBUEVSX19DYXNlX19jIik7Ci8vdmFyIGNvbnRhY3RJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX1BhdGllbnRfX2MiKTsKLy92YXIgcGF0aWVudElkPWNvbnRhY3RJZDsgLy9UT0RPCi8vdmFyIHByb3ZpZGVySWQgPSBYKGRvYywgIlhfWlBBUEVSX19Qcm92aWRlcl9fYyIpOwovL3ZhciBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJYX1pQQVBFUl9fRmlyc3ROYW1lX19jIik7Ci8vdmFyIHBhdGllbnRMYXN0TmFtZSA9IFgoZG9jLCAiWF9aUEFQRVJfX0xhc3ROYW1lX19jIik7Ci8vdmFyIHBhdGllbnRET0IgPSBYKGRvYywgIlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MiKTsKCi8vIEdldCB0aGUgZG9jdW1lbnQgdHlwZSAod2lsbCBiZSB1c2VkIHRvIHJvdXRlIHRvIG5leHQgZm9sZGVyKQovL3ZhciBkb2NUeXBlID0gWChkb2MsICJYX0RvY3VtZW50X1R5cGVfX2MiKTsKdmFyIG5leHRGb2xkZXIgPSAiMjA1MDBUcmlhZ2UtUzIiOyAgICAgICAgICAgICAgLy8gT3RoZXIgZm9sZGVyIGlzIHRoZSBkZWZhdWx0CnZhciBwcmV2SW5kZXhQYWdlcyA9IFgoZG9jLCAiWF9pbmRleGVkUGFnZXMiKTsKdmFyIGN1ckluZGV4UGFnZXMgPSBYKGRvYywgIlhfaWR4UGFnZXMiKTsKaWYgKHByZXZJbmRleFBhZ2VzICYmIHByZXZJbmRleFBhZ2VzLmxlbmd0aCA+IDAgJiYgY3VySW5kZXhQYWdlcyAmJiBjdXJJbmRleFBhZ2VzLmxlbmd0aCA+IDApIHsKICAgIHByZXZJbmRleFBhZ2VzICs9ICIsIjsKfQpjdXJJbmRleFBhZ2VzID0gcHJldkluZGV4UGFnZXMgKyBjdXJJbmRleFBhZ2VzOwp2YXIgYXJyT2ZQYWlycyA9IFtdOwphcnJPZlBhaXJzLnB1c2goIlhfaW5kZXhlZFBhZ2VzIiwgY3VySW5kZXhQYWdlcyk7Ci8vbW92ZSB0byBhZnRlciB1cGRhdGVzIGFyck9mUGFpcnM9ekRhdGEuYWRkU3RhZ2UoZG9jLGFyck9mUGFpcnMsIkluZGV4ZWQiKTsKdXBkYXRlREIoZG9jLGFyck9mUGFpcnMpOwoKLy92YXIgc2ZTdGFja0lkPXpEYXRhLmdldFN0YWNrSWQoZG9jKTsKdmFyIHNmU3RhY2tJZD1YKGRvYywnWF9zZlN0YWNrSWQnKTsKaWYoIXNmU3RhY2tJZCl7CiAgc2ZTdGFja0lkPXpEYXRhLmdldFN0YWNrSWQoZG9jKTsKfQoKYWxlcnQoIkBAQEBAQCBDdXJyZW50bHkgYXR0YWNoZWQgdG8gWlBBUEVSX196U3RhY2tfX2Mgd2l0aCBJRDogIiArIHNmU3RhY2tJZCk7CnpEYXRhLnpQYXJlbnRJZD1kb2MuZGJJRDsgLy9FUlMxOTA4MTQgdG8gb3ZlcnNpZGUgdGhlIHNhdmUuanNwIHdvcmtmbG93cwoKYWxlcnQoIkBAQEAgUGFyZW50IHpTdGFjayBTbmlwcGV0IGF0dGFjaGVkIHRvOiAiICsgWChkb2MsICJYX2F0dGFjaGVkVG8iKSk7CgovKiBTUExJVCBPRkYgTkVXIFNOSVBQRVQgSEVSRSAqLwp2YXIgcGFnZVJhbmdlID0gWChkb2MsIlhfaWR4UGFnZXMiKTsKdmFyIG5ld0lkPXNwbGl0RG9jdW1lbnRGb3JJbmRleChkb2MsICJpbmRleCIsIHBhZ2VSYW5nZSk7CgphbGVydCgiQEBAQCBBRlRFUiBTUExJVDogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBYKGRvYywgIlhfYXR0YWNoZWRUbyIpKTsKCnNhdmVERVBhbmVsVmFsdWVzKGRvYyk7ICAgICAgICAgICAgIC8vQ1JOMTkxMTE4IEFsc28gU2F2ZSBERSBGaWVsZHMgdG8gQ2hpbGQgU3RhY2sKCmFsZXJ0KCJFUlMxOTA2MjQgbmV3SWQ9IituZXdJZCk7Ci8vKgovKiBBRlRFUiBUSElTIFBPSU5ULCBUSEUgRE9DIFdJTEwgSE9MRCBEQVRBIEZPUiBORVcgU05JUFBFVCwgTk9UIFRIRSBTVEFDSyBTTklQUEVUICovCi8vKgoKLyogQXR0YWNoIHRoZSBzcGxpdCBkb2N1bWVudCB0byBhIG5ldyBDYXNlIHJlY29yZCwgaWYgaXQgd2Fzbid0IHBhc3NlZCBpbiBhbmQgaWYgd2UgYXJlIG5vdCBoYW5kbGluZyB0aGUgMkEgREUgUGFuZWw6IENhbmFkYV9Qcmlvcml0eV9EYXRhMl9XZWJfRm9ybSAqLwovL3ZhciBwcmlvcml0eT1YKGRvYywiWF9aUEFQRVJfX1ByaW9yaXR5X19jIik7IC8vRVJTMTcwNjI2CnZhciBsYWJlbDA9IiI7CnZhciB0cmlhZ2VUeXBlPWRvYy5kb2NUeXBlOwoKdmFyIGF0dGFjaFBhdGggPSBYKGRvYywiWF9hdHRhY2hlZFRvIik7CnpEYXRhLmF0dGFjaGVkVG9DYXNlID1mYWxzZTsKekRhdGEuYXR0YWNoZWRUbyA9IFgoZG9jLCAiWF9BdHRhY2hfVG9fX2MiKTsgLy9QVjE5MTIwNSB1cGRhdGVkIGNhc2UgY3JlYXRpb24KICAgIGFsZXJ0KCJ6RGF0YS5hdHRhY2hlZFRvPT09PT09PT09Iit6RGF0YS5hdHRhY2hlZFRvKTsKICAgIHZhciBhdHRhY2hGYXhUeXBlcyA9WyJFTlJMIiwiTUVETyIsIk9USCIsIkNPUEFZIl07CiAgICAvL2lmKCBhdHRhY2hGYXhUeXBlcy5pbmRleE9mKHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSA+LTEgJiYgKHpEYXRhLmF0dGFjaGVkVG8gPT09ICJDYXJlIFBsYW4iIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09ICJBbGwiKSl7CiAgICBpZigoekRhdGEuYXR0YWNoZWRUbyA9PT0gIkNhcmUgUGxhbiIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0gIkFsbCIpKXsKICAgICAgekRhdGEuYXR0YWNoZWRUb0Nhc2UgPSB0cnVlOwogICAgfQovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIFBhdGllbnQgcmVjb3JkIGlmIHJlcXVpcmVkICovIC8vRVJTMTkwNjE5CnpEYXRhLnBhdGllbnRUeXBlPVhDdXN0b21TZXR0aW5nKGRvYywiWlBBUEVSX19QYXRpZW50UmVjb3JkX19jIik7IC8vRVJTMTkwODA2IFpQQVBFUl9fIG5vdyBpbiBNUAphbGVydCgiQEBAQCB6RGF0YS5wYXRpZW50VHlwZSAqKioqKiAiK3pEYXRhLnBhdGllbnRUeXBlKyIgUGF0aWVudCIpOwphbGVydCgiQEBAIGN1cnJlbnQgREUgUGFuZWwgbmFtZSA9ICIgKyBYKGRvYywgIlhfbGFzdERFUGFuZWwiKSk7CmlmICghekRhdGEucGF0aWVudFR5cGUpIHpEYXRhLnBhdGllbnRUeXBlPSJDb250YWN0IjsgLy9FUlMxOTA4MDIgIzYxMjcyCi8vaWYgKFgoZG9jLCJYX1pQQVBFUl9fUGF0aWVudF9fYyIpIHx8IHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYykgeyAvL0VSUzE5MDgwMyBUT0RPIHJldGhpbmsgdXNlIFgKICAgIHZhciBkcSA9IHpEYXRhLmRxID0gU3RyaW5nLmZyb21DaGFyQ29kZSgzNCk7IC8vRVJTMTkwODAyIFRPRE8gZGVmaW5lIGJldHRlciBpbiB6RGF0YQogICAgdmFyIHBhdGllbnRQaG9uZSA9IFgoZG9jLCAiWF9aUEFQRVJfX1Bob25lX19jIik7CiAgICBhbGVydCgiQEBAIHBhdGllbnRQaG9uZSA9ICIgKyBwYXRpZW50UGhvbmUpOwogICAgaWYgKCF6RGF0YS5wYXRpZW50SWQpIHsKICAgICAgICBhbGVydCgiQEBAQCBjcmVhdGluZyBuZXcgIit6RGF0YS5wYXRpZW50VHlwZSsiIFBhdGllbnQiKTsKICAgICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgICAgLy9FUlMxOTA3MzAgIzYxMjcyIG1pc3NpbmcgdGhlIGJhc2ljcwogICAgICAgIHZhciBwPSIiOwogICAgICAgIGlmICgiQWNjb3VudCI9PT16RGF0YS5wYXRpZW50VHlwZSkgeyAvL0VSUzE5MDgwMwogICAgICAgICAgICBwPSJQZXJzb24iOwogICAgICAgICAgICAvL2Fyck9mUGFpcnMucHVzaCgiTmFtZSIsIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MrIiAiK3pEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyk7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiRmlyc3ROYW1lIiwgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyk7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiTGFzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogICAgICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgewovLyAgICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2gocCsiQmlydGhkYXRlIiwgekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyk7CiAgICAgICAgICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQmlydGhfRGF0ZV9fcGMiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsgLy9BU00yMDIwMDEwOSAtIFVzaW5nIHRoZSBjb3JyZWN0IGZpZWxkLiAvL0NSTjIwMDEwOCBhYmJ2aWUgd2FudHMgYmlydGhkYXRlIHN0b3JlZCBpbiB0aGlzIGZpZWxkLCBub3Qgc3RhbmRhcmQgZmllbGQKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGF0aWVudFBob25lKSB7IGFyck9mUGFpcnMucHVzaCgiUGhvbmUiLCBwYXRpZW50UGhvbmUpOyB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJGaXJzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKTsgLy9YX1pQQVBFUl9fRmlyc3ROYW1lX19jIC8vRVJTMTkwODAzIFRPRE8gZ2V0IGNsZWFuZXIgIzYxMjcyCiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiTGFzdE5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpOwogICAgICAgICAgICBpZiAoekRhdGEuWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYykgewogICAgICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJCaXJ0aGRhdGUiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGF0aWVudFBob25lKSB7IGFyck9mUGFpcnMucHVzaCgiUGhvbmUiLCBwYXRpZW50UGhvbmUpOyB9CiAgICAgICAgfQogICAgICAgIHZhciBhdHRhY2hMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgICAgICB6RGF0YS5wYXRpZW50SWQ9ekRhdGEuY2xpZW50UGF0aWVudChkb2MsYXJyT2ZQYWlycywgYXR0YWNoTGFiZWwpOwogICAgICAgIGFsZXJ0KCJDcmVhdGVkIFBhdGllbnQgd2l0aCBJRDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgaWYgKHpEYXRhLnBhdGllbnRJZCA9PSAibnVsbCIgfHwgekRhdGEucGF0aWVudElkID09ICJORVciKSB6RGF0YS5wYXRpZW50SWQ9bnVsbDsKICAgICAgICBlbHNlIHsgLy9FUlMxOTA3MzAgIzYxMjcyIGxldmVyYWdlIHRoZSBuZXcgcmVjb3JkCiAgICAgICAgICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucGF0aWVudElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5wYXRpZW50SWQ7CiAgICAgICAgICAgIGFsZXJ0KCJAQEBAQEBAIE5FVyBQQVRJRU5UIENSRUFURUQgV0lUSCBJRDogIiArIHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMTkwODAyIHpEYXRhLmNvbnRhY3RJZAogICAgICAgICAgICAvLyBjbGVhciBvdXQgdGhlICJOZXcgUGF0aWVudCIgZmllbGRzCiAgICAgICAgICAgIGlmICgxPT09MSkgeyAvL0VSUzE5MDgxMSAjNjE1NzAgY29tbWVudGVkIG91dCBzbyB0aGF0IHBhdGllbnQgaW5mbyBpcyBhdmFpbGFibGUgZm9yIERFIHZhcmlhYmxlcyBpbiB6aXBwaQogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19GaXJzdE5hbWVfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIiIgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fTGFzdE5hbWVfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgIiIgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQmlydGhkYXRlX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX1Bob25lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0JpcnRoZGF0ZV9fY19yZWFkYWJsZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiTk9ORSIgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBzZXQgdGhlIFBhdGllbnQgbG9va3VwIGZpZWxkcwogICAgICAgICAgICAvL0VSUzE5MDgwMyBUT0RPIGhhbmRsZSBaUEFQRVJfXyByZWxhdGlvbnNoaXBzIC8vRVJTMTkwODExIGRvdWJsZSB1cCBmb3Igc2FmZXR5CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX1BhdGllbnRfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEucGF0aWVudElkICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX1BhdGllbnRfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsgIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgZHEgKyAiKTsgIik7CiAgICAgICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLnBhdGllbnRJZCArIGRxICsgIik7ICIpOwogICAgICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50QWNjb3VudF9fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyAiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyBkcSArICIpOyAiKTsKICAgICAgICAgICAgLy9DUk4xOTExMTggQWxzbyBzYXZlIHRoZSBuZXcgdmFsdWVzIHRvIHRoZSBjaGlsZAogICAgICAgICAgICB2YXIgc2F2ZTJEQkFyck9mUGFpcnMgPSBbXTsKICAgICAgICAgICAgc2F2ZTJEQkFyck9mUGFpcnMucHVzaCgiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgc2F2ZTJEQkFyck9mUGFpcnMucHVzaCgiWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19yLk5hbWUiLCB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsgIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsKICAgICAgICAgICAgdXBkYXRlREIoZG9jLCBzYXZlMkRCQXJyT2ZQYWlycyk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICAvL2lmICh6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyAmJiAoIkNPTlMiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgICAgICAvLyAgIHx8ICJFTlJMIiA9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fAogICAgICAgICAvLyAgIk1FRE8iID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykpIHsgLy9FUlMxOTEwOSAjNjQ5MjEgVE9ETyBtYW55IGpvdXJuZXkgYmVzdCBwcm9jdGljZQogICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIGlmICh6RGF0YS5wYXRpZW50VHlwZSAhPSAiQWNjb3VudCIpIHsgLy9FUlMxOTA3MzAgbG9va3VwIHRoZSBkYXRhIFRPRE8gcGVyc29uIGFjY291bnQ/CiAgICAgICAgICAgICAgICB2YXIgY29udGFjdEZsZHMgPSBnZXRTRkZpZWxkcyhkb2MsIHpEYXRhLnBhdGllbnRUeXBlLCAiRmlyc3ROYW1lLExhc3ROYW1lLEJpcnRoZGF0ZSIsIG51bGwsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgY29udGFjdEZsZHM6ICIgKyBjb250YWN0Rmxkcyk7CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jID0gcGF0aWVudEZpcnN0TmFtZSA9IFgoZG9jLCAiRmlyc3ROYW1lIiwgY29udGFjdEZsZHMpOyAvL1BWMTkxMDA2IHVwZGF0ZSB0aGUgY2hpbGQgc3RhY2sKICAgICAgICAgICAgICAgIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyA9IHBhdGllbnRMYXN0TmFtZSA9IFgoZG9jLCAiTGFzdE5hbWUiLCBjb250YWN0Rmxkcyk7CiAgICAgICAgICAgICAgICB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jPXBhdGllbnRET0IgPSBYKGRvYywgIkJpcnRoZGF0ZSIsIGNvbnRhY3RGbGRzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh6RGF0YS5wYXRpZW50VHlwZSA9PT0gIkFjY291bnQiKSB7IC8vRVJTMTkwNzMwIGxvb2t1cCB0aGUgZGF0YSBUT0RPIHBlcnNvbiBhY2NvdW50PwogICAgICAgICAgICAgICAgdmFyIGNvbnRhY3RGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCB6RGF0YS5wYXRpZW50VHlwZSwgIk5hbWUiLCBudWxsLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICAgICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIEFjY291bnRGbGRzOiAiICsgY29udGFjdEZsZHMpOwogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyA9IHBhdGllbnRGaXJzdE5hbWUgPSBYKGRvYywgIk5hbWUiLCBjb250YWN0Rmxkcykuc3BsaXQoIiAiKVswXTsgLy9FUlMxOTA4MDMgVE9ETyBmaW5kIGEgYmV0dGVyIHdheQogICAgICAgICAgICAgICAgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jID0gcGF0aWVudExhc3ROYW1lID0gWChkb2MsICJOYW1lIiwgY29udGFjdEZsZHMpLnNwbGl0KCIgIilbMV07CiAgICAgICAgICAgICAgICAvL3pEYXRhLlhfWlBBUEVSX19CaXJ0aGRhdGVfX2M9cGF0aWVudERPQiA9IFgoZG9jLCAiUGVyc29uQmlydGhkYXRlIiwgY29udGFjdEZsZHMpOwoKICAgICAgICAgICAgfQogICAgICAgICAgICAvL1BWMTkxMDA4IHVwZGF0ZWQgYXR0YWNoTGFiZWwgb24gY2hpbGQgc3RhY2sKICAgICAgICAgICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgICAgICAgICAgaWYoekRhdGEuYXR0YWNoZWRUbyA9PT0gIlBhdGllbnQiIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09ICJBbGwiKXsKICAgICAgICAgICAgICAgIGF0dGFjaChkb2MsIGF0dGFjaExhYmVsLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgICAgICB9CiAgICAgIC8vIH0KICAgIH0KICAgIGlmICh6RGF0YS5wYXRpZW50SWQgJiYgYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnBhdGllbnRJZCk9PS0xKSBhdHRhY2hQYXRoKz0iLCIrekRhdGEucGF0aWVudElkOwovL30KYWxlcnQoIkBAQEAgQUZURVIgUEFUSUVOVDogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBhdHRhY2hQYXRoKTsKCnZhciBhdHRhY2hMYWJlbD16RGF0YS5jbGllbnRGaWxlKGRvYywiSW5kZXhlZCIpOyAvLyJJbmRleGVkICIgKyBmb3JtYXROb3c7CmFsZXJ0KCJFUlMxOTA2MjQgYXR0YWNoTGFiZWw9IithdHRhY2hMYWJlbCk7CgoKLyogQXR0YWNoIHRoZSBzcGxpdCBkb2N1bWVudCB0byBMZWFkIHJlY29yZCBpZiByZXF1aXJlZCAqLyAvL0VSUzE5MDYxOQovLyBUT0RPIEVSUzE5MDYyNCBmbGlwIHRoZSBpZiBsb2dpYwppZiAoZG9jLndkZGF0YS5pbmRleE9mKCJYX1pQQVBFUl9fUmVmZXJyYWxMZWFkX19jIik+LTEpIHsgLy9FUlMxOTA4MDMgVE9ETyByZXRoaW5rCiAgICBpZiAoIWxlYWRJZCB8fCAwID09PSBsZWFkSWQubGVuZ3RoKSB7CiAgICAgICAgYWxlcnQoIkBAQEAgY3JlYXRpbmcgbmV3IExlYWQiKTsKICAgICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgICAgbGVhZElkPXpEYXRhLmNsaWVudExlYWQoZG9jLGFyck9mUGFpcnMpOwogICAgICAgIGFsZXJ0KCJDcmVhdGVkIExlYWQgd2l0aCBJRDogIiArIGxlYWRJZCk7CiAgICAgICAgaWYgKGxlYWRJZCA9PSAibnVsbCIgfHwgbGVhZElkID09ICJORVciKSBsZWFkSWQ9bnVsbDsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHpEYXRhLmF0dGFjaFJlY29yZHMuaW5kZXhPZigiTGVhZCIpPi0xKSB7CiAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBMZWFkOiAiICsgbGVhZElkKTsKICAgICAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIGxlYWRJZCk7CiAgICAgICAgfQogICAgfQogICAgaWYgKGxlYWRJZCAmJiBhdHRhY2hQYXRoLmluZGV4T2YobGVhZElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIitsZWFkSWQ7Cn0KYWxlcnQoIkBAQEAgQUZURVIgTEVBRDogQ2hpbGQgelN0YWNrIFNuaXBwZXQgYXR0YWNoZWQgdG86ICIgKyBYKGRvYywgIlhfYXR0YWNoZWRUbyIpKTsKCgovL0VSUzE5MDYyMCB1c2UgYSBzZXR0aW5nIHRvIGRldGVybWluZSB3aGljaCBsb29rdXBzIHdlIGF0dGFjaCB0bwovKiBBdHRhY2ggdGhlIHNwbGl0IGRvY3VtZW50IHRvIENhc2UgcmVjb3JkIGlmIHJlcXVpcmVkICovIC8vRVJTMTkwNjE5Ci8vaWYgKGRvYy53ZGRhdGEuaW5kZXhPZigiWF9aUEFQRVJfX0Nhc2VfX2MiKT4tMSkgewogIGlmKDE9PT0xKXsKICAgIGFsZXJ0KCJFUlMxOTA2MjQgbmVlZCBDYXNlIik7CiAgICBpZiAoekRhdGEuY2FzZUlkKSB7CiAgICAgICAgaWYgKHpEYXRhLmF0dGFjaFJlY29yZHMuaW5kZXhPZigiQ2FzZSIpPi0xKSB7CiAgICAgICAgICAgIGFsZXJ0KCJAQEBAIGF0dGFjaGluZyB0byBleGlzdGluZyBDYXNlOiAiICsgekRhdGEuY2FzZUlkKTsKICAgICAgICAgICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgICAgICAgICAgaWYoekRhdGEuYXR0YWNoZWRUb0Nhc2UpewogICAgICAgICAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLmNhc2VJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhbGVydCgiRVJTMTkwNjI0Ljc4IGhhdmUgYSBjYXNlPyIpOwogICAgaWYgKHpEYXRhLmNhc2VJZCAmJiBhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEuY2FzZUlkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5jYXNlSWQ7Cn0KCmFsZXJ0KCJAQEBAIEFGVEVSIENBU0U6IENoaWxkIHpTdGFjayBTbmlwcGV0IGF0dGFjaGVkIHRvOiAiICsgWChkb2MsICJYX2F0dGFjaGVkVG8iKSk7CgoKLy9QVjE5MTAyMiBjcmVhdGUgcHJlc2NyaXB0aW9uCnZhciBzdGFja0ZsZHMgPSBnZXRTRkZpZWxkcyhkb2MsICJaUEFQRVJfX3pTdGFja19fYyIsICJaUEFQRVJfX2xhdGVzdEZheF9fYyIsIG51bGwsIHNmU3RhY2tJZCk7CnpEYXRhLlhfWlBBUEVSX19sYXRlc3RGYXhfX2MgPSAgWChkb2MsICJaUEFQRVJfX2xhdGVzdEZheF9fYyIsIHN0YWNrRmxkcyk7IC8vUFYxOTA5MjYgdXBkYXRlIHRoZSBjaGlsZCBzdGFjawppZiggekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpewogICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIFByZXNjcmlwdGlvbjogIiArIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsKICAgIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7CiAgICBpZiggekRhdGEuYXR0YWNoZWRUbyA9PT0iUHJlc2NyaXB0aW9uIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICBhdHRhY2goZG9jLCBhdHRhY2hMYWJlbCwgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwogICAgfQp9CmlmKCAhekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgJiYgekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgJiYiUlgiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyApIHsgLy9FUlMxOTExMDkgIzY0OTIxIFRPRE8gbWFueSBqb3VybmV5cwogICAgYWxlcnQoIkBAQEAgQ3JlYXRpbmcgIFByZXNjcmlwdGlvbl9fYyB3aXRoIGZheCBUeXBlIDogIiArIHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKTsKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9EYXRlX29mX1ByZXNjcmlwdGlvbl9SZWNlaXZlZF9fYyIsekRhdGEuWF9aUEFQRVJfX2xhdGVzdEZheF9fYyk7CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfUHJvZHVjdFByZXNjcmliZWRfX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQ2FyZVBsYW5fX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb3JlX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IlByZXNjcmlwdGlvbiIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ29yZV9QcmVzY3JpcHRpb25fX2MiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB9ZWxzZXsKICAgICAgICB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGVOb0F0dGFjaChkb2MsIkNvcmVfUHJlc2NyaXB0aW9uX19jIixhcnJPZlBhaXJzLCJJbmRleCIpOwogICAgfQogICAgLy96RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGUoZG9jLCJDb3JlX1ByZXNjcmlwdGlvbl9fYyIsYXJyT2ZQYWlycywiSW5kZXgiKTsgIENSTjE5MTIxMyBEb24ndCBjcmVhdGUgdGhlIFByZXNjcmlwdGlvbiBtdWx0aXBsZSB0aW1lcwogICAgYWxlcnQoIkBAQEAgQ3JlYXRlIFByZXNjcmlwdGlvbl9fYyB3aXRoIElEOiAiICsgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIC8vYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jKTsKICAgIHpEYXRhLlByZXNjcmlwdGlvbk5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNvcmVfUHJlc2NyaXB0aW9uX19jIiwgIk5hbWUiLCBudWxsLCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7IC8vUFYxOTEwMjIgLy9FUlMxOTExMDkgY2xpZW50SW5kZXg/CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUHJlc2NyaXB0aW9uX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jICsgZHEgKyAiKTsgIik7CiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjUHJlc2NyaXB0aW9uX19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuUHJlc2NyaXB0aW9uTmFtZSArIGRxICsgIik7ICIpOwoKfQovL0NSTjE5MTExOCBJZiB3ZSBhbHNvIGhhdmUgYSBwYXRpZW50IGFuZCBhIFByZXNjcmlwdGlvbiwgYXNzb2NpYXRlIHRoZW0uCi8qCmlmICh6RGF0YS5wYXRpZW50SWQgJiYgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MpIHsKICAgIGFsZXJ0KCJAQEAgQXNzb2NpYXRpbmcgUHJlc2NyaXB0aW9uOiAiICsgekRhdGEuWF9QcmVzY3JpcHRpb25fX2MgKyAiIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICB2YXIgc2NyaXB0QXJyT2ZQYWlycyA9IFtdOwogICAgc2NyaXB0QXJyT2ZQYWlycy5wdXNoKCJDb3JlX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgdXBkYXRlU0ZSZWNvcmQoZG9jLCAiQ29yZV9QcmVzY3JpcHRpb25fX2MiLCB6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYywgc2NyaXB0QXJyT2ZQYWlycyk7Cn0KKi8KCi8vQ09NRFIKLy9pZiggIXpEYXRhLmNhc2VJZCAmJiAoIkNPTURSIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKLy8gICAgIHx8ICJNRURDIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiTEFCIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwovLyAgICAgfHwgIklOSlIiPT09ekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpKXsKLy9DUk4xOTExMTQgQWNjb3JkaW5nIHRvIHRoZSBBYmJ2aWUgc3RvcmllcywgYWxsIGRvY1R5cGVzIGV4Y2VwdCAiQ29uc2VudCBGb3JtcyIgbmVlZCB0byBoYXZlIGEgQ2FzZSBjcmVhdGVkIGlmIG9uZSBpc24ndCBhbHJlYWR5IHNlbGVjdGVkCmlmKCF6RGF0YS5jYXNlSWQgJiYgIkNPTlMiICE9PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyAmJiAnQ2FuYWRhX1ByaW9yaXR5X0RhdGEyX1dlYl9Gb3JtJyAhPT0gWChkb2MsICJYX2xhc3RERVBhbmVsIikpIHsKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyMWkwMDAwMDBoUW83QUFFIik7ICAgICAgICAgICAgICAgLy8gQ1JOMTkxMTE0IEFsd2F5cyB1c2UgQ2FyZVBsYW4gUmVjb3JkIFR5cGU/CiAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQnJhbmRfX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CiAgICBpZih6RGF0YS5wcm9ncmFtTmFtZSA9PT0gIkFiYnZpZSBPbmVDUk0gLSBDYW5hZGEiKXsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQ291bnRyeUNvZGVfX2MiLCJDQSIpOwogICAgfQogICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgeyBhcnJPZlBhaXJzLnB1c2goIkFjY291bnRJZCIsIHpEYXRhLnBhdGllbnRJZCk7IH0KICAgIGlmKHpEYXRhLmF0dGFjaGVkVG9DYXNlKXsKICAgICAgICB6RGF0YS5jYXNlSWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ2FzZSIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIH1lbHNlewogICAgICAgIHpEYXRhLmNhc2VJZCA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGVOb0F0dGFjaChkb2MsIkNhc2UiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB9CiAgICB6RGF0YS5jYXNlTnVtYmVyID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkNhc2VOdW1iZXIiLCBudWxsLCB6RGF0YS5jYXNlSWQpOyAvL1BWMTkxMDIyCiAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19DYXNlX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLmNhc2VJZCArIGRxICsgIik7ICIpOwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fY19DYXNlTnVtYmVyIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLmNhc2VOdW1iZXIgKyBkcSArICIpOyAiKTsgLy9QVjE5MDkyOSB1cGRhdGVkIGNhc2UgbnVtYmVyIGluIGxvb2t1cAogICAgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyA9IFgoZG9jLCAiWF9DbGluaWNhbF9TZXJ2aWNlc19SZWNvcmRfVHlwZV9fYyIpOwoKLyoKQ1JOMTkxMTEzIE1vdmVkIGJlbG93IHdoZXJlIHRoZSBkb2NUeXBlIGxvZ2ljIGlzbid0IHNvIGNvbnZvbHV0ZWQKICAgIGlmKCJMQUIiPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8ICJJTkpSIj09PXpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jCiAgICAgICB8fCAiTUVEQyIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKXsKICAgICAgYXJyT2ZQYWlycyA9IFtdOwogICAgICBpZigiTGFiIFRlc3RzIj09PXpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MpewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MiLCIwMTI1RTAwMDAwMEsyNEdRQVMiKTsKICAgICAgfQogICAgICBpZigiaW5qZWN0aW9uIFRyYWluaW5nIj09PXpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MpewoKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyNUUwMDAwMDBLMjRMUUFTIik7CiAgICAgIH0KCiAgICAgLy9hcnJPZlBhaXJzLnB1c2goIlNlcnZpY2VfUmVxdWVzdGVkX2RhdGVfX2MiLHpEYXRhLlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyk7CiAgICAgLy9hcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsekRhdGEucGF0aWVudElkKTsKICAgICBpZighekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyl7CiAgICAgICAgYXNzb2NpYXRlZEFyck9mUGFpcnMucHVzaCgiQ29yZV9DYXJlX1BsYW5fX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgICAgIGFzc29jaWF0ZWRBcnJPZlBhaXJzLnB1c2goIkNvcmVfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGUoZG9jLCJDb3JlX0NsaW5pY2FsX1NlcnZpY2VfX2MiLGFyck9mUGFpcnMsIkluZGV4Iik7CiAgICAgfQogICAgIGF0dGFjaExhYmVsPXpEYXRhLmNsaWVudEZpbGUoZG9jLCJJbmRleGVkIik7CiAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsICB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsKICAgICB6RGF0YS5DbGluaWNhbE5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsICJOYW1lIiwgbnVsbCwgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7IC8vUFYxOTEwMjIKICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjQ2xpbmljYWxfU2VydmljZXNfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyArIGRxICsgIik7ICIpOwogICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNDbGluaWNhbF9TZXJ2aWNlc19fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLkNsaW5pY2FsTmFtZSArIGRxICsgIik7ICIpOwogICAgfQogICAgKi8KfQoKLy9TSFIxOTEyMDkgIzY1NTM1IGFkZCBEb2N1bWVudCBMaW5rIGlmIHdlIGhhdmUgYSBuZXcgQ2FzZSBJZAppZiAoekRhdGEuY2FzZUlkKSB7CiAgICB2YXIgenNlcnZlciA9IGRvYy5rYkRhdGEuc2ZTZXJ2ZXIuc3RhcnRzV2l0aCgiaHR0cHM6Ly8iKSA/IGRvYy5rYkRhdGEuc2ZTZXJ2ZXIgOiAiaHR0cHM6Ly8iICsgZG9jLmtiRGF0YS5zZlNlcnZlcjsKICAgIHZhciBkb2N1cmwgPSB6c2VydmVyICsgIi9zZXJ2aWNlcy9kYXRhL3Y0Ni4wL3NvYmplY3RzL0NvbnRlbnRWZXJzaW9uLyI7CiAgICB2YXIgcGRmdXJsID0gImh0dHBzOi8vZ3cuenBhcGVyLmNvbS9rYi9qc3AvU0ZfZmluZC5saWdodG5pbmcuanNwP2dvPVNGX2ZpbGVzLmpzcCZkYklEPSIgKyBkb2MuZGJJRCArICImU0Zvcmc9IiArIGRvYy5rYkRhdGEuc2ZPcmdhbml6YXRpb25JRDsKICAgIHZhciBDb250ZW50VmVyc2lvbkNhdGVnb3JpZXMgPSB7CiAgICAgICAgIk9USCI6ICJPdGhlciBEb2N1bWVudHMiLAogICAgICAgICJNSUYiOiAiTWlzc2luZyBJbmZvcm1hdGlvbiIsCiAgICAgICAgIkVOUkwiOiAiRW5yb2xsbWVudCBGb3JtIiwKICAgICAgICAiTUVETyI6ICJNZWRpY2FsIC0gT3RoZXIiLAogICAgICAgICJDT05TIjogIkNvbnNlbnQgRm9ybXMiLAogICAgICAgICJDT01EUiI6ICJDb21tdW5pY2F0aW9uIGZyb20gUGh5c2ljaWFucyIsCiAgICAgICAgIlJYIjogIlByZXNjcmlwdGlvbiIsCiAgICAgICAgIlNBIjogIlNBIERvY3VtZW50cyIsCiAgICAgICAgIk1FREMiOiAiTWVkaWNhbCBDbGFyaWZpY2F0aW9uIiwKICAgICAgICAiTEFCIjogIkxhYiBEb2N1bWVudHMiLAogICAgICAgICJJTkpSIjogIkluamVjdGlvbiBSZXBvcnQiLAogICAgICAgICJDQSI6ICJDbGluaWNhbCBBc3Nlc3NtZW50IiwKICAgICAgICAiQ09QQVkiOiAiQ29wYXkiCiAgICB9CiAgICB2YXIgZGF0ZXN0ciA9IGdldEN1ckRhdGUoZG9jKTsKICAgIHZhciBhY2NuYW1lID0gWChkb2MsICJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX3IuTmFtZSIpOwogICAgdmFyIGZheHR5cGUgPSBYKGRvYywgIlhfWlBBUEVSX19mYXhUeXBlX19jIik7CiAgICB2YXIgcmV2c3RhdCA9IFgoZG9jLCAiWF9yZXZpZXdlZFN0YXR1cyIpOwogICAgdmFyIGNhdHR5cGUgPSBDb250ZW50VmVyc2lvbkNhdGVnb3JpZXNbZmF4dHlwZV0gfHwgZmF4dHlwZTsKICAgIHZhciBkb2NkYXRhID0gewogICAgICAgICJUaXRsZSI6IGFjY25hbWUgKyAiIC0gIiArIGZheHR5cGUgKyAiIC0gIiArIGRhdGVzdHIsCiAgICAgICAgIkRlc2NyaXB0aW9uIjogcmV2c3RhdCArICIgYnk6ICIgKyBkb2Muc2ZVc2VyTmFtZSArICIgYXQ6ICIgKyB6RGF0YS5mb3JtYXROb3csCiAgICAgICAgIkZpcnN0UHVibGlzaExvY2F0aW9uSWQiOiB6RGF0YS5jYXNlSWQsCiAgICAgICAgIkNvbnRlbnRVcmwiOiBwZGZ1cmwsCiAgICAgICAgIkNPUkVfTGVnYWN5X0RvY3VtZW50X0lEX19jIjogcGRmdXJsLAogICAgICAgICJDb3JlX0NvdW50cnlDb2RlX19jIjogIkNBIiwKICAgICAgICAiQ29yZV9DYXRlZ29yeV9fYyI6IGNhdHR5cGUsCiAgICAgICAgIkNvcmVfU3ViX0NhdGVnb3J5X19jIjogekRhdGEuWF9TdWJfQ2F0ZWdvcnlfX2MKICAgIH07CiAgICB2YXIgaGVhZGVycyA9IFsKICAgICAgICAiQXV0aG9yaXphdGlvbiIsICJCZWFyZXIgIiArIGRvYy5rYkRhdGEuc2ZTZXNzaW9uSUQsCiAgICAgICAgIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIgogICAgXTsKICAgIHZhciBib2R5ID0gSlNPTi5zdHJpbmdpZnkoZG9jZGF0YSk7CiAgICB0cnkgewogICAgICAgIHZhciByZXMgPSB3cG9zdChkb2MsIGRvY3VybCwgW10sIGhlYWRlcnMsIGJvZHkpOwogICAgICAgIGFsZXJ0KCJ3cG9zdCByZXNwb25zZTogIiArIHJlcyk7CiAgICB9CiAgICBjYXRjaChleCkgewogICAgICAgIGFsZXJ0KCJ3cG9zdCBleGNlcHRpb246ICIgKyBleCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG1lc3MgPSBKU09OLnBhcnNlKGV4KTsKICAgICAgICAgICAgaWYgKG1lc3MgJiYgQXJyYXkuaXNBcnJheShtZXNzKSAmJiBtZXNzWzBdLmVycm9yQ29kZSkgewogICAgICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICJhbGVydChgRXJyb3IgY3JlYXRpbmcgQ29udGVudFZlcnNpb24hICIgKyBtZXNzWzBdLmVycm9yQ29kZSArICIgPT4gIiArIG1lc3NbMF0ubWVzc2FnZSArICJgKTsiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaChwZXgpIHsKICAgICAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICJhbGVydChgRXJyb3IgcGFyc2luZyBKU09OIHJlcHNwb25zZTogIiArIGV4ICsgImApOyIpOwogICAgICAgIH0KICAgIH0KfQoKLy9DT1BBWQppZiAoIkNPUEFZIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpIHsKICAgIGFyck9mUGFpcnMgPSBbXTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ0FfUGF0aWVudF9fYyIsekRhdGEucGF0aWVudElkKTsKICAgIGFyck9mUGFpcnMucHVzaCgiQ0FfQ2FyZVBsYW5JRF9fYyIsekRhdGEuY2FzZUlkKTsKICAgIHpEYXRhLmNvcGF5SWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ0FfQ29wYXlfX2MiLGFyck9mUGFpcnMsIkluZGV4Iik7Cn0KCgovL09USAppZiggIXpEYXRhLmNhc2VJZCAmJiAoIk9USCIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jIHx8ICJFTlJMIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MKICAgIHx8ICJNRURPIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgfHwgIlJYIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MgKSl7CiAgICBpZih6RGF0YS5jcmVhdGVDYXNlKXsKICAgICAgICBhcnJPZlBhaXJzID0gW107CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJSZWNvcmRUeXBlSWQiLCIwMTIxaTAwMDAwMGhRbzdBQUUiKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNvcmVfQnJhbmRfX2MiLHpEYXRhLlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyk7CiAgICAgICAgaWYoekRhdGEucHJvZ3JhbU5hbWUgPT09ICJBYmJ2aWUgT25lQ1JNIC0gQ2FuYWRhIil7CiAgICAgICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ29yZV9Db3VudHJ5Q29kZV9fYyIsIkNBIik7CiAgICAgICAgfQoKICAgICAgICB6RGF0YS5jYXNlSWQgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ2FzZSIsYXJyT2ZQYWlycywiSW5kZXgiKTsKICAgICAgICB6RGF0YS5jYXNlTnVtYmVyID0gZ2V0U0ZGaWVsZChkb2MsICJDYXNlIiwgIkNhc2VOdW1iZXIiLCBudWxsLCB6RGF0YS5jYXNlSWQpOyAvL1BWMTkxMDIyCiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyB6RGF0YS5jYXNlSWQgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19DYXNlX19jX0Nhc2VOdW1iZXIiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuY2FzZU51bWJlciArIGRxICsgIik7ICIpOyAvL1BWMTkwOTI5IHVwZGF0ZWQgY2FzZSBudW1iZXIgaW4gbG9va3VwCiAgICB9Cn0KCmlmKCB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpewogICAgYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGV4aXN0aW5nIE91dGNvbWU6ICIgKyB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MpOwogICAgYXR0YWNoTGFiZWw9ekRhdGEuY2xpZW50RmlsZShkb2MsIkluZGV4ZWQiKTsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJSZXBvcnRlZCBPdXRjb21lcyIgfHwgekRhdGEuYXR0YWNoZWRUbyA9PT0iQWxsIil7CiAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNoTGFiZWwsIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyk7CiAgICB9CiAgICAvL0NSTjE5MTExOCBJZiB3ZSBhbHNvIGhhdmUgYSBQYXRpZW50IGFuZCBhIFJlcG9ydGVkIE91dGNvbWUsIGFzc29jaWF0ZSB0aGVtLgogICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgICAgIGFsZXJ0KCJAQEAgQXNzb2NpYXRpbmcgUmVwb3J0ZWQgQ3V0Y29tZTogIiArIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyArICIgd2l0aCBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICB2YXIgb3V0Y29tZUFyck9mUGFpcnMgPSBbXTsKICAgICAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0FjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNvcmVfUGF0aWVudF9SZXBvcnRlZF9PdXRjb21lc19fYyIsIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYywgb3V0Y29tZUFyck9mUGFpcnMpOwogICAgfQp9CmVsc2UgaWYgKCJDQSIgPT09IHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSB7CiAgICB2YXIgb3V0Y29tZUFyck9mUGFpcnMgPSBbXTsKICAgIG91dGNvbWVBcnJPZlBhaXJzLnB1c2goIkNvcmVfRW50cnlfRGF0ZV9fYyIsIGdldEN1ckRhdGUoZG9jKSk7CiAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0NhcmVfUGxhbl9fYyIsIHpEYXRhLmNhc2VJZCk7CiAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0FjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgdmFyIGFzc2Vzc21lbnRUeXBlID0gWChkb2MsICJYX0Fzc2Vzc21lbnRfVHlwZV9fYyIpOwogICAgaWYgKGFzc2Vzc21lbnRUeXBlICYmICJET05PVF9TQVZFIiAhPT0gYXNzZXNzbWVudFR5cGUpIHsKICAgICAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0Fzc2Vzc21lbnRfVHlwZV9fYyIsIGFzc2Vzc21lbnRUeXBlKTsKICAgIH0KICAgIHZhciBvdXRjb21lVHlwZSA9IFgoZG9jLCAiWF9PdXRjb21lX1R5cGVfX2MiKTsKICAgIGlmIChvdXRjb21lVHlwZSAmJiAiRE9OT1RfU0FWRSIgIT09IG91dGNvbWVUeXBlKSB7CiAgICAgICAgb3V0Y29tZUFyck9mUGFpcnMucHVzaCgiQ29yZV9PdXRjb21lX1R5cGVfX2MiLCBvdXRjb21lVHlwZSk7CiAgICB9CiAgICAvL0NSTjE5MTExOCBJZiB3ZSBhbHNvIGhhdmUgYSBQYXRpZW50IGFuZCBhIFJlcG9ydGVkIE91dGNvbWUsIGFzc29jaWF0ZSB0aGVtLgogICAgaWYgKHpEYXRhLnBhdGllbnRJZCkgewogICAgICAgIGFsZXJ0KCJAQEAgQXNzb2NpYXRpbmcgTmV3IFJlcG9ydGVkIEN1dGNvbWUgd2l0aCBQYXRpZW50OiAiICsgekRhdGEucGF0aWVudElkKTsKICAgICAgICBvdXRjb21lQXJyT2ZQYWlycy5wdXNoKCJDb3JlX0FjY291bnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgfQogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IlJlcG9ydGVkIE91dGNvbWVzIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICB6RGF0YS5YX1JlcG9ydGVkX091dGNvbWVfX2MgPSB6RGF0YS5jbGllbnRSZWNvcmRUeXBlKGRvYywiQ29yZV9QYXRpZW50X1JlcG9ydGVkX091dGNvbWVzX19jIixvdXRjb21lQXJyT2ZQYWlycywiSW5kZXgiKTsKICAgIH1lbHNlewogICAgICAgIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyA9IHpEYXRhLmNsaWVudFJlY29yZFR5cGVOb0F0dGFjaChkb2MsIkNvcmVfUGF0aWVudF9SZXBvcnRlZF9PdXRjb21lc19fYyIsb3V0Y29tZUFyck9mUGFpcnMsIkluZGV4Iik7CiAgICB9CiAgICB2YXIgb3V0Y29tZU5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNvcmVfUGF0aWVudF9SZXBvcnRlZF9PdXRjb21lc19fYyIsICJOYW1lIiwgbnVsbCwgekRhdGEuWF9SZXBvcnRlZF9PdXRjb21lX19jKTsKICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNSZXBvcnRlZF9PdXRjb21lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyArIGRxICsgIik7ICIpOwogICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1JlcG9ydGVkX091dGNvbWVfX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBvdXRjb21lTmFtZSArIGRxICsgIik7ICIpOwp9CgoKYXJyT2ZQYWlycyA9IFtdOwppZiAoekRhdGEuZG9jVHlwZSkgeyBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fZmF4VHlwZV9fYyIsIHpEYXRhLmRvY1R5cGUpOyAgfSAvL0VSUzE5MDgxMCBQVjE5MDgwOCAjNTE2NzAKaWYgKHpEYXRhLnByb3ZpZGVySWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcm92aWRlcl9fYyIsIHpEYXRhLnByb3ZpZGVySWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5wcm92aWRlcklkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5wcm92aWRlcklkOwp9CmFsZXJ0KCJFUlMxOTA4MTIuMjAwIHpEYXRhLnBhdGllbnRJZD0iK3pEYXRhLnBhdGllbnRJZCk7IC8vRVJTMTkwODEyICM2MTUxMQppZiAoekRhdGEucGF0aWVudElkKSB7CiAgICBpZiAoekRhdGEucGF0aWVudElkLmluZGV4T2YoIjAwMyIpPT09MCkgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgaWYgKHpEYXRhLnBhdGllbnRJZC5pbmRleE9mKCIwMDEiKT09PTApIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICBpZiAoekRhdGEucGF0aWVudElkLmluZGV4T2YoIjAwUSIpPT09MCkgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1JlZmVycmFsTGVhZF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7IC8vRVJTMTkwODAyIExlYWQKICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoekRhdGEucGF0aWVudElkKT09LTEpIGF0dGFjaFBhdGgrPSIsIit6RGF0YS5wYXRpZW50SWQ7CiAgICBpZiAoMT09PTEpIHsgLy9FUlMxOTA4MTAgUFYxOTA4MDggZGF0YSBlbnRyeSBmb3IgbmV4dCBzcGxpdAogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19GaXJzdE5hbWVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MpIHsgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0xhc3ROYW1lX19jIiwgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKSB7IGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19CaXJ0aGRhdGVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fQmlydGhkYXRlX19jKTsgfQogICAgICAgIGlmICh6RGF0YS5YX1pQQVBFUl9fU3RhdHVzX19jKSB7YXJyT2ZQYWlycy5wdXNoKHpwKyJTdGF0dXNfX2MiLCAiQ29tcGxldGVkIik7IH0gLy9QVjE5MTAyMyB1cGRhdGVpbmcgc3RhdHVzCiAgICB9Cn0KaWYgKHpEYXRhLmNhc2VJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0Nhc2VfX2MiLCB6RGF0YS5jYXNlSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5jYXNlSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmNhc2VJZDsKfQogYWxlcnQoIkBAQEAgekRhdGEuY29udGFjdElkID0gIiArIHpEYXRhLmNvbnRhY3RJZCk7CmlmICh6RGF0YS5jb250YWN0SWQgJiYgekRhdGEuY29udGFjdElkLnN0YXJ0c1dpdGgoIjAwMyIpKSB7CgogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhdGllbnRfX2MiLCB6RGF0YS5jb250YWN0SWQpOwp9CmlmICh6RGF0YS5sZWFkSWQpIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19SZWZlcnJhbExlYWRfX2MiLCB6RGF0YS5sZWFkSWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZih6RGF0YS5sZWFkSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLmxlYWRJZDsKfQppZiAoekRhdGEucmVmZXJyYWxJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1JlZmVycmFsX19jIiwgekRhdGEucmVmZXJyYWxJZCk7CiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKHpEYXRhLnJlZmVycmFsSWQpPT0tMSkgYXR0YWNoUGF0aCs9IiwiK3pEYXRhLnJlZmVycmFsSWQ7Cn0KaWYgKHpEYXRhLlhfWlBBUEVSX19QaG9uZV9fYykgeyAvL1BWMTkxMDA2IFVQREFURUQgRk9SIFBIT05FCiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGhvbmVfX2MiLCB6RGF0YS5YX1pQQVBFUl9fUGhvbmVfX2MpOwoKfQp2YXIgc3BlY2lhbEF1dGhJZCA9IFgoZG9jLCAiWF9TcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiKTsKYWxlcnQoIkBAQCB6RGF0YS5YX1NwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyAiICsgc3BlY2lhbEF1dGhJZCk7CnZhciBhdXRoRG9jVHlwZSA9IFgoZG9jLCAiWlBBUEVSX19mYXhUeXBlX19jIik7CmlmIChzcGVjaWFsQXV0aElkKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIsIHNwZWNpYWxBdXRoSWQpOwogICAgLy9QVjE5MTExMyBJZiB3ZSBoYXZlIGEgU3BlY2lhbCBBdXRob3JpemF0aW9uLCBhdHRhY2ggdGhpcyBkb2N1bWVudCB0byBpdAogICAgdmFyIHNwZWNpYWxMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGlmKCB6RGF0YS5hdHRhY2hlZFRvID09PSJTcGVjaWFsIEF1dGhvcml6YXRpb24iIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09IkFsbCIpewogICAgICAgIGF0dGFjaChkb2MsIHNwZWNpYWxMYWJlbCwgc3BlY2lhbEF1dGhJZCk7CiAgICB9Cn0KZWxzZSBpZiAoIlNBIiA9PT0gekRhdGEuWF9aUEFQRVJfX2ZheFR5cGVfX2MpIHsKICAgIHZhciBhdXRoQXJyT2ZQYWlycyA9IFtdOwogICAgdmFyIGF1dGhMYWJlbCA9IHpEYXRhLlhfWlBBUEVSX19GaXJzdE5hbWVfX2MgKyIgIiArIHpEYXRhLlhfWlBBUEVSX19MYXN0TmFtZV9fYyArICIgLSAiICsgZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jKTsKICAgIGF1dGhBcnJPZlBhaXJzLnB1c2goIk1lbWJlclBsYW5JZCIsIHpEYXRhLlhfTWVtYmVyX1BsYW5fX2MgLCAiQ0FfQ292ZXJhZ2VfQmVuZWZpdF9fYyIsIHpEYXRhLlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyApOwogICAgYXV0aEFyck9mUGFpcnMucHVzaCgiQ0FfUGF0aWVudF9fYyIsIHpEYXRhLnBhdGllbnRJZCk7CiAgICBhdXRoQXJyT2ZQYWlycy5wdXNoKCJOYW1lIiwgImFueVZhbHVlIik7CiAgICB2YXIgc3BlY2lhbEF1dGhJZCA9IiI7CiAgICBpZiggekRhdGEuYXR0YWNoZWRUbyA9PT0iU3BlY2lhbCBBdXRob3JpemF0aW9uIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICBzcGVjaWFsQXV0aElkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNhcmVQcmVhdXRoIiwgYXV0aExhYmVsLCBhdXRoQXJyT2ZQYWlycyk7CiAgICB9ZWxzZXsKICAgICAgICBzcGVjaWFsQXV0aElkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiQ2FyZVByZWF1dGgiLCBhdXRoTGFiZWwsIGF1dGhBcnJPZlBhaXJzKTsKICAgIH0KCiAgICBpZiAoIXNwZWNpYWxBdXRoSWQuY29udGFpbnMoIkVSUk9SIikpIHsKICAgICAgICB2YXIgYXV0aE5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNhcmVQcmVhdXRoIiwgIk5hbWUiLCBudWxsLCBzcGVjaWFsQXV0aElkKTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyIsIHNwZWNpYWxBdXRoSWQpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNTcGVjaWFsX0F1dGhvcml6YXRpb25fX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgc3BlY2lhbEF1dGhJZCArIGRxICsgIik7ICIpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNTcGVjaWFsX0F1dGhvcml6YXRpb25fX2NfTmFtZSIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBhdXRoTmFtZSArIGRxICsgIik7ICIpOwogICAgfQp9Ci8vQ1JOMTkxMTE4IElmIHdlIGFsc28gaGF2ZSBhIFBhdGllbnQgYW5kIGEgU3BlY2lhbCBBdXRob3JpemF0aW9uLCBhc3NvY2lhdGUgdGhlbS4KaWYgKHpEYXRhLnBhdGllbnRJZCAmJiBzcGVjaWFsQXV0aElkKSB7CiAgICBhbGVydCgiQEBAIEFzc29jaWF0aW5nIFNwZWNpYWwgQXV0aG9yaXphdGlvbjogIiArIHNwZWNpYWxBdXRoSWQgKyAiIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICB2YXIgc2NyaXB0QXJyT2ZQYWlycyA9IFtdOwogICAgc2NyaXB0QXJyT2ZQYWlycy5wdXNoKCJDQV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgIHVwZGF0ZVNGUmVjb3JkKGRvYywgIkNhcmVQcmVhdXRoIiwgc3BlY2lhbEF1dGhJZCwgc2NyaXB0QXJyT2ZQYWlycyk7Cn0KCi8vQ1JOMTkxMTE0IEhhbmRsZSBhbnkgcGFzc2VkLWluIHBoeXNpY2lhbiAoU2hvdWxkIHRoaXMgYmUgb25seSBmb3IgQ09NRFI6IENvbW11bmljYXRpb24gZnJvbSBQaHlzaWNpYW4/KQphbGVydCgiQEBAQCB6RGF0YS5YX1BoeXNpY2lhbl9fYyA9ICIgKyB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7CmFsZXJ0KCJAQEBAIFhfUGh5c2ljaWFuX19jID0gIiArIFgoZG9jLCAiWF9QaHlzaWNpYW5fX2MiKSk7CmlmIChYKGRvYywgIlhfUGh5c2ljaWFuX19jIikpIHsKICAgIHpEYXRhLlhfUGh5c2ljaWFuX19jID0gWChkb2MsICJYX1BoeXNpY2lhbl9fYyIpOwogICAgYWxlcnQoIkBAQEAgekRhdGEuWF9QaHlzaWNpYW5fX2Mgbm93ID0gIiArIHpEYXRhLlhfUGh5c2ljaWFuX19jKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUGh5c2ljaWFuX19jIiwgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwogICAgdmFyIHBoeXNpY2lhbkxhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgYWxlcnQoIkBAQCBBdHRhY2hpbmcgdG8gUGh5c2ljaWFuX19jIHdpdGggSWQ6ICIgKyB6RGF0YS5YX1BoeXNpY2lhbl9fYyk7CiAgICBhdHRhY2goZG9jLCBwaHlzaWNpYW5MYWJlbCwgekRhdGEuWF9QaHlzaWNpYW5fX2MpOwp9CgovL1BWMTkxMDA4IHVwZGF0ZWQgbmV3IGZpZWxkcwppZih6RGF0YS5YX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MpIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIsekRhdGEuWF9aUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jKTsKaWYoIHpEYXRhLlhfWlBBUEVSX19Qcmlvcml0eV9fYykgewogICAgaWYgKCF6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcmlvcml0eV9fYyIsekRhdGEuWF9aUEFQRVJfX1ByaW9yaXR5X19jKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcmlvcml0eV9fYyIsICIiKTsKICAgIH0KfQppZiggekRhdGEuWF9TdWJfQ2F0ZWdvcnlfX2MgKSAgYXJyT2ZQYWlycy5wdXNoKCJTdWJfQ2F0ZWdvcnlfX2MiLHpEYXRhLlhfU3ViX0NhdGVnb3J5X19jKTsKaWYoIHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKSAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2ZheFR5cGVfX2MiLHpEYXRhLlhfWlBBUEVSX19mYXhUeXBlX19jKTsKaWYoIHpEYXRhLlhfUHJlc2NyaXB0aW9uX19jICkgIGFyck9mUGFpcnMucHVzaCgiUHJlc2NyaXB0aW9uX19jIix6RGF0YS5YX1ByZXNjcmlwdGlvbl9fYyk7CmlmKCB6RGF0YS5YX01lbWJlcl9QbGFuX19jICkgIGFyck9mUGFpcnMucHVzaCgiTWVtYmVyX1BsYW5fX2MiLHpEYXRhLlhfTWVtYmVyX1BsYW5fX2MpOwppZiggekRhdGEuWF9Db3ZlcmFnZV9CZW5lZml0X19jICkgIGFyck9mUGFpcnMucHVzaCgiQ292ZXJhZ2VfQmVuZWZpdF9fYyIsekRhdGEuWF9Db3ZlcmFnZV9CZW5lZml0X19jKTsKaWYoIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MgKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX19jIix6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsKICAgIC8vUFYxOTExMTMgSWYgd2UgaGF2ZSBhIENsaW5pY2FsIFNlcnZpY2VzLCBhdHRhY2ggdGhpcyBkb2N1bWVudCB0byBpdAogICAgdmFyIGNsaW5pY2FsTGFiZWwgPSB6RGF0YS5YX1pQQVBFUl9fRmlyc3ROYW1lX19jICsiICIgKyB6RGF0YS5YX1pQQVBFUl9fTGFzdE5hbWVfX2MgKyAiIC0gIiArIGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7CiAgICBpZiggekRhdGEuYXR0YWNoZWRUbyA9PT0iQ2xpbmljYWwgU2VydmljZXMiIHx8IHpEYXRhLmF0dGFjaGVkVG8gPT09IkFsbCIpewogICAgICAgIGF0dGFjaChkb2MsIGNsaW5pY2FsTGFiZWwsIHpEYXRhLlhfQ2xpbmljYWxfU2VydmljZXNfX2MpOwogICAgfQp9CmVsc2UgaWYgKCgiTEFCIj09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYyB8fCAiSU5KUiI9PT16RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYwogICAgICAgfHwgIk1FREMiID09PSB6RGF0YS5YX1pQQVBFUl9fZmF4VHlwZV9fYykgJiYgWChkb2MsICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiKSkgeyAgICAgICAgLy9DUk4xOTExMTMgQ3JlYXRlIG5ldyBDbGluaWNhbCBTZXJ2aWNlcyByZWNvcmQgaWYgRG9jVHlwZSBpcyBNRURDIGFuZCB0aGUgU2VydmljZSBSZXF1ZXN0ZWQgRGF0ZSBpcyBmaWxsZWQgaW4KICAgIHZhciBjbGluaWNhbFN2Y0Fyck9mUGFpcnMgPSBbXTsKICAgIHZhciBjbGluaWNhbFN2Y0xhYmVsID0gekRhdGEuWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyArIiAiICsgekRhdGEuWF9aUEFQRVJfX0xhc3ROYW1lX19jICsgIiAtICIgKyBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwogICAgY2xpbmljYWxTdmNBcnJPZlBhaXJzLnB1c2goIkNvcmVfQ2FyZV9QbGFuX19jIiwgekRhdGEuY2FzZUlkKTsKICAgIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycy5wdXNoKCJDb3JlX1BhdGllbnRfX2MiLCB6RGF0YS5wYXRpZW50SWQpOwogICAgaWYoIkxhYiBUZXN0cyI9PT16RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jKXsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIkNsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jIiwiMDEyMWkwMDAwMDBZOURSQUEwIik7CiAgICB9CiAgICBjbGluaWNhbFN2Y0Fyck9mUGFpcnMucHVzaCgiU2VydmljZV9SZXF1ZXN0ZWRfZGF0ZV9fYyIsIFgoZG9jLCAiWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIikpOwogICAgaWYoIkluamVjdGlvbiBUcmFpbmluZyI9PT16RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX1JlY29yZF9UeXBlX19jKXsKICAgICAgICBjbGluaWNhbFN2Y0Fyck9mUGFpcnMucHVzaCgiQ2xpbmljYWxfU2VydmljZXNfUmVjb3JkX1R5cGVfX2MiLCIwMTIxaTAwMDAwMFk5RFFBQTAiKTsKICAgIH0KICAgIHZhciBjbGluaWNhbFN2Y0lkPSIiOwogICAgaWYoIHpEYXRhLmF0dGFjaGVkVG8gPT09IkNsaW5pY2FsIFNlcnZpY2VzIiB8fCB6RGF0YS5hdHRhY2hlZFRvID09PSJBbGwiKXsKICAgICAgICBjbGluaWNhbFN2Y0lkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsIGNsaW5pY2FsU3ZjTGFiZWwsIGNsaW5pY2FsU3ZjQXJyT2ZQYWlycyk7CiAgICB9ZWxzZXsKICAgICAgICBjbGluaWNhbFN2Y0lkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIiwgY2xpbmljYWxTdmNMYWJlbCwgY2xpbmljYWxTdmNBcnJPZlBhaXJzKTsKICAgIH0KCiAgICBpZiAoIWNsaW5pY2FsU3ZjSWQuY29udGFpbnMoIkVSUk9SIikpIHsKICAgICAgICB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jID0gY2xpbmljYWxTdmNJZDsKICAgICAgICB6RGF0YS5DbGluaWNhbE5hbWUgPSBnZXRTRkZpZWxkKGRvYywgIkNvcmVfQ2xpbmljYWxfU2VydmljZV9fYyIsICJOYW1lIiwgbnVsbCwgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyk7IC8vUFYxOTEwMjIKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjQ2xpbmljYWxfU2VydmljZXNfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgekRhdGEuWF9DbGluaWNhbF9TZXJ2aWNlc19fYyArIGRxICsgIik7ICIpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNDbGluaWNhbF9TZXJ2aWNlc19fY19OYW1lIiArIGRxICsgIikudmFsKCIgKyBkcSArIHpEYXRhLkNsaW5pY2FsTmFtZSArIGRxICsgIik7ICIpOwogICAgICAgIGFyck9mUGFpcnMucHVzaCgiQ2xpbmljYWxfU2VydmljZXNfX2MiLCB6RGF0YS5YX0NsaW5pY2FsX1NlcnZpY2VzX19jKTsKCiAgICAgICAgLy9DUk4xOTExMTggSWYgd2UgYWxzbyBoYXZlIGEgUGF0aWVudCBhbmQgYSBDbGluaWNhbCBTZXJ2aWNlLCBhc3NvY2lhdGUgdGhlbS4KICAgICAgICBpZiAoekRhdGEucGF0aWVudElkKSB7CiAgICAgICAgICAgIGFsZXJ0KCJAQEAgQXNzb2NpYXRpbmcgQ2xpbmljYWwgU2VydmljZTogIiArIGNsaW5pY2FsU3ZjSWQgKyAiIHdpdGggUGF0aWVudDogIiArIHpEYXRhLnBhdGllbnRJZCk7CiAgICAgICAgICAgIHZhciBzY3JpcHRBcnJPZlBhaXJzID0gW107CiAgICAgICAgICAgIHNjcmlwdEFyck9mUGFpcnMucHVzaCgiQ29yZV9QYXRpZW50X19jIiwgekRhdGEucGF0aWVudElkKTsKICAgICAgICAgICAgdXBkYXRlU0ZSZWNvcmQoZG9jLCAiQ29yZV9DbGluaWNhbF9TZXJ2aWNlX19jIiwgY2xpbmljYWxTdmNJZCwgc2NyaXB0QXJyT2ZQYWlycyk7CiAgICAgICAgfQogICAgfQp9CgppZiggekRhdGEuWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jICkgIGFyck9mUGFpcnMucHVzaCgiU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyIsekRhdGEuWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jKTsKaWYoIHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyApICBhcnJPZlBhaXJzLnB1c2goIlJlcG9ydGVkX091dGNvbWVfX2MiLHpEYXRhLlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyk7CmlmKCB6RGF0YS5YX0Fzc2Vzc21lbnRfVHlwZV9fYyAmJiAiRE9OT1RfU0FWRSIgIT09IHpEYXRhLlhfQXNzZXNzbWVudF9UeXBlX19jKSAgYXJyT2ZQYWlycy5wdXNoKCJBc3Nlc3NtZW50X1R5cGVfX2MiLHpEYXRhLlhfQXNzZXNzbWVudF9UeXBlX19jKTsKaWYoIHpEYXRhLlhfT3V0Y29tZV9UeXBlX19jICYmICJET05PVF9TQVZFIiAhPT0gekRhdGEuWF9PdXRjb21lX1R5cGVfX2MpICBhcnJPZlBhaXJzLnB1c2goIk91dGNvbWVfVHlwZV9fYyIsekRhdGEuWF9PdXRjb21lX1R5cGVfX2MpOwppZih6RGF0YS5YX1Byb2R1Y3RfRGVzY3JpYmVkX19jKSBhcnJPZlBhaXJzLnB1c2goIlByb2R1Y3RfRGVzY3JpYmVkX19jIix6RGF0YS5YX1Byb2R1Y3RfRGVzY3JpYmVkX19jKTsKaWYoekRhdGEuWF9aUEFQRVJfX2xhdGVzdEZheF9fYykgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX2xhdGVzdEZheF9fYyIsekRhdGEuWF9aUEFQRVJfX2xhdGVzdEZheF9fYyk7Ci8vRVJTMTkwODE0IGp1c3QgdGhlIGNoaWxkICM2MTUxMSB1cGRhdGVTRlJlY29yZChkb2MsIHpEYXRhLnpwcywgc2ZTdGFja0lkLCBhcnJPZlBhaXJzKTsKLy9sZXQgdGhlIGRvY1NldCBkbyB0aGUgd29yayBhdHRhY2goZG9jLGF0dGFjaExhYmVsLCBzZlN0YWNrSWQpOwp2YXIgcj11cGRhdGVTRlJlY29yZChkb2MsIlpQQVBFUl9felN0YWNrX19jIixzZlN0YWNrSWQsWyJaUEFQRVJfX1N0YXR1c19fYyIsIlNwbGl0Il0pOyAvL1BWMTkxMjE2CmFsZXJ0KCJAQEBAIHVwZGF0ZWQgYW5kIGF0dGFjaGVkIHRvIHpTdGFjayBSZWNvcmQsIGlkID0gIiArIHNmU3RhY2tJZCArICI/PSIrekRhdGEuZ2V0U3RhY2tJZChkb2MpKyIgZGF0YT0iK2Fyck9mUGFpcnMpOwoKdmFyIGNoaWxkU3RhY2tJZD16RGF0YS5jbGllbnRDaGlsZFN0YWNrKGRvYyxhcnJPZlBhaXJzLHNmU3RhY2tJZCk7IC8vRVJTMTkwODEwIGNyZWF0ZSBjaGlsZCBzdGFjayBmb3Igc3BsaXQgRVJTMTkwODExIGNsaWVudENoaWxkU3RhY2sKaWYgKGNoaWxkU3RhY2tJZCkge2F0dGFjaFBhdGgrPSIsIitzZlN0YWNrSWQrIiwiK2NoaWxkU3RhY2tJZDsgYXR0YWNoUGF0aD1hdHRhY2hQYXRoLnJlcGxhY2UoIi8sPyIsIi8iKTsgfSAvL0VSUzE5MDgxMSAjNjE1NzAgY2xlYW4gdXAgLy9wYXJlbnQgc3RhY2sgdG9vCmFyck9mUGFpcnM9W107Ly9QVjE5MTAyMyBFdmVyeXRpbWUgY2hpbGQgd2lsbCBhdHRhY2ggdG8gdGhhdCBwYXJ0aWN1bGFyIHpTdGFjawphcnJPZlBhaXJzLnB1c2goIlhfc2ZTdGFja0lkIixjaGlsZFN0YWNrSWQpOwovL0NSTjE5MTExOCBDbGVhciBvdXQgdGhlc2UgdmFsdWVzIGZyb20gcGFyZW50IHN0YWNrCmFyck9mUGFpcnMucHVzaCgiWF9pbmRleGVkUGFnZXMiLCIiKTsKYXJyT2ZQYWlycy5wdXNoKCJYX2lnbm9yZWRQYWdlcyIsIiIpOwphcnJPZlBhaXJzLnB1c2goIlhfcmVqZWN0ZWRQYWdlcyIsIiIpOwp1cGRhdGVEQihkb2MsYXJyT2ZQYWlycyk7Ci8qIE1vdmUgdGhlIHNwbGl0IGRvY3VtZW50IHRvIGl0cyBwcm9jZXNzaW5nIGZvbGRlciAqLwphbGVydCgiQEBAQEBAIE1vdmluZyB0aGUgaW5kZXhlZCBwYWdlcyBkb2N1bWVudCBpbnRvIG5leHQgcHJvY2Vzc2luZyBmb2xkZXI6ICIgKyBuZXh0Rm9sZGVyKTsKLy9FUlMxOTA3MzEgIzYxMjcyIG1vdmVEb2N1bWVudChkb2MsIiIsbmV4dEZvbGRlcik7Ci8vRVJTMTkwNzMxICM2MTI3MiByZWxvYWRCeUJBVEVTKGRvYywgbmV4dEZvbGRlcik7IC8vRVJTMTcwNDEzICMzNTI5MQovKiBQbGFjZSB0aGUgc3BsaXQgZG9jdW1lbnQgaW50byB0aGUgc3RhY2sgZm9sZGVyICovCmFsZXJ0KCJAQEBAQEAgTW92aW5nIHRoZSBpbmRleGVkIHBhZ2VzIGRvY3VtZW50IGludG8gdGhlIGZpbmFsIHN0YWNrIGZvbGRlcjogIiArIHN0YWNrRm9sZGVyKTsKbW92ZURvY3VtZW50KGRvYywiIixzdGFja0ZvbGRlcik7CnVubG9ja0RvY3VtZW50KGRvYyk7CmFyck9mUGFpcnMgPSB6RGF0YS5hZGRTdGFnZShkb2MsYXJyT2ZQYWlycyx6RGF0YS5zdGFnZSk7CnZhciBwYWdlQ291bnQgPSB6RGF0YS5jb3VudFBhZ2VzKGRvYyxwYWdlUmFuZ2UpOwphbGVydCgiQEBAQCBwYWdlQ291bnQgPSAiICsgcGFnZUNvdW50ICsiIHdlcmUgIisgekRhdGEuc3RhZ2UpOwphcnJPZlBhaXJzLnB1c2goIlhfcGFnZXMiLHBhZ2VDb3VudCk7CmFyck9mUGFpcnMucHVzaCgiWF9jb3VudCIscGFnZUNvdW50KTsgLy9QVjE5MTAyOCB1cGRhdGVkIGZvciBzdGFjayBjb21wbGV0ZSB0byB1c2UgZXhhY3QgcGFnZXMKYXJyT2ZQYWlycy5wdXNoKCJkYi1wYWdlcyIscGFnZUNvdW50KTsKLy9FUlMxOTA2MjAgYXJyT2ZQYWlycy5wdXNoKCJkYi1sYWJlbCIsIHBhdGllbnRGaXJzdE5hbWUgKyBwYXRpZW50TGFzdE5hbWUgKyAiIC0gIiArIGNvbXBhbnlDb2RlICsgIiAtICIgKyBzdGFja0lkKTsKLy9hcnJPZlBhaXJzLnB1c2goIlhfYXR0YWNoZWRUbyIsYXR0YWNoUGF0aCk7IC8vQ1JOMTkxMDI4IFdlIGRvbid0IG5lZWQgdG8gdXBkYXRlIHRoZSBYX2F0dGFjaGVkVG8gYmVjYXVzZSBpdCBpcyBiZWluZyBzZXQgY29ycmVjdGx5IGR1cmluZyBlYWNoIGF0dGFjaC4gQmVzaWRlcywgYXR0YWNoUGF0aCBob2xkcyB0aGUgcGFyZW50J3MgbWFzc2FnZWQgWF9hdHRhY2hlZFRvIHdoaWNoIHdlIGRvbid0IHdhbnQuIC8vRVJTMTcwNjI4CnVwZGF0ZURCKGRvYyxhcnJPZlBhaXJzKTsKCi8vUFYxOTEwMjkgQWRkICJJbmRleGVkIiB0byB0aGUgIlJlY2VpdmVkIiBYX3Jldmlld3MgYWRkZWQgaW4gY2xpZW50IGxpYnJhcnkgYWJvdmUuCnZhciBvcmlnWFJldmlld3MgPSBYKGRvYywgIlhfcmV2aWV3cyIpOwp2YXIgbm93MCA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYyk7Ly9QdjE5MTAyOSBjaGVjayBkb2NzZXQgY2hlY2tib3gKYXJyT2ZQYWlycyA9IFtdOwphcnJPZlBhaXJzLnB1c2goIlhfcmV2aWV3cyIsIG9yaWdYUmV2aWV3cyArICJJbmRleGVkIGJ5IGFnZW50IGF0ICIgKyBub3cwICsgIjxici8+Iik7CnVwZGF0ZURCKGRvYywgYXJyT2ZQYWlycyk7Cgp0cmFjayhkb2MsICJEb2MgSW5kZXhlZCIsICJEb2N1bWVudCB3aXRoIElkOiAiICsgZG9jLmRiSUQsIHBhZ2VDb3VudCk7CmFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAibmV4dFBhZ2UofnJlYWR5fik7dXBkYXRlREVTdGF0dXMofmluZGV4ZWQ6IiArIHBhZ2VSYW5nZSArICJ+KTsiKTsKCi8qIGVuZCBvZiBydWxlICovCg=="},"ordinal":6}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
//ASM 2020-01-09 - Fixes field for birthdate

alert("@@@@ Index Rule Fired @@@#");
//ERS190730 #61272 updated button validation in the Actions* Details area

var stackId = X(doc, "X_stack");
if (!stackId) stackId=zData.getStackId(doc); //ERS190624 HACK?
var stackFolder = stackId + "-STACK";
var companyCode = doc.deliveredTo;
zData.stage="Indexed"; //ERS190620

/* Clear the trigger that invoked this rule */
//ERS170909 zData.clearTriggerCondition(doc,"X_buttonAction");
var indexInitialized = X(doc,"X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    zData.initializeStack(doc,stackFolder, companyCode, stackId);
}

saveDEPanelValues(doc);             //CRN191118 Save DE Fields to Parent Stack
zData.getDataEntryFields(doc);
// Does the user want to attach indexed pages to Case?
//var caseId = X(doc, "X_ZPAPER__Case__c");
//var contactId = X(doc, "X_ZPAPER__Patient__c");
//var patientId=contactId; //TODO
//var providerId = X(doc, "X_ZPAPER__Provider__c");
//var patientFirstName = X(doc, "X_ZPAPER__FirstName__c");
//var patientLastName = X(doc, "X_ZPAPER__LastName__c");
//var patientDOB = X(doc, "X_ZPAPER__Birthdate__c");

// Get the document type (will be used to route to next folder)
//var docType = X(doc, "X_Document_Type__c");
var nextFolder = "20500Triage-S2";              // Other folder is the default
var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
//move to after updates arrOfPairs=zData.addStage(doc,arrOfPairs,"Indexed");
updateDB(doc,arrOfPairs);

//var sfStackId=zData.getStackId(doc);
var sfStackId=X(doc,'X_sfStackId');
if(!sfStackId){
  sfStackId=zData.getStackId(doc);
}

alert("@@@@@@ Currently attached to ZPAPER__zStack__c with ID: " + sfStackId);
zData.zParentId=doc.dbID; //ERS190814 to overside the save.jsp workflows

alert("@@@@ Parent zStack Snippet attached to: " + X(doc, "X_attachedTo"));

/* SPLIT OFF NEW SNIPPET HERE */
var pageRange = X(doc,"X_idxPages");
var newId=splitDocumentForIndex(doc, "index", pageRange);

alert("@@@@ AFTER SPLIT: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));

saveDEPanelValues(doc);             //CRN191118 Also Save DE Fields to Child Stack

alert("ERS190624 newId="+newId);
//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/* Attach the split document to a new Case record, if it wasn't passed in and if we are not handling the 2A DE Panel: Canada_Priority_Data2_Web_Form */
//var priority=X(doc,"X_ZPAPER__Priority__c"); //ERS170626
var label0="";
var triageType=doc.docType;

var attachPath = X(doc,"X_attachedTo");
zData.attachedToCase =false;
zData.attachedTo = X(doc, "X_Attach_To__c"); //PV191205 updated case creation
    alert("zData.attachedTo========="+zData.attachedTo);
    var attachFaxTypes =["ENRL","MEDO","OTH","COPAY"];
    //if( attachFaxTypes.indexOf(zData.X_ZPAPER__faxType__c) >-1 && (zData.attachedTo === "Care Plan" || zData.attachedTo === "All")){
    if((zData.attachedTo === "Care Plan" || zData.attachedTo === "All")){
      zData.attachedToCase = true;
    }
/* Attach the split document to Patient record if required */ //ERS190619
zData.patientType=XCustomSetting(doc,"ZPAPER__PatientRecord__c"); //ERS190806 ZPAPER__ now in MP
alert("@@@@ zData.patientType ***** "+zData.patientType+" Patient");
alert("@@@ current DE Panel name = " + X(doc, "X_lastDEPanel"));
if (!zData.patientType) zData.patientType="Contact"; //ERS190802 #61272
//if (X(doc,"X_ZPAPER__Patient__c") || zData.X_ZPAPER__LastName__c) { //ERS190803 TODO rethink use X
    var dq = zData.dq = String.fromCharCode(34); //ERS190802 TODO define better in zData
    var patientPhone = X(doc, "X_ZPAPER__Phone__c");
    alert("@@@ patientPhone = " + patientPhone);
    if (!zData.patientId) {
        alert("@@@@ creating new "+zData.patientType+" Patient");
        arrOfPairs = [];
        //ERS190730 #61272 missing the basics
        var p="";
        if ("Account"===zData.patientType) { //ERS190803
            p="Person";
            //arrOfPairs.push("Name", zData.X_ZPAPER__FirstName__c+" "+zData.X_ZPAPER__LastName__c);
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c);
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
//                arrOfPairs.push(p+"Birthdate", zData.X_ZPAPER__Birthdate__c);
                arrOfPairs.push("Core_Birth_Date__pc", zData.X_ZPAPER__Birthdate__c); //ASM20200109 - Using the correct field. //CRN200108 abbvie wants birthdate stored in this field, not standard field
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        } else {
            arrOfPairs.push("FirstName", zData.X_ZPAPER__FirstName__c); //X_ZPAPER__FirstName__c //ERS190803 TODO get cleaner #61272
            arrOfPairs.push("LastName", zData.X_ZPAPER__LastName__c);
            if (zData.X_ZPAPER__Birthdate__c) {
                arrOfPairs.push("Birthdate", zData.X_ZPAPER__Birthdate__c);
            }
            if (patientPhone) { arrOfPairs.push("Phone", patientPhone); }
        }
        var attachLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
        zData.patientId=zData.clientPatient(doc,arrOfPairs, attachLabel);
        alert("Created Patient with ID: " + zData.patientId);
        if (zData.patientId == "null" || zData.patientId == "NEW") zData.patientId=null;
        else { //ERS190730 #61272 leverage the new record
            if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
            alert("@@@@@@@ NEW PATIENT CREATED WITH ID: " + zData.patientId); //ERS190802 zData.contactId
            // clear out the "New Patient" fields
            if (1===1) { //ERS190811 #61570 commented out so that patient info is available for DE variables in zippi
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Phone__c" + dq + ").val(" + dq + "" + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + "NONE" + dq + "); ");
            }
            // set the Patient lookup fields
            //ERS190803 TODO handle ZPAPER__ relationships //ERS190811 double up for safety
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c" + dq + ").val(" + dq + zData.patientId + dq + "); ");
            addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__PatientAccount__c_Name" + dq + ").val(" + dq + zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c + dq + "); ");
            //CRN191118 Also save the new values to the child
            var save2DBArrOfPairs = [];
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__c", zData.patientId);
            save2DBArrOfPairs.push("X_ZPAPER__PatientAccount__r.Name", zData.X_ZPAPER__FirstName__c + " " + zData.X_ZPAPER__LastName__c);
            updateDB(doc, save2DBArrOfPairs);
        }
    } else {
        //if (zData.X_ZPAPER__faxType__c && ("CONS" === zData.X_ZPAPER__faxType__c
         //   || "ENRL" ===zData.X_ZPAPER__faxType__c ||
         //  "MEDO" === zData.X_ZPAPER__faxType__c)) { //ERS19109 #64921 TODO many journey best proctice
            alert("@@@@ attaching to existing Patient: " + zData.patientId);
            if (zData.patientType != "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "FirstName,LastName,Birthdate", null, zData.patientId);
                alert("@@@@ attaching to existing contactFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "FirstName", contactFlds); //PV191006 update the child stack
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "LastName", contactFlds);
                zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "Birthdate", contactFlds);
            } else if (zData.patientType === "Account") { //ERS190730 lookup the data TODO person account?
                var contactFlds = getSFFields(doc, zData.patientType, "Name", null, zData.patientId);
                alert("@@@@ attaching to existing AccountFlds: " + contactFlds);
                zData.X_ZPAPER__FirstName__c = patientFirstName = X(doc, "Name", contactFlds).split(" ")[0]; //ERS190803 TODO find a better way
                zData.X_ZPAPER__LastName__c = patientLastName = X(doc, "Name", contactFlds).split(" ")[1];
                //zData.X_ZPAPER__Birthdate__c=patientDOB = X(doc, "PersonBirthdate", contactFlds);

            }
            //PV191008 updated attachLabel on child stack
            attachLabel=zData.clientFile(doc,"Indexed");
            if(zData.attachedTo === "Patient" || zData.attachedTo === "All"){
                attach(doc, attachLabel, zData.patientId);
            }
      // }
    }
    if (zData.patientId && attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
//}
alert("@@@@ AFTER PATIENT: Child zStack Snippet attached to: " + attachPath);

var attachLabel=zData.clientFile(doc,"Indexed"); //"Indexed " + formatNow;
alert("ERS190624 attachLabel="+attachLabel);


/* Attach the split document to Lead record if required */ //ERS190619
// TODO ERS190624 flip the if logic
if (doc.wddata.indexOf("X_ZPAPER__ReferralLead__c")>-1) { //ERS190803 TODO rethink
    if (!leadId || 0 === leadId.length) {
        alert("@@@@ creating new Lead");
        arrOfPairs = [];
        leadId=zData.clientLead(doc,arrOfPairs);
        alert("Created Lead with ID: " + leadId);
        if (leadId == "null" || leadId == "NEW") leadId=null;
    } else {
        if (zData.attachRecords.indexOf("Lead")>-1) {
            alert("@@@@ attaching to existing Lead: " + leadId);
            attach(doc, attachLabel, leadId);
        }
    }
    if (leadId && attachPath.indexOf(leadId)==-1) attachPath+=","+leadId;
}
alert("@@@@ AFTER LEAD: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//ERS190620 use a setting to determine which lookups we attach to
/* Attach the split document to Case record if required */ //ERS190619
//if (doc.wddata.indexOf("X_ZPAPER__Case__c")>-1) {
  if(1===1){
    alert("ERS190624 need Case");
    if (zData.caseId) {
        if (zData.attachRecords.indexOf("Case")>-1) {
            alert("@@@@ attaching to existing Case: " + zData.caseId);
            attachLabel=zData.clientFile(doc,"Indexed");
            if(zData.attachedToCase){
                attach(doc, attachLabel, zData.caseId);
            }
        }
    }
    alert("ERS190624.78 have a case?");
    if (zData.caseId && attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}

alert("@@@@ AFTER CASE: Child zStack Snippet attached to: " + X(doc, "X_attachedTo"));


//PV191022 create prescription
var stackFlds = getSFFields(doc, "ZPAPER__zStack__c", "ZPAPER__latestFax__c", null, sfStackId);
zData.X_ZPAPER__latestFax__c =  X(doc, "ZPAPER__latestFax__c", stackFlds); //PV190926 update the child stack
if( zData.X_Prescription__c){
    alert("@@@@ attaching to existing Prescription: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    if( zData.attachedTo ==="Prescription" || zData.attachedTo ==="All"){
        attach(doc, attachLabel, zData.X_Prescription__c);
    }
}
if( !zData.X_Prescription__c && zData.X_ZPAPER__faxType__c &&"RX" === zData.X_ZPAPER__faxType__c ) { //ERS191109 #64921 TODO many journeys
    alert("@@@@ Creating  Prescription__c with fax Type : " + zData.X_ZPAPER__faxType__c);
    arrOfPairs = [];
    arrOfPairs.push("Core_Date_of_Prescription_Received__c",zData.X_ZPAPER__latestFax__c);
    arrOfPairs.push("Core_ProductPrescribed__c",zData.X_ZPAPER__Classification__c);
    arrOfPairs.push("Core_CarePlan__c", zData.caseId);
    arrOfPairs.push("Core_Patient__c", zData.patientId);
    if( zData.attachedTo ==="Prescription" || zData.attachedTo ==="All"){
        zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");
    }else{
        zData.X_Prescription__c = zData.clientRecordTypeNoAttach(doc,"Core_Prescription__c",arrOfPairs,"Index");
    }
    //zData.X_Prescription__c = zData.clientRecordType(doc,"Core_Prescription__c",arrOfPairs,"Index");  CRN191213 Don't create the Prescription multiple times
    alert("@@@@ Create Prescription__c with ID: " + zData.X_Prescription__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    //attach(doc, attachLabel, zData.X_Prescription__c);
    zData.PrescriptionName = getSFField(doc, "Core_Prescription__c", "Name", null, zData.X_Prescription__c); //PV191022 //ERS191109 clientIndex?
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c" + dq + ").val(" + dq + zData.X_Prescription__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Prescription__c_Name" + dq + ").val(" + dq + zData.PrescriptionName + dq + "); ");

}
//CRN191118 If we also have a patient and a Prescription, associate them.
/*
if (zData.patientId && zData.X_Prescription__c) {
    alert("@@@ Associating Prescription: " + zData.X_Prescription__c + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
    updateSFRecord(doc, "Core_Prescription__c", zData.X_Prescription__c, scriptArrOfPairs);
}
*/

//COMDR
//if( !zData.caseId && ("COMDR" === zData.X_ZPAPER__faxType__c
//     || "MEDC"=== zData.X_ZPAPER__faxType__c || "LAB"=== zData.X_ZPAPER__faxType__c
//     || "INJR"===zData.X_ZPAPER__faxType__c)){
//CRN191114 According to the Abbvie stories, all docTypes except "Consent Forms" need to have a Case created if one isn't already selected
if(!zData.caseId && "CONS" !== zData.X_ZPAPER__faxType__c && 'Canada_Priority_Data2_Web_Form' !== X(doc, "X_lastDEPanel")) {
    arrOfPairs = [];
    arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");               // CRN191114 Always use CarePlan Record Type?
    arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
    if(zData.programName === "Abbvie OneCRM - Canada"){
        arrOfPairs.push("Core_CountryCode__c","CA");
    }
    if (zData.patientId) { arrOfPairs.push("AccountId", zData.patientId); }
    if(zData.attachedToCase){
        zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
    }else{
        zData.caseId = zData.clientRecordTypeNoAttach(doc,"Case",arrOfPairs,"Index");
    }
    zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    zData.X_Clinical_Services_Record_Type__c = X(doc, "X_Clinical_Services_Record_Type__c");

/*
CRN191113 Moved below where the docType logic isn't so convoluted
    if("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c){
      arrOfPairs = [];
      if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24GQAS");
      }
      if("injection Training"===zData.X_Clinical_Services_Record_Type__c){

        arrOfPairs.push("Clinical_Services_Record_Type__c","0125E000000K24LQAS");
      }

     //arrOfPairs.push("Service_Requested_date__c",zData.X_Service_Requested_Date__c);
     //arrOfPairs.push("Core_Patient__c",zData.patientId);
     if(!zData.X_Clinical_Services__c){
        associatedArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
        associatedArrOfPairs.push("Core_Patient__c", zData.patientId);
        zData.X_Clinical_Services__c = zData.clientRecordType(doc,"Core_Clinical_Service__c",arrOfPairs,"Index");
     }
     attachLabel=zData.clientFile(doc,"Indexed");
     attach(doc, attachLabel,  zData.X_Clinical_Services__c);
     zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
     addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
    }
    */
}

//SHR191209 #65535 add Document Link if we have a new Case Id
if (zData.caseId) {
    var zserver = doc.kbData.sfServer.startsWith("https://") ? doc.kbData.sfServer : "https://" + doc.kbData.sfServer;
    var docurl = zserver + "/services/data/v46.0/sobjects/ContentVersion/";
    var pdfurl = "https://gw.zpaper.com/kb/jsp/SF_find.lightning.jsp?go=SF_files.jsp&dbID=" + doc.dbID + "&SForg=" + doc.kbData.sfOrganizationID;
    var ContentVersionCategories = {
        "OTH": "Other Documents",
        "MIF": "Missing Information",
        "ENRL": "Enrollment Form",
        "MEDO": "Medical - Other",
        "CONS": "Consent Forms",
        "COMDR": "Communication from Physicians",
        "RX": "Prescription",
        "SA": "SA Documents",
        "MEDC": "Medical Clarification",
        "LAB": "Lab Documents",
        "INJR": "Injection Report",
        "CA": "Clinical Assessment",
        "COPAY": "Copay"
    }
    var datestr = getCurDate(doc);
    var accname = X(doc, "X_ZPAPER__PatientAccount__r.Name");
    var faxtype = X(doc, "X_ZPAPER__faxType__c");
    var revstat = X(doc, "X_reviewedStatus");
    var cattype = ContentVersionCategories[faxtype] || faxtype;
    var docdata = {
        "Title": accname + " - " + faxtype + " - " + datestr,
        "Description": revstat + " by: " + doc.sfUserName + " at: " + zData.formatNow,
        "FirstPublishLocationId": zData.caseId,
        "ContentUrl": pdfurl,
        "CORE_Legacy_Document_ID__c": pdfurl,
        "Core_CountryCode__c": "CA",
        "Core_Category__c": cattype,
        "Core_Sub_Category__c": zData.X_Sub_Category__c
    };
    var headers = [
        "Authorization", "Bearer " + doc.kbData.sfSessionID,
        "Content-Type", "application/json"
    ];
    var body = JSON.stringify(docdata);
    try {
        var res = wpost(doc, docurl, [], headers, body);
        alert("wpost response: " + res);
    }
    catch(ex) {
        alert("wpost exception: " + ex);
        try {
            var mess = JSON.parse(ex);
            if (mess && Array.isArray(mess) && mess[0].errorCode) {
                addPostExecutionScript(doc, "alert(`Error creating ContentVersion! " + mess[0].errorCode + " => " + mess[0].message + "`);");
            }
        }
        catch(pex) {
            addPostExecutionScript(doc, "alert(`Error parsing JSON repsponse: " + ex + "`);");
        }
    }
}

//COPAY
if ("COPAY" === zData.X_ZPAPER__faxType__c) {
    arrOfPairs = [];
    arrOfPairs.push("CA_Patient__c",zData.patientId);
    arrOfPairs.push("CA_CarePlanID__c",zData.caseId);
    zData.copayId = zData.clientRecordType(doc,"CA_Copay__c",arrOfPairs,"Index");
}


//OTH
if( !zData.caseId && ("OTH" === zData.X_ZPAPER__faxType__c || "ENRL" === zData.X_ZPAPER__faxType__c
    || "MEDO" === zData.X_ZPAPER__faxType__c || "RX" === zData.X_ZPAPER__faxType__c )){
    if(zData.createCase){
        arrOfPairs = [];
        arrOfPairs.push("RecordTypeId","0121i000000hQo7AAE");
        arrOfPairs.push("Core_Brand__c",zData.X_ZPAPER__Classification__c);
        if(zData.programName === "Abbvie OneCRM - Canada"){
            arrOfPairs.push("Core_CountryCode__c","CA");
        }

        zData.caseId = zData.clientRecordType(doc,"Case",arrOfPairs,"Index");
        zData.caseNumber = getSFField(doc, "Case", "CaseNumber", null, zData.caseId); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + zData.caseId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + zData.caseNumber + dq + "); "); //PV190929 updated case number in lookup
    }
}

if( zData.X_Reported_Outcome__c){
    alert("@@@@ attaching to existing Outcome: " + zData.X_Reported_Outcome__c);
    attachLabel=zData.clientFile(doc,"Indexed");
    if( zData.attachedTo ==="Reported Outcomes" || zData.attachedTo ==="All"){
        attach(doc, attachLabel, zData.X_Reported_Outcome__c);
    }
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating Reported Cutcome: " + zData.X_Reported_Outcome__c + " with Patient: " + zData.patientId);
        var outcomeArrOfPairs = [];
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
        updateSFRecord(doc, "Core_Patient_Reported_Outcomes__c", zData.X_Reported_Outcome__c, outcomeArrOfPairs);
    }
}
else if ("CA" === zData.X_ZPAPER__faxType__c) {
    var outcomeArrOfPairs = [];
    outcomeArrOfPairs.push("Core_Entry_Date__c", getCurDate(doc));
    outcomeArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    var assessmentType = X(doc, "X_Assessment_Type__c");
    if (assessmentType && "DONOT_SAVE" !== assessmentType) {
        outcomeArrOfPairs.push("Core_Assessment_Type__c", assessmentType);
    }
    var outcomeType = X(doc, "X_Outcome_Type__c");
    if (outcomeType && "DONOT_SAVE" !== outcomeType) {
        outcomeArrOfPairs.push("Core_Outcome_Type__c", outcomeType);
    }
    //CRN191118 If we also have a Patient and a Reported Outcome, associate them.
    if (zData.patientId) {
        alert("@@@ Associating New Reported Cutcome with Patient: " + zData.patientId);
        outcomeArrOfPairs.push("Core_Account__c", zData.patientId);
    }
    if( zData.attachedTo ==="Reported Outcomes" || zData.attachedTo ==="All"){
        zData.X_Reported_Outcome__c = zData.clientRecordType(doc,"Core_Patient_Reported_Outcomes__c",outcomeArrOfPairs,"Index");
    }else{
        zData.X_Reported_Outcome__c = zData.clientRecordTypeNoAttach(doc,"Core_Patient_Reported_Outcomes__c",outcomeArrOfPairs,"Index");
    }
    var outcomeName = getSFField(doc, "Core_Patient_Reported_Outcomes__c", "Name", null, zData.X_Reported_Outcome__c);
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c" + dq + ").val(" + dq + zData.X_Reported_Outcome__c + dq + "); ");
    addPostExecutionScript(doc, " $(" + dq + "#Reported_Outcome__c_Name" + dq + ").val(" + dq + outcomeName + dq + "); ");
}


arrOfPairs = [];
if (zData.docType) { arrOfPairs.push("ZPAPER__faxType__c", zData.docType);  } //ERS190810 PV190808 #51670
if (zData.providerId) {
    arrOfPairs.push("ZPAPER__Provider__c", zData.providerId);
    if (attachPath.indexOf(zData.providerId)==-1) attachPath+=","+zData.providerId;
}
alert("ERS190812.200 zData.patientId="+zData.patientId); //ERS190812 #61511
if (zData.patientId) {
    if (zData.patientId.indexOf("003")===0) arrOfPairs.push("ZPAPER__Patient__c", zData.patientId);
    if (zData.patientId.indexOf("001")===0) arrOfPairs.push("ZPAPER__PatientAccount__c", zData.patientId);
    if (zData.patientId.indexOf("00Q")===0) arrOfPairs.push("ZPAPER__ReferralLead__c", zData.patientId); //ERS190802 Lead
    if (attachPath.indexOf(zData.patientId)==-1) attachPath+=","+zData.patientId;
    if (1===1) { //ERS190810 PV190808 data entry for next split
        if (zData.X_ZPAPER__FirstName__c) { arrOfPairs.push("ZPAPER__FirstName__c", zData.X_ZPAPER__FirstName__c); }
        if (zData.X_ZPAPER__LastName__c) { arrOfPairs.push("ZPAPER__LastName__c", zData.X_ZPAPER__LastName__c); }
        if (zData.X_ZPAPER__Birthdate__c) { arrOfPairs.push("ZPAPER__Birthdate__c", zData.X_ZPAPER__Birthdate__c); }
        if (zData.X_ZPAPER__Status__c) {arrOfPairs.push(zp+"Status__c", "Completed"); } //PV191023 updateing status
    }
}
if (zData.caseId) {
    arrOfPairs.push("ZPAPER__Case__c", zData.caseId);
    if (attachPath.indexOf(zData.caseId)==-1) attachPath+=","+zData.caseId;
}
 alert("@@@@ zData.contactId = " + zData.contactId);
if (zData.contactId && zData.contactId.startsWith("003")) {

    arrOfPairs.push("ZPAPER__Patient__c", zData.contactId);
}
if (zData.leadId) {
    arrOfPairs.push("ZPAPER__ReferralLead__c", zData.leadId);
    if (attachPath.indexOf(zData.leadId)==-1) attachPath+=","+zData.leadId;
}
if (zData.referralId) {
    arrOfPairs.push("ZPAPER__Referral__c", zData.referralId);
    if (attachPath.indexOf(zData.referralId)==-1) attachPath+=","+zData.referralId;
}
if (zData.X_ZPAPER__Phone__c) { //PV191006 UPDATED FOR PHONE
    arrOfPairs.push("ZPAPER__Phone__c", zData.X_ZPAPER__Phone__c);

}
var specialAuthId = X(doc, "X_Special_Authorization__c");
alert("@@@ zData.X_Special_Authorization__c " + specialAuthId);
var authDocType = X(doc, "ZPAPER__faxType__c");
if (specialAuthId) {
    arrOfPairs.push("Special_Authorization__c", specialAuthId);
    //PV191113 If we have a Special Authorization, attach this document to it
    var specialLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    if( zData.attachedTo ==="Special Authorization" || zData.attachedTo ==="All"){
        attach(doc, specialLabel, specialAuthId);
    }
}
else if ("SA" === zData.X_ZPAPER__faxType__c) {
    var authArrOfPairs = [];
    var authLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    authArrOfPairs.push("MemberPlanId", zData.X_Member_Plan__c , "CA_Coverage_Benefit__c", zData.X_Coverage_Benefit__c );
    authArrOfPairs.push("CA_Patient__c", zData.patientId);
    authArrOfPairs.push("Name", "anyValue");
    var specialAuthId ="";
    if( zData.attachedTo ==="Special Authorization" || zData.attachedTo ==="All"){
        specialAuthId = createAndAttach(doc, "CarePreauth", authLabel, authArrOfPairs);
    }else{
        specialAuthId = createSFRecord(doc, "CarePreauth", authLabel, authArrOfPairs);
    }

    if (!specialAuthId.contains("ERROR")) {
        var authName = getSFField(doc, "CarePreauth", "Name", null, specialAuthId);
        arrOfPairs.push("Special_Authorization__c", specialAuthId);
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c" + dq + ").val(" + dq + specialAuthId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Special_Authorization__c_Name" + dq + ").val(" + dq + authName + dq + "); ");
    }
}
//CRN191118 If we also have a Patient and a Special Authorization, associate them.
if (zData.patientId && specialAuthId) {
    alert("@@@ Associating Special Authorization: " + specialAuthId + " with Patient: " + zData.patientId);
    var scriptArrOfPairs = [];
    scriptArrOfPairs.push("CA_Patient__c", zData.patientId);
    updateSFRecord(doc, "CarePreauth", specialAuthId, scriptArrOfPairs);
}

//CRN191114 Handle any passed-in physician (Should this be only for COMDR: Communication from Physician?)
alert("@@@@ zData.X_Physician__c = " + zData.X_Physician__c);
alert("@@@@ X_Physician__c = " + X(doc, "X_Physician__c"));
if (X(doc, "X_Physician__c")) {
    zData.X_Physician__c = X(doc, "X_Physician__c");
    alert("@@@@ zData.X_Physician__c now = " + zData.X_Physician__c);
    arrOfPairs.push("Physician__c", zData.X_Physician__c);
    var physicianLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    alert("@@@ Attaching to Physician__c with Id: " + zData.X_Physician__c);
    attach(doc, physicianLabel, zData.X_Physician__c);
}

//PV191008 updated new fields
if(zData.X_ZPAPER__Classification__c) arrOfPairs.push("ZPAPER__Classification__c",zData.X_ZPAPER__Classification__c);
if( zData.X_ZPAPER__Priority__c) {
    if (!zData.X_ZPAPER__faxType__c) {
        arrOfPairs.push("ZPAPER__Priority__c",zData.X_ZPAPER__Priority__c);
    }
    else {
        arrOfPairs.push("ZPAPER__Priority__c", "");
    }
}
if( zData.X_Sub_Category__c )  arrOfPairs.push("Sub_Category__c",zData.X_Sub_Category__c);
if( zData.X_ZPAPER__faxType__c)  arrOfPairs.push("ZPAPER__faxType__c",zData.X_ZPAPER__faxType__c);
if( zData.X_Prescription__c )  arrOfPairs.push("Prescription__c",zData.X_Prescription__c);
if( zData.X_Member_Plan__c )  arrOfPairs.push("Member_Plan__c",zData.X_Member_Plan__c);
if( zData.X_Coverage_Benefit__c )  arrOfPairs.push("Coverage_Benefit__c",zData.X_Coverage_Benefit__c);
if( zData.X_Clinical_Services__c ) {
    arrOfPairs.push("Clinical_Services__c",zData.X_Clinical_Services__c);
    //PV191113 If we have a Clinical Services, attach this document to it
    var clinicalLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    if( zData.attachedTo ==="Clinical Services" || zData.attachedTo ==="All"){
        attach(doc, clinicalLabel, zData.X_Clinical_Services__c);
    }
}
else if (("LAB"=== zData.X_ZPAPER__faxType__c || "INJR"===zData.X_ZPAPER__faxType__c
       || "MEDC" === zData.X_ZPAPER__faxType__c) && X(doc, "X_Service_Requested_Date__c")) {        //CRN191113 Create new Clinical Services record if DocType is MEDC and the Service Requested Date is filled in
    var clinicalSvcArrOfPairs = [];
    var clinicalSvcLabel = zData.X_ZPAPER__FirstName__c +" " + zData.X_ZPAPER__LastName__c + " - " + getCurDateAndTime(doc);
    clinicalSvcArrOfPairs.push("Core_Care_Plan__c", zData.caseId);
    clinicalSvcArrOfPairs.push("Core_Patient__c", zData.patientId);
    if("Lab Tests"===zData.X_Clinical_Services_Record_Type__c){
        arrOfPairs.push("Clinical_Services_Record_Type__c","0121i000000Y9DRAA0");
    }
    clinicalSvcArrOfPairs.push("Service_Requested_date__c", X(doc, "X_Service_Requested_Date__c"));
    if("Injection Training"===zData.X_Clinical_Services_Record_Type__c){
        clinicalSvcArrOfPairs.push("Clinical_Services_Record_Type__c","0121i000000Y9DQAA0");
    }
    var clinicalSvcId="";
    if( zData.attachedTo ==="Clinical Services" || zData.attachedTo ==="All"){
        clinicalSvcId = createAndAttach(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    }else{
        clinicalSvcId = createSFRecord(doc, "Core_Clinical_Service__c", clinicalSvcLabel, clinicalSvcArrOfPairs);
    }

    if (!clinicalSvcId.contains("ERROR")) {
        zData.X_Clinical_Services__c = clinicalSvcId;
        zData.ClinicalName = getSFField(doc, "Core_Clinical_Service__c", "Name", null, zData.X_Clinical_Services__c); //PV191022
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c" + dq + ").val(" + dq + zData.X_Clinical_Services__c + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#Clinical_Services__c_Name" + dq + ").val(" + dq + zData.ClinicalName + dq + "); ");
        arrOfPairs.push("Clinical_Services__c", zData.X_Clinical_Services__c);

        //CRN191118 If we also have a Patient and a Clinical Service, associate them.
        if (zData.patientId) {
            alert("@@@ Associating Clinical Service: " + clinicalSvcId + " with Patient: " + zData.patientId);
            var scriptArrOfPairs = [];
            scriptArrOfPairs.push("Core_Patient__c", zData.patientId);
            updateSFRecord(doc, "Core_Clinical_Service__c", clinicalSvcId, scriptArrOfPairs);
        }
    }
}

if( zData.X_Service_Requested_Date__c )  arrOfPairs.push("Service_Requested_Date__c",zData.X_Service_Requested_Date__c);
if( zData.X_Reported_Outcome__c )  arrOfPairs.push("Reported_Outcome__c",zData.X_Reported_Outcome__c);
if( zData.X_Assessment_Type__c && "DONOT_SAVE" !== zData.X_Assessment_Type__c)  arrOfPairs.push("Assessment_Type__c",zData.X_Assessment_Type__c);
if( zData.X_Outcome_Type__c && "DONOT_SAVE" !== zData.X_Outcome_Type__c)  arrOfPairs.push("Outcome_Type__c",zData.X_Outcome_Type__c);
if(zData.X_Product_Described__c) arrOfPairs.push("Product_Described__c",zData.X_Product_Described__c);
if(zData.X_ZPAPER__latestFax__c) arrOfPairs.push("ZPAPER__latestFax__c",zData.X_ZPAPER__latestFax__c);
//ERS190814 just the child #61511 updateSFRecord(doc, zData.zps, sfStackId, arrOfPairs);
//let the docSet do the work attach(doc,attachLabel, sfStackId);
var r=updateSFRecord(doc,"ZPAPER__zStack__c",sfStackId,["ZPAPER__Status__c","Split"]); //PV191216
alert("@@@@ updated and attached to zStack Record, id = " + sfStackId + "?="+zData.getStackId(doc)+" data="+arrOfPairs);

var childStackId=zData.clientChildStack(doc,arrOfPairs,sfStackId); //ERS190810 create child stack for split ERS190811 clientChildStack
if (childStackId) {attachPath+=","+sfStackId+","+childStackId; attachPath=attachPath.replace("/,?","/"); } //ERS190811 #61570 clean up //parent stack too
arrOfPairs=[];//PV191023 Everytime child will attach to that particular zStack
arrOfPairs.push("X_sfStackId",childStackId);
//CRN191118 Clear out these values from parent stack
arrOfPairs.push("X_indexedPages","");
arrOfPairs.push("X_ignoredPages","");
arrOfPairs.push("X_rejectedPages","");
updateDB(doc,arrOfPairs);
/* Move the split document to its processing folder */
alert("@@@@@@ Moving the indexed pages document into next processing folder: " + nextFolder);
//ERS190731 #61272 moveDocument(doc,"",nextFolder);
//ERS190731 #61272 reloadByBATES(doc, nextFolder); //ERS170413 #35291
/* Place the split document into the stack folder */
alert("@@@@@@ Moving the indexed pages document into the final stack folder: " + stackFolder);
moveDocument(doc,"",stackFolder);
unlockDocument(doc);
arrOfPairs = zData.addStage(doc,arrOfPairs,zData.stage);
var pageCount = zData.countPages(doc,pageRange);
alert("@@@@ pageCount = " + pageCount +" were "+ zData.stage);
arrOfPairs.push("X_pages",pageCount);
arrOfPairs.push("X_count",pageCount); //PV191028 updated for stack complete to use exact pages
arrOfPairs.push("db-pages",pageCount);
//ERS190620 arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + stackId);
//arrOfPairs.push("X_attachedTo",attachPath); //CRN191028 We don't need to update the X_attachedTo because it is being set correctly during each attach. Besides, attachPath holds the parent's massaged X_attachedTo which we don't want. //ERS170628
updateDB(doc,arrOfPairs);

//PV191029 Add "Indexed" to the "Received" X_reviews added in client library above.
var origXReviews = X(doc, "X_reviews");
var now0 = getCurDateAndTime(doc);//Pv191029 check docset checkbox
arrOfPairs = [];
arrOfPairs.push("X_reviews", origXReviews + "Indexed by agent at " + now0 + "<br/>");
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");

/* end of rule */

//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
dmFyIERFX1BBTkVMX0ZPUk1fMkEgICAgPSAiQ2FuYWRhX1ByaW9yaXR5X0RhdGEyX1dlYl9Gb3JtIjsNCnZhciBERV9QQU5FTF9GT1JNXzJCICAgID0gIk9uZV9DUk1fQ2FuYWRhX0luZGV4X0RhdGEyX1dlYl9Gb3JtIjsNCg0KLyoNCjxvcHRpb24gdmFsdWU9IkRPTk9UX1NBVkUiPjwvb3B0aW9uPg0KPG9wdGlvbiB2YWx1ZT0iT1RIIj5PVEg6T3RoZXIgRG9jdW1lbnRzPC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJFTlJMIj5FTlJMOkVucm9sbG1lbnQ8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9Ik1FRE8iPk1FRE86IE1lZGljYWwgT3RoZXI8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkNPTlMiPkNPTlM6IENvbnNlbnQ8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkNPTURSIj5DT01EUjogQ29tbXVuaWNhdGlvbiBmcm9tIFBoeXNpY2lhbjwvb3B0aW9uPg0KPG9wdGlvbiB2YWx1ZT0iUlgiPlJYOiBQcmVzY3JpcHRpb248L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IlNBIj5TQTogU3BlY2lhbCBBdXRob3JpemF0aW9uPC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJNRURDIj5NRURDOiBNZWRpY2FsIENsYXJpZmljYXRpb248L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkxBQiI+TEFCOiBMYWIgRG9jdW1lbnRzPC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJJTkpSIj5JTkpSOiBJbmplY3Rpb24gUmVwb3J0PC9vcHRpb24+DQo8b3B0aW9uIHZhbHVlPSJDQSI+Q0E6IENsaW5pY2FsIEFzc2Vzc21lbnQ8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IkNPUEFZIj5DT1BBWTogQ29wYXk8L29wdGlvbj4NCjxvcHRpb24gdmFsdWU9IlVOOlVua25vd24iPlVOOlVua25vd248L29wdGlvbj4NCnZhciBmb3JtMkJWYWxpZGF0aW9ucyA9IHsNCiAgICAiT1RIIjogew0KICAgICAgICAicmVxRmllbGRzIjogWw0KICAgICAgICAgICAgeyJuYW1lIjogIiIsICJsYWJlbCI6ICIifQ0KICAgICAgICBdDQogICAgfSwNCiAgICAiTUVEQyI6IG51bGwsDQogICAgIkxBQiI6IG51bGwsDQogICAgIklOSlIiOiBudWxsDQp9DQoqLw0KLy8gV2UnbGwgZmlsbCB0aGlzIGluIHdpdGggYSByZXFGaWVsZHMgbWVtYmVyIGFzIHRoZSBleGFtcGxlIGFib3ZlDQp2YXIgZm9ybTJCVmFsaWRhdGlvbnMgPSB7DQogICAgIkNPTlMiOiAgbnVsbCwNCiAgICAiRU5STCI6IG51bGwsDQogICAgIk1FRE8iOiBudWxsLA0KICAgICJPVEgiOiBudWxsLA0KICAgICJDT01EUiI6IHsNCiAgICAgICAgInJlcUZpZWxkcyI6IFsNCiAgICAgICAgICAgIHsibmFtZSI6ICJYX1BoeXNpY2lhbl9fYyIsICJsYWJlbCI6ICJQaHlzaWNpYW4iLCAiZWxlTmFtZSI6ICJYX1BoeXNpY2lhbl9fci5OYW1lIn0NCiAgICAgICAgXQ0KICAgIH0sDQogICAgIlNBIjogbnVsbCwNCiAgICAiTUVEQyI6IHsNCiAgICAgICAgInJlcUZpZWxkcyI6IFsNCiAgICAgICAgICAgIHsibmFtZSI6ICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MiLCAibGFiZWwiOiAiU2VydmljZSBSZXF1ZXN0ZWQgRGF0ZSIsICJlbGVOYW1lIjogIlhfU2VydmljZV9SZXF1ZXN0ZWRfRGF0ZV9fYyJ9DQogICAgICAgIF0NCiAgICB9LA0KICAgICJMQUIiOiB7DQogICAgICAgICJyZXFGaWVsZHMiOiBbDQogICAgICAgICAgICB7Im5hbWUiOiAiWF9TZXJ2aWNlX1JlcXVlc3RlZF9EYXRlX19jIiwgImxhYmVsIjogIlNlcnZpY2UgUmVxdWVzdGVkIERhdGEiLCAiZWxlTmFtZSI6ICJYX1NlcnZpY2VfUmVxdWVzdGVkX0RhdGVfX2MifQ0KICAgICAgICBdDQogICAgfSwNCiAgICAiSU5KUiI6IG51bGwsDQogICAgIkNBIjogew0KICAgICAgICAicmVxRmllbGRzIjogWw0KICAgICAgICAgICAgeyJuYW1lIjogIlhfQXNzZXNzbWVudF9UeXBlX19jIiwgImxhYmVsIjogIkFzc2Vzc21lbnQgVHlwZSIsICJlbGVOYW1lIjogIlhfQXNzZXNzbWVudF9UeXBlX19jIn0sDQogICAgICAgICAgICB7Im5hbWUiOiAiWF9PdXRjb21lX1R5cGVfX2MiLCAibGFiZWwiOiAiT3V0Y29tZSBUeXBlIiwgImVsZU5hbWUiOiAiWF9PdXRjb21lX1R5cGVfX2MifQ0KICAgICAgICBdDQogICAgfSwNCiAgICAiQ09QQVkiOiBudWxsDQp9Ow0KDQpTdHJpbmcucHJvdG90eXBlLmFwcGVuZCA9IGZ1bmN0aW9uIChhcHBlbmRTdHIpIHsNCiAgICByZXR1cm4gYXBwZW5kU3RyID8gdGhpcyArICh0aGlzLmxlbmd0aCA+IDAgPyAiLCAiIDogIiIpICsgYXBwZW5kU3RyIDogdGhpczsNCn07DQoNCmZ1bmN0aW9uIGRvVmFsaWRhdGlvbigpIHsNCiAgICBkZWJ1Z2dlcjsNCiAgICBjb25zb2xlLmxvZygiQ3VycmVudCBERSBQYW5lbCA9ICIgKyBfY3VyREVQYW5lbCk7DQogICAgLy9DUk4xOTExMTQgRmlyc3QgY2xlYXIgdGhlIHN0eWxlcyBvZiBhbGwgaW5wdXQgZmllbGRzIGFuZCBnYXRoZXIgZmllbGQgdmFsdWVzDQogICAgdmFyIGZpZWxkcyA9IHt9Ow0KICAgICQoJy5iaWdEYXRhRW50cnknKS5lYWNoKGZ1bmN0aW9uKCkgew0KICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOw0KICAgICAgICBmaWVsZHNbdGhpcy5uYW1lXSA9ICR0aGlzLnZhbCgpOw0KICAgICAgICBpZiAoJ2hpZGRlbicgIT0gJHRoaXMuYXR0cigndHlwZScpKSB7DQogICAgICAgICAgICAkdGhpcy5jc3MoJ2JvcmRlcicsJ21lZGl1bSBub25lJyk7DQogICAgICAgIH0NCiAgICB9KTsNCiAgIA0KICAgIHZhciByZXFCdWZmZXIgPSAiIjsNCiAgICB2YXIgZG9jVHlwZSA9ICQoJ1tuYW1lPSJYX1pQQVBFUl9fZmF4VHlwZV9fYyJdJykudmFsKCk7DQogICANCiAgICBpZiAoREVfUEFORUxfRk9STV8yQSA9PT0gX2N1ckRFUGFuZWwpIHsNCiAgICAgICAgLy8gUGFuZWwgQSBWYWxpZGF0aW9ucyBIZXJlDQogICAgICAgIHJlcUJ1ZmZlciA9IGRvMkFWYWxpZGF0aW9ucyhmaWVsZHMsIHJlcUJ1ZmZlcik7DQogICAgfQ0KICAgIGVsc2UgaWYgKERFX1BBTkVMX0ZPUk1fMkIgPT09IF9jdXJERVBhbmVsKSB7DQogICAgICAgIC8vIFBhbmVsIEIgVmFsaWRhdGlvbnMgSGVyZQ0KICAgICAgICAvLyBUZXN0IHRoZSBmaWVsZHMgdGhhdCBBTFdBWVMgcmVxdWlyZWQNCiAgICAgICAgcmVxQnVmZmVyID0gdmFsaWRhdGUyQkFsd2F5c1JlcXVpcmVkRmllbGRzKGZpZWxkcywgcmVxQnVmZmVyKTsNCiAgICAgICAgLy8gVGhlc2UgZG9jVHlwZXMgcmVxdWlyZSBzcGVjaWFsIGhhbmRsaW5nIHRoYXQgaXNuJ3Qgc2ltcGxlIGxpc3Qgb2YgcmVxdWlyZWQgZmllbGRzLg0KICAgICAgICAvLyBTcGVjaWFsIEF1dGhvcml6YXRpb24gcmVxdWlyZXMgc3BlY2lhbCBoYW5kbGluZyB0aGF0IGlzbid0IHNpbXBsZSBsaXN0IG9mIHJlcXVpcmVkIGZpZWxkcy4NCiAgICAgICAgaWYgKCJTQSIgPT09IGRvY1R5cGUpIHsNCiAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHZhbGlkYXRTcGVjaWFsQXV0aG9yaXphdGlvbihmaWVsZHMsIHJlcUJ1ZmZlcik7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoKCJMQUIiID09PSBkb2NUeXBlIHx8ICJNRURDIiA9PT0gZG9jVHlwZSkpIHsNCiAgICAgICAgICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9DbGluaWNhbF9TZXJ2aWNlc19fYyJdKSkgew0KICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHNPYmogPSBmb3JtMkJWYWxpZGF0aW9uc1tkb2NUeXBlXTsNCiAgICAgICAgICAgICAgICB2YXIgcmVxRmllbGRzID0gcmVxRmllbGRzT2JqID8gcmVxRmllbGRzT2JqLnJlcUZpZWxkcyA6IG51bGw7DQogICAgICAgICAgICAgICAgaWYgKHJlcUZpZWxkcykgew0KICAgICAgICAgICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICgiQ0EiID09PSBkb2NUeXBlKSB7DQogICAgICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfUmVwb3J0ZWRfT3V0Y29tZV9fYyJdKSkgew0KICAgICAgICAgICAgICAgIHZhciByZXFGaWVsZHNPYmogPSBmb3JtMkJWYWxpZGF0aW9uc1tkb2NUeXBlXTsNCiAgICAgICAgICAgICAgICB2YXIgcmVxRmllbGRzID0gcmVxRmllbGRzT2JqID8gcmVxRmllbGRzT2JqLnJlcUZpZWxkcyA6IG51bGw7DQogICAgICAgICAgICAgICAgaWYgKHJlcUZpZWxkcykgew0KICAgICAgICAgICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHZhciByZXFGaWVsZHNPYmogPSBmb3JtMkJWYWxpZGF0aW9uc1tkb2NUeXBlXTsNCiAgICAgICAgICAgIHZhciByZXFGaWVsZHMgPSByZXFGaWVsZHNPYmogPyByZXFGaWVsZHNPYmoucmVxRmllbGRzIDogbnVsbDsNCiAgICAgICAgICAgIGlmIChyZXFGaWVsZHMpIHsNCiAgICAgICAgICAgICAgICByZXFCdWZmZXIgPSB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKHJlcUJ1ZmZlci5sZW5ndGggPiAwKSB7DQogICAgICAgIGFsZXJ0KCJFUlJPUjogVGhlIGZvbGxvd2luZyBmaWVsZHMgYXJlIHJlcXVpcmVkOiAiICsgcmVxQnVmZmVyKTsNCiAgICAgICAgcmV0dXJuIGZhbHNlOyAgIC8vb25lIG9yIG1vcmUgZmllbGQgaXMgbWlzc2luZywgZG9uJ3Qgc2VuZCB0byB0aGUgcnVsZXMgZW5naW5lDQogICAgfQ0KICAgIC8vIE1ha2Ugc3VyZSB3ZSBzZW5kIHRoZSBjdXJyZW50IERFIFBhbmVsIHRvIHRoZSBydWxlcw0KICAgICQoJyNkYXRhRW50cnlGb3JtJykuYXBwZW5kKCI8aW5wdXQgdHlwZT0naGlkZGVuJyBjbGFzcz0nYmlnRGF0YUVudHJ5JyBuYW1lPSdYX2xhc3RERVBhbmVsJyB2YWx1ZT0nIiArIF9jdXJERVBhbmVsICsgIic+Iik7DQogICAgcmV0dXJuIHRydWU7ICAgICAgICAvL0FsbCByZXF1aXJlZCBmaWVsZHMgaGF2ZSBiZWVuIHN1cHBsaWVkLCBsZXQgdGhlIHJ1bGVzIGVuZ2luZSBiZSBub3RpZmllZA0KfQ0KDQpmdW5jdGlvbiBpc0JsYW5rKHZhbCkgew0KICAgIHJldHVybiAhdmFsIHx8ICJOT05FIiA9PT0gdmFsIHx8ICJET05PVF9TQVZFIiA9PT0gdmFsOw0KfQ0KDQpmdW5jdGlvbiBpc05vdEJsYW5rKHZhbCkgew0KICAgIHJldHVybiB2YWwgJiYgIk5PTkUiICE9PSB2YWwgJiYgIkRPTk9UX1NBVkUiICE9PSB2YWw7DQp9DQoNCmZ1bmN0aW9uIG1hcmtNaXNzaW5nKG5hbWUsIGlkKSB7DQogICAgdmFyICRlbGUgPSBuYW1lID8gJCgnW25hbWU9IicgKyBuYW1lICsgJyJdJykgOiAkKCcjJyArIGlkKTsNCiAgICAkZWxlLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIHJlZCcpOw0KfQ0KDQpmdW5jdGlvbiBkbzJBVmFsaWRhdGlvbnMoZmllbGRzLCByZXFCdWZmZXIpIHsNCiAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfWlBBUEVSX19QYXRpZW50QWNjb3VudF9fYyJdKSkgew0KICAgICAgICB2YXIgbGFzdE5hbWUgPSBmaWVsZHNbIlhfWlBBUEVSX19MYXN0TmFtZV9fYyJdOw0KICAgICAgICB2YXIgZmlyc3ROYW1lID0gZmllbGRzWyJYX1pQQVBFUl9fRmlyc3ROYW1lX19jIl07DQovLyAgICAgICAgdmFyIGJpcnRoRGF0ZSA9IGZpZWxkc1siWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyJdOw0KICAgICAgIA0KICAgICAgICBpZihpc0JsYW5rKGxhc3ROYW1lKSkgew0KICAgICAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOw0KICAgICAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiTGFzdCBOYW1lIik7DQogICAgICAgIH0NCiAgICAgICAgaWYoaXNCbGFuayhmaXJzdE5hbWUpKSB7DQogICAgICAgICAgICBtYXJrTWlzc2luZygiWF9aUEFQRVJfX0ZpcnN0TmFtZV9fYyIpOw0KICAgICAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiRmlyc3QgTmFtZSIpOw0KICAgICAgICB9DQovKgkJDQogICAgICAgIGlmKGlzQmxhbmsoYmlydGhEYXRlKSkgew0KICAgICAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19CaXJ0aGRhdGVfX2MiKTsNCiAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIkJpcnRoIERhdGUiKTsNCiAgICAgICAgfQ0KKi8JCQ0KICAgIH0NCiAgICB2YXIgcHJpb3JpdHlEZSAgPSBmaWVsZHNbIlhfWlBBUEVSX19Qcmlvcml0eV9fYyJdOw0KICAgIGlmKGlzQmxhbmsocHJpb3JpdHlEZSkgfHwgIlVuYXNzaWduZWQiID09PSBwcmlvcml0eURlKSB7DQogICAgICAgIG1hcmtNaXNzaW5nKCJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiKTsNCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiUHJpb3JpdHkgbXVzdCBiZSBlaXRoZXIgSGlnaCwgTWVkaXVtLCBvciBMb3ciKTsNCiAgICB9DQogICAgcmV0dXJuIHJlcUJ1ZmZlcjsNCn0NCg0KLyoqDQogKiBSZXF1aXJlZCBmaWVsZHMgZm9yIDJCIEZvcm1zOiBDbGFzc2lmaWNhdGlvbiwgUHJpb3JpdHksIFBhdGllbnQsIERvY3VtZW50IFR5cGUsIGFuZCBTdWItQ2F0ZWdvcnkNCiAqLw0KZnVuY3Rpb24gdmFsaWRhdGUyQkFsd2F5c1JlcXVpcmVkRmllbGRzKGZpZWxkcywgcmVxQnVmZmVyKSB7DQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19DbGFzc2lmaWNhdGlvbl9fYyIpOw0KICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJDbGFzc2lmaWNhdGlvbiIpOw0KICAgIH0NCiAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfWlBBUEVSX19Qcmlvcml0eV9fYyJdKSkgew0KICAgICAgICBtYXJrTWlzc2luZygiWF9aUEFQRVJfX1ByaW9yaXR5X19jIik7DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIlByaW9yaXR5Iik7DQogICAgfSAgICANCiAgICAvKmlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX1BhdGllbnRBY2NvdW50X19jIl0pKSB7DQogICAgICAgIG1hcmtNaXNzaW5nKCJYX1pQQVBFUl9fUGF0aWVudEFjY291bnRfX3IuTmFtZSIpOw0KICAgICAgICByZXFCdWZmZXIgPSByZXFCdWZmZXIuYXBwZW5kKCJQYXRpZW50Iik7DQogICAgfSAqLw0KICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9aUEFQRVJfX2ZheFR5cGVfX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfWlBBUEVSX19mYXhUeXBlX19jIik7DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIkRvY3VtZW50IFR5cGUiKTsNCiAgICB9DQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1N1Yl9DYXRlZ29yeV9fYyJdKSkgew0KICAgICAgICBtYXJrTWlzc2luZygiWF9TdWJfQ2F0ZWdvcnlfX2MiKTsNCiAgICAgICAgcmVxQnVmZmVyID0gcmVxQnVmZmVyLmFwcGVuZCgiU3ViLUNhdGVnb3J5Iik7DQogICAgfQ0KICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9BdHRhY2hfVG9fX2MiXSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcoIlhfQXR0YWNoX1RvX19jIik7DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoImF0dGFjaGVkVG8iKTsNCiAgICB9DQoNCiAgICByZXR1cm4gcmVxQnVmZmVyOw0KfQ0KDQpmdW5jdGlvbiB2YWxpZGF0ZUZvckRvY3VtZW50VHlwZShyZXFGaWVsZHMsIGZpZWxkcywgcmVxQnVmZmVyKSB7DQogICAgZm9yICh2YXIgaSBpbiByZXFGaWVsZHMpIHsNCiAgICAgICAgaWYgKHJlcUZpZWxkcy5oYXNPd25Qcm9wZXJ0eShpKSkgew0KICAgICAgICAgICAgdmFyIHJlcUZpZWxkID0gcmVxRmllbGRzW2ldOw0KICAgICAgICAgICAgaWYgKGlzQmxhbmsoZmllbGRzW3JlcUZpZWxkLm5hbWVdKSkgew0KICAgICAgICAgICAgICAgIG1hcmtNaXNzaW5nKHJlcUZpZWxkLmVsZU5hbWUpOw0KICAgICAgICAgICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQocmVxRmllbGQubGFiZWwpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXFCdWZmZXI7DQp9DQoNCi8qKg0KICogVGhlIHZhbGlkYXRpb24gZm9yIHRoaXMgRG9jdW1lbnQgVHlwZSBuZWVkcyB0byBiZSB1bmlxdWUgc2luY2Ugbm90IGFsbCBmaWVsZHMgYXJlIHJlcXVpcmVkLCBqdXN0IGEgY2VydGFpbiBjb21iaW5hdGlvbi4NCiAqLw0KZnVuY3Rpb24gdmFsaWRhdFNwZWNpYWxBdXRob3JpemF0aW9uKGZpZWxkcywgcmVxQnVmZmVyKSB7DQogICAgaWYgKGlzQmxhbmsoZmllbGRzWyJYX1NwZWNpYWxfQXV0aG9yaXphdGlvbl9fYyJdKSAmJiAoaXNCbGFuayhmaWVsZHNbIlhfTWVtYmVyX1BsYW5fX2MiXSkgfHwgaXNCbGFuayhmaWVsZHNbIlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyJdKSkpIHsNCiAgICAgICAgbWFya01pc3NpbmcobnVsbCwgIlNwZWNpYWxfQXV0aG9yaXphdGlvbl9fY19OYW1lIik7DQogICAgICAgIGlmIChpc0JsYW5rKGZpZWxkc1siWF9NZW1iZXJfUGxhbl9fYyJdKSkgew0KICAgICAgICAgICAgbWFya01pc3NpbmcobnVsbCwgIk1lbWJlcl9QbGFuX19jX05hbWUiKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNCbGFuayhmaWVsZHNbIlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyJdKSkgew0KICAgICAgICAgICAgbWFya01pc3NpbmcoIlhfQ292ZXJhZ2VfQmVuZWZpdF9fYyIpOw0KICAgICAgICB9DQogICAgICAgIHJlcUJ1ZmZlciA9IHJlcUJ1ZmZlci5hcHBlbmQoIkVpdGhlciBTcGVjaWFsIEF1dGhvcml6YXRpb24gb3IgYm90aCBNZW1iZXIgUGxhbiBhbmQgQ292ZXJhZ2UgQmVuZWZpdCIpOw0KICAgIH0NCiAgICByZXR1cm4gcmVxQnVmZmVyOw0KfQ0KDQpyZXR1cm4gZG9WYWxpZGF0aW9uKCk7
//--- RULE VALIDATION CODE - END ---

</script>
